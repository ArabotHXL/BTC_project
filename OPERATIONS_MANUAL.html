<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashInsight å¹³å°è¿ç»´æ‰‹å†Œ</title>
    <style>
        @media print {
            @page {
                size: A4;
                margin: 2cm;
            }
            body {
                font-size: 10pt;
            }
            h1 {
                page-break-before: always;
            }
            h1:first-of-type {
                page-break-before: auto;
            }
            table {
                page-break-inside: avoid;
            }
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Noto Sans CJK SC", 
                         "Microsoft YaHei", "PingFang SC", "Hiragino Sans GB", sans-serif;
            line-height: 1.8;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
            background-color: #f9f9f9;
        }
        
        h1 {
            color: #2c3e50;
            border-bottom: 4px solid #f39c12;
            padding-bottom: 12px;
            margin-top: 40px;
            margin-bottom: 25px;
            font-size: 2.5em;
        }
        
        h1:first-of-type {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            margin: -40px -20px 30px -20px;
            border-bottom: none;
            text-align: center;
            border-radius: 0;
        }
        
        h2 {
            color: #34495e;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
            margin-top: 35px;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        h3 {
            color: #555;
            margin-top: 28px;
            margin-bottom: 15px;
            font-size: 1.5em;
            border-left: 5px solid #f39c12;
            padding-left: 15px;
        }
        
        h4 {
            color: #666;
            margin-top: 22px;
            margin-bottom: 12px;
            font-size: 1.25em;
        }
        
        p {
            margin: 12px 0;
            text-align: justify;
        }
        
        code {
            background-color: #f5f5f5;
            padding: 3px 8px;
            border-radius: 4px;
            font-family: "Consolas", "Monaco", "Courier New", monospace;
            font-size: 0.9em;
            color: #e74c3c;
            border: 1px solid #e0e0e0;
        }
        
        pre {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-left: 4px solid #f39c12;
            padding: 20px;
            margin: 20px 0;
            overflow-x: auto;
            border-radius: 5px;
        }
        
        pre code {
            background-color: transparent;
            padding: 0;
            border: none;
            color: #333;
            font-size: 0.9em;
        }
        
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 25px 0;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }
        
        table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: bold;
        }
        
        table td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            vertical-align: top;
        }
        
        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        table tr:hover {
            background-color: #f0f0f0;
        }
        
        blockquote {
            border-left: 5px solid #3498db;
            padding: 15px 20px;
            margin: 20px 0;
            color: #555;
            background-color: #ecf0f1;
            border-radius: 5px;
        }
        
        ul, ol {
            margin: 15px 0;
            padding-left: 35px;
        }
        
        li {
            margin: 8px 0;
            line-height: 1.7;
        }
        
        a {
            color: #3498db;
            text-decoration: none;
            transition: color 0.3s;
        }
        
        a:hover {
            color: #2980b9;
            text-decoration: underline;
        }
        
        strong {
            color: #2c3e50;
            font-weight: 700;
        }
        
        hr {
            border: none;
            border-top: 2px solid #ecf0f1;
            margin: 40px 0;
        }
        
        .print-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: transform 0.2s;
        }
        
        .print-button:hover {
            transform: scale(1.05);
        }
        
        @media print {
            .print-button {
                display: none;
            }
        }
    </style>
</head>
<body>
    <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ æ‰“å°/å¯¼å‡ºPDF</button>
    <h1 id="hashinsight">HashInsight å¹³å°è¿ç»´æ‰‹å†Œ</h1>
<h2 id="operations-manual-for-hashinsight-platform">Operations Manual for HashInsight Platform</h2>
<p><strong>æ–‡æ¡£ç‰ˆæœ¬:</strong> v2.0<br />
<strong>æ›´æ–°æ—¥æœŸ:</strong> 2025-10-03<br />
<strong>ç»´æŠ¤å›¢é˜Ÿ:</strong> HashInsight Platform Operations Team<br />
<strong>åˆ†ç±»:</strong> INTERNAL - CONFIDENTIAL</p>
<hr />
<h2 id="_1">ğŸ“‹ ç›®å½•</h2>
<ol>
<li><a href="#ç¬¬1ç« ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ">ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</a></li>
<li><a href="#ç¬¬2ç« ç¯å¢ƒé…ç½®æ¸…å•">ç¯å¢ƒé…ç½®æ¸…å•</a></li>
<li><a href="#ç¬¬3ç« éƒ¨ç½²è¿ç»´æŒ‡å—">éƒ¨ç½²è¿ç»´æŒ‡å—</a></li>
<li><a href="#ç¬¬4ç« ç›‘æ§ä¸å‘Šè­¦">ç›‘æ§ä¸å‘Šè­¦</a></li>
<li><a href="#ç¬¬5ç« å¤‡ä»½ä¸æ¢å¤">å¤‡ä»½ä¸æ¢å¤</a></li>
<li><a href="#ç¬¬6ç« å®‰å…¨è¿ç»´è§„èŒƒ">å®‰å…¨è¿ç»´è§„èŒƒ</a></li>
<li><a href="#ç¬¬7ç« æ•…éšœæ’æŸ¥æ‰‹å†Œ">æ•…éšœæ’æŸ¥æ‰‹å†Œ</a></li>
<li><a href="#ç¬¬8ç« æ—¥å¸¸è¿ç»´æ“ä½œ">æ—¥å¸¸è¿ç»´æ“ä½œ</a></li>
<li><a href="#ç¬¬9ç« æ€§èƒ½ä¼˜åŒ–æŒ‡å—">æ€§èƒ½ä¼˜åŒ–æŒ‡å—</a></li>
<li><a href="#ç¬¬10ç« åº”æ€¥å“åº”æ‰‹å†Œ">åº”æ€¥å“åº”æ‰‹å†Œ</a></li>
<li><a href="#é™„å½•">é™„å½•</a></li>
</ol>
<hr />
<h2 id="1">ç¬¬1ç« ï¼šç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</h2>
<h3 id="11">1.1 æŠ€æœ¯æ ˆ</h3>
<p>HashInsight æ˜¯ä¸€ä¸ªä¼ä¸šçº§æ¯”ç‰¹å¸æŒ–çŸ¿ç®¡ç†å¹³å°ï¼Œé‡‡ç”¨ç°ä»£åŒ–æŠ€æœ¯æ ˆï¼š</p>
<table>
<thead>
<tr>
<th>ç»„ä»¶</th>
<th>æŠ€æœ¯</th>
<th>ç‰ˆæœ¬</th>
<th>ç”¨é€”</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Webæ¡†æ¶</strong></td>
<td>Flask</td>
<td>3.0+</td>
<td>Python Webåº”ç”¨æ¡†æ¶</td>
</tr>
<tr>
<td><strong>WSGIæœåŠ¡å™¨</strong></td>
<td>Gunicorn</td>
<td>21.0+</td>
<td>ç”Ÿäº§çº§HTTPæœåŠ¡å™¨</td>
</tr>
<tr>
<td><strong>æ•°æ®åº“</strong></td>
<td>PostgreSQL</td>
<td>15+</td>
<td>ä¸»æ•°æ®å­˜å‚¨ (Neonæ‰˜ç®¡)</td>
</tr>
<tr>
<td><strong>ç¼“å­˜</strong></td>
<td>Redis / å†…å­˜ç¼“å­˜</td>
<td>7.0+</td>
<td>æ€§èƒ½ä¼˜åŒ–ç¼“å­˜å±‚</td>
</tr>
<tr>
<td><strong>åŒºå—é“¾</strong></td>
<td>Web3.py + Base L2</td>
<td>-</td>
<td>åŒºå—é“¾é›†æˆ</td>
</tr>
<tr>
<td><strong>åŠ å¯†</strong></td>
<td>Cryptography</td>
<td>41.0+</td>
<td>ä¼ä¸šçº§åŠ å¯†</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 æ¨¡å—æ¶æ„</h3>
<p>ç³»ç»Ÿé‡‡ç”¨<strong>å®Œå…¨é¡µé¢éš”ç¦»æ¶æ„</strong>ï¼Œå„æ¨¡å—ç‹¬ç«‹éƒ¨ç½²ï¼š</p>
<div class="codehilite"><pre><span></span><code>HashInsight Platform
â”œâ”€â”€ Core Application (main.py + app.py)
â”‚   â”œâ”€â”€ Authentication &amp; Authorization
â”‚   â”œâ”€â”€ Session Management
â”‚   â””â”€â”€ Security Middleware
â”‚
â”œâ”€â”€ Mining Management Module
â”‚   â”œâ”€â”€ Miner Dashboard
â”‚   â”œâ”€â”€ Batch Calculator
â”‚   â””â”€â”€ Analytics Engine
â”‚
â”œâ”€â”€ CRM &amp; Client Module
â”‚   â”œâ”€â”€ Customer Management
â”‚   â”œâ”€â”€ Billing System
â”‚   â””â”€â”€ Subscription Management
â”‚
â”œâ”€â”€ Blockchain Integration Module
â”‚   â”œâ”€â”€ SLA NFT Management
â”‚   â”œâ”€â”€ Verifiable Computing
â”‚   â””â”€â”€ Trust Reconciliation
â”‚
â””â”€â”€ Admin &amp; Analytics Module
    â”œâ”€â”€ Market Data Analysis
    â”œâ”€â”€ Performance Monitoring
    â””â”€â”€ Reporting System
</code></pre></div>

<h3 id="13">1.3 ä¼ä¸šçº§æ”¹é€ æˆæœ</h3>
<h4 id="_2">ğŸ” å®‰å…¨å¢å¼º</h4>
<ul>
<li><strong>KMSå¯†é’¥ç®¡ç†</strong>: æ”¯æŒ AWS KMSã€GCP KMSã€Azure Key Vault</li>
<li><strong>mTLSåŒå‘è®¤è¯</strong>: å®¢æˆ·ç«¯è¯ä¹¦éªŒè¯ã€CRL/OCSPæ£€æŸ¥</li>
<li><strong>APIå¯†é’¥ç³»ç»Ÿ</strong>: åŸºäº <code>hsi_dev_key_*</code> æ ¼å¼çš„å®‰å…¨å¯†é’¥</li>
<li><strong>WireGuard VPN</strong>: ä¼ä¸šçº§ä¸“ç½‘éš”ç¦»</li>
<li><strong>å®¡è®¡æ—¥å¿—</strong>: SOC 2 / PCI DSS / GDPR åˆè§„</li>
</ul>
<h4 id="slo">ğŸ“Š SLOç›‘æ§</h4>
<ul>
<li><strong>å¯ç”¨æ€§</strong>: â‰¥99.95% (é”™è¯¯é¢„ç®— â‰¤21.6åˆ†é’Ÿ/æœˆ)</li>
<li><strong>å»¶è¿Ÿ</strong>: p95 â‰¤250ms</li>
<li><strong>é”™è¯¯ç‡</strong>: â‰¤0.1%</li>
<li><strong>PrometheusæŒ‡æ ‡</strong>: å…¨æ–¹ä½æ€§èƒ½ç›‘æ§</li>
<li><strong>ç†”æ–­å™¨</strong>: é˜²æ­¢çº§è”æ•…éšœ</li>
</ul>
<h4 id="_3">âš¡ æ€§èƒ½ä¼˜åŒ–</h4>
<ul>
<li><strong>Request Coalescing</strong>: 9.8å€æ€§èƒ½æå‡</li>
<li><strong>å¤šçº§ç¼“å­˜</strong>: Redis + å†…å­˜ç¼“å­˜</li>
<li><strong>è¿æ¥æ± </strong>: PostgreSQLè¿æ¥ä¼˜åŒ–</li>
<li><strong>æ‰¹é‡å¤„ç†</strong>: æ”¯æŒ5000+çŸ¿æœºå¹¶å‘å¯¼å…¥</li>
</ul>
<h3 id="14">1.4 éƒ¨ç½²æ‹“æ‰‘</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Load Balancer                        â”‚
â”‚                  (Replit/Cloud Provider)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Gunicorn       â”‚         â”‚  Gunicorn        â”‚
â”‚  Worker 1       â”‚         â”‚  Worker 2        â”‚
â”‚  Port 5000      â”‚         â”‚  Port 5000       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL     â”‚         â”‚  Redis Cache     â”‚
â”‚  (Neon Hosted)  â”‚         â”‚  (Optional)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<hr />
<h2 id="2">ç¬¬2ç« ï¼šç¯å¢ƒé…ç½®æ¸…å•</h2>
<h3 id="21">2.1 å¿…éœ€ç¯å¢ƒå˜é‡</h3>
<p>è¿™äº›ç¯å¢ƒå˜é‡<strong>å¿…é¡»</strong>è®¾ç½®ï¼Œå¦åˆ™ç³»ç»Ÿæ— æ³•å¯åŠ¨ï¼š</p>
<table>
<thead>
<tr>
<th>å˜é‡å</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DATABASE_URL</code></td>
<td>String</td>
<td>PostgreSQLè¿æ¥å­—ç¬¦ä¸²</td>
<td><code>postgresql://user:pass@host:5432/db</code></td>
</tr>
<tr>
<td><code>SESSION_SECRET</code></td>
<td>String</td>
<td>Flaskä¼šè¯å¯†é’¥ (â‰¥32å­—ç¬¦)</td>
<td><code>your-secure-random-secret-key-here</code></td>
</tr>
<tr>
<td><code>ENCRYPTION_PASSWORD</code></td>
<td>String</td>
<td>æ•°æ®åŠ å¯†ä¸»å¯†é’¥ (â‰¥32å­—ç¬¦)</td>
<td><code>encryption-master-key-32-chars-min</code></td>
</tr>
</tbody>
</table>
<h4 id="_4">é…ç½®ç¤ºä¾‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># .env æ–‡ä»¶ç¤ºä¾‹</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://hashinsight_user:secure_password@neon-host.us-east-1.aws.neon.tech:5432/hashinsight_db
<span class="nv">SESSION_SECRET</span><span class="o">=</span>generate_with_python_secrets_token_urlsafe_32
<span class="nv">ENCRYPTION_PASSWORD</span><span class="o">=</span>generate_with_python_secrets_token_urlsafe_32
</code></pre></div>

<h4 id="_5">ç”Ÿæˆå®‰å…¨å¯†é’¥</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨Pythonç”Ÿæˆå®‰å…¨éšæœºå¯†é’¥</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">secrets</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SESSION_SECRET=</span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ENCRYPTION_PASSWORD=</span><span class="si">{</span><span class="n">secrets</span><span class="o">.</span><span class="n">token_urlsafe</span><span class="p">(</span><span class="mi">32</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h3 id="22">2.2 åŒºå—é“¾é›†æˆé…ç½®</h3>
<table>
<thead>
<tr>
<th>å˜é‡å</th>
<th>ç±»å‹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BLOCKCHAIN_ENABLED</code></td>
<td>Boolean</td>
<td><code>false</code></td>
<td>å¯ç”¨åŒºå—é“¾åŠŸèƒ½</td>
</tr>
<tr>
<td><code>BLOCKCHAIN_PRIVATE_KEY</code></td>
<td>String</td>
<td>-</td>
<td>ä»¥å¤ªåŠç§é’¥ (0xå¼€å¤´)</td>
</tr>
<tr>
<td><code>BLOCKCHAIN_NETWORK</code></td>
<td>String</td>
<td><code>base-sepolia</code></td>
<td>åŒºå—é“¾ç½‘ç»œ</td>
</tr>
<tr>
<td><code>BASE_RPC_URL</code></td>
<td>String</td>
<td><code>https://sepolia.base.org</code></td>
<td>Base L2 RPCç«¯ç‚¹</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŒºå—é“¾é…ç½®ç¤ºä¾‹</span>
<span class="nv">BLOCKCHAIN_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">BLOCKCHAIN_PRIVATE_KEY</span><span class="o">=</span>0x1234567890abcdef...
<span class="nv">BLOCKCHAIN_NETWORK</span><span class="o">=</span>base-sepolia
</code></pre></div>

<h3 id="23">2.3 å¤‡ä»½ç³»ç»Ÿé…ç½®</h3>
<table>
<thead>
<tr>
<th>å˜é‡å</th>
<th>ç±»å‹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BACKUP_DIR</code></td>
<td>String</td>
<td><code>/tmp/backups</code></td>
<td>å¤‡ä»½å­˜å‚¨ç›®å½•</td>
</tr>
<tr>
<td><code>BACKUP_ENCRYPTION_KEY</code></td>
<td>String</td>
<td>-</td>
<td>å¤‡ä»½åŠ å¯†å¯†é’¥</td>
</tr>
<tr>
<td><code>BACKUP_RETENTION_DAYS</code></td>
<td>Integer</td>
<td><code>30</code></td>
<td>å¤‡ä»½ä¿ç•™å¤©æ•°</td>
</tr>
<tr>
<td><code>BACKUP_STORAGE_TYPE</code></td>
<td>String</td>
<td><code>local</code></td>
<td>è¿œç¨‹å­˜å‚¨ç±»å‹ (s3/azure/gcs)</td>
</tr>
<tr>
<td><code>BACKUP_STORAGE_BUCKET</code></td>
<td>String</td>
<td>-</td>
<td>è¿œç¨‹å­˜å‚¨æ¡¶åç§°</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><code><span class="c1"># AWS S3 å¤‡ä»½é…ç½®</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span>/var/backups/hashinsight
<span class="nv">BACKUP_ENCRYPTION_KEY</span><span class="o">=</span>backup-encryption-key-32-chars
<span class="nv">BACKUP_RETENTION_DAYS</span><span class="o">=</span><span class="m">30</span>
<span class="nv">BACKUP_STORAGE_TYPE</span><span class="o">=</span>s3
<span class="nv">BACKUP_STORAGE_BUCKET</span><span class="o">=</span>hashinsight-backups
<span class="nv">BACKUP_STORAGE_REGION</span><span class="o">=</span>us-east-1
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAXXXXXXXX
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>xxxxxxxxxx
</code></pre></div>

<h3 id="24-kms">2.4 KMSå¯†é’¥ç®¡ç†é…ç½®</h3>
<h4 id="aws-kms">AWS KMS</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">AWS_KMS_KEY_ID</span><span class="o">=</span>arn:aws:kms:us-east-1:123456789:key/xxxxx
<span class="nv">AWS_KMS_REGION</span><span class="o">=</span>us-east-1
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAXXXXXXXX
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>xxxxxxxxxx
</code></pre></div>

<h4 id="gcp-kms">GCP KMS</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">GCP_KMS_PROJECT_ID</span><span class="o">=</span>hashinsight-prod
<span class="nv">GCP_KMS_LOCATION</span><span class="o">=</span>us-east1
<span class="nv">GCP_KMS_KEYRING</span><span class="o">=</span>hashinsight-keyring
<span class="nv">GCP_KMS_KEY_ID</span><span class="o">=</span>encryption-key
<span class="nv">GOOGLE_APPLICATION_CREDENTIALS</span><span class="o">=</span>/path/to/service-account.json
</code></pre></div>

<h4 id="azure-key-vault">Azure Key Vault</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">AZURE_KEY_VAULT_URL</span><span class="o">=</span>https://hashinsight-vault.vault.azure.net/
<span class="nv">AZURE_TENANT_ID</span><span class="o">=</span>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
<span class="nv">AZURE_CLIENT_ID</span><span class="o">=</span>xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
<span class="nv">AZURE_CLIENT_SECRET</span><span class="o">=</span>xxxxxxxxxx
</code></pre></div>

<h3 id="25">2.5 ç›‘æ§å’Œæ€§èƒ½é…ç½®</h3>
<table>
<thead>
<tr>
<th>å˜é‡å</th>
<th>ç±»å‹</th>
<th>é»˜è®¤å€¼</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ENABLE_BACKGROUND_SERVICES</code></td>
<td>Boolean</td>
<td><code>false</code></td>
<td>å¯ç”¨åå°æ•°æ®é‡‡é›†ï¼ˆéœ€æ˜¾å¼è®¾ç½®ä¸º'1'æ‰å¯ç”¨ï¼‰</td>
</tr>
<tr>
<td><code>PROMETHEUS_PORT</code></td>
<td>Integer</td>
<td><code>9090</code></td>
<td>Prometheuså¯¼å‡ºç«¯å£</td>
</tr>
<tr>
<td><code>SLO_MEASUREMENT_WINDOW</code></td>
<td>Integer</td>
<td><code>30</code></td>
<td>SLOæµ‹é‡çª—å£(åˆ†é’Ÿ)</td>
</tr>
</tbody>
</table>
<p><strong>æ³¨æ„</strong>: <code>FAST_STARTUP</code> æ¨¡å¼åœ¨ <code>main.py</code> ä¸­ç¡¬ç¼–ç å®ç°ï¼Œä¸é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ã€‚è¯¦è§ç¬¬3.4èŠ‚ã€‚</p>
<h3 id="26-api">2.6 å¤–éƒ¨APIé…ç½®</h3>
<table>
<thead>
<tr>
<th>å˜é‡å</th>
<th>è¯´æ˜</th>
<th>è·å–æ–¹å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>COINWARZ_API_KEY</code></td>
<td>CoinWarzæŒ–çŸ¿æ•°æ®API</td>
<td>https://www.coinwarz.com/api</td>
</tr>
<tr>
<td><code>COINGECKO_API_KEY</code></td>
<td>CoinGeckoä»·æ ¼API</td>
<td>https://www.coingecko.com/api</td>
</tr>
<tr>
<td><code>SENDGRID_API_KEY</code></td>
<td>SendGridé‚®ä»¶æœåŠ¡</td>
<td>https://sendgrid.com</td>
</tr>
</tbody>
</table>
<h3 id="27">2.7 é…ç½®æ–‡ä»¶ä½ç½®</h3>
<div class="codehilite"><pre><span></span><code>HashInsight/
â”œâ”€â”€ config.py                    # ä¸»é…ç½®æ–‡ä»¶ (å•ä¸€æ•°æ®æº)
â”œâ”€â”€ .env                         # ç¯å¢ƒå˜é‡ (ä¸æäº¤åˆ°Git)
â”œâ”€â”€ .env.example                 # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ replit.md                   # ç³»ç»Ÿæ¶æ„æ–‡æ¡£
</code></pre></div>

<h3 id="28">2.8 é…ç½®éªŒè¯</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æŸ¥å¿…éœ€ç¯å¢ƒå˜é‡</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">import os</span>
<span class="s2">required = [&#39;DATABASE_URL&#39;, &#39;SESSION_SECRET&#39;, &#39;ENCRYPTION_PASSWORD&#39;]</span>
<span class="s2">missing = [v for v in required if not os.getenv(v)]</span>
<span class="s2">if missing:</span>
<span class="s2">    print(f&#39;âŒ Missing: {missing}&#39;)</span>
<span class="s2">    exit(1)</span>
<span class="s2">print(&#39;âœ… All required variables set&#39;)</span>
<span class="s2">&quot;</span>
</code></pre></div>

<hr />
<h2 id="3">ç¬¬3ç« ï¼šéƒ¨ç½²è¿ç»´æŒ‡å—</h2>
<h3 id="31">3.1 å¯åŠ¨å‘½ä»¤</h3>
<h4 id="_6">æ ‡å‡†å¯åŠ¨ (ç”Ÿäº§ç¯å¢ƒ)</h4>
<div class="codehilite"><pre><span></span><code>gunicorn<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:5000<span class="w"> </span>--reuse-port<span class="w"> </span>--reload<span class="w"> </span>main:app
</code></pre></div>

<h4 id="_7">å‚æ•°è¯´æ˜</h4>
<table>
<thead>
<tr>
<th>å‚æ•°</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>--bind 0.0.0.0:5000</code></td>
<td>ç»‘å®šæ‰€æœ‰ç½‘ç»œæ¥å£ï¼Œç«¯å£5000 (Replitå¿…éœ€)</td>
</tr>
<tr>
<td><code>--reuse-port</code></td>
<td>å…è®¸å¤šä¸ªworkerç»‘å®šåŒä¸€ç«¯å£</td>
</tr>
<tr>
<td><code>--reload</code></td>
<td>ä»£ç å˜æ›´æ—¶è‡ªåŠ¨é‡è½½ (å¼€å‘ç¯å¢ƒ)</td>
</tr>
<tr>
<td><code>--workers 4</code></td>
<td>Workerè¿›ç¨‹æ•° (CPUæ ¸å¿ƒæ•°Ã—2+1)</td>
</tr>
<tr>
<td><code>--timeout 120</code></td>
<td>Workerè¶…æ—¶æ—¶é—´(ç§’)</td>
</tr>
</tbody>
</table>
<h4 id="_8">ç”Ÿäº§ç¯å¢ƒå®Œæ•´å¯åŠ¨</h4>
<div class="codehilite"><pre><span></span><code>gunicorn<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:5000<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--workers<span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--threads<span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--worker-class<span class="w"> </span>gthread<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--timeout<span class="w"> </span><span class="m">120</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-requests<span class="w"> </span><span class="m">1000</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-requests-jitter<span class="w"> </span><span class="m">50</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--access-logfile<span class="w"> </span>-<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--error-logfile<span class="w"> </span>-<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--log-level<span class="w"> </span>info<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--preload<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>main:app
</code></pre></div>

<h3 id="32">3.2 ç«¯å£é…ç½®</h3>
<p><strong>âš ï¸ é‡è¦</strong>: å‰ç«¯åº”ç”¨<strong>å¿…é¡»</strong>ç»‘å®šåˆ°ç«¯å£ 5000</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æŸ¥ç«¯å£å ç”¨</span>
lsof<span class="w"> </span>-i<span class="w"> </span>:5000

<span class="c1"># å¼ºåˆ¶æ€æ­»å ç”¨è¿›ç¨‹</span>
<span class="nb">kill</span><span class="w"> </span>-9<span class="w"> </span><span class="k">$(</span>lsof<span class="w"> </span>-t<span class="w"> </span>-i:5000<span class="k">)</span>
</code></pre></div>

<h3 id="33">3.3 å¥åº·æ£€æŸ¥</h3>
<p>ç³»ç»Ÿæä¾›å¥åº·æ£€æŸ¥ç«¯ç‚¹ç”¨äºç›‘æ§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åŸºæœ¬å¥åº·æ£€æŸ¥</span>
curl<span class="w"> </span>http://localhost:5000/health

<span class="c1"># è¯¦ç»†å¥åº·æ£€æŸ¥ (åŒ…å«æ•°æ®åº“çŠ¶æ€)</span>
curl<span class="w"> </span>http://localhost:5000/health/detailed

<span class="c1"># é¢„æœŸå“åº”</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;healthy&quot;</span>,
<span class="w">  </span><span class="s2">&quot;timestamp&quot;</span>:<span class="w"> </span><span class="s2">&quot;2025-10-03T12:00:00Z&quot;</span>,
<span class="w">  </span><span class="s2">&quot;database&quot;</span>:<span class="w"> </span><span class="s2">&quot;connected&quot;</span>,
<span class="w">  </span><span class="s2">&quot;cache&quot;</span>:<span class="w"> </span><span class="s2">&quot;available&quot;</span>,
<span class="w">  </span><span class="s2">&quot;version&quot;</span>:<span class="w"> </span><span class="s2">&quot;2.0.0&quot;</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="34-fast-startup">3.4 Fast Startup æ¨¡å¼</h3>
<p>HashInsight çš„å¿«é€Ÿå¯åŠ¨æ¨¡å¼æ˜¯åœ¨ <strong><code>main.py</code> ä¸­ç¡¬ç¼–ç å®ç°çš„å†…ç½®è¡Œä¸º</strong>ï¼Œä¸é€šè¿‡ <code>config.py</code> é…ç½®ç®¡ç†ã€‚</p>
<h4 id="_9">å®ç°ä½ç½®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># main.py ä¸­çš„ç¡¬ç¼–ç å®ç°</span>
<span class="n">fast_startup</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;FAST_STARTUP&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>  <span class="c1"># é»˜è®¤å¯ç”¨</span>
<span class="n">skip_db_check</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SKIP_DATABASE_HEALTH_CHECK&quot;</span><span class="p">,</span> <span class="s2">&quot;1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;yes&quot;</span><span class="p">)</span>  <span class="c1"># é»˜è®¤å¯ç”¨</span>
</code></pre></div>

<h4 id="_10">æ§åˆ¶æ–¹å¼ï¼ˆå¯é€‰ç¯å¢ƒå˜é‡ï¼‰</h4>
<p>è™½ç„¶è¿™äº›å˜é‡ä¸åœ¨ <code>config.py</code> ä¸­å®šä¹‰ï¼Œä½†å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡ä¸´æ—¶è°ƒæ•´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯ç”¨å¿«é€Ÿå¯åŠ¨ (é»˜è®¤è¡Œä¸ºï¼Œæ— éœ€è®¾ç½®)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FAST_STARTUP</span><span class="o">=</span><span class="m">1</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SKIP_DATABASE_HEALTH_CHECK</span><span class="o">=</span><span class="m">1</span>

<span class="c1"># ç¦ç”¨å¿«é€Ÿå¯åŠ¨ (å®Œæ•´åˆå§‹åŒ–)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FAST_STARTUP</span><span class="o">=</span><span class="m">0</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SKIP_DATABASE_HEALTH_CHECK</span><span class="o">=</span><span class="m">0</span>
</code></pre></div>

<p><strong>âš ï¸ é‡è¦è¯´æ˜</strong>ï¼š
- è¿™äº›å˜é‡<strong>ä¸åœ¨ <code>config.py</code> å•ä¸€æ•°æ®æº</strong>ä¸­å®šä¹‰
- å®ƒä»¬æ˜¯ <code>main.py</code> å¯åŠ¨è„šæœ¬çš„ä¸´æ—¶æ§åˆ¶å¼€å…³
- ç”Ÿäº§ç¯å¢ƒé…ç½®åº”é€šè¿‡ <code>config.py</code> ç®¡ç†</p>
<h4 id="fast-startup">Fast Startup è¡Œä¸º</h4>
<p>å½“å¯ç”¨æ—¶ï¼ˆé»˜è®¤ï¼‰ï¼š
1. ä¸»åº”ç”¨ç«‹å³å¯åŠ¨ (2-3ç§’)
2. åå°æœåŠ¡å»¶è¿Ÿ5ç§’å¯åŠ¨ï¼ˆå¦‚æœ <code>ENABLE_BACKGROUND_SERVICES=1</code>ï¼‰
3. æ•°æ®åº“å¥åº·æ£€æŸ¥è·³è¿‡
4. é€‚åˆCI/CDå¿«é€Ÿéƒ¨ç½²</p>
<p>å½“ç¦ç”¨æ—¶ï¼š
1. å®Œæ•´æ•°æ®åº“å¥åº·æ£€æŸ¥
2. åŒæ­¥å¯åŠ¨æ‰€æœ‰æœåŠ¡
3. å¯åŠ¨æ—¶é—´è¾ƒé•¿ï¼ˆ10-15ç§’ï¼‰
4. é€‚åˆç”Ÿäº§ç¯å¢ƒåˆæ¬¡éƒ¨ç½²</p>
<h3 id="35">3.5 æ•°æ®åº“è¿ç§»</h3>
<p><strong>âš ï¸ é‡è¦</strong>: ç³»ç»Ÿä½¿ç”¨ORMè‡ªåŠ¨è¿ç§»ï¼Œ<strong>é¿å…æ‰‹åŠ¨SQLæ“ä½œ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ•°æ®åº“ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨åˆ›å»ºè¡¨</span>
<span class="c1"># å‚è§ app.py ä¸­çš„ db.create_all()</span>

<span class="c1"># å¦‚éœ€æ‰‹åŠ¨è§¦å‘è¿ç§»</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from app import app, db; app.app_context().push(); db.create_all()&quot;</span>
</code></pre></div>

<h3 id="36">3.6 æ»šåŠ¨å‘å¸ƒç­–ç•¥</h3>
<h4 id="_11">ç°åº¦å‘å¸ƒæµç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Step 1: éƒ¨ç½²æ–°ç‰ˆæœ¬åˆ°Canaryå®ä¾‹</span>
<span class="c1"># ä»…1ä¸ªworkerè¿è¡Œæ–°ç‰ˆæœ¬</span>
gunicorn<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:5001<span class="w"> </span>--workers<span class="w"> </span><span class="m">1</span><span class="w"> </span>main:app

<span class="c1"># Step 2: ç›‘æ§Canaryå®ä¾‹ (5-10åˆ†é’Ÿ)</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s1">&#39;curl -s http://localhost:5001/health | jq&#39;</span>

<span class="c1"># Step 3: é€æ­¥åˆ‡æ¢æµé‡</span>
<span class="c1"># ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨è°ƒæ•´æƒé‡: old(90%) -&gt; new(10%)</span>
<span class="c1"># è§‚å¯Ÿé”™è¯¯ç‡å’Œå»¶è¿Ÿ</span>

<span class="c1"># Step 4: å…¨é‡åˆ‡æ¢</span>
<span class="c1"># old(0%) -&gt; new(100%)</span>
killall<span class="w"> </span>-9<span class="w"> </span>gunicorn<span class="w">  </span><span class="c1"># åœæ­¢æ—§ç‰ˆæœ¬</span>
gunicorn<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:5000<span class="w"> </span>--workers<span class="w"> </span><span class="m">4</span><span class="w"> </span>main:app<span class="w">  </span><span class="c1"># å¯åŠ¨æ–°ç‰ˆæœ¬</span>
</code></pre></div>

<h3 id="37">3.7 ä¼˜é›…åœæœº</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># å‘é€SIGTERMä¿¡å· (ä¼˜é›…åœæœº)</span>
<span class="nb">kill</span><span class="w"> </span>-TERM<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/var/run/gunicorn.pid<span class="k">)</span>

<span class="c1"># ç­‰å¾…30ç§’å¤„ç†ç°æœ‰è¯·æ±‚</span>
sleep<span class="w"> </span><span class="m">30</span>

<span class="c1"># å¼ºåˆ¶åœæ­¢ (å¦‚æœä»åœ¨è¿è¡Œ)</span>
<span class="nb">kill</span><span class="w"> </span>-KILL<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/var/run/gunicorn.pid<span class="k">)</span>
</code></pre></div>

<h3 id="38">3.8 æ—¥å¿—ç®¡ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯åŠ¨æ—¶å¯ç”¨ç»“æ„åŒ–æ—¥å¿—</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">LOG_LEVEL</span><span class="o">=</span>INFO
<span class="nb">export</span><span class="w"> </span><span class="nv">LOG_FORMAT</span><span class="o">=</span>json

<span class="c1"># æŸ¥çœ‹å®æ—¶æ—¥å¿—</span>
tail<span class="w"> </span>-f<span class="w"> </span>/var/log/hashinsight/app.log

<span class="c1"># æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span>
grep<span class="w"> </span>ERROR<span class="w"> </span>/var/log/hashinsight/app.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-20

<span class="c1"># Replitç¯å¢ƒæ—¥å¿—</span>
<span class="c1"># æ—¥å¿—è¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œé€šè¿‡Replit ConsoleæŸ¥çœ‹</span>
</code></pre></div>

<h3 id="39">3.9 éƒ¨ç½²æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] ç¯å¢ƒå˜é‡å·²é…ç½® (DATABASE_URL, SESSION_SECRET, ENCRYPTION_PASSWORD)</li>
<li>[ ] æ•°æ®åº“è¿æ¥æ­£å¸¸</li>
<li>[ ] ç«¯å£5000å¯ç”¨</li>
<li>[ ] å¥åº·æ£€æŸ¥ç«¯ç‚¹è¿”å›200</li>
<li>[ ] å®¡è®¡æ—¥å¿—ç›®å½•å¯å†™ (<code>logs/audit.jsonl</code>)</li>
<li>[ ] å¤‡ä»½ç›®å½•å·²åˆ›å»º</li>
<li>[ ] SSLè¯ä¹¦æœ‰æ•ˆ (å¦‚å¯ç”¨mTLS)</li>
<li>[ ] KMSå¯†é’¥å¯è®¿é—® (å¦‚å¯ç”¨)</li>
<li>[ ] PrometheusæŒ‡æ ‡å¯è®¿é—® (<code>:9090/metrics</code>)</li>
</ul>
<hr />
<h2 id="4">ç¬¬4ç« ï¼šç›‘æ§ä¸å‘Šè­¦</h2>
<h3 id="41-slo">4.1 SLOå®šä¹‰</h3>
<p>HashInsight éµå¾ªä¸¥æ ¼çš„SLOæ ‡å‡†ï¼š</p>
<h4 id="slo_1">å¯ç”¨æ€§ SLO</h4>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ç›®æ ‡</th>
<th>é”™è¯¯é¢„ç®—</th>
<th>æµ‹é‡å‘¨æœŸ</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯ç”¨æ€§</td>
<td>â‰¥99.95%</td>
<td>â‰¤21.6åˆ†é’Ÿ/æœˆ</td>
<td>30å¤©æ»šåŠ¨</td>
</tr>
<tr>
<td>æˆåŠŸç‡</td>
<td>â‰¥99.9%</td>
<td>â‰¤43.2åˆ†é’Ÿ/æœˆ</td>
<td>30å¤©æ»šåŠ¨</td>
</tr>
</tbody>
</table>
<h4 id="slo_2">å»¶è¿Ÿ SLO</h4>
<table>
<thead>
<tr>
<th>ç™¾åˆ†ä½</th>
<th>ç›®æ ‡</th>
<th>æµ‹é‡çª—å£</th>
</tr>
</thead>
<tbody>
<tr>
<td>P50</td>
<td>â‰¤100ms</td>
<td>5åˆ†é’Ÿ</td>
</tr>
<tr>
<td>P95</td>
<td>â‰¤250ms</td>
<td>5åˆ†é’Ÿ</td>
</tr>
<tr>
<td>P99</td>
<td>â‰¤500ms</td>
<td>5åˆ†é’Ÿ</td>
</tr>
</tbody>
</table>
<h4 id="slo_3">é”™è¯¯ç‡ SLO</h4>
<table>
<thead>
<tr>
<th>ç±»å‹</th>
<th>ç›®æ ‡</th>
<th>é˜ˆå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>4xxé”™è¯¯</td>
<td>â‰¤1%</td>
<td>è­¦å‘Š</td>
</tr>
<tr>
<td>5xxé”™è¯¯</td>
<td>â‰¤0.1%</td>
<td>ä¸¥é‡</td>
</tr>
</tbody>
</table>
<h3 id="42-prometheus">4.2 Prometheus æŒ‡æ ‡</h3>
<h4 id="_12">ç³»ç»ŸæŒ‡æ ‡å¯¼å‡º</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># monitoring/prometheus_exporter.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">prometheus_client</span><span class="w"> </span><span class="kn">import</span> <span class="n">Counter</span><span class="p">,</span> <span class="n">Histogram</span><span class="p">,</span> <span class="n">Gauge</span>

<span class="c1"># è¯·æ±‚è®¡æ•°</span>
<span class="n">request_count</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span>
    <span class="s1">&#39;hashinsight_requests_total&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Total request count&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;endpoint&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># è¯·æ±‚å»¶è¿Ÿ</span>
<span class="n">request_latency</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;hashinsight_request_latency_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Request latency&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;method&#39;</span><span class="p">,</span> <span class="s1">&#39;endpoint&#39;</span><span class="p">],</span>
    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># ç¼“å­˜å‘½ä¸­ç‡</span>
<span class="n">cache_hit_rate</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;hashinsight_cache_hit_rate&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Cache hit rate percentage&#39;</span>
<span class="p">)</span>

<span class="c1"># æ•°æ®åº“æŸ¥è¯¢æ—¶é—´</span>
<span class="n">db_query_duration</span> <span class="o">=</span> <span class="n">Histogram</span><span class="p">(</span>
    <span class="s1">&#39;hashinsight_db_query_duration_seconds&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Database query duration&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;query_type&#39;</span><span class="p">],</span>
    <span class="n">buckets</span><span class="o">=</span><span class="p">[</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
<span class="p">)</span>

<span class="c1"># SLOåˆè§„æ€§</span>
<span class="n">slo_compliance</span> <span class="o">=</span> <span class="n">Gauge</span><span class="p">(</span>
    <span class="s1">&#39;hashinsight_slo_compliance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;SLO compliance percentage&#39;</span><span class="p">,</span>
    <span class="p">[</span><span class="s1">&#39;slo_type&#39;</span><span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h4 id="_13">æŒ‡æ ‡è®¿é—®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹PrometheusæŒ‡æ ‡</span>
curl<span class="w"> </span>http://localhost:9090/metrics

<span class="c1"># ç¤ºä¾‹è¾“å‡º</span>
<span class="c1"># HELP hashinsight_requests_total Total request count</span>
<span class="c1"># TYPE hashinsight_requests_total counter</span>
hashinsight_requests_total<span class="o">{</span><span class="nv">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>,endpoint<span class="o">=</span><span class="s2">&quot;/dashboard&quot;</span>,status<span class="o">=</span><span class="s2">&quot;200&quot;</span><span class="o">}</span><span class="w"> </span><span class="m">1234</span>

<span class="c1"># HELP hashinsight_request_latency_seconds Request latency</span>
<span class="c1"># TYPE hashinsight_request_latency_seconds histogram</span>
hashinsight_request_latency_seconds_bucket<span class="o">{</span><span class="nv">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>,endpoint<span class="o">=</span><span class="s2">&quot;/api/miners&quot;</span>,le<span class="o">=</span><span class="s2">&quot;0.1&quot;</span><span class="o">}</span><span class="w"> </span><span class="m">450</span>
hashinsight_request_latency_seconds_bucket<span class="o">{</span><span class="nv">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span>,endpoint<span class="o">=</span><span class="s2">&quot;/api/miners&quot;</span>,le<span class="o">=</span><span class="s2">&quot;0.25&quot;</span><span class="o">}</span><span class="w"> </span><span class="m">480</span>
</code></pre></div>

<h3 id="43-grafana">4.3 Grafana ä»ªè¡¨æ¿</h3>
<h4 id="_14">æ ¸å¿ƒç›‘æ§é¢æ¿</h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;dashboard&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;HashInsight Production Monitoring&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;panels&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Request Rate&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(hashinsight_requests_total[5m])&quot;</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;P95 Latency&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;histogram_quantile(0.95, rate(hashinsight_request_latency_seconds_bucket[5m]))&quot;</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Error Rate&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;rate(hashinsight_requests_total{status=~\&quot;5..\&quot;}[5m]) / rate(hashinsight_requests_total[5m])&quot;</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;SLO Compliance&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;targets&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span>
<span class="w">          </span><span class="nt">&quot;expr&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;hashinsight_slo_compliance&quot;</span>
<span class="w">        </span><span class="p">}]</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44">4.4 å‘Šè­¦è§„åˆ™</h3>
<h4 id="prometheus">Prometheus å‘Šè­¦è§„åˆ™</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># prometheus/alerts.yml</span>
<span class="nt">groups</span><span class="p">:</span>
<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashinsight_alerts</span>
<span class="w">    </span><span class="nt">interval</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30s</span>
<span class="w">    </span><span class="nt">rules</span><span class="p">:</span>
<span class="w">      </span><span class="c1"># å¯ç”¨æ€§å‘Šè­¦</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighErrorRate</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">rate(hashinsight_requests_total{status=~&quot;5..&quot;}[5m]) </span>
<span class="w">          </span><span class="no">/ rate(hashinsight_requests_total[5m]) &gt; 0.01</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;High</span><span class="nv"> </span><span class="s">5xx</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">detected&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Error</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}}&quot;</span>

<span class="w">      </span><span class="c1"># å»¶è¿Ÿå‘Šè­¦</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">HighLatency</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span>
<span class="w">          </span><span class="no">histogram_quantile(0.95, </span>
<span class="w">            </span><span class="no">rate(hashinsight_request_latency_seconds_bucket[5m])</span>
<span class="w">          </span><span class="no">) &gt; 0.25</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;P95</span><span class="nv"> </span><span class="s">latency</span><span class="nv"> </span><span class="s">exceeds</span><span class="nv"> </span><span class="s">SLO&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;P95</span><span class="nv"> </span><span class="s">latency</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}s</span><span class="nv"> </span><span class="s">(SLO:</span><span class="nv"> </span><span class="s">0.25s)&quot;</span>

<span class="w">      </span><span class="c1"># SLOé”™è¯¯é¢„ç®—å‘Šè­¦</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ErrorBudgetExhausted</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashinsight_slo_error_budget_remaining &lt; 0.1</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;SLO</span><span class="nv"> </span><span class="s">error</span><span class="nv"> </span><span class="s">budget</span><span class="nv"> </span><span class="s">nearly</span><span class="nv"> </span><span class="s">exhausted&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Only</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">|</span><span class="nv"> </span><span class="s">humanizePercentage</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">budget</span><span class="nv"> </span><span class="s">remaining&quot;</span>

<span class="w">      </span><span class="c1"># æ•°æ®åº“è¿æ¥å‘Šè­¦</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DatabaseConnectionFailure</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashinsight_db_connection_status == 0</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">critical</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Database</span><span class="nv"> </span><span class="s">connection</span><span class="nv"> </span><span class="s">failure&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Unable</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">connect</span><span class="nv"> </span><span class="s">to</span><span class="nv"> </span><span class="s">PostgreSQL&quot;</span>

<span class="w">      </span><span class="c1"># ç¼“å­˜å‘½ä¸­ç‡å‘Šè­¦</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">alert</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LowCacheHitRate</span>
<span class="w">        </span><span class="nt">expr</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">hashinsight_cache_hit_rate &lt; 50</span>
<span class="w">        </span><span class="nt">for</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15m</span>
<span class="w">        </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">          </span><span class="nt">severity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">warning</span>
<span class="w">        </span><span class="nt">annotations</span><span class="p">:</span>
<span class="w">          </span><span class="nt">summary</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Low</span><span class="nv"> </span><span class="s">cache</span><span class="nv"> </span><span class="s">hit</span><span class="nv"> </span><span class="s">rate&quot;</span>
<span class="w">          </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Cache</span><span class="nv"> </span><span class="s">hit</span><span class="nv"> </span><span class="s">rate</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">$value</span><span class="nv"> </span><span class="s">}}%&quot;</span>
</code></pre></div>

<h3 id="45">4.5 ç†”æ–­å™¨é…ç½®</h3>
<p>HashInsightä½¿ç”¨ç†”æ–­å™¨æ¨¡å¼é˜²æ­¢çº§è”æ•…éšœï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># monitoring/circuit_breaker.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">monitoring.circuit_breaker</span><span class="w"> </span><span class="kn">import</span> <span class="n">CircuitBreaker</span><span class="p">,</span> <span class="n">circuit_breaker</span>

<span class="c1"># æ•°æ®åº“æŸ¥è¯¢ç†”æ–­å™¨</span>
<span class="n">db_breaker</span> <span class="o">=</span> <span class="n">CircuitBreaker</span><span class="p">(</span>
    <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>      <span class="c1"># è¿ç»­å¤±è´¥5æ¬¡è§¦å‘</span>
    <span class="n">recovery_timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">,</span>      <span class="c1"># 60ç§’åå°è¯•æ¢å¤</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;database_queries&quot;</span>
<span class="p">)</span>

<span class="c1"># APIè°ƒç”¨ç†”æ–­å™¨</span>
<span class="nd">@circuit_breaker</span><span class="p">(</span>
    <span class="n">failure_threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
    <span class="n">recovery_timeout</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;external_api&quot;</span>
<span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">call_external_api</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;https://api.coinwarz.com/...&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
</code></pre></div>

<h4 id="_15">ç†”æ–­å™¨çŠ¶æ€ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹ç†”æ–­å™¨çŠ¶æ€</span>
curl<span class="w"> </span>http://localhost:5000/api/circuit-breakers

<span class="c1"># å“åº”ç¤ºä¾‹</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;database_queries&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;state&quot;</span>:<span class="w"> </span><span class="s2">&quot;closed&quot;</span>,
<span class="w">    </span><span class="s2">&quot;failure_count&quot;</span>:<span class="w"> </span><span class="m">0</span>,
<span class="w">    </span><span class="s2">&quot;total_calls&quot;</span>:<span class="w"> </span><span class="m">1234</span>,
<span class="w">    </span><span class="s2">&quot;success_rate&quot;</span>:<span class="w"> </span><span class="s2">&quot;99.8%&quot;</span>
<span class="w">  </span><span class="o">}</span>,
<span class="w">  </span><span class="s2">&quot;external_api&quot;</span>:<span class="w"> </span><span class="o">{</span>
<span class="w">    </span><span class="s2">&quot;state&quot;</span>:<span class="w"> </span><span class="s2">&quot;half_open&quot;</span>,
<span class="w">    </span><span class="s2">&quot;failure_count&quot;</span>:<span class="w"> </span><span class="m">3</span>,
<span class="w">    </span><span class="s2">&quot;total_calls&quot;</span>:<span class="w"> </span><span class="m">456</span>,
<span class="w">    </span><span class="s2">&quot;success_rate&quot;</span>:<span class="w"> </span><span class="s2">&quot;95.2%&quot;</span>
<span class="w">  </span><span class="o">}</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="46">4.6 å‘Šè­¦é€šçŸ¥</h3>
<h4 id="slack">Slack é›†æˆ</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç¯å¢ƒå˜é‡é…ç½®</span>
<span class="nv">SLACK_WEBHOOK_URL</span><span class="o">=</span>https://hooks.slack.com/services/T00/B00/xxxxx
<span class="nv">ALERT_SLACK_CHANNEL</span><span class="o">=</span><span class="c1">#hashinsight-alerts</span>
</code></pre></div>

<h4 id="pagerduty">PagerDuty é›†æˆ</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">PAGERDUTY_API_KEY</span><span class="o">=</span>xxxxx
<span class="nv">PAGERDUTY_SERVICE_KEY</span><span class="o">=</span>xxxxx
</code></pre></div>

<h3 id="47">4.7 ç›‘æ§æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] Prometheusæ­£åœ¨æŠ“å–æŒ‡æ ‡ (<code>:9090/targets</code>)</li>
<li>[ ] Grafanaä»ªè¡¨æ¿æ˜¾ç¤ºæ•°æ®</li>
<li>[ ] å‘Šè­¦è§„åˆ™å·²åŠ è½½</li>
<li>[ ] Slack/PagerDutyé€šçŸ¥æ­£å¸¸</li>
<li>[ ] SLOç›‘æ§é¢æ¿æ˜¾ç¤ºç»¿è‰²</li>
<li>[ ] ç†”æ–­å™¨çŠ¶æ€æ­£å¸¸</li>
</ul>
<hr />
<h2 id="5">ç¬¬5ç« ï¼šå¤‡ä»½ä¸æ¢å¤</h2>
<h3 id="51">5.1 è‡ªåŠ¨å¤‡ä»½ç­–ç•¥</h3>
<p>HashInsight ä½¿ç”¨ <code>backup/backup_manager.py</code> è¿›è¡Œè‡ªåŠ¨åŒ–å¤‡ä»½ï¼š</p>
<h4 id="_16">å¤‡ä»½ç‰¹æ€§</h4>
<ul>
<li>âœ… <strong>PostgreSQLå®Œæ•´å¤‡ä»½</strong> (pg_dump)</li>
<li>âœ… <strong>AES-256åŠ å¯†</strong> (å¤‡ä»½æ–‡ä»¶åŠ å¯†)</li>
<li>âœ… <strong>gzipå‹ç¼©</strong> (èŠ‚çœå­˜å‚¨ç©ºé—´)</li>
<li>âœ… <strong>è¿œç¨‹å­˜å‚¨</strong> (S3/Azure/GCSæ”¯æŒ)</li>
<li>âœ… <strong>å®Œæ•´æ€§éªŒè¯</strong> (SHA256æ ¡éªŒå’Œ)</li>
</ul>
<h4 id="_17">å¤‡ä»½è°ƒåº¦</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># é€šè¿‡croné…ç½®è‡ªåŠ¨å¤‡ä»½</span>
<span class="c1"># /etc/cron.d/hashinsight-backup</span>

<span class="c1"># æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œå®Œæ•´å¤‡ä»½</span>
<span class="m">0</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/usr/bin/python3<span class="w"> </span>/app/backup/backup_manager.py<span class="w"> </span>--type<span class="w"> </span>full

<span class="c1"># æ¯4å°æ—¶æ‰§è¡Œå¢é‡å¤‡ä»½</span>
<span class="m">0</span><span class="w"> </span>*/4<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span>/usr/bin/python3<span class="w"> </span>/app/backup/backup_manager.py<span class="w"> </span>--type<span class="w"> </span>incremental

<span class="c1"># æ¯å‘¨æ—¥å‡Œæ™¨3ç‚¹ä¸Šä¼ åˆ°è¿œç¨‹å­˜å‚¨</span>
<span class="m">0</span><span class="w"> </span><span class="m">3</span><span class="w"> </span>*<span class="w"> </span>*<span class="w"> </span><span class="m">0</span><span class="w"> </span>/usr/bin/python3<span class="w"> </span>/app/backup/backup_manager.py<span class="w"> </span>--upload
</code></pre></div>

<h3 id="52">5.2 æ‰‹åŠ¨å¤‡ä»½</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ‰§è¡Œå®Œæ•´å¤‡ä»½</span>
python<span class="w"> </span>backup/backup_manager.py

<span class="c1"># å¤‡ä»½è¾“å‡ºç¤ºä¾‹</span>
âœ…<span class="w"> </span>å¤‡ä»½åˆ›å»ºæˆåŠŸ:<span class="w"> </span>hashinsight_backup_20251003_140000.sql.gz.enc
ğŸ“¦<span class="w"> </span>å¤§å°:<span class="w"> </span><span class="m">245</span>.3<span class="w"> </span>MB
ğŸ”<span class="w"> </span>å·²åŠ å¯†:<span class="w"> </span>AES-256
âœ…<span class="w"> </span>æ ¡éªŒå’Œ:<span class="w"> </span>e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855
â±ï¸<span class="w">  </span>è€—æ—¶:<span class="w"> </span><span class="m">45</span>.2s
</code></pre></div>

<h3 id="53">5.3 å¤‡ä»½ä¿ç•™ç­–ç•¥</h3>
<table>
<thead>
<tr>
<th>å¤‡ä»½ç±»å‹</th>
<th>ä¿ç•™æ—¶é—´</th>
<th>é¢‘ç‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>å®Œæ•´å¤‡ä»½</td>
<td>30å¤©</td>
<td>æ¯æ—¥</td>
</tr>
<tr>
<td>å¢é‡å¤‡ä»½</td>
<td>7å¤©</td>
<td>æ¯4å°æ—¶</td>
</tr>
<tr>
<td>å‘¨å¤‡ä»½</td>
<td>12å‘¨</td>
<td>æ¯å‘¨æ—¥</td>
</tr>
<tr>
<td>æœˆå¤‡ä»½</td>
<td>12ä¸ªæœˆ</td>
<td>æ¯æœˆ1æ—¥</td>
</tr>
</tbody>
</table>
<h4 id="_18">è‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¸…ç†30å¤©å‰çš„å¤‡ä»½</span>
python<span class="w"> </span>backup/backup_manager.py<span class="w"> </span>--cleanup<span class="w"> </span>--days<span class="w"> </span><span class="m">30</span>

<span class="c1"># è¾“å‡º</span>
ğŸ—‘ï¸<span class="w">  </span>åˆ é™¤æ—§å¤‡ä»½:<span class="w"> </span>hashinsight_backup_20250903_*.sql.gz.enc
âœ…<span class="w"> </span>æ¸…ç†å®Œæˆ:<span class="w"> </span>é‡Šæ”¾<span class="w"> </span><span class="m">2</span>.1<span class="w"> </span>GB
</code></pre></div>

<h3 id="54-rtorpo">5.4 RTO/RPO ç›®æ ‡</h3>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ç›®æ ‡</th>
<th>å®é™…</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>RTO</strong> (æ¢å¤æ—¶é—´ç›®æ ‡)</td>
<td>â‰¤4å°æ—¶</td>
<td>~2å°æ—¶</td>
</tr>
<tr>
<td><strong>RPO</strong> (æ¢å¤ç‚¹ç›®æ ‡)</td>
<td>â‰¤15åˆ†é’Ÿ</td>
<td>~4å°æ—¶</td>
</tr>
</tbody>
</table>
<h3 id="55">5.5 å¤‡ä»½æ¢å¤æµç¨‹</h3>
<h4 id="step-1">Step 1: åˆ—å‡ºå¯ç”¨å¤‡ä»½</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ—å‡ºæœ¬åœ°å¤‡ä»½</span>
ls<span class="w"> </span>-lh<span class="w"> </span>/tmp/backups/

<span class="c1"># åˆ—å‡ºè¿œç¨‹å¤‡ä»½ (S3)</span>
aws<span class="w"> </span>s3<span class="w"> </span>ls<span class="w"> </span>s3://hashinsight-backups/
</code></pre></div>

<h4 id="step-2">Step 2: ä¸‹è½½å¤‡ä»½ (å¦‚æœåœ¨è¿œç¨‹)</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä»S3ä¸‹è½½</span>
aws<span class="w"> </span>s3<span class="w"> </span>cp<span class="w"> </span>s3://hashinsight-backups/hashinsight_backup_20251003_020000.sql.gz.enc<span class="w"> </span>/tmp/restore/

<span class="c1"># ä»Azureä¸‹è½½</span>
az<span class="w"> </span>storage<span class="w"> </span>blob<span class="w"> </span>download<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--account-name<span class="w"> </span>hashinsight<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--container-name<span class="w"> </span>backups<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--name<span class="w"> </span>hashinsight_backup_20251003_020000.sql.gz.enc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--file<span class="w"> </span>/tmp/restore/backup.sql.gz.enc
</code></pre></div>

<h4 id="step-3">Step 3: è§£å¯†å¤‡ä»½</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨backup_managerè§£å¯†</span>
python<span class="w"> </span>backup/backup_manager.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--decrypt<span class="w"> </span>/tmp/restore/hashinsight_backup_20251003_020000.sql.gz.enc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>/tmp/restore/backup.sql.gz

<span class="c1"># æ‰‹åŠ¨è§£å¯† (å¦‚æœéœ€è¦)</span>
openssl<span class="w"> </span>enc<span class="w"> </span>-d<span class="w"> </span>-aes-256-cbc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-in<span class="w"> </span>hashinsight_backup_20251003_020000.sql.gz.enc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-out<span class="w"> </span>backup.sql.gz<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-pass<span class="w"> </span>env:BACKUP_ENCRYPTION_KEY
</code></pre></div>

<h4 id="step-4">Step 4: è§£å‹å¤‡ä»½</h4>
<div class="codehilite"><pre><span></span><code>gunzip<span class="w"> </span>/tmp/restore/backup.sql.gz
<span class="c1"># è¾“å‡º: backup.sql</span>
</code></pre></div>

<h4 id="step-5">Step 5: æ¢å¤æ•°æ®åº“</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># âš ï¸ è­¦å‘Š: è¿™å°†è¦†ç›–ç°æœ‰æ•°æ®åº“!</span>
<span class="c1"># å»ºè®®å…ˆå¤‡ä»½å½“å‰æ•°æ®åº“</span>

<span class="c1"># æ¢å¤åˆ°PostgreSQL</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>&lt;<span class="w"> </span>/tmp/restore/backup.sql

<span class="c1"># éªŒè¯æ¢å¤</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT COUNT(*) FROM users;&quot;</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT COUNT(*) FROM miners;&quot;</span>
</code></pre></div>

<h4 id="step-6">Step 6: éªŒè¯åº”ç”¨</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># é‡å¯åº”ç”¨</span>
systemctl<span class="w"> </span>restart<span class="w"> </span>hashinsight

<span class="c1"># æ£€æŸ¥å¥åº·çŠ¶æ€</span>
curl<span class="w"> </span>http://localhost:5000/health

<span class="c1"># éªŒè¯å…³é”®åŠŸèƒ½</span>
curl<span class="w"> </span>http://localhost:5000/api/miners<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.count&#39;</span>
</code></pre></div>

<h3 id="56">5.6 ç¾éš¾æ¢å¤æ¼”ç»ƒ</h3>
<p><strong>å»ºè®®é¢‘ç‡</strong>: æ¯å­£åº¦ä¸€æ¬¡</p>
<h4 id="_19">æ¼”ç»ƒæ­¥éª¤</h4>
<ol>
<li><strong>å‡†å¤‡æ¼”ç»ƒç¯å¢ƒ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ›å»ºç‹¬ç«‹çš„æ¼”ç»ƒæ•°æ®åº“</span>
createdb<span class="w"> </span>hashinsight_dr_test
<span class="nb">export</span><span class="w"> </span><span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://localhost/hashinsight_dr_test
</code></pre></div>

<ol start="2">
<li><strong>æ¨¡æ‹Ÿæ•°æ®ä¸¢å¤±</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ é™¤æ¼”ç»ƒæ•°æ®åº“å†…å®¹</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;DROP SCHEMA public CASCADE; CREATE SCHEMA public;&quot;</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>æ‰§è¡Œæ¢å¤</strong> (æŒ‰5.5æµç¨‹)</p>
</li>
<li>
<p><strong>éªŒè¯æ¢å¤å®Œæ•´æ€§</strong></p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¿è¡Œæ•°æ®å®Œæ•´æ€§æ£€æŸ¥</span>
python<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">from app import app, db</span>
<span class="s2">from models import User, Miner</span>
<span class="s2">with app.app_context():</span>
<span class="s2">    assert db.session.query(User).count() &gt; 0</span>
<span class="s2">    assert db.session.query(Miner).count() &gt; 0</span>
<span class="s2">    print(&#39;âœ… æ¢å¤éªŒè¯é€šè¿‡&#39;)</span>
<span class="s2">&quot;</span>
</code></pre></div>

<ol start="5">
<li><strong>è®°å½•æ¼”ç»ƒç»“æœ</strong>
   - æ¢å¤è€—æ—¶
   - æ•°æ®å®Œæ•´æ€§
   - å‘ç°çš„é—®é¢˜
   - æ”¹è¿›å»ºè®®</li>
</ol>
<h3 id="57">5.7 å¤‡ä»½ç›‘æ§</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æŸ¥æœ€è¿‘å¤‡ä»½æ—¶é—´</span>
stat<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;%y&#39;</span><span class="w"> </span>/tmp/backups/hashinsight_backup_*.sql.gz.enc<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-1

<span class="c1"># å¤‡ä»½æ–‡ä»¶å¤§å°è¶‹åŠ¿</span>
du<span class="w"> </span>-h<span class="w"> </span>/tmp/backups/hashinsight_backup_*.sql.gz.enc

<span class="c1"># å¤‡ä»½å®Œæ•´æ€§éªŒè¯</span>
python<span class="w"> </span>backup/backup_manager.py<span class="w"> </span>--verify<span class="w"> </span>/tmp/backups/hashinsight_backup_20251003_020000.sql.gz.enc
</code></pre></div>

<hr />
<h2 id="6">ç¬¬6ç« ï¼šå®‰å…¨è¿ç»´è§„èŒƒ</h2>
<h3 id="61-kms">6.1 KMSå¯†é’¥ç®¡ç†</h3>
<p>HashInsight æ”¯æŒä¼ä¸šçº§KMSé›†æˆ (<code>common/crypto/envelope.py</code>)ï¼š</p>
<h4 id="_20">ä¿¡å°åŠ å¯†åŸç†</h4>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. åº”ç”¨è¯·æ±‚åŠ å¯†æ•°æ®                              â”‚
â”‚  2. KMSç”Ÿæˆæ•°æ®åŠ å¯†å¯†é’¥(DEK)                      â”‚
â”‚  3. ä½¿ç”¨DEKåŠ å¯†æ•°æ®                               â”‚
â”‚  4. ä½¿ç”¨KMSä¸»å¯†é’¥(CMK)åŠ å¯†DEK                     â”‚
â”‚  5. å­˜å‚¨: åŠ å¯†æ•°æ® + åŠ å¯†çš„DEK                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â–²
    â”‚ å¯†é’¥æ°¸ä¸ç¦»å¼€KMS
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è§£å¯†æµç¨‹:                                        â”‚
â”‚  1. ä»å­˜å‚¨è·å–åŠ å¯†æ•°æ® + åŠ å¯†DEK                  â”‚
â”‚  2. è°ƒç”¨KMSè§£å¯†DEK                                â”‚
â”‚  3. ä½¿ç”¨è§£å¯†åçš„DEKè§£å¯†æ•°æ®                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h4 id="kms">æ”¯æŒçš„KMSæä¾›å•†</h4>
<h5 id="aws-kms_1">AWS KMS</h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># é…ç½®AWS KMS</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">common.crypto.envelope</span><span class="w"> </span><span class="kn">import</span> <span class="n">KMSClient</span><span class="p">,</span> <span class="n">KMSProvider</span><span class="p">,</span> <span class="n">EncryptionContext</span>

<span class="n">kms_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;key_id&#39;</span><span class="p">:</span> <span class="s1">&#39;arn:aws:kms:us-east-1:123456789:key/xxxxx&#39;</span><span class="p">,</span>
    <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="s1">&#39;us-east-1&#39;</span>
<span class="p">}</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">KMSClient</span><span class="p">(</span><span class="n">KMSProvider</span><span class="o">.</span><span class="n">AWS_KMS</span><span class="p">,</span> <span class="n">kms_config</span><span class="p">)</span>

<span class="c1"># åŠ å¯†æ•æ„Ÿæ•°æ®</span>
<span class="n">context</span> <span class="o">=</span> <span class="n">EncryptionContext</span><span class="p">(</span>
    <span class="n">purpose</span><span class="o">=</span><span class="s2">&quot;user_data_encryption&quot;</span><span class="p">,</span>
    <span class="n">tenant_id</span><span class="o">=</span><span class="s2">&quot;tenant_123&quot;</span>
<span class="p">)</span>

<span class="n">ciphertext</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">encrypt_secret</span><span class="p">(</span>
    <span class="n">plaintext</span><span class="o">=</span><span class="s2">&quot;sensitive data&quot;</span><span class="p">,</span>
    <span class="n">key_id</span><span class="o">=</span><span class="n">kms_config</span><span class="p">[</span><span class="s1">&#39;key_id&#39;</span><span class="p">],</span>
    <span class="n">context</span><span class="o">=</span><span class="n">context</span>
<span class="p">)</span>
</code></pre></div>

<h5 id="gcp-kms_1">GCP KMS</h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># é…ç½®GCP KMS</span>
<span class="n">kms_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;project_id&#39;</span><span class="p">:</span> <span class="s1">&#39;hashinsight-prod&#39;</span><span class="p">,</span>
    <span class="s1">&#39;location&#39;</span><span class="p">:</span> <span class="s1">&#39;us-east1&#39;</span><span class="p">,</span>
    <span class="s1">&#39;keyring&#39;</span><span class="p">:</span> <span class="s1">&#39;hashinsight-keyring&#39;</span><span class="p">,</span>
    <span class="s1">&#39;key_id&#39;</span><span class="p">:</span> <span class="s1">&#39;encryption-key&#39;</span>
<span class="p">}</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">KMSClient</span><span class="p">(</span><span class="n">KMSProvider</span><span class="o">.</span><span class="n">GCP_KMS</span><span class="p">,</span> <span class="n">kms_config</span><span class="p">)</span>
</code></pre></div>

<h5 id="azure-key-vault_1">Azure Key Vault</h5>
<div class="codehilite"><pre><span></span><code><span class="c1"># é…ç½®Azure Key Vault</span>
<span class="n">kms_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;vault_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://hashinsight-vault.vault.azure.net/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;key_name&#39;</span><span class="p">:</span> <span class="s1">&#39;encryption-key&#39;</span>
<span class="p">}</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">KMSClient</span><span class="p">(</span><span class="n">KMSProvider</span><span class="o">.</span><span class="n">AZURE_KEY_VAULT</span><span class="p">,</span> <span class="n">kms_config</span><span class="p">)</span>
</code></pre></div>

<h4 id="_21">å¯†é’¥è½®æ¢æµç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. åœ¨KMSä¸­åˆ›å»ºæ–°å¯†é’¥ç‰ˆæœ¬</span>
aws<span class="w"> </span>kms<span class="w"> </span>create-key<span class="w"> </span>--description<span class="w"> </span><span class="s2">&quot;HashInsight Master Key v2&quot;</span>

<span class="c1"># 2. æ›´æ–°åº”ç”¨é…ç½®</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">AWS_KMS_KEY_ID</span><span class="o">=</span>arn:aws:kms:us-east-1:123456789:key/new-key-id

<span class="c1"># 3. é‡æ–°åŠ å¯†ç°æœ‰æ•°æ® (åå°ä»»åŠ¡)</span>
python<span class="w"> </span>scripts/rotate_encryption_keys.py<span class="w"> </span>--old-key<span class="w"> </span>OLD_KEY_ID<span class="w"> </span>--new-key<span class="w"> </span>NEW_KEY_ID

<span class="c1"># 4. éªŒè¯æ–°å¯†é’¥</span>
python<span class="w"> </span>scripts/verify_encryption.py<span class="w"> </span>--key-id<span class="w"> </span>NEW_KEY_ID

<span class="c1"># 5. åœç”¨æ—§å¯†é’¥ (ä¿ç•™90å¤©)</span>
aws<span class="w"> </span>kms<span class="w"> </span>disable-key<span class="w"> </span>--key-id<span class="w"> </span>OLD_KEY_ID
</code></pre></div>

<h3 id="62-mtls">6.2 mTLSåŒå‘è®¤è¯</h3>
<h4 id="_22">è¯ä¹¦ç”Ÿæˆ</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. ç”ŸæˆCAè¯ä¹¦</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>ca.key<span class="w"> </span><span class="m">4096</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-x509<span class="w"> </span>-days<span class="w"> </span><span class="m">3650</span><span class="w"> </span>-key<span class="w"> </span>ca.key<span class="w"> </span>-out<span class="w"> </span>ca.crt<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=HashInsight/CN=HashInsight Root CA&quot;</span>

<span class="c1"># 2. ç”ŸæˆæœåŠ¡å™¨è¯ä¹¦</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>server.key<span class="w"> </span><span class="m">4096</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>server.key<span class="w"> </span>-out<span class="w"> </span>server.csr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=HashInsight/CN=*.hashinsight.net&quot;</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>server.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-CAcreateserial<span class="w"> </span>-out<span class="w"> </span>server.crt

<span class="c1"># 3. ç”Ÿæˆå®¢æˆ·ç«¯è¯ä¹¦</span>
openssl<span class="w"> </span>genrsa<span class="w"> </span>-out<span class="w"> </span>client.key<span class="w"> </span><span class="m">4096</span>
openssl<span class="w"> </span>req<span class="w"> </span>-new<span class="w"> </span>-key<span class="w"> </span>client.key<span class="w"> </span>-out<span class="w"> </span>client.csr<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-subj<span class="w"> </span><span class="s2">&quot;/C=US/O=HashInsight/CN=client.hashinsight.net&quot;</span>
openssl<span class="w"> </span>x509<span class="w"> </span>-req<span class="w"> </span>-days<span class="w"> </span><span class="m">365</span><span class="w"> </span>-in<span class="w"> </span>client.csr<span class="w"> </span>-CA<span class="w"> </span>ca.crt<span class="w"> </span>-CAkey<span class="w"> </span>ca.key<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>-CAcreateserial<span class="w"> </span>-out<span class="w"> </span>client.crt
</code></pre></div>

<h4 id="mtls">mTLSé…ç½®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç¯å¢ƒå˜é‡é…ç½®</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_CA_CERT_PATH</span><span class="o">=</span>/app/certs/ca.crt
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_SERVER_CERT_PATH</span><span class="o">=</span>/app/certs/server.crt
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_SERVER_KEY_PATH</span><span class="o">=</span>/app/certs/server.key
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_VERIFY_CLIENT</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">MTLS_ALLOWED_DN_PATTERNS</span><span class="o">=</span><span class="s2">&quot;CN=*.hashinsight.net,O=HashInsight,C=US&quot;</span>
</code></pre></div>

<h4 id="mtls_1">ä½¿ç”¨mTLSè®¤è¯</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">common.mtls_auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">require_mtls</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/admin/sensitive&#39;</span><span class="p">)</span>
<span class="nd">@require_mtls</span><span class="p">()</span>
<span class="k">def</span><span class="w"> </span><span class="nf">sensitive_endpoint</span><span class="p">():</span>
    <span class="c1"># ä»…å…è®¸æŒæœ‰æœ‰æ•ˆå®¢æˆ·ç«¯è¯ä¹¦çš„è¯·æ±‚</span>
    <span class="n">client_dn</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">client_cert_subject</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">({</span><span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;Authenticated as </span><span class="si">{</span><span class="n">client_dn</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
</code></pre></div>

<h3 id="63-api">6.3 APIå¯†é’¥ç®¡ç†</h3>
<h4 id="_23">å¯†é’¥æ ¼å¼</h4>
<p>HashInsight APIå¯†é’¥æ ¼å¼: <code>hsi_{env}_key_{random}</code></p>
<p>ç¤ºä¾‹:
- ç”Ÿäº§: <code>hsi_prod_key_a1b2c3d4e5f6g7h8</code>
- å¼€å‘: <code>hsi_dev_key_x9y8z7w6v5u4t3s2</code></p>
<h4 id="api">åˆ›å»ºAPIå¯†é’¥</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨ç®¡ç†å·¥å…·åˆ›å»º</span>
python<span class="w"> </span>scripts/create_api_key.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--user-id<span class="w"> </span><span class="m">123</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--permissions<span class="w"> </span><span class="s2">&quot;miners:read,miners:write&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--expires-in<span class="w"> </span><span class="m">90</span>

<span class="c1"># è¾“å‡º</span>
âœ…<span class="w"> </span>APIå¯†é’¥å·²åˆ›å»º
å¯†é’¥:<span class="w"> </span>hsi_prod_key_a1b2c3d4e5f6g7h8
ç”¨æˆ·ID:<span class="w"> </span><span class="m">123</span>
æƒé™:<span class="w"> </span>miners:read,miners:write
è¿‡æœŸæ—¶é—´:<span class="w"> </span><span class="m">2025</span>-12-31T23:59:59Z
âš ï¸<span class="w">  </span>è¯·å¦¥å–„ä¿ç®¡æ­¤å¯†é’¥ï¼Œå®ƒä¸ä¼šå†æ¬¡æ˜¾ç¤º
</code></pre></div>

<h4 id="api_1">APIå¯†é’¥è½®æ¢</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. åˆ›å»ºæ–°å¯†é’¥</span>
<span class="nv">new_key</span><span class="o">=</span><span class="k">$(</span>python<span class="w"> </span>scripts/create_api_key.py<span class="w"> </span>--user-id<span class="w"> </span><span class="m">123</span><span class="w"> </span>--copy-from<span class="w"> </span>old_key_id<span class="k">)</span>

<span class="c1"># 2. æ›´æ–°å®¢æˆ·ç«¯é…ç½® (åŒå¯†é’¥å¹¶å­˜æœŸ7å¤©)</span>
<span class="c1"># æ–°æ—§å¯†é’¥åŒæ—¶æœ‰æ•ˆ</span>

<span class="c1"># 3. éªŒè¯æ–°å¯†é’¥</span>
curl<span class="w"> </span>-H<span class="w"> </span><span class="s2">&quot;Authorization: Bearer </span><span class="nv">$new_key</span><span class="s2">&quot;</span><span class="w"> </span>http://localhost:5000/api/miners

<span class="c1"># 4. åŠé”€æ—§å¯†é’¥</span>
python<span class="w"> </span>scripts/revoke_api_key.py<span class="w"> </span>--key-id<span class="w"> </span>old_key_id
</code></pre></div>

<h3 id="64-wireguard">6.4 WireGuardä¼ä¸šä¸“ç½‘</h3>
<h4 id="hub">HubæœåŠ¡å™¨éƒ¨ç½²</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. è¿è¡ŒHubå®‰è£…è„šæœ¬</span>
sudo<span class="w"> </span>bash<span class="w"> </span>wireguard/hub_setup.sh

<span class="c1"># 2. é…ç½®é˜²ç«å¢™</span>
sudo<span class="w"> </span>ufw<span class="w"> </span>allow<span class="w"> </span><span class="m">51820</span>/udp
sudo<span class="w"> </span>ufw<span class="w"> </span><span class="nb">enable</span>

<span class="c1"># 3. å¯åŠ¨WireGuard</span>
sudo<span class="w"> </span>systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>wg-quick@wg0
sudo<span class="w"> </span>systemctl<span class="w"> </span>start<span class="w"> </span>wg-quick@wg0

<span class="c1"># 4. æŸ¥çœ‹çŠ¶æ€</span>
sudo<span class="w"> </span>wg<span class="w"> </span>show
</code></pre></div>

<h4 id="_24">ç«™ç‚¹ç½‘å…³é…ç½®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. ç”Ÿæˆç«™ç‚¹å¯†é’¥</span>
<span class="nb">cd</span><span class="w"> </span>wireguard/site-gateway
python<span class="w"> </span>key_manager.py<span class="w"> </span>--generate-keys<span class="w"> </span>--site<span class="w"> </span>beijing-dc1

<span class="c1"># 2. æ·»åŠ åˆ°Hubé…ç½®</span>
sudo<span class="w"> </span>nano<span class="w"> </span>/etc/wireguard/wg0.conf

<span class="c1"># æ·»åŠ Peeré…ç½®</span>
<span class="o">[</span>Peer<span class="o">]</span>
<span class="nv">PublicKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>site_public_key
<span class="nv">AllowedIPs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span>.8.1.0/24
<span class="nv">Endpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>beijing-gateway.hashinsight.net:51820

<span class="c1"># 3. é‡è½½é…ç½®</span>
sudo<span class="w"> </span>wg-quick<span class="w"> </span>down<span class="w"> </span>wg0
sudo<span class="w"> </span>wg-quick<span class="w"> </span>up<span class="w"> </span>wg0
</code></pre></div>

<h3 id="65">6.5 å®¡è®¡æ—¥å¿—</h3>
<p>HashInsight è®°å½•æ‰€æœ‰å…³é”®æ“ä½œåˆ°å®¡è®¡æ—¥å¿— (<code>audit/audit_logger.py</code>)ï¼š</p>
<h4 id="_25">å®¡è®¡äº‹ä»¶ç±»å‹</h4>
<ul>
<li>âœ… è®¤è¯ (ç™»å½•/ç™»å‡º/å¤±è´¥)</li>
<li>âœ… æ•°æ®è®¿é—® (CRUDæ“ä½œ)</li>
<li>âœ… é…ç½®å˜æ›´</li>
<li>âœ… æƒé™å˜æ›´</li>
<li>âœ… åŠ å¯†æ“ä½œ</li>
<li>âœ… APIå¯†é’¥ç®¡ç†</li>
<li>âœ… å¯ç–‘æ´»åŠ¨</li>
</ul>
<h4 id="_26">å®¡è®¡æ—¥å¿—æ ¼å¼</h4>
<div class="codehilite"><pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2025-10-03T12:00:00.000Z&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;event_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;a1b2c3d4e5f6g7h8&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;level&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;INFO&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;category&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;authentication&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;action&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;login&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;123&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_email&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;user@example.com&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;user_role&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;admin&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;ip_address&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;192.168.1.100&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;status&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;success&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;details&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;login_method&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;password&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;two_factor&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="_27">æŸ¥è¯¢å®¡è®¡æ—¥å¿—</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹æœ€è¿‘100æ¡å®¡è®¡æ—¥å¿—</span>
tail<span class="w"> </span>-100<span class="w"> </span>logs/audit.jsonl

<span class="c1"># æŸ¥è¯¢ç‰¹å®šç”¨æˆ·çš„æ“ä½œ</span>
jq<span class="w"> </span><span class="s1">&#39;select(.user_email == &quot;admin@hashinsight.net&quot;)&#39;</span><span class="w"> </span>logs/audit.jsonl

<span class="c1"># æŸ¥è¯¢å¤±è´¥çš„ç™»å½•å°è¯•</span>
jq<span class="w"> </span><span class="s1">&#39;select(.action == &quot;login_failed&quot;)&#39;</span><span class="w"> </span>logs/audit.jsonl

<span class="c1"># æŸ¥è¯¢è¿‡å»24å°æ—¶çš„å®‰å…¨äº‹ä»¶</span>
jq<span class="w"> </span>--arg<span class="w"> </span>date<span class="w"> </span><span class="s2">&quot;</span><span class="k">$(</span>date<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;24 hours ago&#39;</span><span class="w"> </span>-Iseconds<span class="k">)</span><span class="s2">&quot;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="s1">&#39;select(.timestamp &gt; $date and .level == &quot;SECURITY&quot;)&#39;</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>logs/audit.jsonl
</code></pre></div>

<h3 id="66">6.6 åˆè§„è¦æ±‚</h3>
<p>HashInsight éµå¾ªä»¥ä¸‹åˆè§„æ ‡å‡†ï¼š</p>
<h4 id="soc-2-type-ii">SOC 2 Type II</h4>
<ul>
<li>âœ… è®¿é—®æ§åˆ¶</li>
<li>âœ… åŠ å¯†ä¼ è¾“ (TLS 1.3)</li>
<li>âœ… åŠ å¯†å­˜å‚¨ (AES-256)</li>
<li>âœ… å®¡è®¡æ—¥å¿— (ä¸å¯ç¯¡æ”¹)</li>
<li>âœ… å˜æ›´ç®¡ç†</li>
<li>âœ… ç¾éš¾æ¢å¤</li>
</ul>
<h4 id="pci-dss">PCI DSS (å¦‚å¤„ç†æ”¯ä»˜)</h4>
<ul>
<li>âœ… æ•æ„Ÿæ•°æ®è„±æ•</li>
<li>âœ… å¯†é’¥ç®¡ç† (KMS)</li>
<li>âœ… ç½‘ç»œéš”ç¦» (WireGuard)</li>
<li>âœ… å®šæœŸæ¸—é€æµ‹è¯•</li>
</ul>
<h4 id="gdpr">GDPR</h4>
<ul>
<li>âœ… æ•°æ®æœ€å°åŒ–</li>
<li>âœ… ç”¨æˆ·æ•°æ®å¯¼å‡º</li>
<li>âœ… æ•°æ®åˆ é™¤ (è¢«é—å¿˜æƒ)</li>
<li>âœ… æ•°æ®å¤„ç†è®°å½•</li>
</ul>
<h3 id="67">6.7 å®‰å…¨æ£€æŸ¥æ¸…å•</h3>
<ul>
<li>[ ] æ‰€æœ‰å¯†é’¥å­˜å‚¨åœ¨KMSä¸­ (ä¸åœ¨ä»£ç /é…ç½®æ–‡ä»¶)</li>
<li>[ ] å¯ç”¨mTLS (ç”Ÿäº§ç¯å¢ƒ)</li>
<li>[ ] APIå¯†é’¥å®šæœŸè½®æ¢ (90å¤©)</li>
<li>[ ] SSL/TLSè¯ä¹¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ</li>
<li>[ ] å®¡è®¡æ—¥å¿—æ­£å¸¸å†™å…¥</li>
<li>[ ] æ— æ•æ„Ÿä¿¡æ¯æ³„éœ²åˆ°æ—¥å¿—</li>
<li>[ ] æ•°æ®åº“è¿æ¥åŠ å¯† (SSL)</li>
<li>[ ] ä¼šè¯å¯†é’¥å¼ºåº¦ â‰¥256ä½</li>
<li>[ ] å®šæœŸå®‰å…¨æ‰«æ (æ¯å­£åº¦)</li>
<li>[ ] æ¸—é€æµ‹è¯•æŠ¥å‘Š (æ¯å¹´)</li>
</ul>
<hr />
<h2 id="7">ç¬¬7ç« ï¼šæ•…éšœæ’æŸ¥æ‰‹å†Œ</h2>
<h3 id="71">7.1 åº”ç”¨æ— æ³•å¯åŠ¨</h3>
<h4 id="_28">ç—‡çŠ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="err">$</span><span class="w"> </span><span class="n">gunicorn</span><span class="w"> </span><span class="nl">main</span><span class="p">:</span><span class="n">app</span>
<span class="o">[</span><span class="n">ERROR</span><span class="o">]</span><span class="w"> </span><span class="n">Application</span><span class="w"> </span><span class="n">failed</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">start</span>
</code></pre></div>

<h4 id="_29">è¯Šæ–­æ­¥éª¤</h4>
<p><strong>1. æ£€æŸ¥ç«¯å£å ç”¨</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹ç«¯å£5000å ç”¨æƒ…å†µ</span>
lsof<span class="w"> </span>-i<span class="w"> </span>:5000

<span class="c1"># å¦‚æœè¢«å ç”¨ï¼Œæ€æ­»è¿›ç¨‹</span>
<span class="nb">kill</span><span class="w"> </span>-9<span class="w"> </span><span class="k">$(</span>lsof<span class="w"> </span>-t<span class="w"> </span>-i:5000<span class="k">)</span>
</code></pre></div>

<p><strong>2. æ£€æŸ¥ç¯å¢ƒå˜é‡</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># éªŒè¯å¿…éœ€å˜é‡</span>
python3<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">import os</span>
<span class="s">required = [&#39;DATABASE_URL&#39;, &#39;SESSION_SECRET&#39;, &#39;ENCRYPTION_PASSWORD&#39;]</span>
<span class="s">for var in required:</span>
<span class="s">    value = os.getenv(var)</span>
<span class="s">    if not value:</span>
<span class="s">        print(f&quot;âŒ Missing: {var}&quot;)</span>
<span class="s">    else:</span>
<span class="s">        print(f&quot;âœ… {var}: {&#39;*&#39; * 8} (set)&quot;)</span>
<span class="s">EOF</span>
</code></pre></div>

<p><strong>3. æ£€æŸ¥æ•°æ®åº“è¿æ¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æµ‹è¯•PostgreSQLè¿æ¥</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT version();&quot;</span>

<span class="c1"># å¦‚æœå¤±è´¥ï¼Œæ£€æŸ¥Neonç«¯ç‚¹çŠ¶æ€</span>
<span class="c1"># è®¿é—® https://console.neon.tech</span>
</code></pre></div>

<p><strong>4. æ£€æŸ¥Pythonä¾èµ–</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># éªŒè¯å…³é”®åº“</span>
python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">import flask</span>
<span class="s2">import gunicorn</span>
<span class="s2">import psycopg2</span>
<span class="s2">import sqlalchemy</span>
<span class="s2">print(&#39;âœ… All dependencies OK&#39;)</span>
<span class="s2">&quot;</span>
</code></pre></div>

<p><strong>5. æŸ¥çœ‹è¯¦ç»†é”™è¯¯</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯ç”¨è°ƒè¯•æ¨¡å¼</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">FLASK_DEBUG</span><span class="o">=</span><span class="m">1</span>
python3<span class="w"> </span>main.py

<span class="c1"># æŸ¥çœ‹å®Œæ•´å †æ ˆè·Ÿè¸ª</span>
</code></pre></div>

<h4 id="_30">å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ</h4>
<table>
<thead>
<tr>
<th>é”™è¯¯</th>
<th>åŸå› </th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ModuleNotFoundError: No module named 'flask'</code></td>
<td>ä¾èµ–æœªå®‰è£…</td>
<td><code>pip install -r requirements.txt</code></td>
</tr>
<tr>
<td><code>OperationalError: could not connect to server</code></td>
<td>æ•°æ®åº“è¿æ¥å¤±è´¥</td>
<td>æ£€æŸ¥ DATABASE_URLï¼ŒéªŒè¯Neonç«¯ç‚¹</td>
</tr>
<tr>
<td><code>ValueError: SECRET_KEY must be set</code></td>
<td>SESSION_SECRETæœªè®¾ç½®</td>
<td><code>export SESSION_SECRET=$(python -c 'import secrets; print(secrets.token_urlsafe(32))')</code></td>
</tr>
<tr>
<td><code>Address already in use</code></td>
<td>ç«¯å£è¢«å ç”¨</td>
<td><code>kill -9 $(lsof -t -i:5000)</code></td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 æ•°æ®åº“è¿æ¥å¤±è´¥</h3>
<h4 id="_31">ç—‡çŠ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="nv">sqlalchemy</span>.<span class="nv">exc</span>.<span class="nv">OperationalError</span>:<span class="w"> </span><span class="ss">(</span><span class="nv">psycopg2</span>.<span class="nv">OperationalError</span><span class="ss">)</span><span class="w"> </span>
<span class="nv">could</span><span class="w"> </span><span class="nv">not</span><span class="w"> </span><span class="k">connect</span><span class="w"> </span><span class="nv">to</span><span class="w"> </span><span class="nv">server</span>:<span class="w"> </span><span class="nv">Connection</span><span class="w"> </span><span class="nv">timed</span><span class="w"> </span><span class="nv">out</span>
</code></pre></div>

<h4 id="_32">è¯Šæ–­æ­¥éª¤</h4>
<p><strong>1. éªŒè¯è¿æ¥å­—ç¬¦ä¸²</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è§£æDATABASE_URL</span>
python3<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">import os</span>
<span class="s">from urllib.parse import urlparse</span>
<span class="s">url = os.getenv(&#39;DATABASE_URL&#39;)</span>
<span class="s">parsed = urlparse(url)</span>
<span class="s">print(f&quot;Host: {parsed.hostname}&quot;)</span>
<span class="s">print(f&quot;Port: {parsed.port}&quot;)</span>
<span class="s">print(f&quot;Database: {parsed.path[1:]}&quot;)</span>
<span class="s">print(f&quot;User: {parsed.username}&quot;)</span>
<span class="s">EOF</span>
</code></pre></div>

<p><strong>2. æµ‹è¯•ç½‘ç»œè¿é€šæ€§</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æå–hostå’Œport</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DB_HOST</span><span class="o">=</span><span class="k">$(</span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from urllib.parse import urlparse; import os; print(urlparse(os.getenv(&#39;DATABASE_URL&#39;)).hostname)&quot;</span><span class="k">)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">DB_PORT</span><span class="o">=</span><span class="k">$(</span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;from urllib.parse import urlparse; import os; print(urlparse(os.getenv(&#39;DATABASE_URL&#39;)).port or 5432)&quot;</span><span class="k">)</span>

<span class="c1"># æµ‹è¯•TCPè¿æ¥</span>
nc<span class="w"> </span>-zv<span class="w"> </span><span class="nv">$DB_HOST</span><span class="w"> </span><span class="nv">$DB_PORT</span>
</code></pre></div>

<p><strong>3. æ£€æŸ¥è¿æ¥æ± </strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¿æ¥æ± é…ç½® (config.py)</span>
<span class="n">SQLALCHEMY_ENGINE_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;pool_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>           <span class="c1"># é»˜è®¤10ä¸ªè¿æ¥</span>
    <span class="s1">&#39;pool_recycle&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>       <span class="c1"># 5åˆ†é’Ÿå›æ”¶</span>
    <span class="s1">&#39;pool_pre_ping&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># ä½¿ç”¨å‰æµ‹è¯•è¿æ¥</span>
    <span class="s1">&#39;pool_timeout&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>        <span class="c1"># 30ç§’è¶…æ—¶</span>
    <span class="s1">&#39;max_overflow&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>        <span class="c1"># æœ€å¤šæº¢å‡º20ä¸ª</span>
    <span class="s1">&#39;connect_args&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;connect_timeout&#39;</span><span class="p">:</span> <span class="mi">15</span>  <span class="c1"># 15ç§’è¿æ¥è¶…æ—¶</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>4. æ£€æŸ¥Neonç«¯ç‚¹çŠ¶æ€</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®¿é—®Neonæ§åˆ¶å°</span>
<span class="c1"># https://console.neon.tech/app/projects</span>

<span class="c1"># æ£€æŸ¥ç«¯ç‚¹çŠ¶æ€:</span>
<span class="c1"># - Active (ç»¿è‰²) - æ­£å¸¸</span>
<span class="c1"># - Idle (é»„è‰²) - éœ€è¦å”¤é†’</span>
<span class="c1"># - Suspended (ç°è‰²) - å·²æš‚åœ</span>
</code></pre></div>

<p><strong>5. å¯ç”¨è¿æ¥é‡è¯•</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åœ¨app.pyä¸­æ·»åŠ é‡è¯•é€»è¾‘</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span><span class="p">,</span> <span class="n">exc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.pool</span><span class="w"> </span><span class="kn">import</span> <span class="n">Pool</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">receive_connect</span><span class="p">(</span><span class="n">dbapi_conn</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">):</span>
    <span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Pool</span><span class="p">,</span> <span class="s2">&quot;checkout&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">receive_checkout</span><span class="p">(</span><span class="n">dbapi_conn</span><span class="p">,</span> <span class="n">connection_record</span><span class="p">,</span> <span class="n">connection_proxy</span><span class="p">):</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">pid</span><span class="p">:</span>
        <span class="n">connection_record</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="n">connection_proxy</span><span class="o">.</span><span class="n">connection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">DisconnectionError</span><span class="p">(</span>
            <span class="s2">&quot;Connection record belongs to pid </span><span class="si">%s</span><span class="s2">, &quot;</span>
            <span class="s2">&quot;attempting to check out in pid </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">connection_record</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;pid&#39;</span><span class="p">],</span> <span class="n">pid</span><span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="73">7.3 ç¼“å­˜é—®é¢˜</h3>
<h4 id="_33">ç—‡çŠ¶</h4>
<ul>
<li>å“åº”æ—¶é—´æ˜¾è‘—å¢åŠ </li>
<li>ç¼“å­˜å‘½ä¸­ç‡ä½äº50%</li>
<li>Redisè¿æ¥é”™è¯¯</li>
</ul>
<h4 id="_34">è¯Šæ–­æ­¥éª¤</h4>
<p><strong>1. æ£€æŸ¥Redisè¿æ¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æµ‹è¯•Redis</span>
redis-cli<span class="w"> </span>ping
<span class="c1"># é¢„æœŸ: PONG</span>

<span class="c1"># æ£€æŸ¥Rediså†…å­˜</span>
redis-cli<span class="w"> </span>info<span class="w"> </span>memory

<span class="c1"># æ£€æŸ¥é”®æ•°é‡</span>
redis-cli<span class="w"> </span>dbsize
</code></pre></div>

<p><strong>2. æŸ¥çœ‹ç¼“å­˜å‘½ä¸­ç‡</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é€šè¿‡APIæŸ¥è¯¢</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">stats</span>

<span class="c1"># é¢„æœŸå“åº”</span>
<span class="p">{</span>
  <span class="s2">&quot;cache_type&quot;</span><span class="p">:</span> <span class="s2">&quot;redis&quot;</span><span class="p">,</span>
  <span class="s2">&quot;hit_rate&quot;</span><span class="p">:</span> <span class="mf">75.5</span><span class="p">,</span>
  <span class="s2">&quot;total_requests&quot;</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
  <span class="s2">&quot;hits&quot;</span><span class="p">:</span> <span class="mi">7550</span><span class="p">,</span>
  <span class="s2">&quot;misses&quot;</span><span class="p">:</span> <span class="mi">2450</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>3. ç¼“å­˜å›é€€æœºåˆ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># cache_manager.py è‡ªåŠ¨å›é€€</span>
<span class="k">if</span> <span class="n">redis_available</span><span class="p">:</span>
    <span class="n">cache_backend</span> <span class="o">=</span> <span class="n">RedisCache</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Redis unavailable, falling back to memory cache&quot;</span><span class="p">)</span>
    <span class="n">cache_backend</span> <span class="o">=</span> <span class="n">MemoryCache</span><span class="p">()</span>
</code></pre></div>

<p><strong>4. æ¸…ç†ç¼“å­˜</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¸…ç†æ‰€æœ‰ç¼“å­˜</span>
redis-cli<span class="w"> </span>FLUSHDB

<span class="c1"># æ¸…ç†ç‰¹å®šå‰ç¼€</span>
redis-cli<span class="w"> </span>--scan<span class="w"> </span>--pattern<span class="w"> </span><span class="s1">&#39;hashinsight:*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>redis-cli<span class="w"> </span>DEL
</code></pre></div>

<h3 id="74">7.4 æ€§èƒ½ä¸‹é™</h3>
<h4 id="_35">ç—‡çŠ¶</h4>
<ul>
<li>APIå“åº”æ—¶é—´ p95 &gt; 250ms</li>
<li>æ•°æ®åº“æŸ¥è¯¢ç¼“æ…¢</li>
<li>CPU/å†…å­˜ä½¿ç”¨ç‡é«˜</li>
</ul>
<h4 id="_36">è¯Šæ–­æ­¥éª¤</h4>
<p><strong>1. æ£€æŸ¥Request CoalescingçŠ¶æ€</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹è¯·æ±‚åˆå¹¶ç»Ÿè®¡</span>
curl<span class="w"> </span>http://localhost:5000/api/performance/coalescing-stats

<span class="c1"># é¢„æœŸå“åº”</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;enabled&quot;</span>:<span class="w"> </span>true,
<span class="w">  </span><span class="s2">&quot;performance_improvement&quot;</span>:<span class="w"> </span><span class="s2">&quot;9.8x&quot;</span>,
<span class="w">  </span><span class="s2">&quot;deduplicated_requests&quot;</span>:<span class="w"> </span><span class="m">5432</span>,
<span class="w">  </span><span class="s2">&quot;total_requests&quot;</span>:<span class="w"> </span><span class="m">53210</span>
<span class="o">}</span>
</code></pre></div>

<p><strong>2. åˆ†ææ…¢æŸ¥è¯¢</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">-- å¯ç”¨æ…¢æŸ¥è¯¢æ—¥å¿— (PostgreSQL)</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">DATABASE</span><span class="w"> </span><span class="n">hashinsight_db</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">log_min_duration_statement</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span>

<span class="c1">-- æŸ¥è¯¢æ…¢æŸ¥è¯¢</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="n">calls</span><span class="p">,</span><span class="w"> </span><span class="n">total_time</span><span class="p">,</span><span class="w"> </span><span class="n">mean_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_statements</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">mean_time</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1000</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mean_time</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
</code></pre></div>

<p><strong>3. æ£€æŸ¥æ•°æ®åº“ç´¢å¼•</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¿è¡Œç´¢å¼•ä¼˜åŒ–</span>
python<span class="w"> </span>database/optimize_indexes.py<span class="w"> </span>--analyze

<span class="c1"># æŸ¥çœ‹ç¼ºå¤±ç´¢å¼•</span>
python<span class="w"> </span>database/optimize_indexes.py<span class="w"> </span>--suggest
</code></pre></div>

<p><strong>4. ç›‘æ§ç³»ç»Ÿèµ„æº</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CPUä½¿ç”¨ç‡</span>
top<span class="w"> </span>-b<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>gunicorn

<span class="c1"># å†…å­˜ä½¿ç”¨</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>gunicorn<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{sum+=$6} END {print sum/1024 &quot; MB&quot;}&#39;</span>

<span class="c1"># æ•°æ®åº“è¿æ¥æ•°</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;SELECT count(*) FROM pg_stat_activity WHERE datname = &#39;hashinsight_db&#39;;&quot;</span>
</code></pre></div>

<p><strong>5. å¯ç”¨æ€§èƒ½åˆ†æ</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ·»åŠ åˆ°éœ€è¦åˆ†æçš„è·¯ç”±</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.middleware.profiler</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProfilerMiddleware</span>

<span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">ProfilerMiddleware</span><span class="p">(</span>
    <span class="n">app</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span>
    <span class="n">restrictions</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
    <span class="n">profile_dir</span><span class="o">=</span><span class="s1">&#39;./profiles&#39;</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="75">7.5 åŒºå—é“¾é›†æˆé”™è¯¯</h3>
<h4 id="_37">ç—‡çŠ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="n">ERROR</span><span class="o">:</span><span class="n">blockchain_integration</span><span class="o">:</span><span class="w"> </span><span class="err">åŠ å¯†é…ç½®é”™è¯¯</span><span class="o">:</span><span class="w"> </span><span class="n">ENCRYPTION_PASSWORDç¯å¢ƒå˜é‡å¿…é¡»è®¾ç½®</span>
<span class="n">ERROR</span><span class="o">:</span><span class="n">sla_nft_routes</span><span class="o">:</span><span class="w"> </span><span class="err">è·å–</span><span class="n">SLAçŠ¶æ€å¤±è´¥</span>
</code></pre></div>

<h4 id="_38">è¯Šæ–­æ­¥éª¤</h4>
<p><strong>1. æ£€æŸ¥ENCRYPTION_PASSWORD</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># éªŒè¯ç¯å¢ƒå˜é‡</span>
<span class="nb">echo</span><span class="w"> </span><span class="nv">$ENCRYPTION_PASSWORD</span>

<span class="c1"># å¦‚æœæœªè®¾ç½®</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">ENCRYPTION_PASSWORD</span><span class="o">=</span><span class="k">$(</span>python3<span class="w"> </span>-c<span class="w"> </span><span class="s1">&#39;import secrets; print(secrets.token_urlsafe(32))&#39;</span><span class="k">)</span>
</code></pre></div>

<p><strong>2. æ£€æŸ¥åŒºå—é“¾é…ç½®</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># éªŒè¯åŒºå—é“¾ç¯å¢ƒå˜é‡</span>
python3<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">import os</span>
<span class="s">config = {</span>
<span class="s">    &#39;BLOCKCHAIN_ENABLED&#39;: os.getenv(&#39;BLOCKCHAIN_ENABLED&#39;),</span>
<span class="s">    &#39;BLOCKCHAIN_PRIVATE_KEY&#39;: &#39;***&#39; if os.getenv(&#39;BLOCKCHAIN_PRIVATE_KEY&#39;) else None,</span>
<span class="s">    &#39;BLOCKCHAIN_NETWORK&#39;: os.getenv(&#39;BLOCKCHAIN_NETWORK&#39;, &#39;base-sepolia&#39;),</span>
<span class="s">    &#39;BASE_RPC_URL&#39;: os.getenv(&#39;BASE_RPC_URL&#39;, &#39;https://sepolia.base.org&#39;)</span>
<span class="s">}</span>
<span class="s">for k, v in config.items():</span>
<span class="s">    status = &#39;âœ…&#39; if v else &#39;âŒ&#39;</span>
<span class="s">    print(f&quot;{status} {k}: {v}&quot;)</span>
<span class="s">EOF</span>
</code></pre></div>

<p><strong>3. æµ‹è¯•Web3è¿æ¥</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">python3</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;EOF&#39;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">web3</span><span class="w"> </span><span class="kn">import</span> <span class="n">Web3</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>

<span class="n">rpc_url</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;BASE_RPC_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;https://sepolia.base.org&#39;</span><span class="p">)</span>
<span class="n">w3</span> <span class="o">=</span> <span class="n">Web3</span><span class="p">(</span><span class="n">Web3</span><span class="o">.</span><span class="n">HTTPProvider</span><span class="p">(</span><span class="n">rpc_url</span><span class="p">))</span>

<span class="k">if</span> <span class="n">w3</span><span class="o">.</span><span class="n">is_connected</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âœ… Web3 connected to </span><span class="si">{</span><span class="n">rpc_url</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Block number: </span><span class="si">{</span><span class="n">w3</span><span class="o">.</span><span class="n">eth</span><span class="o">.</span><span class="n">block_number</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;âŒ Web3 connection failed&quot;</span><span class="p">)</span>
<span class="n">EOF</span>
</code></pre></div>

<p><strong>4. éªŒè¯ç§é’¥æ ¼å¼</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç§é’¥åº”ä»¥0xå¼€å¤´ï¼Œ64ä¸ªåå…­è¿›åˆ¶å­—ç¬¦</span>
python3<span class="w"> </span><span class="s">&lt;&lt; &#39;EOF&#39;</span>
<span class="s">import os</span>
<span class="s">import re</span>

<span class="s">private_key = os.getenv(&#39;BLOCKCHAIN_PRIVATE_KEY&#39;, &#39;&#39;)</span>
<span class="s">if re.match(r&#39;^0x[0-9a-fA-F]{64}$&#39;, private_key):</span>
<span class="s">    print(&quot;âœ… Private key format valid&quot;)</span>
<span class="s">else:</span>
<span class="s">    print(&quot;âŒ Invalid private key format&quot;)</span>
<span class="s">    print(&quot;Expected: 0x + 64 hex characters&quot;)</span>
<span class="s">EOF</span>
</code></pre></div>

<h3 id="76">7.6 æ—¥å¿—ä½ç½®</h3>
<table>
<thead>
<tr>
<th>æ—¥å¿—ç±»å‹</th>
<th>è·¯å¾„</th>
<th>æ ¼å¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>åº”ç”¨æ—¥å¿—</td>
<td>æ ‡å‡†è¾“å‡º (stdout)</td>
<td>æ–‡æœ¬</td>
</tr>
<tr>
<td>å®¡è®¡æ—¥å¿—</td>
<td><code>logs/audit.jsonl</code></td>
<td>JSON Lines</td>
</tr>
<tr>
<td>é”™è¯¯æ—¥å¿—</td>
<td>æ ‡å‡†é”™è¯¯ (stderr)</td>
<td>æ–‡æœ¬</td>
</tr>
<tr>
<td>Gunicornæ—¥å¿—</td>
<td><code>/var/log/gunicorn/</code></td>
<td>æ–‡æœ¬</td>
</tr>
<tr>
<td>PostgreSQLæ—¥å¿—</td>
<td>Neon Console</td>
<td>æ–‡æœ¬</td>
</tr>
<tr>
<td>Workflowæ—¥å¿—</td>
<td><code>/tmp/logs/</code></td>
<td>æ–‡æœ¬</td>
</tr>
</tbody>
</table>
<h4 id="_39">æŸ¥çœ‹æ—¥å¿—</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å®æ—¶æŸ¥çœ‹åº”ç”¨æ—¥å¿—</span>
tail<span class="w"> </span>-f<span class="w"> </span>/var/log/hashinsight/app.log

<span class="c1"># æŸ¥çœ‹é”™è¯¯æ—¥å¿—</span>
grep<span class="w"> </span>ERROR<span class="w"> </span>/var/log/hashinsight/app.log<span class="w"> </span><span class="p">|</span><span class="w"> </span>tail<span class="w"> </span>-50

<span class="c1"># æŸ¥çœ‹å®¡è®¡æ—¥å¿—</span>
tail<span class="w"> </span>-f<span class="w"> </span>logs/audit.jsonl<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.&#39;</span>

<span class="c1"># æŸ¥çœ‹Gunicornè®¿é—®æ—¥å¿—</span>
tail<span class="w"> </span>-f<span class="w"> </span>/var/log/gunicorn/access.log
</code></pre></div>

<hr />
<h2 id="8">ç¬¬8ç« ï¼šæ—¥å¸¸è¿ç»´æ“ä½œ</h2>
<h3 id="81">8.1 æ•°æ®åº“ç»´æŠ¤</h3>
<h4 id="811">8.1.1 ç´¢å¼•ä¼˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># è‡ªåŠ¨ä¼˜åŒ–ç´¢å¼•</span>
python<span class="w"> </span>database/optimize_indexes.py<span class="w"> </span>--auto

<span class="c1"># åˆ†æå¹¶å»ºè®®ç´¢å¼•</span>
python<span class="w"> </span>database/optimize_indexes.py<span class="w"> </span>--analyze<span class="w"> </span>--suggest

<span class="c1"># è¾“å‡ºç¤ºä¾‹:</span>
<span class="c1"># âœ… ç°æœ‰ç´¢å¼•: 45ä¸ª</span>
<span class="c1"># ğŸ” æ‰«ææ…¢æŸ¥è¯¢...</span>
<span class="c1"># ğŸ’¡ å»ºè®®åˆ›å»ºç´¢å¼•:</span>
<span class="c1">#   - CREATE INDEX idx_miners_user_id ON miners(user_id)</span>
<span class="c1">#   - CREATE INDEX idx_market_data_timestamp ON market_analytics(created_at DESC)</span>
</code></pre></div>

<h4 id="812">8.1.2 è¿æ¥æ± ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- æŸ¥çœ‹å½“å‰è¿æ¥</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="n">pid</span><span class="p">,</span>
<span class="w">    </span><span class="n">usename</span><span class="p">,</span>
<span class="w">    </span><span class="n">application_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">client_addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">state</span><span class="p">,</span>
<span class="w">    </span><span class="n">query_start</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_activity</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;hashinsight_db&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">query_start</span><span class="p">;</span>

<span class="c1">-- æ€æ­»ç©ºé—²è¿æ¥</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_terminate_backend</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_activity</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">datname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;hashinsight_db&#39;</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="k">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;idle&#39;</span>
<span class="w">  </span><span class="k">AND</span><span class="w"> </span><span class="n">state_change</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">NOW</span><span class="p">()</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nb">INTERVAL</span><span class="w"> </span><span class="s1">&#39;30 minutes&#39;</span><span class="p">;</span>
</code></pre></div>

<h4 id="813">8.1.3 æ…¢æŸ¥è¯¢åˆ†æ</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- å¯ç”¨pg_stat_statements</span>
<span class="k">CREATE</span><span class="w"> </span><span class="n">EXTENSION</span><span class="w"> </span><span class="k">IF</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="n">pg_stat_statements</span><span class="p">;</span>

<span class="c1">-- æŸ¥çœ‹Top 10æ…¢æŸ¥è¯¢</span>
<span class="k">SELECT</span><span class="w"> </span>
<span class="w">    </span><span class="k">substring</span><span class="p">(</span><span class="n">query</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">short_query</span><span class="p">,</span>
<span class="w">    </span><span class="n">calls</span><span class="p">,</span>
<span class="w">    </span><span class="n">total_time</span><span class="p">,</span>
<span class="w">    </span><span class="n">mean_time</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_time</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">pg_stat_statements</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%pg_stat_statements%&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mean_time</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>

<span class="c1">-- é‡ç½®ç»Ÿè®¡</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">pg_stat_statements_reset</span><span class="p">();</span>
</code></pre></div>

<h4 id="814">8.1.4 æ•°æ®åº“æ¸…ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¸…ç†æ—§æ•°æ® (ä¿ç•™90å¤©)</span>
python<span class="w"> </span>scripts/cleanup_old_data.py<span class="w"> </span>--days<span class="w"> </span><span class="m">90</span>

<span class="c1"># æ¸…ç†ç¤ºä¾‹:</span>
<span class="c1"># âœ… åˆ é™¤90å¤©å‰çš„market_analytics: 12,543æ¡</span>
<span class="c1"># âœ… åˆ é™¤90å¤©å‰çš„auditæ—¥å¿—: 45,123æ¡</span>
<span class="c1"># âœ… æ¸…ç†å®Œæˆï¼Œé‡Šæ”¾ç©ºé—´: 2.3 GB</span>
</code></pre></div>

<h3 id="82">8.2 ç¼“å­˜ç®¡ç†</h3>
<h4 id="821-redis">8.2.1 Redisç¼“å­˜æ¸…ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¸…ç†æ‰€æœ‰HashInsightç¼“å­˜</span>
redis-cli<span class="w"> </span>--scan<span class="w"> </span>--pattern<span class="w"> </span><span class="s1">&#39;hashinsight:*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>redis-cli<span class="w"> </span>DEL

<span class="c1"># æ¸…ç†ç‰¹å®šæ¨¡å—ç¼“å­˜</span>
redis-cli<span class="w"> </span>--scan<span class="w"> </span>--pattern<span class="w"> </span><span class="s1">&#39;hashinsight:miners:*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>redis-cli<span class="w"> </span>DEL

<span class="c1"># æ¸…ç†è¿‡æœŸé”® (Redisè‡ªåŠ¨ï¼Œæ‰‹åŠ¨è§¦å‘)</span>
redis-cli<span class="w"> </span>--scan<span class="w"> </span>--pattern<span class="w"> </span><span class="s1">&#39;hashinsight:*&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="nb">read</span><span class="w"> </span>key<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>redis-cli<span class="w"> </span>TTL<span class="w"> </span><span class="s2">&quot;</span><span class="nv">$key</span><span class="s2">&quot;</span>
<span class="k">done</span>
</code></pre></div>

<h4 id="822">8.2.2 å†…å­˜ç¼“å­˜ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># é€šè¿‡APIæŸ¥è¯¢å†…å­˜ç¼“å­˜çŠ¶æ€</span>
<span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">cache</span><span class="o">/</span><span class="n">memory</span><span class="o">-</span><span class="n">stats</span>

<span class="c1"># å“åº”</span>
<span class="p">{</span>
  <span class="s2">&quot;cache_type&quot;</span><span class="p">:</span> <span class="s2">&quot;memory&quot;</span><span class="p">,</span>
  <span class="s2">&quot;size_mb&quot;</span><span class="p">:</span> <span class="mf">124.5</span><span class="p">,</span>
  <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="mi">5432</span><span class="p">,</span>
  <span class="s2">&quot;hit_rate&quot;</span><span class="p">:</span> <span class="mf">82.3</span><span class="p">,</span>
  <span class="s2">&quot;evictions&quot;</span><span class="p">:</span> <span class="mi">234</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="823-request-coalescer">8.2.3 Request CoalescerçŠ¶æ€</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹è¯·æ±‚åˆå¹¶ç»Ÿè®¡</span>
curl<span class="w"> </span>http://localhost:5000/api/performance/coalescing-stats<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq

<span class="c1"># æ‰‹åŠ¨æ¸…ç†åˆå¹¶ç¼“å­˜</span>
curl<span class="w"> </span>-X<span class="w"> </span>POST<span class="w"> </span>http://localhost:5000/api/performance/clear-coalescing-cache
</code></pre></div>

<h3 id="83">8.3 æ‰¹é‡ä»»åŠ¡</h3>
<h4 id="831">8.3.1 æ‰¹é‡å¯¼å…¥çŸ¿æœº</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å‡†å¤‡CSVæ–‡ä»¶ (æœ€å¤š5000å°)</span>
<span class="c1"># æ ¼å¼: name,model,hashrate_th,power_w,efficiency</span>

<span class="c1"># æ‰§è¡Œæ‰¹é‡å¯¼å…¥</span>
python<span class="w"> </span>batch/batch_import_manager.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--file<span class="w"> </span>miners_upload_5000.csv<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--user-id<span class="w"> </span><span class="m">123</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--validate

<span class="c1"># è¾“å‡º:</span>
<span class="c1"># âœ… æ–‡ä»¶éªŒè¯é€šè¿‡</span>
<span class="c1"># ğŸ“Š è®°å½•æ•°: 5000</span>
<span class="c1"># âš™ï¸  å¤„ç†ä¸­...</span>
<span class="c1"># [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ] 100%</span>
<span class="c1"># âœ… å¯¼å…¥å®Œæˆ: 5000å°çŸ¿æœº (è€—æ—¶: 45.2s)</span>
</code></pre></div>

<h4 id="832">8.3.2 æ•°æ®æ”¶é›†ä»»åŠ¡</h4>
<p>HashInsight æ¯15åˆ†é’Ÿè‡ªåŠ¨æ”¶é›†å¸‚åœºæ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ‰‹åŠ¨è§¦å‘æ•°æ®æ”¶é›†</span>
python<span class="w"> </span>modules/analytics/engines/analytics_engine.py<span class="w"> </span>--collect-now

<span class="c1"># æŸ¥çœ‹æ”¶é›†çŠ¶æ€</span>
curl<span class="w"> </span>http://localhost:5000/api/analytics/collection-status

<span class="c1"># å“åº”</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;last_collection&quot;</span>:<span class="w"> </span><span class="s2">&quot;2025-10-03T12:15:00Z&quot;</span>,
<span class="w">  </span><span class="s2">&quot;next_collection&quot;</span>:<span class="w"> </span><span class="s2">&quot;2025-10-03T12:30:00Z&quot;</span>,
<span class="w">  </span><span class="s2">&quot;status&quot;</span>:<span class="w"> </span><span class="s2">&quot;healthy&quot;</span>,
<span class="w">  </span><span class="s2">&quot;data_points_today&quot;</span>:<span class="w"> </span><span class="m">8</span>
<span class="o">}</span>
</code></pre></div>

<h4 id="833">8.3.3 æ•°æ®æ”¶é›†è°ƒåº¦</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># é…ç½®æ•°æ®æ”¶é›†é¢‘ç‡ (config.py)</span>
<span class="n">ANALYTICS_COLLECTION_INTERVAL</span> <span class="o">=</span> <span class="mi">15</span>  <span class="c1"># åˆ†é’Ÿ</span>
<span class="n">ANALYTICS_MAX_DATA_POINTS_PER_DAY</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># æ¯æ—¥é™åˆ¶</span>

<span class="c1"># å¯ç”¨/ç¦ç”¨åå°æœåŠ¡ï¼ˆé»˜è®¤ï¼šç¦ç”¨ï¼Œå³ 0ï¼‰</span>
<span class="n">export</span> <span class="n">ENABLE_BACKGROUND_SERVICES</span><span class="o">=</span><span class="mi">1</span>  <span class="c1"># å¯ç”¨åå°æ•°æ®é‡‡é›†</span>
<span class="n">export</span> <span class="n">ENABLE_BACKGROUND_SERVICES</span><span class="o">=</span><span class="mi">0</span>  <span class="c1"># ç¦ç”¨åå°æ•°æ®é‡‡é›†ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰</span>
</code></pre></div>

<h3 id="84">8.4 ç”¨æˆ·ç®¡ç†</h3>
<h4 id="841">8.4.1 åˆ›å»ºç”¨æˆ·</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># é€šè¿‡ç®¡ç†ç•Œé¢åˆ›å»º</span>
<span class="c1"># è®¿é—®: http://localhost:5000/admin/users/create</span>

<span class="c1"># é€šè¿‡å‘½ä»¤è¡Œåˆ›å»º</span>
python<span class="w"> </span>scripts/create_user.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--email<span class="w"> </span>admin@hashinsight.net<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--username<span class="w"> </span>admin<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--role<span class="w"> </span>owner<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--password-prompt

<span class="c1"># è¾“å‡º:</span>
<span class="c1"># è¯·è¾“å…¥å¯†ç : ********</span>
<span class="c1"># âœ… ç”¨æˆ·å·²åˆ›å»º</span>
<span class="c1"># ID: 123</span>
<span class="c1"># Email: admin@hashinsight.net</span>
<span class="c1"># Role: owner</span>
</code></pre></div>

<h4 id="842">8.4.2 è§’è‰²åˆ†é…</h4>
<table>
<thead>
<tr>
<th>è§’è‰²</th>
<th>æƒé™</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>owner</code></td>
<td>å…¨éƒ¨æƒé™</td>
<td>ç³»ç»Ÿæ‰€æœ‰è€…</td>
</tr>
<tr>
<td><code>admin</code></td>
<td>ç®¡ç†æƒé™</td>
<td>ç³»ç»Ÿç®¡ç†å‘˜</td>
</tr>
<tr>
<td><code>broker</code></td>
<td>ç»çºªäººæƒé™</td>
<td>å®¢æˆ·ç®¡ç†ã€è®¢å•</td>
</tr>
<tr>
<td><code>client</code></td>
<td>å®¢æˆ·æƒé™</td>
<td>æŸ¥çœ‹è‡ªå·±çš„æ•°æ®</td>
</tr>
</tbody>
</table>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¿®æ”¹ç”¨æˆ·è§’è‰²</span>
python<span class="w"> </span>scripts/change_user_role.py<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--user-id<span class="w"> </span><span class="m">123</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--new-role<span class="w"> </span>admin

<span class="c1"># æ‰¹é‡å¯¼å…¥ç”¨æˆ·</span>
python<span class="w"> </span>scripts/bulk_import_users.py<span class="w"> </span>--file<span class="w"> </span>users.csv
</code></pre></div>

<h4 id="843">8.4.3 æƒé™ç®¡ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ£€æŸ¥ç”¨æˆ·æƒé™</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">decorators</span><span class="w"> </span><span class="kn">import</span> <span class="n">has_permission</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/api/miners/delete/&lt;int:miner_id&gt;&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;DELETE&#39;</span><span class="p">])</span>
<span class="nd">@login_required</span>
<span class="nd">@requires_permission</span><span class="p">(</span><span class="s1">&#39;miners:delete&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_miner</span><span class="p">(</span><span class="n">miner_id</span><span class="p">):</span>
    <span class="c1"># ä»…å…è®¸æœ‰miners:deleteæƒé™çš„ç”¨æˆ·</span>
    <span class="k">pass</span>
</code></pre></div>

<h3 id="85">8.5 æ•°æ®æ¸…ç†</h3>
<h4 id="851">8.5.1 æ¯æ—¥æ•°æ®ç‚¹é™åˆ¶</h4>
<p>ä¸ºæ§åˆ¶å­˜å‚¨æˆæœ¬ï¼ŒHashInsighté™åˆ¶æ¯æ—¥æ•°æ®ç‚¹æ•°é‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># config.py</span>
<span class="n">ANALYTICS_MAX_DATA_POINTS_PER_DAY</span> <span class="o">=</span> <span class="mi">10</span>  <span class="c1"># æ¯æ—¥æœ€å¤š10ä¸ªæ•°æ®ç‚¹</span>
</code></pre></div>

<h4 id="852">8.5.2 å†å²æ•°æ®å½’æ¡£</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å½’æ¡£90å¤©å‰çš„æ•°æ®åˆ°å†·å­˜å‚¨</span>
python<span class="w"> </span>scripts/archive_historical_data.py<span class="w"> </span>--days<span class="w"> </span><span class="m">90</span><span class="w"> </span>--storage<span class="w"> </span>s3

<span class="c1"># è¾“å‡º:</span>
<span class="c1"># ğŸ“¦ æ‰«æéœ€å½’æ¡£æ•°æ®...</span>
<span class="c1"># ğŸ“Š market_analytics: 123,456æ¡</span>
<span class="c1"># ğŸ“Š calculation_history: 45,678æ¡</span>
<span class="c1"># â¬†ï¸  ä¸Šä¼ åˆ° s3://hashinsight-archive/...</span>
<span class="c1"># ğŸ—‘ï¸  ä»ä¸»æ•°æ®åº“åˆ é™¤</span>
<span class="c1"># âœ… å½’æ¡£å®Œæˆ: é‡Šæ”¾ 5.2 GB</span>
</code></pre></div>

<h4 id="853">8.5.3 å®¡è®¡æ—¥å¿—å½’æ¡£</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å½’æ¡£6ä¸ªæœˆå‰çš„å®¡è®¡æ—¥å¿—</span>
python<span class="w"> </span>scripts/archive_audit_logs.py<span class="w"> </span>--months<span class="w"> </span><span class="m">6</span>

<span class="c1"># æ—¥å¿—è½®è½¬ (è‡ªåŠ¨)</span>
<span class="c1"># audit/audit_logger.py è‡ªåŠ¨è½®è½¬100MBæ—¥å¿—æ–‡ä»¶</span>
</code></pre></div>

<hr />
<h2 id="9">ç¬¬9ç« ï¼šæ€§èƒ½ä¼˜åŒ–æŒ‡å—</h2>
<h3 id="91-request-coalescing">9.1 Request Coalescing</h3>
<p>HashInsight ä½¿ç”¨ Request Coalescing å®ç°<strong>9.8å€æ€§èƒ½æå‡</strong>ï¼š</p>
<h4 id="_40">åŸç†</h4>
<div class="codehilite"><pre><span></span><code><span class="err">ä¼ ç»Ÿæ¨¡å¼</span><span class="o">:</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="mi">1</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="mi">2</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="mi">3</span>
<span class="o">(</span><span class="mi">3</span><span class="err">ä¸ª</span><span class="n">APIè°ƒç”¨</span><span class="o">)</span>

<span class="n">Request</span><span class="w"> </span><span class="n">Coalescing</span><span class="o">:</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="err">â”</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">Single</span><span class="w"> </span><span class="n">API</span><span class="w"> </span><span class="n">Call</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="err">â†’</span><span class="w"> </span><span class="n">Shared</span><span class="w"> </span><span class="n">Result</span>
<span class="n">Request</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="err">â”˜</span>
<span class="o">(</span><span class="mi">1</span><span class="err">ä¸ª</span><span class="n">APIè°ƒç”¨</span><span class="err">ï¼ŒèŠ‚çœ</span><span class="mi">67</span><span class="o">%</span><span class="err">è¯·æ±‚</span><span class="o">)</span>
</code></pre></div>

<h4 id="_41">é…ç½®</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># cache_manager.py</span>
<span class="n">REQUEST_COALESCING_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">COALESCING_TIMEOUT</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># 100mså†…çš„é‡å¤è¯·æ±‚åˆå¹¶</span>
<span class="n">COALESCING_MAX_WAIT</span> <span class="o">=</span> <span class="mi">500</span>  <span class="c1"># æœ€å¤šç­‰å¾…500ms</span>
</code></pre></div>

<h4 id="_42">ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹Request Coalescingç»Ÿè®¡</span>
curl<span class="w"> </span>http://localhost:5000/api/performance/coalescing-stats<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq

<span class="c1"># å“åº”</span>
<span class="o">{</span>
<span class="w">  </span><span class="s2">&quot;enabled&quot;</span>:<span class="w"> </span>true,
<span class="w">  </span><span class="s2">&quot;total_requests&quot;</span>:<span class="w"> </span><span class="m">98234</span>,
<span class="w">  </span><span class="s2">&quot;deduplicated_requests&quot;</span>:<span class="w"> </span><span class="m">85432</span>,
<span class="w">  </span><span class="s2">&quot;api_calls_saved&quot;</span>:<span class="w"> </span><span class="m">85432</span>,
<span class="w">  </span><span class="s2">&quot;performance_improvement&quot;</span>:<span class="w"> </span><span class="s2">&quot;9.8x&quot;</span>,
<span class="w">  </span><span class="s2">&quot;average_wait_time_ms&quot;</span>:<span class="w"> </span><span class="m">45</span>
<span class="o">}</span>
</code></pre></div>

<h3 id="92">9.2 æ•°æ®åº“ä¼˜åŒ–</h3>
<h4 id="921">9.2.1 ç´¢å¼•ç­–ç•¥</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">-- é«˜é¢‘æŸ¥è¯¢å­—æ®µç´¢å¼•</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_miners_user_id</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">miners</span><span class="p">(</span><span class="n">user_id</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_market_data_timestamp</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">market_analytics</span><span class="p">(</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span><span class="p">);</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_calculations_user_created</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">calculations</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">created_at</span><span class="p">);</span>

<span class="c1">-- å¤åˆç´¢å¼• (å¸¸åŒæ—¶æŸ¥è¯¢çš„å­—æ®µ)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_miners_user_model</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">miners</span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">model</span><span class="p">);</span>

<span class="c1">-- éƒ¨åˆ†ç´¢å¼• (ä»…ç´¢å¼•æ´»è·ƒæ•°æ®)</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">idx_active_miners</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">miners</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;active&#39;</span><span class="p">;</span>
</code></pre></div>

<h4 id="922">9.2.2 æŸ¥è¯¢ä¼˜åŒ–</h4>
<p><strong>ä½¿ç”¨EXPLAINåˆ†ææŸ¥è¯¢</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">EXPLAIN</span><span class="w"> </span><span class="k">ANALYZE</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="o">*</span><span class="p">,</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">username</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">miners</span><span class="w"> </span><span class="n">m</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="n">u</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">u</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;active&#39;</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">created_at</span><span class="w"> </span><span class="k">DESC</span>
<span class="k">LIMIT</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="c1">-- æŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œä¼˜åŒ–æ…¢æŸ¥è¯¢</span>
</code></pre></div>

<p><strong>é¿å…N+1æŸ¥è¯¢</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># âŒ ä¸å¥½ - N+1æŸ¥è¯¢</span>
<span class="n">miners</span> <span class="o">=</span> <span class="n">Miner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">miner</span> <span class="ow">in</span> <span class="n">miners</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>  <span class="c1"># æ¯æ¬¡å¾ªç¯ä¸€æ¬¡æŸ¥è¯¢</span>

<span class="c1"># âœ… å¥½ - ä½¿ç”¨JOIN</span>
<span class="n">miners</span> <span class="o">=</span> <span class="n">Miner</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Miner</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<span class="k">for</span> <span class="n">miner</span> <span class="ow">in</span> <span class="n">miners</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">miner</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="p">)</span>  <span class="c1"># ä¸€æ¬¡æŸ¥è¯¢</span>
</code></pre></div>

<h4 id="923">9.2.3 è¿æ¥æ± è°ƒä¼˜</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># config.py</span>
<span class="n">SQLALCHEMY_ENGINE_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;pool_size&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>           <span class="c1"># æ ¹æ®å¹¶å‘é‡è°ƒæ•´ (workeræ•° Ã— 2)</span>
    <span class="s1">&#39;pool_recycle&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>       <span class="c1"># 5åˆ†é’Ÿå›æ”¶è¿æ¥</span>
    <span class="s1">&#39;pool_pre_ping&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>     <span class="c1"># ä½¿ç”¨å‰æµ‹è¯•è¿æ¥ (Neonå¿…éœ€)</span>
    <span class="s1">&#39;pool_timeout&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>        <span class="c1"># 30ç§’è¶…æ—¶</span>
    <span class="s1">&#39;max_overflow&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>        <span class="c1"># æœ€å¤šæº¢å‡º20ä¸ª</span>
    <span class="s1">&#39;connect_args&#39;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s1">&#39;connect_timeout&#39;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>         <span class="c1"># è¿æ¥è¶…æ—¶</span>
        <span class="s1">&#39;application_name&#39;</span><span class="p">:</span> <span class="s1">&#39;hashinsight&#39;</span><span class="p">,</span>  <span class="c1"># ä¾¿äºç›‘æ§</span>
        <span class="s1">&#39;options&#39;</span><span class="p">:</span> <span class="s1">&#39;-c statement_timeout=30000&#39;</span>  <span class="c1"># æŸ¥è¯¢è¶…æ—¶30ç§’</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="93">9.3 ç¼“å­˜ç­–ç•¥</h3>
<h4 id="931">9.3.1 å¤šçº§ç¼“å­˜</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¸‰çº§ç¼“å­˜æ¶æ„</span>
<span class="n">L1</span><span class="p">:</span> <span class="n">å†…å­˜ç¼“å­˜</span> <span class="p">(</span><span class="n">æœ€å¿«</span><span class="err">ï¼Œ</span><span class="n">å®¹é‡å°</span><span class="p">)</span>
    <span class="err">â†“</span> <span class="n">miss</span>
<span class="n">L2</span><span class="p">:</span> <span class="n">Redisç¼“å­˜</span> <span class="p">(</span><span class="n">å¿«</span><span class="err">ï¼Œ</span><span class="n">å®¹é‡ä¸­</span><span class="p">)</span>
    <span class="err">â†“</span> <span class="n">miss</span>
<span class="n">L3</span><span class="p">:</span> <span class="n">æ•°æ®åº“</span> <span class="p">(</span><span class="n">æ…¢</span><span class="err">ï¼Œ</span><span class="n">å®¹é‡å¤§</span><span class="p">)</span>

<span class="c1"># å®ç°</span>
<span class="nd">@cache_manager</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;L1&#39;</span><span class="p">)</span>  <span class="c1"># 5åˆ†é’Ÿ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_user_profile</span><span class="p">(</span><span class="n">user_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

<span class="nd">@cache_manager</span><span class="o">.</span><span class="n">cached</span><span class="p">(</span><span class="n">ttl</span><span class="o">=</span><span class="mi">3600</span><span class="p">,</span> <span class="n">level</span><span class="o">=</span><span class="s1">&#39;L2&#39;</span><span class="p">)</span>  <span class="c1"># 1å°æ—¶</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_market_data</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">fetch_from_api</span><span class="p">()</span>
</code></pre></div>

<h4 id="932-ttl">9.3.2 TTLé…ç½®</h4>
<table>
<thead>
<tr>
<th>æ•°æ®ç±»å‹</th>
<th>TTL</th>
<th>ç†ç”±</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç”¨æˆ·ä¿¡æ¯</td>
<td>5åˆ†é’Ÿ</td>
<td>å¯èƒ½å˜æ›´</td>
</tr>
<tr>
<td>å¸‚åœºæ•°æ®</td>
<td>5åˆ†é’Ÿ</td>
<td>å®æ—¶æ€§è¦æ±‚</td>
</tr>
<tr>
<td>çŸ¿æœºåˆ—è¡¨</td>
<td>1å°æ—¶</td>
<td>å˜æ›´é¢‘ç‡ä½</td>
</tr>
<tr>
<td>ç»Ÿè®¡æ•°æ®</td>
<td>10åˆ†é’Ÿ</td>
<td>è®¡ç®—å¯†é›†</td>
</tr>
<tr>
<td>é™æ€å†…å®¹</td>
<td>24å°æ—¶</td>
<td>å‡ ä¹ä¸å˜</td>
</tr>
</tbody>
</table>
<h4 id="933">9.3.3 ç¼“å­˜é¢„çƒ­</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯åŠ¨æ—¶é¢„çƒ­å…³é”®ç¼“å­˜</span>
python<span class="w"> </span>scripts/warmup_cache.py

<span class="c1"># è„šæœ¬å†…å®¹</span>
<span class="c1"># 1. åŠ è½½çƒ­é—¨ç”¨æˆ·æ•°æ®</span>
<span class="c1"># 2. åŠ è½½å½“å‰å¸‚åœºæ•°æ®</span>
<span class="c1"># 3. é¢„è®¡ç®—ç»Ÿè®¡æ•°æ®</span>
<span class="c1"># 4. åŠ è½½é…ç½®æ•°æ®</span>

<span class="c1"># è¾“å‡º:</span>
<span class="c1"># âœ… é¢„çƒ­ç”¨æˆ·ç¼“å­˜: 1,234ä¸ª</span>
<span class="c1"># âœ… é¢„çƒ­å¸‚åœºæ•°æ®: å½“å‰ä»·æ ¼+ç®—åŠ›</span>
<span class="c1"># âœ… é¢„çƒ­ç»Ÿè®¡æ•°æ®: 10ä¸ªä»ªè¡¨æ¿</span>
<span class="c1"># â±ï¸  è€—æ—¶: 12.3s</span>
</code></pre></div>

<h3 id="94">9.4 æ‰¹é‡å¤„ç†ä¼˜åŒ–</h3>
<h4 id="941">9.4.1 å‘é‡åŒ–è®¡ç®—</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># âŒ ä¸å¥½ - é€æ¡è®¡ç®—</span>
<span class="k">for</span> <span class="n">miner</span> <span class="ow">in</span> <span class="n">miners</span><span class="p">:</span>
    <span class="n">daily_revenue</span> <span class="o">=</span> <span class="n">calculate_revenue</span><span class="p">(</span>
        <span class="n">miner</span><span class="o">.</span><span class="n">hashrate</span><span class="p">,</span> 
        <span class="n">btc_price</span><span class="p">,</span> 
        <span class="n">network_difficulty</span>
    <span class="p">)</span>
<span class="c1"># è€—æ—¶: 5000å° Ã— 10ms = 50ç§’</span>

<span class="c1"># âœ… å¥½ - å‘é‡åŒ–è®¡ç®—</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">hashrates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">m</span><span class="o">.</span><span class="n">hashrate</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">miners</span><span class="p">])</span>
<span class="n">revenues</span> <span class="o">=</span> <span class="n">calculate_revenue_vectorized</span><span class="p">(</span>
    <span class="n">hashrates</span><span class="p">,</span> 
    <span class="n">btc_price</span><span class="p">,</span> 
    <span class="n">network_difficulty</span>
<span class="p">)</span>
<span class="c1"># è€—æ—¶: ~500ms (100å€æå‡)</span>
</code></pre></div>

<h4 id="942">9.4.2 å¹¶å‘å¤„ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>

<span class="c1"># å¹¶å‘å¤„ç†æ‰¹é‡ä»»åŠ¡</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_miner_batch</span><span class="p">(</span><span class="n">miners</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">miners</span><span class="p">),</span> <span class="n">batch_size</span><span class="p">):</span>
            <span class="n">batch</span> <span class="o">=</span> <span class="n">miners</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">batch_size</span><span class="p">]</span>
            <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">process_batch</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">result</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">results</span>
</code></pre></div>

<h4 id="943">9.4.3 å†…å­˜ä¼˜åŒ–</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ‰¹é‡æ’å…¥ (é¿å…ORMå¼€é”€)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span>

<span class="c1"># âŒ ä¸å¥½ - é€æ¡æ’å…¥</span>
<span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">large_dataset</span><span class="p">:</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Model</span><span class="p">(</span><span class="o">**</span><span class="n">data</span><span class="p">))</span>
    <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># æ¯æ¬¡æäº¤</span>

<span class="c1"># âœ… å¥½ - æ‰¹é‡æ’å…¥</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">bulk_insert_mappings</span><span class="p">(</span><span class="n">Model</span><span class="p">,</span> <span class="n">large_dataset</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># ä¸€æ¬¡æäº¤</span>

<span class="c1"># âœ… æ›´å¥½ - ä½¿ç”¨bulk insert</span>
<span class="n">stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">Model</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">large_dataset</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
</code></pre></div>

<h3 id="95">9.5 æ€§èƒ½ç›‘æ§</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># å®šæœŸè¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•</span>
python<span class="w"> </span>scripts/performance_benchmark.py

<span class="c1"># è¾“å‡º:</span>
<span class="c1"># ğŸ“Š APIå“åº”æ—¶é—´:</span>
<span class="c1">#   - /api/miners: p50=45ms, p95=120ms, p99=250ms âœ…</span>
<span class="c1">#   - /api/dashboard: p50=80ms, p95=200ms, p99=400ms âœ…</span>
<span class="c1"># ğŸ“Š æ•°æ®åº“æŸ¥è¯¢:</span>
<span class="c1">#   - å¹³å‡æŸ¥è¯¢æ—¶é—´: 15ms âœ…</span>
<span class="c1">#   - æ…¢æŸ¥è¯¢ (&gt;1s): 0ä¸ª âœ…</span>
<span class="c1"># ğŸ“Š ç¼“å­˜æ€§èƒ½:</span>
<span class="c1">#   - å‘½ä¸­ç‡: 78.5% âœ…</span>
<span class="c1">#   - Request Coalescing: 9.8xæå‡ âœ…</span>
</code></pre></div>

<hr />
<h2 id="10">ç¬¬10ç« ï¼šåº”æ€¥å“åº”æ‰‹å†Œ</h2>
<h3 id="101-on-call">10.1 On-Callå€¼ç­åˆ¶åº¦</h3>
<h4 id="_43">å€¼ç­æ’ç­</h4>
<table>
<thead>
<tr>
<th>æ—¶æ®µ</th>
<th>ä¸»å€¼ç­</th>
<th>å¤‡ä»½å€¼ç­</th>
<th>å‡çº§è”ç³»äºº</th>
</tr>
</thead>
<tbody>
<tr>
<td>å·¥ä½œæ—¥ 09:00-18:00</td>
<td>DevOpså·¥ç¨‹å¸ˆ</td>
<td>åç«¯å·¥ç¨‹å¸ˆ</td>
<td>æŠ€æœ¯æ€»ç›‘</td>
</tr>
<tr>
<td>å·¥ä½œæ—¥ 18:00-09:00</td>
<td>è½®å€¼å·¥ç¨‹å¸ˆ</td>
<td>å¤‡ä»½å·¥ç¨‹å¸ˆ</td>
<td>On-Call Manager</td>
</tr>
<tr>
<td>å‘¨æœ«/èŠ‚å‡æ—¥</td>
<td>è½®å€¼å·¥ç¨‹å¸ˆ</td>
<td>å¤‡ä»½å·¥ç¨‹å¸ˆ</td>
<td>On-Call Manager</td>
</tr>
</tbody>
</table>
<h4 id="_44">å€¼ç­å·¥å…·</h4>
<ul>
<li>ğŸ“± <strong>PagerDuty</strong>: å‘Šè­¦é€šçŸ¥</li>
<li>ğŸ’¬ <strong>Slack</strong>: #incident-responseé¢‘é“</li>
<li>ğŸ“Š <strong>Grafana</strong>: å®æ—¶ç›‘æ§</li>
<li>ğŸ“ <strong>Incident.io</strong>: äº‹æ•…ç®¡ç†</li>
</ul>
<h3 id="102">10.2 äº‹æ•…åˆ†çº§</h3>
<table>
<thead>
<tr>
<th>çº§åˆ«</th>
<th>å½±å“</th>
<th>å“åº”æ—¶é—´</th>
<th>å‡çº§æ—¶é—´</th>
<th>ç¤ºä¾‹</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>P0</strong></td>
<td>å®Œå…¨æœåŠ¡ä¸­æ–­</td>
<td>15åˆ†é’Ÿ</td>
<td>30åˆ†é’Ÿ</td>
<td>æ•°æ®åº“å®•æœºã€åº”ç”¨æ— æ³•è®¿é—®</td>
</tr>
<tr>
<td><strong>P1</strong></td>
<td>æ ¸å¿ƒåŠŸèƒ½é™çº§</td>
<td>30åˆ†é’Ÿ</td>
<td>1å°æ—¶</td>
<td>APIå»¶è¿Ÿ&gt;5sã€é”™è¯¯ç‡&gt;5%</td>
</tr>
<tr>
<td><strong>P2</strong></td>
<td>éƒ¨åˆ†åŠŸèƒ½æ•…éšœ</td>
<td>2å°æ—¶</td>
<td>4å°æ—¶</td>
<td>å•ä¸ªåŠŸèƒ½æ— æ³•ä½¿ç”¨</td>
</tr>
<tr>
<td><strong>P3</strong></td>
<td>æ€§èƒ½ä¸‹é™</td>
<td>4å°æ—¶</td>
<td>8å°æ—¶</td>
<td>å“åº”å˜æ…¢ä½†å¯ç”¨</td>
</tr>
<tr>
<td><strong>P4</strong></td>
<td>éç´§æ€¥é—®é¢˜</td>
<td>1å·¥ä½œæ—¥</td>
<td>2å·¥ä½œæ—¥</td>
<td>UIæ˜¾ç¤ºé—®é¢˜ã€å°bug</td>
</tr>
</tbody>
</table>
<h3 id="103">10.3 å“åº”æµç¨‹</h3>
<h4 id="p0p1">P0/P1 ç´§æ€¥äº‹æ•…æµç¨‹</h4>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="err">[</span><span class="mf">0</span><span class="o">-</span><span class="mf">5</span><span class="n">åˆ†é’Ÿ</span><span class="err">]</span><span class="w"> </span><span class="n">å‘Šè­¦è§¦å‘</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">PagerDutyé€šçŸ¥ä¸»å€¼ç­</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">è‡ªåŠ¨åˆ›å»ºSlackäº‹æ•…é¢‘é“</span>
<span class="w">   </span><span class="err">â””â†’</span><span class="w"> </span><span class="n">è‡ªåŠ¨é€šçŸ¥å¤‡ä»½å€¼ç­</span>

<span class="mf">2.</span><span class="w"> </span><span class="err">[</span><span class="mf">5</span><span class="o">-</span><span class="mf">15</span><span class="n">åˆ†é’Ÿ</span><span class="err">]</span><span class="w"> </span><span class="n">åˆæ­¥å“åº”</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">ç¡®è®¤äº‹æ•…</span><span class="w"> </span><span class="p">(</span><span class="n">ACKå‘Šè­¦</span><span class="p">)</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å‘å¸ƒåˆæ­¥é€šå‘Š</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å¼€å§‹æ•…éšœæ’æŸ¥</span>
<span class="w">   </span><span class="err">â””â†’</span><span class="w"> </span><span class="n">è®°å½•æ—¶é—´çº¿</span>

<span class="mf">3.</span><span class="w"> </span><span class="err">[</span><span class="mf">15</span><span class="o">-</span><span class="mf">30</span><span class="n">åˆ†é’Ÿ</span><span class="err">]</span><span class="w"> </span><span class="n">åº”æ€¥å¤„ç½®</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å®æ–½ä¸´æ—¶ç¼“è§£æªæ–½</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">è¯„ä¼°å½±å“èŒƒå›´</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å†³å®šæ˜¯å¦å‡çº§</span>
<span class="w">   </span><span class="err">â””â†’</span><span class="w"> </span><span class="n">æ›´æ–°äº‹æ•…çŠ¶æ€</span>

<span class="mf">4.</span><span class="w"> </span><span class="err">[</span><span class="mf">30</span><span class="n">åˆ†é’Ÿ</span><span class="o">+</span><span class="err">]</span><span class="w"> </span><span class="n">å®Œå…¨è§£å†³</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å®æ–½æ°¸ä¹…ä¿®å¤</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">éªŒè¯æœåŠ¡æ¢å¤</span>
<span class="w">   </span><span class="err">â”œâ†’</span><span class="w"> </span><span class="n">å‘å¸ƒæ¢å¤é€šå‘Š</span>
<span class="w">   </span><span class="err">â””â†’</span><span class="w"> </span><span class="n">å¼€å§‹äº‹ååˆ†æ</span>
</code></pre></div>

<h3 id="104">10.4 å¸¸è§ç´§æ€¥åœºæ™¯</h3>
<h4 id="1_1">åœºæ™¯1: æ•°æ®åº“è¿æ¥æ± è€—å°½</h4>
<p><strong>ç—‡çŠ¶</strong></p>
<div class="codehilite"><pre><span></span><code>sqlalchemy.exc.TimeoutError: QueuePool limit of size 10 overflow 20 reached
</code></pre></div>

<p><strong>åº”æ€¥å“åº”</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. ç«‹å³æ€æ­»é•¿æ—¶é—´ç©ºé—²è¿æ¥</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;</span>
<span class="s2">SELECT pg_terminate_backend(pid)</span>
<span class="s2">FROM pg_stat_activity</span>
<span class="s2">WHERE state = &#39;idle&#39; </span>
<span class="s2">  AND state_change &lt; NOW() - INTERVAL &#39;10 minutes&#39;;</span>
<span class="s2">&quot;</span>

<span class="c1"># 2. å¢åŠ è¿æ¥æ± é™åˆ¶ (ä¸´æ—¶)</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SQLALCHEMY_POOL_SIZE</span><span class="o">=</span><span class="m">20</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">SQLALCHEMY_MAX_OVERFLOW</span><span class="o">=</span><span class="m">40</span>

<span class="c1"># 3. é‡å¯åº”ç”¨</span>
systemctl<span class="w"> </span>restart<span class="w"> </span>hashinsight

<span class="c1"># 4. ç›‘æ§è¿æ¥æ•°</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s2">&quot;psql </span><span class="nv">$DATABASE_URL</span><span class="s2"> -c &#39;SELECT count(*) FROM pg_stat_activity;&#39;&quot;</span>
</code></pre></div>

<h4 id="2-oom">åœºæ™¯2: å†…å­˜æ³„æ¼å¯¼è‡´OOM</h4>
<p><strong>ç—‡çŠ¶</strong></p>
<div class="codehilite"><pre><span></span><code><span class="n">MemoryError</span><span class="o">:</span><span class="w"> </span><span class="n">Unable</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">allocate</span><span class="w"> </span><span class="n">array</span>
<span class="n">Killed</span><span class="w"> </span><span class="o">(</span><span class="n">OOM</span><span class="o">)</span>
</code></pre></div>

<p><strong>åº”æ€¥å“åº”</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. ç«‹å³é‡å¯å—å½±å“çš„worker</span>
<span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/var/run/gunicorn.pid<span class="k">)</span>

<span class="c1"># 2. æ¸…ç†ç¼“å­˜é‡Šæ”¾å†…å­˜</span>
redis-cli<span class="w"> </span>FLUSHDB

<span class="c1"># 3. é™åˆ¶workeræ•°é‡ (ä¸´æ—¶)</span>
gunicorn<span class="w"> </span>--workers<span class="w"> </span><span class="m">2</span><span class="w"> </span>--max-requests<span class="w"> </span><span class="m">500</span><span class="w"> </span>main:app

<span class="c1"># 4. ç›‘æ§å†…å­˜ä½¿ç”¨</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="s1">&#39;free -h&#39;</span>
</code></pre></div>

<h4 id="3_1">åœºæ™¯3: æ¶æ„æµé‡æ”»å‡»</h4>
<p><strong>ç—‡çŠ¶</strong>
- å¼‚å¸¸é«˜çš„è¯·æ±‚é‡
- å¤§é‡401/403é”™è¯¯
- ç‰¹å®šIPæ®µçš„å¯ç–‘è¯·æ±‚</p>
<p><strong>åº”æ€¥å“åº”</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. å¯ç”¨é€Ÿç‡é™åˆ¶</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RATE_LIMIT_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RATE_LIMIT_REQUESTS_PER_MINUTE</span><span class="o">=</span><span class="m">10</span>

<span class="c1"># 2. å°ç¦æ¶æ„IP (é€šè¿‡é˜²ç«å¢™)</span>
ufw<span class="w"> </span>deny<span class="w"> </span>from<span class="w"> </span><span class="m">192</span>.168.1.0/24

<span class="c1"># 3. å¯ç”¨Cloudflareé˜²æŠ¤ (å¦‚ä½¿ç”¨)</span>
<span class="c1"># è®¿é—®Cloudflare Dashboard -&gt; Security -&gt; DDoS</span>

<span class="c1"># 4. åˆ†ææ”»å‡»æ¨¡å¼</span>
tail<span class="w"> </span>-1000<span class="w"> </span>/var/log/gunicorn/access.log<span class="w"> </span><span class="p">|</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>awk<span class="w"> </span><span class="s1">&#39;{print $1}&#39;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span><span class="p">|</span><span class="w"> </span>uniq<span class="w"> </span>-c<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-rn<span class="w"> </span><span class="p">|</span><span class="w"> </span>head<span class="w"> </span>-20
</code></pre></div>

<h3 id="105">10.5 å›æ»šæµç¨‹</h3>
<h4 id="_45">ä»£ç å›æ»š</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># 1. ç¡®å®šå›æ»šç‰ˆæœ¬</span>
git<span class="w"> </span>log<span class="w"> </span>--oneline<span class="w"> </span>-10

<span class="c1"># 2. å›æ»šåˆ°ä¸Šä¸€ä¸ªç¨³å®šç‰ˆæœ¬</span>
git<span class="w"> </span>revert<span class="w"> </span>HEAD<span class="w"> </span>--no-edit
<span class="c1"># æˆ–</span>
git<span class="w"> </span>checkout<span class="w"> </span>v1.9.5

<span class="c1"># 3. é‡æ–°éƒ¨ç½²</span>
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main

<span class="c1"># 4. éªŒè¯å›æ»šæˆåŠŸ</span>
curl<span class="w"> </span>http://localhost:5000/health<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq<span class="w"> </span><span class="s1">&#39;.version&#39;</span>

<span class="c1"># 5. é€šçŸ¥å›¢é˜Ÿ</span>
<span class="c1"># Slack: &quot;å·²å›æ»šåˆ°v1.9.5ï¼ŒæœåŠ¡æ¢å¤æ­£å¸¸&quot;</span>
</code></pre></div>

<h4 id="_46">æ•°æ®åº“å›æ»š</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># âš ï¸ è­¦å‘Š: æ•°æ®åº“å›æ»šé£é™©é«˜ï¼Œå¿…é¡»å…ˆå¤‡ä»½!</span>

<span class="c1"># 1. åˆ›å»ºå½“å‰çŠ¶æ€å¤‡ä»½</span>
python<span class="w"> </span>backup/backup_manager.py<span class="w"> </span>--type<span class="w"> </span>emergency

<span class="c1"># 2. æ¢å¤åˆ°å›æ»šç‚¹</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>&lt;<span class="w"> </span>/tmp/backups/hashinsight_backup_20251003_020000.sql

<span class="c1"># 3. éªŒè¯æ•°æ®å®Œæ•´æ€§</span>
python<span class="w"> </span>scripts/verify_database_integrity.py

<span class="c1"># 4. é‡å¯åº”ç”¨</span>
systemctl<span class="w"> </span>restart<span class="w"> </span>hashinsight
</code></pre></div>

<h3 id="106">10.6 æ²Ÿé€šæ¨¡æ¿</h3>
<h4 id="_47">åˆå§‹äº‹æ•…é€šå‘Š</h4>
<div class="codehilite"><pre><span></span><code><span class="err">ğŸ“¢</span><span class="w"> </span><span class="o">[</span><span class="n">P0 äº‹æ•…</span><span class="o">]</span><span class="w"> </span><span class="n">HashInsight</span><span class="w"> </span><span class="n">æœåŠ¡ä¸­æ–­</span>

<span class="nl">æ—¶é—´</span><span class="p">:</span><span class="w"> </span><span class="mi">2025</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">03</span><span class="w"> </span><span class="mi">14</span><span class="err">:</span><span class="mi">23</span><span class="w"> </span><span class="n">UTC</span>
<span class="nl">å½±å“</span><span class="p">:</span><span class="w"> </span><span class="n">æ‰€æœ‰ç”¨æˆ·æ— æ³•è®¿é—®ä¸»åº”ç”¨</span>
<span class="nl">çŠ¶æ€</span><span class="p">:</span><span class="w"> </span><span class="n">æ­£åœ¨è°ƒæŸ¥</span>

<span class="n">æˆ‘ä»¬å·²ç¡®è®¤æœåŠ¡ä¸­æ–­é—®é¢˜</span><span class="err">ï¼Œ</span><span class="n">å›¢é˜Ÿæ­£åœ¨ç´§æ€¥æ’æŸ¥</span><span class="err">ã€‚</span>
<span class="n">é¢„è®¡åœ¨30åˆ†é’Ÿå†…æä¾›æ›´æ–°</span><span class="err">ã€‚</span>

<span class="nl">äº‹æ•…é¢‘é“</span><span class="p">:</span><span class="w"> </span><span class="n">#incident</span><span class="o">-</span><span class="mi">2025</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">03</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">outage</span>
<span class="nl">å€¼ç­å·¥ç¨‹å¸ˆ</span><span class="p">:</span><span class="w"> </span><span class="nv">@john</span><span class="p">.</span><span class="n">doe</span>
</code></pre></div>

<h4 id="_48">è¿›åº¦æ›´æ–°</h4>
<div class="codehilite"><pre><span></span><code>ğŸ”„ [æ›´æ–°] HashInsight äº‹æ•…è¿›å±•

æ—¶é—´: 2025-10-03 14:45 UTC
æ ¹æœ¬åŸå› : æ•°æ®åº“è¿æ¥æ± è€—å°½
ç¼“è§£æªæ–½: å·²é‡å¯æ•°æ®åº“è¿æ¥æ± 
å½“å‰çŠ¶æ€: æœåŠ¡éƒ¨åˆ†æ¢å¤ï¼Œç›‘æ§ä¸­

ä¸‹æ¬¡æ›´æ–°: 15:00 UTC æˆ–æœ‰é‡å¤§è¿›å±•æ—¶
</code></pre></div>

<h4 id="_49">æ¢å¤é€šå‘Š</h4>
<div class="codehilite"><pre><span></span><code>âœ… [å·²è§£å†³] HashInsight æœåŠ¡å·²æ¢å¤

æ—¶é—´: 2025-10-03 15:12 UTC
æŒç»­æ—¶é—´: 49åˆ†é’Ÿ
æ ¹æœ¬åŸå› : PostgreSQLè¿æ¥æ± é…ç½®ä¸å½“
è§£å†³æ–¹æ¡ˆ: å·²å¢åŠ è¿æ¥æ± é™åˆ¶å¹¶ä¼˜åŒ–æ…¢æŸ¥è¯¢

æ‰€æœ‰æœåŠ¡ç°å·²å®Œå…¨æ¢å¤æ­£å¸¸ã€‚
äº‹ååˆ†ææŠ¥å‘Šå°†åœ¨24å°æ—¶å†…å‘å¸ƒã€‚

æ„Ÿè°¢æ‚¨çš„è€å¿ƒç­‰å¾…ã€‚
</code></pre></div>

<h3 id="107-postmortem">10.7 äº‹ååˆ†æ (Postmortem)</h3>
<h4 id="_50">æ¨¡æ¿</h4>
<div class="codehilite"><pre><span></span><code><span class="gh"># HashInsight äº‹æ•…æŠ¥å‘Š - 2025-10-03 æ•°æ®åº“ä¸­æ–­</span>

<span class="gu">## æ¦‚è¦</span>
<span class="k">-</span><span class="w"> </span><span class="gs">**äº‹æ•…ç¼–å·**</span>: INC-2025-1003-001
<span class="k">-</span><span class="w"> </span><span class="gs">**ä¸¥é‡ç¨‹åº¦**</span>: P0
<span class="k">-</span><span class="w"> </span><span class="gs">**å‘ç”Ÿæ—¶é—´**</span>: 2025-10-03 14:23 UTC
<span class="k">-</span><span class="w"> </span><span class="gs">**æ¢å¤æ—¶é—´**</span>: 2025-10-03 15:12 UTC
<span class="k">-</span><span class="w"> </span><span class="gs">**æŒç»­æ—¶é—´**</span>: 49åˆ†é’Ÿ
<span class="k">-</span><span class="w"> </span><span class="gs">**å½±å“ç”¨æˆ·**</span>: 100% (æ‰€æœ‰ç”¨æˆ·)

<span class="gu">## æ—¶é—´çº¿</span>
<span class="k">-</span><span class="w"> </span>14:23 - Prometheuså‘Šè­¦: æ•°æ®åº“è¿æ¥å¤±è´¥
<span class="k">-</span><span class="w"> </span>14:25 - å€¼ç­å·¥ç¨‹å¸ˆç¡®è®¤äº‹æ•…
<span class="k">-</span><span class="w"> </span>14:30 - å‘ç°è¿æ¥æ± è€—å°½
<span class="k">-</span><span class="w"> </span>14:35 - å®æ–½ä¸´æ—¶ç¼“è§£ (æ€æ­»ç©ºé—²è¿æ¥)
<span class="k">-</span><span class="w"> </span>14:45 - æœåŠ¡éƒ¨åˆ†æ¢å¤
<span class="k">-</span><span class="w"> </span>15:00 - å®æ–½æ°¸ä¹…ä¿®å¤ (å¢åŠ è¿æ¥æ± )
<span class="k">-</span><span class="w"> </span>15:12 - æœåŠ¡å®Œå…¨æ¢å¤

<span class="gu">## æ ¹æœ¬åŸå› </span>
PostgreSQLè¿æ¥æ± å¤§å°é…ç½®ä¸º10ï¼Œä½†å®é™…å¹¶å‘éœ€æ±‚è¾¾åˆ°30+ï¼Œ
å¯¼è‡´è¿æ¥ç­‰å¾…è¶…æ—¶ã€‚

<span class="gu">## è§£å†³æ–¹æ¡ˆ</span>
<span class="k">1.</span> ä¸´æ—¶: æ€æ­»ç©ºé—²è¿æ¥ï¼Œé‡Šæ”¾è¿æ¥æ± 
<span class="k">2.</span> æ°¸ä¹…: å¢åŠ è¿æ¥æ± å¤§å°è‡³20ï¼Œæº¢å‡ºè‡³40
<span class="k">3.</span> ä¼˜åŒ–: è¯†åˆ«å¹¶ä¼˜åŒ–3ä¸ªæ…¢æŸ¥è¯¢

<span class="gu">## é¢„é˜²æªæ–½</span>
<span class="k">- [ ]</span> è®¾ç½®è¿æ¥æ± å‘Šè­¦ (ä½¿ç”¨ç‡&gt;80%)
<span class="k">- [ ]</span> å®šæœŸå®¡æŸ¥æ…¢æŸ¥è¯¢
<span class="k">- [ ]</span> å¢åŠ å®¹é‡è§„åˆ’æµç¨‹
<span class="k">- [ ]</span> æ·»åŠ è¿æ¥æ± ç›‘æ§ä»ªè¡¨æ¿

<span class="gu">## ç»éªŒæ•™è®­</span>
âœ… å¿«é€Ÿå“åº”å’Œæ²Ÿé€šè‰¯å¥½
âŒ ç¼ºå°‘è¿æ¥æ± ç›‘æ§
âŒ å®¹é‡è§„åˆ’ä¸è¶³
</code></pre></div>

<hr />
<h2 id="_51">é™„å½•</h2>
<h3 id="a">é™„å½•A: å¸¸ç”¨å‘½ä»¤é€ŸæŸ¥è¡¨</h3>
<h4 id="_52">åº”ç”¨ç®¡ç†</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯åŠ¨åº”ç”¨</span>
gunicorn<span class="w"> </span>--bind<span class="w"> </span><span class="m">0</span>.0.0.0:5000<span class="w"> </span>--workers<span class="w"> </span><span class="m">4</span><span class="w"> </span>main:app

<span class="c1"># ä¼˜é›…é‡å¯</span>
<span class="nb">kill</span><span class="w"> </span>-HUP<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/var/run/gunicorn.pid<span class="k">)</span>

<span class="c1"># åœæ­¢åº”ç”¨</span>
<span class="nb">kill</span><span class="w"> </span>-TERM<span class="w"> </span><span class="k">$(</span>cat<span class="w"> </span>/var/run/gunicorn.pid<span class="k">)</span>

<span class="c1"># æŸ¥çœ‹è¿›ç¨‹</span>
ps<span class="w"> </span>aux<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>gunicorn

<span class="c1"># æŸ¥çœ‹æ—¥å¿—</span>
tail<span class="w"> </span>-f<span class="w"> </span>/var/log/hashinsight/app.log
</code></pre></div>

<h4 id="_53">æ•°æ®åº“</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># è¿æ¥æ•°æ®åº“</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span>

<span class="c1"># æŸ¥çœ‹è¡¨</span>
<span class="se">\d</span>t

<span class="c1"># æŸ¥çœ‹è¿æ¥æ•°</span>
SELECT<span class="w"> </span>count<span class="o">(</span>*<span class="o">)</span><span class="w"> </span>FROM<span class="w"> </span>pg_stat_activity<span class="p">;</span>

<span class="c1"># å¤‡ä»½æ•°æ®åº“</span>
pg_dump<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>&gt;<span class="w"> </span>backup.sql

<span class="c1"># æ¢å¤æ•°æ®åº“</span>
psql<span class="w"> </span><span class="nv">$DATABASE_URL</span><span class="w"> </span>&lt;<span class="w"> </span>backup.sql
</code></pre></div>

<h4 id="_54">ç¼“å­˜</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># Redisè¿æ¥</span>
redis-cli

<span class="c1"># æŸ¥çœ‹æ‰€æœ‰é”®</span>
redis-cli<span class="w"> </span>KEYS<span class="w"> </span><span class="s1">&#39;hashinsight:*&#39;</span>

<span class="c1"># æ¸…ç©ºç¼“å­˜</span>
redis-cli<span class="w"> </span>FLUSHDB

<span class="c1"># æŸ¥çœ‹å†…å­˜ä½¿ç”¨</span>
redis-cli<span class="w"> </span>INFO<span class="w"> </span>memory
</code></pre></div>

<h4 id="_55">ç›‘æ§</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># æŸ¥çœ‹å¥åº·çŠ¶æ€</span>
curl<span class="w"> </span>http://localhost:5000/health<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq

<span class="c1"># æŸ¥çœ‹PrometheusæŒ‡æ ‡</span>
curl<span class="w"> </span>http://localhost:9090/metrics

<span class="c1"># æŸ¥çœ‹SLOçŠ¶æ€</span>
curl<span class="w"> </span>http://localhost:5000/api/slo/status<span class="w"> </span><span class="p">|</span><span class="w"> </span>jq
</code></pre></div>

<h3 id="b">é™„å½•B: é…ç½®æ–‡ä»¶ç¤ºä¾‹</h3>
<h4 id="env">.env ç¤ºä¾‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¿…éœ€é…ç½®</span>
<span class="nv">DATABASE_URL</span><span class="o">=</span>postgresql://user:pass@host:5432/hashinsight_db
<span class="nv">SESSION_SECRET</span><span class="o">=</span>your-secret-key-min-32-chars
<span class="nv">ENCRYPTION_PASSWORD</span><span class="o">=</span>encryption-key-min-32-chars

<span class="c1"># åŒºå—é“¾é…ç½®</span>
<span class="nv">BLOCKCHAIN_ENABLED</span><span class="o">=</span><span class="nb">true</span>
<span class="nv">BLOCKCHAIN_PRIVATE_KEY</span><span class="o">=</span>0x1234567890abcdef...
<span class="nv">BLOCKCHAIN_NETWORK</span><span class="o">=</span>base-sepolia
<span class="nv">BASE_RPC_URL</span><span class="o">=</span>https://sepolia.base.org

<span class="c1"># å¤‡ä»½é…ç½®</span>
<span class="nv">BACKUP_DIR</span><span class="o">=</span>/var/backups/hashinsight
<span class="nv">BACKUP_ENCRYPTION_KEY</span><span class="o">=</span>backup-encryption-key
<span class="nv">BACKUP_RETENTION_DAYS</span><span class="o">=</span><span class="m">30</span>
<span class="nv">BACKUP_STORAGE_TYPE</span><span class="o">=</span>s3
<span class="nv">BACKUP_STORAGE_BUCKET</span><span class="o">=</span>hashinsight-backups

<span class="c1"># KMSé…ç½® (AWS)</span>
<span class="nv">AWS_KMS_KEY_ID</span><span class="o">=</span>arn:aws:kms:us-east-1:123456789:key/xxxxx
<span class="nv">AWS_KMS_REGION</span><span class="o">=</span>us-east-1
<span class="nv">AWS_ACCESS_KEY_ID</span><span class="o">=</span>AKIAXXXXXXXX
<span class="nv">AWS_SECRET_ACCESS_KEY</span><span class="o">=</span>xxxxxxxxxx

<span class="c1"># ç›‘æ§é…ç½®</span>
<span class="nv">ENABLE_BACKGROUND_SERVICES</span><span class="o">=</span><span class="m">0</span><span class="w">  </span><span class="c1"># é»˜è®¤ç¦ç”¨ï¼›è®¾ä¸º 1 å¯ç”¨åå°æ•°æ®é‡‡é›†</span>
<span class="nv">PROMETHEUS_PORT</span><span class="o">=</span><span class="m">9090</span>
<span class="nv">SLO_MEASUREMENT_WINDOW</span><span class="o">=</span><span class="m">30</span>

<span class="c1"># APIé…ç½®</span>
<span class="nv">COINWARZ_API_KEY</span><span class="o">=</span>your-coinwarz-api-key
<span class="nv">COINGECKO_API_KEY</span><span class="o">=</span>your-coingecko-api-key
</code></pre></div>

<h4 id="systemd">systemdæœåŠ¡æ–‡ä»¶ç¤ºä¾‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># /etc/systemd/system/hashinsight.service</span>

<span class="k">[Unit]</span>
<span class="na">Description</span><span class="o">=</span><span class="s">HashInsight Platform</span>
<span class="na">After</span><span class="o">=</span><span class="s">network.target postgresql.service</span>

<span class="k">[Service]</span>
<span class="na">Type</span><span class="o">=</span><span class="s">notify</span>
<span class="na">User</span><span class="o">=</span><span class="s">hashinsight</span>
<span class="na">Group</span><span class="o">=</span><span class="s">hashinsight</span>
<span class="na">WorkingDirectory</span><span class="o">=</span><span class="s">/opt/hashinsight</span>
<span class="na">EnvironmentFile</span><span class="o">=</span><span class="s">/opt/hashinsight/.env</span>

<span class="na">ExecStart</span><span class="o">=</span><span class="s">/opt/hashinsight/venv/bin/gunicorn </span>\
<span class="w">  </span><span class="s">--bind 0.0.0.0:5000 </span>\
<span class="w">  </span><span class="s">--workers 4 </span>\
<span class="w">  </span><span class="s">--threads 2 </span>\
<span class="w">  </span><span class="s">--worker-class gthread </span>\
<span class="w">  </span><span class="s">--timeout 120 </span>\
<span class="w">  </span><span class="s">--max-requests 1000 </span>\
<span class="w">  </span><span class="s">--access-logfile /var/log/hashinsight/access.log </span>\
<span class="w">  </span><span class="s">--error-logfile /var/log/hashinsight/error.log </span>\
<span class="w">  </span><span class="s">--pid /var/run/gunicorn.pid </span>\
<span class="w">  </span><span class="s">main:app</span>

<span class="na">ExecReload</span><span class="o">=</span><span class="s">/bin/kill -s HUP $MAINPID</span>
<span class="na">KillMode</span><span class="o">=</span><span class="s">mixed</span>
<span class="na">KillSignal</span><span class="o">=</span><span class="s">SIGTERM</span>
<span class="na">TimeoutStopSec</span><span class="o">=</span><span class="s">30</span>

<span class="na">Restart</span><span class="o">=</span><span class="s">on-failure</span>
<span class="na">RestartSec</span><span class="o">=</span><span class="s">10</span>

<span class="k">[Install]</span>
<span class="na">WantedBy</span><span class="o">=</span><span class="s">multi-user.target</span>
</code></pre></div>

<h3 id="c">é™„å½•C: ç›‘æ§æŒ‡æ ‡å‚è€ƒ</h3>
<h4 id="prometheus_1">PrometheusæŒ‡æ ‡åˆ—è¡¨</h4>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡åç§°</th>
<th>ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>hashinsight_requests_total</code></td>
<td>Counter</td>
<td>æ€»è¯·æ±‚æ•°</td>
</tr>
<tr>
<td><code>hashinsight_request_latency_seconds</code></td>
<td>Histogram</td>
<td>è¯·æ±‚å»¶è¿Ÿ</td>
</tr>
<tr>
<td><code>hashinsight_error_rate</code></td>
<td>Gauge</td>
<td>é”™è¯¯ç‡</td>
</tr>
<tr>
<td><code>hashinsight_cache_hit_rate</code></td>
<td>Gauge</td>
<td>ç¼“å­˜å‘½ä¸­ç‡</td>
</tr>
<tr>
<td><code>hashinsight_db_query_duration_seconds</code></td>
<td>Histogram</td>
<td>æ•°æ®åº“æŸ¥è¯¢æ—¶é—´</td>
</tr>
<tr>
<td><code>hashinsight_db_connection_pool_size</code></td>
<td>Gauge</td>
<td>æ•°æ®åº“è¿æ¥æ± å¤§å°</td>
</tr>
<tr>
<td><code>hashinsight_db_connection_pool_active</code></td>
<td>Gauge</td>
<td>æ´»è·ƒè¿æ¥æ•°</td>
</tr>
<tr>
<td><code>hashinsight_slo_compliance</code></td>
<td>Gauge</td>
<td>SLOåˆè§„æ€§</td>
</tr>
<tr>
<td><code>hashinsight_slo_error_budget_remaining</code></td>
<td>Gauge</td>
<td>é”™è¯¯é¢„ç®—å‰©ä½™</td>
</tr>
<tr>
<td><code>hashinsight_circuit_breaker_state</code></td>
<td>Gauge</td>
<td>ç†”æ–­å™¨çŠ¶æ€</td>
</tr>
</tbody>
</table>
<h4 id="slo_4">SLOé˜ˆå€¼</h4>
<table>
<thead>
<tr>
<th>SLOç±»å‹</th>
<th>ç›®æ ‡</th>
<th>è­¦å‘Šé˜ˆå€¼</th>
<th>ä¸¥é‡é˜ˆå€¼</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¯ç”¨æ€§</td>
<td>99.95%</td>
<td>&lt;99.9%</td>
<td>&lt;99.5%</td>
</tr>
<tr>
<td>P95å»¶è¿Ÿ</td>
<td>â‰¤250ms</td>
<td>&gt;200ms</td>
<td>&gt;300ms</td>
</tr>
<tr>
<td>é”™è¯¯ç‡</td>
<td>â‰¤0.1%</td>
<td>&gt;0.5%</td>
<td>&gt;1%</td>
</tr>
<tr>
<td>é”™è¯¯é¢„ç®—</td>
<td>21.6min/æœˆ</td>
<td>&lt;20%</td>
<td>&lt;10%</td>
</tr>
</tbody>
</table>
<h3 id="d">é™„å½•D: é”™è¯¯ä»£ç å¯¹ç…§è¡¨</h3>
<table>
<thead>
<tr>
<th>é”™è¯¯ä»£ç </th>
<th>HTTPçŠ¶æ€</th>
<th>è¯´æ˜</th>
<th>è§£å†³æ–¹æ¡ˆ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AUTH_001</code></td>
<td>401</td>
<td>æœªç™»å½•</td>
<td>é‡æ–°ç™»å½•</td>
</tr>
<tr>
<td><code>AUTH_002</code></td>
<td>403</td>
<td>æƒé™ä¸è¶³</td>
<td>è”ç³»ç®¡ç†å‘˜</td>
</tr>
<tr>
<td><code>AUTH_003</code></td>
<td>401</td>
<td>Sessionè¿‡æœŸ</td>
<td>é‡æ–°ç™»å½•</td>
</tr>
<tr>
<td><code>DB_001</code></td>
<td>500</td>
<td>æ•°æ®åº“è¿æ¥å¤±è´¥</td>
<td>æ£€æŸ¥DATABASE_URL</td>
</tr>
<tr>
<td><code>DB_002</code></td>
<td>500</td>
<td>æŸ¥è¯¢è¶…æ—¶</td>
<td>ä¼˜åŒ–æŸ¥è¯¢æˆ–å¢åŠ è¶…æ—¶</td>
</tr>
<tr>
<td><code>CACHE_001</code></td>
<td>503</td>
<td>Redisä¸å¯ç”¨</td>
<td>æ£€æŸ¥RedisæœåŠ¡</td>
</tr>
<tr>
<td><code>API_001</code></td>
<td>429</td>
<td>è¯·æ±‚è¿‡äºé¢‘ç¹</td>
<td>é™ä½è¯·æ±‚é¢‘ç‡</td>
</tr>
<tr>
<td><code>API_002</code></td>
<td>500</td>
<td>å¤–éƒ¨APIå¤±è´¥</td>
<td>ç¨åé‡è¯•</td>
</tr>
<tr>
<td><code>BLOCKCHAIN_001</code></td>
<td>500</td>
<td>ç§é’¥æœªé…ç½®</td>
<td>è®¾ç½®BLOCKCHAIN_PRIVATE_KEY</td>
</tr>
<tr>
<td><code>ENCRYPTION_001</code></td>
<td>500</td>
<td>åŠ å¯†å¯†é’¥æœªé…ç½®</td>
<td>è®¾ç½®ENCRYPTION_PASSWORD</td>
</tr>
</tbody>
</table>
<h3 id="e">é™„å½•E: æ›´æ–°å†å²</h3>
<table>
<thead>
<tr>
<th>ç‰ˆæœ¬</th>
<th>æ—¥æœŸ</th>
<th>ä½œè€…</th>
<th>å˜æ›´å†…å®¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>v2.0</td>
<td>2025-10-03</td>
<td>HashInsight Ops Team</td>
<td>å®Œæ•´è¿ç»´æ‰‹å†Œé¦–æ¬¡å‘å¸ƒ</td>
</tr>
<tr>
<td>v1.9</td>
<td>2025-09-15</td>
<td>DevOps Team</td>
<td>æ·»åŠ Request Coalescingä¼˜åŒ–</td>
</tr>
<tr>
<td>v1.8</td>
<td>2025-08-20</td>
<td>Security Team</td>
<td>å¢å¼ºKMSå’ŒmTLSæ–‡æ¡£</td>
</tr>
<tr>
<td>v1.7</td>
<td>2025-07-10</td>
<td>Platform Team</td>
<td>æ·»åŠ SLOç›‘æ§ç« èŠ‚</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_56">æ–‡æ¡£ç»´æŠ¤</h2>
<p><strong>ç»´æŠ¤è´£ä»»</strong>: HashInsight Platform Operations Team<br />
<strong>å®¡æ ¸å‘¨æœŸ</strong>: æ¯å­£åº¦<br />
<strong>åé¦ˆæ¸ é“</strong>: ops@hashinsight.net<br />
<strong>æ–‡æ¡£ä»“åº“</strong>: https://github.com/hashinsight/operations-manual</p>
<p><strong>æœ€åæ›´æ–°</strong>: 2025-10-03<br />
<strong>ä¸‹æ¬¡å®¡æ ¸</strong>: 2026-01-03</p>
<hr />
<p><strong>Â© 2025 HashInsight Platform. All Rights Reserved.</strong><br />
<strong>Confidential - Internal Use Only</strong></p>
</body>
</html>