{% extends "base.html" %}

{% block title %}
    {% if current_lang == 'en' %}Crypto Payment Dashboard{% else %}åŠ å¯†è´§å¸æ”¯ä»˜ç®¡ç†{% endif %} - Web3 Dashboard
{% endblock %}

{% block extra_css %}
<style>
/* åŠ å¯†è´§å¸æ”¯ä»˜ç®¡ç†ä¸“ç”¨æ ·å¼ */
:root {
    --crypto-primary: #f7931a; /* Bitcoinæ©™è‰² */
    --crypto-secondary: #627eea; /* Ethereumè“è‰² */
    --crypto-accent: #3c3c3d; /* USDCæ·±è‰² */
    --crypto-success: #00d4aa;
    --crypto-warning: #ffa500;
    --crypto-danger: #ff6b6b;
    --crypto-gold: #ffd700;
    --bg-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
    --card-bg: rgba(255, 255, 255, 0.08);
    --card-border: rgba(247, 147, 26, 0.3);
    --text-primary: #ffffff;
    --text-secondary: #b8b8b8;
    --shadow-glow: 0 8px 32px rgba(247, 147, 26, 0.2);
    --neon-glow: 0 0 25px rgba(247, 147, 26, 0.6);
}

body {
    background: var(--bg-gradient);
    min-height: 100vh;
    color: var(--text-primary);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

.crypto-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
}

/* é¡µé¢å¤´éƒ¨ */
.crypto-header {
    text-align: center;
    margin-bottom: 3rem;
    position: relative;
}

.crypto-title {
    font-size: 3rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--crypto-primary), var(--crypto-secondary), var(--crypto-accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 1rem;
    text-shadow: 0 0 30px rgba(247, 147, 26, 0.3);
}

.crypto-subtitle {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
    max-width: 700px;
    margin-left: auto;
    margin-right: auto;
}

/* å¿«é€Ÿæ“ä½œé¢æ¿ */
.quick-actions {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 3rem;
}

.action-btn {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    color: var(--text-primary);
    text-decoration: none;
    transition: all 0.3s ease;
    backdrop-filter: blur(20px);
    position: relative;
    overflow: hidden;
}

.action-btn:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-glow);
    border-color: var(--crypto-primary);
    color: var(--text-primary);
    text-decoration: none;
}

.action-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent, rgba(247, 147, 26, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.action-btn:hover::before {
    opacity: 1;
}

.action-icon {
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

.action-text {
    font-weight: 600;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    position: relative;
    z-index: 2;
}

/* åŠ å¯†è´§å¸æ”¯æŒé¢æ¿ */
.currency-panel {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 3rem;
    backdrop-filter: blur(20px);
}

.currency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
}

.currency-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.currency-card.btc {
    border-color: var(--crypto-primary);
}

.currency-card.eth {
    border-color: var(--crypto-secondary);
}

.currency-card.usdc {
    border-color: var(--crypto-accent);
}

.currency-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.currency-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
    position: relative;
    z-index: 2;
}

.currency-icon.btc {
    color: var(--crypto-primary);
    filter: drop-shadow(0 0 15px var(--crypto-primary));
}

.currency-icon.eth {
    color: var(--crypto-secondary);
    filter: drop-shadow(0 0 15px var(--crypto-secondary));
}

.currency-icon.usdc {
    color: var(--crypto-accent);
    filter: drop-shadow(0 0 15px var(--crypto-accent));
}

.currency-name {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
}

.currency-symbol {
    font-size: 1rem;
    color: var(--text-secondary);
    margin-bottom: 1rem;
    font-family: 'JetBrains Mono', monospace;
}

.currency-price {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
}

.currency-price.btc {
    color: var(--crypto-primary);
}

.currency-price.eth {
    color: var(--crypto-secondary);
}

.currency-price.usdc {
    color: var(--crypto-accent);
}

.currency-change {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.currency-change.positive {
    color: var(--crypto-success);
}

.currency-change.negative {
    color: var(--crypto-danger);
}

.currency-actions {
    display: flex;
    gap: 0.5rem;
}

.currency-btn {
    flex: 1;
    padding: 0.75rem;
    border: 1px solid currentColor;
    background: rgba(255, 255, 255, 0.05);
    color: inherit;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-decoration: none;
    text-align: center;
}

.currency-btn:hover {
    background: currentColor;
    color: #000;
    transform: translateY(-2px);
}

/* æ”¯ä»˜å†å² */
.payment-history {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 3rem;
    backdrop-filter: blur(20px);
}

.history-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 2rem;
}

.history-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
}

.history-filter {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.filter-select {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 0.5rem 1rem;
    color: var(--text-primary);
    font-size: 0.9rem;
}

.filter-select:focus {
    outline: none;
    border-color: var(--crypto-primary);
}

.payment-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
}

.payment-table th {
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-secondary);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.payment-table td {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    vertical-align: middle;
}

.payment-table tr:hover {
    background: rgba(255, 255, 255, 0.02);
}

.payment-status {
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    text-transform: uppercase;
}

.payment-status.completed {
    background: rgba(0, 212, 170, 0.2);
    color: var(--crypto-success);
    border: 1px solid var(--crypto-success);
}

.payment-status.pending {
    background: rgba(255, 165, 0, 0.2);
    color: var(--crypto-warning);
    border: 1px solid var(--crypto-warning);
}

.payment-status.failed {
    background: rgba(255, 107, 107, 0.2);
    color: var(--crypto-danger);
    border: 1px solid var(--crypto-danger);
}

.payment-amount {
    font-family: 'JetBrains Mono', monospace;
    font-weight: 600;
}

.payment-hash {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.8rem;
    color: var(--text-secondary);
    cursor: pointer;
    text-decoration: underline;
}

.payment-hash:hover {
    color: var(--crypto-primary);
}

/* ç»Ÿè®¡å¡ç‰‡ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 20px;
    padding: 2rem;
    text-align: center;
    backdrop-filter: blur(20px);
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-glow);
}

.stat-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    color: var(--crypto-primary);
    filter: drop-shadow(0 0 10px var(--crypto-primary));
}

.stat-value {
    font-size: 2rem;
    font-weight: 800;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

/* é’±åŒ…ä½™é¢ */
.wallet-balances {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 2rem;
    margin-bottom: 3rem;
    backdrop-filter: blur(20px);
}

.balance-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
}

.balance-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.balance-card:hover {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--crypto-primary);
}

.balance-currency {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.balance-amount {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 0.5rem;
    font-family: 'JetBrains Mono', monospace;
}

.balance-usd {
    font-size: 0.8rem;
    color: var(--text-secondary);
}

/* æ”¯ä»˜åˆ›å»ºæ¨¡æ€æ¡† */
.payment-modal .modal-content {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    backdrop-filter: blur(20px);
    color: var(--text-primary);
}

.payment-modal .modal-header {
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.payment-form {
    padding: 1rem 0;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-label {
    display: block;
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input, .form-select {
    width: 100%;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    color: var(--text-primary);
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-input:focus, .form-select:focus {
    outline: none;
    border-color: var(--crypto-primary);
    box-shadow: 0 0 0 3px rgba(247, 147, 26, 0.1);
}

.qr-container {
    text-align: center;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 16px;
    margin: 1rem 0;
}

.qr-code {
    width: 200px;
    height: 200px;
    margin: 0 auto 1rem;
    background: #fff;
    border-radius: 12px;
    padding: 1rem;
}

.payment-address {
    font-family: 'JetBrains Mono', monospace;
    background: rgba(0, 0, 0, 0.3);
    padding: 0.75rem;
    border-radius: 8px;
    word-break: break-all;
    margin-bottom: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.payment-address:hover {
    background: rgba(0, 0, 0, 0.5);
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .crypto-container {
        padding: 1rem;
    }
    
    .crypto-title {
        font-size: 2.5rem;
    }
    
    .quick-actions {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .currency-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .payment-table {
        font-size: 0.8rem;
    }
    
    .payment-table th,
    .payment-table td {
        padding: 0.5rem;
    }
}

@media (max-width: 480px) {
    .quick-actions {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .balance-grid {
        grid-template-columns: 1fr;
    }
}

/* åŠ è½½åŠ¨ç”» */
.loading-spinner {
    display: inline-block;
    width: 30px;
    height: 30px;
    border: 3px solid rgba(247, 147, 26, 0.3);
    border-radius: 50%;
    border-top-color: var(--crypto-primary);
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

/* æµ®åŠ¨æ•ˆæœ */
.floating {
    animation: float 6s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
}

/* è„‰å†²æ•ˆæœ */
.pulse {
    animation: pulse 2s infinite;
}

@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}
</style>
{% endblock %}

{% block content %}
<div class="crypto-container">
    <!-- é¡µé¢å¤´éƒ¨ -->
    <div class="crypto-header">
        <h1 class="crypto-title floating">
            {% if current_lang == 'en' %}
                Crypto Payment Dashboard
            {% else %}
                åŠ å¯†è´§å¸æ”¯ä»˜ç®¡ç†
            {% endif %}
        </h1>
        <p class="crypto-subtitle">
            {% if current_lang == 'en' %}
                Secure cryptocurrency payments with multi-chain support and real-time tracking
            {% else %}
                å®‰å…¨çš„åŠ å¯†è´§å¸æ”¯ä»˜ï¼Œæ”¯æŒå¤šé“¾å’Œå®æ—¶è¿½è¸ª
            {% endif %}
        </p>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="quick-actions">
        <a href="#" class="action-btn" onclick="createNewPayment()">
            <div class="action-icon">ğŸ’°</div>
            <div class="action-text">
                {% if current_lang == 'en' %}Create Payment{% else %}åˆ›å»ºæ”¯ä»˜{% endif %}
            </div>
        </a>
        
        <a href="#" class="action-btn" onclick="checkBalances()">
            <div class="action-icon">ğŸ‘›</div>
            <div class="action-text">
                {% if current_lang == 'en' %}Check Balances{% else %}æŸ¥çœ‹ä½™é¢{% endif %}
            </div>
        </a>
        
        <a href="#" class="action-btn" onclick="viewPaymentHistory()">
            <div class="action-icon">ğŸ“‹</div>
            <div class="action-text">
                {% if current_lang == 'en' %}Payment History{% else %}æ”¯ä»˜å†å²{% endif %}
            </div>
        </a>
        
        <a href="#" class="action-btn" onclick="downloadReceipts()">
            <div class="action-icon">ğŸ“„</div>
            <div class="action-text">
                {% if current_lang == 'en' %}Download Receipt{% else %}ä¸‹è½½æ”¶æ®{% endif %}
            </div>
        </a>
    </div>

    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">ğŸ’³</div>
            <div class="stat-value" id="totalPayments">0</div>
            <div class="stat-label">
                {% if current_lang == 'en' %}Total Payments{% else %}æ€»æ”¯ä»˜æ•°{% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-value" id="successfulPayments">0</div>
            <div class="stat-label">
                {% if current_lang == 'en' %}Successful{% else %}æˆåŠŸæ”¯ä»˜{% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">â³</div>
            <div class="stat-value" id="pendingPayments">0</div>
            <div class="stat-label">
                {% if current_lang == 'en' %}Pending{% else %}å¾…å¤„ç†{% endif %}
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ’</div>
            <div class="stat-value" id="totalVolume">$0</div>
            <div class="stat-label">
                {% if current_lang == 'en' %}Total Volume{% else %}æ€»äº¤æ˜“é¢{% endif %}
            </div>
        </div>
    </div>

    <!-- æ”¯æŒçš„åŠ å¯†è´§å¸ -->
    <div class="currency-panel">
        <h2 style="color: var(--text-primary); margin-bottom: 2rem; text-align: center;">
            {% if current_lang == 'en' %}Supported Cryptocurrencies{% else %}æ”¯æŒçš„åŠ å¯†è´§å¸{% endif %}
        </h2>
        <div class="currency-grid">
            <div class="currency-card btc">
                <div class="currency-icon btc">â‚¿</div>
                <div class="currency-name">Bitcoin</div>
                <div class="currency-symbol">BTC</div>
                <div class="currency-price btc" id="btcPrice">$0</div>
                <div class="currency-change" id="btcChange">+0.00%</div>
                <div class="currency-actions">
                    <button class="currency-btn" onclick="createPayment('BTC')">
                        {% if current_lang == 'en' %}Pay with BTC{% else %}ä½¿ç”¨BTCæ”¯ä»˜{% endif %}
                    </button>
                </div>
            </div>
            
            <div class="currency-card eth">
                <div class="currency-icon eth">Î</div>
                <div class="currency-name">Ethereum</div>
                <div class="currency-symbol">ETH</div>
                <div class="currency-price eth" id="ethPrice">$0</div>
                <div class="currency-change" id="ethChange">+0.00%</div>
                <div class="currency-actions">
                    <button class="currency-btn" onclick="createPayment('ETH')">
                        {% if current_lang == 'en' %}Pay with ETH{% else %}ä½¿ç”¨ETHæ”¯ä»˜{% endif %}
                    </button>
                </div>
            </div>
            
            <div class="currency-card usdc">
                <div class="currency-icon usdc">$</div>
                <div class="currency-name">USD Coin</div>
                <div class="currency-symbol">USDC</div>
                <div class="currency-price usdc" id="usdcPrice">$1.00</div>
                <div class="currency-change" id="usdcChange">+0.00%</div>
                <div class="currency-actions">
                    <button class="currency-btn" onclick="createPayment('USDC')">
                        {% if current_lang == 'en' %}Pay with USDC{% else %}ä½¿ç”¨USDCæ”¯ä»˜{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- é’±åŒ…ä½™é¢ -->
    <div class="wallet-balances">
        <h2 style="color: var(--text-primary); margin-bottom: 2rem; text-align: center;">
            {% if current_lang == 'en' %}Wallet Balances{% else %}é’±åŒ…ä½™é¢{% endif %}
        </h2>
        <div class="balance-grid" id="balanceGrid">
            <!-- ä½™é¢å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <!-- æ”¯ä»˜å†å² -->
    <div class="payment-history">
        <div class="history-header">
            <h2 class="history-title">
                {% if current_lang == 'en' %}Payment History{% else %}æ”¯ä»˜å†å²{% endif %}
            </h2>
            <div class="history-filter">
                <select class="filter-select" id="statusFilter" onchange="filterPayments()">
                    <option value="">{% if current_lang == 'en' %}All Status{% else %}æ‰€æœ‰çŠ¶æ€{% endif %}</option>
                    <option value="COMPLETED">{% if current_lang == 'en' %}Completed{% else %}å·²å®Œæˆ{% endif %}</option>
                    <option value="PENDING">{% if current_lang == 'en' %}Pending{% else %}å¾…å¤„ç†{% endif %}</option>
                    <option value="FAILED">{% if current_lang == 'en' %}Failed{% else %}å¤±è´¥{% endif %}</option>
                </select>
                
                <select class="filter-select" id="currencyFilter" onchange="filterPayments()">
                    <option value="">{% if current_lang == 'en' %}All Currencies{% else %}æ‰€æœ‰å¸ç§{% endif %}</option>
                    <option value="BTC">Bitcoin (BTC)</option>
                    <option value="ETH">Ethereum (ETH)</option>
                    <option value="USDC">USD Coin (USDC)</option>
                </select>
            </div>
        </div>
        
        <table class="payment-table">
            <thead>
                <tr>
                    <th>{% if current_lang == 'en' %}Date{% else %}æ—¥æœŸ{% endif %}</th>
                    <th>{% if current_lang == 'en' %}Amount{% else %}é‡‘é¢{% endif %}</th>
                    <th>{% if current_lang == 'en' %}Currency{% else %}å¸ç§{% endif %}</th>
                    <th>{% if current_lang == 'en' %}Status{% else %}çŠ¶æ€{% endif %}</th>
                    <th>{% if current_lang == 'en' %}Transaction{% else %}äº¤æ˜“å“ˆå¸Œ{% endif %}</th>
                    <th>{% if current_lang == 'en' %}Actions{% else %}æ“ä½œ{% endif %}</th>
                </tr>
            </thead>
            <tbody id="paymentTableBody">
                <!-- æ”¯ä»˜è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
            </tbody>
        </table>
    </div>
</div>

<!-- åˆ›å»ºæ”¯ä»˜æ¨¡æ€æ¡† -->
<div class="modal fade payment-modal" id="paymentModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    {% if current_lang == 'en' %}Create Crypto Payment{% else %}åˆ›å»ºåŠ å¯†è´§å¸æ”¯ä»˜{% endif %}
                </h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span style="color: var(--text-primary);">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form class="payment-form" id="paymentForm">
                    <div class="form-group">
                        <label class="form-label">
                            {% if current_lang == 'en' %}Amount (USD){% else %}é‡‘é¢ (USD){% endif %}
                        </label>
                        <input type="number" class="form-input" id="paymentAmount" 
                               placeholder="100.00" min="10" step="0.01" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            {% if current_lang == 'en' %}Cryptocurrency{% else %}åŠ å¯†è´§å¸{% endif %}
                        </label>
                        <select class="form-select" id="paymentCurrency" required>
                            <option value="BTC">Bitcoin (BTC)</option>
                            <option value="ETH">Ethereum (ETH)</option>
                            <option value="USDC">USD Coin (USDC)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            {% if current_lang == 'en' %}Purpose{% else %}æ”¯ä»˜ç”¨é€”{% endif %}
                        </label>
                        <select class="form-select" id="paymentPurpose" required>
                            <option value="subscription">
                                {% if current_lang == 'en' %}Subscription Payment{% else %}è®¢é˜…æ”¯ä»˜{% endif %}
                            </option>
                            <option value="upgrade">
                                {% if current_lang == 'en' %}Plan Upgrade{% else %}è®¡åˆ’å‡çº§{% endif %}
                            </option>
                            <option value="addon">
                                {% if current_lang == 'en' %}Add-on Service{% else %}é™„åŠ æœåŠ¡{% endif %}
                            </option>
                        </select>
                    </div>
                    
                    <div class="text-center">
                        <button type="submit" class="btn btn-primary btn-lg">
                            {% if current_lang == 'en' %}Generate Payment Address{% else %}ç”Ÿæˆæ”¯ä»˜åœ°å€{% endif %}
                        </button>
                    </div>
                </form>
                
                <!-- æ”¯ä»˜åœ°å€æ˜¾ç¤ºåŒºåŸŸ -->
                <div id="paymentAddressSection" style="display: none;">
                    <div class="qr-container">
                        <div class="qr-code" id="paymentQR"></div>
                        <div class="payment-address" id="paymentAddress" onclick="copyToClipboard(this.textContent)">
                            <!-- æ”¯ä»˜åœ°å€å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                        </div>
                        <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
                            {% if current_lang == 'en' %}Click address to copy{% else %}ç‚¹å‡»åœ°å€å¤åˆ¶{% endif %}
                        </div>
                        <div style="color: var(--crypto-warning); font-size: 0.9rem;">
                            {% if current_lang == 'en' %}Payment will expire in 24 hours{% else %}æ”¯ä»˜å°†åœ¨24å°æ—¶åè¿‡æœŸ{% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½è¦†ç›–å±‚ -->
<div class="loading-overlay" id="loadingOverlay" style="display: none;">
    <div>
        <div class="loading-spinner"></div>
        <div style="color: var(--text-primary); margin-top: 1rem; text-align: center;">
            {% if current_lang == 'en' %}Processing...{% else %}å¤„ç†ä¸­...{% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// åŠ å¯†è´§å¸æ”¯ä»˜ç®¡ç†JavaScript

// å…¨å±€å˜é‡
let payments = [];
let allPayments = [];
let cryptoPrices = {};
let walletBalances = {};

// é¡µé¢åˆå§‹åŒ–
document.addEventListener('DOMContentLoaded', function() {
    initializeCryptoPaymentDashboard();
    loadCryptoPrices();
    loadPaymentStats();
    loadPaymentHistory();
    loadWalletBalances();
    
    // è®¾ç½®å®šæœŸæ›´æ–°
    setInterval(updatePrices, 60000); // æ¯åˆ†é’Ÿæ›´æ–°ä»·æ ¼
    setInterval(loadPaymentHistory, 30000); // æ¯30ç§’æ›´æ–°æ”¯ä»˜å†å²
});

// åˆå§‹åŒ–åŠ å¯†è´§å¸æ”¯ä»˜ç®¡ç†é¢æ¿
function initializeCryptoPaymentDashboard() {
    console.log('Initializing Crypto Payment Dashboard...');
    
    // è®¾ç½®æ”¯ä»˜è¡¨å•æäº¤äº‹ä»¶
    document.getElementById('paymentForm').addEventListener('submit', handlePaymentFormSubmit);
    
    // æ·»åŠ æµ®åŠ¨åŠ¨ç”»
    const cards = document.querySelectorAll('.stat-card, .currency-card');
    cards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
        card.classList.add('floating');
    });
}

// åŠ è½½åŠ å¯†è´§å¸ä»·æ ¼
async function loadCryptoPrices() {
    try {
        // æ¨¡æ‹ŸåŠ å¯†è´§å¸ä»·æ ¼æ•°æ®
        // å®é™…åº”ç”¨ä¸­åº”è¯¥ä»APIè·å–
        cryptoPrices = {
            BTC: { price: 113332, change: 2.45 },
            ETH: { price: 3678, change: -1.23 },
            USDC: { price: 1.00, change: 0.01 }
        };
        
        updatePriceDisplay();
    } catch (error) {
        console.error('Failed to load crypto prices:', error);
    }
}

// æ›´æ–°ä»·æ ¼æ˜¾ç¤º
function updatePriceDisplay() {
    Object.entries(cryptoPrices).forEach(([currency, data]) => {
        const priceElement = document.getElementById(`${currency.toLowerCase()}Price`);
        const changeElement = document.getElementById(`${currency.toLowerCase()}Change`);
        
        if (priceElement) {
            if (currency === 'USDC') {
                priceElement.textContent = `$${data.price.toFixed(2)}`;
            } else {
                priceElement.textContent = `$${data.price.toLocaleString()}`;
            }
        }
        
        if (changeElement) {
            const changeText = data.change >= 0 ? `+${data.change.toFixed(2)}%` : `${data.change.toFixed(2)}%`;
            changeElement.textContent = changeText;
            changeElement.className = `currency-change ${data.change >= 0 ? 'positive' : 'negative'}`;
        }
    });
}

// æ›´æ–°ä»·æ ¼ï¼ˆå®šæœŸè°ƒç”¨ï¼‰
function updatePrices() {
    // æ¨¡æ‹Ÿä»·æ ¼æ³¢åŠ¨
    Object.keys(cryptoPrices).forEach(currency => {
        if (currency !== 'USDC') {
            const currentPrice = cryptoPrices[currency].price;
            const fluctuation = (Math.random() - 0.5) * 0.02; // Â±1%çš„æ³¢åŠ¨
            cryptoPrices[currency].price = currentPrice * (1 + fluctuation);
            cryptoPrices[currency].change += fluctuation * 100;
        }
    });
    
    updatePriceDisplay();
}

// åŠ è½½æ”¯ä»˜ç»Ÿè®¡
async function loadPaymentStats() {
    try {
        // æ¨¡æ‹Ÿæ”¯ä»˜ç»Ÿè®¡æ•°æ®
        // å®é™…åº”ç”¨ä¸­åº”è¯¥ä»APIè·å–
        const stats = {
            total: 42,
            successful: 38,
            pending: 3,
            volume: 15678.90
        };
        
        document.getElementById('totalPayments').textContent = stats.total;
        document.getElementById('successfulPayments').textContent = stats.successful;
        document.getElementById('pendingPayments').textContent = stats.pending;
        document.getElementById('totalVolume').textContent = `$${stats.volume.toLocaleString()}`;
        
    } catch (error) {
        console.error('Failed to load payment stats:', error);
    }
}

// åŠ è½½æ”¯ä»˜å†å²
async function loadPaymentHistory() {
    try {
        const response = await fetch('/billing/payment-history', {
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                payments = data.payments || [];
                allPayments = [...payments];
            }
        } else {
            // å¦‚æœAPIä¸å¯ç”¨ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
            payments = generateMockPayments();
            allPayments = [...payments];
        }
        
        renderPaymentHistory();
        
    } catch (error) {
        console.error('Error loading payment history:', error);
        // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        payments = generateMockPayments();
        allPayments = [...payments];
        renderPaymentHistory();
    }
}

// ç”Ÿæˆæ¨¡æ‹Ÿæ”¯ä»˜æ•°æ®
function generateMockPayments() {
    return [
        {
            id: 1,
            amount: 0.00088,
            currency: 'BTC',
            status: 'COMPLETED',
            transaction_hash: '1a2b3c4d5e6f7g8h9i0j1k2l3m4n5o6p7q8r9s0t1u2v3w4x5y6z',
            created_at: new Date(Date.now() - 86400000).toISOString(),
            usd_amount: 100.00
        },
        {
            id: 2,
            amount: 0.027,
            currency: 'ETH',
            status: 'PENDING',
            transaction_hash: 'pending',
            created_at: new Date(Date.now() - 3600000).toISOString(),
            usd_amount: 99.45
        },
        {
            id: 3,
            amount: 250.00,
            currency: 'USDC',
            status: 'COMPLETED',
            transaction_hash: '9z8y7x6w5v4u3t2s1r0q9p8o7n6m5l4k3j2i1h0g9f8e7d6c5b4a',
            created_at: new Date(Date.now() - 172800000).toISOString(),
            usd_amount: 250.00
        }
    ];
}

// æ¸²æŸ“æ”¯ä»˜å†å²
function renderPaymentHistory() {
    const tbody = document.getElementById('paymentTableBody');
    tbody.innerHTML = '';
    
    if (payments.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    {% if current_lang == 'en' %}No payment history found{% else %}æœªæ‰¾åˆ°æ”¯ä»˜è®°å½•{% endif %}
                </td>
            </tr>
        `;
        return;
    }
    
    payments.forEach(payment => {
        const row = document.createElement('tr');
        const date = new Date(payment.created_at).toLocaleDateString();
        const statusClass = getPaymentStatusClass(payment.status);
        const statusText = getPaymentStatusText(payment.status);
        
        row.innerHTML = `
            <td>${date}</td>
            <td class="payment-amount">${payment.amount} ${payment.currency}<br>
                <small style="color: var(--text-secondary);">â‰ˆ $${(payment.usd_amount || 0).toFixed(2)}</small>
            </td>
            <td>
                <span style="font-weight: 600; color: var(--crypto-${payment.currency.toLowerCase()});">
                    ${payment.currency}
                </span>
            </td>
            <td>
                <span class="payment-status ${statusClass}">${statusText}</span>
            </td>
            <td>
                ${payment.transaction_hash !== 'pending' ? `
                    <span class="payment-hash" onclick="viewTransaction('${payment.transaction_hash}', '${payment.currency}')">
                        ${payment.transaction_hash.substring(0, 8)}...${payment.transaction_hash.substring(-6)}
                    </span>
                ` : '<span style="color: var(--text-secondary);">Pending</span>'}
            </td>
            <td>
                <button class="currency-btn" onclick="viewPaymentDetails(${payment.id})" style="padding: 0.5rem 1rem; font-size: 0.8rem;">
                    {% if current_lang == 'en' %}Details{% else %}è¯¦æƒ…{% endif %}
                </button>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// è·å–æ”¯ä»˜çŠ¶æ€æ ·å¼ç±»
function getPaymentStatusClass(status) {
    switch (status.toUpperCase()) {
        case 'COMPLETED': return 'completed';
        case 'PENDING': return 'pending';
        case 'FAILED': return 'failed';
        default: return 'pending';
    }
}

// è·å–æ”¯ä»˜çŠ¶æ€æ–‡æœ¬
function getPaymentStatusText(status) {
    const texts = {
        en: {
            'COMPLETED': 'Completed',
            'PENDING': 'Pending',
            'FAILED': 'Failed'
        },
        zh: {
            'COMPLETED': 'å·²å®Œæˆ',
            'PENDING': 'å¾…å¤„ç†',
            'FAILED': 'å¤±è´¥'
        }
    };
    
    const lang = '{{ current_lang }}' === 'en' ? 'en' : 'zh';
    return texts[lang][status.toUpperCase()] || texts[lang]['PENDING'];
}

// åŠ è½½é’±åŒ…ä½™é¢
async function loadWalletBalances() {
    try {
        // æ£€æŸ¥æ˜¯å¦è¿æ¥äº†Web3é’±åŒ…
        if (window.Web3Utils && typeof window.ethereum !== 'undefined') {
            const connectionStatus = await window.Web3Utils.checkWalletConnection();
            
            if (connectionStatus.connected) {
                // è·å–çœŸå®ä½™é¢
                await loadRealWalletBalances(connectionStatus.account);
            } else {
                // æ˜¾ç¤ºæ¨¡æ‹Ÿä½™é¢
                loadMockWalletBalances();
            }
        } else {
            // æ˜¾ç¤ºæ¨¡æ‹Ÿä½™é¢
            loadMockWalletBalances();
        }
    } catch (error) {
        console.error('Error loading wallet balances:', error);
        loadMockWalletBalances();
    }
}

// åŠ è½½çœŸå®é’±åŒ…ä½™é¢
async function loadRealWalletBalances(account) {
    try {
        if (window.Web3Utils && window.Web3Utils.getWeb3Instance()) {
            const web3 = window.Web3Utils.getWeb3Instance();
            
            // è·å–ETHä½™é¢
            const ethBalance = await web3.eth.getBalance(account);
            const ethBalanceEth = parseFloat(web3.utils.fromWei(ethBalance, 'ether'));
            
            walletBalances = {
                BTC: { amount: 0, usd: 0 }, // BTCéœ€è¦å…¶ä»–API
                ETH: { 
                    amount: ethBalanceEth, 
                    usd: ethBalanceEth * (cryptoPrices.ETH?.price || 3678)
                },
                USDC: { amount: 0, usd: 0 } // USDCéœ€è¦åˆçº¦è°ƒç”¨
            };
        }
        
        renderWalletBalances();
    } catch (error) {
        console.error('Error loading real wallet balances:', error);
        loadMockWalletBalances();
    }
}

// åŠ è½½æ¨¡æ‹Ÿé’±åŒ…ä½™é¢
function loadMockWalletBalances() {
    walletBalances = {
        BTC: { amount: 0.00123456, usd: 139.67 },
        ETH: { amount: 0.789, usd: 2903.14 },
        USDC: { amount: 1250.50, usd: 1250.50 }
    };
    
    renderWalletBalances();
}

// æ¸²æŸ“é’±åŒ…ä½™é¢
function renderWalletBalances() {
    const grid = document.getElementById('balanceGrid');
    grid.innerHTML = '';
    
    Object.entries(walletBalances).forEach(([currency, balance]) => {
        const card = document.createElement('div');
        card.className = 'balance-card';
        
        card.innerHTML = `
            <div class="balance-currency">${currency}</div>
            <div class="balance-amount">${balance.amount.toFixed(currency === 'USDC' ? 2 : 8)}</div>
            <div class="balance-usd">â‰ˆ $${balance.usd.toFixed(2)}</div>
        `;
        
        grid.appendChild(card);
    });
}

// ç­›é€‰æ”¯ä»˜è®°å½•
function filterPayments() {
    const statusFilter = document.getElementById('statusFilter').value;
    const currencyFilter = document.getElementById('currencyFilter').value;
    
    payments = allPayments.filter(payment => {
        const statusMatch = !statusFilter || payment.status === statusFilter;
        const currencyMatch = !currencyFilter || payment.currency === currencyFilter;
        return statusMatch && currencyMatch;
    });
    
    renderPaymentHistory();
}

// åˆ›å»ºæ–°æ”¯ä»˜
function createNewPayment() {
    document.getElementById('paymentForm').reset();
    document.getElementById('paymentAddressSection').style.display = 'none';
    $('#paymentModal').modal('show');
}

// åˆ›å»ºæŒ‡å®šå¸ç§çš„æ”¯ä»˜
function createPayment(currency) {
    document.getElementById('paymentForm').reset();
    document.getElementById('paymentCurrency').value = currency;
    document.getElementById('paymentAddressSection').style.display = 'none';
    $('#paymentModal').modal('show');
}

// å¤„ç†æ”¯ä»˜è¡¨å•æäº¤
async function handlePaymentFormSubmit(event) {
    event.preventDefault();
    
    const amount = parseFloat(document.getElementById('paymentAmount').value);
    const currency = document.getElementById('paymentCurrency').value;
    const purpose = document.getElementById('paymentPurpose').value;
    
    if (!amount || amount < 10) {
        alert('{% if current_lang == "en" %}Minimum payment amount is $10{% else %}æœ€å°æ”¯ä»˜é‡‘é¢ä¸º$10{% endif %}');
        return;
    }
    
    showLoading();
    
    try {
        // æ¨¡æ‹Ÿç”Ÿæˆæ”¯ä»˜åœ°å€
        const paymentData = await generatePaymentAddress(amount, currency, purpose);
        
        if (paymentData.success) {
            displayPaymentAddress(paymentData);
        } else {
            alert(paymentData.error || '{% if current_lang == "en" %}Failed to generate payment address{% else %}ç”Ÿæˆæ”¯ä»˜åœ°å€å¤±è´¥{% endif %}');
        }
    } catch (error) {
        console.error('Error creating payment:', error);
        alert('{% if current_lang == "en" %}Error creating payment{% else %}åˆ›å»ºæ”¯ä»˜æ—¶å‘ç”Ÿé”™è¯¯{% endif %}');
    } finally {
        hideLoading();
    }
}

// ç”Ÿæˆæ”¯ä»˜åœ°å€
async function generatePaymentAddress(amount, currency, purpose) {
    try {
        const response = await fetch('/billing/create-crypto-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                amount: amount,
                currency: 'USD',
                crypto_currency: currency,
                purpose: purpose
            })
        });
        
        if (response.ok) {
            return await response.json();
        } else {
            // å¦‚æœAPIä¸å¯ç”¨ï¼Œç”Ÿæˆæ¨¡æ‹Ÿåœ°å€
            return generateMockPaymentAddress(amount, currency);
        }
    } catch (error) {
        console.error('Error generating payment address:', error);
        return generateMockPaymentAddress(amount, currency);
    }
}

// ç”Ÿæˆæ¨¡æ‹Ÿæ”¯ä»˜åœ°å€
function generateMockPaymentAddress(amount, currency) {
    const addresses = {
        BTC: 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh',
        ETH: '0x742d35cc6cf7f9eb6c1f7e4b1a0a4c8e8b3f5d1a',
        USDC: '0x742d35cc6cf7f9eb6c1f7e4b1a0a4c8e8b3f5d1a'
    };
    
    return {
        success: true,
        payment_address: addresses[currency],
        amount: amount,
        currency: currency,
        expires_at: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString()
    };
}

// æ˜¾ç¤ºæ”¯ä»˜åœ°å€
function displayPaymentAddress(paymentData) {
    const addressSection = document.getElementById('paymentAddressSection');
    const addressElement = document.getElementById('paymentAddress');
    const qrElement = document.getElementById('paymentQR');
    
    addressElement.textContent = paymentData.payment_address;
    
    // ç”ŸæˆäºŒç»´ç 
    try {
        // ç®€å•çš„äºŒç»´ç æ˜¾ç¤ºï¼Œå®é™…åº”è¯¥ä½¿ç”¨QRåº“
        qrElement.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; color: #333; font-size: 0.8rem; text-align: center; padding: 1rem;">
                QR Code<br>
                ${paymentData.payment_address.substring(0, 8)}...
            </div>
        `;
    } catch (error) {
        console.error('Error generating QR code:', error);
    }
    
    addressSection.style.display = 'block';
}

// æ£€æŸ¥ä½™é¢
function checkBalances() {
    loadWalletBalances();
    alert('{% if current_lang == "en" %}Wallet balances refreshed{% else %}é’±åŒ…ä½™é¢å·²åˆ·æ–°{% endif %}');
}

// æŸ¥çœ‹æ”¯ä»˜å†å²
function viewPaymentHistory() {
    loadPaymentHistory();
    document.querySelector('.payment-history').scrollIntoView({ behavior: 'smooth' });
}

// ä¸‹è½½æ”¶æ®
function downloadReceipts() {
    alert('{% if current_lang == "en" %}Receipt download feature coming soon{% else %}æ”¶æ®ä¸‹è½½åŠŸèƒ½å³å°†æ¨å‡º{% endif %}');
}

// æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…
function viewTransaction(hash, currency) {
    const explorerUrls = {
        BTC: 'https://mempool.space/tx/',
        ETH: 'https://etherscan.io/tx/',
        USDC: 'https://etherscan.io/tx/'
    };
    
    const url = explorerUrls[currency] + hash;
    window.open(url, '_blank');
}

// æŸ¥çœ‹æ”¯ä»˜è¯¦æƒ…
function viewPaymentDetails(paymentId) {
    const payment = allPayments.find(p => p.id === paymentId);
    if (payment) {
        alert(`Payment Details:\nID: ${payment.id}\nAmount: ${payment.amount} ${payment.currency}\nStatus: ${payment.status}\nDate: ${new Date(payment.created_at).toLocaleString()}`);
    }
}

// å¤åˆ¶åˆ°å‰ªè´´æ¿
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        alert('{% if current_lang == "en" %}Address copied to clipboard{% else %}åœ°å€å·²å¤åˆ¶åˆ°å‰ªè´´æ¿{% endif %}');
    }).catch(err => {
        console.error('Failed to copy text: ', err);
    });
}

// æ˜¾ç¤º/éšè—åŠ è½½åŠ¨ç”»
function showLoading() {
    document.getElementById('loadingOverlay').style.display = 'flex';
}

function hideLoading() {
    document.getElementById('loadingOverlay').style.display = 'none';
}
</script>
{% endblock %}