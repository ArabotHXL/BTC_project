{% extends "hosting/hosting_base.html" %}

{% block page_title %}<span data-i18n="miner_management">Miner Management</span>{% endblock %}
{% block page_subtitle %}<span data-i18n="hosting.miner_management_subtitle">Professional mining device management with unified approval workflow</span>{% endblock %}

{% block header_actions %}
{{ super() }}
<div class="btn-group ms-3" role="group">
    <button class="btn btn-hosting-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMinerModal">
        <i class="bi bi-plus-circle me-1"></i><span data-i18n="add_miner">Add Miner</span>
    </button>
    <button class="btn btn-hosting-secondary btn-sm" onclick="refreshMiners()">
        <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="refresh">Refresh</span>
    </button>
    <a href="{{ url_for('hosting_service_bp.miner_setup_guide') }}" class="btn btn-info btn-sm" target="_blank">
        <i class="bi bi-book me-1"></i><span data-i18n="help_guide">Help Guide</span>
    </a>
</div>
{% endblock %}

{% block content %}

<!-- KPI卡片区 -->
<div class="row mb-4" id="kpi-cards">
    <div class="col-md-3 mb-3">
        <div class="kpi-card">
            <div class="kpi-icon">
                <i class="bi bi-cpu"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label" data-i18n="total_miners">Total Miners</div>
                <div class="kpi-value" id="kpi-total-miners">-</div>
                <div class="kpi-unit">&nbsp;</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #4ECDC4, #44A08D);">
                <i class="bi bi-speedometer2"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label" data-i18n="total_hashrate">Total Hashrate</div>
                <div class="kpi-value" id="kpi-total-hashrate">-</div>
                <div class="kpi-unit">PH/s</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #F7971E, #FFD200);">
                <i class="bi bi-lightning-charge"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label" data-i18n="power_efficiency">Power & Efficiency</div>
                <div class="kpi-value" id="kpi-total-power">-</div>
                <div class="kpi-subvalue" id="kpi-avg-efficiency">-</div>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="kpi-card">
            <div class="kpi-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <i class="bi bi-heart-pulse"></i>
            </div>
            <div class="kpi-content">
                <div class="kpi-label" data-i18n="device_health">Device Health</div>
                <div class="kpi-value" id="kpi-health-score">-</div>
                <div class="kpi-subvalue">
                    <span data-i18n="online_rate">Online Rate</span>: 
                    <span id="kpi-online-rate">-</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 加密控制中心 - 仅矿场主/管理员可见 -->
{% if session.get('role') in ['owner', 'admin', 'mining_site'] %}
<div class="hosting-card mb-4" id="encryption-control-center">
    <div class="hosting-card-header d-flex justify-content-between align-items-center cursor-pointer" 
         data-bs-toggle="collapse" data-bs-target="#encryptionBody" aria-expanded="false">
        <h6 class="hosting-card-title mb-0">
            <i class="bi bi-shield-lock me-2"></i><span data-i18n="hosting.encryption_control_center">Encryption Control Center</span>
            <span class="badge bg-warning ms-2" id="encryption-status-badge" data-i18n="hosting.not_configured">Not Configured</span>
        </h6>
        <i class="bi bi-chevron-down collapse-icon"></i>
    </div>
    <div class="collapse" id="encryptionBody">
        <div class="hosting-card-body">
            <div class="row">
                <!-- 左侧：状态信息 -->
                <div class="col-md-6">
                    <div class="encryption-status-panel p-3 rounded" style="background: rgba(247,147,26,0.1); border: 1px solid rgba(247,147,26,0.3);">
                        <h6 class="mb-3">
                            <i class="bi bi-info-circle me-2"></i><span data-i18n="hosting.encryption_status">Encryption Status</span>
                        </h6>
                        <div class="row">
                            <div class="col-6">
                                <div class="mb-2">
                                    <small class="text-muted" data-i18n="total_miners">Total Miners</small>
                                    <div class="fw-bold" id="enc-total-miners">-</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted" data-i18n="hosting.encrypted_miners">Encrypted Miners</small>
                                    <div class="fw-bold" id="enc-encrypted-miners">-</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="mb-2">
                                    <small class="text-muted" data-i18n="hosting.key_version">Key Version</small>
                                    <div class="fw-bold" id="enc-key-version">-</div>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted" data-i18n="hosting.unlock_status">Unlock Status</small>
                                    <div id="enc-unlock-status">
                                        <span class="badge bg-secondary" data-i18n="hosting.locked">Locked</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 进度条 -->
                        <div class="mt-3" id="enc-progress-container" style="display: none;">
                            <small class="text-muted" data-i18n="hosting.processing">Processing...</small>
                            <div class="progress mt-1" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" id="enc-progress-bar" 
                                     style="width: 0%">0%</div>
                            </div>
                            <small class="text-muted mt-1" id="enc-progress-text"></small>
                        </div>
                    </div>
                </div>
                <!-- 右侧：操作按钮 -->
                <div class="col-md-6">
                    <div class="p-3">
                        <h6 class="mb-3">
                            <i class="bi bi-gear me-2"></i><span data-i18n="quick_actions">Quick Actions</span>
                        </h6>
                        <!-- 首次设置密码 -->
                        <div id="enc-setup-section">
                            <p class="text-muted small mb-2" data-i18n="hosting.encryption_setup_desc">Set up a master passphrase to encrypt all miners' network data (IP/MAC addresses).</p>
                            <div class="input-group mb-2">
                                <span class="input-group-text"><i class="bi bi-key"></i></span>
                                <input type="password" class="form-control" id="enc-setup-passphrase" 
                                       data-i18n-placeholder="hosting.enter_master_passphrase" placeholder="Enter master passphrase (min 8 chars)">
                            </div>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-key-fill"></i></span>
                                <input type="password" class="form-control" id="enc-setup-confirm" 
                                       data-i18n-placeholder="hosting.confirm_passphrase" placeholder="Confirm passphrase">
                            </div>
                            <button class="btn btn-hosting-primary w-100" onclick="setupOwnerEncryption()">
                                <i class="bi bi-shield-lock me-2"></i><span data-i18n="hosting.setup_encrypt_all">Setup & Encrypt All</span>
                            </button>
                        </div>
                        <!-- 解锁操作 -->
                        <div id="enc-unlock-section" style="display: none;">
                            <p class="text-muted small mb-2" data-i18n="hosting.unlock_desc">Enter your master passphrase to unlock and view encrypted data.</p>
                            <div class="input-group mb-3">
                                <span class="input-group-text"><i class="bi bi-unlock"></i></span>
                                <input type="password" class="form-control" id="enc-unlock-passphrase" 
                                       data-i18n-placeholder="hosting.enter_master_passphrase_short" placeholder="Enter master passphrase">
                                <button class="btn btn-hosting-primary" onclick="unlockOwnerEncryption()">
                                    <i class="bi bi-unlock-fill"></i>
                                </button>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-outline-warning flex-fill" onclick="lockOwnerEncryption()">
                                    <i class="bi bi-lock me-1"></i><span data-i18n="hosting.lock">Lock</span>
                                </button>
                                <button class="btn btn-outline-danger flex-fill" onclick="rotateOwnerKey()">
                                    <i class="bi bi-arrow-repeat me-1"></i><span data-i18n="hosting.rotate_key">Rotate Key</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 操作按钮区 -->
<div class="d-flex justify-content-between gap-3 mb-4 flex-wrap">
    <div class="d-flex gap-2 flex-wrap">
        <button class="btn btn-hosting-primary" data-bs-toggle="modal" data-bs-target="#batchImportModal">
            <i class="bi bi-upload me-2"></i><span data-i18n="batch_import">Batch Import</span>
        </button>
        <button class="btn btn-hosting-secondary" onclick="showPendingOnly()">
            <i class="bi bi-clock me-2"></i><span data-i18n="pending_review">Pending Review</span>
            <span class="badge bg-warning text-dark ms-2" id="pending-count">0</span>
        </button>
    </div>
    <div class="d-flex gap-2 flex-wrap">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-warning dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" id="batch-ops-btn" disabled>
                <i class="bi bi-list-check me-1"></i><span data-i18n="batch_operations">Batch Operations</span>
                <span class="badge bg-light text-dark ms-1" id="selected-count">0</span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchApprove()">
                    <i class="bi bi-check-circle me-2"></i><span data-i18n="approve">Approve</span>
                </a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchStart()">
                    <i class="bi bi-play-circle me-2"></i><span data-i18n="start">Start</span>
                </a></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchShutdown()">
                    <i class="bi bi-stop-circle me-2"></i><span data-i18n="shutdown">Shutdown</span>
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchChangeStatus()">
                    <i class="bi bi-arrow-left-right me-2"></i><span data-i18n="change_status">Change Status</span>
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <!-- Remote Commands Submenu -->
                <li class="dropdown-submenu">
                    <a class="dropdown-item dropdown-toggle" href="javascript:void(0)" data-bs-toggle="dropdown">
                        <i class="bi bi-terminal me-2"></i><span data-i18n="hosting.remote_commands">Remote Commands</span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('change_pools')">
                            <i class="bi bi-shuffle me-2"></i><span data-i18n="hosting.change_pools">Change Pools</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('reboot')">
                            <i class="bi bi-arrow-clockwise me-2"></i><span data-i18n="hosting.reboot">Reboot</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('fetch_logs')">
                            <i class="bi bi-file-text me-2"></i><span data-i18n="hosting.fetch_logs">Fetch Logs</span>
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('power_mode')">
                            <i class="bi bi-lightning me-2"></i><span data-i18n="hosting.power_mode">Power Mode</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('power_target')">
                            <i class="bi bi-speedometer2 me-2"></i><span data-i18n="hosting.power_target">Power Target</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('overclock')">
                            <i class="bi bi-cpu me-2"></i><span data-i18n="hosting.overclock">Overclock</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('fan_mode')">
                            <i class="bi bi-fan me-2"></i><span data-i18n="hosting.fan_mode">Fan Mode</span>
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('static_ip')">
                            <i class="bi bi-ethernet me-2"></i><span data-i18n="hosting.assign_static_ip">Assign Static IP</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('change_password')">
                            <i class="bi bi-key me-2"></i><span data-i18n="hosting.change_password">Change Password</span>
                        </a></li>
                        <li><a class="dropdown-item" href="javascript:void(0)" onclick="batchRemoteCommand('blink_led')">
                            <i class="bi bi-lightbulb me-2"></i><span data-i18n="hosting.blink_leds">Blink LEDs</span>
                        </a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="batchRemoteCommand('factory_reset')">
                            <i class="bi bi-exclamation-triangle me-2"></i><span data-i18n="hosting.factory_reset">Factory Reset</span>
                        </a></li>
                    </ul>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="batchDelete()">
                    <i class="bi bi-trash me-2"></i><span data-i18n="delete">Delete</span>
                </a></li>
            </ul>
        </div>
        <button class="btn btn-success" onclick="exportCSV()">
            <i class="bi bi-download me-1"></i><span data-i18n="export_csv">Export CSV</span>
        </button>
    </div>
</div>

<!-- 筛选器 -->
<div class="hosting-card">
    <div class="hosting-card-header d-flex justify-content-between align-items-center">
        <h6 class="hosting-card-title mb-0">
            <i class="bi bi-funnel me-2"></i><span data-i18n="filter_options">Filter Options</span>
        </h6>
        <div class="input-group" style="width: 300px;">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" id="quickSearch" data-i18n-placeholder="hosting.search_serial_ip_rack" placeholder="Search Serial Number/IP/Rack...">
        </div>
    </div>
    <div class="hosting-card-body">
        <form class="row g-3" id="filter-form">
            <div class="col-md-3">
                <label for="status-filter" class="form-label" data-i18n="status">Status</label>
                <select class="form-select" id="status-filter" name="status">
                    <option value="" data-i18n="all_status">All Status</option>
                    <option value="active" data-i18n="running">Running</option>
                    <option value="offline" data-i18n="offline">Offline</option>
                    <option value="maintenance" data-i18n="maintenance">Maintenance</option>
                    <option value="error" data-i18n="error">Error</option>
                </select>
            </div>
            <div class="col-md-3">
                <label for="model-filter" class="form-label" data-i18n="miner_model">Miner Model</label>
                <select class="form-select" id="model-filter" name="model_id">
                    <option value="" data-i18n="hosting.all_models">All Models</option>
                    <!-- 动态加载矿机型号选项 -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="site-filter" class="form-label" data-i18n="site">Site</label>
                <select class="form-select" id="site-filter" name="site_id">
                    <option value="" data-i18n="all_sites">All Sites</option>
                    <!-- 动态加载站点选项 -->
                </select>
            </div>
            <div class="col-md-3">
                <label for="customer-filter" class="form-label" data-i18n="customer">Customer</label>
                <select class="form-select" id="customer-filter" name="customer_id">
                    <option value="" data-i18n="all_customers">All Customers</option>
                    <!-- 动态加载客户选项 -->
                </select>
            </div>
        </form>
    </div>
</div>

<!-- 矿机列表 -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-list me-2"></i><span data-i18n="miner_list">Miner List</span>
        </h5>
        <div class="d-flex gap-2 flex-wrap">
            <span class="badge bg-info" id="total-count"><span data-i18n="hosting.total">Total</span>: 0</span>
            <span class="badge bg-success" id="active-count"><span data-i18n="running">Running</span>: 0</span>
            <span class="badge bg-warning" id="pending-approval-count"><span data-i18n="pending">Pending</span>: 0</span>
        </div>
    </div>
    <div class="hosting-card-body">
        <div class="hosting-table">
            <table class="table table-hover" id="miners-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"><input type="checkbox" id="selectAll" class="form-check-input"></th>
                        <th class="sortable-header" data-sort="serial_number" onclick="toggleSort('serial_number')">
                            <span data-i18n="serial_number">Serial Number</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="evaluation_grade" onclick="toggleSort('evaluation_grade')">
                            <span data-i18n="grade">Grade</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="customer_email" onclick="toggleSort('customer_email')">
                            <span data-i18n="customer">Customer</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="miner_model" onclick="toggleSort('miner_model')">
                            <span data-i18n="miner_model">Miner Model</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="site_name" onclick="toggleSort('site_name')">
                            <span data-i18n="site">Site</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="actual_hashrate" onclick="toggleSort('actual_hashrate')">
                            <span data-i18n="hashrate">Hashrate</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="actual_power" onclick="toggleSort('actual_power')">
                            <span data-i18n="power">Power</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="daily_profit" onclick="toggleSort('daily_profit')">
                            <span data-i18n="daily_profit">Daily Profit</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th>CGMiner</th>
                        <th class="sortable-header" data-sort="temperature_avg" onclick="toggleSort('temperature_avg')">
                            <span data-i18n="temperature">Temperature</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="fan_avg" onclick="toggleSort('fan_avg')">
                            <span data-i18n="fan">Fan</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th class="sortable-header" data-sort="status" onclick="toggleSort('status')">
                            <span data-i18n="status">Status</span>
                            <i class="bi bi-arrow-down-up sort-icon ms-1"></i>
                        </th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据通过JavaScript加载 -->
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="Miner pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮通过JavaScript生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 添加矿机模态框 -->
<div class="modal fade" id="addMinerModal" tabindex="-1" aria-labelledby="addMinerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="addMinerModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span data-i18n="hosting.add_new_miner">Add New Miner</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addMinerForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="serial_number" class="form-label">
                                <span data-i18n="serial_number">Serial Number</span> <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="serial_number" name="serial_number" required>
                        </div>
                        <div class="col-md-6">
                            <label for="miner_model" class="form-label">
                                <span data-i18n="miner_model">Miner Model</span> <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="miner_model" name="miner_model" required>
                                <option value="" data-i18n="select_model">Select Model</option>
                                <option value="Antminer S19 Pro">Antminer S19 Pro</option>
                                <option value="Antminer S19j Pro">Antminer S19j Pro</option>
                                <option value="WhatsMiner M30S++">WhatsMiner M30S++</option>
                                <option value="WhatsMiner M31S+">WhatsMiner M31S+</option>
                                <option value="AvalonMiner 1246">AvalonMiner 1246</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="site_id" class="form-label">
                                <span data-i18n="site">Site</span> <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="site_id" name="site_id" required>
                                <option value="" data-i18n="select_site">Select Site</option>
                                <!-- 动态加载站点选项 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="customer_email" class="form-label">
                                <span data-i18n="hosting.customer_email">Customer Email</span> <span class="text-danger">*</span>
                            </label>
                            <input type="email" class="form-control" id="customer_email" name="customer_email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="ip_address" class="form-label" data-i18n="hosting.ip_address">IP Address</label>
                            <input type="text" class="form-control" id="ip_address" name="ip_address" placeholder="192.168.1.100">
                        </div>
                        <div class="col-md-6">
                            <label for="rack_position" class="form-label" data-i18n="hosting.rack_position">Rack Position</label>
                            <input type="text" class="form-control" id="rack_position" name="rack_position" placeholder="A-01-05">
                        </div>
                        <div class="col-12">
                            <label for="notes" class="form-label" data-i18n="notes">Notes</label>
                            <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="addMiner()" data-i18n="add_miner">Add Miner</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量导入模态框 -->
<div class="modal fade" id="batchImportModal" tabindex="-1" aria-labelledby="batchImportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="batchImportModalLabel">
                    <i class="bi bi-upload me-2"></i>
                    <span data-i18n="hosting.batch_import_miners">Batch Import Miners</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Link to Full Import Page with Field Documentation -->
                <div class="alert alert-warning border-warning mb-3">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-lightbulb-fill fs-4 me-3 text-warning"></i>
                        <div class="flex-grow-1">
                            <h6 class="alert-heading mb-2" data-i18n="hosting.need_field_requirements">Need detailed field requirements?</h6>
                            <p class="mb-2" data-i18n="hosting.field_requirements_desc">For complete hosting field documentation, required vs optional fields, and validation rules, visit our full import page.</p>
                            <a href="/batch/import" target="_blank" class="btn btn-sm btn-outline-warning">
                                <i class="bi bi-box-arrow-up-right me-1"></i>
                                <span data-i18n="hosting.open_full_import_page">Open Full Import Page</span>
                            </a>
                        </div>
                    </div>
                </div>
                
                <!-- Download Template Section -->
                <div class="alert alert-info d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="bi bi-info-circle me-2"></i>
                        <strong data-i18n="hosting.first_time">First time?</strong> <span data-i18n="hosting.download_template_desc">Download the CSV template to get started</span>
                    </div>
                    <div class="btn-group" role="group">
                        <a href="/batch/api/template/download?lang={{ current_lang }}&examples=true" class="btn btn-sm btn-outline-primary" download>
                            <i class="bi bi-download me-1"></i>
                            <span data-i18n="hosting.with_examples">With Examples</span>
                        </a>
                        <a href="/batch/api/template/download?lang={{ current_lang }}&examples=false" class="btn btn-sm btn-outline-secondary" download>
                            <i class="bi bi-file-earmark me-1"></i>
                            <span data-i18n="hosting.blank">Blank</span>
                        </a>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="batchFile" class="form-label" data-i18n="hosting.select_csv_file">Select CSV File</label>
                    <input type="file" class="form-control" id="batchFile" accept=".csv">
                    <div class="form-text" data-i18n="hosting.required_fields_desc">Required fields: Hashrate (TH/s), Power (W), Electricity Cost ($/kWh)</div>
                </div>
                <div id="importPreview" class="d-none">
                    <h6 data-i18n="hosting.import_preview">Import Preview:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm" id="previewTable">
                            <thead></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" id="confirmImport" disabled onclick="confirmBatchImport()" data-i18n="import">Import</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑矿机模态框 -->
<div class="modal fade" id="editMinerModal" tabindex="-1" aria-labelledby="editMinerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="editMinerModalLabel">
                    <i class="bi bi-pencil me-2"></i>
                    <span data-i18n="hosting.edit_miner">Edit Miner</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editMinerForm">
                    <input type="hidden" id="edit_miner_id" name="miner_id">
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="edit_serial_number" class="form-label" data-i18n="serial_number">Serial Number</label>
                            <input type="text" class="form-control" id="edit_serial_number" readonly>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_rack_position" class="form-label" data-i18n="hosting.rack_position">Rack Position</label>
                            <input type="text" class="form-control" id="edit_rack_position" name="rack_position">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_ip_address" class="form-label" data-i18n="hosting.ip_address">IP Address</label>
                            <input type="text" class="form-control" id="edit_ip_address" name="ip_address" placeholder="192.168.1.100">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_mac_address" class="form-label" data-i18n="hosting.mac_address">MAC Address</label>
                            <input type="text" class="form-control" id="edit_mac_address" name="mac_address" placeholder="00:1A:2B:3C:4D:5E">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_actual_hashrate" class="form-label" data-i18n="hosting.actual_hashrate">Actual Hashrate (TH/s)</label>
                            <input type="number" class="form-control" id="edit_actual_hashrate" name="actual_hashrate" step="0.01">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_actual_power" class="form-label" data-i18n="hosting.actual_power">Actual Power (W)</label>
                            <input type="number" class="form-control" id="edit_actual_power" name="actual_power" step="1">
                        </div>
                        
                        <div class="col-md-6">
                            <label for="edit_status" class="form-label" data-i18n="status">Status</label>
                            <select class="form-select" id="edit_status" name="status">
                                <option value="active" data-i18n="active">Active</option>
                                <option value="inactive" data-i18n="inactive">Inactive</option>
                                <option value="maintenance" data-i18n="maintenance">Maintenance</option>
                                <option value="offline" data-i18n="offline">Offline</option>
                            </select>
                        </div>
                    </div>
                    
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="saveMinerEdit()" data-i18n="save_changes">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- 批量操作确认Modal -->
<div class="modal fade" id="batchConfirmModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="batchConfirmTitle" data-i18n="hosting.confirm_batch_operation">Confirm Batch Operation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="batchConfirmMessage"></span>
                </div>
                <div id="batchConfirmList" class="mb-3"></div>
                <div id="batchNotesInput" class="d-none">
                    <label class="form-label" data-i18n="hosting.notes_optional">Notes (Optional)</label>
                    <textarea class="form-control" id="batchNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-warning" id="batchConfirmBtn" data-i18n="confirm">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- 快速修改状态Modal -->
<div class="modal fade" id="quickStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-info text-dark">
                <h5 class="modal-title" data-i18n="hosting.change_miner_status">Change Miner Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="quickStatusMinerId">
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.select_new_status">Select New Status</label>
                    <select class="form-select" id="quickStatusSelect">
                        <option value="active" data-i18n="hosting.active_running">Active (Running)</option>
                        <option value="offline" data-i18n="offline">Offline</option>
                        <option value="maintenance" data-i18n="maintenance">Maintenance</option>
                        <option value="error" data-i18n="error">Error</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.notes_optional">Notes (Optional)</label>
                    <textarea class="form-control" id="quickStatusNotes" rows="2"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-info" onclick="saveQuickStatus()" data-i18n="save">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- 操作日志Modal -->
<div class="modal fade" id="operationLogsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-secondary">
                <h5 class="modal-title" data-i18n="hosting.operation_logs">Operation Logs</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-sm table-dark table-hover">
                        <thead>
                            <tr>
                                <th data-i18n="time">Time</th>
                                <th data-i18n="hosting.operation">Operation</th>
                                <th data-i18n="hosting.old_status">Old Status</th>
                                <th data-i18n="hosting.new_status">New Status</th>
                                <th data-i18n="hosting.operator">Operator</th>
                                <th data-i18n="notes">Notes</th>
                            </tr>
                        </thead>
                        <tbody id="logsTableBody">
                            <tr><td colspan="6" class="text-center" data-i18n="loading">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
                <nav>
                    <ul class="pagination pagination-sm justify-content-center" id="logsPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Remote Command Modals -->

<!-- Change Pools Modal -->
<div class="modal fade" id="changePoolsModal" tabindex="-1" aria-labelledby="changePoolsModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="changePoolsModalLabel">
                    <i class="bi bi-shuffle me-2"></i>
                    <span data-i18n="hosting.change_mining_pools">Change Mining Pools</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changePoolsMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="hosting.pool_1_url">Pool 1 URL</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="pool1Url" placeholder="stratum+tcp://pool1.example.com:3333">
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.pool_2_url">Pool 2 URL</label>
                    <input type="text" class="form-control" id="pool2Url" placeholder="stratum+tcp://pool2.example.com:3333">
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.pool_3_url">Pool 3 URL</label>
                    <input type="text" class="form-control" id="pool3Url" placeholder="stratum+tcp://pool3.example.com:3333">
                </div>
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="hosting.worker_name">Worker Name</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="poolWorkerName" placeholder="worker001">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitChangePoolsCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Power Mode Modal -->
<div class="modal fade" id="powerModeModal" tabindex="-1" aria-labelledby="powerModeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="powerModeModalLabel">
                    <i class="bi bi-lightning me-2"></i>
                    <span data-i18n="hosting.set_power_mode">Set Power Mode</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="powerModeMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.power_mode">Power Mode</label>
                    <select class="form-select" id="powerModeSelect">
                        <option value="normal" data-i18n="hosting.normal">Normal</option>
                        <option value="low_power" data-i18n="hosting.low_power">Low Power</option>
                        <option value="high_performance" data-i18n="hosting.high_performance">High Performance</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitPowerModeCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Power Target Modal -->
<div class="modal fade" id="powerTargetModal" tabindex="-1" aria-labelledby="powerTargetModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="powerTargetModalLabel">
                    <i class="bi bi-speedometer2 me-2"></i>
                    <span data-i18n="hosting.set_power_target">Set Power Target</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="powerTargetMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.target_power_watts">Target Power (Watts)</label>
                    <input type="number" class="form-control" id="powerTargetWatts" placeholder="3000" min="500" max="5000">
                    <div class="form-text" data-i18n="hosting.power_target_desc">Enter target power consumption in watts (500-5000W)</div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitPowerTargetCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Overclock Modal -->
<div class="modal fade" id="overclockModal" tabindex="-1" aria-labelledby="overclockModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="overclockModalLabel">
                    <i class="bi bi-cpu me-2"></i>
                    <span data-i18n="hosting.overclock_settings">Overclock Settings</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span data-i18n="hosting.overclock_warning">Warning: Overclocking may void warranty and cause hardware damage. Proceed with caution.</span>
                </div>
                <input type="hidden" id="overclockMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.frequency_mhz">Frequency (MHz)</label>
                    <input type="range" class="form-range" id="overclockFreqSlider" min="400" max="800" value="500" oninput="document.getElementById('overclockFreqValue').value = this.value">
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">400 MHz</small>
                        <input type="number" class="form-control form-control-sm text-center" id="overclockFreqValue" value="500" style="width: 100px;" min="400" max="800" oninput="document.getElementById('overclockFreqSlider').value = this.value">
                        <small class="text-muted">800 MHz</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="submitOverclockCommand()" data-i18n="hosting.apply_overclock">Apply Overclock</button>
            </div>
        </div>
    </div>
</div>

<!-- Fan Mode Modal -->
<div class="modal fade" id="fanModeModal" tabindex="-1" aria-labelledby="fanModeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="fanModeModalLabel">
                    <i class="bi bi-fan me-2"></i>
                    <span data-i18n="hosting.fan_control_settings">Fan Control Settings</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="fanModeMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.fan_mode">Fan Mode</label>
                    <div class="btn-group w-100" role="group">
                        <input type="radio" class="btn-check" name="fanModeRadio" id="fanModeAuto" value="auto" checked onchange="toggleManualFanSpeed()">
                        <label class="btn btn-outline-primary" for="fanModeAuto" data-i18n="hosting.auto">Auto</label>
                        <input type="radio" class="btn-check" name="fanModeRadio" id="fanModeManual" value="manual" onchange="toggleManualFanSpeed()">
                        <label class="btn btn-outline-primary" for="fanModeManual" data-i18n="hosting.manual">Manual</label>
                    </div>
                </div>
                <div class="mb-3" id="manualFanSpeedSection" style="display: none;">
                    <label class="form-label" data-i18n="hosting.fan_speed_percent">Fan Speed (%)</label>
                    <input type="range" class="form-range" id="manualFanSpeedSlider" min="20" max="100" value="80" oninput="document.getElementById('manualFanSpeedValue').textContent = this.value + '%'">
                    <div class="text-center"><span id="manualFanSpeedValue">80%</span></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitFanModeCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Static IP Modal -->
<div class="modal fade" id="staticIpModal" tabindex="-1" aria-labelledby="staticIpModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="staticIpModalLabel">
                    <i class="bi bi-ethernet me-2"></i>
                    <span data-i18n="hosting.configure_static_ip">Configure Static IP</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="staticIpMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="hosting.ip_address">IP Address</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="staticIpAddress" placeholder="192.168.1.100">
                </div>
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="hosting.subnet_mask">Subnet Mask</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="staticSubnetMask" placeholder="255.255.255.0" value="255.255.255.0">
                </div>
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="hosting.gateway">Gateway</span> <span class="text-danger">*</span></label>
                    <input type="text" class="form-control" id="staticGateway" placeholder="192.168.1.1">
                </div>
                <div class="mb-3">
                    <label class="form-label" data-i18n="hosting.dns_server">DNS Server</label>
                    <input type="text" class="form-control" id="staticDns" placeholder="8.8.8.8" value="8.8.8.8">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitStaticIpCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- Change Password Modal -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="changePasswordModalLabel">
                    <i class="bi bi-key me-2"></i>
                    <span data-i18n="hosting.change_miner_password">Change Miner Password</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="changePasswordMinerIds" value="">
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="new_password">New Password</span> <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="minerNewPassword" data-i18n-placeholder="hosting.enter_new_password" placeholder="Enter new password">
                </div>
                <div class="mb-3">
                    <label class="form-label"><span data-i18n="confirm_password">Confirm Password</span> <span class="text-danger">*</span></label>
                    <input type="password" class="form-control" id="minerConfirmPassword" data-i18n-placeholder="hosting.confirm_new_password" placeholder="Confirm new password">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="submitChangePasswordCommand()" data-i18n="apply">Apply</button>
            </div>
        </div>
    </div>
</div>

<!-- CSS样式 -->
<style>
.kpi-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 12px;
    padding: 1.5rem;
    color: white;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    min-height: 120px;
    transition: transform 0.2s;
}

.kpi-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.2);
}

.kpi-icon {
    width: 60px;
    height: 60px;
    background: rgba(255,255,255,0.2);
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
}

.kpi-content {
    flex: 1;
}

.kpi-label {
    font-size: 0.85rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.kpi-value {
    font-size: 1.8rem;
    font-weight: 700;
    line-height: 1.2;
}

.kpi-unit {
    font-size: 0.9rem;
    opacity: 0.8;
}

.kpi-subvalue {
    font-size: 0.85rem;
    opacity: 0.85;
    margin-top: 0.25rem;
}

/* 加密控制中心样式 */
.cursor-pointer { cursor: pointer; }
.collapse-icon { transition: transform 0.3s ease; }
.hosting-card-header[aria-expanded="true"] .collapse-icon { transform: rotate(180deg); }
#encryption-control-center .hosting-card-header { border-bottom: none; }
#encryption-control-center .hosting-card-header[aria-expanded="true"] { border-bottom: 1px solid rgba(255,255,255,0.1); }

/* 可排序表头样式 */
.sortable-header {
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    transition: background-color 0.2s ease;
}
.sortable-header:hover {
    background-color: rgba(247, 147, 26, 0.15);
}
.sortable-header.active {
    background-color: rgba(247, 147, 26, 0.25);
    color: #f7931a;
}
.sortable-header .sort-icon {
    opacity: 0.4;
    font-size: 0.75rem;
    transition: opacity 0.2s, color 0.2s;
}
.sortable-header:hover .sort-icon {
    opacity: 0.7;
}
.sortable-header.active .sort-icon {
    opacity: 1;
    color: #f7931a;
}
.sortable-header.asc .sort-icon::before {
    content: "\F128";
}
.sortable-header.desc .sort-icon::before {
    content: "\F127";
}

/* Dropdown Submenu Styles for Bootstrap 5 */
.dropdown-submenu {
    position: relative;
}
.dropdown-submenu > .dropdown-menu {
    top: 0;
    left: 100%;
    margin-top: -6px;
    margin-left: -1px;
    display: none;
}
.dropdown-submenu:hover > .dropdown-menu,
.dropdown-submenu.show > .dropdown-menu {
    display: block;
}
/* Submenu opens left when near right edge */
.dropdown-submenu.dropdown-submenu-left > .dropdown-menu {
    left: auto;
    right: 100%;
    margin-left: 0;
    margin-right: -1px;
}
.dropdown-submenu > .dropdown-toggle::after {
    display: inline-block;
    margin-left: 0.5em;
    vertical-align: 0.1em;
    content: "";
    border-top: 0.3em solid transparent;
    border-right: 0;
    border-bottom: 0.3em solid transparent;
    border-left: 0.3em solid;
}
/* Flip arrow for left-opening submenu */
.dropdown-submenu.dropdown-submenu-left > .dropdown-toggle::after {
    border-left: 0;
    border-right: 0.3em solid;
    margin-left: 0;
    margin-right: 0.5em;
    float: left;
}
.dropdown-submenu:hover > a.dropdown-item {
    background-color: rgba(247, 147, 26, 0.15);
}
/* Per-row actions dropdown styling */
.miner-actions-dropdown .dropdown-menu {
    min-width: 200px;
    max-height: 400px;
    overflow-y: auto;
    background-color: #1a1a2e;
    border: 1px solid rgba(247, 147, 26, 0.3);
}
/* Auto-position dropdown to stay within viewport */
.miner-actions-dropdown.dropstart .dropdown-menu {
    right: 100%;
    left: auto;
}
/* Ensure dropdown stays within table container */
.hosting-table {
    position: relative;
    overflow-x: auto;
}
.hosting-table .dropdown-menu {
    position: fixed;
    z-index: 1050;
}
.miner-actions-dropdown .dropdown-item {
    color: #e0e0e0;
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
}
.miner-actions-dropdown .dropdown-item:hover {
    background-color: rgba(247, 147, 26, 0.15);
    color: #f7931a;
}
.miner-actions-dropdown .dropdown-item.text-danger:hover {
    background-color: rgba(220, 53, 69, 0.15);
    color: #dc3545;
}
.miner-actions-dropdown .dropdown-divider {
    border-color: rgba(255, 255, 255, 0.1);
}
</style>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 先初始化checkbox事件监听器（只需要初始化一次）
    if (typeof initCheckboxes === 'function') {
        initCheckboxes();
    }
    
    loadMiners();
    loadSitesForDropdown();
    loadCustomersForDropdown();
    loadModelsForDropdown();
    setupFilterForm();
    setupBatchImport();
});

let currentPage = 1;
const perPage = 20;
let currentSortBy = '';
let currentSortDir = '';

function toggleSort(field) {
    if (currentSortBy === field) {
        if (currentSortDir === 'asc') {
            currentSortDir = 'desc';
        } else if (currentSortDir === 'desc') {
            currentSortBy = '';
            currentSortDir = '';
        } else {
            currentSortDir = 'asc';
        }
    } else {
        currentSortBy = field;
        currentSortDir = 'asc';
    }
    
    updateSortHeaders();
    loadMiners(1, getCurrentFilters());
}

function updateSortHeaders() {
    document.querySelectorAll('.sortable-header').forEach(th => {
        th.classList.remove('active', 'asc', 'desc');
        const icon = th.querySelector('.sort-icon');
        if (icon) {
            icon.className = 'bi bi-arrow-down-up sort-icon ms-1';
        }
    });
    
    if (currentSortBy) {
        const activeHeader = document.querySelector(`.sortable-header[data-sort="${currentSortBy}"]`);
        if (activeHeader) {
            activeHeader.classList.add('active', currentSortDir);
            const icon = activeHeader.querySelector('.sort-icon');
            if (icon) {
                icon.className = currentSortDir === 'asc' 
                    ? 'bi bi-sort-up sort-icon ms-1' 
                    : 'bi bi-sort-down sort-icon ms-1';
            }
        }
    }
}

function getCurrentFilters() {
    const filters = {};
    const status = document.getElementById('status-filter')?.value;
    const siteId = document.getElementById('site-filter')?.value;
    const customerId = document.getElementById('customer-filter')?.value;
    const modelId = document.getElementById('model-filter')?.value;
    if (status) filters.status = status;
    if (siteId) filters.site_id = siteId;
    if (customerId) filters.customer_id = customerId;
    if (modelId) filters.model_id = modelId;
    return filters;
}

function loadMiners(page = 1, filters = {}) {
    const sortParams = {};
    if (currentSortBy) {
        sortParams.sort_by = currentSortBy;
        sortParams.sort_dir = currentSortDir || 'asc';
    }
    
    const queryParams = new URLSearchParams({
        page: page,
        per_page: perPage,
        ...filters,
        ...sortParams
    });
    
    return fetch(`/hosting/api/miners?${queryParams}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayMiners(data.miners || []);
                updateCounts(data.counts || {total: 0, active: 0, pending: 0});
                if (typeof updatePagination === 'function') {
                    updatePagination(data.pagination || {});
                }
            } else {
                console.error('API returned error:', data.error);
                displayMiners([]);
                updateCounts({total: 0, active: 0, pending: 0});
            }
        })
        .catch(error => {
            console.error('Error loading miners:', error.message || error);
            displayMiners([]);
            updateCounts({total: 0, active: 0, pending: 0});
        });
}

function displayMiners(miners) {
    const tbody = document.querySelector('#miners-table tbody');
    if (!tbody) {
        console.error('Miners table body not found');
        return;
    }
    
    tbody.innerHTML = '';
    
    if (!miners || miners.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="14" class="text-center text-muted py-4">
                    <i class="bi bi-cpu fs-1 mb-2 d-block"></i>
                    <span data-i18n="hosting.no_miners_found">${getLanguage() === 'en' ? 'No miners found' : '未找到矿机'}</span>
                </td>
            </tr>
        `;
        if (window.I18n) {
            I18n.updatePageTranslations();
        }
        return;
    }
    
    miners.forEach(miner => {
        const telemetry = miner.telemetry || {live: false};
        const hasLiveTelemetry = telemetry.live === true;
        
        const cgminerOnline = hasLiveTelemetry ? telemetry.online : (miner.cgminer_online || false);
        const tempAvg = hasLiveTelemetry && telemetry.temperature_avg ? telemetry.temperature_avg : (miner.temperature_avg || null);
        const tempMax = hasLiveTelemetry && telemetry.temperature_max ? telemetry.temperature_max : (miner.temperature_max || null);
        const fanAvg = hasLiveTelemetry && telemetry.fan_speeds?.length ? 
            telemetry.fan_speeds.reduce((a, b) => a + b, 0) / telemetry.fan_speeds.length : (miner.fan_avg || null);
        const lastSeen = hasLiveTelemetry && telemetry.last_seen ? telemetry.last_seen : (miner.last_seen || null);
        const liveHashrate = hasLiveTelemetry ? telemetry.hashrate_ths : null;
        const livePower = hasLiveTelemetry && telemetry.power_consumption ? telemetry.power_consumption : null;
        
        // Format CGMiner online status with live indicator
        const liveIndicator = hasLiveTelemetry ? '<span class="badge bg-success ms-1" style="font-size:0.6rem;">LIVE</span>' : '';
        const cgminerStatus = cgminerOnline 
            ? '<i class="bi bi-wifi text-success fs-5" title="' + (getLanguage() === 'en' ? 'Online' : '在线') + '"></i>' + liveIndicator
            : '<i class="bi bi-wifi-off text-danger fs-5" title="' + (getLanguage() === 'en' ? 'Offline' : '离线') + '"></i>';
        
        // Format temperature with color coding
        let tempDisplay = '-';
        let tempClass = '';
        if (tempAvg !== null && tempMax !== null) {
            tempClass = tempMax > 85 ? 'text-danger' : (tempMax > 75 ? 'text-warning' : '');
            const tempVal = typeof tempAvg === 'number' ? tempAvg.toFixed(1) : tempAvg;
            const tempMaxVal = typeof tempMax === 'number' ? tempMax.toFixed(1) : tempMax;
            tempDisplay = `<span class="${tempClass}" title="${getLanguage() === 'en' ? 'Avg / Max' : '平均 / 最高'}">${tempVal}°C / ${tempMaxVal}°C</span>`;
        }
        
        // Format fan speed
        const fanDisplay = fanAvg !== null ? `${Math.round(fanAvg)} RPM` : '-';
        
        // Format last seen time
        let lastSeenDisplay = '-';
        if (lastSeen) {
            const timeAgo = getTimeAgo(lastSeen);
            lastSeenDisplay = `<small class="text-muted" title="${lastSeen}">${timeAgo}</small>`;
        }
        
        // Format alert badge
        let alertBadge = '';
        if (miner.alerts && miner.alerts.has_alerts && miner.alerts.count > 0) {
            const hasCritical = miner.alerts.alerts.some(a => a.severity === 'critical');
            const badgeColor = hasCritical ? 'danger' : 'warning';
            const alertMessages = miner.alerts.alerts.map(a => a.message).join(', ');
            alertBadge = `
                <span class="badge bg-${badgeColor} ms-2" 
                      data-bs-toggle="tooltip" 
                      data-bs-placement="top"
                      title="${alertMessages}">
                    <i class="bi bi-exclamation-triangle"></i> ${miner.alerts.count}
                </span>`;
        }
        
        // Format evaluation grade badge
        const grade = miner.evaluation_grade || '-';
        const gradeColors = {
            'A': 'success',
            'B': 'info', 
            'C': 'warning',
            'D': 'secondary',
            'F': 'danger'
        };
        const gradeColor = gradeColors[grade] || 'secondary';
        const gradeScore = miner.evaluation_score ? miner.evaluation_score.toFixed(0) : '-';
        const gradeDisplay = grade !== '-' 
            ? `<span class="badge bg-${gradeColor} fs-6" data-bs-toggle="tooltip" title="${getLanguage() === 'en' ? 'Score: ' : '评分: '}${gradeScore}">${grade}</span>`
            : '<span class="badge bg-secondary">-</span>';
        
        // Format daily profit
        const dailyProfit = miner.daily_net_profit;
        let profitDisplay = '-';
        if (dailyProfit !== null && dailyProfit !== undefined) {
            const profitColor = dailyProfit >= 0 ? 'text-success' : 'text-danger';
            const profitSign = dailyProfit >= 0 ? '+' : '';
            profitDisplay = `<span class="${profitColor}">${profitSign}$${Math.abs(dailyProfit).toFixed(2)}</span>`;
        }
        
        const row = `
            <tr id="miner-row-${miner.id}">
                <td><input type="checkbox" class="form-check-input miner-checkbox" value="${miner.id}"></td>
                <td><strong>${miner.serial_number}</strong>${alertBadge}</td>
                <td class="text-center">${gradeDisplay}</td>
                <td>${miner.customer_email || '-'}</td>
                <td>${miner.miner_model_name || '-'}</td>
                <td>${miner.site_name || '-'}</td>
                <td>${liveHashrate !== null ? liveHashrate : (miner.actual_hashrate || '-')} TH/s${hasLiveTelemetry && liveHashrate ? ' <i class="bi bi-broadcast text-success" style="font-size:0.7rem;"></i>' : ''}</td>
                <td>${livePower !== null ? livePower : (miner.actual_power || '-')} W${hasLiveTelemetry && livePower ? ' <i class="bi bi-broadcast text-success" style="font-size:0.7rem;"></i>' : ''}</td>
                <td>${profitDisplay}</td>
                <td class="text-center">${cgminerStatus}<br>${lastSeenDisplay}</td>
                <td>${tempDisplay}</td>
                <td>${fanDisplay}</td>
                <td><span class="badge bg-${getStatusColor(miner.status)}">${getStatusText(miner.status)}</span></td>
                <td>
                    <div class="dropdown miner-actions-dropdown">
                        <button class="btn btn-hosting-outline btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="/hosting/miner/${miner.id}/detail">
                                <i class="bi bi-graph-up me-2"></i>${getLanguage() === 'en' ? 'Details' : '详情'}
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="editMiner(${miner.id})">
                                <i class="bi bi-gear me-2"></i>${getLanguage() === 'en' ? 'Settings' : '设置'}
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="testMinerConnection(${miner.id})">
                                <i class="bi bi-activity me-2"></i>${getLanguage() === 'en' ? 'Test Connection' : '测试连接'}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="openTicketForMiner(${miner.id})">
                                <i class="bi bi-ticket-detailed me-2"></i>${getLanguage() === 'en' ? 'Open Ticket' : '创建工单'}
                            </a></li>
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="viewMinerTickets(${miner.id})">
                                <i class="bi bi-list-task me-2"></i>${getLanguage() === 'en' ? 'View Tickets' : '查看工单'}
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li class="dropdown-submenu">
                                <a class="dropdown-item dropdown-toggle" href="javascript:void(0)">
                                    <i class="bi bi-terminal me-2"></i>${getLanguage() === 'en' ? 'Remote Commands' : '远程命令'}
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'change_pools')">
                                        <i class="bi bi-shuffle me-2"></i>${getLanguage() === 'en' ? 'Change Pools' : '更换矿池'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'reboot')">
                                        <i class="bi bi-arrow-clockwise me-2"></i>${getLanguage() === 'en' ? 'Reboot' : '重启'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'fetch_logs')">
                                        <i class="bi bi-file-text me-2"></i>${getLanguage() === 'en' ? 'Fetch Logs' : '获取日志'}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'power_mode')">
                                        <i class="bi bi-lightning me-2"></i>${getLanguage() === 'en' ? 'Power Mode' : '电源模式'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'power_target')">
                                        <i class="bi bi-speedometer2 me-2"></i>${getLanguage() === 'en' ? 'Power Target' : '功率目标'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'overclock')">
                                        <i class="bi bi-cpu me-2"></i>${getLanguage() === 'en' ? 'Overclock' : '超频'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'fan_mode')">
                                        <i class="bi bi-fan me-2"></i>${getLanguage() === 'en' ? 'Fan Mode' : '风扇模式'}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'static_ip')">
                                        <i class="bi bi-ethernet me-2"></i>${getLanguage() === 'en' ? 'Static IP' : '静态IP'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'change_password')">
                                        <i class="bi bi-key me-2"></i>${getLanguage() === 'en' ? 'Password' : '密码'}
                                    </a></li>
                                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'blink_led')">
                                        <i class="bi bi-lightbulb me-2"></i>${getLanguage() === 'en' ? 'Blink LEDs' : '闪烁LED'}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="singleRemoteCommand(${miner.id}, 'factory_reset')">
                                        <i class="bi bi-exclamation-triangle me-2"></i>${getLanguage() === 'en' ? 'Factory Reset' : '恢复出厂'}
                                    </a></li>
                                </ul>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            ${miner.status === 'active' ? `
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleMinerStatus(${miner.id}, 'disable')">
                                <i class="bi bi-pause-circle me-2"></i>${getLanguage() === 'en' ? 'Disable' : '禁用'}
                            </a></li>` : `
                            <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleMinerStatus(${miner.id}, 'enable')">
                                <i class="bi bi-play-circle me-2"></i>${getLanguage() === 'en' ? 'Enable' : '启用'}
                            </a></li>`}
                            <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteMiner(${miner.id})">
                                <i class="bi bi-trash me-2"></i>${getLanguage() === 'en' ? 'Delete' : '删除'}
                            </a></li>
                            ${miner.approval_status === 'pending_approval' ? `
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-success" href="javascript:void(0)" onclick="approveMiner(${miner.id})">
                                <i class="bi bi-check-circle me-2"></i>${getLanguage() === 'en' ? 'Approve' : '批准'}
                            </a></li>
                            <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="rejectMiner(${miner.id})">
                                <i class="bi bi-x-circle me-2"></i>${getLanguage() === 'en' ? 'Reject' : '拒绝'}
                            </a></li>` : ''}
                        </ul>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    
    initializeTooltips();
    
    if (window.I18n) {
        I18n.updatePageTranslations();
    }
}

function initializeTooltips() {
    const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
}

function updateCounts(counts) {
    const totalCountEl = document.querySelector('[data-stat="total"]');
    const activeCountEl = document.querySelector('[data-stat="running"]');
    const pendingCountEl = document.querySelector('[data-stat="pending"]');
    
    // 更新数据统计显示
    if (totalCountEl) totalCountEl.textContent = counts.total || 0;
    if (activeCountEl) activeCountEl.textContent = counts.active || 0;
    if (pendingCountEl) pendingCountEl.textContent = counts.pending || 0;
    
    // 更新顶部显示区域
    const totalDisplay = document.getElementById('total-count');
    const activeDisplay = document.getElementById('active-count');
    const pendingDisplay = document.getElementById('pending-count');
    
    if (totalDisplay) totalDisplay.textContent = `${getLanguage() === 'en' ? 'Total:' : '总计:'} ${counts.total || 0}`;
    if (activeDisplay) activeDisplay.textContent = `${getLanguage() === 'en' ? 'Running:' : '运行:'} ${counts.active || 0}`;
    if (pendingDisplay) pendingDisplay.textContent = `${getLanguage() === 'en' ? 'Pending:' : '待审核:'} ${counts.pending || 0}`;
}

function updatePagination(pagination) {
    const paginationEl = document.getElementById('pagination');
    if (!paginationEl || !pagination) return;
    
    const { page, pages, total, has_prev, has_next } = pagination;
    const lang = getLanguage();
    
    // 清空现有分页
    paginationEl.innerHTML = '';
    
    if (pages <= 1) return; // 只有1页时不显示分页
    
    // 首页按钮
    const firstLi = document.createElement('li');
    firstLi.className = `page-item ${!has_prev ? 'disabled' : ''}`;
    firstLi.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(1)">${lang === 'en' ? 'First' : '首页'}</a>`;
    paginationEl.appendChild(firstLi);
    
    // 上一页按钮
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${!has_prev ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${page - 1})">&laquo;</a>`;
    paginationEl.appendChild(prevLi);
    
    // 智能页码显示策略 - 确保总是显示至少5个页码（如果总页数>=5）
    const delta = 2; // 当前页左右各显示2个页码
    const range = [];
    const minVisible = 5; // 最少显示5个页码
    
    if (pages <= minVisible + 2) {
        // 总页数少，显示所有页码
        for (let i = 1; i <= pages; i++) {
            range.push(i);
        }
    } else {
        // 计算显示窗口
        let start, end;
        
        if (page <= delta + 1) {
            // 靠近开始：显示 [1,2,3,4,5,...,pages]
            start = 1;
            end = minVisible;
        } else if (page >= pages - delta) {
            // 靠近结束：显示 [1,...,pages-4,pages-3,pages-2,pages-1,pages]
            start = pages - minVisible + 1;
            end = pages;
        } else {
            // 中间：显示 [1,...,page-2,page-1,page,page+1,page+2,...,pages]
            start = page - delta;
            end = page + delta;
        }
        
        // 添加第一页（如果不在窗口内）
        if (start > 1) {
            range.push(1);
        }
        
        // 添加窗口内的页码
        for (let i = start; i <= end; i++) {
            if (i > 1 && i < pages) {
                range.push(i);
            } else if (i === 1 || i === pages) {
                if (!range.includes(i)) {
                    range.push(i);
                }
            }
        }
        
        // 添加最后一页（如果不在窗口内）
        if (end < pages && !range.includes(pages)) {
            range.push(pages);
        }
        
        // 排序（确保页码按顺序）
        range.sort((a, b) => a - b);
    }
    
    // 渲染页码
    let lastPage = 0;
    range.forEach(i => {
        // 如果页码不连续，添加省略号
        if (lastPage && i > lastPage + 1) {
            const ellipsisLi = document.createElement('li');
            ellipsisLi.className = 'page-item disabled';
            ellipsisLi.innerHTML = '<span class="page-link">...</span>';
            paginationEl.appendChild(ellipsisLi);
        }
        
        // 添加页码按钮
        const li = document.createElement('li');
        li.className = `page-item ${i === page ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${i})">${i}</a>`;
        paginationEl.appendChild(li);
        
        lastPage = i;
    });
    
    // 下一页按钮
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${!has_next ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${page + 1})">&raquo;</a>`;
    paginationEl.appendChild(nextLi);
    
    // 末页按钮
    const lastLi = document.createElement('li');
    lastLi.className = `page-item ${!has_next ? 'disabled' : ''}`;
    lastLi.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="goToPage(${pages})">${lang === 'en' ? 'Last' : '末页'}</a>`;
    paginationEl.appendChild(lastLi);
    
    // 添加页面信息和跳转输入框
    const infoLi = document.createElement('li');
    infoLi.className = 'page-item disabled ms-2';
    infoLi.innerHTML = `<span class="page-link">${lang === 'en' ? `Page ${page}/${pages} (Total: ${total})` : `第 ${page}/${pages} 页 (共 ${total} 条)`}</span>`;
    paginationEl.appendChild(infoLi);
    
    // 页面跳转输入框
    const jumpLi = document.createElement('li');
    jumpLi.className = 'page-item ms-2';
    jumpLi.innerHTML = `
        <div class="input-group input-group-sm" style="width: 150px;">
            <input type="number" class="form-control" id="jumpToPage" placeholder="${lang === 'en' ? 'Jump to' : '跳转'}" min="1" max="${pages}">
            <button class="btn btn-outline-secondary" type="button" onclick="jumpToPage(${pages})">${lang === 'en' ? 'Go' : '跳转'}</button>
        </div>
    `;
    paginationEl.appendChild(jumpLi);
}

// 跳转到指定页
function goToPage(pageNum) {
    // 严格验证页码
    const num = parseInt(pageNum);
    if (isNaN(num) || num < 1) return;
    
    // 动态获取最大页数（从当前分页数据）
    const paginationData = window.currentPaginationData || { pages: 301 };
    const maxPages = paginationData.pages || 301;
    
    if (num > maxPages) return;
    
    currentPage = num;
    const filters = getFilters();
    loadMiners(currentPage, filters);
}

// 输入框跳转
function jumpToPage(maxPages) {
    const input = document.getElementById('jumpToPage');
    const pageNum = parseInt(input.value);
    
    if (!input.value.trim()) {
        alert(getLanguage() === 'en' ? 'Please enter a page number' : '请输入页码');
        return;
    }
    
    if (isNaN(pageNum) || pageNum < 1 || pageNum > maxPages) {
        alert(getLanguage() === 'en' ? `Please enter a valid page number (1-${maxPages})` : `请输入有效的页码 (1-${maxPages})`);
        input.value = '';
        return;
    }
    
    goToPage(pageNum);
    input.value = '';
}

function refreshMiners() {
    const filters = getFilters();
    loadMiners(currentPage, filters);
}

function setupFilterForm() {
    const form = document.getElementById('filter-form');
    form.addEventListener('change', function() {
        const filters = getFilters();
        currentPage = 1;
        loadMiners(currentPage, filters);
    });
}

function getFilters() {
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const filters = {};
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            filters[key] = value;
        }
    }
    
    return filters;
}

function loadSitesForDropdown() {
    fetch('/hosting/api/sites')
        .then(response => response.json())
        .then(data => {
            const siteFilter = document.getElementById('site-filter');
            const siteSelect = document.getElementById('site_id');
            
            if (data.success && data.sites) {
                data.sites.forEach(site => {
                    const option = `<option value="${site.id}">${site.name}</option>`;
                    if (siteFilter) siteFilter.insertAdjacentHTML('beforeend', option);
                    if (siteSelect) siteSelect.insertAdjacentHTML('beforeend', option);
                });
            }
        });
}

function loadCustomersForDropdown() {
    fetch('/hosting/api/customers')
        .then(response => response.json())
        .then(data => {
            const customerFilter = document.getElementById('customer-filter');
            
            if (data.success && data.customers && customerFilter) {
                data.customers.forEach(customer => {
                    const displayName = customer.name || customer.email;
                    const option = `<option value="${customer.id}">${displayName}</option>`;
                    customerFilter.insertAdjacentHTML('beforeend', option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading customers:', error);
        });
}

function loadModelsForDropdown() {
    fetch('/hosting/api/miner-models')
        .then(response => response.json())
        .then(data => {
            const modelFilter = document.getElementById('model-filter');
            
            if (data.success && data.models && modelFilter) {
                data.models.forEach(model => {
                    const option = `<option value="${model.id}">${model.model_name}</option>`;
                    modelFilter.insertAdjacentHTML('beforeend', option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading miner models:', error);
        });
}

function addMiner() {
    const form = document.getElementById('addMinerForm');
    const formData = new FormData(form);
    
    fetch('/hosting/api/miners/create', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addMinerModal')).hide();
            form.reset();
            refreshMiners();
            showToast(getLanguage() === 'en' ? 'Miner added successfully' : '矿机添加成功', 'success');
        } else {
            showToast(data.message || (getLanguage() === 'en' ? 'Error adding miner' : '添加矿机失败'), 'error');
        }
    })
    .catch(error => {
        console.error('Error adding miner:', error);
        showToast(getLanguage() === 'en' ? 'Error adding miner' : '添加矿机失败', 'error');
    });
}

function getStatusColor(status) {
    const colorMap = {
        'active': 'success',
        'offline': 'danger',
        'maintenance': 'warning',
        'error': 'danger'
    };
    return colorMap[status] || 'secondary';
}

function getApprovalColor(approval) {
    const colorMap = {
        'draft': 'secondary',
        'pending_approval': 'warning',
        'approved': 'success',
        'rejected': 'danger'
    };
    return colorMap[approval] || 'secondary';
}

function getStatusText(status) {
    if (window.I18n && I18n.initialized) {
        const translated = I18n.t('hosting.status.' + status);
        if (translated !== 'hosting.status.' + status) {
            return translated;
        }
    }
    const language = getLanguage();
    const statusMap = {
        'active': language === 'en' ? 'Running' : '运行中',
        'offline': language === 'en' ? 'Offline' : '离线',
        'maintenance': language === 'en' ? 'Maintenance' : '维护中',
        'error': language === 'en' ? 'Error' : '故障'
    };
    return statusMap[status] || status;
}

function getApprovalText(approval) {
    if (window.I18n && I18n.initialized) {
        const translated = I18n.t('hosting.approval.' + approval);
        if (translated !== 'hosting.approval.' + approval) {
            return translated;
        }
    }
    const language = getLanguage();
    const approvalMap = {
        'draft': language === 'en' ? 'Draft' : '草稿',
        'pending_approval': language === 'en' ? 'Pending' : '待审核',
        'approved': language === 'en' ? 'Approved' : '已通过',
        'rejected': language === 'en' ? 'Rejected' : '已拒绝'
    };
    return approvalMap[approval] || approval;
}

function getLanguage() {
    if (window.I18n && I18n.initialized) {
        return I18n.getLang();
    }
    return document.querySelector('meta[name="language"]').content;
}

function showToast(message, type = 'info') {
    // Enhanced toast notification with proper Bootstrap toast display
    let bgColor = 'bg-secondary';
    let icon = 'bi-info-circle';
    
    // Map type to Bootstrap colors and icons
    if (type === 'success') {
        bgColor = 'bg-success';
        icon = 'bi-check-circle';
    } else if (type === 'error' || type === 'danger') {
        bgColor = 'bg-danger';
        icon = 'bi-exclamation-circle';
    } else if (type === 'warning') {
        bgColor = 'bg-warning text-dark';
        icon = 'bi-exclamation-triangle';
    } else if (type === 'info') {
        bgColor = 'bg-info text-dark';
        icon = 'bi-info-circle';
    }
    
    const toastHtml = `
        <div class="toast align-items-center text-white ${bgColor} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="bi ${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close ${type === 'warning' || type === 'info' ? '' : 'btn-close-white'} me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `;
    
    // Get or create toast container
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        document.body.appendChild(toastContainer);
    }
    
    // Add toast to container
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    const toastElement = toastContainer.lastElementChild;
    
    // Initialize and show toast
    const toast = new bootstrap.Toast(toastElement, {
        autohide: true,
        delay: type === 'error' || type === 'danger' ? 5000 : 3000
    });
    toast.show();
    
    // Remove toast element after it's hidden
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}

// Test CGMiner connection
async function testMinerConnection(minerId) {
    const lang = getLanguage();
    const button = event.target.closest('button');
    const originalHtml = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="bi bi-hourglass-split"></i>';
    
    try {
        const response = await fetch(`/hosting/api/miners/${minerId}/test-connection`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(
                lang === 'en' 
                    ? 'Connection test successful! Refreshing data...' 
                    : '连接测试成功！正在刷新数据...',
                'success'
            );
            
            // Auto-refresh the miner row data
            setTimeout(() => refreshMinerData(minerId), 500);
        } else {
            showToast(
                lang === 'en' 
                    ? `Connection test failed: ${data.message || 'Unknown error'}` 
                    : `连接测试失败：${data.message || '未知错误'}`,
                'error'
            );
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        showToast(
            lang === 'en' 
                ? 'Error testing connection' 
                : '测试连接时出错',
            'error'
        );
    } finally {
        button.disabled = false;
        button.innerHTML = originalHtml;
    }
}

// Refresh individual miner data
async function refreshMinerData(minerId) {
    const lang = getLanguage();
    
    try {
        const response = await fetch(`/hosting/api/miners/${minerId}`);
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (data.success && data.miner) {
            // Update the specific row with new data
            updateMinerRow(data.miner);
            showToast(
                lang === 'en' 
                    ? 'Miner data refreshed successfully' 
                    : '矿机数据已刷新',
                'success'
            );
        } else {
            throw new Error(data.message || 'Failed to fetch miner data');
        }
    } catch (error) {
        console.error('Error refreshing miner data:', error);
        showToast(
            lang === 'en' 
                ? 'Error refreshing miner data' 
                : '刷新矿机数据时出错',
            'error'
        );
    }
}

// Update a single miner row with fresh data
function updateMinerRow(miner) {
    const row = document.getElementById(`miner-row-${miner.id}`);
    if (!row) {
        console.warn(`Row not found for miner ${miner.id}`);
        return;
    }
    
    const cgminerOnline = miner.cgminer_online || false;
    const tempAvg = miner.temperature_avg || null;
    const tempMax = miner.temperature_max || null;
    const fanAvg = miner.fan_avg || null;
    const hashrate5s = miner.hashrate_5s || null;
    const lastSeen = miner.last_seen || null;
    
    // Format CGMiner online status
    const cgminerStatus = cgminerOnline 
        ? '<i class="bi bi-wifi text-success fs-5" title="' + (getLanguage() === 'en' ? 'Online' : '在线') + '"></i>'
        : '<i class="bi bi-wifi-off text-danger fs-5" title="' + (getLanguage() === 'en' ? 'Offline' : '离线') + '"></i>';
    
    // Format temperature with color coding
    let tempDisplay = '-';
    let tempClass = '';
    if (tempAvg !== null && tempMax !== null) {
        tempClass = tempMax > 85 ? 'text-danger' : (tempMax > 75 ? 'text-warning' : '');
        tempDisplay = `<span class="${tempClass}" title="${getLanguage() === 'en' ? 'Avg / Max' : '平均 / 最高'}">${tempAvg.toFixed(1)}°C / ${tempMax.toFixed(1)}°C</span>`;
    }
    
    // Format fan speed
    const fanDisplay = fanAvg !== null ? `${Math.round(fanAvg)} RPM` : '-';
    
    // Format 5s hashrate
    const hashrate5sDisplay = hashrate5s !== null ? `${hashrate5s.toFixed(1)} TH/s` : '-';
    
    // Format last seen time
    let lastSeenDisplay = '-';
    if (lastSeen) {
        const timeAgo = getTimeAgo(lastSeen);
        lastSeenDisplay = `<small class="text-muted" title="${lastSeen}">${timeAgo}</small>`;
    }
    
    // Update cells (skip first 6 columns that don't change frequently)
    const cells = row.querySelectorAll('td');
    if (cells.length >= 13) {
        cells[6].innerHTML = `<div class="text-center">${cgminerStatus}<br>${lastSeenDisplay}</div>`;
        cells[7].innerHTML = tempDisplay;
        cells[8].innerHTML = fanDisplay;
        cells[9].innerHTML = hashrate5sDisplay;
        cells[10].innerHTML = `<span class="badge bg-${getStatusColor(miner.status)}">${getStatusText(miner.status)}</span>`;
    }
    
    // Add a brief highlight effect
    row.classList.add('table-active');
    setTimeout(() => row.classList.remove('table-active'), 1000);
}

// Get human-readable time ago
function getTimeAgo(dateString) {
    if (!dateString) return '-';
    
    const lang = getLanguage();
    const now = new Date();
    const past = new Date(dateString);
    const diffMs = now - past;
    const diffSecs = Math.floor(diffMs / 1000);
    const diffMins = Math.floor(diffSecs / 60);
    const diffHours = Math.floor(diffMins / 60);
    const diffDays = Math.floor(diffHours / 24);
    
    if (diffSecs < 60) {
        return lang === 'en' ? 'just now' : '刚刚';
    } else if (diffMins < 60) {
        return lang === 'en' ? `${diffMins} min ago` : `${diffMins}分钟前`;
    } else if (diffHours < 24) {
        return lang === 'en' ? `${diffHours} hour${diffHours > 1 ? 's' : ''} ago` : `${diffHours}小时前`;
    } else if (diffDays < 7) {
        return lang === 'en' ? `${diffDays} day${diffDays > 1 ? 's' : ''} ago` : `${diffDays}天前`;
    } else {
        return lang === 'en' ? past.toLocaleDateString('en-US') : past.toLocaleDateString('zh-CN');
    }
}

// 批量导入相关函数
function setupBatchImport() {
    const fileInput = document.getElementById('batchFile');
    fileInput.addEventListener('change', handleFileSelect);
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file && file.type === 'text/csv') {
        const reader = new FileReader();
        reader.onload = function(e) {
            const csv = e.target.result;
            const data = parseCSV(csv);
            showImportPreview(data);
        };
        reader.readAsText(file);
    }
}

function parseCSV(csv) {
    const lines = csv.split('\n');
    const headers = lines[0].split(',');
    const data = [];
    
    for (let i = 1; i < lines.length; i++) {
        if (lines[i].trim()) {
            const values = lines[i].split(',');
            const row = {};
            headers.forEach((header, index) => {
                row[header.trim()] = values[index] ? values[index].trim() : '';
            });
            data.push(row);
        }
    }
    
    return { headers, data };
}

function showImportPreview(csvData) {
    const preview = document.getElementById('importPreview');
    const table = document.getElementById('previewTable');
    
    // 创建表头
    const thead = table.querySelector('thead');
    thead.innerHTML = '<tr>' + csvData.headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
    
    // 显示前5行数据作为预览
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';
    csvData.data.slice(0, 5).forEach(row => {
        const tr = document.createElement('tr');
        csvData.headers.forEach(header => {
            const td = document.createElement('td');
            td.textContent = row[header] || '';
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
    
    preview.classList.remove('d-none');
    document.getElementById('confirmImport').disabled = false;
}

function confirmBatchImport() {
    const file = document.getElementById('batchFile').files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    
    fetch('/batch/api/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('batchImportModal')).hide();
            refreshMiners();
            showToast(`${getLanguage() === 'en' ? 'Successfully imported' : '成功导入'} ${data.imported_count || data.imported || 0} ${getLanguage() === 'en' ? 'miners' : '台矿机'}`, 'success');
        } else {
            showToast(data.error || data.message || (getLanguage() === 'en' ? 'Import failed' : '导入失败'), 'error');
        }
    })
    .catch(error => {
        console.error('Error importing miners:', error);
        showToast(getLanguage() === 'en' ? 'Import failed' : '导入失败', 'error');
    });
}

// 添加缺失的 showPendingOnly 函数
function showPendingOnly() {
    const pendingFilter = document.getElementById('approvalFilter');
    if (pendingFilter) {
        pendingFilter.value = 'pending_approval';
        filterMiners();
    }
}

// 查看矿机详情
function viewMiner(minerId) {
    fetch(`/hosting/api/miners/${minerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.miner) {
                const miner = data.miner;
                const lang = getLanguage();
                const title = lang === 'en' ? 'Miner Details' : '矿机详情';
                const content = `
                    <div class="row g-3">
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Serial Number' : '序列号'}:</strong> ${miner.serial_number}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Status' : '状态'}:</strong> <span class="badge bg-${getStatusColor(miner.status)}">${getStatusText(miner.status)}</span></div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Model' : '型号'}:</strong> ${miner.miner_model_name || '-'}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Site' : '站点'}:</strong> ${miner.site_name || '-'}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Customer' : '客户'}:</strong> ${miner.customer_email || '-'}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Hashrate' : '算力'}:</strong> ${miner.actual_hashrate || '-'} TH/s</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Power' : '功耗'}:</strong> ${miner.actual_power || '-'} W</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Rack Position' : '机架位置'}:</strong> ${miner.rack_position || '-'}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'IP Address' : 'IP地址'}:</strong> ${miner.ip_address || '-'}</div>
                        <div class="col-md-6"><strong>${lang === 'en' ? 'Approval' : '审核状态'}:</strong> <span class="badge bg-${getApprovalColor(miner.approval_status)}">${getApprovalText(miner.approval_status)}</span></div>
                    </div>
                `;
                showModalDialog(title, content);
            } else {
                showToast(data.error || (lang === 'en' ? 'Failed to load miner details' : '加载矿机详情失败'), 'error');
            }
        })
        .catch(error => {
            console.error('Error loading miner:', error);
            const lang = getLanguage();
            showToast(lang === 'en' ? 'Failed to load miner details' : '加载矿机详情失败', 'error');
        });
}

// 编辑矿机
function editMiner(minerId) {
    fetch(`/hosting/api/miners/${minerId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.miner) {
                const miner = data.miner;
                const lang = getLanguage();
                
                document.getElementById('edit_miner_id').value = miner.id;
                document.getElementById('edit_serial_number').value = miner.serial_number || '';
                document.getElementById('edit_rack_position').value = miner.rack_position || '';
                document.getElementById('edit_actual_hashrate').value = miner.actual_hashrate || '';
                document.getElementById('edit_actual_power').value = miner.actual_power || '';
                document.getElementById('edit_status').value = miner.status || 'active';
                
                const isOwnerEncrypted = miner.encryption_scope === 'owner';
                const hasCachedKey = window.MinerE2EE && window.MinerE2EE.isCacheValid();
                
                if (miner.has_encrypted_ip || miner.has_encrypted_mac) {
                    if (isOwnerEncrypted && hasCachedKey) {
                        const cachedData = getDecryptedNetworkData(miner.id);
                        document.getElementById('edit_ip_address').value = cachedData.ip || '';
                        document.getElementById('edit_mac_address').value = cachedData.mac || '';
                        document.getElementById('edit_ip_address').placeholder = lang === 'en' ? 'IP Address' : 'IP地址';
                        document.getElementById('edit_mac_address').placeholder = lang === 'en' ? 'MAC Address' : 'MAC地址';
                    } else if (isOwnerEncrypted) {
                        document.getElementById('edit_ip_address').placeholder = lang === 'en' ? 'Unlock in Control Center to view' : '请在加密控制中心解锁以查看';
                        document.getElementById('edit_mac_address').placeholder = lang === 'en' ? 'Unlock in Control Center to view' : '请在加密控制中心解锁以查看';
                        document.getElementById('edit_ip_address').value = '********';
                        document.getElementById('edit_mac_address').value = '**:**:**:**:**:**';
                    } else {
                        document.getElementById('edit_ip_address').value = miner.ip_address || '';
                        document.getElementById('edit_mac_address').value = miner.mac_address || '';
                    }
                } else {
                    document.getElementById('edit_ip_address').value = miner.ip_address || '';
                    document.getElementById('edit_mac_address').value = miner.mac_address || '';
                }
                
                const editModal = document.getElementById('editMinerModal');
                if (editModal) {
                    new bootstrap.Modal(editModal).show();
                } else {
                    showToast(lang === 'en' ? 'Edit modal not found. Please contact administrator.' : '编辑模态框未找到，请联系管理员。', 'warning');
                }
            } else {
                const lang = getLanguage();
                showToast(data.error || (lang === 'en' ? 'Failed to load miner data' : '加载矿机数据失败'), 'error');
            }
        })
        .catch(error => {
            console.error('Error loading miner for edit:', error);
            const lang = getLanguage();
            showToast(lang === 'en' ? 'Failed to load miner data' : '加载矿机数据失败', 'error');
        });
}

async function saveMinerEdit() {
    const minerId = document.getElementById('edit_miner_id').value;
    const ipAddress = document.getElementById('edit_ip_address').value;
    const macAddress = document.getElementById('edit_mac_address').value;
    const lang = getLanguage();
    
    let formData = {
        rack_position: document.getElementById('edit_rack_position').value,
        actual_hashrate: parseFloat(document.getElementById('edit_actual_hashrate').value) || null,
        actual_power: parseInt(document.getElementById('edit_actual_power').value) || null,
        status: document.getElementById('edit_status').value
    };
    
    if (ipAddress !== '********') {
        formData.ip_address = ipAddress;
    }
    if (macAddress !== '**:**:**:**:**:**') {
        formData.mac_address = macAddress;
    }
    
    try {
        const response = await fetch(`/hosting/api/miners/${minerId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast(data.message || (lang === 'en' ? 'Miner updated successfully' : '矿机更新成功'), 'success');
            const editModal = bootstrap.Modal.getInstance(document.getElementById('editMinerModal'));
            if (editModal) editModal.hide();
            refreshMiners();
        } else {
            showToast(data.error || (lang === 'en' ? 'Failed to update miner' : '更新矿机失败'), 'error');
        }
    } catch (error) {
        console.error('Error updating miner:', error);
        showToast(lang === 'en' ? 'Failed to update miner' : '更新矿机失败', 'error');
    }
}

// 通用模态对话框
function showModalDialog(title, content) {
    const modalHtml = `
        <div class="modal fade" id="dynamicModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content bg-dark">
                    <div class="modal-header">
                        <h5 class="modal-title">${title}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">${content}</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${getLanguage() === 'en' ? 'Close' : '关闭'}</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除旧的动态模态框
    const oldModal = document.getElementById('dynamicModal');
    if (oldModal) oldModal.remove();
    
    // 添加新模态框
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('dynamicModal'));
    modal.show();
    
    // 关闭后移除DOM
    document.getElementById('dynamicModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
    });
}

// ========== Phase 3: 设备管理升级 JavaScript ==========

// 全局状态
let selectedMiners = [];

// 加载KPI统计数据
async function loadKPIStats() {
    try {
        const siteId = document.getElementById('site-filter').value;
        const url = siteId ? `/hosting/api/miners/stats?site_id=${siteId}` : '/hosting/api/miners/stats';
        
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success) {
            const data = result.data;
            document.getElementById('kpi-total-miners').textContent = data.total_miners || 0;
            document.getElementById('kpi-total-hashrate').textContent = data.total_hashrate_ph || '0.00';
            document.getElementById('kpi-total-power').textContent = `${data.total_power_mw || '0.00'} MW`;
            document.getElementById('kpi-avg-efficiency').textContent = `${data.avg_efficiency_w_th || '0'} W/TH`;
            document.getElementById('kpi-health-score').textContent = `${data.avg_health_score || '100'}%`;
            document.getElementById('kpi-online-rate').textContent = `${data.online_rate || '0'}%`;
        }
    } catch (error) {
        console.error('加载KPI统计失败:', error);
    }
}

// 初始化复选框事件 - 使用事件委托处理动态加载的checkbox
// 标记是否已初始化，防止重复绑定事件监听器
let checkboxesInitialized = false;

function initCheckboxes() {
    if (checkboxesInitialized) {
        // 已初始化，只需重置选中状态
        document.getElementById('selectAll').checked = false;
        selectedMiners = [];
        updateSelectedMiners();
        return;
    }
    
    // selectAll checkbox直接绑定
    const selectAllCheckbox = document.getElementById('selectAll');
    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            const isChecked = this.checked;
            const checkboxes = document.querySelectorAll('#miners-table tbody .miner-checkbox');
            console.log('SelectAll clicked, found', checkboxes.length, 'checkboxes, setting to:', isChecked);
            checkboxes.forEach(cb => {
                cb.checked = isChecked;
            });
            updateSelectedMiners();
        });
    }
    
    // 使用事件委托：在表格上监听，处理动态加载的checkbox
    const minersTable = document.getElementById('miners-table');
    if (minersTable) {
        minersTable.addEventListener('change', function(e) {
            if (e.target && e.target.classList.contains('miner-checkbox')) {
                updateSelectedMiners();
            }
        });
    }
    
    checkboxesInitialized = true;
}

// 更新选中的矿机列表
function updateSelectedMiners() {
    selectedMiners = Array.from(document.querySelectorAll('.miner-checkbox:checked')).map(cb => parseInt(cb.value));
    
    // 更新选中计数显示
    document.getElementById('selected-count').textContent = selectedMiners.length;
    
    // 启用/禁用批量操作按钮
    const batchOpsBtn = document.getElementById('batch-ops-btn');
    if (selectedMiners.length > 0) {
        batchOpsBtn.disabled = false;
    } else {
        batchOpsBtn.disabled = true;
    }
    
    // 更新全选checkbox状态
    const allCheckboxes = document.querySelectorAll('.miner-checkbox');
    const checkedCount = document.querySelectorAll('.miner-checkbox:checked').length;
    const selectAllCheckbox = document.getElementById('selectAll');
    
    if (checkedCount === 0) {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = false;
    } else if (checkedCount === allCheckboxes.length) {
        selectAllCheckbox.checked = true;
        selectAllCheckbox.indeterminate = false;
    } else {
        selectAllCheckbox.checked = false;
        selectAllCheckbox.indeterminate = true;
    }
}

// 搜索防抖函数
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func(...args), wait);
    };
}

// 设置快速搜索
function setupQuickSearch() {
    const quickSearch = document.getElementById('quickSearch');
    const debouncedSearch = debounce(function(query) {
        const filters = getFilters();
        filters.search = query;
        currentPage = 1;
        loadMiners(currentPage, filters);
    }, 300);
    
    quickSearch.addEventListener('input', (e) => {
        debouncedSearch(e.target.value);
    });
}

// 批量审核通过
async function batchApprove() {
    if (selectedMiners.length === 0) {
        showToast(getLanguage() === 'en' ? 'Please select miners first' : '请先选择矿机', 'warning');
        return;
    }
    
    showBatchConfirmModal(
        getLanguage() === 'en' ? 'Batch Approve Miners' : '批量审核通过',
        getLanguage() === 'en' ? 
            `You are about to approve ${selectedMiners.length} miners. Continue?` : 
            `您即将审核通过 ${selectedMiners.length} 台矿机，是否继续？`,
        selectedMiners,
        true,
        async (notes) => {
            const response = await fetch('/hosting/api/miners/batch-approve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({miner_ids: selectedMiners, approval_notes: notes})
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message || (getLanguage() === 'en' ? 'Batch approve successful' : '批量审核成功'), 'success');
                refreshMiners();
                loadKPIStats();
            } else {
                showToast(result.error, 'error');
            }
        }
    );
}

// 批量启动 - 发送命令到边缘采集器
async function batchStart() {
    if (selectedMiners.length === 0) {
        showToast(getLanguage() === 'en' ? 'Please select miners first' : '请先选择矿机', 'warning');
        return;
    }
    
    showBatchConfirmModal(
        getLanguage() === 'en' ? 'Batch Start Miners' : '批量启动矿机',
        getLanguage() === 'en' ? 
            `You are about to start ${selectedMiners.length} miners. Continue?` : 
            `您即将启动 ${selectedMiners.length} 台矿机，是否继续？`,
        selectedMiners,
        false,
        async () => {
            const response = await fetch('/hosting/api/miners/batch-start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({miner_ids: selectedMiners})
            });
            const result = await response.json();
            if (result.success) {
                let msg = result.message || (getLanguage() === 'en' ? 'Batch start successful' : '批量启动成功');
                if (result.commands_queued > 0) {
                    msg += getLanguage() === 'en' 
                        ? ` (${result.commands_queued} commands sent to edge collector)` 
                        : ` (${result.commands_queued}条命令已发送到边缘采集器)`;
                }
                if (result.skipped_no_collector > 0) {
                    msg += getLanguage() === 'en'
                        ? ` (${result.skipped_no_collector} skipped - no collector)`
                        : ` (${result.skipped_no_collector}台跳过 - 无采集器)`;
                }
                showToast(msg, 'success');
                refreshMiners();
                loadKPIStats();
            } else {
                if (result.skipped_no_collector > 0) {
                    showToast(getLanguage() === 'en'
                        ? `${result.skipped_no_collector} miners have no edge collector. Control operations require an active collector.`
                        : `${result.skipped_no_collector}台矿机无边缘采集器。控制操作需要活跃的采集器。`, 'error');
                } else {
                    showToast(result.error, 'error');
                }
            }
        }
    );
}

// 批量关闭 - 发送命令到边缘采集器
async function batchShutdown() {
    if (selectedMiners.length === 0) {
        showToast(getLanguage() === 'en' ? 'Please select miners first' : '请先选择矿机', 'warning');
        return;
    }
    
    showBatchConfirmModal(
        getLanguage() === 'en' ? 'Batch Shutdown Miners' : '批量关闭矿机',
        getLanguage() === 'en' ? 
            `You are about to shutdown ${selectedMiners.length} miners. Continue?` : 
            `您即将关闭 ${selectedMiners.length} 台矿机，是否继续？`,
        selectedMiners,
        false,
        async () => {
            const response = await fetch('/hosting/api/miners/batch-shutdown', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({miner_ids: selectedMiners})
            });
            const result = await response.json();
            if (result.success) {
                let msg = result.message || (getLanguage() === 'en' ? 'Batch shutdown successful' : '批量关闭成功');
                if (result.commands_queued > 0) {
                    msg += getLanguage() === 'en' 
                        ? ` (${result.commands_queued} commands sent to edge collector)` 
                        : ` (${result.commands_queued}条命令已发送到边缘采集器)`;
                }
                if (result.skipped_no_collector > 0) {
                    msg += getLanguage() === 'en'
                        ? ` (${result.skipped_no_collector} skipped - no collector)`
                        : ` (${result.skipped_no_collector}台跳过 - 无采集器)`;
                }
                showToast(msg, 'success');
                refreshMiners();
                loadKPIStats();
            } else {
                if (result.skipped_no_collector > 0) {
                    showToast(getLanguage() === 'en'
                        ? `${result.skipped_no_collector} miners have no edge collector. Control operations require an active collector.`
                        : `${result.skipped_no_collector}台矿机无边缘采集器。控制操作需要活跃的采集器。`, 'error');
                } else {
                    showToast(result.error, 'error');
                }
            }
        }
    );
}

// 批量修改状态
async function batchChangeStatus() {
    if (selectedMiners.length === 0) {
        showToast(getLanguage() === 'en' ? 'Please select miners first' : '请先选择矿机', 'warning');
        return;
    }
    
    // 显示快速修改状态Modal，但用于批量操作
    const modal = new bootstrap.Modal(document.getElementById('quickStatusModal'));
    document.getElementById('quickStatusMinerId').value = JSON.stringify(selectedMiners);
    modal.show();
}

// 批量删除
async function batchDelete() {
    if (selectedMiners.length === 0) {
        showToast(getLanguage() === 'en' ? 'Please select miners first' : '请先选择矿机', 'warning');
        return;
    }
    
    showBatchConfirmModal(
        getLanguage() === 'en' ? 'Batch Delete Miners' : '批量删除矿机',
        getLanguage() === 'en' ? 
            `WARNING: You are about to DELETE ${selectedMiners.length} miners. This action cannot be undone!` : 
            `警告：您即将删除 ${selectedMiners.length} 台矿机，此操作无法撤销！`,
        selectedMiners,
        false,
        async () => {
            const response = await fetch('/hosting/api/miners/batch-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({miner_ids: selectedMiners})
            });
            const result = await response.json();
            if (result.success) {
                showToast(result.message || (getLanguage() === 'en' ? 'Batch delete successful' : '批量删除成功'), 'success');
                refreshMiners();
                loadKPIStats();
            } else {
                showToast(result.error, 'error');
            }
        }
    );
}

// 显示批量操作确认Modal
function showBatchConfirmModal(title, message, minerIds, showNotes, onConfirm) {
    const modal = new bootstrap.Modal(document.getElementById('batchConfirmModal'));
    document.getElementById('batchConfirmTitle').textContent = title;
    document.getElementById('batchConfirmMessage').textContent = message;
    
    // 显示选中的矿机列表
    const listHTML = `<div class="alert alert-info"><strong>${getLanguage() === 'en' ? 'Selected miners:' : '已选择的矿机：'}</strong> ${minerIds.length} ${getLanguage() === 'en' ? 'items' : '项'}</div>`;
    document.getElementById('batchConfirmList').innerHTML = listHTML;
    
    // 是否显示备注输入框
    const notesInput = document.getElementById('batchNotesInput');
    if (showNotes) {
        notesInput.classList.remove('d-none');
    } else {
        notesInput.classList.add('d-none');
    }
    
    // 绑定确认按钮
    const confirmBtn = document.getElementById('batchConfirmBtn');
    confirmBtn.onclick = async () => {
        const notes = showNotes ? document.getElementById('batchNotes').value : '';
        modal.hide();
        await onConfirm(notes);
    };
    
    modal.show();
}

// 单机启动 - 发送命令到边缘采集器
async function startMiner(minerId) {
    const response = await fetch(`/hosting/api/miners/${minerId}/start`, {method: 'POST'});
    const result = await response.json();
    if (result.success) {
        let msg = getLanguage() === 'en' ? 'Miner started successfully' : '矿机启动成功';
        if (result.command_queued) {
            msg += getLanguage() === 'en' ? ' (Command sent to edge collector)' : ' (命令已发送到边缘采集器)';
        }
        showToast(msg, 'success');
        refreshMiners();
        loadKPIStats();
    } else {
        if (result.collector_available === false) {
            showToast(getLanguage() === 'en' 
                ? 'No edge collector available. Control operations require an active collector.' 
                : '无边缘采集器。控制操作需要活跃的采集器。', 'error');
        } else {
            showToast(result.error, 'error');
        }
    }
}

// 单机关闭 - 发送命令到边缘采集器
async function shutdownMiner(minerId) {
    const response = await fetch(`/hosting/api/miners/${minerId}/shutdown`, {method: 'POST'});
    const result = await response.json();
    if (result.success) {
        let msg = getLanguage() === 'en' ? 'Miner shutdown successfully' : '矿机关闭成功';
        if (result.command_queued) {
            msg += getLanguage() === 'en' ? ' (Command sent to edge collector)' : ' (命令已发送到边缘采集器)';
        }
        showToast(msg, 'success');
        refreshMiners();
        loadKPIStats();
    } else {
        if (result.collector_available === false) {
            showToast(getLanguage() === 'en' 
                ? 'No edge collector available. Control operations require an active collector.' 
                : '无边缘采集器。控制操作需要活跃的采集器。', 'error');
        } else {
            showToast(result.error, 'error');
        }
    }
}

// 单机重启 - 发送命令到边缘采集器
async function restartMiner(minerId) {
    const response = await fetch(`/hosting/api/miners/${minerId}/restart`, {method: 'POST'});
    const result = await response.json();
    if (result.success) {
        let msg = getLanguage() === 'en' ? 'Miner restarted successfully' : '矿机重启成功';
        if (result.command_queued) {
            msg += getLanguage() === 'en' ? ' (Command sent to edge collector)' : ' (命令已发送到边缘采集器)';
        }
        showToast(msg, 'success');
        refreshMiners();
        loadKPIStats();
    } else {
        if (result.collector_available === false) {
            showToast(getLanguage() === 'en' 
                ? 'No edge collector available. Control operations require an active collector.' 
                : '无边缘采集器。控制操作需要活跃的采集器。', 'error');
        } else {
            showToast(result.error, 'error');
        }
    }
}

// 快速修改状态
function quickChangeStatus(minerId) {
    const modal = new bootstrap.Modal(document.getElementById('quickStatusModal'));
    document.getElementById('quickStatusMinerId').value = minerId;
    modal.show();
}

// 保存快速状态修改
async function saveQuickStatus() {
    const minerIdValue = document.getElementById('quickStatusMinerId').value;
    const newStatus = document.getElementById('quickStatusSelect').value;
    const notes = document.getElementById('quickStatusNotes').value;
    
    try {
        const minerIds = JSON.parse(minerIdValue);
        // 批量操作
        const response = await fetch('/hosting/api/miners/batch-status', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({miner_ids: minerIds, new_status: newStatus, notes: notes})
        });
        const result = await response.json();
        if (result.success) {
            showToast(result.message || (getLanguage() === 'en' ? 'Status updated successfully' : '状态更新成功'), 'success');
            bootstrap.Modal.getInstance(document.getElementById('quickStatusModal')).hide();
            refreshMiners();
            loadKPIStats();
        } else {
            showToast(result.error, 'error');
        }
    } catch {
        // 单个矿机操作
        const minerId = parseInt(minerIdValue);
        const response = await fetch(`/hosting/api/miners/${minerId}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({status: newStatus, notes: notes})
        });
        const result = await response.json();
        if (result.success) {
            showToast(getLanguage() === 'en' ? 'Status updated successfully' : '状态更新成功', 'success');
            bootstrap.Modal.getInstance(document.getElementById('quickStatusModal')).hide();
            refreshMiners();
            loadKPIStats();
        } else {
            showToast(result.error, 'error');
        }
    }
}

// 显示操作日志
async function showOperationLogs(minerId) {
    const modal = new bootstrap.Modal(document.getElementById('operationLogsModal'));
    modal.show();
    
    // 加载日志
    await loadOperationLogs(minerId, 1);
}

// 加载操作日志
async function loadOperationLogs(minerId, page = 1) {
    try {
        const response = await fetch(`/hosting/api/miners/${minerId}/logs?page=${page}&limit=20`);
        const result = await response.json();
        
        if (result.success) {
            const tbody = document.getElementById('logsTableBody');
            tbody.innerHTML = '';
            
            if (result.logs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">${getLanguage() === 'en' ? 'No operation logs' : '暂无操作日志'}</td></tr>`;
            } else {
                result.logs.forEach(log => {
                    const row = `
                        <tr>
                            <td>${new Date(log.created_at).toLocaleString()}</td>
                            <td><span class="badge bg-secondary">${log.operation_type}</span></td>
                            <td>${log.old_status || '-'}</td>
                            <td>${log.new_status || '-'}</td>
                            <td>${log.operator_email || '-'}</td>
                            <td>${log.notes || '-'}</td>
                        </tr>
                    `;
                    tbody.insertAdjacentHTML('beforeend', row);
                });
            }
            
            // 更新分页
            const pagination = result.pagination;
            const paginationEl = document.getElementById('logsPagination');
            paginationEl.innerHTML = '';
            
            for (let i = 1; i <= pagination.total_pages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === pagination.current_page ? 'active' : ''}`;
                li.innerHTML = `<a class="page-link" href="javascript:void(0)" onclick="loadOperationLogs(${minerId}, ${i})">${i}</a>`;
                paginationEl.appendChild(li);
            }
        }
    } catch (error) {
        console.error('加载操作日志失败:', error);
    }
}

// 导出CSV
function exportCSV() {
    const siteId = document.getElementById('site-filter').value;
    const status = document.getElementById('status-filter').value;
    const search = document.getElementById('quickSearch').value;
    
    const params = new URLSearchParams();
    if (siteId) params.append('site_id', siteId);
    if (status) params.append('status', status);
    if (search) params.append('search', search);
    
    window.location.href = `/hosting/api/miners/export?${params.toString()}`;
}

// 初始化时加载KPI和设置事件
document.addEventListener('DOMContentLoaded', function() {
    loadKPIStats();
    setupQuickSearch();
    
    // 每次刷新矿机列表后，重新初始化复选框
    const originalLoadMiners = loadMiners;
    window.loadMiners = function(...args) {
        originalLoadMiners.apply(this, args).then(() => {
            initCheckboxes();
        });
    };
    
    // 站点筛选器变化时也更新KPI
    document.getElementById('site-filter').addEventListener('change', function() {
        loadKPIStats();
    });
});


// ==================== 矿场主批量加密控制中心 (Owner-Level Encryption) ====================

let ownerEncryptionStatus = null;
let decryptedNetworkData = {};

async function loadOwnerEncryptionStatus() {
    try {
        const response = await fetch('/hosting/api/encryption/owner-key');
        const result = await response.json();
        
        if (result.success) {
            ownerEncryptionStatus = result;
            updateEncryptionUI(result);
        }
    } catch (err) {
        console.error('Failed to load owner encryption status:', err);
    }
}

function updateEncryptionUI(status) {
    const badge = document.getElementById('encryption-status-badge');
    const setupSection = document.getElementById('enc-setup-section');
    const unlockSection = document.getElementById('enc-unlock-section');
    const totalMiners = document.getElementById('enc-total-miners');
    const encryptedMiners = document.getElementById('enc-encrypted-miners');
    const keyVersion = document.getElementById('enc-key-version');
    const unlockStatus = document.getElementById('enc-unlock-status');
    const lang = getLanguage();
    
    totalMiners.textContent = status.total_miners || 0;
    encryptedMiners.textContent = status.encrypted_miners || 0;
    
    if (!status.has_encryption) {
        badge.className = 'badge bg-warning ms-2';
        badge.textContent = lang === 'en' ? 'Not Configured' : '未配置';
        setupSection.style.display = 'block';
        unlockSection.style.display = 'none';
        keyVersion.textContent = '-';
    } else {
        badge.className = 'badge bg-success ms-2';
        badge.textContent = lang === 'en' ? 'Configured' : '已配置';
        setupSection.style.display = 'none';
        unlockSection.style.display = 'block';
        keyVersion.textContent = 'v' + (status.key_version || 1);
    }
    
    const isCached = window.MinerE2EE && window.MinerE2EE.isCacheValid();
    if (isCached) {
        unlockStatus.innerHTML = `<span class="badge bg-success">${lang === 'en' ? 'Unlocked' : '已解锁'}</span>`;
    } else {
        unlockStatus.innerHTML = `<span class="badge bg-secondary">${lang === 'en' ? 'Locked' : '已锁定'}</span>`;
    }
}

function showEncryptionProgress(current, total, message) {
    const container = document.getElementById('enc-progress-container');
    const bar = document.getElementById('enc-progress-bar');
    const text = document.getElementById('enc-progress-text');
    const lang = getLanguage();
    
    container.style.display = 'block';
    const pct = Math.round((current / total) * 100);
    bar.style.width = pct + '%';
    bar.textContent = pct + '%';
    text.textContent = message || (lang === 'en' ? `Processing ${current} / ${total}...` : `处理中 ${current} / ${total}...`);
}

function hideEncryptionProgress() {
    document.getElementById('enc-progress-container').style.display = 'none';
}

async function setupOwnerEncryption() {
    const passphrase = document.getElementById('enc-setup-passphrase').value;
    const confirm = document.getElementById('enc-setup-confirm').value;
    const lang = getLanguage();
    
    if (!passphrase || passphrase.length < 8) {
        alert(lang === 'en' ? 'Passphrase must be at least 8 characters' : '密码至少需要8位字符');
        return;
    }
    
    if (passphrase !== confirm) {
        alert(lang === 'en' ? 'Passwords do not match' : '两次输入的密码不一致');
        return;
    }
    
    if (!window.MinerE2EE || !window.MinerE2EE.isSupported()) {
        alert(lang === 'en' ? 'Browser does not support encryption' : '浏览器不支持加密');
        return;
    }
    
    const confirmMsg = lang === 'en'
        ? 'This will encrypt all miners\' network data (IP/MAC addresses). Make sure to remember your master passphrase - it cannot be recovered! Continue?'
        : '这将加密所有矿机的网络数据（IP/MAC地址）。请确保记住主密码 - 密码无法恢复！是否继续？';
    
    if (!window.confirm(confirmMsg)) return;
    
    try {
        showEncryptionProgress(0, 1, lang === 'en' ? 'Creating encryption key...' : '创建加密密钥...');
        
        const keyResult = await window.MinerE2EE.createOwnerKey(passphrase);
        
        const saveResponse = await fetch('/hosting/api/encryption/owner-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                encrypted_data_key: keyResult.encrypted_data_key,
                key_salt: keyResult.key_salt
            })
        });
        
        const saveResult = await saveResponse.json();
        if (!saveResult.success) {
            throw new Error(saveResult.error || 'Failed to save key');
        }
        
        window.MinerE2EE.cacheDataKey(keyResult.data_key, 30);
        
        showEncryptionProgress(0, 1, lang === 'en' ? 'Loading miners...' : '加载矿机列表...');
        
        let allMiners = [];
        let page = 1;
        let hasMore = true;
        
        while (hasMore) {
            const response = await fetch(`/hosting/api/encryption/bulk-network?page=${page}&per_page=500`);
            const data = await response.json();
            
            if (data.success && data.miners) {
                allMiners = allMiners.concat(data.miners.filter(m => m.ip_address || m.mac_address));
                hasMore = page < data.pages;
                page++;
            } else {
                hasMore = false;
            }
        }
        
        if (allMiners.length === 0) {
            hideEncryptionProgress();
            alert(lang === 'en' ? 'No miners with network data to encrypt' : '没有需要加密的矿机网络数据');
            loadOwnerEncryptionStatus();
            return;
        }
        
        showEncryptionProgress(0, allMiners.length, lang === 'en' ? 'Encrypting...' : '加密中...');
        
        const encryptedMiners = await window.MinerE2EE.batchEncryptMiners(
            allMiners,
            keyResult.data_key,
            (current, total) => showEncryptionProgress(current, total)
        );
        
        showEncryptionProgress(allMiners.length, allMiners.length, lang === 'en' ? 'Saving encrypted data...' : '保存加密数据...');
        
        const batchSize = 100;
        for (let i = 0; i < encryptedMiners.length; i += batchSize) {
            const batch = encryptedMiners.slice(i, i + batchSize);
            await fetch('/hosting/api/encryption/bulk-encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ miners: batch })
            });
        }
        
        hideEncryptionProgress();
        alert(lang === 'en' 
            ? `Successfully encrypted ${encryptedMiners.length} miners!` 
            : `成功加密 ${encryptedMiners.length} 台矿机！`);
        
        loadOwnerEncryptionStatus();
        refreshMiners();
        
    } catch (err) {
        hideEncryptionProgress();
        console.error('Setup failed:', err);
        alert((lang === 'en' ? 'Setup failed: ' : '设置失败: ') + err.message);
    }
}

async function unlockOwnerEncryption() {
    const passphrase = document.getElementById('enc-unlock-passphrase').value;
    const lang = getLanguage();
    
    if (!passphrase) {
        alert(lang === 'en' ? 'Please enter passphrase' : '请输入密码');
        return;
    }
    
    try {
        showEncryptionProgress(0, 1, lang === 'en' ? 'Verifying passphrase...' : '验证密码中...');
        
        const response = await fetch('/hosting/api/encryption/owner-key/verify', { method: 'POST' });
        const result = await response.json();
        
        if (!result.success) {
            throw new Error(result.error || 'Failed to verify');
        }
        
        const dataKey = await window.MinerE2EE.unlockOwnerKey(result.encrypted_data_key, passphrase);
        window.MinerE2EE.cacheDataKey(dataKey, 30);
        
        showEncryptionProgress(0, 1, lang === 'en' ? 'Decrypting miners...' : '解密矿机数据...');
        
        let allMiners = [];
        let page = 1;
        let hasMore = true;
        
        while (hasMore) {
            const resp = await fetch(`/hosting/api/encryption/bulk-network?page=${page}&per_page=500`);
            const data = await resp.json();
            
            if (data.success && data.miners) {
                allMiners = allMiners.concat(data.miners.filter(m => m.encryption_scope === 'owner'));
                hasMore = page < data.pages;
                page++;
            } else {
                hasMore = false;
            }
        }
        
        if (allMiners.length > 0) {
            decryptedNetworkData = await window.MinerE2EE.batchDecryptMiners(
                allMiners,
                dataKey,
                (current, total) => showEncryptionProgress(current, total)
            );
        }
        
        hideEncryptionProgress();
        document.getElementById('enc-unlock-passphrase').value = '';
        updateEncryptionUI(ownerEncryptionStatus);
        refreshMiners();
        
        alert(lang === 'en' 
            ? `Unlocked! ${Object.keys(decryptedNetworkData).length} miners decrypted.`
            : `解锁成功！已解密 ${Object.keys(decryptedNetworkData).length} 台矿机。`);
        
    } catch (err) {
        hideEncryptionProgress();
        console.error('Unlock failed:', err);
        alert((lang === 'en' ? 'Unlock failed: ' : '解锁失败: ') + err.message);
    }
}

function lockOwnerEncryption() {
    const lang = getLanguage();
    
    window.MinerE2EE.clearCachedDataKey();
    decryptedNetworkData = {};
    
    updateEncryptionUI(ownerEncryptionStatus);
    refreshMiners();
    
    alert(lang === 'en' ? 'Encryption locked. Enter passphrase to unlock.' : '已锁定。请输入密码解锁。');
}

async function rotateOwnerKey() {
    const lang = getLanguage();
    
    const confirmMsg = lang === 'en'
        ? 'This will create a new encryption key. You will need to re-encrypt all miners. Current passphrase is required. Continue?'
        : '这将创建新的加密密钥。您需要重新加密所有矿机。需要当前密码。是否继续？';
    
    if (!window.confirm(confirmMsg)) return;
    
    const currentPassphrase = prompt(lang === 'en' ? 'Enter current passphrase:' : '请输入当前密码:');
    if (!currentPassphrase) return;
    
    const newPassphrase = prompt(lang === 'en' ? 'Enter new passphrase (min 8 chars):' : '请输入新密码（至少8位）:');
    if (!newPassphrase || newPassphrase.length < 8) {
        alert(lang === 'en' ? 'New passphrase must be at least 8 characters' : '新密码至少需要8位');
        return;
    }
    
    const confirmNew = prompt(lang === 'en' ? 'Confirm new passphrase:' : '确认新密码:');
    if (newPassphrase !== confirmNew) {
        alert(lang === 'en' ? 'Passwords do not match' : '两次输入的密码不一致');
        return;
    }
    
    try {
        showEncryptionProgress(0, 1, lang === 'en' ? 'Verifying current passphrase...' : '验证当前密码...');
        
        const verifyResp = await fetch('/hosting/api/encryption/owner-key/verify', { method: 'POST' });
        const verifyResult = await verifyResp.json();
        
        if (!verifyResult.success) {
            throw new Error(verifyResult.error);
        }
        
        const oldDataKey = await window.MinerE2EE.unlockOwnerKey(verifyResult.encrypted_data_key, currentPassphrase);
        
        showEncryptionProgress(0, 1, lang === 'en' ? 'Creating new key...' : '创建新密钥...');
        
        const newKeyResult = await window.MinerE2EE.createOwnerKey(newPassphrase);
        
        showEncryptionProgress(0, 1, lang === 'en' ? 'Loading miners...' : '加载矿机...');
        
        let allMiners = [];
        let page = 1;
        let hasMore = true;
        
        while (hasMore) {
            const response = await fetch(`/hosting/api/encryption/bulk-network?page=${page}&per_page=500`);
            const data = await response.json();
            
            if (data.success && data.miners) {
                allMiners = allMiners.concat(data.miners.filter(m => m.encryption_scope === 'owner'));
                hasMore = page < data.pages;
                page++;
            } else {
                hasMore = false;
            }
        }
        
        showEncryptionProgress(0, allMiners.length, lang === 'en' ? 'Decrypting with old key...' : '用旧密钥解密...');
        
        const decryptedData = await window.MinerE2EE.batchDecryptMiners(
            allMiners,
            oldDataKey,
            (current, total) => showEncryptionProgress(current, total, lang === 'en' ? 'Decrypting...' : '解密中...')
        );
        
        const minersToReEncrypt = allMiners.map(m => ({
            id: m.id,
            ip_address: decryptedData[m.id]?.ip,
            mac_address: decryptedData[m.id]?.mac
        })).filter(m => m.ip_address || m.mac_address);
        
        showEncryptionProgress(0, minersToReEncrypt.length, lang === 'en' ? 'Re-encrypting with new key...' : '用新密钥重新加密...');
        
        const reEncrypted = await window.MinerE2EE.batchEncryptMiners(
            minersToReEncrypt,
            newKeyResult.data_key,
            (current, total) => showEncryptionProgress(current, total, lang === 'en' ? 'Encrypting...' : '加密中...')
        );
        
        await fetch('/hosting/api/encryption/owner-key', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                encrypted_data_key: newKeyResult.encrypted_data_key,
                key_salt: newKeyResult.key_salt
            })
        });
        
        const batchSize = 100;
        for (let i = 0; i < reEncrypted.length; i += batchSize) {
            const batch = reEncrypted.slice(i, i + batchSize);
            await fetch('/hosting/api/encryption/bulk-encrypt', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ miners: batch })
            });
        }
        
        window.MinerE2EE.cacheDataKey(newKeyResult.data_key, 30);
        
        hideEncryptionProgress();
        loadOwnerEncryptionStatus();
        refreshMiners();
        
        alert(lang === 'en' 
            ? `Key rotated successfully! ${reEncrypted.length} miners re-encrypted.`
            : `密钥轮换成功！已重新加密 ${reEncrypted.length} 台矿机。`);
        
    } catch (err) {
        hideEncryptionProgress();
        console.error('Key rotation failed:', err);
        alert((lang === 'en' ? 'Key rotation failed: ' : '密钥轮换失败: ') + err.message);
    }
}

function getDecryptedNetworkData(minerId) {
    return decryptedNetworkData[minerId] || { ip: null, mac: null };
}

document.addEventListener('DOMContentLoaded', function() {
    // 加密控制中心 - 仅矿场主/管理员可见
    const encryptionBody = document.getElementById('encryptionBody');
    if (encryptionBody) {
        loadOwnerEncryptionStatus();
        
        encryptionBody.addEventListener('show.bs.collapse', function() {
            document.querySelector('#encryption-control-center .hosting-card-header').setAttribute('aria-expanded', 'true');
        });
        encryptionBody.addEventListener('hide.bs.collapse', function() {
            document.querySelector('#encryption-control-center .hosting-card-header').setAttribute('aria-expanded', 'false');
        });
    }
    
    // Initialize dropdown submenus for Bootstrap 5 with viewport detection
    initDropdownSubmenus();
});

// Initialize dropdown submenus with viewport boundary detection
function initDropdownSubmenus() {
    document.querySelectorAll('.dropdown-submenu').forEach(function(submenu) {
        submenu.addEventListener('mouseenter', function(e) {
            const rect = this.getBoundingClientRect();
            const submenuEl = this.querySelector('.dropdown-menu');
            if (submenuEl) {
                const submenuWidth = 220; // Approximate submenu width
                const rightSpace = window.innerWidth - rect.right;
                
                // If not enough space on right, open to left
                if (rightSpace < submenuWidth) {
                    this.classList.add('dropdown-submenu-left');
                } else {
                    this.classList.remove('dropdown-submenu-left');
                }
            }
        });
        
        submenu.addEventListener('click', function(e) {
            e.stopPropagation();
            this.classList.toggle('show');
        });
    });
}

// Position dropdown menu to stay within viewport
function positionDropdownInViewport(dropdownEl, buttonEl) {
    if (!dropdownEl || !buttonEl) return;
    
    const buttonRect = buttonEl.getBoundingClientRect();
    const menuWidth = dropdownEl.offsetWidth || 200;
    const menuHeight = dropdownEl.offsetHeight || 300;
    
    // Calculate available space
    const rightSpace = window.innerWidth - buttonRect.right;
    const bottomSpace = window.innerHeight - buttonRect.bottom;
    
    // Horizontal positioning
    if (rightSpace < menuWidth) {
        // Open to the left
        dropdownEl.style.left = 'auto';
        dropdownEl.style.right = '0';
    } else {
        dropdownEl.style.left = '0';
        dropdownEl.style.right = 'auto';
    }
    
    // Vertical positioning
    if (bottomSpace < menuHeight && buttonRect.top > menuHeight) {
        // Open upward
        dropdownEl.style.top = 'auto';
        dropdownEl.style.bottom = '100%';
    } else {
        dropdownEl.style.top = '100%';
        dropdownEl.style.bottom = 'auto';
    }
}

// Re-initialize submenus after table reload (event delegation for dynamic content)
document.addEventListener('shown.bs.dropdown', function(e) {
    const dropdown = e.target.closest('.dropdown, .btn-group');
    if (dropdown) {
        // Reinitialize submenus within this dropdown
        dropdown.querySelectorAll('.dropdown-submenu').forEach(function(submenu) {
            const rect = submenu.getBoundingClientRect();
            const submenuWidth = 220;
            const rightSpace = window.innerWidth - rect.right;
            
            if (rightSpace < submenuWidth) {
                submenu.classList.add('dropdown-submenu-left');
            } else {
                submenu.classList.remove('dropdown-submenu-left');
            }
        });
        
        // Position the main dropdown menu
        const menu = dropdown.querySelector('.dropdown-menu');
        const button = dropdown.querySelector('[data-bs-toggle="dropdown"]');
        if (menu && button) {
            positionDropdownInViewport(menu, button);
        }
    }
});

// ============================================
// Remote Command Functions
// ============================================

// Commands that require modal input
const PARAMETERIZED_COMMANDS = ['change_pools', 'power_mode', 'power_target', 'overclock', 'fan_mode', 'static_ip', 'change_password'];

// Commands that require confirmation
const DANGEROUS_COMMANDS = ['factory_reset', 'overclock', 'reboot'];

// Single miner remote command handler
function singleRemoteCommand(minerId, commandType) {
    const lang = getLanguage();
    
    // Check if command needs modal input
    if (PARAMETERIZED_COMMANDS.includes(commandType)) {
        openCommandModal(commandType, [minerId]);
        return;
    }
    
    // Check if command needs confirmation
    if (DANGEROUS_COMMANDS.includes(commandType)) {
        let confirmMessage = '';
        if (commandType === 'factory_reset') {
            confirmMessage = lang === 'en' 
                ? 'WARNING: Factory reset will erase all settings! Are you sure you want to proceed?'
                : '警告：恢复出厂设置将删除所有配置！确定要继续吗？';
        } else if (commandType === 'reboot') {
            confirmMessage = lang === 'en'
                ? 'Are you sure you want to reboot this miner?'
                : '确定要重启这台矿机吗？';
        } else if (commandType === 'overclock') {
            confirmMessage = lang === 'en'
                ? 'Warning: Overclocking may void warranty. Continue?'
                : '警告：超频可能导致保修失效。继续吗？';
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
    }
    
    // Execute command directly
    executeRemoteCommand([minerId], commandType, {});
}

// Batch remote command handler
function batchRemoteCommand(commandType) {
    const lang = getLanguage();
    const selectedIds = getSelectedMinerIds();
    
    if (selectedIds.length === 0) {
        alert(lang === 'en' ? 'Please select at least one miner' : '请至少选择一台矿机');
        return;
    }
    
    // Check if command needs modal input
    if (PARAMETERIZED_COMMANDS.includes(commandType)) {
        openCommandModal(commandType, selectedIds);
        return;
    }
    
    // Check if command needs confirmation
    if (DANGEROUS_COMMANDS.includes(commandType)) {
        let confirmMessage = '';
        const count = selectedIds.length;
        if (commandType === 'factory_reset') {
            confirmMessage = lang === 'en' 
                ? `WARNING: Factory reset will erase all settings on ${count} miners! Are you sure?`
                : `警告：恢复出厂设置将删除 ${count} 台矿机的所有配置！确定吗？`;
        } else if (commandType === 'reboot') {
            confirmMessage = lang === 'en'
                ? `Are you sure you want to reboot ${count} miners?`
                : `确定要重启 ${count} 台矿机吗？`;
        }
        
        if (!confirm(confirmMessage)) {
            return;
        }
    }
    
    executeRemoteCommand(selectedIds, commandType, {});
}

// Open appropriate modal for parameterized commands
function openCommandModal(commandType, minerIds) {
    const idList = minerIds.join(',');
    
    switch (commandType) {
        case 'change_pools':
            document.getElementById('changePoolsMinerIds').value = idList;
            document.getElementById('pool1Url').value = '';
            document.getElementById('pool2Url').value = '';
            document.getElementById('pool3Url').value = '';
            document.getElementById('poolWorkerName').value = '';
            new bootstrap.Modal(document.getElementById('changePoolsModal')).show();
            break;
        case 'power_mode':
            document.getElementById('powerModeMinerIds').value = idList;
            document.getElementById('powerModeSelect').value = 'normal';
            new bootstrap.Modal(document.getElementById('powerModeModal')).show();
            break;
        case 'power_target':
            document.getElementById('powerTargetMinerIds').value = idList;
            document.getElementById('powerTargetWatts').value = '';
            new bootstrap.Modal(document.getElementById('powerTargetModal')).show();
            break;
        case 'overclock':
            document.getElementById('overclockMinerIds').value = idList;
            document.getElementById('overclockFreqSlider').value = 500;
            document.getElementById('overclockFreqValue').value = 500;
            new bootstrap.Modal(document.getElementById('overclockModal')).show();
            break;
        case 'fan_mode':
            document.getElementById('fanModeMinerIds').value = idList;
            document.getElementById('fanModeAuto').checked = true;
            document.getElementById('manualFanSpeedSection').style.display = 'none';
            document.getElementById('manualFanSpeedSlider').value = 80;
            document.getElementById('manualFanSpeedValue').textContent = '80%';
            new bootstrap.Modal(document.getElementById('fanModeModal')).show();
            break;
        case 'static_ip':
            document.getElementById('staticIpMinerIds').value = idList;
            document.getElementById('staticIpAddress').value = '';
            document.getElementById('staticSubnetMask').value = '255.255.255.0';
            document.getElementById('staticGateway').value = '';
            document.getElementById('staticDns').value = '8.8.8.8';
            new bootstrap.Modal(document.getElementById('staticIpModal')).show();
            break;
        case 'change_password':
            document.getElementById('changePasswordMinerIds').value = idList;
            document.getElementById('minerNewPassword').value = '';
            document.getElementById('minerConfirmPassword').value = '';
            new bootstrap.Modal(document.getElementById('changePasswordModal')).show();
            break;
    }
}

// Toggle manual fan speed section visibility
function toggleManualFanSpeed() {
    const isManual = document.getElementById('fanModeManual').checked;
    document.getElementById('manualFanSpeedSection').style.display = isManual ? 'block' : 'none';
}

// Modal submission handlers
function submitChangePoolsCommand() {
    const lang = getLanguage();
    const minerIds = document.getElementById('changePoolsMinerIds').value.split(',').map(Number);
    const pool1 = document.getElementById('pool1Url').value.trim();
    const pool2 = document.getElementById('pool2Url').value.trim();
    const pool3 = document.getElementById('pool3Url').value.trim();
    const worker = document.getElementById('poolWorkerName').value.trim();
    
    if (!pool1 || !worker) {
        alert(lang === 'en' ? 'Pool 1 URL and Worker Name are required' : '矿池1 URL和矿工名称为必填项');
        return;
    }
    
    const params = { pool1_url: pool1, pool2_url: pool2, pool3_url: pool3, worker_name: worker };
    bootstrap.Modal.getInstance(document.getElementById('changePoolsModal')).hide();
    executeRemoteCommand(minerIds, 'change_pools', params);
}

function submitPowerModeCommand() {
    const minerIds = document.getElementById('powerModeMinerIds').value.split(',').map(Number);
    const mode = document.getElementById('powerModeSelect').value;
    
    bootstrap.Modal.getInstance(document.getElementById('powerModeModal')).hide();
    executeRemoteCommand(minerIds, 'power_mode', { mode: mode });
}

function submitPowerTargetCommand() {
    const lang = getLanguage();
    const minerIds = document.getElementById('powerTargetMinerIds').value.split(',').map(Number);
    const watts = parseInt(document.getElementById('powerTargetWatts').value);
    
    if (isNaN(watts) || watts < 500 || watts > 5000) {
        alert(lang === 'en' ? 'Please enter a valid power target (500-5000W)' : '请输入有效的功率目标 (500-5000W)');
        return;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('powerTargetModal')).hide();
    executeRemoteCommand(minerIds, 'power_target', { watts: watts });
}

function submitOverclockCommand() {
    const lang = getLanguage();
    const minerIds = document.getElementById('overclockMinerIds').value.split(',').map(Number);
    const frequency = parseInt(document.getElementById('overclockFreqValue').value);
    
    if (isNaN(frequency) || frequency < 400 || frequency > 800) {
        alert(lang === 'en' ? 'Please enter a valid frequency (400-800 MHz)' : '请输入有效的频率 (400-800 MHz)');
        return;
    }
    
    // Additional confirmation for overclock
    const confirmMsg = lang === 'en'
        ? `Are you sure you want to set frequency to ${frequency} MHz? This may void warranty.`
        : `确定要将频率设置为 ${frequency} MHz吗？这可能导致保修失效。`;
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('overclockModal')).hide();
    executeRemoteCommand(minerIds, 'overclock', { frequency_mhz: frequency });
}

function submitFanModeCommand() {
    const minerIds = document.getElementById('fanModeMinerIds').value.split(',').map(Number);
    const isManual = document.getElementById('fanModeManual').checked;
    const speed = isManual ? parseInt(document.getElementById('manualFanSpeedSlider').value) : null;
    
    const params = { mode: isManual ? 'manual' : 'auto' };
    if (isManual) {
        params.speed_percent = speed;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('fanModeModal')).hide();
    executeRemoteCommand(minerIds, 'fan_mode', params);
}

function submitStaticIpCommand() {
    const lang = getLanguage();
    const minerIds = document.getElementById('staticIpMinerIds').value.split(',').map(Number);
    const ip = document.getElementById('staticIpAddress').value.trim();
    const subnet = document.getElementById('staticSubnetMask').value.trim();
    const gateway = document.getElementById('staticGateway').value.trim();
    const dns = document.getElementById('staticDns').value.trim();
    
    if (!ip || !subnet || !gateway) {
        alert(lang === 'en' ? 'IP Address, Subnet Mask, and Gateway are required' : 'IP地址、子网掩码和网关为必填项');
        return;
    }
    
    // Simple IP validation
    const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (!ipPattern.test(ip) || !ipPattern.test(subnet) || !ipPattern.test(gateway)) {
        alert(lang === 'en' ? 'Please enter valid IP addresses' : '请输入有效的IP地址');
        return;
    }
    
    const params = { ip_address: ip, subnet_mask: subnet, gateway: gateway, dns_server: dns };
    bootstrap.Modal.getInstance(document.getElementById('staticIpModal')).hide();
    executeRemoteCommand(minerIds, 'static_ip', params);
}

function submitChangePasswordCommand() {
    const lang = getLanguage();
    const minerIds = document.getElementById('changePasswordMinerIds').value.split(',').map(Number);
    const newPass = document.getElementById('minerNewPassword').value;
    const confirmPass = document.getElementById('minerConfirmPassword').value;
    
    if (!newPass || !confirmPass) {
        alert(lang === 'en' ? 'Please enter and confirm the new password' : '请输入并确认新密码');
        return;
    }
    
    if (newPass !== confirmPass) {
        alert(lang === 'en' ? 'Passwords do not match' : '密码不匹配');
        return;
    }
    
    if (newPass.length < 6) {
        alert(lang === 'en' ? 'Password must be at least 6 characters' : '密码至少需要6个字符');
        return;
    }
    
    bootstrap.Modal.getInstance(document.getElementById('changePasswordModal')).hide();
    executeRemoteCommand(minerIds, 'change_password', { password: newPass });
}

// Execute remote command API call
async function executeRemoteCommand(minerIds, commandType, params) {
    const lang = getLanguage();
    
    try {
        const response = await fetch('/hosting/api/miners/batch-command', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                miner_ids: minerIds,
                command: commandType,
                params: params
            })
        });
        
        const data = await response.json();
        
        if (response.ok && data.success) {
            const successCount = data.results?.filter(r => r.success)?.length || minerIds.length;
            const failCount = data.results?.filter(r => !r.success)?.length || 0;
            
            let message = lang === 'en'
                ? `Command sent successfully! Success: ${successCount}`
                : `命令发送成功！成功: ${successCount}`;
            
            if (failCount > 0) {
                message += lang === 'en' ? `, Failed: ${failCount}` : `，失败: ${failCount}`;
            }
            
            alert(message);
            refreshMiners();
        } else {
            throw new Error(data.error || 'Command failed');
        }
    } catch (err) {
        console.error('Remote command failed:', err);
        alert((lang === 'en' ? 'Command failed: ' : '命令失败: ') + err.message);
    }
}

// Helper functions for miner actions
function getSelectedMinerIds() {
    return Array.from(document.querySelectorAll('.miner-checkbox:checked')).map(cb => parseInt(cb.value));
}

function openTicketForMiner(minerId) {
    window.location.href = `/hosting/tickets/new?miner_id=${minerId}`;
}

function viewMinerTickets(minerId) {
    window.location.href = `/hosting/tickets?miner_id=${minerId}`;
}

function toggleMinerStatus(minerId, action) {
    const lang = getLanguage();
    const confirmMsg = action === 'disable'
        ? (lang === 'en' ? 'Are you sure you want to disable this miner?' : '确定要禁用这台矿机吗？')
        : (lang === 'en' ? 'Are you sure you want to enable this miner?' : '确定要启用这台矿机吗？');
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    fetch(`/hosting/api/miners/${minerId}/status`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: action })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            refreshMiners();
        } else {
            throw new Error(data.error || 'Failed');
        }
    })
    .catch(err => {
        alert((lang === 'en' ? 'Failed to update status: ' : '更新状态失败: ') + err.message);
    });
}

function deleteMiner(minerId) {
    const lang = getLanguage();
    const confirmMsg = lang === 'en' 
        ? 'Are you sure you want to delete this miner? This action cannot be undone.'
        : '确定要删除这台矿机吗？此操作不可撤销。';
    
    if (!confirm(confirmMsg)) {
        return;
    }
    
    fetch(`/hosting/api/miners/${minerId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            refreshMiners();
            alert(lang === 'en' ? 'Miner deleted successfully' : '矿机删除成功');
        } else {
            throw new Error(data.error || 'Delete failed');
        }
    })
    .catch(err => {
        alert((lang === 'en' ? 'Delete failed: ' : '删除失败: ') + err.message);
    });
}

</script>
{% endblock %}