{% extends "hosting/hosting_base.html" %}

{% block page_title %}<span data-i18n="hosting.event_monitoring">Event Monitoring</span>{% endblock %}
{% block page_subtitle %}<span data-i18n="hosting.realtime_monitoring_incident">Real-time monitoring and incident management</span>{% endblock %}

{% block header_actions %}
{{ super() }}
<div class="btn-group ms-3" role="group">
    <button class="btn btn-hosting-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createIncidentModal">
        <i class="bi bi-plus-circle me-1"></i><span data-i18n="hosting.new_incident">New Incident</span>
    </button>
    <button class="btn btn-hosting-secondary btn-sm" onclick="refreshMonitoring()">
        <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="refresh">Refresh</span>
    </button>
</div>
{% endblock %}

{% block content %}

<!-- ÁõëÊéßÊ¶ÇËßàÁªüËÆ° -->
<div class="hosting-stats-grid">
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="active-alerts">--</div>
        <div class="hosting-stat-label" data-i18n="hosting.active_alerts">Active Alerts</div>
        <i class="bi bi-exclamation-triangle hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-incidents">--</div>
        <div class="hosting-stat-label" data-i18n="hosting.total_incidents">Total Incidents</div>
        <i class="bi bi-shield-exclamation hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="response-time">--</div>
        <div class="hosting-stat-label" data-i18n="hosting.avg_response">Avg Response</div>
        <i class="bi bi-clock hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="uptime-percentage">--</div>
        <div class="hosting-stat-label" data-i18n="hosting.system_uptime">System Uptime</div>
        <i class="bi bi-check-circle hosting-stat-icon"></i>
    </div>
</div>

<!-- ÂÆûÊó∂ÂëäË≠¶ -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-bell me-2"></i><span data-i18n="hosting.realtime_alerts">Real-time Alerts</span>
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-hosting-outline btn-sm active" onclick="filterAlerts('all')" data-i18n="all">All</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterAlerts('critical')" data-i18n="hosting.critical">Critical</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterAlerts('warning')" data-i18n="hosting.warning">Warning</button>
        </div>
    </div>
    <div class="hosting-card-body">
        <div class="row g-3" id="alerts-grid">
            <!-- ÂëäË≠¶Âç°ÁâáÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>
</div>

<!-- ‰∫ã‰ª∂ÁÆ°ÁêÜ -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-calendar-event me-2"></i><span data-i18n="hosting.incident_management">Incident Management</span>
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-hosting-secondary btn-sm" onclick="exportIncidents()">
                <i class="bi bi-download me-1"></i><span data-i18n="export">Export</span>
            </button>
        </div>
    </div>
    <div class="hosting-card-body">
        <!-- Á≠õÈÄâÈÄâÈ°π -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <select class="form-select" id="severity-filter" onchange="filterIncidents()">
                    <option value="" data-i18n="hosting.all_severities">All Severities</option>
                    <option value="critical" data-i18n="hosting.critical">Critical</option>
                    <option value="high" data-i18n="high">High</option>
                    <option value="medium" data-i18n="medium">Medium</option>
                    <option value="low" data-i18n="low">Low</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="status-filter" onchange="filterIncidents()">
                    <option value="" data-i18n="hosting.all_statuses">All Statuses</option>
                    <option value="open" data-i18n="hosting.open">Open</option>
                    <option value="investigating" data-i18n="hosting.investigating">Investigating</option>
                    <option value="resolved" data-i18n="hosting.resolved">Resolved</option>
                    <option value="closed" data-i18n="hosting.closed">Closed</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="site-filter" onchange="filterIncidents()">
                    <option value="" data-i18n="all_sites">All Sites</option>
                    <!-- Á´ôÁÇπÈÄâÈ°πÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="search-incidents" data-i18n-placeholder="hosting.search_incidents" placeholder="Search incidents..." onkeyup="searchIncidents()">
            </div>
        </div>
        
        <!-- ‰∫ã‰ª∂ÂàóË°® -->
        <div class="hosting-table">
            <table class="table table-hover" id="incidents-table">
                <thead>
                    <tr>
                        <th data-i18n="hosting.id">ID</th>
                        <th data-i18n="hosting.title">Title</th>
                        <th data-i18n="hosting.severity">Severity</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="site">Site</th>
                        <th data-i18n="hosting.created">Created</th>
                        <th data-i18n="hosting.duration">Duration</th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- ‰∫ã‰ª∂Êï∞ÊçÆÈÄöËøáJavaScriptÂä†ËΩΩ -->
                </tbody>
            </table>
        </div>
        
        <!-- ÂàÜÈ°µ -->
        <nav aria-label="Incidents pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="incidents-pagination">
                <!-- ÂàÜÈ°µÊåâÈíÆÈÄöËøáJavaScriptÁîüÊàê -->
            </ul>
        </nav>
    </div>
</div>

<!-- ÊîØÊåÅÂ∑•Âçï -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-ticket-detailed me-2"></i><span data-i18n="hosting.support_tickets">Support Tickets</span>
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-hosting-outline btn-sm active" onclick="filterTickets('all', this)" data-i18n="all">All</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterTickets('open', this)" data-i18n="hosting.open">Open</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterTickets('resolved', this)" data-i18n="hosting.resolved">Resolved</button>
        </div>
    </div>
    <div class="hosting-card-body">
        <!-- Â∑•ÂçïÂàóË°® -->
        <div class="hosting-table">
            <table class="table table-hover" id="tickets-table">
                <thead>
                    <tr>
                        <th data-i18n="hosting.id">ID</th>
                        <th data-i18n="hosting.title">Title</th>
                        <th data-i18n="hosting.miner">Miner</th>
                        <th data-i18n="hosting.priority">Priority</th>
                        <th data-i18n="status">Status</th>
                        <th data-i18n="hosting.created">Created</th>
                        <th data-i18n="actions">Actions</th>
                    </tr>
                </thead>
                <tbody id="tickets-tbody">
                    <!-- Â∑•ÂçïÊï∞ÊçÆÈÄöËøáJavaScriptÂä†ËΩΩ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Á≥ªÁªüÁõëÊéßÂõæË°® -->
<div class="row">
    <div class="col-lg-8">
        <div class="hosting-card">
            <div class="hosting-card-header">
                <h5 class="hosting-card-title">
                    <i class="bi bi-activity me-2"></i><span data-i18n="hosting.system_performance">System Performance</span>
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-hosting-outline btn-sm active" onclick="switchTimeRange('1h')">1<span data-i18n="hosting.hour_short">H</span></button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('6h')">6<span data-i18n="hosting.hour_short">H</span></button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('24h')">24<span data-i18n="hosting.hour_short">H</span></button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('7d')">7<span data-i18n="hosting.day_short">D</span></button>
                </div>
            </div>
            <div class="hosting-card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="hosting-card">
            <div class="hosting-card-header">
                <h5 class="hosting-card-title">
                    <i class="bi bi-speedometer2 me-2"></i><span data-i18n="hosting.key_metrics">Key Metrics</span>
                </h5>
            </div>
            <div class="hosting-card-body">
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted" data-i18n="hosting.cpu_usage">CPU Usage</span>
                        <span class="fw-bold" id="cpu-usage">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar" id="cpu-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted" data-i18n="hosting.memory_usage">Memory Usage</span>
                        <span class="fw-bold" id="memory-usage">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted" data-i18n="hosting.network_io">Network I/O</span>
                        <span class="fw-bold" id="network-io">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" id="network-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted" data-i18n="hosting.error_rate">Error Rate</span>
                        <span class="fw-bold" id="error-rate">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" role="progressbar" id="error-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÂàõÂª∫‰∫ã‰ª∂Ê®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="createIncidentModal" tabindex="-1" aria-labelledby="createIncidentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="createIncidentModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span data-i18n="hosting.create_new_incident">Create New Incident</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createIncidentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="incident-title" class="form-label">
                                <span data-i18n="hosting.title">Title</span> <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="incident-title" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-severity" class="form-label">
                                <span data-i18n="hosting.severity">Severity</span> <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="incident-severity" name="severity" required>
                                <option value="" data-i18n="hosting.select_severity">Select Severity</option>
                                <option value="critical" data-i18n="hosting.critical">Critical</option>
                                <option value="high" data-i18n="high">High</option>
                                <option value="medium" data-i18n="medium">Medium</option>
                                <option value="low" data-i18n="low">Low</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-site" class="form-label" data-i18n="hosting.affected_site">Affected Site</label>
                            <select class="form-select" id="incident-site" name="site_id">
                                <option value="" data-i18n="hosting.select_site">Select Site</option>
                                <!-- Á´ôÁÇπÈÄâÈ°πÈÄöËøáJavaScriptÂä®ÊÄÅÂä†ËΩΩ -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-category" class="form-label" data-i18n="hosting.category">Category</label>
                            <select class="form-select" id="incident-category" name="category">
                                <option value="" data-i18n="hosting.select_category">Select Category</option>
                                <option value="hardware" data-i18n="hosting.hardware">Hardware</option>
                                <option value="network" data-i18n="hosting.network">Network</option>
                                <option value="power" data-i18n="hosting.power">Power</option>
                                <option value="cooling" data-i18n="hosting.cooling">Cooling</option>
                                <option value="security" data-i18n="hosting.security">Security</option>
                                <option value="other" data-i18n="hosting.other">Other</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="incident-description" class="form-label">
                                <span data-i18n="description">Description</span> <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="incident-description" name="description" rows="4" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                <button type="button" class="btn btn-hosting-primary" onclick="createIncident()" data-i18n="hosting.create_incident">Create Incident</button>
            </div>
        </div>
    </div>
</div>

<!-- ‰∫ã‰ª∂ËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="incidentDetailModal" tabindex="-1" aria-labelledby="incidentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="incidentDetailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    <span data-i18n="hosting.incident_details">Incident Details</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="incident-detail-content">
                <!-- ‰∫ã‰ª∂ËØ¶ÊÉÖÂÜÖÂÆπÂ∞ÜÂú®ËøôÈáåÂä†ËΩΩ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="hosting.close">Close</button>
                <button type="button" class="btn btn-hosting-primary" onclick="updateIncidentStatus()" data-i18n="hosting.update_status">Update Status</button>
            </div>
        </div>
    </div>
</div>

<!-- AI ËØäÊñ≠ÁªìÊûúÊ®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="aiDiagnosisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;">
                <h5 class="modal-title"><i class="bi bi-robot me-2"></i>AI Diagnosis / AIËØäÊñ≠</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ai-diagnosis-content">
                <div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">Analyzing... / ÂàÜÊûê‰∏≠...</p></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringData();
    loadSiteOptions();
    initPerformanceChart();
    setupRealTimeUpdates();
});

let currentIncidentId = null;
let performanceChart = null;

function loadMonitoringData() {
    // Âä†ËΩΩÁõëÊéßÊ¶ÇËßàÊï∞ÊçÆ
    fetch('/hosting/api/monitoring/overview')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMonitoringStats(data.stats);
                updateAlertsGrid(data.alerts);
                updateMetrics(data.metrics);
            }
        })
        .catch(error => {
            console.error('Error loading monitoring data:', error);
        });
    
    // Âä†ËΩΩ‰∫ã‰ª∂ÂàóË°®
    loadIncidents();
    
    // Âä†ËΩΩÂ∑•ÂçïÂàóË°®
    loadTickets();
}

function updateMonitoringStats(stats) {
    document.getElementById('active-alerts').textContent = stats.active_alerts || 0;
    document.getElementById('total-incidents').textContent = stats.total_incidents || 0;
    document.getElementById('response-time').textContent = `${stats.avg_response_time || 0}min`;
    document.getElementById('uptime-percentage').textContent = `${stats.uptime_percentage || 0}%`;
}

function updateAlertsGrid(alerts) {
    const grid = document.getElementById('alerts-grid');
    grid.innerHTML = '';
    
    if (alerts.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <i class="bi bi-check-circle fs-1 mb-2 d-block text-success"></i>
                ${getLanguage() === 'en' ? 'No active alerts' : 'Êó†Ê¥ªË∑ÉÂëäË≠¶'}
            </div>
        `;
        return;
    }
    
    alerts.forEach(alert => {
        const alertCard = `
            <div class="col-md-4 alert-card" data-severity="${alert.severity}">
                <div class="hosting-card border-start border-${getSeverityColor(alert.severity)} border-3">
                    <div class="hosting-card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-${getSeverityColor(alert.severity)}">${getSeverityText(alert.severity)}</span>
                            <small class="text-muted">${alert.created_at}</small>
                        </div>
                        <h6 class="fw-bold mb-2">${alert.title}</h6>
                        <p class="text-muted mb-2">${alert.description}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">${alert.site_name || 'Global'}</small>
                            <div class="btn-group">
                                <button class="btn btn-outline-success btn-sm px-3" onclick="acknowledgeAlert(${alert.id})" title="${getLanguage() === 'en' ? 'Acknowledge Alert' : 'Á°ÆËÆ§ÂëäË≠¶'}">
                                    <span style="font-size: 14px;">‚úì</span> ${getLanguage() === 'en' ? 'Ack' : 'Á°ÆËÆ§'}
                                </button>
                                ${(alert.miner_id && alert.site_id) ? 
                                    `<button class="btn btn-outline-info btn-sm px-3" onclick="openAIDiagnosis('${alert.id}', '${alert.alert_type || 'offline'}', '${alert.miner_id}', ${alert.site_id})" title="${getLanguage() === 'en' ? 'AI Diagnosis' : 'AIÊô∫ËÉΩËØäÊñ≠'}">
                                        <span style="font-size: 14px;">ü§ñ</span> AI
                                    </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', alertCard);
    });
}

function updateMetrics(metrics) {
    document.getElementById('cpu-usage').textContent = `${metrics.cpu_usage}%`;
    document.getElementById('cpu-progress').style.width = `${metrics.cpu_usage}%`;
    
    document.getElementById('memory-usage').textContent = `${metrics.memory_usage}%`;
    document.getElementById('memory-progress').style.width = `${metrics.memory_usage}%`;
    
    document.getElementById('network-io').textContent = `${metrics.network_io} MB/s`;
    document.getElementById('network-progress').style.width = `${Math.min(metrics.network_io * 10, 100)}%`;
    
    document.getElementById('error-rate').textContent = `${metrics.error_rate}%`;
    document.getElementById('error-progress').style.width = `${metrics.error_rate}%`;
}

function loadIncidents() {
    const filters = getIncidentFilters();
    const queryParams = new URLSearchParams(filters);
    
    fetch(`/hosting/api/monitoring/incidents?${queryParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIncidents(data.incidents);
                updatePagination(data.pagination);
            }
        })
        .catch(error => {
            console.error('Error loading incidents:', error);
        });
}

function displayIncidents(incidents) {
    const tbody = document.querySelector('#incidents-table tbody');
    tbody.innerHTML = '';
    
    if (incidents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-shield-check fs-1 mb-2 d-block text-success"></i>
                    ${getLanguage() === 'en' ? 'No incidents found' : 'Êú™ÊâæÂà∞‰∫ã‰ª∂'}
                </td>
            </tr>
        `;
        return;
    }
    
    incidents.forEach(incident => {
        const row = `
            <tr>
                <td><strong>#${incident.id}</strong></td>
                <td>${incident.title}</td>
                <td><span class="badge bg-${getSeverityColor(incident.severity)}">${getSeverityText(incident.severity)}</span></td>
                <td><span class="badge bg-${getStatusColor(incident.status)}">${getStatusText(incident.status)}</span></td>
                <td>${incident.site_name || 'Global'}</td>
                <td>${incident.created_at}</td>
                <td>${incident.duration || '--'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-hosting-outline" onclick="viewIncident(${incident.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-hosting-outline" onclick="editIncident(${incident.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

// ==================== Â∑•ÂçïÁõ∏ÂÖ≥ÂáΩÊï∞ ====================

let currentTicketFilter = 'all';

function loadTickets(filter = null) {
    if (filter !== null) {
        currentTicketFilter = filter;
    }
    
    let url = '/hosting/api/tickets?limit=50';
    if (currentTicketFilter && currentTicketFilter !== 'all') {
        url += `&status=${currentTicketFilter}`;
    }
    
    fetch(url, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTickets(data.tickets);
            }
        })
        .catch(error => {
            console.error('Error loading tickets:', error);
        });
}

function filterTickets(filter, btn) {
    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
    const ticketsCard = document.getElementById('tickets-table').closest('.hosting-card');
    if (ticketsCard) {
        ticketsCard.querySelectorAll('.hosting-card-header .btn-group .btn').forEach(b => {
            b.classList.remove('active');
        });
    }
    if (btn) {
        btn.classList.add('active');
    }
    
    loadTickets(filter);
}

function displayTickets(tickets) {
    const tbody = document.getElementById('tickets-tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    if (!tickets || tickets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted py-4">
                    <i class="bi bi-ticket-detailed fs-1 mb-2 d-block"></i>
                    ${getLanguage() === 'en' ? 'No tickets found' : 'Êú™ÊâæÂà∞Â∑•Âçï'}
                </td>
            </tr>
        `;
        return;
    }
    
    tickets.forEach(ticket => {
        const snapshot = ticket.miner_snapshot || {};
        const minerInfo = snapshot.serial_number 
            ? `<strong>${snapshot.serial_number}</strong><br>
               <small class="text-muted">
                   ${snapshot.site_name || ''} | 
                   ${snapshot.hashrate || '-'} TH/s | 
                   ${snapshot.power || '-'} W
               </small>`
            : '<span class="text-muted">-</span>';
        
        const priorityColors = {
            'urgent': 'danger',
            'high': 'warning',
            'medium': 'info',
            'low': 'secondary'
        };
        
        const row = `
            <tr>
                <td><strong>#${ticket.id}</strong></td>
                <td>
                    <div>${ticket.title}</div>
                    ${ticket.description ? `<small class="text-muted">${ticket.description.substring(0, 50)}${ticket.description.length > 50 ? '...' : ''}</small>` : ''}
                </td>
                <td>${minerInfo}</td>
                <td><span class="badge bg-${priorityColors[ticket.priority] || 'secondary'}">${getPriorityText(ticket.priority)}</span></td>
                <td><span class="badge bg-${getStatusColor(ticket.status)}">${getStatusText(ticket.status)}</span></td>
                <td><small>${formatDate(ticket.created_at)}</small></td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-hosting-outline" onclick="viewTicketDetails(${ticket.id})" title="${getLanguage() === 'en' ? 'View Details' : 'Êü•ÁúãËØ¶ÊÉÖ'}">
                            <i class="bi bi-eye"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function getPriorityText(priority) {
    const language = getLanguage();
    const map = {
        'urgent': language === 'en' ? 'Urgent' : 'Á¥ßÊÄ•',
        'high': language === 'en' ? 'High' : 'È´ò',
        'medium': language === 'en' ? 'Medium' : '‰∏≠',
        'low': language === 'en' ? 'Low' : '‰Ωé'
    };
    return map[priority] || priority;
}

function formatDate(dateStr) {
    if (!dateStr) return '-';
    try {
        const date = new Date(dateStr);
        return date.toLocaleString(getLanguage() === 'en' ? 'en-US' : 'zh-CN', {
            month: 'short',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return dateStr;
    }
}

function viewTicketDetails(ticketId) {
    fetch(`/hosting/api/tickets/${ticketId}`, { credentials: 'same-origin' })
        .then(response => response.json())
        .then(data => {
            if (!data.success || !data.ticket) {
                showToast(getLanguage() === 'en' ? 'Ticket not found' : 'Êú™ÊâæÂà∞Â∑•Âçï', 'error');
                return;
            }
            
            const ticket = data.ticket;
            
            const lang = getLanguage();
            const snapshot = ticket.miner_snapshot || {};
            
            let details = `${lang === 'en' ? 'Ticket' : 'Â∑•Âçï'} #${ticket.id}\n`;
            details += `${lang === 'en' ? 'Title' : 'Ê†áÈ¢ò'}: ${ticket.title}\n`;
            details += `${lang === 'en' ? 'Status' : 'Áä∂ÊÄÅ'}: ${getStatusText(ticket.status)}\n`;
            details += `${lang === 'en' ? 'Priority' : '‰ºòÂÖàÁ∫ß'}: ${getPriorityText(ticket.priority)}\n`;
            details += `${lang === 'en' ? 'Created' : 'ÂàõÂª∫Êó∂Èó¥'}: ${formatDate(ticket.created_at)}\n`;
            
            if (ticket.description) {
                details += `\n${lang === 'en' ? 'Description' : 'ÊèèËø∞'}:\n${ticket.description}\n`;
            }
            
            if (Object.keys(snapshot).length > 0) {
                details += `\n--- ${lang === 'en' ? 'Miner Snapshot at Creation' : 'ÂàõÂª∫Êó∂ÁüøÊú∫Âø´ÁÖß'} ---\n`;
                details += `${lang === 'en' ? 'Serial Number' : 'Â∫èÂàóÂè∑'}: ${snapshot.serial_number || '-'}\n`;
                details += `${lang === 'en' ? 'Site' : 'Á´ôÁÇπ'}: ${snapshot.site_name || '-'} (${snapshot.site_location || '-'})\n`;
                details += `${lang === 'en' ? 'Customer' : 'ÂÆ¢Êà∑'}: ${snapshot.customer_email || '-'}\n`;
                details += `${lang === 'en' ? 'Model' : 'ÂûãÂè∑'}: ${snapshot.miner_model || '-'}\n`;
                details += `${lang === 'en' ? 'Hashrate' : 'ÁÆóÂäõ'}: ${snapshot.hashrate || '-'} TH/s\n`;
                details += `${lang === 'en' ? 'Power' : 'ÂäüÁéá'}: ${snapshot.power || '-'} W\n`;
                details += `${lang === 'en' ? 'Temperature' : 'Ê∏©Â∫¶'}: ${snapshot.temperature_avg || '-'}¬∞C (${lang === 'en' ? 'Max' : 'ÊúÄÈ´ò'}: ${snapshot.temperature_max || '-'}¬∞C)\n`;
                details += `${lang === 'en' ? 'IP Address' : 'IPÂú∞ÂùÄ'}: ${snapshot.ip_address || '-'}\n`;
                details += `${lang === 'en' ? 'Status' : 'Áä∂ÊÄÅ'}: ${snapshot.status || '-'}\n`;
                details += `${lang === 'en' ? 'Online' : 'Âú®Á∫ø'}: ${snapshot.cgminer_online ? (lang === 'en' ? 'Yes' : 'ÊòØ') : (lang === 'en' ? 'No' : 'Âê¶')}\n`;
                details += `${lang === 'en' ? 'Captured At' : 'ËÆ∞ÂΩïÊó∂Èó¥'}: ${snapshot.captured_at || '-'}\n`;
            }
            
            alert(details);
        })
        .catch(error => {
            console.error('Error loading ticket details:', error);
        });
}

function loadSiteOptions() {
    fetch('/hosting/api/sites')
        .then(response => response.json())
        .then(data => {
            const siteSelects = ['site-filter', 'incident-site'];
            siteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                data.sites.forEach(site => {
                    const option = `<option value="${site.id}">${site.name} - ${site.location}</option>`;
                    select.insertAdjacentHTML('beforeend', option);
                });
            });
        });
}

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: getLanguage() === 'en' ? 'Response Time (ms)' : 'ÂìçÂ∫îÊó∂Èó¥ (ms)',
                data: [],
                borderColor: '#f7931e',
                backgroundColor: 'rgba(247, 147, 30, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: getLanguage() === 'en' ? 'Error Count' : 'ÈîôËØØÊï∞Èáè',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#adb5bd' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: { color: '#adb5bd' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: { color: '#adb5bd' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
    
    loadPerformanceData('1h');
}

function setupRealTimeUpdates() {
    // ÊØè30ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÁõëÊéßÊï∞ÊçÆ
    setInterval(loadMonitoringData, 30000);
    
    // ÊØè10ÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÊÄßËÉΩÂõæË°®
    setInterval(() => loadPerformanceData('1h'), 10000);
}

function createIncident() {
    const form = document.getElementById('createIncidentForm');
    const formData = new FormData(form);
    
    fetch('/hosting/api/monitoring/incidents', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createIncidentModal')).hide();
            form.reset();
            loadIncidents();
            showToast(getLanguage() === 'en' ? 'Incident created successfully' : '‰∫ã‰ª∂ÂàõÂª∫ÊàêÂäü', 'success');
        } else {
            showToast(data.message || (getLanguage() === 'en' ? 'Creation failed' : 'ÂàõÂª∫Â§±Ë¥•'), 'error');
        }
    })
    .catch(error => {
        console.error('Error creating incident:', error);
        showToast(getLanguage() === 'en' ? 'Creation failed' : 'ÂàõÂª∫Â§±Ë¥•', 'error');
    });
}

function refreshMonitoring() {
    loadMonitoringData();
    showToast(getLanguage() === 'en' ? 'Monitoring data refreshed' : 'ÁõëÊéßÊï∞ÊçÆÂ∑≤Âà∑Êñ∞', 'success');
}

function getSeverityColor(severity) {
    const colorMap = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary'
    };
    return colorMap[severity] || 'secondary';
}

function getSeverityText(severity) {
    const language = getLanguage();
    const severityMap = {
        'critical': language === 'en' ? 'Critical' : '‰∏•Èáç',
        'high': language === 'en' ? 'High' : 'È´ò',
        'medium': language === 'en' ? 'Medium' : '‰∏≠Á≠â',
        'low': language === 'en' ? 'Low' : '‰Ωé'
    };
    return severityMap[severity] || severity;
}

function getStatusColor(status) {
    const colorMap = {
        'open': 'danger',
        'investigating': 'warning',
        'resolved': 'success',
        'closed': 'secondary'
    };
    return colorMap[status] || 'secondary';
}

function getStatusText(status) {
    const language = getLanguage();
    const statusMap = {
        'open': language === 'en' ? 'Open' : 'ÂºÄÊîæ',
        'investigating': language === 'en' ? 'Investigating' : 'Ë∞ÉÊü•‰∏≠',
        'resolved': language === 'en' ? 'Resolved' : 'Â∑≤Ëß£ÂÜ≥',
        'closed': language === 'en' ? 'Closed' : 'Â∑≤ÂÖ≥Èó≠'
    };
    return statusMap[status] || status;
}

function getLanguage() {
    return document.querySelector('meta[name="language"]').content;
}

function showToast(message, type) {
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// ÂÖ∂‰ªñËæÖÂä©ÂáΩÊï∞
function filterAlerts(filter) { /* ÂÆûÁé∞ÂëäË≠¶ËøáÊª§ */ }
function filterIncidents() { /* ÂÆûÁé∞‰∫ã‰ª∂ËøáÊª§ */ }
function searchIncidents() { /* ÂÆûÁé∞‰∫ã‰ª∂ÊêúÁ¥¢ */ }
function switchTimeRange(range) { /* ÂàáÊç¢Êó∂Èó¥ËåÉÂõ¥ */ }
function viewIncident(id) {
    const lang = getLanguage();
    const modal = new bootstrap.Modal(document.getElementById('incidentDetailModal'));
    const content = document.getElementById('incident-detail-content');
    
    content.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-warning"></div><p class="mt-2">' + (lang === 'en' ? 'Loading...' : 'Âä†ËΩΩ‰∏≠...') + '</p></div>';
    modal.show();
    
    fetch('/hosting/api/monitoring/incidents/' + id)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const inc = data.incident;
                const severityColors = {critical: 'danger', high: 'warning', medium: 'info', low: 'secondary'};
                const statusColors = {open: 'danger', investigating: 'warning', resolved: 'success', closed: 'secondary'};
                const severityLabels = {critical: lang === 'en' ? 'Critical' : '‰∏•Èáç', high: lang === 'en' ? 'High' : 'È´ò', medium: lang === 'en' ? 'Medium' : '‰∏≠Á≠â', low: lang === 'en' ? 'Low' : '‰Ωé'};
                const statusLabels = {open: lang === 'en' ? 'Open' : 'ÂºÄÊîæ', investigating: lang === 'en' ? 'Investigating' : 'Ë∞ÉÊü•‰∏≠', resolved: lang === 'en' ? 'Resolved' : 'Â∑≤Ëß£ÂÜ≥', closed: lang === 'en' ? 'Closed' : 'Â∑≤ÂÖ≥Èó≠'};
                
                let minersHtml = '';
                if (inc.affected_miners_details && inc.affected_miners_details.length > 0) {
                    minersHtml = inc.affected_miners_details.map(m => {
                        const onlineStatus = m.cgminer_online ? 
                            `<span class="badge bg-success">${lang === 'en' ? 'Online' : 'Âú®Á∫ø'}</span>` : 
                            `<span class="badge bg-danger">${lang === 'en' ? 'Offline' : 'Á¶ªÁ∫ø'}</span>`;
                        const hashratePercent = m.expected_hashrate ? Math.round((m.actual_hashrate / m.expected_hashrate) * 100) : 100;
                        const hashrateColor = hashratePercent >= 90 ? 'success' : hashratePercent >= 70 ? 'warning' : 'danger';
                        const tempColor = m.temperature_max > 90 ? 'danger' : m.temperature_max > 80 ? 'warning' : 'success';
                        
                        return `
                            <div class="card bg-dark border-secondary mb-2">
                                <div class="card-body p-2">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong class="text-warning">${m.serial_number}</strong>
                                        ${onlineStatus}
                                    </div>
                                    <div class="row small">
                                        <div class="col-6 mb-1">
                                            <span class="text-muted">${lang === 'en' ? 'Model' : 'ÂûãÂè∑'}:</span> ${m.model_name}
                                        </div>
                                        <div class="col-6 mb-1">
                                            <span class="text-muted">IP:</span> ${m.ip_address || '-'}
                                        </div>
                                        <div class="col-6 mb-1">
                                            <span class="text-muted">${lang === 'en' ? 'Rack' : 'Êú∫Êû∂'}:</span> ${m.rack_position || '-'}
                                        </div>
                                        <div class="col-6 mb-1">
                                            <span class="text-muted">${lang === 'en' ? 'Health' : 'ÂÅ•Â∫∑Â∫¶'}:</span> 
                                            <span class="text-${m.health_score >= 80 ? 'success' : m.health_score >= 50 ? 'warning' : 'danger'}">${m.health_score}%</span>
                                        </div>
                                    </div>
                                    <hr class="border-secondary my-2">
                                    <div class="row small">
                                        <div class="col-4 text-center">
                                            <div class="text-muted">${lang === 'en' ? 'Hashrate' : 'ÁÆóÂäõ'}</div>
                                            <div class="text-${hashrateColor}">${m.actual_hashrate} <small>TH/s</small></div>
                                            ${m.expected_hashrate ? `<small class="text-muted">/ ${m.expected_hashrate}</small>` : ''}
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="text-muted">${lang === 'en' ? 'Temp' : 'Ê∏©Â∫¶'}</div>
                                            <div class="text-${tempColor}">${m.temperature_max || '-'}¬∞C</div>
                                            <small class="text-muted">${lang === 'en' ? 'avg' : 'Âùá'}: ${m.temperature_avg || '-'}¬∞C</small>
                                        </div>
                                        <div class="col-4 text-center">
                                            <div class="text-muted">${lang === 'en' ? 'Power' : 'ÂäüÁéá'}</div>
                                            <div>${m.actual_power}W</div>
                                            <small class="text-muted">${lang === 'en' ? 'Uptime' : 'ËøêË°å'}: ${m.uptime || '-'}</small>
                                        </div>
                                    </div>
                                    <div class="row small mt-2">
                                        <div class="col-6">
                                            <span class="text-muted">${lang === 'en' ? 'Fan' : 'È£éÊâá'}:</span> ${m.fan_avg || '-'} RPM
                                        </div>
                                        <div class="col-6">
                                            <span class="text-muted">${lang === 'en' ? 'Reject' : 'ÊãíÁªùÁéá'}:</span> ${m.reject_rate}%
                                        </div>
                                    </div>
                                    ${m.last_seen ? `<div class="small text-muted mt-1">${lang === 'en' ? 'Last seen' : 'ÊúÄÂêéÂú®Á∫ø'}: ${m.last_seen}</div>` : ''}
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    minersHtml = `<div class="text-muted small">${lang === 'en' ? 'No miner data available' : 'Êó†ÁüøÊú∫Êï∞ÊçÆ'}</div>`;
                }
                
                let commandsHtml = '';
                if (inc.recent_commands && inc.recent_commands.length > 0) {
                    commandsHtml = inc.recent_commands.map(cmd => `
                        <div class="d-flex justify-content-between small mb-1">
                            <span>${cmd.command_type}</span>
                            <span class="badge bg-${cmd.status === 'completed' ? 'success' : cmd.status === 'failed' ? 'danger' : 'secondary'}">${cmd.status}</span>
                            <span class="text-muted">${cmd.created_at}</span>
                        </div>
                    `).join('');
                } else {
                    commandsHtml = `<div class="text-muted small">${lang === 'en' ? 'No recent commands' : 'Êó†ÊúÄËøëÂëΩ‰ª§'}</div>`;
                }
                
                let alertsHtml = '';
                if (inc.recent_site_alerts && inc.recent_site_alerts.length > 0) {
                    alertsHtml = inc.recent_site_alerts.map(a => `
                        <div class="d-flex justify-content-between small mb-1">
                            <span class="text-truncate" style="max-width: 150px;">${a.title}</span>
                            <span class="badge bg-${severityColors[a.severity] || 'secondary'}">${a.severity}</span>
                            <span class="text-muted">${a.created_at}</span>
                        </div>
                    `).join('');
                } else {
                    alertsHtml = `<div class="text-muted small">${lang === 'en' ? 'No other alerts' : 'Êó†ÂÖ∂‰ªñÂëäË≠¶'}</div>`;
                }
                
                content.innerHTML = `
                    <div class="row">
                        <div class="col-md-8">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="text-warning mb-0">${inc.title}</h5>
                                <button class="btn btn-sm btn-outline-info" onclick="triggerAIDiagnosis(${inc.site_id}, ${inc.affected_miners_details && inc.affected_miners_details[0] ? inc.affected_miners_details[0].id : 'null'}, '${inc.title}')">
                                    ü§ñ ${lang === 'en' ? 'AI Diagnose' : 'AIËØäÊñ≠'}
                                </button>
                            </div>
                            <p class="text-muted">${inc.description || (lang === 'en' ? 'No description' : 'Êó†ÊèèËø∞')}</p>
                            <hr class="border-secondary">
                            <div class="row mb-3">
                                <div class="col-3">
                                    <small class="text-muted">${lang === 'en' ? 'Severity' : '‰∏•ÈáçÁ®ãÂ∫¶'}</small>
                                    <div><span class="badge bg-${severityColors[inc.severity] || 'secondary'}">${severityLabels[inc.severity] || inc.severity}</span></div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">${lang === 'en' ? 'Status' : 'Áä∂ÊÄÅ'}</small>
                                    <div><span class="badge bg-${statusColors[inc.status] || 'secondary'}">${statusLabels[inc.status] || inc.status}</span></div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">${lang === 'en' ? 'Site' : 'Á´ôÁÇπ'}</small>
                                    <div>${inc.site_name || 'Global'}</div>
                                    ${inc.site_location ? `<small class="text-muted">${inc.site_location}</small>` : ''}
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">${lang === 'en' ? 'Assigned To' : 'ÊåáÊ¥æÁªô'}</small>
                                    <div>${inc.assigned_to_name || (lang === 'en' ? 'Unassigned' : 'Êú™ÊåáÊ¥æ')}</div>
                                </div>
                            </div>
                            
                            <h6 class="text-info mt-4 mb-2">üîß ${lang === 'en' ? 'Affected Miners' : 'ÂèóÂΩ±ÂìçÁüøÊú∫'}</h6>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${minersHtml}
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-secondary mb-3">
                                <div class="card-body">
                                    <h6 class="text-info mb-3">‚è±Ô∏è ${lang === 'en' ? 'Timeline' : 'Êó∂Èó¥Á∫ø'}</h6>
                                    <div class="mb-2">
                                        <small class="text-muted">${lang === 'en' ? 'Created' : 'ÂàõÂª∫Êó∂Èó¥'}</small>
                                        <div>${inc.created_at || '-'}</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">${lang === 'en' ? 'First Response' : 'È¶ñÊ¨°ÂìçÂ∫î'}</small>
                                        <div>${inc.first_response_at || '-'}</div>
                                    </div>
                                    <div class="mb-2">
                                        <small class="text-muted">${lang === 'en' ? 'Resolved' : 'Ëß£ÂÜ≥Êó∂Èó¥'}</small>
                                        <div>${inc.resolved_at || '-'}</div>
                                    </div>
                                    <div>
                                        <small class="text-muted">${lang === 'en' ? 'Duration' : 'ÊåÅÁª≠Êó∂Èó¥'}</small>
                                        <div>${inc.duration || '-'}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card bg-secondary mb-3">
                                <div class="card-body">
                                    <h6 class="text-info mb-2">üì° ${lang === 'en' ? 'Recent Commands' : 'ÊúÄËøëÂëΩ‰ª§'}</h6>
                                    ${commandsHtml}
                                </div>
                            </div>
                            
                            <div class="card bg-secondary">
                                <div class="card-body">
                                    <h6 class="text-info mb-2">‚ö†Ô∏è ${lang === 'en' ? 'Site Alerts' : 'Á´ôÁÇπÂëäË≠¶'}</h6>
                                    ${alertsHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                currentIncidentId = id;
            } else {
                content.innerHTML = '<div class="alert alert-danger">' + (data.error || (lang === 'en' ? 'Failed to load' : 'Âä†ËΩΩÂ§±Ë¥•')) + '</div>';
            }
        })
        .catch(err => {
            content.innerHTML = '<div class="alert alert-danger">' + (lang === 'en' ? 'Network error' : 'ÁΩëÁªúÈîôËØØ') + ': ' + err.message + '</div>';
        });
}

function editIncident(id) {
    const lang = getLanguage();
    fetch('/hosting/api/monitoring/incidents/' + id)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const inc = data.incident;
                currentIncidentId = id;
                
                const statusOptions = [
                    {value: 'open', label: lang === 'en' ? 'Open' : 'ÂºÄÊîæ'},
                    {value: 'investigating', label: lang === 'en' ? 'Investigating' : 'Ë∞ÉÊü•‰∏≠'},
                    {value: 'resolved', label: lang === 'en' ? 'Resolved' : 'Â∑≤Ëß£ÂÜ≥'},
                    {value: 'closed', label: lang === 'en' ? 'Closed' : 'Â∑≤ÂÖ≥Èó≠'}
                ];
                
                const modalHtml = `
                    <div class="modal fade" id="editIncidentModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content bg-dark">
                                <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                                    <h5 class="modal-title">${lang === 'en' ? 'Edit Incident' : 'ÁºñËæë‰∫ã‰ª∂'}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editIncidentForm">
                                        <div class="mb-3">
                                            <label class="form-label">${lang === 'en' ? 'Title' : 'Ê†áÈ¢ò'}</label>
                                            <input type="text" class="form-control bg-secondary text-white border-0" name="title" value="${inc.title}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">${lang === 'en' ? 'Status' : 'Áä∂ÊÄÅ'}</label>
                                            <select class="form-select bg-secondary text-white border-0" name="status">
                                                ${statusOptions.map(opt => `<option value="${opt.value}" ${opt.value === inc.status ? 'selected' : ''}>${opt.label}</option>`).join('')}
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">${lang === 'en' ? 'Description' : 'ÊèèËø∞'}</label>
                                            <textarea class="form-control bg-secondary text-white border-0" name="description" rows="3">${inc.description || ''}</textarea>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">${lang === 'en' ? 'Cancel' : 'ÂèñÊ∂à'}</button>
                                    <button type="button" class="btn btn-warning" onclick="saveIncident()">${lang === 'en' ? 'Save' : '‰øùÂ≠ò'}</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                let existingModal = document.getElementById('editIncidentModal');
                if (existingModal) existingModal.remove();
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                const modal = new bootstrap.Modal(document.getElementById('editIncidentModal'));
                modal.show();
            } else {
                showToast(data.error || (lang === 'en' ? 'Failed to load' : 'Âä†ËΩΩÂ§±Ë¥•'), 'error');
            }
        })
        .catch(err => {
            showToast((lang === 'en' ? 'Network error' : 'ÁΩëÁªúÈîôËØØ') + ': ' + err.message, 'error');
        });
}

function saveIncident() {
    const lang = getLanguage();
    const form = document.getElementById('editIncidentForm');
    const formData = new FormData(form);
    const data = {};
    formData.forEach((value, key) => data[key] = value);
    
    fetch('/hosting/api/monitoring/incidents/' + currentIncidentId, {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
    })
    .then(r => r.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('editIncidentModal')).hide();
            loadIncidents();
            showToast(lang === 'en' ? 'Incident updated successfully' : '‰∫ã‰ª∂Êõ¥Êñ∞ÊàêÂäü', 'success');
        } else {
            showToast(result.error || (lang === 'en' ? 'Update failed' : 'Êõ¥Êñ∞Â§±Ë¥•'), 'error');
        }
    })
    .catch(err => {
        showToast((lang === 'en' ? 'Network error' : 'ÁΩëÁªúÈîôËØØ') + ': ' + err.message, 'error');
    });
}
function acknowledgeAlert(id) { /* Á°ÆËÆ§ÂëäË≠¶ */ }
function loadPerformanceData(range) { /* Âä†ËΩΩÊÄßËÉΩÊï∞ÊçÆ */ }
function getIncidentFilters() { return {}; /* Ëé∑Âèñ‰∫ã‰ª∂ËøáÊª§Âô® */ }
function updatePagination(pagination) { /* Êõ¥Êñ∞ÂàÜÈ°µ */ }
function exportIncidents() { /* ÂØºÂá∫‰∫ã‰ª∂ */ }
function updateIncidentStatus() { /* Êõ¥Êñ∞‰∫ã‰ª∂Áä∂ÊÄÅ */ }

function triggerAIDiagnosis(siteId, minerId, incidentTitle) {
    let alertType = 'offline';
    const title = (incidentTitle || '').toLowerCase();
    if (title.includes('temp') || title.includes('temperature') || title.includes('ÁÉ≠') || title.includes('Ê∏©Â∫¶')) {
        alertType = 'temperature';
    } else if (title.includes('hash') || title.includes('ÁÆóÂäõ')) {
        alertType = 'hashrate';
    } else if (title.includes('offline') || title.includes('Á¶ªÁ∫ø')) {
        alertType = 'offline';
    } else if (title.includes('power') || title.includes('ÂäüÁéá') || title.includes('Áîµ')) {
        alertType = 'power';
    }
    openAIDiagnosis(null, alertType, minerId, siteId);
}

function openAIDiagnosis(alertId, alertType, minerId, siteId) {
    if (!minerId || !siteId) {
        alert(getLanguage() === 'en' ? 'AI diagnosis requires miner and site information' : 'AIËØäÊñ≠ÈúÄË¶ÅÁüøÊú∫ÂíåÁ´ôÁÇπ‰ø°ÊÅØ');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('aiDiagnosisModal'));
    modal.show();
    document.getElementById('ai-diagnosis-content').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">' + (getLanguage() === 'en' ? 'Analyzing...' : 'ÂàÜÊûê‰∏≠...') + '</p></div>';
    
    fetch('/api/v1/ai/diagnose/alert', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            site_id: siteId,
            miner_id: minerId,
            alert_type: alertType
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            renderAIDiagnosis(data.diagnosis);
        } else {
            document.getElementById('ai-diagnosis-content').innerHTML = '<div class="alert alert-danger">' + (data.error || 'Diagnosis failed') + '</div>';
        }
    })
    .catch(err => {
        document.getElementById('ai-diagnosis-content').innerHTML = '<div class="alert alert-danger">Network error: ' + err.message + '</div>';
    });
}

function renderAIDiagnosis(diagnosis) {
    const lang = getLanguage();
    let html = '<div class="mb-3"><strong>' + (lang === 'en' ? 'Alert' : 'ÂëäË≠¶') + ':</strong> ' + (diagnosis.alert_type || '-') + '</div>';
    html += '<h6 class="text-info mb-3"><i class="bi bi-lightbulb me-2"></i>' + (lang === 'en' ? 'Top 3 Hypotheses' : 'Top3 Ê†πÂõ†ÂÅáËÆæ') + '</h6>';
    
    if (diagnosis.hypotheses && diagnosis.hypotheses.length > 0) {
        diagnosis.hypotheses.forEach((h, i) => {
            const riskBadge = h.risk_level === 'high' ? 'danger' : (h.risk_level === 'medium' ? 'warning' : 'info');
            html += '<div class="card bg-secondary mb-3"><div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-center mb-2">';
            html += '<h6 class="text-warning mb-0">#' + (i+1) + ' ' + (lang === 'en' ? h.cause : h.cause_zh) + '</h6>';
            html += '<span class="badge bg-' + (h.confidence > 0.7 ? 'success' : h.confidence > 0.4 ? 'warning' : 'secondary') + '">' + Math.round(h.confidence * 100) + '%</span>';
            html += '</div>';
            if (h.evidence && h.evidence.length > 0) {
                html += '<div class="mb-2"><small class="text-muted">' + (lang === 'en' ? 'Evidence:' : 'ËØÅÊçÆ:') + '</small><ul class="mb-0">';
                h.evidence.forEach(e => {
                    const desc = lang === 'en' ? e.description : e.description_zh;
                    const valueInfo = e.value !== null && e.value !== undefined ? ' (' + e.metric + ': ' + e.value + (e.threshold ? ' / ' + (lang === 'en' ? 'threshold' : 'ÈòàÂÄº') + ': ' + e.threshold : '') + ')' : '';
                    html += '<li><small>' + desc + valueInfo + '</small></li>';
                });
                html += '</ul></div>';
            }
            if (h.suggested_actions && h.suggested_actions.length > 0) {
                html += '<div><small class="text-muted">' + (lang === 'en' ? 'Suggested Actions:' : 'Âª∫ËÆÆÂä®‰Ωú:') + '</small><ul class="mb-0">';
                h.suggested_actions.forEach(a => {
                    const actionText = lang === 'en' ? a.action : a.action_zh;
                    const reasonText = lang === 'en' ? a.reason : a.reason_zh;
                    html += '<li><small class="text-success">' + actionText + '</small>';
                    if (reasonText) html += ' <small class="text-muted">- ' + reasonText + '</small>';
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            html += '</div></div>';
        });
    } else {
        html += '<div class="alert alert-secondary">' + (lang === 'en' ? 'No hypotheses generated' : 'Êú™ÁîüÊàêÂÅáËÆæ') + '</div>';
    }
    
    if (diagnosis.summary_zh || diagnosis.summary) {
        html += '<div class="alert alert-info mt-3"><strong>' + (lang === 'en' ? 'Summary:' : 'ÊÄªÁªì:') + '</strong> ' + (lang === 'en' ? diagnosis.summary : diagnosis.summary_zh) + '</div>';
    }
    
    document.getElementById('ai-diagnosis-content').innerHTML = html;
}
</script>
{% endblock %}