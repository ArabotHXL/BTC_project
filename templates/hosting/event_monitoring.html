{% extends "hosting/hosting_base.html" %}

{% block page_title %}{% if current_lang == 'en' %}Event Monitoring{% else %}äº‹ä»¶ç›‘æ§{% endif %}{% endblock %}
{% block page_subtitle %}{% if current_lang == 'en' %}Real-time monitoring and incident management{% else %}å®æ—¶ç›‘æ§å’Œäº‹ä»¶ç®¡ç†{% endif %}{% endblock %}

{% block header_actions %}
{{ super() }}
<div class="btn-group ms-3" role="group">
    <button class="btn btn-hosting-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createIncidentModal">
        <i class="bi bi-plus-circle me-1"></i>{% if current_lang == 'en' %}New Incident{% else %}æ–°å»ºäº‹ä»¶{% endif %}
    </button>
    <button class="btn btn-hosting-secondary btn-sm" onclick="refreshMonitoring()">
        <i class="bi bi-arrow-clockwise me-1"></i>{% if current_lang == 'en' %}Refresh{% else %}åˆ·æ–°{% endif %}
    </button>
</div>
{% endblock %}

{% block content %}

<!-- ç›‘æ§æ¦‚è§ˆç»Ÿè®¡ -->
<div class="hosting-stats-grid">
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="active-alerts">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}Active Alerts{% else %}æ´»è·ƒå‘Šè­¦{% endif %}</div>
        <i class="bi bi-exclamation-triangle hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-incidents">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}Total Incidents{% else %}æ€»äº‹ä»¶æ•°{% endif %}</div>
        <i class="bi bi-shield-exclamation hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="response-time">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}Avg Response{% else %}å¹³å‡å“åº”{% endif %}</div>
        <i class="bi bi-clock hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="uptime-percentage">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}System Uptime{% else %}ç³»ç»Ÿå¯ç”¨ç‡{% endif %}</div>
        <i class="bi bi-check-circle hosting-stat-icon"></i>
    </div>
</div>

<!-- å®æ—¶å‘Šè­¦ -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-bell me-2"></i>{% if current_lang == 'en' %}Real-time Alerts{% else %}å®æ—¶å‘Šè­¦{% endif %}
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-hosting-outline btn-sm active" onclick="filterAlerts('all')">{% if current_lang == 'en' %}All{% else %}å…¨éƒ¨{% endif %}</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterAlerts('critical')">{% if current_lang == 'en' %}Critical{% else %}ä¸¥é‡{% endif %}</button>
            <button class="btn btn-hosting-outline btn-sm" onclick="filterAlerts('warning')">{% if current_lang == 'en' %}Warning{% else %}è­¦å‘Š{% endif %}</button>
        </div>
    </div>
    <div class="hosting-card-body">
        <div class="row g-3" id="alerts-grid">
            <!-- å‘Šè­¦å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
</div>

<!-- äº‹ä»¶ç®¡ç† -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-calendar-event me-2"></i>{% if current_lang == 'en' %}Incident Management{% else %}äº‹ä»¶ç®¡ç†{% endif %}
        </h5>
        <div class="btn-group" role="group">
            <button class="btn btn-hosting-secondary btn-sm" onclick="exportIncidents()">
                <i class="bi bi-download me-1"></i>{% if current_lang == 'en' %}Export{% else %}å¯¼å‡º{% endif %}
            </button>
        </div>
    </div>
    <div class="hosting-card-body">
        <!-- ç­›é€‰é€‰é¡¹ -->
        <div class="row g-3 mb-4">
            <div class="col-md-3">
                <select class="form-select" id="severity-filter" onchange="filterIncidents()">
                    <option value="">{% if current_lang == 'en' %}All Severities{% else %}å…¨éƒ¨ä¸¥é‡çº§åˆ«{% endif %}</option>
                    <option value="critical">{% if current_lang == 'en' %}Critical{% else %}ä¸¥é‡{% endif %}</option>
                    <option value="high">{% if current_lang == 'en' %}High{% else %}é«˜{% endif %}</option>
                    <option value="medium">{% if current_lang == 'en' %}Medium{% else %}ä¸­ç­‰{% endif %}</option>
                    <option value="low">{% if current_lang == 'en' %}Low{% else %}ä½{% endif %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="status-filter" onchange="filterIncidents()">
                    <option value="">{% if current_lang == 'en' %}All Statuses{% else %}å…¨éƒ¨çŠ¶æ€{% endif %}</option>
                    <option value="open">{% if current_lang == 'en' %}Open{% else %}å¼€æ”¾{% endif %}</option>
                    <option value="investigating">{% if current_lang == 'en' %}Investigating{% else %}è°ƒæŸ¥ä¸­{% endif %}</option>
                    <option value="resolved">{% if current_lang == 'en' %}Resolved{% else %}å·²è§£å†³{% endif %}</option>
                    <option value="closed">{% if current_lang == 'en' %}Closed{% else %}å·²å…³é—­{% endif %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" id="site-filter" onchange="filterIncidents()">
                    <option value="">{% if current_lang == 'en' %}All Sites{% else %}å…¨éƒ¨ç«™ç‚¹{% endif %}</option>
                    <!-- ç«™ç‚¹é€‰é¡¹é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" id="search-incidents" placeholder="{% if current_lang == 'en' %}Search incidents...{% else %}æœç´¢äº‹ä»¶...{% endif %}" onkeyup="searchIncidents()">
            </div>
        </div>
        
        <!-- äº‹ä»¶åˆ—è¡¨ -->
        <div class="hosting-table">
            <table class="table table-hover" id="incidents-table">
                <thead>
                    <tr>
                        <th>{% if current_lang == 'en' %}ID{% else %}ç¼–å·{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Title{% else %}æ ‡é¢˜{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Severity{% else %}ä¸¥é‡çº§åˆ«{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Status{% else %}çŠ¶æ€{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Site{% else %}ç«™ç‚¹{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Created{% else %}åˆ›å»ºæ—¶é—´{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Duration{% else %}æŒç»­æ—¶é—´{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Actions{% else %}æ“ä½œ{% endif %}</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- äº‹ä»¶æ•°æ®é€šè¿‡JavaScriptåŠ è½½ -->
                </tbody>
            </table>
        </div>
        
        <!-- åˆ†é¡µ -->
        <nav aria-label="Incidents pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="incidents-pagination">
                <!-- åˆ†é¡µæŒ‰é’®é€šè¿‡JavaScriptç”Ÿæˆ -->
            </ul>
        </nav>
    </div>
</div>

<!-- ç³»ç»Ÿç›‘æ§å›¾è¡¨ -->
<div class="row">
    <div class="col-lg-8">
        <div class="hosting-card">
            <div class="hosting-card-header">
                <h5 class="hosting-card-title">
                    <i class="bi bi-activity me-2"></i>{% if current_lang == 'en' %}System Performance{% else %}ç³»ç»Ÿæ€§èƒ½{% endif %}
                </h5>
                <div class="btn-group" role="group">
                    <button class="btn btn-hosting-outline btn-sm active" onclick="switchTimeRange('1h')">1{% if current_lang == 'en' %}H{% else %}å°æ—¶{% endif %}</button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('6h')">6{% if current_lang == 'en' %}H{% else %}å°æ—¶{% endif %}</button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('24h')">24{% if current_lang == 'en' %}H{% else %}å°æ—¶{% endif %}</button>
                    <button class="btn btn-hosting-outline btn-sm" onclick="switchTimeRange('7d')">7{% if current_lang == 'en' %}D{% else %}å¤©{% endif %}</button>
                </div>
            </div>
            <div class="hosting-card-body">
                <canvas id="performanceChart" height="300"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="hosting-card">
            <div class="hosting-card-header">
                <h5 class="hosting-card-title">
                    <i class="bi bi-speedometer2 me-2"></i>{% if current_lang == 'en' %}Key Metrics{% else %}å…³é”®æŒ‡æ ‡{% endif %}
                </h5>
            </div>
            <div class="hosting-card-body">
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">{% if current_lang == 'en' %}CPU Usage{% else %}CPUä½¿ç”¨ç‡{% endif %}</span>
                        <span class="fw-bold" id="cpu-usage">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-warning" role="progressbar" id="cpu-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">{% if current_lang == 'en' %}Memory Usage{% else %}å†…å­˜ä½¿ç”¨ç‡{% endif %}</span>
                        <span class="fw-bold" id="memory-usage">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-info" role="progressbar" id="memory-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item mb-4">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">{% if current_lang == 'en' %}Network I/O{% else %}ç½‘ç»œI/O{% endif %}</span>
                        <span class="fw-bold" id="network-io">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" id="network-progress" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="metric-item">
                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-muted">{% if current_lang == 'en' %}Error Rate{% else %}é”™è¯¯ç‡{% endif %}</span>
                        <span class="fw-bold" id="error-rate">--</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-danger" role="progressbar" id="error-progress" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ›å»ºäº‹ä»¶æ¨¡æ€æ¡† -->
<div class="modal fade" id="createIncidentModal" tabindex="-1" aria-labelledby="createIncidentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="createIncidentModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    {% if current_lang == 'en' %}Create New Incident{% else %}åˆ›å»ºæ–°äº‹ä»¶{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="createIncidentForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="incident-title" class="form-label">
                                {% if current_lang == 'en' %}Title{% else %}æ ‡é¢˜{% endif %} <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="incident-title" name="title" required>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-severity" class="form-label">
                                {% if current_lang == 'en' %}Severity{% else %}ä¸¥é‡çº§åˆ«{% endif %} <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" id="incident-severity" name="severity" required>
                                <option value="">{% if current_lang == 'en' %}Select Severity{% else %}é€‰æ‹©çº§åˆ«{% endif %}</option>
                                <option value="critical">{% if current_lang == 'en' %}Critical{% else %}ä¸¥é‡{% endif %}</option>
                                <option value="high">{% if current_lang == 'en' %}High{% else %}é«˜{% endif %}</option>
                                <option value="medium">{% if current_lang == 'en' %}Medium{% else %}ä¸­ç­‰{% endif %}</option>
                                <option value="low">{% if current_lang == 'en' %}Low{% else %}ä½{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-site" class="form-label">
                                {% if current_lang == 'en' %}Affected Site{% else %}å—å½±å“ç«™ç‚¹{% endif %}
                            </label>
                            <select class="form-select" id="incident-site" name="site_id">
                                <option value="">{% if current_lang == 'en' %}Select Site{% else %}é€‰æ‹©ç«™ç‚¹{% endif %}</option>
                                <!-- ç«™ç‚¹é€‰é¡¹é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="incident-category" class="form-label">
                                {% if current_lang == 'en' %}Category{% else %}ç±»åˆ«{% endif %}
                            </label>
                            <select class="form-select" id="incident-category" name="category">
                                <option value="">{% if current_lang == 'en' %}Select Category{% else %}é€‰æ‹©ç±»åˆ«{% endif %}</option>
                                <option value="hardware">{% if current_lang == 'en' %}Hardware{% else %}ç¡¬ä»¶{% endif %}</option>
                                <option value="network">{% if current_lang == 'en' %}Network{% else %}ç½‘ç»œ{% endif %}</option>
                                <option value="power">{% if current_lang == 'en' %}Power{% else %}ç”µåŠ›{% endif %}</option>
                                <option value="cooling">{% if current_lang == 'en' %}Cooling{% else %}å†·å´{% endif %}</option>
                                <option value="security">{% if current_lang == 'en' %}Security{% else %}å®‰å…¨{% endif %}</option>
                                <option value="other">{% if current_lang == 'en' %}Other{% else %}å…¶ä»–{% endif %}</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label for="incident-description" class="form-label">
                                {% if current_lang == 'en' %}Description{% else %}æè¿°{% endif %} <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control" id="incident-description" name="description" rows="4" required></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal">
                    {% if current_lang == 'en' %}Cancel{% else %}å–æ¶ˆ{% endif %}
                </button>
                <button type="button" class="btn btn-hosting-primary" onclick="createIncident()">
                    {% if current_lang == 'en' %}Create Incident{% else %}åˆ›å»ºäº‹ä»¶{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- äº‹ä»¶è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="incidentDetailModal" tabindex="-1" aria-labelledby="incidentDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="incidentDetailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    {% if current_lang == 'en' %}Incident Details{% else %}äº‹ä»¶è¯¦æƒ…{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="incident-detail-content">
                <!-- äº‹ä»¶è¯¦æƒ…å†…å®¹å°†åœ¨è¿™é‡ŒåŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal">
                    {% if current_lang == 'en' %}Close{% else %}å…³é—­{% endif %}
                </button>
                <button type="button" class="btn btn-hosting-primary" onclick="updateIncidentStatus()">
                    {% if current_lang == 'en' %}Update Status{% else %}æ›´æ–°çŠ¶æ€{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- AI è¯Šæ–­ç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="aiDiagnosisModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;">
                <h5 class="modal-title"><i class="bi bi-robot me-2"></i>AI Diagnosis / AIè¯Šæ–­</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="ai-diagnosis-content">
                <div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">Analyzing... / åˆ†æä¸­...</p></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMonitoringData();
    loadSiteOptions();
    initPerformanceChart();
    setupRealTimeUpdates();
});

let currentIncidentId = null;
let performanceChart = null;

function loadMonitoringData() {
    // åŠ è½½ç›‘æ§æ¦‚è§ˆæ•°æ®
    fetch('/hosting/api/monitoring/overview')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateMonitoringStats(data.stats);
                updateAlertsGrid(data.alerts);
                updateMetrics(data.metrics);
            }
        })
        .catch(error => {
            console.error('Error loading monitoring data:', error);
        });
    
    // åŠ è½½äº‹ä»¶åˆ—è¡¨
    loadIncidents();
}

function updateMonitoringStats(stats) {
    document.getElementById('active-alerts').textContent = stats.active_alerts || 0;
    document.getElementById('total-incidents').textContent = stats.total_incidents || 0;
    document.getElementById('response-time').textContent = `${stats.avg_response_time || 0}min`;
    document.getElementById('uptime-percentage').textContent = `${stats.uptime_percentage || 0}%`;
}

function updateAlertsGrid(alerts) {
    const grid = document.getElementById('alerts-grid');
    grid.innerHTML = '';
    
    if (alerts.length === 0) {
        grid.innerHTML = `
            <div class="col-12 text-center text-muted py-4">
                <i class="bi bi-check-circle fs-1 mb-2 d-block text-success"></i>
                ${getLanguage() === 'en' ? 'No active alerts' : 'æ— æ´»è·ƒå‘Šè­¦'}
            </div>
        `;
        return;
    }
    
    alerts.forEach(alert => {
        const alertCard = `
            <div class="col-md-4 alert-card" data-severity="${alert.severity}">
                <div class="hosting-card border-start border-${getSeverityColor(alert.severity)} border-3">
                    <div class="hosting-card-body">
                        <div class="d-flex justify-content-between mb-2">
                            <span class="badge bg-${getSeverityColor(alert.severity)}">${getSeverityText(alert.severity)}</span>
                            <small class="text-muted">${alert.created_at}</small>
                        </div>
                        <h6 class="fw-bold mb-2">${alert.title}</h6>
                        <p class="text-muted mb-2">${alert.description}</p>
                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <small class="text-muted">${alert.site_name || 'Global'}</small>
                            <div class="btn-group">
                                <button class="btn btn-outline-success btn-sm px-3" onclick="acknowledgeAlert(${alert.id})" title="${getLanguage() === 'en' ? 'Acknowledge Alert' : 'ç¡®è®¤å‘Šè­¦'}">
                                    <span style="font-size: 14px;">âœ“</span> ${getLanguage() === 'en' ? 'Ack' : 'ç¡®è®¤'}
                                </button>
                                ${(alert.miner_id && alert.site_id) ? 
                                    `<button class="btn btn-outline-info btn-sm px-3" onclick="openAIDiagnosis('${alert.id}', '${alert.alert_type || 'offline'}', '${alert.miner_id}', ${alert.site_id})" title="${getLanguage() === 'en' ? 'AI Diagnosis' : 'AIæ™ºèƒ½è¯Šæ–­'}">
                                        <span style="font-size: 14px;">ğŸ¤–</span> AI
                                    </button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        grid.insertAdjacentHTML('beforeend', alertCard);
    });
}

function updateMetrics(metrics) {
    document.getElementById('cpu-usage').textContent = `${metrics.cpu_usage}%`;
    document.getElementById('cpu-progress').style.width = `${metrics.cpu_usage}%`;
    
    document.getElementById('memory-usage').textContent = `${metrics.memory_usage}%`;
    document.getElementById('memory-progress').style.width = `${metrics.memory_usage}%`;
    
    document.getElementById('network-io').textContent = `${metrics.network_io} MB/s`;
    document.getElementById('network-progress').style.width = `${Math.min(metrics.network_io * 10, 100)}%`;
    
    document.getElementById('error-rate').textContent = `${metrics.error_rate}%`;
    document.getElementById('error-progress').style.width = `${metrics.error_rate}%`;
}

function loadIncidents() {
    const filters = getIncidentFilters();
    const queryParams = new URLSearchParams(filters);
    
    fetch(`/hosting/api/monitoring/incidents?${queryParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayIncidents(data.incidents);
                updatePagination(data.pagination);
            }
        })
        .catch(error => {
            console.error('Error loading incidents:', error);
        });
}

function displayIncidents(incidents) {
    const tbody = document.querySelector('#incidents-table tbody');
    tbody.innerHTML = '';
    
    if (incidents.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center text-muted py-4">
                    <i class="bi bi-shield-check fs-1 mb-2 d-block text-success"></i>
                    ${getLanguage() === 'en' ? 'No incidents found' : 'æœªæ‰¾åˆ°äº‹ä»¶'}
                </td>
            </tr>
        `;
        return;
    }
    
    incidents.forEach(incident => {
        const row = `
            <tr>
                <td><strong>#${incident.id}</strong></td>
                <td>${incident.title}</td>
                <td><span class="badge bg-${getSeverityColor(incident.severity)}">${getSeverityText(incident.severity)}</span></td>
                <td><span class="badge bg-${getStatusColor(incident.status)}">${getStatusText(incident.status)}</span></td>
                <td>${incident.site_name || 'Global'}</td>
                <td>${incident.created_at}</td>
                <td>${incident.duration || '--'}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-hosting-outline" onclick="viewIncident(${incident.id})">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-hosting-outline" onclick="editIncident(${incident.id})">
                            <i class="bi bi-pencil"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
}

function loadSiteOptions() {
    fetch('/hosting/api/sites')
        .then(response => response.json())
        .then(data => {
            const siteSelects = ['site-filter', 'incident-site'];
            siteSelects.forEach(selectId => {
                const select = document.getElementById(selectId);
                data.sites.forEach(site => {
                    const option = `<option value="${site.id}">${site.name} - ${site.location}</option>`;
                    select.insertAdjacentHTML('beforeend', option);
                });
            });
        });
}

function initPerformanceChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    performanceChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: getLanguage() === 'en' ? 'Response Time (ms)' : 'å“åº”æ—¶é—´ (ms)',
                data: [],
                borderColor: '#f7931e',
                backgroundColor: 'rgba(247, 147, 30, 0.1)',
                tension: 0.4,
                fill: true
            }, {
                label: getLanguage() === 'en' ? 'Error Count' : 'é”™è¯¯æ•°é‡',
                data: [],
                borderColor: '#dc3545',
                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    labels: { color: '#ffffff' }
                }
            },
            scales: {
                x: {
                    ticks: { color: '#adb5bd' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    ticks: { color: '#adb5bd' },
                    grid: { color: 'rgba(255, 255, 255, 0.1)' }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    ticks: { color: '#adb5bd' },
                    grid: { drawOnChartArea: false }
                }
            }
        }
    });
    
    loadPerformanceData('1h');
}

function setupRealTimeUpdates() {
    // æ¯30ç§’æ›´æ–°ä¸€æ¬¡ç›‘æ§æ•°æ®
    setInterval(loadMonitoringData, 30000);
    
    // æ¯10ç§’æ›´æ–°ä¸€æ¬¡æ€§èƒ½å›¾è¡¨
    setInterval(() => loadPerformanceData('1h'), 10000);
}

function createIncident() {
    const form = document.getElementById('createIncidentForm');
    const formData = new FormData(form);
    
    fetch('/hosting/api/monitoring/incidents', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('createIncidentModal')).hide();
            form.reset();
            loadIncidents();
            showToast(getLanguage() === 'en' ? 'Incident created successfully' : 'äº‹ä»¶åˆ›å»ºæˆåŠŸ', 'success');
        } else {
            showToast(data.message || (getLanguage() === 'en' ? 'Creation failed' : 'åˆ›å»ºå¤±è´¥'), 'error');
        }
    })
    .catch(error => {
        console.error('Error creating incident:', error);
        showToast(getLanguage() === 'en' ? 'Creation failed' : 'åˆ›å»ºå¤±è´¥', 'error');
    });
}

function refreshMonitoring() {
    loadMonitoringData();
    showToast(getLanguage() === 'en' ? 'Monitoring data refreshed' : 'ç›‘æ§æ•°æ®å·²åˆ·æ–°', 'success');
}

function getSeverityColor(severity) {
    const colorMap = {
        'critical': 'danger',
        'high': 'warning',
        'medium': 'info',
        'low': 'secondary'
    };
    return colorMap[severity] || 'secondary';
}

function getSeverityText(severity) {
    const language = getLanguage();
    const severityMap = {
        'critical': language === 'en' ? 'Critical' : 'ä¸¥é‡',
        'high': language === 'en' ? 'High' : 'é«˜',
        'medium': language === 'en' ? 'Medium' : 'ä¸­ç­‰',
        'low': language === 'en' ? 'Low' : 'ä½'
    };
    return severityMap[severity] || severity;
}

function getStatusColor(status) {
    const colorMap = {
        'open': 'danger',
        'investigating': 'warning',
        'resolved': 'success',
        'closed': 'secondary'
    };
    return colorMap[status] || 'secondary';
}

function getStatusText(status) {
    const language = getLanguage();
    const statusMap = {
        'open': language === 'en' ? 'Open' : 'å¼€æ”¾',
        'investigating': language === 'en' ? 'Investigating' : 'è°ƒæŸ¥ä¸­',
        'resolved': language === 'en' ? 'Resolved' : 'å·²è§£å†³',
        'closed': language === 'en' ? 'Closed' : 'å·²å…³é—­'
    };
    return statusMap[status] || status;
}

function getLanguage() {
    return document.querySelector('meta[name="language"]').content;
}

function showToast(message, type) {
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// å…¶ä»–è¾…åŠ©å‡½æ•°
function filterAlerts(filter) { /* å®ç°å‘Šè­¦è¿‡æ»¤ */ }
function filterIncidents() { /* å®ç°äº‹ä»¶è¿‡æ»¤ */ }
function searchIncidents() { /* å®ç°äº‹ä»¶æœç´¢ */ }
function switchTimeRange(range) { /* åˆ‡æ¢æ—¶é—´èŒƒå›´ */ }
function viewIncident(id) { /* æŸ¥çœ‹äº‹ä»¶è¯¦æƒ… */ }
function editIncident(id) { /* ç¼–è¾‘äº‹ä»¶ */ }
function acknowledgeAlert(id) { /* ç¡®è®¤å‘Šè­¦ */ }
function loadPerformanceData(range) { /* åŠ è½½æ€§èƒ½æ•°æ® */ }
function getIncidentFilters() { return {}; /* è·å–äº‹ä»¶è¿‡æ»¤å™¨ */ }
function updatePagination(pagination) { /* æ›´æ–°åˆ†é¡µ */ }
function exportIncidents() { /* å¯¼å‡ºäº‹ä»¶ */ }
function updateIncidentStatus() { /* æ›´æ–°äº‹ä»¶çŠ¶æ€ */ }

function openAIDiagnosis(alertId, alertType, minerId, siteId) {
    if (!minerId || !siteId) {
        alert(getLanguage() === 'en' ? 'AI diagnosis requires miner and site information' : 'AIè¯Šæ–­éœ€è¦çŸ¿æœºå’Œç«™ç‚¹ä¿¡æ¯');
        return;
    }
    
    const modal = new bootstrap.Modal(document.getElementById('aiDiagnosisModal'));
    modal.show();
    document.getElementById('ai-diagnosis-content').innerHTML = '<div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">' + (getLanguage() === 'en' ? 'Analyzing...' : 'åˆ†æä¸­...') + '</p></div>';
    
    fetch('/api/v1/ai/diagnose/alert', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            site_id: siteId,
            miner_id: minerId,
            alert_type: alertType
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            renderAIDiagnosis(data.diagnosis);
        } else {
            document.getElementById('ai-diagnosis-content').innerHTML = '<div class="alert alert-danger">' + (data.error || 'Diagnosis failed') + '</div>';
        }
    })
    .catch(err => {
        document.getElementById('ai-diagnosis-content').innerHTML = '<div class="alert alert-danger">Network error: ' + err.message + '</div>';
    });
}

function renderAIDiagnosis(diagnosis) {
    const lang = getLanguage();
    let html = '<div class="mb-3"><strong>' + (lang === 'en' ? 'Alert' : 'å‘Šè­¦') + ':</strong> ' + (diagnosis.alert_type || '-') + '</div>';
    html += '<h6 class="text-info mb-3"><i class="bi bi-lightbulb me-2"></i>' + (lang === 'en' ? 'Top 3 Hypotheses' : 'Top3 æ ¹å› å‡è®¾') + '</h6>';
    
    if (diagnosis.hypotheses && diagnosis.hypotheses.length > 0) {
        diagnosis.hypotheses.forEach((h, i) => {
            const riskBadge = h.risk_level === 'high' ? 'danger' : (h.risk_level === 'medium' ? 'warning' : 'info');
            html += '<div class="card bg-secondary mb-3"><div class="card-body">';
            html += '<div class="d-flex justify-content-between align-items-center mb-2">';
            html += '<h6 class="text-warning mb-0">#' + (i+1) + ' ' + (lang === 'en' ? h.cause : h.cause_zh) + '</h6>';
            html += '<span class="badge bg-' + (h.confidence > 0.7 ? 'success' : h.confidence > 0.4 ? 'warning' : 'secondary') + '">' + Math.round(h.confidence * 100) + '%</span>';
            html += '</div>';
            if (h.evidence && h.evidence.length > 0) {
                html += '<div class="mb-2"><small class="text-muted">' + (lang === 'en' ? 'Evidence:' : 'è¯æ®:') + '</small><ul class="mb-0">';
                h.evidence.forEach(e => {
                    const desc = lang === 'en' ? e.description : e.description_zh;
                    const valueInfo = e.value !== null && e.value !== undefined ? ' (' + e.metric + ': ' + e.value + (e.threshold ? ' / ' + (lang === 'en' ? 'threshold' : 'é˜ˆå€¼') + ': ' + e.threshold : '') + ')' : '';
                    html += '<li><small>' + desc + valueInfo + '</small></li>';
                });
                html += '</ul></div>';
            }
            if (h.suggested_actions && h.suggested_actions.length > 0) {
                html += '<div><small class="text-muted">' + (lang === 'en' ? 'Suggested Actions:' : 'å»ºè®®åŠ¨ä½œ:') + '</small><ul class="mb-0">';
                h.suggested_actions.forEach(a => {
                    const actionText = lang === 'en' ? a.action : a.action_zh;
                    const reasonText = lang === 'en' ? a.reason : a.reason_zh;
                    html += '<li><small class="text-success">' + actionText + '</small>';
                    if (reasonText) html += ' <small class="text-muted">- ' + reasonText + '</small>';
                    html += '</li>';
                });
                html += '</ul></div>';
            }
            html += '</div></div>';
        });
    } else {
        html += '<div class="alert alert-secondary">' + (lang === 'en' ? 'No hypotheses generated' : 'æœªç”Ÿæˆå‡è®¾') + '</div>';
    }
    
    if (diagnosis.summary_zh || diagnosis.summary) {
        html += '<div class="alert alert-info mt-3"><strong>' + (lang === 'en' ? 'Summary:' : 'æ€»ç»“:') + '</strong> ' + (lang === 'en' ? diagnosis.summary : diagnosis.summary_zh) + '</div>';
    }
    
    document.getElementById('ai-diagnosis-content').innerHTML = html;
}
</script>
{% endblock %}