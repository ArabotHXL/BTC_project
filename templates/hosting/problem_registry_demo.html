{% extends "hosting/hosting_base.html" %}

{% block page_title %}<i class="bi bi-shield-exclamation me-2"></i><span data-i18n="hosting.problem_registry_demo">Problem Registry Demo</span>{% endblock %}
{% block page_subtitle %}<span data-i18n="hosting.problem_registry_subtitle">Fleet Anomaly Detection & Health Monitoring System</span>{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
.pr-section-title {
    font-size: 1.3rem;
    font-weight: 700;
    margin-bottom: 1.5rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid rgba(247, 147, 30, 0.3);
    display: flex;
    align-items: center;
    gap: 0.5rem;
}
.pr-section-title i {
    color: #f7931a;
    font-size: 1.4rem;
}

.arch-pipeline {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0;
    padding: 1.5rem 0;
}
.arch-node {
    background: linear-gradient(135deg, rgba(247,147,26,0.15), rgba(255,193,7,0.08));
    border: 1px solid rgba(247,147,26,0.4);
    border-radius: 12px;
    padding: 0.75rem 1rem;
    text-align: center;
    min-width: 120px;
    transition: all 0.3s ease;
    cursor: default;
}
.arch-node:hover {
    border-color: #f7931a;
    box-shadow: 0 0 20px rgba(247,147,26,0.3);
    transform: translateY(-3px);
}
.arch-node-title {
    font-weight: 700;
    font-size: 0.85rem;
    color: #f7931a;
}
.arch-node-sub {
    font-size: 0.7rem;
    color: #adb5bd;
    margin-top: 2px;
}
.arch-arrow {
    color: #ffc107;
    font-size: 1.2rem;
    margin: 0 0.25rem;
    flex-shrink: 0;
}

.severity-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-weight: 700;
    font-size: 0.75rem;
    letter-spacing: 0.5px;
}
.severity-P0 { background: #dc3545; color: #fff; }
.severity-P1 { background: #fd7e14; color: #fff; }
.severity-P2 { background: #ffc107; color: #000; }
.severity-P3 { background: #0d6efd; color: #fff; }

.status-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    border-radius: 6px;
    font-weight: 600;
    font-size: 0.75rem;
}
.status-open { background: rgba(220,53,69,0.2); color: #dc3545; border: 1px solid #dc3545; }
.status-ack { background: rgba(255,193,7,0.2); color: #ffc107; border: 1px solid #ffc107; }
.status-in_progress { background: rgba(13,110,253,0.2); color: #0d6efd; border: 1px solid #0d6efd; }
.status-resolved { background: rgba(40,167,69,0.2); color: #28a745; border: 1px solid #28a745; }

.stat-card {
    text-align: center;
    padding: 1.25rem;
}
.stat-value {
    font-size: 2rem;
    font-weight: 800;
    background: linear-gradient(135deg, #f7931a, #ffc107);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}
.stat-label {
    font-size: 0.8rem;
    color: #adb5bd;
    margin-top: 0.25rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.lifecycle-container {
    display: flex;
    align-items: center;
    justify-content: center;
    flex-wrap: wrap;
    gap: 0.5rem;
    padding: 1.5rem 0;
}
.lifecycle-state {
    padding: 0.75rem 1.25rem;
    border-radius: 12px;
    border: 2px solid #444;
    background: rgba(255,255,255,0.03);
    text-align: center;
    min-width: 110px;
    transition: all 0.4s ease;
    position: relative;
}
.lifecycle-state.active-state {
    border-color: #f7931a;
    background: linear-gradient(135deg, rgba(247,147,26,0.2), rgba(255,193,7,0.1));
    box-shadow: 0 0 25px rgba(247,147,26,0.4);
    transform: scale(1.08);
}
.lifecycle-state.completed-state {
    border-color: #28a745;
    background: rgba(40,167,69,0.1);
}
.lifecycle-state-name {
    font-weight: 700;
    font-size: 0.9rem;
    color: #fff;
}
.lifecycle-state-detail {
    font-size: 0.7rem;
    color: #adb5bd;
    margin-top: 2px;
}
.lifecycle-arrow {
    color: #666;
    font-size: 1.2rem;
}
.lifecycle-arrow.active-arrow {
    color: #f7931a;
}

.lifecycle-counters {
    display: flex;
    gap: 2rem;
    justify-content: center;
    margin-top: 1rem;
}
.counter-box {
    text-align: center;
    padding: 0.75rem 1.5rem;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    border: 1px solid #444;
}
.counter-value {
    font-size: 1.5rem;
    font-weight: 800;
    color: #ffc107;
}
.counter-label {
    font-size: 0.75rem;
    color: #adb5bd;
}

.rule-card {
    border-radius: 10px;
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: rgba(255,255,255,0.03);
    border: 1px solid #333;
    transition: all 0.3s ease;
}
.rule-card:hover {
    border-color: rgba(247,147,26,0.5);
    background: rgba(255,255,255,0.06);
}
.rule-code {
    font-family: 'Courier New', monospace;
    font-weight: 700;
    color: #ffc107;
    font-size: 0.9rem;
}
.rule-condition {
    font-size: 0.82rem;
    color: #adb5bd;
    margin-top: 0.35rem;
}
.rule-threshold {
    font-size: 0.75rem;
    color: #6c757d;
    font-family: monospace;
}

.filter-btn {
    border-radius: 20px;
    padding: 0.3rem 1rem;
    font-size: 0.8rem;
    font-weight: 600;
    border: 1px solid #444;
    background: transparent;
    color: #adb5bd;
    cursor: pointer;
    transition: all 0.3s ease;
}
.filter-btn:hover, .filter-btn.active {
    background: linear-gradient(135deg, #f7931a, #ffc107);
    color: #000;
    border-color: #f7931a;
}

.problem-row {
    cursor: pointer;
    transition: background 0.2s ease;
}
.problem-row:hover {
    background: rgba(255,193,7,0.05) !important;
}
.problem-detail {
    display: none;
    background: rgba(0,0,0,0.3);
    padding: 1rem;
    font-size: 0.85rem;
}
.problem-detail.show {
    display: table-row;
}

.config-stat-card {
    text-align: center;
    padding: 1rem;
    border-radius: 12px;
    background: linear-gradient(135deg, rgba(247,147,26,0.08), rgba(255,193,7,0.04));
    border: 1px solid rgba(247,147,26,0.2);
    transition: all 0.3s ease;
}
.config-stat-card:hover {
    border-color: #f7931a;
    transform: translateY(-2px);
}
.config-stat-value {
    font-size: 1.4rem;
    font-weight: 800;
    color: #ffc107;
}
.config-stat-label {
    font-size: 0.75rem;
    color: #adb5bd;
    margin-top: 0.25rem;
}

.loading-spinner {
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 3rem;
    color: #adb5bd;
}
.loading-spinner .spinner-border {
    color: #f7931a;
    margin-right: 0.75rem;
}

@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}
.fade-in-up {
    animation: fadeInUp 0.5s ease forwards;
}

@keyframes pulse-glow {
    0%, 100% { box-shadow: 0 0 10px rgba(247,147,26,0.2); }
    50% { box-shadow: 0 0 25px rgba(247,147,26,0.5); }
}
.pulse-glow {
    animation: pulse-glow 2s ease-in-out infinite;
}
</style>

<!-- ========== Section A: System Architecture ========== -->
<div class="row mb-4 fade-in-up">
    <div class="col-12">
        <div class="hosting-card">
            <div class="hosting-card-body">
                <div class="pr-section-title">
                    <i class="bi bi-diagram-3"></i>
                    <span data-i18n="hosting.system_architecture">System Architecture — Data Pipeline</span>
                </div>
                <div class="arch-pipeline">
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-broadcast me-1"></i>Telemetry</div>
                        <div class="arch-node-sub">Live Data (5min)</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-funnel me-1"></i>Feature Extract</div>
                        <div class="arch-node-sub">hashrate, temp, boards</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-graph-up me-1"></i>Baseline</div>
                        <div class="arch-node-sub">EWMA α=0.1</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-bullseye me-1"></i>ModeInfer</div>
                        <div class="arch-node-sub">KMeans k=3</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-people me-1"></i>FleetBaseline</div>
                        <div class="arch-node-sub">Peer Z-Scores</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-shield-check me-1"></i>HealthRules</div>
                        <div class="arch-node-sub">Hard + Soft Rules</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-lightning me-1"></i>EventEngine</div>
                        <div class="arch-node-sub">Lifecycle Mgmt</div>
                    </div>
                    <div class="arch-arrow"><i class="bi bi-chevron-right"></i></div>
                    <div class="arch-node">
                        <div class="arch-node-title"><i class="bi bi-megaphone me-1"></i>PolicyEngine</div>
                        <div class="arch-node-sub">Budget & Dispatch</div>
                    </div>
                </div>
                <div class="text-center mt-2">
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        <span data-i18n="hosting.pipeline_interval">FeatureStoreJob runs every 5 minutes via APScheduler</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Section B: Live Health Summary ========== -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.1s;">
    <div class="col-12">
        <div class="pr-section-title">
            <i class="bi bi-heart-pulse"></i>
            <span data-i18n="hosting.live_health_summary">Live Health Summary</span>
            <button class="btn btn-sm ms-auto" style="background: rgba(247,147,26,0.15); color: #f7931a; border: 1px solid rgba(247,147,26,0.3); border-radius: 20px;" onclick="loadHealthSummary()">
                <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="common.refresh">Refresh</span>
            </button>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-3">
        <div class="hosting-card h-100">
            <div class="hosting-card-body">
                <div class="row g-2">
                    <div class="col-4">
                        <div class="stat-card">
                            <div class="stat-value" id="total-miners-val">--</div>
                            <div class="stat-label" data-i18n="hosting.total_miners">Total</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <div class="stat-value" id="healthy-miners-val" style="-webkit-text-fill-color: #28a745; color: #28a745;">--</div>
                            <div class="stat-label" data-i18n="hosting.healthy">Healthy</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stat-card">
                            <div class="stat-value" id="problem-miners-val" style="-webkit-text-fill-color: #dc3545; color: #dc3545;">--</div>
                            <div class="stat-label" data-i18n="hosting.problems">Problems</div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted"><i class="bi bi-clock me-1"></i><span data-i18n="hosting.last_scan">Last scan:</span> <span id="last-scan-time">--</span></small>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-6 mb-3">
        <div class="hosting-card h-100">
            <div class="hosting-card-header">
                <h6 class="hosting-card-title mb-0"><i class="bi bi-pie-chart me-2"></i><span data-i18n="hosting.severity_distribution">Severity Distribution</span></h6>
            </div>
            <div class="hosting-card-body d-flex align-items-center justify-content-center" style="min-height: 200px;">
                <div id="severity-chart-loading" class="loading-spinner">
                    <div class="spinner-border spinner-border-sm"></div>
                    <span data-i18n="common.loading">Loading...</span>
                </div>
                <canvas id="severityChart" style="display:none; max-height: 200px;"></canvas>
            </div>
        </div>
    </div>

    <div class="col-lg-4 col-md-12 mb-3">
        <div class="hosting-card h-100">
            <div class="hosting-card-header">
                <h6 class="hosting-card-title mb-0"><i class="bi bi-bar-chart me-2"></i><span data-i18n="hosting.issue_distribution">Issue Type Distribution</span></h6>
            </div>
            <div class="hosting-card-body d-flex align-items-center justify-content-center" style="min-height: 200px;">
                <div id="issue-chart-loading" class="loading-spinner">
                    <div class="spinner-border spinner-border-sm"></div>
                    <span data-i18n="common.loading">Loading...</span>
                </div>
                <canvas id="issueChart" style="display:none; max-height: 200px;"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Risks Table -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.15s;">
    <div class="col-12">
        <div class="hosting-card">
            <div class="hosting-card-header">
                <h6 class="hosting-card-title mb-0"><i class="bi bi-exclamation-triangle me-2"></i><span data-i18n="hosting.top_risks">Top Risks</span></h6>
            </div>
            <div class="hosting-card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;">
                        <thead>
                            <tr>
                                <th>Miner ID</th>
                                <th>Issue</th>
                                <th>Severity</th>
                                <th>P(Fail 24h)</th>
                                <th>Start Time</th>
                            </tr>
                        </thead>
                        <tbody id="top-risks-body">
                            <tr><td colspan="5" class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm me-2" style="color: #f7931a;"></div>Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Section C: Problem Events Explorer ========== -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.2s;">
    <div class="col-12">
        <div class="hosting-card">
            <div class="hosting-card-body">
                <div class="pr-section-title">
                    <i class="bi bi-list-task"></i>
                    <span data-i18n="hosting.problem_events">Problem Events Explorer</span>
                </div>

                <div class="d-flex flex-wrap gap-2 mb-3">
                    <button class="filter-btn active" onclick="filterSeverity(null, this)" data-i18n="common.all">All</button>
                    <button class="filter-btn" onclick="filterSeverity('P0', this)"><span class="severity-badge severity-P0">P0</span> Critical</button>
                    <button class="filter-btn" onclick="filterSeverity('P1', this)"><span class="severity-badge severity-P1">P1</span> High</button>
                    <button class="filter-btn" onclick="filterSeverity('P2', this)"><span class="severity-badge severity-P2">P2</span> Medium</button>
                    <button class="filter-btn" onclick="filterSeverity('P3', this)"><span class="severity-badge severity-P3">P3</span> Low</button>
                </div>

                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0" style="font-size: 0.85rem;" id="problems-table">
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>Miner ID</th>
                                <th>Issue Code</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Start Time</th>
                                <th>Last Seen</th>
                                <th>Recurrence</th>
                            </tr>
                        </thead>
                        <tbody id="problems-body">
                            <tr><td colspan="8" class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm me-2" style="color: #f7931a;"></div>Loading problems...</td></tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted" id="problems-count">--</small>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-secondary" id="prev-page-btn" onclick="changePage(-1)" disabled><i class="bi bi-chevron-left"></i></button>
                        <button class="btn btn-outline-secondary" disabled id="page-indicator">1</button>
                        <button class="btn btn-outline-secondary" id="next-page-btn" onclick="changePage(1)"><i class="bi bi-chevron-right"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Section D: Event Lifecycle Demo ========== -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.25s;">
    <div class="col-12">
        <div class="hosting-card">
            <div class="hosting-card-body">
                <div class="pr-section-title">
                    <i class="bi bi-arrow-repeat"></i>
                    <span data-i18n="hosting.event_lifecycle">Interactive Event Lifecycle Demo</span>
                </div>

                <div class="lifecycle-container" id="lifecycle-states">
                    <div class="lifecycle-state active-state" id="lc-detect">
                        <div class="lifecycle-state-name"><i class="bi bi-search me-1"></i>Detect</div>
                        <div class="lifecycle-state-detail">Rule triggered</div>
                    </div>
                    <div class="lifecycle-arrow" id="lc-arrow-1"><i class="bi bi-chevron-right"></i></div>
                    <div class="lifecycle-state" id="lc-debounce">
                        <div class="lifecycle-state-name"><i class="bi bi-hourglass-split me-1"></i>Debounce</div>
                        <div class="lifecycle-state-detail">N=2 consecutive</div>
                    </div>
                    <div class="lifecycle-arrow" id="lc-arrow-2"><i class="bi bi-chevron-right"></i></div>
                    <div class="lifecycle-state" id="lc-open">
                        <div class="lifecycle-state-name"><i class="bi bi-exclamation-circle me-1"></i>Open</div>
                        <div class="lifecycle-state-detail">Event created</div>
                    </div>
                    <div class="lifecycle-arrow" id="lc-arrow-3"><i class="bi bi-chevron-right"></i></div>
                    <div class="lifecycle-state" id="lc-resolve">
                        <div class="lifecycle-state-name"><i class="bi bi-check-circle me-1"></i>Resolve</div>
                        <div class="lifecycle-state-detail">M=3 consecutive OK</div>
                    </div>
                    <div class="lifecycle-arrow" id="lc-arrow-4"><i class="bi bi-chevron-right"></i></div>
                    <div class="lifecycle-state" id="lc-cooldown">
                        <div class="lifecycle-state-name"><i class="bi bi-clock-history me-1"></i>Cooldown</div>
                        <div class="lifecycle-state-detail">24h suppression</div>
                    </div>
                    <div class="lifecycle-arrow" id="lc-arrow-5"><i class="bi bi-chevron-right"></i></div>
                    <div class="lifecycle-state" id="lc-recurrence">
                        <div class="lifecycle-state-name"><i class="bi bi-arrow-repeat me-1"></i>Recurrence</div>
                        <div class="lifecycle-state-detail">count++</div>
                    </div>
                </div>

                <div class="lifecycle-counters">
                    <div class="counter-box">
                        <div class="counter-value" id="consecutive-fail">0</div>
                        <div class="counter-label">consecutive_fail</div>
                    </div>
                    <div class="counter-box">
                        <div class="counter-value" id="consecutive-ok">0</div>
                        <div class="counter-label">consecutive_ok</div>
                    </div>
                    <div class="counter-box">
                        <div class="counter-value" id="recurrence-count">0</div>
                        <div class="counter-label">recurrence_count</div>
                    </div>
                </div>

                <div class="text-center mt-4">
                    <button class="btn px-4 py-2" style="background: linear-gradient(135deg, #f7931a, #ffc107); color: #000; font-weight: 700; border-radius: 25px; border: none;" onclick="nextLifecycleStep()" id="lifecycle-next-btn">
                        <i class="bi bi-skip-forward me-2"></i><span data-i18n="hosting.next_step">Next Step</span>
                    </button>
                    <button class="btn btn-outline-secondary ms-2 px-3 py-2" style="border-radius: 25px;" onclick="resetLifecycle()">
                        <i class="bi bi-arrow-counterclockwise me-2"></i><span data-i18n="common.reset">Reset</span>
                    </button>
                </div>
                <div class="text-center mt-3">
                    <small class="text-muted" id="lifecycle-description">
                        <i class="bi bi-info-circle me-1"></i>
                        <span data-i18n="hosting.lifecycle_detect_desc">A health rule violation is detected for this miner.</span>
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Section E: Health Rules Reference ========== -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.3s;">
    <div class="col-12">
        <div class="pr-section-title">
            <i class="bi bi-journal-code"></i>
            <span data-i18n="hosting.health_rules_ref">Health Rules Reference</span>
        </div>
    </div>

    <div class="col-lg-6 mb-3">
        <div class="hosting-card h-100">
            <div class="hosting-card-header">
                <h6 class="hosting-card-title mb-0">
                    <i class="bi bi-exclamation-octagon me-2 text-danger"></i>
                    <span data-i18n="hosting.hard_rules">Hard Rules (P0 / P1)</span>
                </h6>
            </div>
            <div class="hosting-card-body">
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">overheat_crit</span>
                        <span class="severity-badge severity-P0">P0</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_overheat_crit">Critical overheating — chip temperature exceeds safe limit</span></div>
                    <div class="rule-threshold">temp_max ≥ 85°C</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">offline</span>
                        <span class="severity-badge severity-P0">P0</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_offline">Miner is not responding or unreachable</span></div>
                    <div class="rule-threshold">is_online = false</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">hashrate_zero</span>
                        <span class="severity-badge severity-P0">P0</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_hashrate_zero">Miner is online but producing zero hashrate</span></div>
                    <div class="rule-threshold">hashrate = 0 AND is_online = true</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">boards_dead</span>
                        <span class="severity-badge severity-P1">P1</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_boards_dead">One or more hashboards are not functioning</span></div>
                    <div class="rule-threshold">boards_ratio &lt; 1.0 AND boards_active &lt; boards_expected</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">fan_zero</span>
                        <span class="severity-badge severity-P1">P1</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_fan_zero">Fan speed is at zero — cooling failure</span></div>
                    <div class="rule-threshold">fan_speed_min = 0 AND is_online = true</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">overheat_warn</span>
                        <span class="severity-badge severity-P1">P1</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_overheat_warn">Temperature elevated — approaching critical threshold</span></div>
                    <div class="rule-threshold">75°C ≤ temp_max &lt; 85°C</div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6 mb-3">
        <div class="hosting-card h-100">
            <div class="hosting-card-header">
                <h6 class="hosting-card-title mb-0">
                    <i class="bi bi-exclamation-triangle me-2 text-warning"></i>
                    <span data-i18n="hosting.soft_rules">Soft Rules (P2 / P3)</span>
                </h6>
            </div>
            <div class="hosting-card-body">
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">hashrate_degradation</span>
                        <span class="severity-badge severity-P2">P2</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_hashrate_deg">Hashrate significantly below EWMA baseline</span></div>
                    <div class="rule-threshold">z_hashrate &lt; -2.0</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">efficiency_degradation</span>
                        <span class="severity-badge severity-P2">P2</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_efficiency_deg">Energy efficiency worse than expected (higher J/TH)</span></div>
                    <div class="rule-threshold">z_efficiency &gt; 2.0</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">temp_anomaly</span>
                        <span class="severity-badge severity-P2">P2</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_temp_anomaly">Temperature abnormally high relative to baseline</span></div>
                    <div class="rule-threshold">z_temp &gt; 2.5</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">fleet_outlier</span>
                        <span class="severity-badge severity-P3">P3</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_fleet_outlier">Miner performance significantly deviates from peer group</span></div>
                    <div class="rule-threshold">|fleet_z| &gt; 3.0</div>
                </div>
                <div class="rule-card">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="rule-code">boards_degrading</span>
                        <span class="severity-badge severity-P3">P3</span>
                    </div>
                    <div class="rule-condition"><span data-i18n="hosting.rule_boards_deg">Hashboard performance trending downward over time</span></div>
                    <div class="rule-threshold">boards_residual &lt; -0.1</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== Section F: System Statistics ========== -->
<div class="row mb-4 fade-in-up" style="animation-delay: 0.35s;">
    <div class="col-12">
        <div class="pr-section-title">
            <i class="bi bi-gear"></i>
            <span data-i18n="hosting.system_config">System Configuration & Statistics</span>
        </div>
    </div>

    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">α = 0.1</div>
            <div class="config-stat-label">EWMA Alpha</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">N = 2</div>
            <div class="config-stat-label">Debounce Count</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">M = 3</div>
            <div class="config-stat-label">Resolve Count</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">24h</div>
            <div class="config-stat-label">Cooldown Period</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">20 / 5</div>
            <div class="config-stat-label">Notifs / Tickets per Cycle</div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-6 mb-3">
        <div class="config-stat-card">
            <div class="config-stat-value">k = 3</div>
            <div class="config-stat-label">KMeans Clusters</div>
        </div>
    </div>
</div>

<script>
(function() {
    const siteId = {{ default_site_id }};
    let severityChart = null;
    let issueChart = null;
    let currentPage = 1;
    let currentSeverityFilter = null;

    function loadHealthSummary() {
        fetch(`/hosting/api/sites/${siteId}/health_summary`)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    console.warn('Health summary error:', data.error);
                    setFallbackData();
                    return;
                }
                document.getElementById('total-miners-val').textContent = data.total_miners || 0;
                document.getElementById('healthy-miners-val').textContent = data.healthy_miners || 0;
                document.getElementById('problem-miners-val').textContent = data.problem_miners || 0;
                document.getElementById('last-scan-time').textContent = data.last_scan_ts ? new Date(data.last_scan_ts).toLocaleString() : 'N/A';

                renderSeverityChart(data.by_severity || {});
                renderIssueChart(data.by_issue || {});
                renderTopRisks(data.top_risks || []);
            })
            .catch(err => {
                console.warn('Health summary fetch failed:', err);
                setFallbackData();
            });
    }

    function setFallbackData() {
        document.getElementById('total-miners-val').textContent = '0';
        document.getElementById('healthy-miners-val').textContent = '0';
        document.getElementById('problem-miners-val').textContent = '0';
        document.getElementById('last-scan-time').textContent = 'N/A';
        document.getElementById('severity-chart-loading').innerHTML = '<span class="text-muted">No data available</span>';
        document.getElementById('issue-chart-loading').innerHTML = '<span class="text-muted">No data available</span>';
        document.getElementById('top-risks-body').innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No risk data available</td></tr>';
    }

    function renderSeverityChart(bySeverity) {
        document.getElementById('severity-chart-loading').style.display = 'none';
        const canvas = document.getElementById('severityChart');
        canvas.style.display = 'block';

        const labels = ['P0', 'P1', 'P2', 'P3'];
        const values = labels.map(l => bySeverity[l] || 0);
        const colors = ['#dc3545', '#fd7e14', '#ffc107', '#0d6efd'];
        const total = values.reduce((a, b) => a + b, 0);

        if (severityChart) severityChart.destroy();
        severityChart = new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: total > 0 ? values : [1],
                    backgroundColor: total > 0 ? colors : ['#333'],
                    borderWidth: 0,
                    hoverOffset: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: { color: '#adb5bd', font: { size: 11 }, padding: 12, usePointStyle: true }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(ctx) {
                                if (total === 0) return 'No events';
                                return `${ctx.label}: ${ctx.raw} (${(ctx.raw / total * 100).toFixed(1)}%)`;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderIssueChart(byIssue) {
        document.getElementById('issue-chart-loading').style.display = 'none';
        const canvas = document.getElementById('issueChart');
        canvas.style.display = 'block';

        const entries = Object.entries(byIssue).sort((a, b) => b[1] - a[1]).slice(0, 8);
        const labels = entries.map(e => e[0]);
        const values = entries.map(e => e[1]);

        if (issueChart) issueChart.destroy();
        issueChart = new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: labels.length > 0 ? labels : ['No issues'],
                datasets: [{
                    data: values.length > 0 ? values : [0],
                    backgroundColor: 'rgba(247, 147, 26, 0.6)',
                    borderColor: '#f7931a',
                    borderWidth: 1,
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: ctx => `Count: ${ctx.raw}` } }
                },
                scales: {
                    x: { ticks: { color: '#adb5bd', font: { size: 10 } }, grid: { color: 'rgba(255,255,255,0.05)' } },
                    y: { ticks: { color: '#adb5bd', font: { size: 10 } }, grid: { display: false } }
                }
            }
        });
    }

    function renderTopRisks(risks) {
        const tbody = document.getElementById('top-risks-body');
        if (!risks || risks.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No active risks</td></tr>';
            return;
        }
        tbody.innerHTML = risks.slice(0, 5).map(r => `
            <tr>
                <td><code style="color: #ffc107;">${escHtml(r.miner_id)}</code></td>
                <td>${escHtml(r.issue_code)}</td>
                <td><span class="severity-badge severity-${r.severity}">${r.severity}</span></td>
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <div class="progress flex-grow-1" style="height: 6px; max-width: 80px;">
                            <div class="progress-bar ${r.p_fail_24h > 0.7 ? 'bg-danger' : r.p_fail_24h > 0.4 ? 'bg-warning' : 'bg-info'}" style="width: ${(r.p_fail_24h * 100).toFixed(0)}%"></div>
                        </div>
                        <span>${(r.p_fail_24h * 100).toFixed(1)}%</span>
                    </div>
                </td>
                <td>${r.start_ts ? new Date(r.start_ts).toLocaleString() : 'N/A'}</td>
            </tr>
        `).join('');
    }

    function loadProblems(page, severity) {
        let url = `/hosting/api/sites/${siteId}/problems?per_page=20&page=${page}`;
        if (severity) url += `&severity=${severity}`;

        fetch(url)
            .then(r => r.json())
            .then(data => {
                if (data.error) {
                    renderEmptyProblems();
                    return;
                }
                const problems = data.problems || [];
                const pagination = data.pagination || {};
                renderProblems(problems);
                document.getElementById('problems-count').textContent =
                    `Showing ${problems.length} of ${pagination.total || 0} events`;
                document.getElementById('page-indicator').textContent = `${pagination.page || 1} / ${pagination.pages || 1}`;
                document.getElementById('prev-page-btn').disabled = (pagination.page || 1) <= 1;
                document.getElementById('next-page-btn').disabled = (pagination.page || 1) >= (pagination.pages || 1);
            })
            .catch(() => renderEmptyProblems());
    }

    function renderEmptyProblems() {
        document.getElementById('problems-body').innerHTML =
            '<tr><td colspan="8" class="text-center text-muted py-3">No problem events found</td></tr>';
        document.getElementById('problems-count').textContent = '0 events';
    }

    function renderProblems(problems) {
        const tbody = document.getElementById('problems-body');
        if (!problems || problems.length === 0) {
            renderEmptyProblems();
            return;
        }
        let html = '';
        problems.forEach((p, idx) => {
            const evidence = p.evidence_json || p.evidence || {};
            const evidenceStr = typeof evidence === 'string' ? evidence : JSON.stringify(evidence, null, 2);
            html += `
                <tr class="problem-row" onclick="toggleDetail('detail-${idx}', this)">
                    <td><i class="bi bi-chevron-right" style="font-size: 0.7rem; transition: transform 0.2s;"></i></td>
                    <td><code style="color: #ffc107;">${escHtml(p.miner_id)}</code></td>
                    <td>${escHtml(p.issue_code)}</td>
                    <td><span class="severity-badge severity-${p.severity}">${p.severity}</span></td>
                    <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                    <td>${p.start_ts ? new Date(p.start_ts).toLocaleString() : 'N/A'}</td>
                    <td>${p.last_seen_ts ? new Date(p.last_seen_ts).toLocaleString() : 'N/A'}</td>
                    <td>${p.recurrence_count || 0}</td>
                </tr>
                <tr class="problem-detail" id="detail-${idx}">
                    <td colspan="8">
                        <div class="row">
                            <div class="col-md-6">
                                <strong>Evidence:</strong>
                                <pre style="background: rgba(0,0,0,0.4); padding: 0.75rem; border-radius: 8px; font-size: 0.75rem; max-height: 150px; overflow: auto; color: #adb5bd; margin-top: 0.5rem;">${escHtml(evidenceStr)}</pre>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Model:</strong> ${escHtml(p.model || 'N/A')}</div>
                                <div class="mb-2"><strong>Firmware:</strong> ${escHtml(p.firmware || 'N/A')}</div>
                                <div class="mb-2"><strong>Debounce Hits:</strong> ${p.debounce_hits || 0}</div>
                                <div class="mb-2"><strong>Consecutive Fail:</strong> ${p.consecutive_fail || 0}</div>
                            </div>
                        </div>
                    </td>
                </tr>`;
        });
        tbody.innerHTML = html;
    }

    window.toggleDetail = function(id, row) {
        const detail = document.getElementById(id);
        if (!detail) return;
        const icon = row.querySelector('i');
        if (detail.classList.contains('show')) {
            detail.classList.remove('show');
            if (icon) icon.style.transform = 'rotate(0deg)';
        } else {
            document.querySelectorAll('.problem-detail.show').forEach(d => {
                d.classList.remove('show');
                const prevRow = d.previousElementSibling;
                if (prevRow) {
                    const prevIcon = prevRow.querySelector('i');
                    if (prevIcon) prevIcon.style.transform = 'rotate(0deg)';
                }
            });
            detail.classList.add('show');
            if (icon) icon.style.transform = 'rotate(90deg)';
        }
    };

    window.filterSeverity = function(severity, btn) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSeverityFilter = severity;
        currentPage = 1;
        loadProblems(currentPage, currentSeverityFilter);
    };

    window.changePage = function(delta) {
        currentPage += delta;
        if (currentPage < 1) currentPage = 1;
        loadProblems(currentPage, currentSeverityFilter);
    };

    window.loadHealthSummary = loadHealthSummary;

    function escHtml(str) {
        if (!str) return '';
        const div = document.createElement('div');
        div.textContent = String(str);
        return div.innerHTML;
    }

    /* ===== Lifecycle Demo ===== */
    const lifecycleSteps = [
        {
            active: 'lc-detect', completed: [],
            fail: 1, ok: 0, recurrence: 0,
            desc: 'A health rule violation is detected for this miner (e.g., temp_max ≥ 85°C).'
        },
        {
            active: 'lc-debounce', completed: ['lc-detect'],
            fail: 2, ok: 0, recurrence: 0,
            desc: 'Debounce: rule must trigger N=2 consecutive times to confirm it is not a transient spike.'
        },
        {
            active: 'lc-open', completed: ['lc-detect', 'lc-debounce'],
            fail: 2, ok: 0, recurrence: 0,
            desc: 'Event is now OPEN. A problem_event record is created with status="open" and notifications dispatched.'
        },
        {
            active: 'lc-open', completed: ['lc-detect', 'lc-debounce'],
            fail: 2, ok: 1, recurrence: 0,
            desc: 'First OK reading received. consecutive_ok incremented to 1. Need M=3 to resolve.'
        },
        {
            active: 'lc-open', completed: ['lc-detect', 'lc-debounce'],
            fail: 2, ok: 2, recurrence: 0,
            desc: 'Second OK reading. consecutive_ok = 2. One more needed to resolve.'
        },
        {
            active: 'lc-resolve', completed: ['lc-detect', 'lc-debounce', 'lc-open'],
            fail: 0, ok: 3, recurrence: 0,
            desc: 'M=3 consecutive OK readings confirmed. Event status → "resolved". Cooldown timer starts.'
        },
        {
            active: 'lc-cooldown', completed: ['lc-detect', 'lc-debounce', 'lc-open', 'lc-resolve'],
            fail: 0, ok: 3, recurrence: 0,
            desc: '24-hour cooldown period active. Same issue_code is suppressed to prevent alert fatigue.'
        },
        {
            active: 'lc-recurrence', completed: ['lc-detect', 'lc-debounce', 'lc-open', 'lc-resolve', 'lc-cooldown'],
            fail: 1, ok: 0, recurrence: 1,
            desc: 'After cooldown, if the same issue triggers again, recurrence_count is incremented and a new cycle begins.'
        }
    ];
    let currentLifecycleStep = 0;

    function updateLifecycleUI() {
        const step = lifecycleSteps[currentLifecycleStep];
        const allStates = ['lc-detect', 'lc-debounce', 'lc-open', 'lc-resolve', 'lc-cooldown', 'lc-recurrence'];
        allStates.forEach(id => {
            const el = document.getElementById(id);
            el.classList.remove('active-state', 'completed-state');
        });
        for (let i = 1; i <= 5; i++) {
            const arrow = document.getElementById('lc-arrow-' + i);
            arrow.classList.remove('active-arrow');
        }

        step.completed.forEach(id => {
            document.getElementById(id).classList.add('completed-state');
        });
        document.getElementById(step.active).classList.add('active-state');

        const activeIdx = allStates.indexOf(step.active);
        for (let i = 1; i <= activeIdx; i++) {
            document.getElementById('lc-arrow-' + i).classList.add('active-arrow');
        }

        document.getElementById('consecutive-fail').textContent = step.fail;
        document.getElementById('consecutive-ok').textContent = step.ok;
        document.getElementById('recurrence-count').textContent = step.recurrence;
        document.getElementById('lifecycle-description').innerHTML = '<i class="bi bi-info-circle me-1"></i>' + step.desc;

        if (currentLifecycleStep >= lifecycleSteps.length - 1) {
            document.getElementById('lifecycle-next-btn').innerHTML = '<i class="bi bi-arrow-counterclockwise me-2"></i>Restart';
        } else {
            document.getElementById('lifecycle-next-btn').innerHTML = '<i class="bi bi-skip-forward me-2"></i>Next Step';
        }
    }

    window.nextLifecycleStep = function() {
        if (currentLifecycleStep >= lifecycleSteps.length - 1) {
            resetLifecycle();
            return;
        }
        currentLifecycleStep++;
        updateLifecycleUI();
    };

    window.resetLifecycle = function() {
        currentLifecycleStep = 0;
        updateLifecycleUI();
    };

    updateLifecycleUI();
    loadHealthSummary();
    loadProblems(1, null);
})();
</script>
{% endblock %}
