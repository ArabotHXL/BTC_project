{% extends "hosting/hosting_base.html" %}

{% block page_title %}{% if current_lang == 'en' %}Customer Management{% else %}客户管理{% endif %}{% endblock %}
{% block page_subtitle %}{% if current_lang == 'en' %}Manage customers for your hosting sites{% else %}管理托管站点的客户{% endif %}{% endblock %}

{% block header_actions %}
{{ super() }}
<div class="btn-group ms-3" role="group">
    <button class="btn btn-hosting-primary btn-sm" data-bs-toggle="modal" data-bs-target="#assignCustomerModal">
        <i class="bi bi-person-plus me-1"></i>{% if current_lang == 'en' %}Assign Customer{% else %}分配客户{% endif %}
    </button>
    <button class="btn btn-hosting-secondary btn-sm" onclick="refreshCustomers()">
        <i class="bi bi-arrow-clockwise me-1"></i>{% if current_lang == 'en' %}Refresh{% else %}刷新{% endif %}
    </button>
</div>
{% endblock %}

{% block content %}

<!-- Customer Stats -->
<div class="hosting-stats-grid">
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-customers">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}Total Customers{% else %}总客户数{% endif %}</div>
        <i class="bi bi-people hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="active-customers">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}With Account{% else %}有账号{% endif %}</div>
        <i class="bi bi-person-check hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-miners">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}Total Miners{% else %}总矿机数{% endif %}</div>
        <i class="bi bi-cpu hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-sites">--</div>
        <div class="hosting-stat-label">{% if current_lang == 'en' %}My Sites{% else %}我的站点{% endif %}</div>
        <i class="bi bi-building hosting-stat-icon"></i>
    </div>
</div>

<!-- Customer List -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-people me-2"></i>{% if current_lang == 'en' %}My Customers{% else %}我的客户{% endif %}
        </h5>
        <div class="d-flex gap-2 align-items-center">
            <select class="form-select form-select-sm" id="site-filter" style="width: 200px;" onchange="filterBySite()">
                <option value="">{% if current_lang == 'en' %}All Sites{% else %}全部站点{% endif %}</option>
            </select>
        </div>
    </div>
    <div class="hosting-card-body">
        <!-- Search -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <input type="text" class="form-control" id="search-customers" placeholder="{% if current_lang == 'en' %}Search by name or email...{% else %}按姓名或邮箱搜索...{% endif %}" onkeyup="searchCustomers()">
            </div>
            <div class="col-md-2">
                <select class="form-select" id="status-filter" onchange="filterByStatus()">
                    <option value="">{% if current_lang == 'en' %}All Status{% else %}全部状态{% endif %}</option>
                    <option value="active">{% if current_lang == 'en' %}Active{% else %}活跃{% endif %}</option>
                    <option value="inactive">{% if current_lang == 'en' %}Inactive{% else %}已禁用{% endif %}</option>
                </select>
            </div>
        </div>
        
        <!-- Table -->
        <div class="hosting-table">
            <table class="table table-hover" id="customers-table">
                <thead>
                    <tr>
                        <th>{% if current_lang == 'en' %}Name{% else %}姓名{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Email{% else %}邮箱{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Company{% else %}公司{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Site{% else %}站点{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Miners{% else %}矿机数{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Account Status{% else %}账号状态{% endif %}</th>
                        <th>{% if current_lang == 'en' %}Actions{% else %}操作{% endif %}</th>
                    </tr>
                </thead>
                <tbody id="customers-table-body">
                    <tr>
                        <td colspan="7" class="text-center text-muted py-4">
                            <i class="bi bi-hourglass-split me-2"></i>{% if current_lang == 'en' %}Loading...{% else %}加载中...{% endif %}
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="text-center py-5" style="display: none;">
            <i class="bi bi-people fs-1 text-muted mb-3 d-block"></i>
            <h5 class="text-muted">{% if current_lang == 'en' %}No customers found{% else %}暂无客户{% endif %}</h5>
            <p class="text-muted">{% if current_lang == 'en' %}Click "Assign Customer" to assign a CRM customer to your site{% else %}点击"分配客户"将CRM客户分配到您的站点{% endif %}</p>
        </div>
    </div>
</div>

<!-- Assign Customer Modal -->
<div class="modal fade" id="assignCustomerModal" tabindex="-1" aria-labelledby="assignCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931a, #ffc107); color: #000;">
                <h5 class="modal-title" id="assignCustomerModalLabel">
                    <i class="bi bi-person-plus me-2"></i>
                    {% if current_lang == 'en' %}Assign Customer to Site{% else %}分配客户到站点{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="assignCustomerForm">
                    <div class="mb-3">
                        <label for="unassigned-customer" class="form-label">
                            {% if current_lang == 'en' %}Select Customer{% else %}选择客户{% endif %} <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="unassigned-customer" name="customer_id" required>
                            <option value="">{% if current_lang == 'en' %}Loading customers...{% else %}加载客户中...{% endif %}</option>
                        </select>
                        <small class="text-muted">{% if current_lang == 'en' %}Only unassigned CRM customers are shown{% else %}仅显示未分配的CRM客户{% endif %}</small>
                    </div>
                    <div class="mb-3">
                        <label for="assign-site" class="form-label">
                            {% if current_lang == 'en' %}Assign to Site{% else %}分配到站点{% endif %} <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="assign-site" name="site_id" required>
                            <option value="">{% if current_lang == 'en' %}Select a site...{% else %}选择站点...{% endif %}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal">
                    {% if current_lang == 'en' %}Cancel{% else %}取消{% endif %}
                </button>
                <button type="button" class="btn btn-hosting-primary" onclick="assignCustomer()">
                    {% if current_lang == 'en' %}Assign Customer{% else %}分配客户{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931a, #ffc107); color: #000;">
                <h5 class="modal-title" id="editCustomerModalLabel">
                    <i class="bi bi-pencil me-2"></i>
                    {% if current_lang == 'en' %}Edit Customer{% else %}编辑客户{% endif %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <input type="hidden" id="edit-customer-id" name="id">
                    <div class="mb-3">
                        <label for="edit-customer-name" class="form-label">
                            {% if current_lang == 'en' %}Name{% else %}姓名{% endif %} <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="edit-customer-name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit-customer-email" class="form-label">
                            {% if current_lang == 'en' %}Email{% else %}邮箱{% endif %}
                        </label>
                        <input type="email" class="form-control" id="edit-customer-email" name="email" readonly disabled>
                        <small class="text-muted">{% if current_lang == 'en' %}Email cannot be changed{% else %}邮箱不可修改{% endif %}</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit-customer-company" class="form-label">
                            {% if current_lang == 'en' %}Company{% else %}公司{% endif %}
                        </label>
                        <input type="text" class="form-control" id="edit-customer-company" name="company">
                    </div>
                    <div class="mb-3">
                        <label for="edit-customer-site" class="form-label">
                            {% if current_lang == 'en' %}Assigned Site{% else %}分配站点{% endif %} <span class="text-danger">*</span>
                        </label>
                        <select class="form-select" id="edit-customer-site" name="site_id" required>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal">
                    {% if current_lang == 'en' %}Cancel{% else %}取消{% endif %}
                </button>
                <button type="button" class="btn btn-hosting-primary" onclick="updateCustomer()">
                    {% if current_lang == 'en' %}Save Changes{% else %}保存修改{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Account Created Success Modal -->
<div class="modal fade" id="accountCreatedModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success" style="background: linear-gradient(135deg, #28a745, #20c997); color: #fff;">
                <h5 class="modal-title">
                    <i class="bi bi-check-circle me-2"></i>
                    {% if current_lang == 'en' %}Account Created{% else %}账号创建成功{% endif %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    {% if current_lang == 'en' %}Please share the following temporary password with the customer:{% else %}请将以下临时密码分享给客户：{% endif %}
                </div>
                <div class="bg-dark border rounded p-3 mb-3">
                    <div class="mb-2">
                        <strong>{% if current_lang == 'en' %}Email:{% else %}邮箱：{% endif %}</strong>
                        <span id="created-account-email"></span>
                    </div>
                    <div>
                        <strong>{% if current_lang == 'en' %}Temporary Password:{% else %}临时密码：{% endif %}</strong>
                        <code id="created-account-password" class="fs-5 text-warning"></code>
                        <button class="btn btn-sm btn-outline-light ms-2" onclick="copyPassword()">
                            <i class="bi bi-clipboard"></i>
                        </button>
                    </div>
                </div>
                <small class="text-muted">
                    {% if current_lang == 'en' %}The customer should change this password after first login.{% else %}客户应在首次登录后更改此密码。{% endif %}
                </small>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-primary" data-bs-dismiss="modal">
                    {% if current_lang == 'en' %}Done{% else %}完成{% endif %}
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let allCustomers = [];
let allSites = [];
let unassignedCustomers = [];
const currentLang = '{{ current_lang }}';

document.addEventListener('DOMContentLoaded', function() {
    loadCustomersData();
    loadUnassignedCustomers();
});

function loadCustomersData() {
    const siteFilter = document.getElementById('site-filter').value;
    let url = '/hosting/api/my-customers';
    if (siteFilter) {
        url += '?site_id=' + siteFilter;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allCustomers = data.customers;
                allSites = data.sites;
                updateStats();
                displayCustomers(allCustomers);
                populateSiteDropdowns();
            } else {
                console.error('Error loading customers:', data.error);
                showToast(data.error || 'Failed to load customers', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Failed to load customers', 'error');
        });
}

function loadUnassignedCustomers() {
    fetch('/hosting/api/my-customers/unassigned')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                unassignedCustomers = data.customers;
                populateUnassignedDropdown();
            }
        })
        .catch(error => {
            console.error('Error loading unassigned customers:', error);
        });
}

function populateUnassignedDropdown() {
    const select = document.getElementById('unassigned-customer');
    select.innerHTML = `<option value="">${currentLang === 'en' ? 'Select a customer...' : '选择客户...'}</option>`;
    
    if (unassignedCustomers.length === 0) {
        select.innerHTML = `<option value="">${currentLang === 'en' ? 'No unassigned customers' : '暂无未分配客户'}</option>`;
        return;
    }
    
    unassignedCustomers.forEach(c => {
        const displayText = c.company ? `${c.name} (${c.company})` : c.name;
        const option = new Option(displayText + (c.email ? ` - ${c.email}` : ''), c.id);
        select.add(option);
    });
}

function updateStats() {
    document.getElementById('total-customers').textContent = allCustomers.length;
    document.getElementById('active-customers').textContent = allCustomers.filter(c => c.has_account).length;
    document.getElementById('total-miners').textContent = allCustomers.reduce((sum, c) => sum + (c.miners_count || 0), 0);
    document.getElementById('total-sites').textContent = allSites.length;
}

function populateSiteDropdowns() {
    const filterSelect = document.getElementById('site-filter');
    const assignSelect = document.getElementById('assign-site');
    const editSelect = document.getElementById('edit-customer-site');
    
    const currentFilterValue = filterSelect.value;
    
    filterSelect.innerHTML = `<option value="">${currentLang === 'en' ? 'All Sites' : '全部站点'}</option>`;
    assignSelect.innerHTML = `<option value="">${currentLang === 'en' ? 'Select a site...' : '选择站点...'}</option>`;
    editSelect.innerHTML = '';
    
    allSites.forEach(site => {
        const option1 = new Option(site.name, site.id);
        const option2 = new Option(site.name, site.id);
        const option3 = new Option(site.name, site.id);
        filterSelect.add(option1);
        assignSelect.add(option2);
        editSelect.add(option3);
    });
    
    filterSelect.value = currentFilterValue;
}

function displayCustomers(customers) {
    const tbody = document.getElementById('customers-table-body');
    const emptyState = document.getElementById('empty-state');
    const table = document.getElementById('customers-table');
    
    if (customers.length === 0) {
        tbody.innerHTML = '';
        table.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    table.style.display = 'table';
    emptyState.style.display = 'none';
    
    tbody.innerHTML = customers.map(customer => `
        <tr data-customer-id="${customer.id}">
            <td>
                <div class="d-flex align-items-center">
                    <div class="avatar-circle me-2" style="width: 36px; height: 36px; background: linear-gradient(135deg, #f7931a, #ffc107); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #000; font-weight: bold;">
                        ${customer.name.charAt(0).toUpperCase()}
                    </div>
                    <span>${escapeHtml(customer.name)}</span>
                </div>
            </td>
            <td>${customer.email ? escapeHtml(customer.email) : '<span class="text-muted">-</span>'}</td>
            <td>${customer.company ? escapeHtml(customer.company) : '<span class="text-muted">-</span>'}</td>
            <td><span class="badge bg-secondary">${escapeHtml(customer.site_name)}</span></td>
            <td>
                <span class="badge ${customer.miners_count > 0 ? 'bg-info' : 'bg-secondary'}">
                    <i class="bi bi-cpu me-1"></i>${customer.miners_count}
                </span>
            </td>
            <td>
                ${customer.has_account 
                    ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>' + (currentLang === 'en' ? 'Has Account' : '有账号') + '</span>'
                    : '<span class="badge bg-warning text-dark"><i class="bi bi-x-circle me-1"></i>' + (currentLang === 'en' ? 'No Account' : '无账号') + '</span>'
                }
            </td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-light" onclick="editCustomer(${customer.id})" title="${currentLang === 'en' ? 'Edit' : '编辑'}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    ${!customer.has_account && customer.email ? `
                        <button class="btn btn-outline-success" onclick="createAccount(${customer.id})" title="${currentLang === 'en' ? 'Create Account' : '创建账号'}">
                            <i class="bi bi-person-plus"></i>
                        </button>
                    ` : ''}
                    <button class="btn ${customer.status === 'active' ? 'btn-outline-warning' : 'btn-outline-success'}" 
                            onclick="toggleStatus(${customer.id})" 
                            title="${customer.status === 'active' ? (currentLang === 'en' ? 'Disable' : '禁用') : (currentLang === 'en' ? 'Enable' : '启用')}">
                        <i class="bi ${customer.status === 'active' ? 'bi-pause-circle' : 'bi-play-circle'}"></i>
                    </button>
                </div>
            </td>
        </tr>
    `).join('');
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function filterBySite() {
    loadCustomersData();
}

function filterByStatus() {
    const status = document.getElementById('status-filter').value;
    let filtered = allCustomers;
    
    if (status === 'active') {
        filtered = allCustomers.filter(c => c.status === 'active');
    } else if (status === 'inactive') {
        filtered = allCustomers.filter(c => c.status !== 'active');
    }
    
    displayCustomers(filtered);
}

function searchCustomers() {
    const search = document.getElementById('search-customers').value.toLowerCase();
    const statusFilter = document.getElementById('status-filter').value;
    
    let filtered = allCustomers.filter(c => 
        c.name.toLowerCase().includes(search) || 
        (c.email && c.email.toLowerCase().includes(search)) ||
        (c.company && c.company.toLowerCase().includes(search))
    );
    
    if (statusFilter === 'active') {
        filtered = filtered.filter(c => c.status === 'active');
    } else if (statusFilter === 'inactive') {
        filtered = filtered.filter(c => c.status !== 'active');
    }
    
    displayCustomers(filtered);
}

function refreshCustomers() {
    loadCustomersData();
    loadUnassignedCustomers();
    showToast(currentLang === 'en' ? 'Refreshed' : '已刷新', 'success');
}

function assignCustomer() {
    const customerId = document.getElementById('unassigned-customer').value;
    const siteId = document.getElementById('assign-site').value;
    
    if (!customerId || !siteId) {
        showToast(currentLang === 'en' ? 'Please select customer and site' : '请选择客户和站点', 'error');
        return;
    }
    
    fetch('/hosting/host/my-customers/assign', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ customer_id: parseInt(customerId), site_id: parseInt(siteId) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('assignCustomerModal')).hide();
            document.getElementById('assignCustomerForm').reset();
            showToast(data.message, 'success');
            loadCustomersData();
            loadUnassignedCustomers();
        } else {
            showToast(data.error || 'Failed to assign customer', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to assign customer', 'error');
    });
}

function createAccount(customerId) {
    if (!confirm(currentLang === 'en' ? 'Create login account for this customer?' : '为此客户创建登录账号？')) {
        return;
    }
    
    fetch(`/hosting/host/my-customers/${customerId}/create-account`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('created-account-email').textContent = data.account.email;
            document.getElementById('created-account-password').textContent = data.account.temp_password;
            new bootstrap.Modal(document.getElementById('accountCreatedModal')).show();
            loadCustomersData();
        } else {
            showToast(data.error || 'Failed to create account', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to create account', 'error');
    });
}

function editCustomer(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;
    
    document.getElementById('edit-customer-id').value = customer.id;
    document.getElementById('edit-customer-name').value = customer.name;
    document.getElementById('edit-customer-email').value = customer.email || '';
    document.getElementById('edit-customer-company').value = customer.company || '';
    document.getElementById('edit-customer-site').value = customer.site_id;
    
    new bootstrap.Modal(document.getElementById('editCustomerModal')).show();
}

function updateCustomer() {
    const customerId = document.getElementById('edit-customer-id').value;
    const name = document.getElementById('edit-customer-name').value.trim();
    const company = document.getElementById('edit-customer-company').value.trim();
    const siteId = document.getElementById('edit-customer-site').value;
    
    if (!name || !siteId) {
        showToast(currentLang === 'en' ? 'Please fill in all required fields' : '请填写所有必填项', 'error');
        return;
    }
    
    fetch(`/hosting/host/my-customers/${customerId}/edit`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ name, company, site_id: parseInt(siteId) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editCustomerModal')).hide();
            loadCustomersData();
            showToast(data.message, 'success');
        } else {
            showToast(data.error || 'Failed to update customer', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to update customer', 'error');
    });
}

function toggleStatus(customerId) {
    const customer = allCustomers.find(c => c.id === customerId);
    if (!customer) return;
    
    const action = customer.status === 'active' ? 
        (currentLang === 'en' ? 'disable' : '禁用') : 
        (currentLang === 'en' ? 'enable' : '启用');
    
    if (!confirm(`${currentLang === 'en' ? 'Are you sure you want to' : '确定要'}${action}${currentLang === 'en' ? ' this customer?' : '此客户吗？'}`)) {
        return;
    }
    
    fetch(`/hosting/host/my-customers/${customerId}/toggle-status`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadCustomersData();
            showToast(data.message, 'success');
        } else {
            showToast(data.error || 'Failed to toggle status', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('Failed to toggle status', 'error');
    });
}

function copyPassword() {
    const password = document.getElementById('created-account-password').textContent;
    navigator.clipboard.writeText(password).then(() => {
        showToast(currentLang === 'en' ? 'Password copied!' : '密码已复制！', 'success');
    });
}

function showToast(message, type) {
    if (typeof Toastify !== 'undefined') {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            style: {
                background: type === 'error' ? "#dc3545" : type === 'success' ? "#28a745" : "#17a2b8",
            }
        }).showToast();
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
