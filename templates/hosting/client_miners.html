{% extends "hosting/hosting_base.html" %}

{% block page_title %}<span data-i18n="my_devices">{% if current_lang == 'en' %}My Devices{% else %}我的设备{% endif %}</span>{% endblock %}
{% block page_subtitle %}<span data-i18n="manage_monitor_devices">{% if current_lang == 'en' %}Manage and monitor your hosted mining devices{% else %}管理和监控您的托管矿机设备{% endif %}</span>{% endblock %}

{% block header_actions %}
{{ super() }}
<div class="btn-group ms-3" role="group">
    <button class="btn btn-hosting-primary btn-sm" data-bs-toggle="modal" data-bs-target="#registerMinerModal">
        <i class="bi bi-plus-circle me-1"></i><span data-i18n="register_miner">{% if current_lang == 'en' %}Register Miner{% else %}注册矿机{% endif %}</span>
    </button>
    <button class="btn btn-hosting-secondary btn-sm" onclick="refreshMiners()">
        <i class="bi bi-arrow-clockwise me-1"></i><span data-i18n="refresh">{% if current_lang == 'en' %}Refresh{% else %}刷新{% endif %}</span>
    </button>
</div>
{% endblock %}

{% block content %}

<!-- 设备状态概览 -->
<div class="hosting-stats-grid mb-4">
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-devices">--</div>
        <div class="hosting-stat-label"><span data-i18n="total_devices">{% if current_lang == 'en' %}Total Devices{% else %}总设备数{% endif %}</span></div>
        <i class="bi bi-cpu hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="active-devices">--</div>
        <div class="hosting-stat-label"><span data-i18n="running">{% if current_lang == 'en' %}Running{% else %}运行中{% endif %}</span></div>
        <i class="bi bi-play-circle hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="pending-devices">--</div>
        <div class="hosting-stat-label"><span data-i18n="pending_approval">{% if current_lang == 'en' %}Pending Approval{% else %}待审核{% endif %}</span></div>
        <i class="bi bi-clock hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="offline-devices">--</div>
        <div class="hosting-stat-label"><span data-i18n="offline">{% if current_lang == 'en' %}Offline{% else %}离线{% endif %}</span></div>
        <i class="bi bi-x-circle hosting-stat-icon"></i>
    </div>
</div>

<!-- 筛选和搜索 -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h6 class="hosting-card-title mb-0">
            <i class="bi bi-search me-2"></i><span data-i18n="search_filter">{% if current_lang == 'en' %}Search & Filter{% else %}搜索和筛选{% endif %}</span>
        </h6>
    </div>
    <div class="hosting-card-body">
        <form class="row g-3" id="filter-form">
            <div class="col-md-4">
                <label for="search-input" class="form-label">
                    <span data-i18n="search">{% if current_lang == 'en' %}Search{% else %}搜索{% endif %}</span>
                </label>
                <input type="text" class="form-control" id="search-input" name="search" 
                       placeholder="{% if current_lang == 'en' %}Serial number, model...{% else %}序列号、型号...{% endif %}"
                       data-i18n-placeholder="search_placeholder">
            </div>
            <div class="col-md-2">
                <label for="status-filter" class="form-label">
                    <span data-i18n="status">{% if current_lang == 'en' %}Status{% else %}状态{% endif %}</span>
                </label>
                <select class="form-select" id="status-filter" name="status">
                    <option value="" data-i18n="all">{% if current_lang == 'en' %}All{% else %}全部{% endif %}</option>
                    <option value="active" data-i18n="running">{% if current_lang == 'en' %}Running{% else %}运行中{% endif %}</option>
                    <option value="offline" data-i18n="offline">{% if current_lang == 'en' %}Offline{% else %}离线{% endif %}</option>
                    <option value="maintenance" data-i18n="maintenance">{% if current_lang == 'en' %}Maintenance{% else %}维护中{% endif %}</option>
                    <option value="pending_approval" data-i18n="pending">{% if current_lang == 'en' %}Pending{% else %}待审核{% endif %}</option>
                </select>
            </div>
            <div class="col-md-2">
                <label for="model-filter" class="form-label">
                    <span data-i18n="model">{% if current_lang == 'en' %}Model{% else %}型号{% endif %}</span>
                </label>
                <select class="form-select" id="model-filter" name="model">
                    <option value="" data-i18n="all">{% if current_lang == 'en' %}All{% else %}全部{% endif %}</option>
                    <!-- 动态加载型号选项 -->
                </select>
            </div>
            <div class="col-md-2">
                <label for="site-filter" class="form-label">
                    <span data-i18n="site">{% if current_lang == 'en' %}Site{% else %}站点{% endif %}</span>
                </label>
                <select class="form-select" id="site-filter" name="site">
                    <option value="" data-i18n="all">{% if current_lang == 'en' %}All{% else %}全部{% endif %}</option>
                    <!-- 动态加载站点选项 -->
                </select>
            </div>
            <div class="col-md-2">
                <label class="form-label">&nbsp;</label>
                <div class="d-grid">
                    <button type="submit" class="btn btn-hosting-primary">
                        <i class="bi bi-search me-1"></i><span data-i18n="search">{% if current_lang == 'en' %}Search{% else %}搜索{% endif %}</span>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- 设备列表 -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-list me-2"></i><span data-i18n="my_devices">{% if current_lang == 'en' %}My Devices{% else %}我的设备{% endif %}</span>
        </h5>
        <div class="d-flex gap-2 flex-wrap">
            <span class="badge bg-info" id="result-count">{% if current_lang == 'en' %}Total: 0{% else %}共 0 台{% endif %}</span>
        </div>
    </div>
    <div class="hosting-card-body">
        <div class="hosting-table">
            <table class="table table-hover" id="miners-table">
                <thead>
                    <tr>
                        <th><span data-i18n="serial_number">{% if current_lang == 'en' %}Serial Number{% else %}序列号{% endif %}</span></th>
                        <th><span data-i18n="model">{% if current_lang == 'en' %}Model{% else %}型号{% endif %}</span></th>
                        <th><span data-i18n="site">{% if current_lang == 'en' %}Site{% else %}站点{% endif %}</span></th>
                        <th><span data-i18n="hashrate">{% if current_lang == 'en' %}Hashrate{% else %}算力{% endif %}</span></th>
                        <th><span data-i18n="power">{% if current_lang == 'en' %}Power{% else %}功耗{% endif %}</span></th>
                        <th><span data-i18n="status">{% if current_lang == 'en' %}Status{% else %}状态{% endif %}</span></th>
                        <th><span data-i18n="daily_revenue">{% if current_lang == 'en' %}Daily Revenue{% else %}日收益{% endif %}</span></th>
                        <th><span data-i18n="uptime">{% if current_lang == 'en' %}Uptime{% else %}在线时间{% endif %}</span></th>
                        <th><span data-i18n="actions">{% if current_lang == 'en' %}Actions{% else %}操作{% endif %}</span></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- 数据通过JavaScript加载 -->
                </tbody>
            </table>
        </div>
        
        <!-- 分页 -->
        <nav aria-label="Device pagination" class="mt-3">
            <ul class="pagination justify-content-center" id="pagination">
                <!-- 分页按钮通过JavaScript生成 -->
            </ul>
        </nav>
    </div>
</div>

<!-- 注册矿机模态框 -->
<div class="modal fade" id="registerMinerModal" tabindex="-1" aria-labelledby="registerMinerModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="registerMinerModalLabel">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span data-i18n="register_new_miner">{% if current_lang == 'en' %}Register New Miner{% else %}注册新矿机{% endif %}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    <span data-i18n="pending_approval_notice">{% if current_lang == 'en' %}Your miner registration will be pending approval by the hosting provider.{% else %}您的矿机注册将等待托管商审核批准。{% endif %}</span>
                </div>
                
                <form id="registerMinerForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="reg_serial_number" class="form-label" data-i18n="serial_number">
                                {% if current_lang == 'en' %}Serial Number{% else %}矿机序列号{% endif %}
                            </label> <span class="text-danger">*</span>
                            <input type="text" class="form-control" id="reg_serial_number" name="serial_number" required>
                        </div>
                        <div class="col-md-6">
                            <label for="reg_miner_model" class="form-label" data-i18n="miner_model">
                                {% if current_lang == 'en' %}Miner Model{% else %}矿机型号{% endif %}
                            </label> <span class="text-danger">*</span>
                            <select class="form-select" id="reg_miner_model" name="miner_model" required>
                                <option value="" data-i18n="select_model">{% if current_lang == 'en' %}Select Model{% else %}选择型号{% endif %}</option>
                                <option value="Antminer S19 Pro">Antminer S19 Pro</option>
                                <option value="Antminer S19j Pro">Antminer S19j Pro</option>
                                <option value="WhatsMiner M30S++">WhatsMiner M30S++</option>
                                <option value="WhatsMiner M31S+">WhatsMiner M31S+</option>
                                <option value="AvalonMiner 1246">AvalonMiner 1246</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="reg_hosting_site" class="form-label" data-i18n="hosting_site">
                                {% if current_lang == 'en' %}Preferred Hosting Site{% else %}首选托管站点{% endif %}
                            </label> <span class="text-danger">*</span>
                            <select class="form-select" id="reg_hosting_site" name="hosting_site" required>
                                <option value="" data-i18n="select_site">{% if current_lang == 'en' %}Select Site{% else %}选择站点{% endif %}</option>
                                <!-- 动态加载站点选项 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="reg_purchase_date" class="form-label" data-i18n="purchase_date">
                                {% if current_lang == 'en' %}Purchase Date{% else %}购买日期{% endif %}
                            </label>
                            <input type="date" class="form-control" id="reg_purchase_date" name="purchase_date">
                        </div>
                        <div class="col-12">
                            <label for="reg_notes" class="form-label" data-i18n="additional_notes">
                                {% if current_lang == 'en' %}Additional Notes{% else %}补充说明{% endif %}
                            </label>
                            <textarea class="form-control" id="reg_notes" name="notes" rows="3"></textarea>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal">
                    <span data-i18n="cancel">{% if current_lang == 'en' %}Cancel{% else %}取消{% endif %}</span>
                </button>
                <button type="button" class="btn btn-hosting-primary" onclick="registerMiner()">
                    <span data-i18n="submit_registration">{% if current_lang == 'en' %}Submit Registration{% else %}提交注册{% endif %}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 设备详情模态框 -->
<div class="modal fade" id="deviceDetailModal" tabindex="-1" aria-labelledby="deviceDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #f7931e, #ffc107); color: #000;">
                <h5 class="modal-title" id="deviceDetailModalLabel">
                    <i class="bi bi-info-circle me-2"></i>
                    <span data-i18n="device_details">{% if current_lang == 'en' %}Device Details{% else %}设备详情{% endif %}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="device-detail-content">
                <!-- 设备详情内容将在这里加载 -->
            </div>
        </div>
    </div>
</div>

<!-- KB诊断模态框 -->
<div class="modal fade" id="kbDiagnosisModal" tabindex="-1" aria-labelledby="kbDiagnosisModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header" style="background: linear-gradient(135deg, #17a2b8, #138496); color: #fff;">
                <h5 class="modal-title" id="kbDiagnosisModalLabel">
                    <i class="bi bi-journal-medical me-2"></i>
                    <span data-i18n="kb_diagnosis">{% if current_lang == 'en' %}KB Repair Guide{% else %}KB维修指南{% endif %}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="kb-diagnosis-content">
                <div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">分析中...</p></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadMiners();
    setupFilters();
    loadDropdownOptions();
    
    // Update translations when modals are shown (for dynamic language switching)
    document.querySelectorAll('.modal').forEach(function(modal) {
        modal.addEventListener('shown.bs.modal', function() {
            if (window.I18n) {
                I18n.updatePageTranslations();
            }
        });
    });
});

let currentPage = 1;
const perPage = 20;
let cachedMiners = {};  // Cache miners by ID for KB diagnosis

function loadMiners(page = 1, filters = {}) {
    const queryParams = new URLSearchParams({
        page: page,
        per_page: perPage,
        ...filters
    });
    
    fetch(`/hosting/api/client/miners?${queryParams}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMiners(data.miners);
                updateStats(data.stats);
                updatePagination(data.pagination);
            }
        })
        .catch(error => {
            console.error('Error loading miners:', error);
        });
}

function displayMiners(miners) {
    const tbody = document.querySelector('#miners-table tbody');
    tbody.innerHTML = '';
    
    // Cache miners for KB diagnosis (avoid extra fetch calls)
    miners.forEach(m => { cachedMiners[m.id] = m; });
    
    if (miners.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted py-4">
                    <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                    <span data-i18n="hosting.no_devices_found">${getLanguage() === 'en' ? 'No devices found' : '未找到设备'}</span>
                    <br>
                    <button class="btn btn-hosting-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#registerMinerModal">
                        <span data-i18n="hosting.register_first_miner">${getLanguage() === 'en' ? 'Register Your First Miner' : '注册您的第一台矿机'}</span>
                    </button>
                </td>
            </tr>
        `;
        if (window.I18n) {
            I18n.updatePageTranslations();
        }
        return;
    }
    
    miners.forEach(miner => {
        const row = `
            <tr>
                <td><strong>${miner.serial_number}</strong></td>
                <td>${miner.miner_model}</td>
                <td>${miner.site_name || '-'}</td>
                <td>${miner.hashrate || '-'} TH/s</td>
                <td>${miner.power_consumption || '-'} W</td>
                <td><span class="badge bg-${getStatusColor(miner.status)}" data-i18n="hosting.status.${miner.status}">${getStatusText(miner.status)}</span></td>
                <td>$${(miner.daily_revenue || 0).toFixed(2)}</td>
                <td>${miner.uptime || '-'}</td>
                <td>
                    <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-hosting-outline" onclick="showDeviceDetail(${miner.id})" data-i18n-title="hosting.view_details" title="${getLanguage() === 'en' ? 'View Details' : '查看详情'}">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-hosting-outline" onclick="showKBDiagnosis(${miner.id}, ${miner.site_id || 0})" data-i18n-title="hosting.kb_diagnosis" title="${getLanguage() === 'en' ? 'KB Diagnosis' : 'KB诊断'}">
                            <i class="bi bi-journal-medical"></i>
                        </button>
                        <button class="btn btn-hosting-outline" onclick="restartDevice(${miner.id})" data-i18n-title="hosting.restart" title="${getLanguage() === 'en' ? 'Restart' : '重启'}">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML('beforeend', row);
    });
    
    if (window.I18n) {
        I18n.updatePageTranslations();
    }
}

function updateStats(stats) {
    document.getElementById('total-devices').textContent = stats.total || 0;
    document.getElementById('active-devices').textContent = stats.active || 0;
    document.getElementById('pending-devices').textContent = stats.pending || 0;
    document.getElementById('offline-devices').textContent = stats.offline || 0;
    document.getElementById('result-count').textContent = `${getLanguage() === 'en' ? 'Total:' : '共'} ${stats.total}${getLanguage() === 'en' ? '' : ' 台'}`;
}

function updatePagination(pagination) {
    const container = document.getElementById('pagination');
    if (!container || !pagination) return;
    
    const { page, pages, total } = pagination;
    const isEn = getLanguage() === 'en';
    
    if (pages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = '';
    
    html += `<li class="page-item ${page <= 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${page - 1}); return false;">${isEn ? 'Previous' : '上一页'}</a>
    </li>`;
    
    const startPage = Math.max(1, page - 2);
    const endPage = Math.min(pages, page + 2);
    
    if (startPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(1); return false;">1</a></li>`;
        if (startPage > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `<li class="page-item ${i === page ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
        </li>`;
    }
    
    if (endPage < pages) {
        if (endPage < pages - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${pages}); return false;">${pages}</a></li>`;
    }
    
    html += `<li class="page-item ${page >= pages ? 'disabled' : ''}">
        <a class="page-link" href="#" onclick="changePage(${page + 1}); return false;">${isEn ? 'Next' : '下一页'}</a>
    </li>`;
    
    container.innerHTML = html;
}

function changePage(newPage) {
    if (newPage < 1) return;
    currentPage = newPage;
    const filters = getFilters();
    loadMiners(currentPage, filters);
}

function setupFilters() {
    const form = document.getElementById('filter-form');
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        const filters = getFilters();
        currentPage = 1;
        loadMiners(currentPage, filters);
    });
    
    // 实时搜索
    const searchInput = document.getElementById('search-input');
    let searchTimeout;
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const filters = getFilters();
            currentPage = 1;
            loadMiners(currentPage, filters);
        }, 500);
    });
}

function getFilters() {
    const form = document.getElementById('filter-form');
    const formData = new FormData(form);
    const filters = {};
    
    for (let [key, value] of formData.entries()) {
        if (value) {
            filters[key] = value;
        }
    }
    
    return filters;
}

function refreshMiners() {
    const filters = getFilters();
    loadMiners(currentPage, filters);
}

function loadDropdownOptions() {
    // 加载站点选项
    fetch('/hosting/api/sites')
        .then(response => response.json())
        .then(data => {
            const siteFilter = document.getElementById('site-filter');
            const regSiteSelect = document.getElementById('reg_hosting_site');
            
            if (data.success && data.sites) {
                data.sites.forEach(site => {
                    const option = `<option value="${site.id}">${site.name}</option>`;
                    siteFilter.insertAdjacentHTML('beforeend', option);
                    regSiteSelect.insertAdjacentHTML('beforeend', option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading sites:', error);
        });
}

function registerMiner() {
    const form = document.getElementById('registerMinerForm');
    const formData = new FormData(form);
    
    fetch('/hosting/api/client/register-miner', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('registerMinerModal')).hide();
            form.reset();
            refreshMiners();
            showToast(getLanguage() === 'en' ? 'Miner registration submitted successfully' : '矿机注册提交成功', 'success');
        } else {
            showToast(data.message || (getLanguage() === 'en' ? 'Registration failed' : '注册失败'), 'error');
        }
    })
    .catch(error => {
        console.error('Error registering miner:', error);
        showToast(getLanguage() === 'en' ? 'Registration failed' : '注册失败', 'error');
    });
}

function showDeviceDetail(deviceId) {
    fetch(`/hosting/api/client/miners/${deviceId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayDeviceDetail(data.device);
                new bootstrap.Modal(document.getElementById('deviceDetailModal')).show();
            }
        })
        .catch(error => {
            console.error('Error loading device details:', error);
        });
}

function displayDeviceDetail(device) {
    const content = document.getElementById('device-detail-content');
    content.innerHTML = `
        <div class="row g-4">
            <div class="col-md-6">
                <h6 class="text-warning mb-3" data-i18n="hosting.basic_info">${getLanguage() === 'en' ? 'Basic Information' : '基本信息'}</h6>
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.serial_number">${getLanguage() === 'en' ? 'Serial Number' : '序列号'}</span>:</td>
                        <td><strong>${device.serial_number}</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.model">${getLanguage() === 'en' ? 'Model' : '型号'}</span>:</td>
                        <td>${device.miner_model}</td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.site">${getLanguage() === 'en' ? 'Site' : '站点'}</span>:</td>
                        <td>${device.site_name || '-'}</td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.status_label">${getLanguage() === 'en' ? 'Status' : '状态'}</span>:</td>
                        <td><span class="badge bg-${getStatusColor(device.status)}" data-i18n="hosting.status.${device.status}">${getStatusText(device.status)}</span></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6 class="text-warning mb-3" data-i18n="hosting.performance">${getLanguage() === 'en' ? 'Performance' : '性能指标'}</h6>
                <table class="table table-borderless">
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.hashrate">${getLanguage() === 'en' ? 'Hashrate' : '算力'}</span>:</td>
                        <td><strong>${device.hashrate || '-'} TH/s</strong></td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.power">${getLanguage() === 'en' ? 'Power' : '功耗'}</span>:</td>
                        <td>${device.power_consumption || '-'} W</td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.temperature">${getLanguage() === 'en' ? 'Temperature' : '温度'}</span>:</td>
                        <td>${device.temperature || '-'} °C</td>
                    </tr>
                    <tr>
                        <td class="text-muted"><span data-i18n="hosting.uptime">${getLanguage() === 'en' ? 'Uptime' : '在线时间'}</span>:</td>
                        <td>${device.uptime || '-'}</td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-12">
                <h6 class="text-warning mb-3" data-i18n="hosting.recent_revenue">${getLanguage() === 'en' ? 'Recent Revenue' : '最近收益'}</h6>
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="text-warning fw-bold">$${(device.daily_revenue || 0).toFixed(2)}</div>
                        <small class="text-muted" data-i18n="hosting.today">${getLanguage() === 'en' ? 'Today' : '今日'}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-warning fw-bold">$${(device.weekly_revenue || 0).toFixed(2)}</div>
                        <small class="text-muted" data-i18n="hosting.this_week">${getLanguage() === 'en' ? 'This Week' : '本周'}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-warning fw-bold">$${(device.monthly_revenue || 0).toFixed(2)}</div>
                        <small class="text-muted" data-i18n="hosting.this_month">${getLanguage() === 'en' ? 'This Month' : '本月'}</small>
                    </div>
                    <div class="col-md-3">
                        <div class="text-warning fw-bold">$${(device.total_revenue || 0).toFixed(2)}</div>
                        <small class="text-muted" data-i18n="hosting.total">${getLanguage() === 'en' ? 'Total' : '总计'}</small>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (window.I18n) {
        I18n.updatePageTranslations();
    }
}

function restartDevice(deviceId) {
    if (confirm(getLanguage() === 'en' ? 'Are you sure you want to restart this device?' : '确定要重启这台设备吗？')) {
        fetch(`/hosting/api/client/miners/${deviceId}/restart`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(getLanguage() === 'en' ? 'Restart command sent successfully' : '重启命令发送成功', 'success');
                refreshMiners();
            } else {
                showToast(data.message || (getLanguage() === 'en' ? 'Restart failed' : '重启失败'), 'error');
            }
        })
        .catch(error => {
            console.error('Error restarting device:', error);
            showToast(getLanguage() === 'en' ? 'Restart failed' : '重启失败', 'error');
        });
    }
}

function getStatusColor(status) {
    const colorMap = {
        'active': 'success',
        'offline': 'danger',
        'maintenance': 'warning',
        'error': 'danger',
        'pending_approval': 'warning'
    };
    return colorMap[status] || 'secondary';
}

function getStatusText(status) {
    if (window.I18n && I18n.initialized) {
        const translated = I18n.t('hosting.status.' + status);
        if (translated !== 'hosting.status.' + status) {
            return translated;
        }
    }
    const language = getLanguage();
    const statusMap = {
        'active': language === 'en' ? 'Running' : '运行中',
        'offline': language === 'en' ? 'Offline' : '离线',
        'maintenance': language === 'en' ? 'Maintenance' : '维护中',
        'error': language === 'en' ? 'Error' : '故障',
        'pending_approval': language === 'en' ? 'Pending' : '待审核'
    };
    return statusMap[status] || status;
}

function getLanguage() {
    if (window.I18n && I18n.initialized) {
        return I18n.getLang();
    }
    return document.querySelector('meta[name="language"]').content;
}

function showToast(message, type) {
    console.log(`[${type.toUpperCase()}] ${message}`);
}

// ===== KB Diagnosis Integration =====
function showKBDiagnosis(minerId, siteId) {
    const modal = new bootstrap.Modal(document.getElementById('kbDiagnosisModal'));
    modal.show();
    const container = document.getElementById('kb-diagnosis-content');
    const lang = getLanguage();
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-info"></div><p class="mt-2">' + (lang === 'en' ? 'Analyzing with Knowledge Base...' : '正在使用知识库分析...') + '</p></div>';
    
    // Use cached miner data from table (no extra fetch needed)
    const device = cachedMiners[minerId];
    if (!device) {
        container.innerHTML = '<div class="alert alert-warning"><i class="bi bi-exclamation-circle me-2"></i>' + (lang === 'en' ? 'Miner data not found. Please refresh the page.' : '未找到矿机数据，请刷新页面。') + '</div>';
        return;
    }
    
    const brand = (device.miner_model || '').toLowerCase().includes('whatsminer') ? 'WhatsMiner' : 
                  (device.miner_model || '').toLowerCase().includes('avalon') ? 'Avalon' : 'Bitmain';
    
    const logs = [];
    if (device.status === 'offline') logs.push('Miner offline, ERROR_POWER_LOST');
    if (device.status === 'error') logs.push('Device error detected');
    if ((device.temperature || 0) > 80) logs.push(`High temperature: ${device.temperature}°C, overheat`);
    if ((device.hashrate || 0) < 10) logs.push(`Low hashrate: ${device.hashrate} TH/s`);
    if (device.notes) logs.push(device.notes);
    if ((device.fan_speed || 0) > 0 && device.fan_speed < 2000) logs.push('Fan speed low, Fan lost');
    if ((device.hardware_errors || 0) > 100) logs.push('HW error rate high');
    if ((device.reject_rate || 0) > 3) logs.push('High reject rate, rejected, stale');
    
    const uptimeSec = device.uptime || 0;
    const metrics = {
        uptime_sec: uptimeSec,
        temperature_avg: device.temperature || 0,
        hashrate_current: device.hashrate || 0,
        fan_avg: device.fan_speed || 0,
        chip_temp_c: device.temperature || 0,
        pcb_temp_c: device.temperature || 0,
        fans_rpm: device.fan_speed || 0,
        hw_error_rate: (device.hardware_errors || 0) > 0 && (device.accepted_shares || 0) > 0 ? device.hardware_errors / device.accepted_shares : 0,
        reject_rate: (device.reject_rate || 0) / 100,
        avg_hashrate_12h: device.hashrate || 0
    };
    
    // Only fetch call needed: KB diagnosis API (specialized, allowed for diagnosis like charts)
    fetch('/api/kb/diagnose', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            miner_id: String(minerId),
            model_id: device.miner_model || 'generic_asic_miner',
            brand: brand,
            timestamp: new Date().toISOString(),
            logs: logs,
            metrics: metrics
        })
    })
    .then(r => r.json())
    .then(kbResult => {
        container.innerHTML = renderKBResult(kbResult, lang);
    })
    .catch(err => {
        container.innerHTML = '<div class="alert alert-danger"><i class="bi bi-exclamation-triangle me-2"></i>' + (lang === 'en' ? 'Diagnosis failed: ' : '诊断失败: ') + err.message + '</div>';
    });
}

function renderKBResult(kbResult, lang) {
    let html = '';
    
    if (!kbResult.success || !kbResult.selected) {
        html += '<div class="alert alert-info"><i class="bi bi-check-circle me-2"></i>' + 
                (lang === 'en' ? 'No issues detected. Device appears healthy.' : '未检测到问题，设备状态正常。') + '</div>';
        
        // Show prevention tips anyway if available
        if (kbResult.prevention && kbResult.prevention.checks && kbResult.prevention.checks.length > 0) {
            html += '<div class="card bg-dark border-warning mt-3">';
            html += '<div class="card-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #000;"><i class="bi bi-shield-check me-2"></i>' + (lang === 'en' ? 'Preventive Maintenance Tips' : '预防性维护建议') + '</div>';
            html += '<div class="card-body"><ul class="small mb-0">';
            kbResult.prevention.checks.forEach(c => { html += '<li>' + c + '</li>'; });
            html += '</ul></div></div>';
        }
        return html;
    }
    
    const sel = kbResult.selected;
    const playbook = kbResult.playbook;
    const prevention = kbResult.prevention;
    
    // Confidence badge
    const confPct = Math.round(kbResult.confidence * 100);
    const confClass = confPct >= 80 ? 'success' : confPct >= 50 ? 'warning' : 'secondary';
    
    // Main diagnosis card
    html += '<div class="card bg-dark border-danger mb-3">';
    html += '<div class="card-header d-flex justify-content-between align-items-center bg-danger text-white">';
    html += '<span><i class="bi bi-exclamation-triangle me-2"></i>' + (lang === 'en' ? 'Issue Detected' : '检测到问题') + '</span>';
    html += '<span class="badge bg-light text-dark">' + confPct + '% ' + (lang === 'en' ? 'Confidence' : '置信度') + '</span>';
    html += '</div>';
    html += '<div class="card-body">';
    
    // Fault title
    html += '<h5 class="text-warning mb-2">' + sel.title + '</h5>';
    html += '<div class="mb-2"><span class="badge bg-' + (sel.severity === 'critical' ? 'danger' : sel.severity === 'high' ? 'warning' : 'info') + ' me-2">' + sel.severity.toUpperCase() + '</span>';
    html += '<span class="badge bg-secondary">' + sel.category + '</span></div>';
    
    // Evidence
    if (sel.reasons && sel.reasons.length > 0) {
        html += '<div class="mb-2"><small class="text-muted">' + (lang === 'en' ? 'Evidence:' : '匹配证据:') + '</small><ul class="mb-0 small">';
        sel.reasons.forEach(r => { html += '<li class="text-success">' + r + '</li>'; });
        html += '</ul></div>';
    }
    html += '</div></div>';
    
    // Playbook (SOP)
    if (playbook) {
        html += '<div class="card bg-dark border-success mb-3">';
        html += '<div class="card-header bg-success text-white"><i class="bi bi-journal-check me-2"></i>' + (lang === 'en' ? 'Repair SOP' : '维修SOP') + '</div>';
        html += '<div class="card-body">';
        html += '<h6 class="text-info">' + playbook.title + '</h6>';
        html += '<p class="small text-muted mb-2">' + playbook.goal + '</p>';
        
        if (playbook.safety && playbook.safety.length > 0) {
            html += '<div class="alert alert-danger py-2 mb-2"><small><strong><i class="bi bi-shield-exclamation me-1"></i>' + (lang === 'en' ? 'Safety Warning:' : '安全警告:') + '</strong><ul class="mb-0 mt-1">';
            playbook.safety.forEach(s => { html += '<li>' + s + '</li>'; });
            html += '</ul></small></div>';
        }
        
        if (playbook.steps && playbook.steps.length > 0) {
            html += '<div class="mb-2"><strong>' + (lang === 'en' ? 'Steps:' : '操作步骤:') + '</strong><ol class="small mb-0">';
            playbook.steps.forEach(s => { html += '<li>' + s + '</li>'; });
            html += '</ol></div>';
        }
        
        if (playbook.verification && playbook.verification.length > 0) {
            html += '<div class="mt-2"><small class="text-success"><strong><i class="bi bi-check-circle me-1"></i>' + (lang === 'en' ? 'Verification:' : '验证点:') + '</strong> ' + playbook.verification.join('; ') + '</small></div>';
        }
        html += '</div></div>';
    }
    
    // Prevention
    if (prevention && prevention.checks && prevention.checks.length > 0) {
        html += '<div class="card bg-dark border-warning">';
        html += '<div class="card-header" style="background: linear-gradient(135deg, #ffc107, #e0a800); color: #000;"><i class="bi bi-shield-check me-2"></i>' + (lang === 'en' ? 'Prevention' : '预防措施') + '</div>';
        html += '<div class="card-body"><ul class="small mb-0">';
        prevention.checks.forEach(c => { html += '<li>' + c + '</li>'; });
        html += '</ul></div></div>';
    }
    
    return html;
}
</script>
{% endblock %}