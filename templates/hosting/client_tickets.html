{% extends "hosting/hosting_base.html" %}

{% block page_title %}{% if current_lang == 'en' %}Support Tickets{% else %}技术支持{% endif %}{% endblock %}
{% block page_subtitle %}{% if current_lang == 'en' %}Submit and track your support requests{% else %}提交并跟踪您的技术支持请求{% endif %}{% endblock %}

{% block content %}

<!-- 工单统计卡片 -->
<div class="hosting-stats-grid">
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="total-tickets">0</div>
        <div class="hosting-stat-label" data-i18n="total_tickets">{% if current_lang == 'en' %}Total Tickets{% else %}总工单{% endif %}</div>
        <i class="bi bi-ticket-perforated hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="pending-tickets">0</div>
        <div class="hosting-stat-label" data-i18n="pending_tickets">{% if current_lang == 'en' %}Pending{% else %}待处理{% endif %}</div>
        <i class="bi bi-clock hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="processing-tickets">0</div>
        <div class="hosting-stat-label" data-i18n="processing_tickets">{% if current_lang == 'en' %}In Progress{% else %}处理中{% endif %}</div>
        <i class="bi bi-gear hosting-stat-icon"></i>
    </div>
    <div class="hosting-stat-card">
        <div class="hosting-stat-value" id="resolved-tickets">0</div>
        <div class="hosting-stat-label" data-i18n="resolved_tickets">{% if current_lang == 'en' %}Resolved{% else %}已解决{% endif %}</div>
        <i class="bi bi-check-circle hosting-stat-icon"></i>
    </div>
</div>

<!-- 快捷操作 -->
<div class="hosting-card mb-4">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-lightning me-2"></i>
            <span data-i18n="quick_actions">{% if current_lang == 'en' %}Quick Actions{% else %}快捷操作{% endif %}</span>
        </h5>
    </div>
    <div class="hosting-card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <button class="btn btn-hosting w-100 py-3" onclick="openNewTicketModal('hardware')">
                    <i class="bi bi-cpu d-block fs-4 mb-2"></i>
                    <span data-i18n="hardware_issue">{% if current_lang == 'en' %}Hardware Issue{% else %}硬件问题{% endif %}</span>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-hosting-secondary w-100 py-3" onclick="openNewTicketModal('network')">
                    <i class="bi bi-wifi d-block fs-4 mb-2"></i>
                    <span data-i18n="network_issue">{% if current_lang == 'en' %}Network Issue{% else %}网络问题{% endif %}</span>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-hosting-secondary w-100 py-3" onclick="openNewTicketModal('billing')">
                    <i class="bi bi-receipt d-block fs-4 mb-2"></i>
                    <span data-i18n="billing_inquiry">{% if current_lang == 'en' %}Billing Inquiry{% else %}账单咨询{% endif %}</span>
                </button>
            </div>
            <div class="col-md-3">
                <button class="btn btn-hosting-secondary w-100 py-3" onclick="openNewTicketModal('other')">
                    <i class="bi bi-question-circle d-block fs-4 mb-2"></i>
                    <span data-i18n="other_request">{% if current_lang == 'en' %}Other Request{% else %}其他请求{% endif %}</span>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 工单列表 -->
<div class="hosting-card">
    <div class="hosting-card-header">
        <h5 class="hosting-card-title">
            <i class="bi bi-list-ul me-2"></i>
            <span data-i18n="my_tickets">{% if current_lang == 'en' %}My Tickets{% else %}我的工单{% endif %}</span>
        </h5>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm" id="status-filter" style="width: auto; background: var(--hosting-bg-secondary); border-color: var(--hosting-border); color: var(--hosting-text);">
                <option value="all" data-i18n="all_status">{% if current_lang == 'en' %}All Status{% else %}全部状态{% endif %}</option>
                <option value="open" data-i18n="status_open">{% if current_lang == 'en' %}Open{% else %}待处理{% endif %}</option>
                <option value="in_progress" data-i18n="status_in_progress">{% if current_lang == 'en' %}In Progress{% else %}处理中{% endif %}</option>
                <option value="resolved" data-i18n="status_resolved">{% if current_lang == 'en' %}Resolved{% else %}已解决{% endif %}</option>
                <option value="closed" data-i18n="status_closed">{% if current_lang == 'en' %}Closed{% else %}已关闭{% endif %}</option>
            </select>
            <button class="btn btn-hosting btn-sm" onclick="openNewTicketModal()">
                <i class="bi bi-plus-lg me-1"></i>
                <span data-i18n="new_ticket">{% if current_lang == 'en' %}New Ticket{% else %}新建工单{% endif %}</span>
            </button>
        </div>
    </div>
    <div class="hosting-card-body p-0">
        <div class="table-responsive">
            <table class="table table-dark mb-0" style="background: transparent;">
                <thead>
                    <tr style="border-bottom: 1px solid var(--hosting-border);">
                        <th class="ps-4" data-i18n="ticket_id">{% if current_lang == 'en' %}Ticket ID{% else %}工单编号{% endif %}</th>
                        <th data-i18n="title">{% if current_lang == 'en' %}Title{% else %}标题{% endif %}</th>
                        <th data-i18n="type">{% if current_lang == 'en' %}Type{% else %}类型{% endif %}</th>
                        <th data-i18n="priority">{% if current_lang == 'en' %}Priority{% else %}优先级{% endif %}</th>
                        <th data-i18n="status">{% if current_lang == 'en' %}Status{% else %}状态{% endif %}</th>
                        <th data-i18n="created_at">{% if current_lang == 'en' %}Created{% else %}创建时间{% endif %}</th>
                        <th class="pe-4" data-i18n="actions">{% if current_lang == 'en' %}Actions{% else %}操作{% endif %}</th>
                    </tr>
                </thead>
                <tbody id="tickets-table-body">
                    <tr>
                        <td colspan="7" class="text-center py-5">
                            <i class="bi bi-ticket-perforated fs-1 text-muted mb-3 d-block"></i>
                            <div class="text-muted" data-i18n="no_tickets">{% if current_lang == 'en' %}No tickets found{% else %}暂无工单记录{% endif %}</div>
                            <small class="text-muted" data-i18n="create_ticket_hint">{% if current_lang == 'en' %}Create a ticket when you need assistance{% else %}遇到问题时可以新建工单{% endif %}</small>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 新建工单模态框 -->
<div class="modal fade" id="newTicketModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="background: var(--hosting-bg-secondary); border: 1px solid var(--hosting-border);">
            <div class="modal-header border-bottom" style="border-color: var(--hosting-border) !important;">
                <h5 class="modal-title text-warning">
                    <i class="bi bi-plus-circle me-2"></i>
                    <span data-i18n="create_new_ticket">{% if current_lang == 'en' %}Create New Ticket{% else %}新建工单{% endif %}</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newTicketForm">
                    <div class="mb-3">
                        <label class="form-label" data-i18n="ticket_type">{% if current_lang == 'en' %}Type{% else %}工单类型{% endif %}</label>
                        <select class="form-select" id="ticketType" style="background: var(--hosting-bg-primary); border-color: var(--hosting-border); color: var(--hosting-text);">
                            <option value="hardware" data-i18n="type_hardware">{% if current_lang == 'en' %}Hardware Issue{% else %}硬件问题{% endif %}</option>
                            <option value="network" data-i18n="type_network">{% if current_lang == 'en' %}Network Issue{% else %}网络问题{% endif %}</option>
                            <option value="billing" data-i18n="type_billing">{% if current_lang == 'en' %}Billing Inquiry{% else %}账单咨询{% endif %}</option>
                            <option value="maintenance" data-i18n="type_maintenance">{% if current_lang == 'en' %}Maintenance Request{% else %}维护请求{% endif %}</option>
                            <option value="other" data-i18n="type_other">{% if current_lang == 'en' %}Other{% else %}其他{% endif %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="ticket_priority">{% if current_lang == 'en' %}Priority{% else %}优先级{% endif %}</label>
                        <select class="form-select" id="ticketPriority" style="background: var(--hosting-bg-primary); border-color: var(--hosting-border); color: var(--hosting-text);">
                            <option value="low" data-i18n="priority_low">{% if current_lang == 'en' %}Low{% else %}低{% endif %}</option>
                            <option value="normal" selected data-i18n="priority_normal">{% if current_lang == 'en' %}Normal{% else %}普通{% endif %}</option>
                            <option value="high" data-i18n="priority_high">{% if current_lang == 'en' %}High{% else %}高{% endif %}</option>
                            <option value="urgent" data-i18n="priority_urgent">{% if current_lang == 'en' %}Urgent{% else %}紧急{% endif %}</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="ticket_title">{% if current_lang == 'en' %}Title{% else %}标题{% endif %}</label>
                        <input type="text" class="form-control" id="ticketTitle" placeholder="{% if current_lang == 'en' %}Brief description of the issue{% else %}简要描述问题{% endif %}" style="background: var(--hosting-bg-primary); border-color: var(--hosting-border); color: var(--hosting-text);">
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="ticket_description">{% if current_lang == 'en' %}Description{% else %}详细描述{% endif %}</label>
                        <textarea class="form-control" id="ticketDescription" rows="5" placeholder="{% if current_lang == 'en' %}Please provide detailed information about your issue...{% else %}请详细描述您遇到的问题...{% endif %}" style="background: var(--hosting-bg-primary); border-color: var(--hosting-border); color: var(--hosting-text);"></textarea>
                    </div>
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-info btn-sm" onclick="generateAIDraft()">
                            <i class="bi bi-robot me-1"></i>
                            <span data-i18n="ai_generate">{% if current_lang == 'en' %}AI Generate Draft{% else %}AI生成草稿{% endif %}</span>
                        </button>
                        <small class="text-muted ms-2" data-i18n="ai_generate_hint">{% if current_lang == 'en' %}Auto-fill based on selected device alerts{% else %}基于所选设备告警自动填充{% endif %}</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="related_device">{% if current_lang == 'en' %}Related Device (Optional){% else %}关联设备（可选）{% endif %}</label>
                        <select class="form-select" id="relatedDevice" style="background: var(--hosting-bg-primary); border-color: var(--hosting-border); color: var(--hosting-text);">
                            <option value="">{% if current_lang == 'en' %}-- Select Device --{% else %}-- 选择设备 --{% endif %}</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-top" style="border-color: var(--hosting-border) !important;">
                <button type="button" class="btn btn-hosting-secondary" data-bs-dismiss="modal" data-i18n="cancel">{% if current_lang == 'en' %}Cancel{% else %}取消{% endif %}</button>
                <button type="button" class="btn btn-hosting" onclick="submitTicket()" data-i18n="submit_ticket">{% if current_lang == 'en' %}Submit Ticket{% else %}提交工单{% endif %}</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadTickets();
    loadUserDevices();
    
    // 状态筛选
    document.getElementById('status-filter').addEventListener('change', function() {
        loadTickets(this.value);
    });
});

function loadTickets(statusFilter = 'all') {
    let url = '/hosting/api/tickets';
    if (statusFilter !== 'all') {
        url += `?status=${statusFilter}`;
    }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateTicketStats(data.tickets);
                renderTicketsTable(data.tickets);
            }
        })
        .catch(error => {
            console.error('Error loading tickets:', error);
        });
}

function updateTicketStats(tickets) {
    const stats = {
        total: tickets.length,
        pending: tickets.filter(t => t.status === 'open').length,
        processing: tickets.filter(t => t.status === 'in_progress' || t.status === 'assigned').length,
        resolved: tickets.filter(t => t.status === 'resolved' || t.status === 'closed').length
    };
    
    document.getElementById('total-tickets').textContent = stats.total;
    document.getElementById('pending-tickets').textContent = stats.pending;
    document.getElementById('processing-tickets').textContent = stats.processing;
    document.getElementById('resolved-tickets').textContent = stats.resolved;
}

function renderTicketsTable(tickets) {
    const tbody = document.getElementById('tickets-table-body');
    const lang = document.querySelector('meta[name="language"]')?.content || 'zh';
    
    if (tickets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center py-5">
                    <i class="bi bi-ticket-perforated fs-1 text-muted mb-3 d-block"></i>
                    <div class="text-muted">${lang === 'en' ? 'No tickets found' : '暂无工单记录'}</div>
                    <small class="text-muted">${lang === 'en' ? 'Create a ticket when you need assistance' : '遇到问题时可以新建工单'}</small>
                </td>
            </tr>
        `;
        return;
    }
    
    tbody.innerHTML = tickets.map(ticket => `
        <tr style="border-bottom: 1px solid var(--hosting-border);">
            <td class="ps-4">
                <span class="text-warning fw-bold">#${ticket.id}</span>
            </td>
            <td>
                <a href="javascript:void(0)" onclick="viewTicket(${ticket.id})" class="text-decoration-none text-white">
                    ${ticket.title}
                </a>
            </td>
            <td>${getTypeLabel(ticket.type, lang)}</td>
            <td>${getPriorityBadge(ticket.priority, lang)}</td>
            <td>${getStatusBadge(ticket.status, lang)}</td>
            <td>${formatDate(ticket.created_at)}</td>
            <td class="pe-4">
                <button class="btn btn-sm btn-hosting-outline" onclick="viewTicket(${ticket.id})">
                    <i class="bi bi-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function getTypeLabel(type, lang) {
    const types = {
        'hardware': lang === 'en' ? 'Hardware' : '硬件',
        'network': lang === 'en' ? 'Network' : '网络',
        'billing': lang === 'en' ? 'Billing' : '账单',
        'maintenance': lang === 'en' ? 'Maintenance' : '维护',
        'other': lang === 'en' ? 'Other' : '其他'
    };
    return types[type] || type;
}

function getPriorityBadge(priority, lang) {
    const priorities = {
        'low': { label: lang === 'en' ? 'Low' : '低', class: 'bg-secondary' },
        'normal': { label: lang === 'en' ? 'Normal' : '普通', class: 'bg-info' },
        'high': { label: lang === 'en' ? 'High' : '高', class: 'bg-warning text-dark' },
        'urgent': { label: lang === 'en' ? 'Urgent' : '紧急', class: 'bg-danger' }
    };
    const p = priorities[priority] || { label: priority, class: 'bg-secondary' };
    return `<span class="badge ${p.class}">${p.label}</span>`;
}

function getStatusBadge(status, lang) {
    const statuses = {
        'open': { label: lang === 'en' ? 'Open' : '待处理', class: 'bg-warning text-dark' },
        'assigned': { label: lang === 'en' ? 'Assigned' : '已分配', class: 'bg-info' },
        'in_progress': { label: lang === 'en' ? 'In Progress' : '处理中', class: 'bg-primary' },
        'resolved': { label: lang === 'en' ? 'Resolved' : '已解决', class: 'bg-success' },
        'closed': { label: lang === 'en' ? 'Closed' : '已关闭', class: 'bg-secondary' }
    };
    const s = statuses[status] || { label: status, class: 'bg-secondary' };
    return `<span class="badge ${s.class}">${s.label}</span>`;
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}

function loadUserDevices() {
    fetch('/hosting/api/client/miners')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('relatedDevice');
                data.miners.forEach(miner => {
                    const option = document.createElement('option');
                    option.value = miner.id;
                    option.textContent = `${miner.serial_number} - ${miner.model}`;
                    if (miner.site_id) {
                        option.setAttribute('data-site-id', miner.site_id);
                    }
                    select.appendChild(option);
                });
            }
        })
        .catch(error => console.error('Error loading devices:', error));
}

function openNewTicketModal(type = null) {
    if (type) {
        document.getElementById('ticketType').value = type;
    }
    new bootstrap.Modal(document.getElementById('newTicketModal')).show();
}

function submitTicket() {
    const title = document.getElementById('ticketTitle').value.trim();
    const description = document.getElementById('ticketDescription').value.trim();
    const type = document.getElementById('ticketType').value;
    const priority = document.getElementById('ticketPriority').value;
    const device = document.getElementById('relatedDevice').value;
    
    const lang = document.querySelector('meta[name="language"]')?.content || 'zh';
    
    if (!title || !description) {
        alert(lang === 'en' ? 'Please fill in the title and description' : '请填写标题和描述');
        return;
    }
    
    fetch('/hosting/api/tickets', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            title: title,
            description: description,
            type: type,
            priority: priority,
            miner_id: device || null
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('newTicketModal')).hide();
            document.getElementById('newTicketForm').reset();
            loadTickets();
            alert(lang === 'en' ? 'Ticket submitted successfully' : '工单提交成功');
        } else {
            alert(data.error || (lang === 'en' ? 'Failed to submit ticket' : '提交失败'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(lang === 'en' ? 'Failed to submit ticket' : '提交失败');
    });
}

function viewTicket(ticketId) {
    const lang = document.querySelector('meta[name="language"]')?.content || 'zh';
    alert(lang === 'en' ? 'Ticket detail view coming soon' : '工单详情功能即将上线');
}

function generateAIDraft() {
    const deviceId = document.getElementById('relatedDevice').value;
    const ticketType = document.getElementById('ticketType').value;
    const deviceOption = document.getElementById('relatedDevice').selectedOptions[0];
    const siteId = deviceOption ? deviceOption.getAttribute('data-site-id') : null;
    
    if (!deviceId) {
        showTicketToast(getLanguage() === 'en' ? 'Please select a related device first' : '请先选择关联设备', 'warning');
        return;
    }
    
    const finalSiteId = siteId || (window.currentSiteId || null);
    if (!finalSiteId) {
        showTicketToast(getLanguage() === 'en' ? 'Site information not available. Please try again later.' : '站点信息不可用，请稍后再试。', 'warning');
        return;
    }
    
    const btn = event.target.closest('button');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>' + (getLanguage() === 'en' ? 'Generating...' : '生成中...');
    
    fetch('/api/v1/ai/ticket/draft', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            site_id: parseInt(finalSiteId),
            miner_ids: [deviceId],
            alert_type: ticketType === 'hardware' ? 'hashrate_drop' : (ticketType === 'network' ? 'offline' : 'temperature_high')
        })
    })
    .then(r => r.json())
    .then(data => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot me-1"></i>' + (getLanguage() === 'en' ? 'AI Generate Draft' : 'AI生成草稿');
        
        if (data.success && data.ticket_draft) {
            const lang = getLanguage();
            const draft = data.ticket_draft;
            
            document.getElementById('ticketTitle').value = lang === 'en' ? draft.title : draft.title_zh;
            
            let desc = lang === 'en' ? draft.problem_description : draft.problem_description_zh;
            desc += '\n\n' + (lang === 'en' ? '--- Impact Scope ---\n' : '--- 影响范围 ---\n');
            desc += lang === 'en' ? draft.impact_scope : draft.impact_scope_zh;
            desc += '\n\n' + (lang === 'en' ? '--- Troubleshooting Steps ---\n' : '--- 排查步骤 ---\n');
            desc += lang === 'en' ? draft.troubleshooting_steps : draft.troubleshooting_steps_zh;
            
            document.getElementById('ticketDescription').value = desc;
            
            showTicketToast(lang === 'en' ? 'Draft generated successfully' : '草稿生成成功', 'success');
        } else {
            showTicketToast(data.error || (getLanguage() === 'en' ? 'Generation failed' : '生成失败'), 'error');
        }
    })
    .catch(err => {
        btn.disabled = false;
        btn.innerHTML = '<i class="bi bi-robot me-1"></i>' + (getLanguage() === 'en' ? 'AI Generate Draft' : 'AI生成草稿');
        showTicketToast('Error: ' + err.message, 'error');
    });
}

function showTicketToast(message, type) {
    console.log('[' + type.toUpperCase() + '] ' + message);
    alert(message);
}

function getLanguage() {
    const langMeta = document.querySelector('meta[name="language"]');
    return langMeta ? langMeta.content : 'en';
}
</script>
{% endblock %}
