{% extends "crm/base.html" %}
{% block title %}添加佣金记录{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="text-light mb-0">添加佣金记录</h2>
                <p class="text-muted">记录客户的月度挖矿利润和您的佣金收入</p>
            </div>
            <a href="{{ url_for('broker.commissions') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-2"></i>返回佣金管理
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">佣金记录信息</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="deal_id" class="form-label">选择交易</label>
                                <select class="form-select" id="deal_id" name="deal_id" required onchange="updateCommissionInfo()">
                                    <option value="">请选择交易</option>
                                    {% for deal in deals %}
                                    <option value="{{ deal.id }}" 
                                            data-commission-type="{{ deal.commission_type }}"
                                            data-commission-rate="{{ deal.commission_rate or 0 }}"
                                            data-commission-amount="{{ deal.commission_amount or 0 }}"
                                            data-customer-name="{{ deal.customer.name if deal.customer else '未知客户' }}"
                                            data-mining-farm="{{ deal.mining_farm_name or '未指定' }}">
                                        {{ deal.title }} - {{ deal.customer.name if deal.customer else '未知客户' }}
                                        {% if deal.commission_type == 'percentage' %}
                                            ({{ deal.commission_rate }}% 抽成)
                                        {% else %}
                                            (固定收费 ${{ "{:,.2f}".format(deal.commission_amount or 0) }})
                                        {% endif %}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="record_month" class="form-label">记录月份</label>
                                <input type="month" class="form-control" id="record_month" name="record_month" 
                                       value="{{ datetime.now().strftime('%Y-%m') }}" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client_monthly_profit" class="form-label">客户月度利润 (USD)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control" id="client_monthly_profit" 
                                           name="client_monthly_profit" required oninput="calculateCommission()">
                                </div>
                                <div class="form-text">客户在这个月的净挖矿利润</div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="client_btc_mined" class="form-label">客户产出BTC (可选)</label>
                                <div class="input-group">
                                    <input type="number" step="0.00000001" class="form-control" id="client_btc_mined" 
                                           name="client_btc_mined" placeholder="0.00000000">
                                    <span class="input-group-text">BTC</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="btc_price" class="form-label">BTC价格 (可选)</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    <input type="number" step="0.01" class="form-control" id="btc_price" 
                                           name="btc_price" placeholder="0.00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">预计佣金</label>
                                <div class="form-control-plaintext bg-light border rounded p-2">
                                    <span id="calculated_commission" class="fw-bold text-success">请先选择交易和输入利润</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">备注</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="可以添加关于这个月挖矿情况的备注..."></textarea>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('broker.commissions') }}" class="btn btn-outline-secondary me-md-2">取消</a>
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-plus-circle me-2"></i>添加佣金记录
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- 交易信息显示 -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">交易信息</h6>
            </div>
            <div class="card-body">
                <div id="deal-info" style="display: none;">
                    <div class="mb-2">
                        <small class="text-muted">客户:</small>
                        <div id="customer-name" class="fw-bold">-</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">矿场:</small>
                        <div id="mining-farm" class="fw-bold">-</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">佣金模式:</small>
                        <div id="commission-mode" class="fw-bold">-</div>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">佣金设置:</small>
                        <div id="commission-setting" class="fw-bold">-</div>
                    </div>
                </div>
                <div id="no-deal-selected" class="text-center p-4">
                    <i class="bi bi-info-circle text-muted mb-2" style="font-size: 2rem;"></i>
                    <p class="text-muted mb-0">请先选择交易</p>
                </div>
            </div>
        </div>
        
        <!-- 佣金计算说明 -->
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">佣金计算说明</h6>
            </div>
            <div class="card-body">
                <div class="d-flex align-items-start mb-3">
                    <i class="bi bi-percent text-primary me-2 mt-1"></i>
                    <div>
                        <strong>利润抽成:</strong>
                        <small class="text-muted d-block">佣金 = 客户利润 × 抽成比例</small>
                    </div>
                </div>
                <div class="d-flex align-items-start">
                    <i class="bi bi-currency-dollar text-success me-2 mt-1"></i>
                    <div>
                        <strong>固定收费:</strong>
                        <small class="text-muted d-block">佣金 = 固定金额(不受利润影响)</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateCommissionInfo() {
    const dealSelect = document.getElementById('deal_id');
    const selectedOption = dealSelect.options[dealSelect.selectedIndex];
    
    if (selectedOption.value) {
        // 显示交易信息
        document.getElementById('deal-info').style.display = 'block';
        document.getElementById('no-deal-selected').style.display = 'none';
        
        document.getElementById('customer-name').textContent = selectedOption.dataset.customerName;
        document.getElementById('mining-farm').textContent = selectedOption.dataset.miningFarm;
        
        const commissionType = selectedOption.dataset.commissionType;
        if (commissionType === 'percentage') {
            document.getElementById('commission-mode').textContent = '利润抽成';
            document.getElementById('commission-setting').textContent = selectedOption.dataset.commissionRate + '%';
        } else {
            document.getElementById('commission-mode').textContent = '固定收费';
            document.getElementById('commission-setting').textContent = '$' + parseFloat(selectedOption.dataset.commissionAmount).toLocaleString();
        }
    } else {
        // 隐藏交易信息
        document.getElementById('deal-info').style.display = 'none';
        document.getElementById('no-deal-selected').style.display = 'block';
    }
    
    calculateCommission();
}

function calculateCommission() {
    const dealSelect = document.getElementById('deal_id');
    const selectedOption = dealSelect.options[dealSelect.selectedIndex];
    const profitInput = document.getElementById('client_monthly_profit');
    const commissionDisplay = document.getElementById('calculated_commission');
    
    if (!selectedOption.value || !profitInput.value) {
        commissionDisplay.textContent = '请先选择交易和输入利润';
        return;
    }
    
    const profit = parseFloat(profitInput.value);
    const commissionType = selectedOption.dataset.commissionType;
    let commission = 0;
    
    if (commissionType === 'percentage') {
        const rate = parseFloat(selectedOption.dataset.commissionRate);
        commission = profit * (rate / 100);
        commissionDisplay.textContent = `$${commission.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (${rate}% 抽成)`;
    } else {
        commission = parseFloat(selectedOption.dataset.commissionAmount);
        commissionDisplay.textContent = `$${commission.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} (固定收费)`;
    }
}
</script>
{% endblock %}