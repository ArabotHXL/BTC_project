{% extends "base.html" %}

{% block title %}
    Feature Interactions / åŠŸèƒ½äº¤äº’å›¾ - HashInsight Enterprise
{% endblock %}

{% block header_title %}
    <i class="bi bi-arrow-left-right me-2"></i>Feature Interactions / åŠŸèƒ½äº¤äº’å›¾
{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
{% endblock %}

{% block extra_css %}
<style>
body {
    background: linear-gradient(135deg, #1a1d2e 0%, #0d0f1a 100%);
    min-height: 100vh;
}
.diagram-container {
    background: rgba(26, 29, 46, 0.95);
    border-radius: 16px;
    border: 1px solid rgba(247, 147, 26, 0.2);
    padding: 30px;
    margin: 20px auto;
}
.diagram-title {
    color: #f7931a;
    text-align: center;
    margin-bottom: 10px;
    font-size: 1.6rem;
    font-weight: 600;
}
.diagram-subtitle {
    color: #8a8fa8;
    text-align: center;
    margin-bottom: 30px;
    font-size: 0.95rem;
}

.section-title {
    color: #f7931a;
    font-size: 1.1rem;
    margin: 25px 0 15px;
    padding-bottom: 8px;
    border-bottom: 1px solid rgba(247, 147, 26, 0.3);
}

.mermaid-container {
    background: rgba(13, 15, 26, 0.8);
    border-radius: 12px;
    padding: 25px;
    overflow-x: auto;
    margin-bottom: 20px;
}

.back-btn {
    color: #f7931a;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: 0.9rem;
}
.back-btn:hover {
    color: #d4780f;
}

.tab-btn {
    background: rgba(26, 29, 46, 0.9);
    border: 1px solid rgba(247, 147, 26, 0.3);
    color: #8a8fa8;
    padding: 10px 20px;
    border-radius: 8px;
    margin: 0 5px 10px;
    cursor: pointer;
    transition: all 0.3s;
}
.tab-btn:hover, .tab-btn.active {
    background: rgba(247, 147, 26, 0.2);
    border-color: #f7931a;
    color: #f7931a;
}

.diagram-section {
    display: none;
}
.diagram-section.active {
    display: block;
}

.interaction-card {
    background: rgba(26, 29, 46, 0.8);
    border: 1px solid rgba(247, 147, 26, 0.2);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}
.interaction-card h5 {
    color: #f7931a;
    font-size: 1rem;
    margin-bottom: 10px;
}
.interaction-card p {
    color: #8a8fa8;
    font-size: 0.85rem;
    margin-bottom: 0;
}
.arrow-flow {
    color: #27ae60;
    font-family: monospace;
    font-size: 0.9rem;
}

.legend-box {
    display: inline-flex;
    align-items: center;
    margin: 5px 15px 5px 0;
}
.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 4px;
    margin-right: 8px;
}
.legend-text {
    color: #8a8fa8;
    font-size: 0.8rem;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
    <a href="{{ url_for('relationship_diagram') }}" class="back-btn">
        <i class="bi bi-arrow-left me-2"></i>
        è¿”å›ç³»ç»Ÿå…³ç³»å›¾ / Back to System Diagram
    </a>
    
    <div class="diagram-container">
        <h2 class="diagram-title">
            <i class="bi bi-arrow-left-right me-2"></i>
            åŠŸèƒ½æ¨¡å—äº¤äº’å›¾ / Feature Interaction Map
        </h2>
        <p class="diagram-subtitle">How each feature talks to each other / æ¯ä¸ªåŠŸèƒ½æ¨¡å—å¦‚ä½•ç›¸äº’é€šä¿¡</p>
        
        <div class="text-center mb-4">
            <button class="tab-btn active" onclick="showSection('full')">
                <i class="bi bi-diagram-3 me-1"></i>Full System / å®Œæ•´ç³»ç»Ÿ
            </button>
            <button class="tab-btn" onclick="showSection('hosting')">
                <i class="bi bi-cpu me-1"></i>Hosting Core / æ‰˜ç®¡æ ¸å¿ƒ
            </button>
            <button class="tab-btn" onclick="showSection('data')">
                <i class="bi bi-database me-1"></i>Data Flow / æ•°æ®æµ
            </button>
            <button class="tab-btn" onclick="showSection('api')">
                <i class="bi bi-plug me-1"></i>API Integrations / APIé›†æˆ
            </button>
            <button class="tab-btn" onclick="showSection('realtime')">
                <i class="bi bi-broadcast me-1"></i>Real-time / å®æ—¶é€šä¿¡
            </button>
            <button class="tab-btn" onclick="showSection('encryption')">
                <i class="bi bi-shield-lock me-1"></i>Encryption / åŠ å¯†ç³»ç»Ÿ
            </button>
        </div>
        
        <div class="text-center mb-4">
            <span class="legend-box">
                <span class="legend-color" style="background: #f7931a;"></span>
                <span class="legend-text">Core Module æ ¸å¿ƒæ¨¡å—</span>
            </span>
            <span class="legend-box">
                <span class="legend-color" style="background: #27ae60;"></span>
                <span class="legend-text">Service æœåŠ¡å±‚</span>
            </span>
            <span class="legend-box">
                <span class="legend-color" style="background: #3498db;"></span>
                <span class="legend-text">Data/API æ•°æ®å±‚</span>
            </span>
            <span class="legend-box">
                <span class="legend-color" style="background: #9b59b6;"></span>
                <span class="legend-text">External å¤–éƒ¨é›†æˆ</span>
            </span>
            <span class="legend-box">
                <span class="legend-color" style="background: #e74c3c;"></span>
                <span class="legend-text">Real-time å®æ—¶é€šä¿¡</span>
            </span>
            <span class="legend-box">
                <span class="legend-color" style="background: #1abc9c;"></span>
                <span class="legend-text">Security å®‰å…¨å±‚</span>
            </span>
        </div>
        
        <div id="section-full" class="diagram-section active">
            <h4 class="section-title"><i class="bi bi-diagram-3 me-2"></i>Complete Feature Interaction Map / å®Œæ•´åŠŸèƒ½äº¤äº’å›¾</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
graph TB
    subgraph UserInterface["ğŸ–¥ï¸ User Interface ç”¨æˆ·ç•Œé¢"]
        Dashboard[Dashboard<br/>ä»ªè¡¨ç›˜]
        Calculator[Calculator<br/>æŒ–çŸ¿è®¡ç®—å™¨]
        HostingUI[Hosting UI<br/>æ‰˜ç®¡ç•Œé¢]
        CRMUI[CRM UI<br/>å®¢æˆ·ç®¡ç†ç•Œé¢]
        ClientPortal[Client Portal<br/>å®¢æˆ·é—¨æˆ·]
    end
    
    subgraph CoreModules["âš™ï¸ Core Modules æ ¸å¿ƒæ¨¡å—"]
        HostingService[Hosting Service<br/>æ‰˜ç®¡æœåŠ¡]
        MinerMgmt[Miner Management<br/>çŸ¿æœºç®¡ç†]
        CRMService[CRM Service<br/>å®¢æˆ·å…³ç³»æœåŠ¡]
        ThermalProtection[Thermal Protection<br/>æ¸©æ§ä¿æŠ¤]
        Curtailment[Curtailment Scheduler<br/>é™ç”µè°ƒåº¦]
    end
    
    subgraph DataServices["ğŸ“Š Data Services æ•°æ®æœåŠ¡"]
        CGMinerCollector[CGMiner Collector<br/>CGMineré‡‡é›†å™¨]
        EdgeCollector[Edge Collector<br/>è¾¹ç¼˜é‡‡é›†å™¨]
        TelemetryService[Telemetry Service<br/>é¥æµ‹æœåŠ¡]
        AnalyticsEngine[Analytics Engine<br/>åˆ†æå¼•æ“]
    end
    
    subgraph Intelligence["ğŸ§  Intelligence Layer æ™ºèƒ½å±‚"]
        Forecast[Price/Difficulty Forecast<br/>ä»·æ ¼/éš¾åº¦é¢„æµ‹]
        PowerOptimize[Power Optimization<br/>ç”µåŠ›ä¼˜åŒ–]
        AnomalyDetect[Anomaly Detection<br/>å¼‚å¸¸æ£€æµ‹]
        ROIExplain[ROI Explanation<br/>æ”¶ç›Šè§£é‡Š]
    end
    
    subgraph ExternalAPIs["ğŸŒ External APIs å¤–éƒ¨æ¥å£"]
        CoinGecko[CoinGecko API<br/>ä»·æ ¼æ•°æ®]
        Blockchain[Blockchain API<br/>ç½‘ç»œæ•°æ®]
        Exchanges[Exchange APIs<br/>äº¤æ˜“æ‰€æ•°æ®]
    end
    
    subgraph Database["ğŸ’¾ Database æ•°æ®åº“"]
        PostgreSQL[(PostgreSQL<br/>ä¸»æ•°æ®åº“)]
        Redis[(Redis<br/>ç¼“å­˜/é˜Ÿåˆ—)]
    end
    
    subgraph Security["ğŸ” Security Layer å®‰å…¨å±‚"]
        E2EE[E2EE Module<br/>ç«¯åˆ°ç«¯åŠ å¯†]
        PBKDF2[PBKDF2 Key Derivation<br/>å¯†é’¥æ´¾ç”Ÿ]
        AES256[AES-256-GCM<br/>å¯¹ç§°åŠ å¯†]
    end
    
    Dashboard --> HostingService
    Dashboard --> CRMService
    Dashboard --> AnalyticsEngine
    Calculator --> Forecast
    Calculator --> AnalyticsEngine
    HostingUI --> HostingService
    HostingUI --> MinerMgmt
    CRMUI --> CRMService
    ClientPortal --> HostingService
    
    HostingService --> MinerMgmt
    HostingService --> ThermalProtection
    HostingService --> Curtailment
    MinerMgmt --> CGMinerCollector
    MinerMgmt --> EdgeCollector
    ThermalProtection --> MinerMgmt
    Curtailment --> MinerMgmt
    
    CGMinerCollector --> TelemetryService
    EdgeCollector --> TelemetryService
    TelemetryService --> AnalyticsEngine
    AnalyticsEngine --> Forecast
    AnalyticsEngine --> AnomalyDetect
    
    Forecast --> PowerOptimize
    AnomalyDetect --> ThermalProtection
    PowerOptimize --> Curtailment
    ROIExplain --> Calculator
    
    CoinGecko --> AnalyticsEngine
    Blockchain --> AnalyticsEngine
    Exchanges --> AnalyticsEngine
    
    HostingService --> PostgreSQL
    CRMService --> PostgreSQL
    MinerMgmt --> PostgreSQL
    TelemetryService --> PostgreSQL
    AnalyticsEngine --> Redis
    CGMinerCollector --> Redis
    
    CRMService -.->|email sync| HostingService
    
    HostingUI -->|encrypt credentials| E2EE
    E2EE --> PBKDF2
    PBKDF2 --> AES256
    AES256 -->|encrypted data| PostgreSQL
    EdgeCollector -->|decrypt| E2EE
    
    style UserInterface fill:#1a1d2e,stroke:#f7931a
    style CoreModules fill:#1a1d2e,stroke:#27ae60
    style DataServices fill:#1a1d2e,stroke:#3498db
    style Intelligence fill:#1a1d2e,stroke:#9b59b6
    style ExternalAPIs fill:#1a1d2e,stroke:#e74c3c
    style Database fill:#1a1d2e,stroke:#f39c12
    style Security fill:#1a1d2e,stroke:#1abc9c
                </pre>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-arrow-repeat me-2"></i>CRM â†” Hosting Sync</h5>
                        <p class="arrow-flow">Customer.email â†’ UserAccess.email â†’ UserMiner</p>
                        <p>CRMå®¢æˆ·é€šè¿‡é‚®ç®±åŒ¹é…å…³è”åˆ°æ‰˜ç®¡çŸ¿æœºæ•°æ®ï¼Œå®ç°è·¨æ¨¡å—æ•°æ®åŒæ­¥</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-thermometer-half me-2"></i>Thermal â†’ Miner Control</h5>
                        <p class="arrow-flow">Temperature Event â†’ Frequency Throttle â†’ CGMiner Command</p>
                        <p>æ¸©æ§æœåŠ¡æ£€æµ‹åˆ°é«˜æ¸©æ—¶è‡ªåŠ¨é™é¢‘ï¼Œé€šè¿‡CGMiner APIå‘é€æ§åˆ¶å‘½ä»¤</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-lightning me-2"></i>Curtailment â†’ Miner</h5>
                        <p class="arrow-flow">Schedule Plan â†’ Miner Selection â†’ Stop/Start Command</p>
                        <p>é™ç”µè°ƒåº¦æŒ‰è®¡åˆ’è‡ªåŠ¨åœæ­¢/å¯åŠ¨çŸ¿æœºï¼Œæ”¯æŒä¼˜å…ˆçº§ç­–ç•¥å’Œè‡ªåŠ¨æ¢å¤</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="section-hosting" class="diagram-section">
            <h4 class="section-title"><i class="bi bi-cpu me-2"></i>Hosting Core Interactions / æ‰˜ç®¡æ ¸å¿ƒäº¤äº’</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
graph LR
    subgraph MinerLayer["çŸ¿æœºå±‚ Miner Layer"]
        Miner1[Miner 1]
        Miner2[Miner 2]
        MinerN[Miner N...]
    end
    
    subgraph CollectorLayer["é‡‡é›†å±‚ Collector Layer"]
        CGMiner[CGMiner API<br/>ç«¯å£4028]
        EdgeAgent[Edge Agent<br/>è¾¹ç¼˜ä»£ç†]
    end
    
    subgraph ProcessLayer["å¤„ç†å±‚ Process Layer"]
        Scheduler[CGMiner Scheduler<br/>é‡‡é›†è°ƒåº¦å™¨]
        CommandQueue[Command Queue<br/>å‘½ä»¤é˜Ÿåˆ—]
        TelemetryDB[Telemetry Storage<br/>é¥æµ‹å­˜å‚¨]
    end
    
    subgraph ControlLayer["æ§åˆ¶å±‚ Control Layer"]
        ThermalCtrl[Thermal Controller<br/>æ¸©æ§å™¨]
        CurtailCtrl[Curtailment Controller<br/>é™ç”µæ§åˆ¶å™¨]
        ManualCtrl[Manual Control<br/>æ‰‹åŠ¨æ§åˆ¶]
    end
    
    subgraph MonitorLayer["ç›‘æ§å±‚ Monitor Layer"]
        StatusDash[Status Dashboard<br/>çŠ¶æ€ä»ªè¡¨ç›˜]
        AlertSystem[Alert System<br/>å‘Šè­¦ç³»ç»Ÿ]
        ReportGen[Report Generator<br/>æŠ¥è¡¨ç”Ÿæˆ]
    end
    
    Miner1 --> CGMiner
    Miner2 --> CGMiner
    MinerN --> CGMiner
    Miner1 --> EdgeAgent
    Miner2 --> EdgeAgent
    MinerN --> EdgeAgent
    
    CGMiner --> Scheduler
    EdgeAgent --> Scheduler
    Scheduler --> TelemetryDB
    Scheduler --> CommandQueue
    
    TelemetryDB --> ThermalCtrl
    TelemetryDB --> CurtailCtrl
    TelemetryDB --> StatusDash
    TelemetryDB --> AlertSystem
    TelemetryDB --> ReportGen
    
    ThermalCtrl --> CommandQueue
    CurtailCtrl --> CommandQueue
    ManualCtrl --> CommandQueue
    
    CommandQueue --> CGMiner
    CommandQueue --> EdgeAgent
    
    style MinerLayer fill:#1a1d2e,stroke:#f7931a
    style CollectorLayer fill:#1a1d2e,stroke:#e74c3c
    style ProcessLayer fill:#1a1d2e,stroke:#3498db
    style ControlLayer fill:#1a1d2e,stroke:#27ae60
    style MonitorLayer fill:#1a1d2e,stroke:#9b59b6
                </pre>
            </div>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="interaction-card">
                        <h5><i class="bi bi-arrow-down-up me-2"></i>Bidirectional Communication / åŒå‘é€šä¿¡</h5>
                        <p class="arrow-flow">Cloud âŸ· Edge Collector âŸ· CGMiner API âŸ· Miner</p>
                        <p>äº‘ç«¯å¯ä»¥é€šè¿‡è¾¹ç¼˜é‡‡é›†å™¨å‘çŸ¿æœºå‘é€æ§åˆ¶å‘½ä»¤ï¼ŒåŒæ—¶æ¥æ”¶å®æ—¶é¥æµ‹æ•°æ®</p>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="interaction-card">
                        <h5><i class="bi bi-clock-history me-2"></i>Scheduled Collection / å®šæ—¶é‡‡é›†</h5>
                        <p class="arrow-flow">APScheduler â†’ CGMiner Collector â†’ Database â†’ Cache</p>
                        <p>æ¯60ç§’è‡ªåŠ¨é‡‡é›†æ‰€æœ‰çŸ¿æœºæ•°æ®ï¼Œæ›´æ–°æ•°æ®åº“å’ŒRedisç¼“å­˜</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="section-data" class="diagram-section">
            <h4 class="section-title"><i class="bi bi-database me-2"></i>Data Flow Architecture / æ•°æ®æµæ¶æ„</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
graph TB
    subgraph Sources["ğŸ“¥ Data Sources æ•°æ®æº"]
        MinerAPI[Miner CGMiner API]
        PriceAPI[Price APIs<br/>CoinGecko/Exchanges]
        NetworkAPI[Network APIs<br/>Blockchain.info/Mempool]
        UserInput[User Input<br/>ç”¨æˆ·è¾“å…¥]
    end
    
    subgraph Collectors["ğŸ”„ Data Collectors æ•°æ®é‡‡é›†"]
        CGCollector[CGMiner Collector<br/>çŸ¿æœºé‡‡é›†å™¨]
        MarketCollector[Market Collector<br/>å¸‚åœºé‡‡é›†å™¨]
        ExchangeCollector[Multi-Exchange Collector<br/>å¤šäº¤æ˜“æ‰€é‡‡é›†å™¨]
    end
    
    subgraph Processing["âš™ï¸ Data Processing æ•°æ®å¤„ç†"]
        Aggregation[Data Aggregation<br/>æ•°æ®èšåˆ]
        Validation[Data Validation<br/>æ•°æ®éªŒè¯]
        Transform[Data Transform<br/>æ•°æ®è½¬æ¢]
    end
    
    subgraph Storage["ğŸ’¾ Data Storage æ•°æ®å­˜å‚¨"]
        PG[(PostgreSQL<br/>æŒä¹…åŒ–å­˜å‚¨)]
        RedisCache[(Redis Cache<br/>çƒ­æ•°æ®ç¼“å­˜)]
        TimeSeries[Time Series Data<br/>æ—¶åºæ•°æ®è¡¨]
    end
    
    subgraph Analytics["ğŸ“Š Analytics æ•°æ®åˆ†æ"]
        TechIndicators[Technical Indicators<br/>æŠ€æœ¯æŒ‡æ ‡]
        ProfitCalc[Profitability Calc<br/>æ”¶ç›Šè®¡ç®—]
        TrendAnalysis[Trend Analysis<br/>è¶‹åŠ¿åˆ†æ]
    end
    
    subgraph Output["ğŸ“¤ Data Output æ•°æ®è¾“å‡º"]
        Dashboard[Dashboard Display<br/>ä»ªè¡¨ç›˜å±•ç¤º]
        Reports[Report Generation<br/>æŠ¥è¡¨ç”Ÿæˆ]
        Alerts[Alert Notifications<br/>å‘Šè­¦é€šçŸ¥]
        APIResponse[API Responses<br/>APIå“åº”]
    end
    
    MinerAPI --> CGCollector
    PriceAPI --> MarketCollector
    NetworkAPI --> MarketCollector
    PriceAPI --> ExchangeCollector
    UserInput --> Validation
    
    CGCollector --> Aggregation
    MarketCollector --> Aggregation
    ExchangeCollector --> Aggregation
    
    Aggregation --> Validation
    Validation --> Transform
    
    Transform --> PG
    Transform --> RedisCache
    Transform --> TimeSeries
    
    PG --> TechIndicators
    PG --> ProfitCalc
    TimeSeries --> TrendAnalysis
    RedisCache --> Dashboard
    
    TechIndicators --> Dashboard
    ProfitCalc --> Dashboard
    TrendAnalysis --> Reports
    PG --> Reports
    TechIndicators --> Alerts
    RedisCache --> APIResponse
    
    style Sources fill:#1a1d2e,stroke:#e74c3c
    style Collectors fill:#1a1d2e,stroke:#f39c12
    style Processing fill:#1a1d2e,stroke:#27ae60
    style Storage fill:#1a1d2e,stroke:#3498db
    style Analytics fill:#1a1d2e,stroke:#9b59b6
    style Output fill:#1a1d2e,stroke:#f7931a
                </pre>
            </div>
        </div>
        
        <div id="section-api" class="diagram-section">
            <h4 class="section-title"><i class="bi bi-plug me-2"></i>API Integration Map / APIé›†æˆå›¾</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
graph LR
    subgraph InternalAPIs["ğŸ  Internal APIs å†…éƒ¨API"]
        HostingAPI[/api/hosting/*<br/>æ‰˜ç®¡API/]
        ClientAPI[/api/client/*<br/>å®¢æˆ·API/]
        CRMAPI[/crm/api/*<br/>CRM API/]
        AnalyticsAPI[/api/analytics/*<br/>åˆ†æAPI/]
        IntelligenceAPI[/api/intelligence/*<br/>æ™ºèƒ½API/]
        CollectorAPI[/api/collector/*<br/>é‡‡é›†å™¨API/]
    end
    
    subgraph ExternalAPIs["ğŸŒ External APIs å¤–éƒ¨API"]
        CoinGecko[CoinGecko<br/>ä»·æ ¼/å†å²æ•°æ®]
        BlockchainInfo[Blockchain.info<br/>ç½‘ç»œç»Ÿè®¡]
        Mempool[Mempool.space<br/>äº¤æ˜“è´¹/éš¾åº¦]
        Deribit[Deribit API<br/>æœŸæƒæ•°æ®]
        Binance[Binance API<br/>ç°è´§/åˆçº¦]
        OKX[OKX API<br/>äº¤æ˜“æ•°æ®]
    end
    
    subgraph MinerAPIs["â›ï¸ Miner APIs çŸ¿æœºAPI"]
        CGMinerAPI[CGMiner API<br/>:4028]
        BraiinsAPI[Braiins API<br/>:8080]
        EdgeAPI[Edge Collector API<br/>æœ¬åœ°é‡‡é›†]
    end
    
    subgraph Services["âš™ï¸ Backend Services"]
        FlaskApp[Flask Application]
        Redis[Redis Cache]
        Scheduler[APScheduler]
    end
    
    HostingAPI --> FlaskApp
    ClientAPI --> FlaskApp
    CRMAPI --> FlaskApp
    AnalyticsAPI --> FlaskApp
    IntelligenceAPI --> FlaskApp
    CollectorAPI --> FlaskApp
    
    FlaskApp --> CoinGecko
    FlaskApp --> BlockchainInfo
    FlaskApp --> Mempool
    FlaskApp --> Deribit
    FlaskApp --> Binance
    FlaskApp --> OKX
    
    FlaskApp --> CGMinerAPI
    FlaskApp --> BraiinsAPI
    EdgeAPI --> FlaskApp
    
    FlaskApp --> Redis
    Scheduler --> FlaskApp
    
    style InternalAPIs fill:#1a1d2e,stroke:#27ae60
    style ExternalAPIs fill:#1a1d2e,stroke:#9b59b6
    style MinerAPIs fill:#1a1d2e,stroke:#e74c3c
    style Services fill:#1a1d2e,stroke:#f7931a
                </pre>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5>Hosting API</h5>
                        <p>/api/sites<br/>/api/miners<br/>/api/telemetry<br/>/api/thermal</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5>CRM API</h5>
                        <p>/crm/api/customers<br/>/crm/api/deals<br/>/crm/api/sync-hosting<br/>/crm/api/sync-status</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5>Intelligence API</h5>
                        <p>/api/intelligence/forecast<br/>/api/intelligence/optimize<br/>/api/intelligence/explain</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5>Collector API</h5>
                        <p>/api/collector/register<br/>/api/collector/telemetry<br/>/api/collector/command</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="section-realtime" class="diagram-section">
            <h4 class="section-title"><i class="bi bi-broadcast me-2"></i>Real-time Communication / å®æ—¶é€šä¿¡</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
sequenceDiagram
    participant Miner as çŸ¿æœº Miner
    participant Edge as è¾¹ç¼˜é‡‡é›†å™¨ Edge
    participant Cloud as äº‘ç«¯ Cloud
    participant DB as æ•°æ®åº“ Database
    participant User as ç”¨æˆ· User
    
    Note over Miner,User: æ•°æ®é‡‡é›†æµç¨‹ Data Collection Flow
    
    loop æ¯60ç§’ Every 60s
        Cloud->>Edge: é‡‡é›†è¯·æ±‚ Collection Request
        Edge->>Miner: CGMiner API Call
        Miner-->>Edge: çŠ¶æ€æ•°æ® Status Data
        Edge-->>Cloud: é¥æµ‹ä¸ŠæŠ¥ Telemetry Report
        Cloud->>DB: å­˜å‚¨æ•°æ® Store Data
    end
    
    Note over Miner,User: æ¸©åº¦å‘Šè­¦æµç¨‹ Thermal Alert Flow
    
    Miner->>Edge: æ¸©åº¦æ•°æ® Temperature
    Edge->>Cloud: é¥æµ‹ä¸ŠæŠ¥ Telemetry
    Cloud->>Cloud: æ£€æµ‹å¼‚å¸¸ Detect Anomaly
    alt æ¸©åº¦è¿‡é«˜ Temperature High
        Cloud->>Edge: é™é¢‘å‘½ä»¤ Throttle Command
        Edge->>Miner: è°ƒæ•´é¢‘ç‡ Adjust Frequency
        Cloud->>User: å‘Šè­¦é€šçŸ¥ Alert
    end
    
    Note over Miner,User: é™ç”µè°ƒåº¦æµç¨‹ Curtailment Flow
    
    Cloud->>Cloud: æ£€æŸ¥è®¡åˆ’ Check Schedule
    alt åˆ°è¾¾é™ç”µæ—¶é—´ Curtailment Time
        Cloud->>Edge: åœæœºå‘½ä»¤ Stop Command
        Edge->>Miner: åœæ­¢æŒ–çŸ¿ Stop Mining
        Cloud->>DB: è®°å½•äº‹ä»¶ Log Event
        Cloud->>User: æ‰§è¡Œé€šçŸ¥ Execution Notice
    end
                </pre>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-arrow-repeat me-2"></i>Polling Model / è½®è¯¢æ¨¡å¼</h5>
                        <p>CGMinerè°ƒåº¦å™¨æ¯60ç§’è½®è¯¢æ‰€æœ‰çŸ¿æœºï¼Œé‡‡é›†çŠ¶æ€ã€ç®—åŠ›ã€æ¸©åº¦ç­‰æ•°æ®</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-exclamation-triangle me-2"></i>Event-Driven / äº‹ä»¶é©±åŠ¨</h5>
                        <p>æ¸©æ§ä¿æŠ¤å’Œé™ç”µè°ƒåº¦é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼ï¼Œè§¦å‘æ¡ä»¶æ—¶ç«‹å³æ‰§è¡Œ</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="interaction-card">
                        <h5><i class="bi bi-arrow-down-up me-2"></i>Bidirectional / åŒå‘é€šä¿¡</h5>
                        <p>è¾¹ç¼˜é‡‡é›†å™¨æ”¯æŒåŒå‘é€šä¿¡ï¼Œæ—¢ä¸ŠæŠ¥æ•°æ®ä¹Ÿæ¥æ”¶äº‘ç«¯æ§åˆ¶å‘½ä»¤</p>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="section-encryption" class="diagram-section">
            <h4 class="section-title"><i class="bi bi-shield-lock me-2"></i>Owner-Level Encryption (E2EE) / ç«¯åˆ°ç«¯åŠ å¯†ç³»ç»Ÿ</h4>
            <div class="mermaid-container">
                <pre class="mermaid">
graph TB
    subgraph Browser["ğŸŒ Browser æµè§ˆå™¨ç«¯"]
        OwnerUI[Site Owner UI<br/>çŸ¿åœºä¸»ç•Œé¢]
        PasswordInput[Owner Password<br/>ä¸»å¯†ç è¾“å…¥]
        JSCrypto[Web Crypto API<br/>æµè§ˆå™¨åŠ å¯†åº“]
    end
    
    subgraph KeyDerivation["ğŸ”‘ Key Derivation å¯†é’¥æ´¾ç”Ÿ"]
        PBKDF2[PBKDF2<br/>100,000 iterations]
        Salt[Random Salt<br/>éšæœºç›å€¼]
        DerivedKey[256-bit AES Key<br/>æ´¾ç”Ÿå¯†é’¥]
    end
    
    subgraph Encryption["ğŸ”’ Encryption åŠ å¯†è¿‡ç¨‹"]
        Plaintext[Miner Credentials<br/>çŸ¿æœºè¿æ¥å‡­è¯]
        IV[Random IV<br/>éšæœºåˆå§‹å‘é‡]
        AES256GCM[AES-256-GCM<br/>è®¤è¯åŠ å¯†]
        Ciphertext[Encrypted Blob<br/>åŠ å¯†æ•°æ®]
        AuthTag[Auth Tag<br/>è®¤è¯æ ‡ç­¾]
    end
    
    subgraph Storage["ğŸ’¾ Cloud Storage äº‘ç«¯å­˜å‚¨"]
        PostgreSQL[(PostgreSQL<br/>encrypted_credentials)]
        SaltStore[(Salt Storage<br/>ç›å€¼å­˜å‚¨)]
        IVStore[(IV Storage<br/>IVå­˜å‚¨)]
    end
    
    subgraph EdgeDecryption["ğŸ­ Edge Collector è¾¹ç¼˜è§£å¯†"]
        EdgeAgent[Edge Collector<br/>è¾¹ç¼˜é‡‡é›†å™¨]
        PyCrypto[Python Cryptography<br/>åŠ å¯†åº“]
        DecryptedCreds[Decrypted Credentials<br/>è§£å¯†å‡­è¯]
        MinerConnect[Connect to Miner<br/>è¿æ¥çŸ¿æœº]
    end
    
    OwnerUI --> PasswordInput
    PasswordInput --> JSCrypto
    JSCrypto --> PBKDF2
    Salt --> PBKDF2
    PBKDF2 --> DerivedKey
    
    Plaintext --> AES256GCM
    DerivedKey --> AES256GCM
    IV --> AES256GCM
    AES256GCM --> Ciphertext
    AES256GCM --> AuthTag
    
    Ciphertext --> PostgreSQL
    Salt --> SaltStore
    IV --> IVStore
    AuthTag --> PostgreSQL
    
    PostgreSQL --> EdgeAgent
    SaltStore --> EdgeAgent
    IVStore --> EdgeAgent
    EdgeAgent --> PyCrypto
    PyCrypto --> DecryptedCreds
    DecryptedCreds --> MinerConnect
    
    style Browser fill:#1a1d2e,stroke:#f7931a
    style KeyDerivation fill:#1a1d2e,stroke:#9b59b6
    style Encryption fill:#1a1d2e,stroke:#1abc9c
    style Storage fill:#1a1d2e,stroke:#3498db
    style EdgeDecryption fill:#1a1d2e,stroke:#e74c3c
                </pre>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="interaction-card">
                        <h5><i class="bi bi-info-circle me-2"></i>Zero-Knowledge Architecture / é›¶çŸ¥è¯†æ¶æ„</h5>
                        <p class="mb-2">æœåŠ¡å™¨æ°¸è¿œæ— æ³•è·çŸ¥æ˜æ–‡å‡­è¯ - åŠ å¯†/è§£å¯†ä»…åœ¨å®¢æˆ·ç«¯(æµè§ˆå™¨)å’Œè¾¹ç¼˜é‡‡é›†å™¨è¿›è¡Œ</p>
                        <p class="arrow-flow mb-0">Browser Encrypt â†’ Cloud Store (Encrypted) â†’ Edge Decrypt â†’ Miner Connect</p>
                    </div>
                </div>
            </div>
            
            <div class="mermaid-container">
                <pre class="mermaid">
sequenceDiagram
    participant Owner as çŸ¿åœºä¸» Owner
    participant Browser as æµè§ˆå™¨ Browser
    participant Cloud as äº‘ç«¯ Cloud
    participant Edge as è¾¹ç¼˜é‡‡é›†å™¨ Edge
    participant Miner as çŸ¿æœº Miner
    
    Note over Owner,Miner: å‡­è¯åŠ å¯†å­˜å‚¨æµç¨‹ Credential Encryption Flow
    
    Owner->>Browser: è¾“å…¥çŸ¿æœºå‡­è¯ + ä¸»å¯†ç 
    Browser->>Browser: PBKDF2 æ´¾ç”Ÿå¯†é’¥
    Browser->>Browser: AES-256-GCM åŠ å¯†
    Browser->>Cloud: å­˜å‚¨åŠ å¯†æ•°æ® + Salt + IV
    Cloud-->>Browser: å­˜å‚¨æˆåŠŸ
    
    Note over Owner,Miner: å‡­è¯è§£å¯†ä½¿ç”¨æµç¨‹ Credential Decryption Flow
    
    Edge->>Cloud: è¯·æ±‚åŠ å¯†å‡­è¯
    Cloud-->>Edge: è¿”å› Ciphertext + Salt + IV
    Edge->>Edge: PBKDF2 æ´¾ç”Ÿå¯†é’¥
    Edge->>Edge: AES-256-GCM è§£å¯†
    Edge->>Miner: ä½¿ç”¨æ˜æ–‡å‡­è¯è¿æ¥
    Miner-->>Edge: è¿æ¥æˆåŠŸ
    
    Note over Owner,Miner: å¯†ç å˜æ›´æµç¨‹ Password Change Flow
    
    Owner->>Browser: è¾“å…¥æ—§å¯†ç  + æ–°å¯†ç 
    Browser->>Cloud: è·å–åŠ å¯†æ•°æ®
    Browser->>Browser: ç”¨æ—§å¯†ç è§£å¯†
    Browser->>Browser: ç”¨æ–°å¯†ç é‡æ–°åŠ å¯†
    Browser->>Cloud: å­˜å‚¨æ–°åŠ å¯†æ•°æ®
                </pre>
            </div>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5><i class="bi bi-key me-2"></i>PBKDF2</h5>
                        <p>Password-Based Key Derivation Function 2</p>
                        <p class="arrow-flow">100,000 iterations<br/>SHA-256 hash</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5><i class="bi bi-lock me-2"></i>AES-256-GCM</h5>
                        <p>Authenticated Encryption with Associated Data</p>
                        <p class="arrow-flow">256-bit key<br/>128-bit auth tag</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5><i class="bi bi-shuffle me-2"></i>Random IV</h5>
                        <p>æ¯æ¬¡åŠ å¯†ä½¿ç”¨å”¯ä¸€éšæœºåˆå§‹å‘é‡</p>
                        <p class="arrow-flow">96-bit IV<br/>Unique per encryption</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="interaction-card">
                        <h5><i class="bi bi-shield-check me-2"></i>Two-Tier Plans</h5>
                        <p>æ”¯æŒä¸¤ç§åŠ å¯†æ–¹æ¡ˆ</p>
                        <p class="arrow-flow">Tier 1: ä»…å‡­è¯åŠ å¯†<br/>Tier 2: å®Œæ•´å¯¹è±¡åŠ å¯†</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    var renderedSections = {};
    
    document.addEventListener('DOMContentLoaded', function() {
        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            themeVariables: {
                primaryColor: '#f7931a',
                primaryTextColor: '#fff',
                primaryBorderColor: '#d4780f',
                lineColor: '#4a5568',
                secondaryColor: '#2c3e50',
                tertiaryColor: '#1a1d2e',
                background: '#0d0f1a',
                mainBkg: '#1a1d2e',
                fontFamily: 'Inter, system-ui, sans-serif',
                fontSize: '12px',
                clusterBkg: 'rgba(26,29,46,0.9)',
                clusterBorder: '#f7931a'
            },
            flowchart: { curve: 'basis', padding: 15 },
            sequence: { 
                actorMargin: 50,
                messageMargin: 40,
                mirrorActors: false
            }
        });
        
        renderSection('full');
    });
    
    function renderSection(name) {
        if (renderedSections[name]) return;
        var section = document.getElementById('section-' + name);
        if (!section) return;
        var diagrams = section.querySelectorAll('.mermaid:not([data-processed])');
        if (diagrams.length > 0) {
            mermaid.run({ nodes: diagrams });
            renderedSections[name] = true;
        }
    }
    
    function showSection(name) {
        document.querySelectorAll('.diagram-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('section-' + name).classList.add('active');
        event.target.classList.add('active');
        
        setTimeout(function() {
            renderSection(name);
        }, 50);
    }
</script>
{% endblock %}
