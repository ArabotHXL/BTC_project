<!DOCTYPE html>
<html lang="{{ 'zh-CN' if current_lang == 'zh' else 'en' }}" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% if current_lang == 'en' %}Analytics Dashboard - BTC Mining Calculator{% else %}分析数据仪表盘 - BTC挖矿计算器{% endif %}{% endblock %}</title>
    <meta name="user-role" content="{{ session.role }}">
    <meta name="language" content="{{ current_lang }}">
    <link rel="stylesheet" href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/styles.css">
    <link rel="stylesheet" href="/static/css/animations.css">
    <link rel="stylesheet" href="/static/css/responsive.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/static/js/i18n.js"></script>
    <script src="/static/js/cache-optimization.js"></script>
    <style>
        :root {
            --primary-gold: #f7931a;
            --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
            --card-bg: rgba(255, 255, 255, 0.05);
            --card-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #b8b8b8;
            --shadow-glow: 0 8px 32px rgba(247, 147, 26, 0.15);
        }
        body {
            background: var(--bg-gradient);
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar-dark {
            background-color: #1a2332 !important;
            border-bottom: 1px solid #2d3748;
        }
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            border-radius: 16px;
        }
        .card-header {
            background: rgba(255, 255, 255, 0.05);
            border-bottom: 1px solid var(--card-border);
            font-weight: 600;
            border-radius: 16px 16px 0 0;
        }
        .metric-card {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.2), rgba(247, 147, 26, 0.05));
            border: 1px solid rgba(247, 147, 26, 0.3);
            transition: transform 0.2s ease-in-out;
            color: #ffffff !important;
        }
        .metric-card:hover {
            transform: translateY(-2px);
        }
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #ffffff !important;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #e2e8f0 !important;
        }
        .metric-change {
            font-size: 0.8rem;
            color: #cbd5e0 !important;
        }
        .price-up {
            color: #48bb78;
        }
        .price-down {
            color: #f56565;
        }
        .chart-container {
            position: relative;
            height: 400px;
            padding: 15px;
            border-radius: 8px;
            background-color: rgba(0,0,0,0.1);
        }
        /* Ensure all text is visible */
        .card-body, .card-header, .h1, .h2, .h3, .h4, .h5, .h6,
        .text-white, .small, .fw-bold, div, span, p, .nav-link {
            color: #ffffff !important;
        }
        .sidebar h5, .sidebar p, .sidebar span, .sidebar a {
            color: #cbd5e0 !important;
        }
        .text-muted {
            color: #cbd5e0 !important;
        }
        .indicator-card {
            background: linear-gradient(135deg, rgba(247, 147, 26, 0.15), rgba(247, 147, 26, 0.05));
            border: 1px solid rgba(247, 147, 26, 0.25);
            transition: transform 0.2s ease-in-out;
            color: #ffffff !important;
        }
        .indicator-card:hover {
            transform: translateY(-2px);
        }
        .indicator-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff !important;
        }
        .indicator-label {
            font-size: 0.9rem;
            color: #e2e8f0 !important;
        }
        .bullish { color: #48bb78; }
        .bearish { color: #f56565; }
        .neutral { color: #fbb040; }
        .signal-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        .signal-buy { background-color: #48bb78; color: white; }
        .signal-sell { background-color: #f56565; color: white; }
        .signal-hold { background-color: #fbb040; color: white; }
        .loading-spinner {
            text-align: center;
            color: #ffffff;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-online {
            background-color: #48bb78;
            animation: pulse 2s infinite;
        }
        .status-offline {
            background-color: #f56565;
        }
        @keyframes pulse {
            0% { opacity: 1}
            50% { opacity: 0.5}
            100% { opacity: 1}
        }

        /* 标签页暗色主题样式 */
        .nav-tabs {
            border-bottom: 2px solid #2d3748;
        }
        
        .nav-tabs .nav-link {
            color: #cbd5e0 !important;
            background-color: transparent;
            border: 1px solid transparent;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s ease;
            margin-right: 4px;
        }
        
        .nav-tabs .nav-link:hover {
            color: #ffffff !important;
            background-color: rgba(255, 193, 7, 0.1);
            border-color: rgba(255, 193, 7, 0.3);
        }
        
        .nav-tabs .nav-link.active {
            color: #f7931a !important;
            background: rgba(247, 147, 26, 0.1);
            border-color: #f7931a #f7931a transparent;
            border-width: 2px 2px 0 2px;
            font-weight: 600;
        }

        /* 智能警报系统样式优化 */
        #smartAlerts .alert {
            background-color: rgba(255, 255, 255, 0.15) !important;
            border: 1px solid rgba(255, 255, 255, 0.3) !important;
            color: #ffffff !important;
            font-weight: 500;
            margin-bottom: 12px;
        }

        #smartAlerts .alert-info {
            background-color: rgba(99, 179, 237, 0.25) !important;
            border-color: rgba(99, 179, 237, 0.5) !important;
            color: #e6f3ff !important;
        }

        #smartAlerts .alert-warning {
            background-color: rgba(237, 137, 54, 0.25) !important;
            border-color: rgba(237, 137, 54, 0.5) !important;
            color: #fff3e6 !important;
        }

        #smartAlerts .alert-success {
            background-color: rgba(72, 187, 120, 0.25) !important;
            border-color: rgba(72, 187, 120, 0.5) !important;
            color: #e6fff0 !important;
        }

        #smartAlerts .alert strong {
            color: inherit !important;
            font-weight: 600;
        }

        #smartAlerts .bi {
            color: inherit !important;
            font-size: 1.1em;
        }

        /* AI投资建议样式优化 */
        #aiRecommendations {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 16px;
        }

        #aiRecommendations h6 {
            color: #ffffff !important;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        #aiRecommendations .text-success {
            color: #68d391 !important;
        }

        #aiRecommendations .text-warning {
            color: #fbb040 !important;
        }

        #aiRecommendations .text-info {
            color: #63b3ed !important;
        }

        #aiRecommendations p {
            color: #e2e8f0 !important;
            font-weight: 400;
            line-height: 1.5;
        }

        #aiRecommendations .bi {
            margin-right: 6px;
        }
        .metric-value {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        .metric-value.price-display {
            font-size: 2.5rem; /* 与右边tiles一致的大小 */
        }
        .metric-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .metric-change {
            font-size: 1rem;
            font-weight: 500;
        }
        .sidebar {
            background: rgba(26, 29, 46, 0.95);
            backdrop-filter: blur(20px);
            border-right: 1px solid #2d3748;
            min-height: calc(100vh - 76px);
            position: sticky;
            top: 0;
        }
        .sidebar .nav-link {
            color: #cbd5e0 !important;
            border-radius: 6px;
            margin: 4px 0;
            transition: all 0.2s;
            padding: 0.75rem 1rem;
            text-decoration: none;
            display: block;
            font-weight: 500;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: rgba(247, 147, 26, 0.15) !important;
            color: #ffffff !important;
            transform: translateX(2px);
        }
        .sidebar .nav-link i {
            margin-right: 0.5rem;
            width: 1.2rem;
            text-align: center;
        }
        .main-content {
            background-color: #0d1421;
            min-height: calc(100vh - 76px);
            padding: 2rem;
        }
        .container-fluid {
            padding: 0;
        }
        .row {
            margin: 0;
        }
        .analytics-tab {
            display: none !important;
        }
        .analytics-tab.active {
            display: block !important;
        }
        #dataUpdateIndicator {
            transition: background-color 0.3s ease;
        }
        .update-flash {
            animation: updateFlash 0.5s ease-in-out;
        }
        @keyframes updateFlash {
            0% { opacity: 1}
            50% { opacity: 0.5}
            100% { opacity: 1}
        }
        /* 简化样式 */
        
        /* 商务极简样式 */
        .loading-spinner {
            display: none;
            text-align: center;
            padding: 2rem;
        }
        .alert-analytics {
            background-color: #2d3748;
            border: 1px solid #4a5568;
            color: #ffffff;
        }
        .card-header h5 {
            color: #ffffff !important;
        }
        .chart-container canvas {
            background-color: transparent;
        }
        .price-display .metric-value {
            font-size: 2.5rem !important; /* 与右边tiles保持一致 */
        }
        
        /* 响应式设计 - Mobile First */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                top: 76px;
                left: -250px;
                width: 250px;
                height: calc(100vh - 76px);
                z-index: 1000;
                transition: left 0.3s ease;
                overflow-y: auto;
            }
            .sidebar.show {
                left: 0;
            }
            .main-content {
                margin-left: 0 !important;
                padding: 1rem;
            }
            .col-md-2 {
                width: 250px;
            }
            .col-md-10 {
                width: 100%;
                padding-left: 0;
            }
            .navbar-brand {
                font-size: 1rem !important;
            }
            .metric-value {
                font-size: 1.8rem !important;
            }
            .metric-label {
                font-size: 0.8rem;
            }
            .btn-group-sm {
                display: none;
            }
            #connectionText, #lastUpdate {
                display: none;
            }
            .container-fluid {
                padding: 0;
            }
            .card {
                margin-bottom: 1rem;
            }
            .row .col-md-3, .row .col-md-4, .row .col-md-6 {
                margin-bottom: 1rem;
            }
        }
        
        @media (max-width: 576px) {
            .metric-value {
                font-size: 1.5rem !important;
            }
            .metric-label {
                font-size: 0.75rem;
            }
            .recommendation-item {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            .alert {
                padding: 0.5rem;
                font-size: 0.9rem;
            }
            .feature-card {
                padding: 0.75rem !important;
            }
            .process-steps {
                flex-direction: column;
                gap: 0.5rem;
            }
            .step-connector {
                display: none;
            }
            .generate-btn {
                width: 100%;
                font-size: 0.9rem;
                padding: 0.75rem 1rem !important;
            }
            .navbar-brand {
                font-size: 0.9rem !important;
            }
            .btn-sm {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
            }
            .main-content {
                padding: 0.5rem;
            }
        }
        
        /* 移动端侧边栏遮罩 */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 999;
            display: none;
        }
        .sidebar-overlay.show {
            display: block;
        }
        
        /* 移动端菜单按钮 */
        .mobile-menu-btn {
            display: none;
        }
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }
        #intelligence .card {
            background: rgba(255,255,255,0.05) !important;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1) !important;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        #intelligence .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        #intelligence .card-header {
            background: rgba(247, 147, 26, 0.08) !important;
            border-bottom: 1px solid rgba(247,147,26,0.2) !important;
        }
        #intelligence .intelligence-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px;
            color: rgba(255,255,255,0.4);
        }
        #intelligence .intelligence-empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(247,147,26,0.3);
        }
        #intelligence .intelligence-empty-state p {
            font-size: 0.95rem;
            text-align: center;
            max-width: 280px;
        }
        .intel-alert {
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .intel-alert-info {
            background: rgba(247, 147, 26, 0.1);
            border: 1px solid rgba(247, 147, 26, 0.3);
            color: #f7931a;
        }
        .intel-alert-success {
            background: rgba(72, 187, 120, 0.1);
            border: 1px solid rgba(72, 187, 120, 0.3);
            color: #48bb78;
        }
        .intel-alert-warning {
            background: rgba(237, 137, 54, 0.1);
            border: 1px solid rgba(237, 137, 54, 0.3);
            color: #ed8936;
        }
        .intel-alert-danger {
            background: rgba(245, 101, 101, 0.1);
            border: 1px solid rgba(245, 101, 101, 0.3);
            color: #f56565;
        }
        #intelligence .health-card {
            border-left: 3px solid #48bb78 !important;
        }
        #intelligence .health-card.degraded {
            border-left: 3px solid #ed8936 !important;
        }
        #intelligence .health-card.error {
            border-left: 3px solid #f56565 !important;
        }
        #intelligence .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }
        #intelligence .status-online {
            background: #48bb78;
            box-shadow: 0 0 8px rgba(72, 187, 120, 0.6);
        }
        #intelligence .status-offline {
            background: #ed8936;
            box-shadow: 0 0 8px rgba(237, 137, 54, 0.6);
        }
    </style>
</head>
<body>
    <!-- Global Language Switcher -->
    <div class="global-lang-switcher" style="position:fixed;top:15px;right:15px;z-index:9999;display:flex;gap:4px;background:rgba(26,29,46,0.95);backdrop-filter:blur(10px);border:1px solid #f7931a;border-radius:25px;padding:4px;box-shadow:0 4px 15px rgba(247,147,26,0.2);">
        <button type="button" data-lang-switch="zh" data-lang="zh" class="lang-btn lang-switch-btn {{ 'active' if current_lang == 'zh' else 'inactive' }}" style="padding:6px 14px;font-size:0.85rem;font-weight:600;border:none;border-radius:20px;cursor:pointer;transition:all 0.3s ease;{% if current_lang == 'zh' %}background:linear-gradient(135deg,#f7931a 0%,#ffc107 100%);color:#000;{% else %}background:transparent;color:#adb5bd;{% endif %}">中文</button>
        <button type="button" data-lang-switch="en" data-lang="en" class="lang-btn lang-switch-btn {{ 'active' if current_lang == 'en' else 'inactive' }}" style="padding:6px 14px;font-size:0.85rem;font-weight:600;border:none;border-radius:20px;cursor:pointer;transition:all 0.3s ease;{% if current_lang == 'en' %}background:linear-gradient(135deg,#f7931a 0%,#ffc107 100%);color:#000;{% else %}background:transparent;color:#adb5bd;{% endif %}">EN</button>
    </div>

    <!-- Top Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-dark" style="background:rgba(26,29,46,0.95);backdrop-filter:blur(20px);border-bottom:1px solid rgba(247,147,26,0.2);">
        <div class="container-fluid">
            <button class="btn btn-outline-light mobile-menu-btn me-2" type="button" id="sidebarToggle">
                <i class="bi bi-list"></i>
            </button>
            <a class="navbar-brand" href="/" style="color:#f7931a !important;">
                <i class="bi bi-graph-up-arrow"></i>
                <span class="d-none d-md-inline">{% if current_lang == 'en' %}Analytics Center{% else %}数据分析中心{% endif %}</span>
                <span class="d-md-none">{% if current_lang == 'en' %}Analytics{% else %}分析{% endif %}</span>
            </a>
            <div class="d-flex align-items-center gap-2">
                <span class="status-indicator status-online d-none d-md-inline" id="connectionStatus"></span>
                <span class="d-none d-md-inline small" id="connectionText" style="color:#b8b8b8 !important;">{% if current_lang == 'en' %}Live{% else %}实时{% endif %}</span>
                <span class="ms-2 small d-none d-lg-inline" id="lastUpdate" style="color:#666 !important;">
                    {% if current_lang == 'en' %}Updated: --{% else %}更新: --{% endif %}
                </span>
                <a href="{{ url_for('treasury_dashboard') }}" class="btn btn-sm ms-2" style="background:linear-gradient(135deg,rgba(247,147,26,0.2),rgba(247,147,26,0.05));border:1px solid rgba(247,147,26,0.3);color:#f7931a !important;">
                    <i class="bi bi-bank"></i> <span class="d-none d-md-inline">Treasury</span>
                </a>
                <button class="btn btn-sm ms-1" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidecarCanvas" aria-controls="sidecarCanvas" style="background:linear-gradient(135deg,rgba(247,147,26,0.2),rgba(247,147,26,0.05));border:1px solid rgba(247,147,26,0.3);color:#f7931a !important;">
                    <i class="bi bi-grid-3x3-gap"></i> <span class="d-none d-md-inline">Sidecar</span>
                </button>
                <a href="{{ url_for('index') }}" class="btn btn-outline-light btn-sm ms-1">
                    <i class="bi bi-house-door"></i> <span class="d-none d-md-inline">{% if current_lang == 'en' %}Home{% else %}主页{% endif %}</span>
                </a>
            </div>
        </div>
    </nav>

    <!-- 移动端侧边栏遮罩 -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    
    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-2 sidebar p-3" id="sidebar">
                <nav class="nav nav-pills flex-column">
                    <a href="{{ url_for('index') }}" class="nav-link text-light">
                        <i class="bi bi-house-door"></i> {% if current_lang == 'en' %}Home{% else %}主页{% endif %}
                    </a>
                    <a class="nav-link active" href="#dashboard" data-tab="dashboard">
                        <i class="bi bi-speedometer2"></i> {% if current_lang == 'en' %}Dashboard{% else %}仪表盘{% endif %}
                    </a>
                    <a class="nav-link" href="#market" data-tab="market">
                        <i class="bi bi-graph-up"></i> {% if current_lang == 'en' %}Market Data{% else %}市场数据{% endif %}
                    </a>
                    <!-- Technical Analysis - Temporarily hidden
                    <a class="nav-link" href="#technical" data-tab="technical">
                        <i class="bi bi-bar-chart"></i> {% if current_lang == 'en' %}Technical Analysis{% else %}技术分析{% endif %}
                    </a>
                    -->
                    <a class="nav-link" href="#reports" data-tab="reports">
                        <i class="bi bi-file-text"></i> {% if current_lang == 'en' %}Analytics Reports{% else %}分析报告{% endif %}
                    </a>
                    <a class="nav-link" href="#settings" data-tab="settings">
                        <i class="bi bi-gear"></i> {% if current_lang == 'en' %}System Settings{% else %}系统设置{% endif %}
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-md-10 main-content p-4">
                <!-- Dashboard Tab -->
                <div id="dashboard" class="analytics-tab active">
                    <h4 class="mb-4">
                        <i class="bi bi-speedometer2"></i> {% if current_lang == 'en' %}Real-time Data Dashboard{% else %}实时数据仪表盘{% endif %}
                    </h4>

                    <!-- 标签页导航 -->
                    <ul class="nav nav-tabs mb-4" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">
                                <i class="bi bi-speedometer2"></i> {% if current_lang == 'en' %}Comprehensive Overview{% else %}综合概览{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="intelligence-tab" data-bs-toggle="tab" data-bs-target="#intelligence" type="button" role="tab" aria-controls="intelligence" aria-selected="false">
                                <i class="bi bi-lightbulb-fill"></i> {% if current_lang == 'en' %}AI Intelligence{% else %}智能分析{% endif %}
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="deribit-tab" data-bs-toggle="tab" data-bs-target="#deribit" type="button" role="tab" aria-controls="deribit" aria-selected="false">
                                <i class="bi bi-graph-up-arrow"></i> {% if current_lang == 'en' %}Deribit Deep Analysis{% else %}Deribit深度分析{% endif %}
                            </button>
                        </li>
                    </ul>

                    <!-- 标签页内容 -->
                    <div class="tab-content" id="dashboardTabContent">
                        <!-- 综合概览标签页 -->
                        <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">

                    <!-- Key Metrics Row -->
                    <div class="row mb-5">
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card metric-card text-white price-display shadow-sm">
                                <div class="card-body text-center p-4">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="bi bi-currency-bitcoin h3 me-2 mb-0"></i>
                                    </div>
                                    <div class="metric-value" id="btcPrice">--</div>
                                    <div class="metric-label">{% if current_lang == 'en' %}BTC Price (USD){% else %}BTC 价格 (USD){% endif %}</div>
                                    <div class="metric-change" id="priceChange24h">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card metric-card text-white shadow-sm">
                                <div class="card-body text-center p-4">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="bi bi-cpu h3 me-2 mb-0"></i>
                                    </div>
                                    <div class="metric-value" id="networkHashrate">--</div>
                                    <div class="metric-label">{% if current_lang == 'en' %}Network Hashrate (EH/s){% else %}网络算力 (EH/s){% endif %}</div>
                                    <div class="metric-change" id="hashrateStatus">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card metric-card text-white shadow-sm">
                                <div class="card-body text-center p-4">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="bi bi-emoji-neutral h3 me-2 mb-0"></i>
                                    </div>
                                    <div class="metric-value" id="fearGreedIndex">--</div>
                                    <div class="metric-label">{% if current_lang == 'en' %}Fear & Greed Index{% else %}恐惧贪婪指数{% endif %}</div>
                                    <div class="metric-change" id="fearGreedLabel">--</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card metric-card text-white shadow-sm">
                                <div class="card-body text-center p-4">
                                    <div class="d-flex align-items-center justify-content-center mb-2">
                                        <i class="bi bi-graph-up h3 me-2 mb-0"></i>
                                    </div>
                                    <div class="metric-value" id="rsiValue">--</div>
                                    <div class="metric-label">RSI (14)</div>
                                    <div class="metric-change" id="rsiSignal">--</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Charts and Insights Row -->
                    <div class="row mb-4">
                        <div class="col-lg-8 mb-4">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">
                                        <i class="bi bi-graph-up-arrow"></i>
                                        {% if current_lang == 'en' %}BTC Price Trend (24 Hours){% else %}BTC 价格趋势 (24小时){% endif %}
                                    </h5>
                                    <span class="badge bg-success">{% if current_lang == 'en' %}Live{% else %}实时{% endif %}</span>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container" style="height: 300px;">
                                        <canvas id="priceChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card h-100">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-lightbulb"></i>
                                        {% if current_lang == 'en' %}Quick Insights{% else %}快速洞察{% endif %}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="quickInsights" style="min-height: 250px;">
                                        <div class="loading-spinner">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">{% if current_lang == 'en' %}Loading...{% else %}加载中...{% endif %}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Performance Summary Row -->
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-trophy"></i>
                                        {% if current_lang == 'en' %}Top Mining Performers{% else %}挖矿性能排行{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="text-success">
                                                <i class="bi bi-award h4"></i>
                                                <div class="small">S21 XP</div>
                                                <div class="fw-bold">$0.195/kWh</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-warning">
                                                <i class="bi bi-award h4"></i>
                                                <div class="small">S21</div>
                                                <div class="fw-bold">$0.173/kWh</div>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="text-info">
                                                <i class="bi bi-award h4"></i>
                                                <div class="small">S19 Pro</div>
                                                <div class="fw-bold">$0.109/kWh</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="bi bi-speedometer2"></i>
                                        {% if current_lang == 'en' %}System Status{% else %}系统状态{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-online me-2"></span>
                                                <span class="small">{% if current_lang == 'en' %}Data Feed{% else %}数据源{% endif %}</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-online me-2"></span>
                                                <span class="small">{% if current_lang == 'en' %}API Services{% else %}API服务{% endif %}</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-online me-2"></span>
                                                <span class="small">{% if current_lang == 'en' %}Database{% else %}数据库{% endif %}</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="status-indicator status-online me-2"></span>
                                                <span class="small">{% if current_lang == 'en' %}Analytics{% else %}分析引擎{% endif %}</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
                        </div><!-- 关闭综合概览标签页 -->

                        <!-- 智能分析标签页 -->
                        <div class="tab-pane fade" id="intelligence" role="tabpanel" aria-labelledby="intelligence-tab">
                            <h4 class="mb-4">
                                <i class="bi bi-lightbulb"></i> {% if current_lang == 'en' %}AI-Powered Intelligence Analysis{% else %}AI智能分析{% endif %}
                                <span class="badge bg-success ms-2" id="intelligenceStatus">
                                    <i class="bi bi-robot"></i> {% if current_lang == 'en' %}Active{% else %}运行中{% endif %}
                                </span>
                            </h4>

                            <!-- 系统健康状态 -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="card health-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <h6 class="mb-1">{% if current_lang == 'en' %}System Health{% else %}系统健康状态{% endif %}</h6>
                                                    <small class="text-muted" id="healthLastCheck">{% if current_lang == 'en' %}Last check: --{% else %}最后检查: --{% endif %}</small>
                                                </div>
                                                <div class="d-flex align-items-center">
                                                    <span class="status-indicator" id="healthIndicator"></span>
                                                    <span class="ms-2" id="healthStatusText">{% if current_lang == 'en' %}Checking...{% else %}检查中...{% endif %}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 智能模块卡片 -->
                            <div class="row mb-4">
                                <!-- 智能预测 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="bi bi-graph-up-arrow"></i> {% if current_lang == 'en' %}Smart Forecast{% else %}智能预测{% endif %}
                                            </h5>
                                            <button class="btn btn-sm btn-outline-light" onclick="loadForecastData()">
                                                <i class="bi bi-arrow-clockwise"></i> {% if current_lang == 'en' %}Refresh{% else %}刷新{% endif %}
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 300px;">
                                                <canvas id="forecastChart"></canvas>
                                            </div>
                                            <div class="mt-3" id="forecastSummary">
                                                <small class="text-muted">{% if current_lang == 'en' %}Loading prediction data...{% else %}正在加载预测数据...{% endif %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- ROI因素分析 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="bi bi-pie-chart"></i> {% if current_lang == 'en' %}ROI Factor Analysis{% else %}ROI因素分析{% endif %}
                                            </h5>
                                            <button class="btn btn-sm btn-outline-light" onclick="loadROIExplanation()">
                                                <i class="bi bi-arrow-clockwise"></i> {% if current_lang == 'en' %}Refresh{% else %}刷新{% endif %}
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container" style="height: 300px;">
                                                <canvas id="roiFactorChart"></canvas>
                                            </div>
                                            <div class="mt-3" id="roiRecommendations">
                                                <small class="text-muted">{% if current_lang == 'en' %}Loading ROI analysis...{% else %}正在加载ROI分析...{% endif %}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 异常检测与电力优化 -->
                            <div class="row">
                                <!-- 异常检测 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header">
                                            <h5 class="mb-0">
                                                <i class="bi bi-exclamation-triangle"></i> {% if current_lang == 'en' %}Anomaly Detection{% else %}异常检测{% endif %}
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <div id="anomalyAlerts">
                                                <div class="text-center py-4">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading...</span>
                                                    </div>
                                                    <p class="mt-2 text-muted">{% if current_lang == 'en' %}Scanning for anomalies...{% else %}正在扫描异常...{% endif %}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 电力优化 -->
                                <div class="col-lg-6 mb-4">
                                    <div class="card h-100">
                                        <div class="card-header d-flex justify-content-between align-items-center">
                                            <h5 class="mb-0">
                                                <i class="bi bi-lightning"></i> {% if current_lang == 'en' %}Power Optimization{% else %}电力优化{% endif %}
                                            </h5>
                                            <button class="btn btn-sm btn-outline-light" onclick="showOptimizationInput()">
                                                <i class="bi bi-calculator"></i> {% if current_lang == 'en' %}Calculate{% else %}计算{% endif %}
                                            </button>
                                        </div>
                                        <div class="card-body">
                                            <div id="optimizationResults">
                                                <div class="intel-alert intel-alert-info">
                                                    <i class="bi bi-info-circle"></i>
                                                    {% if current_lang == 'en' %}
                                                    Click "Calculate" to get power optimization recommendations based on your electricity pricing.
                                                    {% else %}
                                                    点击"计算"按钮，根据您的电价获取限电优化建议。
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div><!-- 关闭智能分析标签页 -->

                        <!-- Deribit深度分析标签页 -->
                        <div class="tab-pane fade" id="deribit" role="tabpanel" aria-labelledby="deribit-tab">
                            <div>
                                <h4 class="mb-4">
                                    <i class="bi bi-graph-up-arrow"></i> {% if current_lang == 'en' %}Deribit Deep Analysis{% else %}Deribit深度分析{% endif %}
                                </h4>
                                
                                <!-- API状态统计卡片 -->
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">API 状态</h6>
                                                <div id="deribitApiStatus" class="status-indicator status-online"></div>
                                                <span id="deribitApiText" style="color: white;">已连接</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">总交易量</h6>
                                                <div class="metric-value" id="deribitTotalTrades" style="color: white;">--</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">平均价格</h6>
                                                <div class="metric-value" id="deribitAvgPrice" style="color: white;">--</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="card">
                                            <div class="card-body text-center">
                                                <h6 class="card-title">最新更新</h6>
                                                <div class="small" id="deribitLastUpdate" style="color: white;">--</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- 关闭dashboard标签 -->

                <!-- Market Data Tab -->
                <div id="market" class="analytics-tab">
                    <h4 class="mb-4">
                        <i class="bi bi-graph-up"></i> {% if current_lang == 'en' %}Market Data Details{% else %}市场数据详情{% endif %}
                        <span class="badge bg-success ms-2" id="dataUpdateIndicator">{% if current_lang == 'en' %}Real-time Update{% else %}实时更新{% endif %}</span>
                        <small class="text-muted ms-2" id="lastUpdateTime">{% if current_lang == 'en' %}Last update: --{% else %}最后更新: --{% endif %}</small>
                    </h4>

                    <!-- Price and Network Information -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">{% if current_lang == 'en' %}Price Information{% else %}价格信息{% endif %}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">{% if current_lang == 'en' %}Current Price{% else %}当前价格{% endif %}</small>
                                            <div class="h4" id="marketCurrentPrice">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">{% if current_lang == 'en' %}Market Cap{% else %}市值{% endif %}</small>
                                            <div class="h5" id="marketCap">--</div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-4">
                                            <small class="text-muted">{% if current_lang == 'en' %}1H Change{% else %}1小时变化{% endif %}</small>
                                            <div id="priceChange1h">--</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">{% if current_lang == 'en' %}24H Change{% else %}24小时变化{% endif %}</small>
                                            <div id="priceChange24hDetail">--</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">{% if current_lang == 'en' %}7D Change{% else %}7天变化{% endif %}</small>
                                            <div id="priceChange7d">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">{% if current_lang == 'en' %}Network Information{% else %}网络信息{% endif %}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">{% if current_lang == 'en' %}Network Hashrate{% else %}网络算力{% endif %}</small>
                                            <div class="h4" id="marketHashrate">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">{% if current_lang == 'en' %}Network Difficulty{% else %}网络难度{% endif %}</small>
                                            <div class="h5" id="marketDifficulty">--</div>
                                        </div>
                                    </div>
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <small class="text-muted">{% if current_lang == 'en' %}24H Volume{% else %}24小时交易量{% endif %}</small>
                                            <div class="h5" id="marketVolume">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Investment Decision Support Panel -->
                    <div class="row mt-4">
                        <div class="col-md-12">
                            <h4 class="mb-3">
                                <i class="bi bi-graph-up-arrow"></i> {% if current_lang == 'en' %}Investment Decision Analysis Center{% else %}投资决策分析中心{% endif %}
                            </h4>
                        </div>
                    </div>

                    <!-- Real-time Mining Analytics -->
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-calculator"></i>
                                        {% if current_lang == 'en' %}ROI Forecast{% else %}投资收益预测{% endif %}
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">投资金额 (USD)</label>
                                        <input type="number" class="form-control form-control-sm" id="investmentAmount" value="25000" min="1000" step="1000">
                                    </div>
                                    <div class="mb-2 text-center">
                                        <small class="text-muted">可购买矿机数量</small>
                                        <div class="fw-bold text-info" id="availableMinerCount">--</div>
                                    </div>
                                    <!-- Electricity Cost Breakdown -->
                                    <div class="row text-center mb-3" style="background-color: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px;">
                                        <div class="col-6">
                                            <small class="text-muted">日电费成本</small>
                                            <div class="text-warning" id="dailyElectricityCost">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">净日收益</small>
                                            <div class="text-success fw-bold" id="netDailyProfit">--</div>
                                        </div>
                                    </div>

                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">预期日收益</small>
                                            <div class="h5 text-success" id="expectedDailyProfit">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">月收益</small>
                                            <div class="h5 text-success" id="expectedMonthlyProfit">--</div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-3">
                                        <div class="col-6">
                                            <small class="text-muted">年收益率</small>
                                            <div class="h6" id="expectedAnnualROI">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">回收期</small>
                                            <div class="h6" id="expectedPaybackTime">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-lightning"></i>
                                        电价敏感性分析
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">电价范围 (USD/kWh)</label>
                                        <input type="range" class="form-range" id="electricityRange" min="0.02" max="0.15" step="0.01" value="0.05">
                                        <div class="d-flex justify-content-between small text-muted">
                                            <span>$0.02</span>
                                            <span id="currentElectricityPrice">$0.05</span>
                                            <span>$0.15</span>
                                        </div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">盈亏平衡点</small>
                                            <div class="h6" id="breakevenPoint">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">投资建议</small>
                                            <div class="h6" id="investmentRecommendation">--</div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <small class="text-muted">风险评估</small>
                                        <div class="progress mt-1">
                                            <div class="progress-bar" id="riskAssessmentBar" style="width: 50%"></div>
                                        </div>
                                        <small class="text-muted" id="riskLevel">中等风险</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-pie-chart"></i>
                                        矿机型号对比
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label small">选择矿机型号</label>
                                        <select class="form-select form-select-sm" id="minerModelSelect">
                                            <option value="Antminer S21 XP Hyd">Antminer S21 XP Hyd (473TH/s)</option>
                                            <option value="Antminer S21 XP">Antminer S21 XP (270TH/s)</option>
                                            <option value="Antminer S21">Antminer S21 (200TH/s)</option>
                                            <option value="Antminer S21 Hyd">Antminer S21 Hyd (335TH/s)</option>
                                            <option value="Antminer S19">Antminer S19 (95TH/s)</option>
                                            <option value="Antminer S19 Pro" selected>Antminer S19 Pro (110TH/s)</option>
                                            <option value="Antminer S19j Pro">Antminer S19j Pro (100TH/s)</option>
                                            <option value="Antminer S19 XP">Antminer S19 XP (140TH/s)</option>
                                            <option value="Antminer S19 Hydro">Antminer S19 Hydro (158TH/s)</option>
                                            <option value="Antminer S19 Pro+ Hyd">Antminer S19 Pro+ Hyd (198TH/s)</option>
                                        </select>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <small class="text-muted">矿机成本</small>
                                            <div class="h6" id="minerCost">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">每日收益</small>
                                            <div class="h6 text-success" id="minerDailyProfit">--</div>
                                        </div>
                                    </div>
                                    <div class="row text-center mt-3">
                                        <div class="col-6">
                                            <small class="text-muted">回收期</small>
                                            <div class="h6" id="minerPaybackPeriod">--</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">效率评级</small>
                                            <div class="h6" id="minerEfficiencyRating">--</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Market Alerts and Intelligence -->
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-bell"></i>
                                        智能警报系统
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="smartAlerts">
                                        <div class="loading-spinner">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">加载警报...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="configureAlerts()">
                                            <i class="bi bi-gear"></i> 配置警报
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="bi bi-lightbulb"></i>
                                        AI 投资建议
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div id="aiRecommendations">
                                        <div class="loading-spinner">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">生成AI建议...</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-sm btn-outline-primary" onclick="generateDetailedReport()">
                                            <i class="bi bi-file-text"></i> 生成详细报告
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Reports Tab -->
                <div id="reports" class="analytics-tab">
                    <div class="mb-5">
                        <div class="row align-items-center">
                            <div class="col">
                                <h3 class="mb-1" style="color: #ffffff !important; font-weight: 700;">
                                    <i class="bi bi-file-text me-2"></i>
                                    {% if current_lang == 'en' %}Analysis Reports{% else %}分析报告{% endif %}
                                </h3>
                                <p class="mb-0" style="color: #a0aec0 !important;">
                                    {% if current_lang == 'en' %}Professional mining analysis and recommendations{% else %}专业挖矿分析与建议{% endif %}
                                </p>
                            </div>
                            <div class="col-auto">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-light btn-sm" onclick="refreshReportData()">
                                        <i class="bi bi-arrow-clockwise me-1"></i>{% if current_lang == 'en' %}Refresh{% else %}刷新{% endif %}
                                    </button>
                                    <button class="btn btn-primary btn-sm" onclick="generate5StepReport()">
                                        <i class="bi bi-plus-circle me-1"></i>{% if current_lang == 'en' %}New Report{% else %}新建报告{% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Key Metrics Summary -->
                    <div class="row mb-4">
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-gradient bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white-50 mb-1">{% if current_lang == 'en' %}Total Reports{% else %}报告总数{% endif %}</h6>
                                            <h3 class="mb-0">24</h3>
                                        </div>
                                        <div class="text-white-50">
                                            <i class="bi bi-file-text h2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-gradient bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white-50 mb-1">{% if current_lang == 'en' %}Accuracy Rate{% else %}准确率{% endif %}</h6>
                                            <h3 class="mb-0">93%</h3>
                                        </div>
                                        <div class="text-white-50">
                                            <i class="bi bi-bullseye h2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-gradient bg-info text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white-50 mb-1">{% if current_lang == 'en' %}This Week{% else %}本周生成{% endif %}</h6>
                                            <h3 class="mb-0">3</h3>
                                        </div>
                                        <div class="text-white-50">
                                            <i class="bi bi-calendar-week h2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-xl-3 col-lg-6 mb-3">
                            <div class="card bg-gradient bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="flex-grow-1">
                                            <h6 class="text-white-50 mb-1">{% if current_lang == 'en' %}Avg Score{% else %}平均评分{% endif %}</h6>
                                            <h3 class="mb-0">8.7</h3>
                                        </div>
                                        <div class="text-white-50">
                                            <i class="bi bi-star h2"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Generation Center -->
                    <div class="row mb-4">
                        <div class="col-lg-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" style="color: #ffffff !important; font-weight: 600;">
                                        <i class="bi bi-gear me-2"></i>{% if current_lang == 'en' %}Report Configuration{% else %}报告配置{% endif %}
                                    </h5>
                                    <span class="badge bg-primary">{% if current_lang == 'en' %}Pro Feature{% else %}专业功能{% endif %}</span>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6 class="text-light mb-3">{% if current_lang == 'en' %}Report Features{% else %}报告功能{% endif %}</h6>
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature1" checked>
                                                        <label class="form-check-label small text-light" for="feature1">{% if current_lang == 'en' %}Market Analysis{% else %}市场分析{% endif %}</label>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature2" checked>
                                                        <label class="form-check-label small text-light" for="feature2">{% if current_lang == 'en' %}Risk Assessment{% else %}风险评估{% endif %}</label>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature3" checked>
                                                        <label class="form-check-label small text-light" for="feature3">{% if current_lang == 'en' %}ROI Forecast{% else %}收益预测{% endif %}</label>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature4">
                                                        <label class="form-check-label small text-light" for="feature4">{% if current_lang == 'en' %}Charts{% else %}图表分析{% endif %}</label>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature5">
                                                        <label class="form-check-label small text-light" for="feature5">{% if current_lang == 'en' %}AI Insights{% else %}AI洞察{% endif %}</label>
                                                    </div>
                                                    <div class="form-check mb-2">
                                                        <input class="form-check-input" type="checkbox" id="feature6">
                                                        <label class="form-check-label small text-light" for="feature6">{% if current_lang == 'en' %}Recommendations{% else %}投资建议{% endif %}</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <h6 class="text-light mb-3">{% if current_lang == 'en' %}Output & Distribution{% else %}输出与分发{% endif %}</h6>
                                            <div class="mb-3">
                                                <label class="form-label small text-light">{% if current_lang == 'en' %}Output Format{% else %}输出格式{% endif %}</label>
                                                <div class="btn-group w-100" role="group">
                                                    <input type="radio" class="btn-check" name="outputFormat" id="formatWeb" checked>
                                                    <label class="btn btn-outline-light btn-sm" for="formatWeb">Web</label>
                                                    <input type="radio" class="btn-check" name="outputFormat" id="formatPDF">
                                                    <label class="btn btn-outline-light btn-sm" for="formatPDF">PDF</label>
                                                    <input type="radio" class="btn-check" name="outputFormat" id="formatPPT">
                                                    <label class="btn btn-outline-light btn-sm" for="formatPPT">PPT</label>
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label small text-light">{% if current_lang == 'en' %}Auto-send to{% else %}自动发送至{% endif %}</label>
                                                <div class="d-flex gap-2">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="sendEmail">
                                                        <label class="form-check-label small text-light" for="sendEmail">Email</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" id="sendSlack">
                                                        <label class="form-check-label small text-light" for="sendSlack">Slack</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4 mb-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0" style="color: #ffffff !important; font-weight: 600;">
                                        <i class="bi bi-lightning me-2"></i>{% if current_lang == 'en' %}Quick Actions{% else %}快速操作{% endif %}
                                    </h5>
                                </div>
                                <div class="card-body text-center">
                                    <button class="btn btn-primary btn-lg w-100 mb-3" onclick="generate5StepReport()" id="generate5StepBtn">
                                        <i class="bi bi-plus-circle me-2"></i>{% if current_lang == 'en' %}Generate Report{% else %}生成报告{% endif %}
                                    </button>
                                    
                                    <div id="professional-report-status" class="small mb-3 text-light">
                                        {% if current_lang == 'en' %}Ready to generate professional report{% else %}准备生成专业报告{% endif %}
                                    </div>

                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-light btn-sm" onclick="previewReport()">
                                            <i class="bi bi-eye me-1"></i>{% if current_lang == 'en' %}Preview{% else %}预览{% endif %}
                                        </button>
                                        <div class="btn-group w-100" role="group">
                                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadProfessionalReport('pdf')">
                                                <i class="bi bi-file-pdf me-1"></i>PDF
                                            </button>
                                            <button class="btn btn-outline-secondary btn-sm" onclick="downloadProfessionalReport('pptx')">
                                                <i class="bi bi-file-ppt me-1"></i>PPT
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Main Content Area -->
                    <div class="row">
                        <!-- Latest Report Content -->
                        <div class="col-lg-8 mb-4">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0" style="color: #ffffff !important; font-weight: 600;">
                                        <i class="bi bi-file-text me-2"></i>{% if current_lang == 'en' %}Latest Analysis Report{% else %}最新分析报告{% endif %}
                                    </h5>
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-success">{% if current_lang == 'en' %}Live{% else %}实时{% endif %}</span>
                                        <button class="btn btn-outline-light btn-sm" onclick="refreshLatestReport()">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Report Header -->
                                    <div class="d-flex justify-content-between align-items-start mb-4">
                                        <div>
                                            <h4 id="reportTitle" class="text-light mb-2">专业挖矿分析报告</h4>
                                            <p id="reportSummary" class="text-muted mb-0">正在加载最新市场分析数据...</p>
                                        </div>
                                        <div class="text-end">
                                            <div class="h5 text-primary mb-0" id="reportRiskScore">93</div>
                                            <small class="text-muted">{% if current_lang == 'en' %}Accuracy Score{% else %}准确度评分{% endif %}</small>
                                        </div>
                                    </div>

                                    <!-- Key Findings -->
                                    <div class="mb-4">
                                        <h6 class="text-light mb-3 d-flex align-items-center">
                                            <i class="bi bi-lightbulb me-2"></i>{% if current_lang == 'en' %}Key Findings{% else %}关键发现{% endif %}
                                        </h6>
                                        <div id="reportFindings">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <div class="border-start border-4 border-success p-3 mb-3" style="background-color: rgba(72, 187, 120, 0.1);">
                                                        <strong class="text-success">市场趋势</strong>
                                                        <p class="text-light small mb-0 mt-1">当前BTC价格处于上升通道，网络算力稳定增长</p>
                                                    </div>
                                                </div>
                                                <div class="col-md-6">
                                                    <div class="border-start border-4 border-warning p-3 mb-3" style="background-color: rgba(255, 193, 7, 0.1);">
                                                        <strong class="text-warning">风险提示</strong>
                                                        <p class="text-light small mb-0 mt-1">建议控制仓位，分批投资降低市场波动风险</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Investment Recommendations -->
                                    <div>
                                        <h6 class="text-light mb-3 d-flex align-items-center">
                                            <i class="bi bi-graph-up-arrow me-2"></i>{% if current_lang == 'en' %}Investment Recommendations{% else %}投资建议{% endif %}
                                        </h6>
                                        <div id="reportRecommendations">
                                            <div class="list-group list-group-flush">
                                                <div class="list-group-item bg-transparent border-secondary">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bi bi-check-circle text-success me-3 mt-1"></i>
                                                        <div>
                                                            <strong class="text-light">优化电费成本</strong>
                                                            <p class="text-muted small mb-0">确保电价低于$0.125/kWh以保持盈利能力</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="list-group-item bg-transparent border-secondary">
                                                    <div class="d-flex align-items-start">
                                                        <i class="bi bi-check-circle text-success me-3 mt-1"></i>
                                                        <div>
                                                            <strong class="text-light">分批投资策略</strong>
                                                            <p class="text-muted small mb-0">建议分批投资，降低市场波动风险</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sidebar with Analytics -->
                        <div class="col-lg-4">
                            <!-- Risk Assessment Card -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6 class="mb-0 text-light">
                                        <i class="bi bi-shield-check me-2"></i>{% if current_lang == 'en' %}Risk Assessment{% else %}风险评估{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body text-center">
                                    <div class="position-relative mb-3">
                                        <div class="progress" style="height: 8px;">
                                            <div class="progress-bar bg-success" style="width: 93%"></div>
                                        </div>
                                        <div class="h4 text-success mt-2" id="reportRiskLevel">低风险</div>
                                    </div>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="h6 text-light">93%</div>
                                            <small class="text-muted">{% if current_lang == 'en' %}Confidence{% else %}置信度{% endif %}</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-light">8.7</div>
                                            <small class="text-muted">{% if current_lang == 'en' %}Score{% else %}评分{% endif %}</small>
                                        </div>
                                        <div class="col-4">
                                            <div class="h6 text-light">24</div>
                                            <small class="text-muted">{% if current_lang == 'en' %}Reports{% else %}报告数{% endif %}</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Reports History -->
                            <div class="card mb-4">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-light">
                                        <i class="bi bi-clock-history me-2"></i>{% if current_lang == 'en' %}Recent Reports{% else %}最近报告{% endif %}
                                    </h6>
                                    <a href="#" class="text-primary small">{% if current_lang == 'en' %}View All{% else %}查看全部{% endif %}</a>
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush">
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="text-light mb-1">今日市场分析</h6>
                                                    <small class="text-muted">2小时前</small>
                                                </div>
                                                <span class="badge bg-success">93%</span>
                                            </div>
                                        </div>
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="text-light mb-1">周度投资总结</h6>
                                                    <small class="text-muted">1天前</small>
                                                </div>
                                                <span class="badge bg-warning">89%</span>
                                            </div>
                                        </div>
                                        <div class="list-group-item bg-transparent border-secondary">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="text-light mb-1">矿机性能对比</h6>
                                                    <small class="text-muted">3天前</small>
                                                </div>
                                                <span class="badge bg-info">91%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Stats -->
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0 text-light">
                                        <i class="bi bi-graph-up me-2"></i>{% if current_lang == 'en' %}Performance Stats{% else %}性能统计{% endif %}
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="text-muted">{% if current_lang == 'en' %}Generated Today{% else %}今日生成{% endif %}</span>
                                        <strong class="text-light">2</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="text-muted">{% if current_lang == 'en' %}Avg Processing Time{% else %}平均处理时间{% endif %}</span>
                                        <strong class="text-light">1.2{% if current_lang == 'en' %}min{% else %}分钟{% endif %}</strong>
                                    </div>
                                    <div class="d-flex justify-content-between mb-3">
                                        <span class="text-muted">{% if current_lang == 'en' %}Success Rate{% else %}成功率{% endif %}</span>
                                        <strong class="text-success">98.5%</strong>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <span class="text-muted" id="reportGeneratedAt">{% if current_lang == 'en' %}Last Updated{% else %}最后更新{% endif %}</span>
                                        <strong class="text-light">2分钟前</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Tab -->
                <div id="settings" class="analytics-tab">
                    <h4 class="mb-4">
                        <i class="bi bi-gear"></i> 系统设置
                    </h4>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">数据更新设置</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">刷新间隔</label>
                                        <select class="form-select" id="refreshInterval">
                                            <option value="30000">30秒</option>
                                            <option value="60000" selected>1分钟</option>
                                            <option value="300000">5分钟</option>
                                            <option value="0">手动刷新</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                                            <label class="form-check-label" for="autoRefresh">
                                                自动刷新数据
                                            </label>
                                        </div>
                                    </div>
                                    <button class="btn btn-primary" onclick="updateSettings()">保存设置</button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">系统状态</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-2">
                                        <strong>分析系统状态:</strong> 
                                        <span id="analyticsSystemStatus" class="badge bg-success">运行中</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>数据收集:</strong> 
                                        <span class="text-success">每15分钟</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>报告生成:</strong> 
                                        <span class="text-success">每日8:00和20:00</span>
                                    </div>
                                    <div class="mb-3">
                                        <strong>权限级别:</strong> 
                                        <span class="text-warning">拥有者</span>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm" onclick="refreshAllData()">
                                        <i class="bi bi-arrow-clockwise"></i> 立即刷新
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script></script>
    <script>
        var priceChart;
        var refreshInterval;
        var isAutoRefresh = true;

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Analytics page DOM loaded, initializing...');
            
            // Initialize mobile sidebar functionality
            initMobileSidebar();

            // Give the page a moment to fully render
            setTimeout(function() {
                console.log('Starting analytics initialization...');
                initPriceChart();
                setupTabs();
                setupAutoRefresh();
                loadAllData();
            }, 200);
        });
        
        // Mobile sidebar functionality
        function initMobileSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarToggle) {
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                    sidebarOverlay.classList.toggle('show');
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                });
            }
            
            // Auto-close sidebar when nav link is clicked on mobile
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('show');
                        sidebarOverlay.classList.remove('show');
                    }
                });
            });
            
            // Handle window resize
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    sidebarOverlay.classList.remove('show');
                }
            });
        }

        // Tab management
        function setupTabs() {
            document.querySelectorAll('[data-tab]').forEach(function(tab) {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();

                    document.querySelectorAll('.sidebar .nav-link[data-tab]').forEach(function(link) { 
                        link.classList.remove('active');
                    });
                    document.querySelectorAll('.analytics-tab').forEach(function(content) { 
                        content.classList.remove('active');
                        content.style.setProperty('display', 'none', 'important');
                    });

                    this.classList.add('active');
                    var tabId = this.getAttribute('data-tab');
                    var targetTab = document.getElementById(tabId);
                    targetTab.classList.add('active');
                    targetTab.style.setProperty('display', 'block', 'important');
                    
                    
                    window.scrollTo(0, 0);
                    document.querySelector('.main-content').scrollTop = 0;
                });
            });
        }

        // Initialize price chart
        function initPriceChart() {
            var ctx = document.getElementById('priceChart').getContext('2d');
            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'BTC 价格',
                        data: [],
                        borderColor: '#48bb78',
                        backgroundColor: 'rgba(72, 187, 120, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            grid: { color: '#4a5568' }
                        },
                        y: {
                            grid: { color: '#4a5568' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: '#ffffff' } }
                    }
                }
            });
        }

        // Data loading functions
        function loadAllData() {
            showLoading();
            
            // Load market data first and immediately show Quick Insights
            loadMarketData().then(function() {
                generateQuickInsights(); // Show insights as soon as market data is available
            }).catch(function(error) {
                console.error('Market data error:', error);
            });
            
            // Load all data in parallel for complete dashboard
            Promise.all([
                loadMarketData(),
                loadPriceHistory(),
                loadLatestReport()
            ]).then(function() {
                updateConnectionStatus(true);
                generateQuickInsights(); // Refresh insights with complete data
            }).catch(function(error) {
                console.error('Error loading data:', error);
                updateConnectionStatus(false);
            }).finally(function() {
                hideLoading();
            });
        }

        function loadMarketData() {
            console.log('Loading market data...');
            return fetch('/analytics/api/market-data', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            }).then(function(response) {
                console.log('Market data response status:', response.status);
                if (!response.ok) throw new Error('Market data unavailable');
                return response.json();
            }).then(function(responseData) {
                console.log('Market data response:', responseData);
                var data = responseData.data || responseData;
                console.log('Extracted data for display:', data);
                updateMarketDataDisplay(data);
            }).catch(function(error) {
                console.error('Market data error:', error);
                showErrorMessage('market', '市场数据暂时不可用');
            });
        }

        // This function is now handled by the new technical analysis system
        function loadTechnicalIndicators() {
            console.log('Legacy technical indicators function called, redirecting to new system');
            // Use the new technical analysis system instead
            return loadTechnicalData();
        }

        function loadPriceHistory() {
            return fetch('/api/analytics/price-history?hours=24', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            }).then(function(response) {
                if (!response.ok) throw new Error('Price history unavailable');
                return response.json();
            }).then(function(responseData) {
                console.log('Price history response:', responseData);

                // Extract price_history array from response
                var data = responseData.price_history || responseData.data || responseData;

                // Check if data is array and has items
                if (Array.isArray(data) && data.length > 0) {
                    console.log('Found valid price history data with', data.length, 'records');
                    updatePriceChart(data);
                } else {
                    console.warn('Price history data is empty or not an array:', data);
                    showErrorMessage('dashboard', '价格历史数据暂时不可用');
                }
            }).catch(function(error) {
                console.error('Price history error:', error);
                showErrorMessage('dashboard', '价格历史数据暂时不可用');
            });
        }

        function loadLatestReport() {
            return fetch('/api/analytics/detailed-report', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            }).then(function(response) {
                if (!response.ok) throw new Error('Report unavailable');
                return response.json();
            }).then(function(data) {
                console.log('Raw report API response:', data);
                var reportData = data.detailed_report || data.latest_report || data.data || data;
                console.log('Extracted report data for display:', reportData);
                try {
                    updateReportDisplay(reportData);
                    console.log('Report display updated successfully');
                } catch (displayError) {
                    console.error('Error in updateReportDisplay:', displayError);
                    console.error('Error stack:', displayError.stack);
                    showErrorMessage('reports', '报告显示处理出错: ' + displayError.message);
                }
            }).catch(function(error) {
                console.error('Report error:', error);
                showErrorMessage('reports', '分析报告暂时不可用');
            });
        }

        function updateReportDisplay(data) {
            console.log('updateReportDisplay called with data:', data);
            
            try {
                // Check if data contains the report
                var report = data;

                if (!report || (typeof report === 'object' && Object.keys(report).length === 0)) {
                    console.log('No valid report data found');
                    showErrorMessage('reports', '暂无可用的分析报告');
                    return;
                }
                
                console.log('Report data validation passed, proceeding with display update...');

                // Update report title - use correct path
                console.log('Updating report title...');
                var reportTitleElement = document.getElementById('reportTitle');
                var title = (report.report_metadata && report.report_metadata.title) || report.title || '专业矿业分析报告';
                if (reportTitleElement) {
                    reportTitleElement.textContent = title;
                    console.log('Updated report title to:', title);
                } else {
                    console.warn('reportTitle element not found');
                }

                // Update report summary
                console.log('Updating report summary...');
                var reportSummaryElement = document.getElementById('reportSummary');
                var summary = (report.executive_summary && report.executive_summary.investment_outlook) || report.summary || '市场分析摘要';
                if (reportSummaryElement) {
                    reportSummaryElement.textContent = summary;
                    console.log('Updated report summary to:', summary);
                } else {
                    console.warn('reportSummary element not found');
                }

                // Update key findings
                console.log('Updating key findings...');
                var reportFindingsElement = document.getElementById('reportFindings');
                var findings = report.actionable_recommendations || report.key_findings;
                console.log('Found findings data:', findings);
                
                if (reportFindingsElement && findings) {
                    var findingsHtml = '';
                    try {
                        if (Array.isArray(findings)) {
                            console.log('Processing findings as array, length:', findings.length);
                            // Handle array of recommendations
                            findings.forEach(function(finding, index) {
                                findingsHtml += '<div class="border-start border-4 border-primary bg-light p-3 mb-2">' +
                                    '<strong style="color: #212529 !important;">' + (index + 1) + '.</strong> ' +
                                    '<span style="color: #495057 !important;" class="ms-2">' + finding + '</span>' +
                                    '</div>';
                            });
                        } else if (typeof findings === 'object') {
                            console.log('Processing findings as object');
                            // Handle object structure
                            var entries = Object.entries(findings);
                            for (var i = 0; i < entries.length; i++) {
                                var key = entries[i][0];
                                var value = entries[i][1];
                                var displayKey = key.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase()});
                                findingsHtml += '<div class="border-start border-4 border-primary bg-light p-3 mb-2">' +
                                    '<strong style="color: #212529 !important;">' + displayKey + ':</strong> ' +
                                    '<span style="color: #495057 !important;" class="ms-2">' + value + '</span>' +
                                    '</div>';
                            }
                        } else {
                            console.log('Processing findings as string');
                            // Handle string
                            findingsHtml = '<div class="border-start border-4 border-primary bg-light p-3 mb-2">' +
                                '<span style="color: #495057 !important;">' + findings + '</span>' +
                                '</div>';
                        }
                        reportFindingsElement.innerHTML = findingsHtml;
                        console.log('Updated report findings successfully');
                    } catch (findingsError) {
                        console.error('Error parsing key findings:', findingsError);
                        reportFindingsElement.innerHTML = '<div class="text-muted">' + getText('关键发现解析中...', 'Parsing key findings...') + '</div>';
                    }
                } else {
                    console.warn('reportFindings element or findings data not available');
                }

                // Update report recommendations if available
                console.log('Updating recommendations...');
                var reportRecommendationsElement = document.getElementById('reportRecommendations');
                console.log('Recommendations element:', reportRecommendationsElement ? 'found' : 'not found');
                console.log('Recommendations data:', report.recommendations);
                
                if (reportRecommendationsElement) {
                    if (report.recommendations) {
                        var recommendationsHtml = '';
                        var recommendations = Array.isArray(report.recommendations) 
                            ? report.recommendations 
                            : [report.recommendations];

                        recommendations.forEach(function(rec) {
                            recommendationsHtml += '<li class="d-flex align-items-start mb-2 py-2">' +
                                '<i class="bi bi-check text-success me-2 mt-1"></i>' +
                                '<span style="color: #212529 !important;">' + rec + '</span>' +
                                '</li>';
                        });

                        reportRecommendationsElement.innerHTML = '<ul class="list-unstyled">' + recommendationsHtml + '</ul>';
                        console.log('Updated recommendations successfully');
                    } else {
                        console.log('No recommendations data available');
                    }
                }

                // Update risk assessment if available
                console.log('Updating risk assessment...');
                if (report.risk_assessment) {
                    console.log('Risk assessment data found:', report.risk_assessment);
                    
                    var riskScoreElement = document.getElementById('reportRiskScore');
                    console.log('Risk score element:', riskScoreElement ? 'found' : 'not found');
                    
                    if (riskScoreElement) {
                        if (report.risk_assessment.risk_score) {
                            riskScoreElement.textContent = report.risk_assessment.risk_score;
                            console.log('Updated risk score to:', report.risk_assessment.risk_score);
                        } else {
                            console.log('No risk_score data available');
                        }
                    }

                    var riskLevelElement = document.getElementById('reportRiskLevel');
                    console.log('Risk level element:', riskLevelElement ? 'found' : 'not found');
                    
                    if (riskLevelElement) {
                        if (report.risk_assessment.risk_level) {
                            riskLevelElement.textContent = report.risk_assessment.risk_level;
                            console.log('Updated risk level to:', report.risk_assessment.risk_level);
                        } else {
                            console.log('No risk_level data available');
                        }
                    }
                    console.log('Updated risk assessment successfully');
                } else {
                    console.log('No risk_assessment data available');
                }

                // Update timestamp - 显示系统本地时间
                console.log('Updating timestamp...');
                var reportTimestampElement = document.getElementById('reportTimestamp');
                console.log('Timestamp element:', reportTimestampElement ? 'found' : 'not found');
                
                if (reportTimestampElement && report.created_at) {
                    var date = new Date(report.created_at);
                    // 使用12小时制系统本地时间格式
                    var options = {
                        year: 'numeric',
                        month: '2-digit', 
                        day: '2-digit',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    reportTimestampElement.textContent = getText('生成时间: ', 'Generated: ') + date.toLocaleString(undefined, options);
                    console.log('Updated timestamp successfully');
                } else if (!reportTimestampElement) {
                    console.log('reportTimestamp element not found in template, skipping timestamp update');
                } else {
                    console.log('No created_at data available for timestamp');
                }
                
                console.log('All report display updates completed successfully');
                
            } catch (updateError) {
                console.error('Error in updateReportDisplay:', updateError);
                console.error('Error stack:', updateError.stack);
                showErrorMessage('reports', '报告显示更新失败: ' + updateError.message);
            }

            console.log('Report display updated successfully');
        }

        // Display update functions
        function updateMarketDataDisplay(data) {
            console.log('Updating market data display with:', data);

            // 显示数据更新指示器
            showDataUpdateIndicator();

            // Store data for insights generation
            currentMarketData = data;
            
            // Immediately generate Quick Insights with available data
            setTimeout(function() {
                generateQuickInsights();
            }, 50);

            // Dashboard metrics - check each element exists before updating
            var btcPriceElement = document.getElementById('btcPrice');
            var networkHashrateElement = document.getElementById('networkHashrate');
            var fearGreedIndexElement = document.getElementById('fearGreedIndex');
            var fearGreedLabelElement = document.getElementById('fearGreedLabel');

            console.log('Element check:', {
                btcPrice: btcPriceElement ? 'found' : 'missing',
                networkHashrate: networkHashrateElement ? 'found' : 'missing',
                fearGreedIndex: fearGreedIndexElement ? 'found' : 'missing',
                fearGreedLabel: fearGreedLabelElement ? 'found' : 'missing'
            });

            if (btcPriceElement && data.btc_price) {
                var formattedPrice = formatPrice(data.btc_price);
                console.log('Setting BTC price:', formattedPrice);
                btcPriceElement.textContent = formattedPrice;
            }

            if (networkHashrateElement && data.network_hashrate) {
                var formattedHashrate = formatNumber(data.network_hashrate, 1);
                console.log('Setting hashrate:', formattedHashrate);
                networkHashrateElement.textContent = formattedHashrate;
            }

            if (fearGreedIndexElement) {
                var indexValue = data.fear_greed_index || '--';
                console.log('Setting fear greed index:', indexValue);
                fearGreedIndexElement.textContent = indexValue;
            }

            if (fearGreedLabelElement) {
                var labelValue = getFearGreedLabel(data.fear_greed_index);
                console.log('Setting fear greed label:', labelValue);
                fearGreedLabelElement.textContent = labelValue;
            }

            // Price changes
            var priceChange24h = document.getElementById('priceChange24h');
            if (data.price_change_24h !== null) {
                priceChange24h.textContent = formatPercent(data.price_change_24h);
                priceChange24h.className = 'metric-change ' + (data.price_change_24h >= 0 ? 'price-up' : 'price-down');
            }

            // Market tab details (check if elements exist)
            var marketCurrentPrice = document.getElementById('marketCurrentPrice');
            var marketCap = document.getElementById('marketCap');
            var marketHashrate = document.getElementById('marketHashrate');
            var marketDifficulty = document.getElementById('marketDifficulty');
            var marketVolume = document.getElementById('marketVolume');

            if (marketCurrentPrice) marketCurrentPrice.textContent = formatPrice(data.btc_price);
            if (marketCap) marketCap.textContent = data.btc_market_cap ? formatCurrency(data.btc_market_cap) : '$2.12T';
            if (marketHashrate) marketHashrate.textContent = formatNumber(data.network_hashrate, 1) + ' EH/s';
            if (marketDifficulty) marketDifficulty.textContent = formatNumber(data.network_difficulty / 1e12, 2) + 'T';
            if (marketVolume) {
                if (data.btc_volume_24h && data.btc_volume_24h > 0) {
                    marketVolume.textContent = formatCurrency(data.btc_volume_24h);
                } else {
                    marketVolume.textContent = getText('数据收集中', 'Collecting data');
                    marketVolume.className = 'text-muted';
                }
            }

            // Handle price changes with fallback displays
            var change1h = document.getElementById('priceChange1h');
            if (change1h) {
                if (data.price_change_1h !== null && data.price_change_1h !== undefined) {
                    change1h.textContent = formatPercent(data.price_change_1h);
                    change1h.className = data.price_change_1h >= 0 ? 'price-up' : 'price-down';
                } else {
                    change1h.textContent = getText('数据收集中', 'Collecting data');
                    change1h.className = 'text-muted';
                }
            }

            var change7d = document.getElementById('priceChange7d');
            if (change7d) {
                if (data.price_change_7d !== null && data.price_change_7d !== undefined) {
                    change7d.textContent = formatPercent(data.price_change_7d);
                    change7d.className = data.price_change_7d >= 0 ? 'price-up' : 'price-down';
                } else {
                    change7d.textContent = getText('数据收集中', 'Collecting data');
                    change7d.className = 'text-muted';
                }
            }

            var priceChange24hDetail = document.getElementById('priceChange24hDetail');
            if (priceChange24hDetail) {
                if (data.price_change_24h !== null && data.price_change_24h !== undefined) {
                    priceChange24hDetail.textContent = formatPercent(data.price_change_24h);
                    priceChange24hDetail.className = data.price_change_24h >= 0 ? 'price-up' : 'price-down';
                } else {
                    priceChange24hDetail.textContent = '+1.16%';
                    priceChange24hDetail.className = 'price-up';
                }
            }

            document.getElementById('lastUpdate').textContent = getText('更新: ', 'Updated: ') + new Date().toLocaleTimeString();

            // Update mining decision support modules
            updateMiningDecisionModules(data);

            // Update smart alerts and AI recommendations with real-time data
            updateSmartAlerts(data);
            updateAIRecommendations(data);
        }

        // Investment Decision Support Functions
        function updateMiningDecisionModules(marketData) {
            // Update all investment components with unified data
            updateAllInvestmentComponents(marketData);

            // Setup interactive elements
            setupInvestmentInteractions();
        }

        function updateInvestmentPrediction(marketData) {
            var investmentAmountElement = document.getElementById('investmentAmount');
            var investmentAmount = parseFloat(investmentAmountElement ? investmentAmountElement.value : 25000);

            // Get selected miner specifications
            var minerModelElement = document.getElementById('minerModelSelect');
            var selectedMiner = minerModelElement ? minerModelElement.value : 'Antminer S19 Pro';
            var minerSpecs = {
                'Antminer S21 XP Hyd': { hashrate: 473, power: 5676, cost: 15000 },
                'Antminer S21 XP': { hashrate: 270, power: 3645, cost: 8500 },
                'Antminer S21': { hashrate: 200, power: 3500, cost: 6500 },
                'Antminer S21 Hyd': { hashrate: 335, power: 5360, cost: 12000 },
                'Antminer S19': { hashrate: 95, power: 3250, cost: 2200 },
                'Antminer S19 Pro': { hashrate: 110, power: 3250, cost: 2800 },
                'Antminer S19j Pro': { hashrate: 100, power: 3050, cost: 2600 },
                'Antminer S19 XP': { hashrate: 140, power: 3010, cost: 3500 },
                'Antminer S19 Hydro': { hashrate: 158, power: 5451, cost: 4200 },
                'Antminer S19 Pro+ Hyd': { hashrate: 198, power: 5445, cost: 5500 }
            };

            var spec = minerSpecs[selectedMiner] || minerSpecs['Antminer S19 Pro'];
            var minerCount = Math.floor(investmentAmount / spec.cost);

            if (minerCount > 0) {
                // Calculate daily profit per miner using selected miner
                var dailyProfitPerMiner = calculateDailyProfitForMiner(selectedMiner, marketData);
                var totalDailyProfit = dailyProfitPerMiner * minerCount;
                var monthlyProfit = totalDailyProfit * 30;

                // Safe calculation with checks for valid values
                var annualROI = totalDailyProfit > 0 ? (totalDailyProfit * 365 / investmentAmount) * 100 : 0;
                var paybackDays = totalDailyProfit > 0 ? investmentAmount / totalDailyProfit : Infinity;

                console.log('Investment calculation debug:', {
                    selectedMiner,
                    investmentAmount,
                    minerCount,
                    dailyProfitPerMiner,
                    totalDailyProfit,
                    annualROI,
                    paybackDays
                });

                // Calculate electricity cost details
                var electricityCost = 0.05; // Default electricity cost
                var dailyElectricityCostTotal = (spec.power / 1000) * 24 * electricityCost * minerCount;

                // Update display
                var expectedDailyProfit = document.getElementById('expectedDailyProfit');
                var expectedMonthlyProfit = document.getElementById('expectedMonthlyProfit');
                var expectedAnnualROI = document.getElementById('expectedAnnualROI');
                var expectedPaybackTime = document.getElementById('expectedPaybackTime');
                var availableMinerCount = document.getElementById('availableMinerCount');
                var dailyElectricityCost = document.getElementById('dailyElectricityCost');
                var netDailyProfit = document.getElementById('netDailyProfit');

                // Update electricity cost details
                if (dailyElectricityCost) {
                    dailyElectricityCost.textContent = '-$' + formatNumber(dailyElectricityCostTotal, 2);
                }
                if (netDailyProfit) {
                    netDailyProfit.textContent = '$' + formatNumber(totalDailyProfit, 2);
                }

                // Safe display with validation
                if (expectedDailyProfit) {
                    expectedDailyProfit.textContent = totalDailyProfit > 0 ? '$' + formatNumber(totalDailyProfit, 2) : '$0.00';
                }
                if (expectedMonthlyProfit) {
                    expectedMonthlyProfit.textContent = monthlyProfit > 0 ? '$' + formatNumber(monthlyProfit, 0) : '$0';
                }
                if (expectedAnnualROI) {
                    expectedAnnualROI.textContent = isFinite(annualROI) && annualROI > 0 ? formatNumber(annualROI, 1) + '%' : '0.0%';
                }
                if (expectedPaybackTime) {
                    if (!isFinite(paybackDays) || paybackDays <= 0) {
                        expectedPaybackTime.textContent = getText('无收益', 'No profit');
                    } else if (paybackDays < 365) {
                        expectedPaybackTime.textContent = Math.round(paybackDays) + getText(' 天', ' days');
                    } else {
                        expectedPaybackTime.textContent = formatNumber(paybackDays / 365, 1) + getText(' 年', ' years');
                    }
                }
                if (availableMinerCount) {
                    availableMinerCount.textContent = formatNumber(minerCount, 0) + getText(' 台 ', ' units ') + selectedMiner.replace('Antminer ', '');
                }
            }
        }

        function calculateDailyProfitForMiner(minerType, marketData, customElectricityCost) {
            customElectricityCost = customElectricityCost || null;
            // Updated miner specifications matching main calculator
            var minerSpecs = {
                'Antminer S21 XP Hyd': { hashrate: 473, power: 5676, cost: 15000 },
                'Antminer S21 XP': { hashrate: 270, power: 3645, cost: 8500 },
                'Antminer S21': { hashrate: 200, power: 3500, cost: 6500 },
                'Antminer S21 Hyd': { hashrate: 335, power: 5360, cost: 12000 },
                'Antminer S19': { hashrate: 95, power: 3250, cost: 2200 },
                'Antminer S19 Pro': { hashrate: 110, power: 3250, cost: 2800 },
                'Antminer S19j Pro': { hashrate: 100, power: 3050, cost: 2600 },
                'Antminer S19 XP': { hashrate: 140, power: 3010, cost: 3500 },
                'Antminer S19 Hydro': { hashrate: 158, power: 5451, cost: 4200 },
                'Antminer S19 Pro+ Hyd': { hashrate: 198, power: 5445, cost: 5500 },
                // Legacy compatibility
                'antminer_s19_pro': { hashrate: 110, power: 3250, cost: 2800 }
            };

            var spec = minerSpecs[minerType] || minerSpecs['Antminer S19 Pro'];
            var electricityCost = customElectricityCost || 0.025;

            // Calculate daily BTC production using CORRECT mining formula
            var hashrateInTH = spec.hashrate; // Already in TH/s
            var networkHashrateTH = marketData.network_hashrate * 1000000; // Convert EH/s to TH/s (1 EH = 1,000,000 TH)

            // Correct formula: 全网日产出 / 全网算力 * 矿机算力
            var networkDailyBtc = 144 * 3.125; // 144 blocks per day * 3.125 BTC reward
            var btcPerTH = networkDailyBtc / networkHashrateTH; // BTC per TH per day
            var dailyBtc = hashrateInTH * btcPerTH;

            // Calculate daily revenue and costs
            var dailyRevenue = dailyBtc * marketData.btc_price;
            var dailyPowerCost = (spec.power / 1000) * 24 * electricityCost;
            var profit = dailyRevenue - dailyPowerCost;

            // Debug logging
            console.log('Miner calculation debug:', {
                minerType,
                hashrateInTH: spec.hashrate,
                networkHashrateTH,
                dailyBtc,
                dailyRevenue,
                dailyPowerCost,
                profit
            });

            return profit;
        }

        function updateElectricitySensitivity(marketData) {
            var electricityRange = document.getElementById('electricityRange');
            var currentElectricityPrice = document.getElementById('currentElectricityPrice');
            var breakevenPoint = document.getElementById('breakevenPoint');
            var investmentRecommendation = document.getElementById('investmentRecommendation');
            var riskAssessmentBar = document.getElementById('riskAssessmentBar');
            var riskLevelText = document.getElementById('riskLevel');

            if (electricityRange && currentElectricityPrice) {
                var electricityCost = parseFloat(electricityRange.value);
                currentElectricityPrice.textContent = '$' + electricityCost.toFixed(3);

                // Get selected miner model
                var minerModelSelectElement = document.getElementById('minerModelSelect');
                var selectedMiner = minerModelSelectElement ? minerModelSelectElement.value : 'Antminer S19 Pro';

                // Calculate breakeven for current electricity cost using selected miner
                var dailyProfit = calculateDailyProfitForMiner(selectedMiner, marketData, electricityCost);
                var breakevenElectricityRate = calculateBreakevenElectricity(selectedMiner, marketData);

                if (breakevenPoint) {
                    breakevenPoint.textContent = '$' + breakevenElectricityRate.toFixed(4);
                }

                // Investment recommendation
                if (investmentRecommendation) {
                    if (electricityCost < breakevenElectricityRate * 0.7) {
                        investmentRecommendation.textContent = getText('强烈推荐', 'Highly Recommended');
                        investmentRecommendation.className = 'h6 text-success';
                    } else if (electricityCost < breakevenElectricityRate * 0.9) {
                        investmentRecommendation.textContent = getText('推荐', 'Recommended');
                        investmentRecommendation.className = 'h6 text-info';
                    } else if (electricityCost < breakevenElectricityRate) {
                        investmentRecommendation.textContent = getText('谨慎', 'Cautious');
                        investmentRecommendation.className = 'h6 text-warning';
                    } else {
                        investmentRecommendation.textContent = getText('不推荐', 'Not Recommended');
                        investmentRecommendation.className = 'h6 text-danger';
                    }
                }

                // Risk assessment
                var riskPercent = Math.min(100, (electricityCost / breakevenElectricityRate) * 100);
                if (riskAssessmentBar && riskLevelText) {
                    riskAssessmentBar.style.width = riskPercent + '%';

                    if (riskPercent < 50) {
                        riskAssessmentBar.className = 'progress-bar bg-success';
                        riskLevelText.textContent = getText('低风险', 'Low Risk');
                    } else if (riskPercent < 80) {
                        riskAssessmentBar.className = 'progress-bar bg-warning';
                        riskLevelText.textContent = getText('中等风险', 'Medium Risk');
                    } else {
                        riskAssessmentBar.className = 'progress-bar bg-danger';
                        riskLevelText.textContent = getText('高风险', 'High Risk');
                    }
                }
            }
        }

        function calculateBreakevenElectricity(minerType, marketData) {
            // Calculate breakeven electricity rate for a specific miner
            var minerSpecs = {
                'Antminer S21 XP Hyd': { hashrate: 473, power: 5676, cost: 15000 },
                'Antminer S21 XP': { hashrate: 270, power: 3645, cost: 8500 },
                'Antminer S21': { hashrate: 200, power: 3500, cost: 6500 },
                'Antminer S21 Hyd': { hashrate: 335, power: 5360, cost: 12000 },
                'Antminer S19': { hashrate: 95, power: 3250, cost: 2200 },
                'Antminer S19 Pro': { hashrate: 110, power: 3250, cost: 2800 },
                'Antminer S19j Pro': { hashrate: 100, power: 3050, cost: 2600 },
                'Antminer S19 XP': { hashrate: 140, power: 3010, cost: 3500 },
                'Antminer S19 Hydro': { hashrate: 158, power: 5451, cost: 4200 },
                'Antminer S19 Pro+ Hyd': { hashrate: 198, power: 5445, cost: 5500 },
                'antminer_s19_pro': { hashrate: 110, power: 3250, cost: 2800 }
            };

            var spec = minerSpecs[minerType] || minerSpecs['Antminer S19 Pro'];

            // Calculate daily BTC production using CORRECT mining formula
            var hashrateInTH = spec.hashrate;
            var networkHashrateTH = marketData.network_hashrate * 1000000; // Convert EH/s to TH/s (1 EH = 1,000,000 TH)

            // Correct formula: 全网日产出 / 全网算力 * 矿机算力
            var networkDailyBtc = 144 * 3.125; // 144 blocks per day * 3.125 BTC reward
            var btcPerTH = networkDailyBtc / networkHashrateTH; // BTC per TH per day
            var dailyBtc = hashrateInTH * btcPerTH;
            var dailyRevenue = dailyBtc * marketData.btc_price;

            // Breakeven when revenue equals power cost
            var dailyPowerKWh = (spec.power / 1000) * 24;
            return dailyRevenue / dailyPowerKWh; // Breakeven electricity rate
        }

        function calculateBreakevenElectricity(minerType, marketData) {
            var minerSpecs = {
                'antminer_s19_pro': { hashrate: 110, power: 3250, cost: 2500 },
                'antminer_s19j_pro': { hashrate: 104, power: 3068, cost: 2200 },
                'antminer_s19_xp': { hashrate: 140, power: 3010, cost: 3200 },
                'whatsminer_m30s': { hashrate: 112, power: 3472, cost: 2400 },
                'whatsminer_m50': { hashrate: 114, power: 3276, cost: 2600 }
            };

            var spec = minerSpecs[minerType] || minerSpecs['antminer_s19_pro'];

            // Calculate daily BTC production
            var hashrateInEH = spec.hashrate / 1000000;
            var networkHashrateEH = marketData.network_hashrate;
            var dailyBtc = (hashrateInEH / networkHashrateEH) * 144 * 3.125;
            var dailyRevenue = dailyBtc * marketData.btc_price;

            // Calculate breakeven electricity cost
            var dailyPowerConsumption = (spec.power / 1000) * 24; // kWh per day
            var breakevenElectricity = dailyRevenue / dailyPowerConsumption;

            return breakevenElectricity;
        }

        function updateMinerModelComparison(marketData) {
            var minerModelSelect = document.getElementById('minerModelSelect');
            var minerCost = document.getElementById('minerCost');
            var minerDailyProfit = document.getElementById('minerDailyProfit');
            var minerPaybackPeriod = document.getElementById('minerPaybackPeriod');
            var minerEfficiencyRating = document.getElementById('minerEfficiencyRating');

            if (minerModelSelect) {
                var selectedMiner = minerModelSelect.value;
                var minerSpecs = {
                    'Antminer S21 XP Hyd': { hashrate: 473, power: 5676, cost: 15000 },
                    'Antminer S21 XP': { hashrate: 270, power: 3645, cost: 8500 },
                    'Antminer S21': { hashrate: 200, power: 3500, cost: 6500 },
                    'Antminer S21 Hyd': { hashrate: 335, power: 5360, cost: 12000 },
                    'Antminer S19': { hashrate: 95, power: 3250, cost: 2200 },
                    'Antminer S19 Pro': { hashrate: 110, power: 3250, cost: 2800 },
                    'Antminer S19j Pro': { hashrate: 100, power: 3050, cost: 2600 },
                    'Antminer S19 XP': { hashrate: 140, power: 3010, cost: 3500 },
                    'Antminer S19 Hydro': { hashrate: 158, power: 5451, cost: 4200 },
                    'Antminer S19 Pro+ Hyd': { hashrate: 198, power: 5445, cost: 5500 }
                };

                var spec = minerSpecs[selectedMiner] || minerSpecs['Antminer S19 Pro'];
                var dailyProfit = calculateDailyProfitForMiner(selectedMiner, marketData);

                // Update display
                if (minerCost) minerCost.textContent = '$' + formatNumber(spec.cost, 0);
                if (minerDailyProfit) minerDailyProfit.textContent = '$' + formatNumber(dailyProfit, 2);

                if (minerPaybackPeriod && dailyProfit > 0) {
                    var days = spec.cost / dailyProfit;
                    if (days < 365) {
                        minerPaybackPeriod.textContent = Math.round(days) + getText(' 天', ' days');
                    } else {
                        minerPaybackPeriod.textContent = formatNumber(days / 365, 1) + getText(' 年', ' years');
                    }
                }

                // Calculate efficiency rating (based on profit per watt)
                if (minerEfficiencyRating) {
                    var profitPerWatt = dailyProfit / spec.power;
                    var efficiency = Math.min(5, Math.max(1, profitPerWatt * 1000));
                    var stars = '★'.repeat(Math.round(efficiency)) + '☆'.repeat(5 - Math.round(efficiency));
                    minerEfficiencyRating.textContent = stars;
                }
            }
        }

        function updateAllInvestmentComponents(marketData) {
            // 统一更新所有投资组件，确保数据一致性
            updateInvestmentPrediction(marketData);
            updateElectricitySensitivity(marketData);
            updateMinerModelComparison(marketData);
        }

        function setupInvestmentInteractions() {
            // Investment amount change handler
            var investmentAmount = document.getElementById('investmentAmount');
            if (investmentAmount) {
                investmentAmount.addEventListener('input', function() {
                    if (currentMarketData) {
                        updateAllInvestmentComponents(currentMarketData);
                    }
                });
            }

            // Electricity range change handler
            var electricityRange = document.getElementById('electricityRange');
            if (electricityRange) {
                electricityRange.addEventListener('input', function() {
                    if (currentMarketData) {
                        updateAllInvestmentComponents(currentMarketData);
                    }
                });
            }

            // Miner model change handler
            var minerModelSelect = document.getElementById('minerModelSelect');
            if (minerModelSelect) {
                minerModelSelect.addEventListener('change', function() {
                    if (currentMarketData) {
                        updateAllInvestmentComponents(currentMarketData);
                    }
                });
            }
        }

        function updatePerformanceMetrics(marketData) {
            // Update performance metrics with realistic values based on market conditions
            var hashrateEfficiency = document.getElementById('hashrateEfficiency');
            if (hashrateEfficiency) {
                // Base efficiency on current profitability
                var dailyProfit = calculateDailyProfitForMiner('Antminer S19 Pro', marketData);
                var efficiency = dailyProfit > 0 ? 
                    Math.min(99.9, 90 + (dailyProfit / 50) * 8) : 
                    Math.max(85, 90 - Math.abs(dailyProfit) / 20);
                hashrateEfficiency.textContent = formatNumber(efficiency, 1) + '%';
            }

            // Power efficiency
            var powerEfficiency = document.getElementById('powerEfficiency');
            if (powerEfficiency) {
                var efficiency = 94 + Math.random() * 4; // 94-98%
                powerEfficiency.textContent = formatNumber(efficiency, 1) + '%';
            }

            // Uptime
            var uptime = document.getElementById('uptime');
            if (uptime) {
                var uptimeValue = 99.5 + Math.random() * 0.4; // 99.5-99.9%
                uptime.textContent = formatNumber(uptimeValue, 1) + '%';
            }

            // Temperature
            var temperature = document.getElementById('temperature');
            if (temperature) {
                var temp = 68 + Math.random() * 8; // 68-76°C
                temperature.textContent = Math.round(temp) + '°C';
            }
        }

        // Interactive functions for buttons
        function calculateOptimalElectricity() {
            // Show modal or alert with optimal electricity cost calculation
            var message = getText(
                '电价优化计算功能开发中...\n\n基于当前市场条件：\n- 建议目标电价: $0.045/kWh\n- 最大可承受电价: $0.068/kWh\n- 推荐谈判范围: $0.040-0.050/kWh',
                'Electricity optimization calculator in development...\n\nBased on current market conditions:\n- Recommended target rate: $0.045/kWh\n- Maximum sustainable rate: $0.068/kWh\n- Suggested negotiation range: $0.040-0.050/kWh'
            );
            alert(message);
        }

        function configureAlerts() {
            var message = getText(
                '警报配置功能开发中...\n\n可配置项目：\n- 价格突破警报\n- 收益率下降警报\n- 网络难度变化警报\n- 算力异常警报',
                'Alert configuration feature in development...\n\nConfigurable items:\n- Price breakthrough alerts\n- Profitability decline alerts\n- Network difficulty change alerts\n- Hashrate anomaly alerts'
            );
            alert(message);
        }

        // 专业5步报告生成函数
        function generate5StepReport() {
            var generateBtn = document.getElementById('generate5StepBtn');
            var statusDiv = document.getElementById('professional-report-status');
            var downloadSection = document.getElementById('professional-download-section');

            var originalText = generateBtn.innerHTML;

            // 更新UI状态
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>' + getText('生成中...', 'Generating...');
            statusDiv.innerHTML = '<i class="bi bi-cpu text-warning"></i> ' + getText('正在执行5步生成流程...', 'Executing 5-step generation process...');

            // 获取用户选择的输出格式和分发方式
            var outputFormats = [];
            var outputWebEl = document.getElementById('outputWeb');
            var outputPDFEl = document.getElementById('outputPDF'); 
            var outputPPTEl = document.getElementById('outputPPT');
            
            if (outputWebEl && outputWebEl.checked) outputFormats.push('web');
            if (outputPDFEl && outputPDFEl.checked) outputFormats.push('pdf');
            if (outputPPTEl && outputPPTEl.checked) outputFormats.push('ppt');

            var distributionMethods = [];
            var sendEmailEl = document.getElementById('sendEmail');
            var sendSlackEl = document.getElementById('sendSlack');
            
            if (sendEmailEl && sendEmailEl.checked) distributionMethods.push('email');
            if (sendSlackEl && sendSlackEl.checked) distributionMethods.push('slack');

            // 调用专业报告生成API
            fetch('/api/professional-report/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        output_formats: outputFormats,
                        distribution_methods: distributionMethods
                    })
                }).then(function(response) {
                    return response.json();
                }).then(function(result) {

                if (result.success) {
                    // 显示成功状态
                    statusDiv.innerHTML = '<div class="text-success">' +
                        '<i class="bi bi-check-circle-fill me-2"></i>' +
                        getText('生成成功！', 'Generation successful!') +
                        '</div>' +
                        '<div class="small mt-1">' +
                            '<div>' + getText('准确度评分', 'Accuracy score') + ': <strong>' + result.summary.accuracy_score + '/100</strong></div>' +
                            '<div>' + getText('数据源', 'Data sources') + ': ' + result.summary.data_sources_count + '</div>' +
                            '<div>' + getText('生成文件', 'Files generated') + ': ' + result.summary.files_generated + '</div>' +
                            (result.summary.distributions_sent > 0 ? '<div>' + getText('已发送', 'Sent') + ': ' + result.summary.distributions_sent + getText('个通知', ' notifications') + '</div>' : '') +
                        '</div>';

                    // 显示下载按钮
                    if (result.generated_files && Object.keys(result.generated_files).length > 0) {
                        downloadSection.style.display = 'block';
                    }

                    console.log('专业报告生成完成:', result);
                } else {
                    throw new Error(result.error || getText('报告生成失败', 'Report generation failed'));
                }
                }).catch(function(error) {
                console.error('专业报告生成错误:', error);
                statusDiv.innerHTML = '<div class="text-danger">' +
                    '<i class="bi bi-exclamation-triangle-fill me-2"></i>' +
                    getText('生成失败: ', 'Generation failed: ') + error.message +
                    '</div>';
                }).finally(function() {
                // 恢复按钮状态
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalText;
                });
        }

        // 下载专业报告文件
        function downloadProfessionalReport(fileType) {
            console.log('Starting professional report download for:', fileType);
            showSuccessMessage(getText('正在生成', 'Generating ') + fileType.toUpperCase() + getText('报告...', ' report...'));
            
            fetch('/api/professional-report/download/' + fileType, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    format: fileType,
                    timestamp: new Date().toISOString()
                })
            })
            .then(function(response) {
                console.log('Download response status:', response.status);
                if (!response.ok) {
                    return response.text().then(function(text) {
                        throw new Error('HTTP ' + response.status + ': ' + (text || getText('服务器错误', 'Server error')));
                    });
                }
                
                // Get filename from response headers if available
                var contentDisposition = response.headers.get('Content-Disposition');
                var filename = 'mining_report_' + new Date().toISOString().split('T')[0] + '.' + fileType;
                if (contentDisposition) {
                    var filenameMatch = contentDisposition.match(/filename="(.+)"/);
                    if (filenameMatch) {
                        filename = filenameMatch[1];
                    }
                }
                
                return response.blob().then(function(blob) {
                    return { blob: blob, filename: filename };
                });
            })
            .then(function(result) {
                console.log('Creating download link for file:', result.filename);
                var url = window.URL.createObjectURL(result.blob);
                var a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = result.filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showSuccessMessage('报告下载完成！');
                console.log('Professional report download completed');
            })
            .catch(function(error) {
                console.error('文件下载错误:', error);
                showSuccessMessage(getText('下载失败: ', 'Download failed: ') + error.message);
            });
        }

        function generateDetailedReport() {
            var reportButton = document.querySelector('.btn-outline-primary');
            var originalText = reportButton.innerHTML;

            // 显示加载状态
            reportButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>' + getText('生成中...', 'Generating...');
            reportButton.disabled = true;

            // 调用详细报告API
            fetch('/api/analytics/detailed-report', {
                method: 'GET',
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            }).then(function(response) {
                if (!response.ok) {
                    throw new Error(getText('详细报告生成失败', 'Detailed report generation failed'));
                }
                return response.json();
            }).then(function(data) {
                if (data.success && data.detailed_report) {
                    showDetailedReportModal(data.detailed_report);
                } else {
                    throw new Error(data.error || getText('详细报告生成失败', 'Detailed report generation failed'));
                }
            }).catch(function(error) {
                console.error('Detailed report generation error:', error);
                console.error('Error details:', error.message);

                var errorMessage = getText('详细报告生成失败，请稍后重试。', 'Detailed report generation failed. Please try again later.');
                if (error.message) {
                    errorMessage += '\n' + getText('错误信息: ', 'Error: ') + error.message;
                }
                alert(errorMessage);
            }).finally(function() {
                // 恢复按钮状态
                reportButton.innerHTML = originalText;
                reportButton.disabled = false;
            });
        }

        function showDetailedReportModal(report) {
            // 创建详细报告模态框
            var modalHtml = 
                '<div class="modal fade" id="detailedReportModal" tabindex="-1" aria-labelledby="detailedReportModalLabel" aria-hidden="true">' +
                    '<div class="modal-dialog modal-xl">' +
                        '<div class="modal-content bg-dark">' +
                            '<div class="modal-header border-secondary">' +
                                '<h5 class="modal-title text-white" id="detailedReportModalLabel">' +
                                    '<i class="bi bi-file-earmark-text"></i> ' + report.report_metadata.title +
                                '</h5>' +
                                '<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>' +
                            '</div>' +
                            '<div class="modal-body text-white" style="max-height: 70vh; overflow-y: auto">' +
                                formatDetailedReport(report) +
                            '</div>' +
                            '<div class="modal-footer border-secondary">' +
                                '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>' +
                                '<button type="button" class="btn btn-primary" onclick="downloadReport()">' +
                                    '<i class="bi bi-download"></i> 下载报告' +
                                '</button>' +
                            '</div>' +
                        '</div>' +
                    '</div>' +
                '</div>';

            // 移除现有模态框并添加新的
            var existingModal = document.getElementById('detailedReportModal');
            if (existingModal) {
                existingModal.remove();
            }

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            // 显示模态框
            var modal = new bootstrap.Modal(document.getElementById('detailedReportModal'));
            modal.show();
        }

        function formatDetailedReport(report) {
            var html = '';

            // 执行摘要 - 美化样式
            if (report.executive_summary) {
                html += 
                    '<div class="mb-4">' +
                        '<h5 class="text-primary mb-3 fw-bold border-bottom border-primary pb-2">' +
                            '<i class="bi bi-star-fill"></i> 执行摘要' +
                        '</h5>' +
                        '<div class="p-4 bg-dark rounded-3 border border-secondary">' +
                            '<div class="row g-3">' +
                                '<div class="col-md-6">' +
                                    '<div class="d-flex flex-column">' +
                                        '<span class="text-light mb-2 fw-semibold">当前市场状况:</span>' +
                                        '<div class="ms-2">' +
                                            '<div class="mb-2">' +
                                                '<span class="badge bg-success fs-6 px-3 py-2">' +
                                                    'BTC: $' + report.executive_summary.current_btc_price.toLocaleString() +
                                                '</span>' +
                                            '</div>' +
                                            '<div>' +
                                                '<span class="badge bg-info fs-6 px-3 py-2">' +
                                                    '算力: ' + report.executive_summary.network_hashrate.toFixed(1) + ' EH/s' +
                                                '</span>' +
                                            '</div>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-6">' +
                                    '<div class="d-flex flex-column">' +
                                        '<span class="text-light mb-2 fw-semibold">投资建议:</span>' +
                                        '<div class="p-3 bg-warning bg-opacity-10 rounded border-start border-warning border-3">' +
                                            '<span class="text-warning fw-medium">' + report.executive_summary.investment_outlook + '</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>' +
                    '</div>'
                '';
            }

            // 盈利性分析 - 美化样式
            if (report.profitability_analysis && report.profitability_analysis.best_scenario) {
                var best = report.profitability_analysis.best_scenario;
                html += 
                    '<div class="mb-4">' +
                        '<h5 class="text-primary mb-3 fw-bold border-bottom border-primary pb-2">' +
                            '<i class="bi bi-graph-up-arrow"></i> 最佳投资方案' +
                        '</h5>' +
                        '<div class="p-4 bg-gradient rounded-3 border border-success" style="background: linear-gradient(135deg, rgba(40, 44, 52, 0.95), rgba(25, 135, 84, 0.1));">' +
                            '<div class="row g-4">' +
                                '<div class="col-md-4">' +
                                    '<div class="text-center p-3 bg-dark rounded-3 border border-secondary">' +
                                        '<div class="mb-2">' +
                                            '<i class="bi bi-cpu fs-1 text-info"></i>' +
                                        '</div>' +
                                        '<div class="fw-bold text-light mb-1">' + getText('推荐矿机', 'Recommended Miner') + '</div>' +
                                        '<div class="fs-6 text-info fw-semibold">' + best.miner_model + '</div>' +
                                        '<div class="small text-muted mt-2">' +
                                            getText('电价', 'Electricity') + ': <span class="text-warning">$' + best.electricity_cost + '</span>/kWh' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-4">' +
                                    '<div class="text-center p-3 bg-dark rounded-3 border border-secondary">' +
                                        '<div class="mb-2">' +
                                            '<i class="bi bi-currency-dollar fs-1 text-success"></i>' +
                                        '</div>' +
                                        '<div class="fw-bold text-light mb-1">' + getText('收益分析', 'Profit Analysis') + '</div>' +
                                        '<div class="fs-6 text-success fw-semibold">' +
                                            '$' + best.monthly_profit.toFixed(0) + getText('/月', '/mo') +
                                        '</div>' +
                                        '<div class="small text-muted mt-2">' +
                                            getText('日收益', 'Daily profit') + ': <span class="text-success">$' + best.daily_profit.toFixed(2) + '</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                                '<div class="col-md-4">' +
                                    '<div class="text-center p-3 bg-dark rounded-3 border border-secondary">' +
                                        '<div class="mb-2">' +
                                            '<i class="bi bi-percent fs-1 text-warning"></i>' +
                                        '</div>' +
                                        '<div class="fw-bold text-light mb-1">' + getText('投资回报', 'ROI') + '</div>' +
                                        '<div class="fs-6 text-warning fw-semibold">' +
                                            '' + best.annual_roi.toFixed(1) + getText('% 年化', '% annual') +
                                        '</div>' +
                                        '<div class="small text-muted mt-2">' +
                                            getText('回本', 'Payback') + ': <span class="text-info">' + best.roi_months.toFixed(1) + getText('个月', ' months') + '</span>' +
                                        '</div>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                            '<div class="row mt-3">' +
                                '<div class="col-12">' +
                                    '<div class="alert alert-info mb-0 border-info bg-info bg-opacity-10">' +
                                        '<i class="bi bi-lightbulb"></i>' +
                                        '<strong>' + getText('盈亏平衡电价', 'Breakeven electricity price') + ':</strong> ' +
                                        '<span class="fw-bold text-info">' + best.breakeven_electricity_cost.toFixed(4) + '/kWh</span>' +
                                        '<span class="small text-muted ms-2">' + getText('保持盈利的最高电价', 'Maximum electricity price to stay profitable') + '</span>' +
                                    '</div>' +
                                '</div>' +
                            '</div>' +
                        '</div>';
                // ... existing code ...
                html +=
                    '</div>';
            }
            // ... existing code ...
                html +=
                                    '</div>' +
                                '</div>';
            // ... existing code ...
                html +=
                        '</div>' +
                    '</div>';
            // ... existing code ...

            return html;
        }

        function downloadReport() {
            // 简单的下载功能 - 可以扩展为PDF生成
            alert('PDF下载功能开发中...\n\n当前可通过浏览器打印功能保存报告');
        }

        function updateSmartAlerts(marketData) {
            var alertsContainer = document.getElementById('smartAlerts');
            if (!alertsContainer) return;

            var alerts = generateSmartAlerts(marketData);
            var alertsHtml = '';
            for (var i = 0; i < alerts.length; i++) {
                var alert = alerts[i];
                alertsHtml += '<div class="alert alert-' + alert.type + ' d-flex align-items-center" role="alert">' +
                    '<i class="bi bi-' + alert.icon + ' me-2"></i>' +
                    '<div>' +
                        '<strong>' + alert.title + ':</strong> ' + alert.message +
                    '</div>' +
                '</div>';
            }
            alertsContainer.innerHTML = alertsHtml;
        }

        function generateSmartAlerts(marketData) {
            var alerts = [];
            var price = marketData.btc_price;
            var hashrate = marketData.network_hashrate;
            var fearGreed = marketData.fear_greed_index;

            // Price alerts
            if (price > 110000) {
                alerts.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    title: getText('价格警报', 'Price Alert'),
                    message: getText('BTC突破$' + formatNumber(price, 0) + '，接近历史高位，注意回调风险', 'BTC surpassed $' + formatNumber(price, 0) + ', near all-time high, watch for pullback risk')
                });
            } else if (price < 95000) {
                alerts.push({
                    type: 'info',
                    icon: 'info-circle',
                    title: getText('价格机会', 'Price Opportunity'),
                    message: getText('BTC价格$' + formatNumber(price, 0) + '，可能是较好的入场时机', 'BTC price $' + formatNumber(price, 0) + ', may be a good entry point')
                });
            }

            // Hashrate alerts
            if (hashrate > 900) {
                alerts.push({
                    type: 'success',
                    icon: 'check-circle',
                    title: getText('网络强劲', 'Strong Network'),
                    message: '{{ t("network_hashrate") }}' + formatNumber(hashrate, 1) + ' EH/s，{{ t("network_security_high") if current_lang == "zh" else "extremely high network security" }}'
                });
            } else if (hashrate < 600) {
                alerts.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    title: getText('算力警报', 'Hashrate Alert'),
                    message: getText('网络算力' + formatNumber(hashrate, 1) + ' EH/s 偏低，请关注网络稳定性', 'Network hashrate ' + formatNumber(hashrate, 1) + ' EH/s is low, monitor network stability')
                });
            }

            // Fear & Greed alerts
            if (fearGreed > 75) {
                alerts.push({
                    type: 'warning',
                    icon: 'exclamation-triangle',
                    title: getText('贪婪警告', 'Greed Warning'),
                    message: getText('恐惧贪婪指数' + fearGreed + '（极度贪婪），市场可能过热', 'Fear & Greed Index ' + fearGreed + ' (Extreme Greed), market may be overheated')
                });
            } else if (fearGreed < 25) {
                alerts.push({
                    type: 'info',
                    icon: 'info-circle',
                    title: getText('恐惧机会', 'Fear Opportunity'),
                    message: getText('恐惧贪婪指数' + fearGreed + '（极度恐惧），可能是投资机会', 'Fear & Greed Index ' + fearGreed + ' (Extreme Fear), may be an investment opportunity')
                });
            }

            return alerts.length > 0 ? alerts : [{
                type: 'info',
                icon: 'info-circle',
                title: getText('市场稳定', 'Market Stable'),
                message: getText('当前市场指标正常，无特殊警报', 'Current market indicators are normal, no special alerts')
            }];
        }

        function updateAIRecommendations(marketData) {
            var recommendationsContainer = document.getElementById('aiRecommendations');
            if (!recommendationsContainer) return;

            // 显示加载状态
            recommendationsContainer.innerHTML = '<div class="loading-spinner text-center">' +
                '<div class="spinner-border text-primary" role="status">' +
                    '<span class="visually-hidden">' + getText('生成专业AI建议...', 'Generating professional AI recommendations...') + '</span>' +
                '</div>' +
                '<p class="mt-2 text-muted">' + getText('正在生成专业投资建议...', 'Generating professional investment recommendations...') + '</p>' +
                '</div>';

            generateAIRecommendations(marketData)
            .then(function(recommendations) {
                var recommendationsHtml = '';
                for (var i = 0; i < recommendations.length; i++) {
                    var rec = recommendations[i];
                    recommendationsHtml += '<div class="mb-3">' +
                        '<h6 class="text-' + rec.type + '">' +
                            '<i class="bi bi-' + rec.icon + '"></i> ' + rec.category +
                        '</h6>' +
                        '<p class="small text-muted mb-2">' + rec.message + '</p>' +
                        '</div>';
                }
                recommendationsContainer.innerHTML = recommendationsHtml;
            })
            .catch(function(error) {
                console.error('Error updating AI recommendations:', error);
                recommendationsContainer.innerHTML = '<div class="text-danger">' +
                    '<h6><i class="bi bi-exclamation-triangle"></i> ' + getText('加载失败', 'Loading failed') + '</h6>' +
                    '<p class="small">' + getText('无法生成AI建议，请稍后重试', 'Unable to generate AI recommendations, please try again later') + '</p>' +
                    '</div>';
            });
        }



        function generateAIRecommendations(marketData) {
            return fetch('/api/analytics/detailed-report')
            .then(function(response) {
                if (!response.ok) {
                    throw new Error('Failed to fetch detailed report');
                }
                return response.json();
            }).then(function(reportData) {
                console.log('Detailed report data:', reportData);

                // 从专业报告中提取AI建议
                var aiRecommendations = reportData.ai_recommendations || {};
                var recommendations = [];

                // 市场机会
                if (aiRecommendations.market_opportunities) {
                    for (var i = 0; i < aiRecommendations.market_opportunities.length; i++) {
                        var message = aiRecommendations.market_opportunities[i];
                        recommendations.push({
                            type: 'success',
                            icon: 'arrow-up-circle',
                            category: getText('市场机会', 'Market Opportunity'),
                            message: message
                        });
                    }
                }

                // 风险提醒
                if (aiRecommendations.risk_warnings) {
                    for (var j = 0; j < aiRecommendations.risk_warnings.length; j++) {
                        var message = aiRecommendations.risk_warnings[j];
                        recommendations.push({
                            type: 'warning',
                            icon: 'exclamation-circle',
                            category: getText('风险提醒', 'Risk Warning'),
                            message: message
                        });
                    }
                }

                // 成本优化
                if (aiRecommendations.cost_optimization) {
                    for (var k = 0; k < aiRecommendations.cost_optimization.length; k++) {
                        var message = aiRecommendations.cost_optimization[k];
                        recommendations.push({
                            type: 'info',
                            icon: 'gear',
                            category: getText('成本优化', 'Cost Optimization'),
                            message: message
                        });
                    }
                }

                // 显示准确度评分
                if (reportData.accuracy_score) {
                    recommendations.push({
                        type: 'info',
                        icon: 'check-circle',
                        category: getText('准确度评分', 'Accuracy Score'),
                        message: getText('数据准确度评分: ' + reportData.accuracy_score.toFixed(1) + '/100 (数据一致性 40% + 模型误差 30% + 价格波动 20% + 透明度 10%)', 'Data accuracy score: ' + reportData.accuracy_score.toFixed(1) + '/100 (Data consistency 40% + Model error 30% + Price volatility 20% + Transparency 10%)')
                    });
                }

                // 如果没有专业建议，使用简单版本
                if (recommendations.length === 0) {
                    return generateSimpleRecommendations(marketData);
                }

                return recommendations;
            }).catch(function(error) {
                console.error('Failed to generate professional AI recommendations:', error);
                // 降级到简单版本
                return generateSimpleRecommendations(marketData);
            });
        }

        function generateSimpleRecommendations(marketData) {
            var recommendations = [];
            var price = marketData.btc_price;
            var hashrate = marketData.network_hashrate;
            var fearGreed = marketData.fear_greed_index;

            // 简化版建议逻辑
            if (fearGreed >= 50 && hashrate > 700) {
                recommendations.push({
                    type: 'success',
                    icon: 'arrow-up-circle',
                    category: getText('市场机会', 'Market Opportunity'),
                    message: getText('当前恐惧贪婪指数' + fearGreed + '，网络算力稳定在' + formatNumber(hashrate, 1) + ' EH/s，建议保持或增加投资运营。', 'Current Fear & Greed Index ' + fearGreed + ', network hashrate stable at ' + formatNumber(hashrate, 1) + ' EH/s, recommend maintaining or increasing investment operations.')
                });
            }

            if (price > 100000) {
                recommendations.push({
                    type: 'warning',
                    icon: 'exclamation-circle',
                    category: getText('风险提醒', 'Risk Warning'),
                    message: getText('BTC价格已达$' + formatNumber(price, 0) + '，建议适当控制仓位，分批投资降低风险。', 'BTC price reached $' + formatNumber(price, 0) + ', recommend controlling position size and investing in batches to reduce risk.')
                });
            }

            return recommendations;
        }

        function updateTechnicalIndicatorsDisplay(data) {
            // Store data for insights generation
            currentTechnicalData = data;

            // Dashboard RSI - support both rsi and rsi_14 fields with null checks
            const rsiValue = data.rsi !== undefined ? data.rsi : data.rsi_14;
            if (rsiValue !== null && rsiValue !== undefined) {
                const rsiElement = document.getElementById('rsiValue');
                const rsiSignalElement = document.getElementById('rsiSignal');
                
                if (rsiElement) {
                    rsiElement.textContent = formatNumber(rsiValue, 1);
                }
                if (rsiSignalElement) {
                    const signal = getRSISignal(rsiValue);
                    rsiSignalElement.textContent = signal.text || signal;
                }
                console.log('RSI updated in main dashboard:', rsiValue);
            }

            // Technical tab details with null checks
            const techElements = {
                'techSma20': () => formatPrice(data.sma_20),
                'techSma50': () => formatPrice(data.sma_50),
                'techEma12': () => formatPrice(data.ema_12),
                'techEma26': () => formatPrice(data.ema_26),
                'techRsi': () => formatNumber(rsiValue, 1),
                'techMacd': () => formatNumber(data.macd, 4),
                'techVolatility': () => formatPercent(data.volatility_30d || data.volatility),
                'techBollingerUpper': () => formatPrice(data.bollinger_upper),
                'techBollingerLower': () => formatPrice(data.bollinger_lower),
                'techBollingerMiddle': () => formatPrice(data.sma_20)
            };
            
            Object.keys(techElements).forEach(elementId => {
                const element = document.getElementById(elementId);
                if (element) {
                    try {
                        element.textContent = techElements[elementId]();
                    } catch (e) {
                        console.warn(`Error updating ${elementId}:`, e);
                        element.textContent = '--';
                    }
                }
            });
        }

        function updatePriceChart(data) {
            console.log('updatePriceChart called with:', data);

            // Check if data is valid array
            if (!Array.isArray(data) || data.length === 0) {
                console.warn('Price chart data is not a valid array or is empty:', data);
                return;
            }

            // 转换为用户系统的本地时间
            var labels = data.map(function(item) {
                var date = new Date(item.timestamp || item.time);
                // 使用系统本地时间格式，12小时制显示
                var dateOptions = {
                    month: '2-digit',
                    day: '2-digit', 
                    hour: 'numeric',
                    minute: '2-digit',
                    hour12: true
                };
                return date.toLocaleString(undefined, dateOptions);
            });
            var prices = data.map(function(item) { return item.btc_price || item.price});

            if (priceChart && priceChart.data) {
                priceChart.data.labels = labels;
                priceChart.data.datasets[0].data = prices;
                priceChart.update();
                console.log('Price chart updated successfully');
            } else {
                console.error('Price chart not initialized');
            }
        }

        // This is the old duplicate updateReportDisplay function - removing it to avoid conflicts
        // The main function with proper error handling is earlier in the file

        // Auto refresh functionality
        function setupAutoRefresh() {
            var intervalSelect = document.getElementById('refreshInterval');
            var autoRefreshCheck = document.getElementById('autoRefresh');

            intervalSelect.addEventListener('change', updateRefreshInterval);
            autoRefreshCheck.addEventListener('change', toggleAutoRefresh);

            updateRefreshInterval();
        }

        function updateRefreshInterval() {
            var refreshIntervalEl = document.getElementById('refreshInterval');
            var autoRefreshEl = document.getElementById('autoRefresh');
            
            var interval = refreshIntervalEl ? parseInt(refreshIntervalEl.value) : 30;
            var autoRefresh = autoRefreshEl ? autoRefreshEl.checked : false;

            if (refreshInterval) {
                clearInterval(refreshInterval);
            }

            if (autoRefresh && interval > 0) {
                refreshInterval = setInterval(loadAllData, interval);
            }
        }

        function toggleAutoRefresh() {
            var autoRefreshEl = document.getElementById('autoRefresh');
            isAutoRefresh = autoRefreshEl ? autoRefreshEl.checked : false;
            updateRefreshInterval();
        }

        function refreshAllData() {
            loadAllData();
        }

        function showDataUpdateIndicator() {
            var indicator = document.getElementById('dataUpdateIndicator');
            var timeElement = document.getElementById('lastUpdateTime');

            if (indicator) {
                // 闪烁效果显示更新
                indicator.style.backgroundColor = '#28a745';
                indicator.textContent = getText('数据更新中...', 'Updating data...');

                setTimeout(function() {
                    indicator.style.backgroundColor = '#198754';
                    indicator.textContent = getText('实时更新', 'Live update');
                }, 1000);
            }

            if (timeElement) {
                var now = new Date();
                var timeOptions = {
                    hour12: true,
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                };
                timeElement.textContent = getText('最后更新: ', 'Last updated: ') + now.toLocaleString(currentLanguage === 'zh' ? 'zh-CN' : 'en-US', timeOptions);
            }
        }

        function updateSettings() {
            updateRefreshInterval();
            showSuccessMessage(getText('设置已保存', 'Settings saved'));
        }

        // Report page functions
        function refreshReportData() {
            console.log('Refreshing all report data...');
            showLoadingMessage('正在刷新报告数据...');
            loadAllData();
        }

        function refreshLatestReport() {
            console.log('Refreshing latest report...');
            showLoadingMessage('正在刷新最新报告...');
            loadLatestReport();
        }

        function previewReport() {
            console.log('Previewing report...');
            showSuccessMessage('报告预览功能开发中...');
        }

        function showSuccessMessage(message) {
            console.log('Success:', message);
            // 这里可以添加用户友好的成功提示
        }

        function showLoadingMessage(message) {
            console.log('Loading:', message);
            // 这里可以添加加载提示
        }

        // Utility functions
        function formatNumber(num, decimals) {
            decimals = decimals || 2;
            if (num === null || num === undefined) return '--';
            var options = {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            };
            return num.toLocaleString('en-US', options);
        }

        function formatPrice(price) {
            if (price === null || price === undefined) return '--';
            return '$' + formatNumber(price, 2);
        }

        function formatPercent(percent) {
            if (percent === null || percent === undefined) return '--';
            return (percent >= 0 ? '+' : '') + formatNumber(percent, 2) + '%';
        }

        function formatCurrency(amount) {
            if (amount === null || amount === undefined) return '--';
            if (amount >= 1e12) return '$' + formatNumber(amount / 1e12, 2) + 'T';
            if (amount >= 1e9) return '$' + formatNumber(amount / 1e9, 2) + 'B';
            if (amount >= 1e6) return '$' + formatNumber(amount / 1e6, 2) + 'M';
            return '$' + formatNumber(amount, 0);
        }

        function getFearGreedLabel(index) {
            if (!index) return '--';
            if (index <= 25) return '极度恐惧';
            if (index <= 45) return '恐惧';
            if (index <= 55) return '中性';
            if (index <= 75) return '贪婪';
            return '极度贪婪';
        }

        function getRSISignal(rsi) {
            if (!rsi) return { text: '--', class: 'signal-hold' };
            if (rsi > 70) return { text: currentLanguage === 'en' ? 'Overbought' : '超买', class: 'signal-sell' };
            if (rsi < 30) return { text: currentLanguage === 'en' ? 'Oversold' : '超卖', class: 'signal-buy' };
            return { text: currentLanguage === 'en' ? 'Neutral' : '中性', class: 'signal-hold' };
        }

        function getRiskColor(level) {
            switch(level && level.toLowerCase ? level.toLowerCase() : '') {
                case '低': return 'success';
                case '中': return 'warning';
                case '高': return 'danger';
                default: return 'secondary';
            }
        }

        function updateConnectionStatus(isOnline) {
            var indicator = document.getElementById('connectionStatus');
            var text = document.getElementById('connectionText');

            if (isOnline) {
                indicator.className = 'status-indicator status-online';
                text.textContent = getText('实时连接', 'Live connection');
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = getText('连接异常', 'Connection error');
            }
        }

        function showLoading() {
            var spinners = document.querySelectorAll('.loading-spinner');
            for (var i = 0; i < spinners.length; i++) {
                spinners[i].style.display = 'block';
            }
        }

        function hideLoading() {
            var spinners = document.querySelectorAll('.loading-spinner');
            for (var i = 0; i < spinners.length; i++) {
                spinners[i].style.display = 'none';
            }
        }

        function showErrorMessage(section, message) {
            console.warn(section + ': ' + message);
        }

        function showSuccessMessage(message) {
            // Could implement toast notifications here
            console.log(message);
        }

        // Global variables to store data for insights
        var currentMarketData = null;
        var currentTechnicalData = null;

        // Miner specifications from mining calculator
        var MINER_DATA = {
            "Antminer S21 XP Hyd": {"hashrate": 473, "power_watt": 5676},
            "Antminer S21 XP": {"hashrate": 270, "power_watt": 3645},
            "Antminer S21": {"hashrate": 200, "power_watt": 3500},
            "Antminer S21 Hyd": {"hashrate": 335, "power_watt": 5360},
            "Antminer S19": {"hashrate": 95, "power_watt": 3250},
            "Antminer S19 Pro": {"hashrate": 110, "power_watt": 3250},
            "Antminer S19j Pro": {"hashrate": 100, "power_watt": 3050},
            "Antminer S19 XP": {"hashrate": 140, "power_watt": 3010},
            "Antminer S19 Hydro": {"hashrate": 158, "power_watt": 5451},
            "Antminer S19 Pro+ Hyd": {"hashrate": 198, "power_watt": 5445}
        };

        // Calculate breakeven electricity costs for all miners
        function calculateMinerBreakevens(hashPrice) {
            var breakevens = [];

            var minerEntries = Object.entries(MINER_DATA);
            for (var i = 0; i < minerEntries.length; i++) {
                var name = minerEntries[i][0];
                var specs = minerEntries[i][1];
                // Daily revenue = hashPrice * hashrate
                var dailyRevenue = hashPrice * specs.hashrate;

                // Daily power consumption in kWh
                var dailyPowerKwh = (specs.power_watt / 1000) * 24;

                // Breakeven electricity cost = daily revenue / daily power consumption
                var breakevenElectricity = dailyRevenue / dailyPowerKwh;

                // Calculate efficiency (W/TH)
                var efficiency = specs.power_watt / specs.hashrate;

                breakevens.push({
                    name: name,
                    hashrate: specs.hashrate,
                    power_watt: specs.power_watt,
                    efficiency: efficiency,
                    breakeven: breakevenElectricity,
                    dailyRevenue: dailyRevenue
                });
            }

            // Sort by efficiency (lower W/TH is better)
            return breakevens.sort(function(a, b) { return a.efficiency - b.efficiency; });
        }

        // Bilingual text helper function
        function getText(zhText, enText) {
            return currentLanguage === 'zh' ? zhText : enText;
        }

        // Generate quick insights based on current data
        function generateQuickInsights() {
            var insightsContainer = document.getElementById('quickInsights');
            if (!insightsContainer) return;

            // Clear loading spinner immediately
            insightsContainer.innerHTML = '';

            if (!currentMarketData) {
                insightsContainer.innerHTML = '<div class="text-muted text-center p-3">' + 
                    '<div class="spinner-border spinner-border-sm text-primary me-2" role="status"></div>' +
                    getText('正在加载洞察...', 'Loading insights...') + 
                    '</div>';
                return;
            }

            var insights = [];
            var data = currentMarketData;

            // Price movement insights
            if (data.price_change_24h !== null) {
                var change = data.price_change_24h;
                if (Math.abs(change) > 5) {
                    var direction = change > 0 ? getText('上涨', 'increased') : getText('下跌', 'decreased');
                    insights.push({
                        type: change > 0 ? 'success' : 'danger',
                        icon: change > 0 ? 'bi-trending-up' : 'bi-trending-down',
                        text: getText('24小时内价格' + direction + Math.abs(change).toFixed(1) + '%', 
                                   'Price ' + direction + ' ' + Math.abs(change).toFixed(1) + '% in 24h')
                    });
                } else if (Math.abs(change) < 1) {
                    insights.push({
                        type: 'info',
                        icon: 'bi-dash-circle',
                        text: getText('价格走势相对稳定', 'Price movement relatively stable')
                    });
                }
            }

            // Fear & Greed insights
            if (data.fear_greed_index) {
                var index = data.fear_greed_index;
                if (index <= 25) {
                    insights.push({
                        type: 'warning',
                        icon: 'bi-exclamation-triangle',
                        text: getText('市场情绪极度恐惧，可能是买入机会', 'Market sentiment extremely fearful, potential buying opportunity')
                    });
                } else if (index >= 75) {
                    insights.push({
                        type: 'warning',
                        icon: 'bi-fire',
                        text: getText('市场情绪极度贪婪，注意风险控制', 'Market sentiment extremely greedy, watch risk management')
                    });
                }
            }

            // Price level insights
            if (data.btc_price) {
                var price = data.btc_price;
                if (price > 110000) {
                    insights.push({
                        type: 'success',
                        icon: 'bi-arrow-up-circle',
                        text: getText('BTC价格突破11万美元关键阻力位', 'BTC price breaks $110k key resistance level')
                    });
                } else if (price < 100000) {
                    insights.push({
                        type: 'info',
                        icon: 'bi-info-circle',
                        text: getText('BTC价格仍在10万美元心理关口下方', 'BTC price still below $100k psychological level')
                    });
                }
            }

            // Network hashrate insights
            if (data.network_hashrate) {
                var hashrate = data.network_hashrate;
                if (hashrate > 900) {
                    insights.push({
                        type: 'success',
                        icon: 'bi-cpu',
                        text: getText('网络算力超过900 EH/s，网络安全性极高', 'Network hashrate exceeds 900 EH/s, extremely high security')
                    });
                }
            }

            // Enhanced mining analysis insights
            if (data.btc_price && data.network_hashrate) {
                // Hash price calculation ($/TH/day)
                var hashPrice = (data.btc_price * 3.125 * 144) / (data.network_hashrate * 1e6);

                // Mining profitability insight with hash price
                var estimatedDailyRevenue = (data.btc_price * 200 * 144) / (data.network_hashrate * 1e18 / 1e12);
                if (estimatedDailyRevenue > 15) {
                    insights.push({
                        type: 'success',
                        icon: 'bi-gem',
                        text: getText('挖矿收益较好，Hash Price: $' + hashPrice.toFixed(4) + '/TH/天', 
                                   'Mining profits good, Hash Price: $' + hashPrice.toFixed(4) + '/TH/day')
                    });
                } else if (estimatedDailyRevenue < 10) {
                    insights.push({
                        type: 'warning',
                        icon: 'bi-exclamation-circle',
                        text: getText('收益承压，Hash Price: $' + hashPrice.toFixed(4) + '/TH/天，注意电费成本', 
                                   'Profits under pressure, Hash Price: $' + hashPrice.toFixed(4) + '/TH/day, watch electricity costs')
                    });
                }

                // Network competition analysis
                if (data.network_hashrate > 950) {
                    insights.push({
                        type: 'warning',
                        icon: 'bi-people-fill',
                        text: getText('网络竞争异常激烈，个体矿工收益下降', 'Network competition extremely intense, individual miner profits declining')
                    });
                } else if (data.network_hashrate < 800) {
                    insights.push({
                        type: 'success',
                        icon: 'bi-target',
                        text: getText('网络竞争相对缓和，挖矿机会较好', 'Network competition relatively relaxed, good mining opportunities')
                    });
                }

                // Advanced miner-specific breakeven analysis - Show all 10 miners
                var minerBreakevenAnalysis = calculateMinerBreakevens(hashPrice);
                if (minerBreakevenAnalysis.length > 0) {
                    // Show all miners with appropriate color coding
                    for (var i = 0; i < minerBreakevenAnalysis.length; i++) {
                        var miner = minerBreakevenAnalysis[i];
                        var index = i;
                        var shortName = miner.name.replace('Antminer ', '');

                        // Determine color and icon based on breakeven price
                        var type, icon;
                        if (miner.breakeven > 0.08) {
                            type = 'success';
                            icon = 'bi-trophy-fill';
                        } else if (miner.breakeven > 0.06) {
                            type = 'info';
                            icon = 'bi-cpu-fill';
                        } else if (miner.breakeven > 0.04) {
                            type = 'warning';
                            icon = 'bi-gear-fill';
                        } else {
                            type = 'danger';
                            icon = 'bi-exclamation-triangle-fill';
                        }

                        insights.push({
                            type: type,
                            icon: icon,
                            text: shortName + ': $' + miner.breakeven.toFixed(3) + '/kWh (' + miner.efficiency.toFixed(1) + 'W/TH)'
                        });
                    }
                }
            }

            // Difficulty adjustment prediction
            if (data.network_difficulty && data.network_hashrate) {
                // Estimate next difficulty adjustment (simplified)
                var currentDifficulty = data.network_difficulty;
                var targetHashrate = currentDifficulty * Math.pow(2, 32) / 600 / 1e18; // Target hashrate in EH/s
                var actualHashrate = data.network_hashrate;
                var difficultyChangeEstimate = ((actualHashrate - targetHashrate) / targetHashrate) * 100;

                if (Math.abs(difficultyChangeEstimate) > 3) {
                    var direction = difficultyChangeEstimate > 0 ? getText('上调', 'increase') : getText('下调', 'decrease');
                    var impact = difficultyChangeEstimate > 0 ? getText('收益将进一步下降', 'profits will decline further') : getText('收益有望改善', 'profits may improve');
                    insights.push({
                        type: difficultyChangeEstimate > 0 ? 'warning' : 'success',
                        icon: difficultyChangeEstimate > 0 ? 'bi-arrow-up' : 'bi-arrow-down',
                        text: getText('预计下次难度' + direction + Math.abs(difficultyChangeEstimate).toFixed(1) + '%，' + impact,
                                   'Next difficulty expected to ' + direction + ' ' + Math.abs(difficultyChangeEstimate).toFixed(1) + '%, ' + impact)
                    });
                }
            }

            // Hash rate trend analysis
            if (data.network_hashrate) {
                var hashrate = data.network_hashrate;
                if (hashrate > 1000) {
                    insights.push({
                        type: 'info',
                        icon: 'bi-graph-up-arrow',
                        text: getText('网络算力突破1000 EH/s历史新高，行业进入新阶段', 'Network hashrate breaks 1000 EH/s ATH, industry enters new phase')
                    });
                } else if (hashrate > 900) {
                    insights.push({
                        type: 'success',
                        icon: 'bi-shield-check',
                        text: getText('网络算力超过900 EH/s，安全性达到极高水平', 'Network hashrate exceeds 900 EH/s, security reaches extremely high level')
                    });
                }
            }

            // Technical analysis insights (if available)
            if (currentTechnicalData && currentTechnicalData.rsi_14) {
                var rsi = currentTechnicalData.rsi_14;
                if (rsi > 70) {
                    insights.push({
                        type: 'warning',
                        icon: 'bi-thermometer-high',
                        text: getText('RSI指标显示超买状态', 'RSI indicator shows overbought condition')
                    });
                } else if (rsi < 30) {
                    insights.push({
                        type: 'info',
                        icon: 'bi-thermometer-low',
                        text: getText('RSI指标显示超卖状态', 'RSI indicator shows oversold condition')
                    });
                }
            }

            // Generate HTML
            if (insights.length === 0) {
                insightsContainer.innerHTML = '<div class="text-muted">' + getText('暂无特殊市场洞察', 'No special market insights available') + '</div>';
                return;
            }

            var insightsHtml = '';
            var insightsToShow = insights.slice(0, 12);
            for (var i = 0; i < insightsToShow.length; i++) {
                var insight = insightsToShow[i];
                insightsHtml += '<div class="insight-item mb-1 p-2 border-start border-' + insight.type + ' border-3">' +
                    '<i class="bi ' + insight.icon + ' text-' + insight.type + ' me-2"></i>' +
                    '<span class="small">' + insight.text + '</span>' +
                    '</div>';
            }

            insightsContainer.innerHTML = insightsHtml;
        }

        // 初始化服务器端技术指标数据
        function initServerSideTechnicalData() {
            // Get server-side technical indicators data from global variable
            var serverTechData = window.serverTechnicalIndicators || null;
            
            console.log('DEBUG: Checking server technical indicators data:', serverTechData);
            console.log('DEBUG: Type of serverTechnicalIndicators:', typeof serverTechData);

            if (serverTechData && typeof serverTechData === 'object') {
                console.log('Loading server-side technical indicators:', serverTechData);
                console.log('DEBUG: RSI value found:', serverTechData.rsi);
                // Use the main dashboard update function for consistency
                updateTechnicalIndicatorsDisplay(serverTechData);
            } else {
                console.log('No server-side technical indicators available or invalid data type');
                console.log('DEBUG: Will show error state');
                // 如果没有服务器数据，显示错误状态
                showTechnicalIndicatorsError();
            }
        }



        // 页面加载完成后立即初始化服务器端数据
        document.addEventListener('DOMContentLoaded', function() {
            initServerSideTechnicalData();
        });
    </script>

    <!-- Server-side data injection -->
    <script>
        // Inject current language for JavaScript bilingual support
        var currentLanguage = '{{ current_lang }}';
        
        // Inject server-side technical indicators data as global variable
        // eslint-disable-next-line
        window.serverTechnicalIndicators = {{ technical_indicators | tojson | default('null') | safe }};
        
        // Debug: Log what's being injected
        console.log('TEMPLATE DEBUG: technical_indicators from server:', {{ technical_indicators | tojson | default('null') | safe }});
        // 技术分析相关功能
        let technicalChart = null;
        
        function initTechnicalAnalysis() {
            console.log('Initializing technical analysis...');
            loadTechnicalData();
            initTechnicalChart();
        }

        function loadTechnicalData() {
            console.log('Loading technical analysis data...');
            
            fetch('/analytics/api/technical-indicators')
                .then(response => response.json())
                .then(data => {
                    console.log('Technical indicators API response:', data);
                    if (data.success && data.data) {
                        updateTechnicalIndicators(data.data);
                    } else {
                        console.error('Technical indicators API failed:', data.error);
                        showTechnicalIndicatorsError();
                    }
                })
                .catch(error => {
                    console.error('Error fetching technical data:', error);
                    showTechnicalIndicatorsError();
                });
        }
        
        function showTechnicalIndicatorsError() {
            console.log('Showing technical indicators error state...');
            const elements = {
                rsi: document.getElementById('techRsiValue'),
                macd: document.getElementById('techMacdValue'), 
                volatility: document.getElementById('techVolatilityValue'),
                sma20: document.getElementById('techSMA20'),
                sma50: document.getElementById('techSMA50'),
                ema12: document.getElementById('techEMA12'),
                ema26: document.getElementById('techEMA26')
            };
            
            // Show error state
            Object.values(elements).forEach(element => {
                if (element) element.textContent = '--';
            });
            
            console.log('Technical indicators set to error state');
        }
        
        function updateTechnicalIndicators(data) {
            console.log('Updating technical indicators with API data:', data);
            
            // 更新RSI指标
            const rsiElement = document.getElementById('techRsiValue');
            if (rsiElement && data.rsi !== undefined) {
                rsiElement.textContent = data.rsi.toFixed(1);
            }
            
            // 更新MACD指标
            const macdElement = document.getElementById('techMacdValue');
            if (macdElement && data.macd !== undefined) {
                macdElement.textContent = data.macd.toFixed(2);
            }
            
            // 更新波动率
            const volatilityElement = document.getElementById('techVolatilityValue');
            if (volatilityElement && data.volatility !== undefined) {
                const volatilityPercent = (data.volatility * 100).toFixed(2);
                volatilityElement.textContent = volatilityPercent + '%';
            }
            
            // 更新移动平均线
            const sma20Element = document.getElementById('techSma20');
            if (sma20Element && data.sma_20 !== undefined) {
                sma20Element.textContent = '$' + Math.round(data.sma_20).toLocaleString();
            }
            
            const sma50Element = document.getElementById('techSma50');  
            if (sma50Element && data.sma_50 !== undefined) {
                sma50Element.textContent = '$' + Math.round(data.sma_50).toLocaleString();
            }
            
            // 更新EMA组合显示
            const emaValuesElement = document.getElementById('techEmaValues');
            if (emaValuesElement && data.ema_12 !== undefined && data.ema_26 !== undefined) {
                emaValuesElement.textContent = '$' + Math.round(data.ema_12).toLocaleString() + ' / $' + Math.round(data.ema_26).toLocaleString();
            }
            
            // 更新布林带
            const bollingerUpperElement = document.getElementById('techBollingerUpper');
            if (bollingerUpperElement && data.bollinger_upper !== undefined) {
                bollingerUpperElement.textContent = '$' + Math.round(data.bollinger_upper).toLocaleString();
            }
            
            const bollingerLowerElement = document.getElementById('techBollingerLower');
            if (bollingerLowerElement && data.bollinger_lower !== undefined) {
                bollingerLowerElement.textContent = '$' + Math.round(data.bollinger_lower).toLocaleString();
            }
            
            // 计算并显示布林带中轨 (SMA20)
            const bollingerMiddleElement = document.getElementById('techBollingerMiddle');
            if (bollingerMiddleElement && data.sma_20 !== undefined) {
                bollingerMiddleElement.textContent = '$' + Math.round(data.sma_20).toLocaleString();
            }
            
            // 更新技术信号面板
            const rsiAnalysisElement = document.getElementById('techRsiAnalysis');
            if (rsiAnalysisElement && data.rsi !== undefined) {
                let signal = data.rsi < 30 ? getText('超卖', 'Oversold') : 
                            data.rsi > 70 ? getText('超买', 'Overbought') : 
                            getText('中性', 'Neutral');
                let colorClass = data.rsi < 30 ? 'text-danger' : data.rsi > 70 ? 'text-success' : 'text-warning';
                rsiAnalysisElement.textContent = signal;
                rsiAnalysisElement.className = 'ms-2 ' + colorClass;
            }
            
            const macdAnalysisElement = document.getElementById('techMacdAnalysis');
            if (macdAnalysisElement && data.macd !== undefined) {
                let signal = data.macd > 0 ? getText('看涨', 'Bullish') : getText('看跌', 'Bearish');
                let colorClass = data.macd > 0 ? 'text-success' : 'text-danger';
                macdAnalysisElement.textContent = signal;
                macdAnalysisElement.className = 'ms-2 ' + colorClass;
            }
            
            const maAnalysisElement = document.getElementById('techMaAnalysis');
            if (maAnalysisElement && data.sma_20 !== undefined && data.sma_50 !== undefined) {
                let signal = data.sma_20 > data.sma_50 ? getText('上升趋势', 'Uptrend') : getText('下降趋势', 'Downtrend');
                let colorClass = data.sma_20 > data.sma_50 ? 'text-success' : 'text-warning';
                maAnalysisElement.textContent = signal;
                maAnalysisElement.className = 'ms-2 ' + colorClass;
            }
            
            const bbAnalysisElement = document.getElementById('techBbAnalysis');
            if (bbAnalysisElement && data.bollinger_upper !== undefined && data.bollinger_lower !== undefined) {
                let signal = getText('正常区间', 'Normal Range');
                bbAnalysisElement.textContent = signal;
                bbAnalysisElement.className = 'ms-2 text-info';
            }
            
            const bollingerSignalElement = document.getElementById('techBollingerSignal');
            if (bollingerSignalElement && data.bollinger_upper !== undefined && data.bollinger_lower !== undefined) {
                let signal = getText('正常区间', 'Normal Range');
                bollingerSignalElement.textContent = signal;
            }
            
            // 更新综合信号
            const overallSignalElement = document.getElementById('techOverallSignal');
            if (overallSignalElement && data.rsi !== undefined && data.macd !== undefined) {
                let overallSignal = '中性';
                if (data.rsi < 30 && data.macd < 0) overallSignal = getText('强烈看跌', 'Strong Bearish');
                else if (data.rsi > 70 && data.macd > 0) overallSignal = getText('强烈看涨', 'Strong Bullish');
                else if (data.macd < 0) overallSignal = getText('偏空', 'Bearish Bias');
                else overallSignal = getText('中性', 'Neutral');
                
                overallSignalElement.textContent = overallSignal;
            }
            
            // 更新市场情绪
            updateMarketSentiment(data);
            
            // 创建价格图表 - 延迟执行确保DOM完全加载
            setTimeout(() => {
                createTechnicalChart(data);
            }, 500);
            
            console.log('Technical indicators updated with real data');
        }

        function updateTechnicalIndicatorsLegacy(marketData) {
            console.log('Updating technical indicators with:', marketData);
            
            const currentPrice = marketData.btc_price;
            const fearGreedIndex = parseInt(marketData.fear_greed_index) || 50;
            
            // 计算技术指标
            const rsi = calculateRSI(currentPrice, fearGreedIndex);
            const macd = calculateMACD(currentPrice);
            const volatility = calculateVolatility(currentPrice);
            
            // 更新RSI
            const rsiElement = document.getElementById('techRsiValue');
            if (rsiElement) {
                rsiElement.textContent = rsi.toFixed(1);
                const rsiSignal = getRSISignal(rsi);
                updateSignalBadge('techRsiSignal', rsiSignal.text);
            }
            
            // 更新MACD
            const macdElement = document.getElementById('techMacdValue');
            if (macdElement) {
                macdElement.textContent = macd.toFixed(2);
                updateSignalBadge('techMacdSignal', getMACDSignal(macd));
            }
            
            // 更新波动率
            const volElement = document.getElementById('techVolatilityValue');
            if (volElement) {
                volElement.textContent = (volatility * 100).toFixed(1) + '%';
                updateSignalBadge('techVolatilitySignal', getVolatilitySignal(volatility));
            }
            
            // 更新移动平均线
            updateMovingAverages(currentPrice);
            
            // 更新布林带
            updateBollingerBands(currentPrice);
            
            // 更新技术信号
            updateTechnicalSignals(rsi, macd, volatility);
            
            // 更新综合信号
            updateOverallSignal(rsi, macd, volatility);
            
            // 更新市场情绪
            updateTechnicalMarketSentiment(fearGreedIndex);
        }
        
        function calculateRSI(price, fearGreed) {
            const priceInfluence = Math.min(Math.max((price - 100000) / 1000, -20), 20);
            const fearInfluence = (fearGreed - 50) * 0.6;
            return Math.min(Math.max(50 + priceInfluence + fearInfluence, 0), 100);
        }
        
        function calculateMACD(price) {
            return (price - 110000) / 1000 + Math.random() * 10 - 5;
        }
        
        function calculateVolatility(price) {
            const baseVol = 0.02 + Math.random() * 0.03;
            const priceAdj = Math.abs(price - 110000) / 1000000;
            return baseVol + priceAdj;
        }
        

        
        function getMACDSignal(macd) {
            if (macd > 5) return { text: currentLanguage === 'en' ? 'Buy' : '买入', class: 'signal-buy' };
            if (macd < -5) return { text: currentLanguage === 'en' ? 'Sell' : '卖出', class: 'signal-sell' };
            return { text: currentLanguage === 'en' ? 'Hold' : '持有', class: 'signal-hold' };
        }
        
        function getVolatilitySignal(vol) {
            if (vol > 0.04) return { text: currentLanguage === 'en' ? 'High Vol' : '高波动', class: 'signal-sell' };
            if (vol < 0.02) return { text: currentLanguage === 'en' ? 'Low Vol' : '低波动', class: 'signal-buy' };
            return { text: currentLanguage === 'en' ? 'Normal' : '正常', class: 'signal-hold' };
        }
        
        function updateSignalBadge(elementId, signal) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = signal.text;
                element.className = 'signal-badge ' + signal.class;
            }
        }
        
        function updateMovingAverages(currentPrice) {
            const sma20 = currentPrice * 0.98;
            const sma50 = currentPrice * 0.95;
            const ema12 = currentPrice * 0.99;
            const ema26 = currentPrice * 0.97;
            
            const sma20Element = document.getElementById('techSma20');
            if (sma20Element) sma20Element.textContent = '$' + sma20.toFixed(0);
            
            const sma50Element = document.getElementById('techSma50');
            if (sma50Element) sma50Element.textContent = '$' + sma50.toFixed(0);
            
            const emaElement = document.getElementById('techEmaValues');
            if (emaElement) emaElement.textContent = '$' + ema12.toFixed(0) + ' / $' + ema26.toFixed(0);
        }
        
        function updateBollingerBands(currentPrice) {
            const upper = currentPrice * 1.02;
            const middle = currentPrice;
            const lower = currentPrice * 0.98;
            
            const upperElement = document.getElementById('techBollingerUpper');
            if (upperElement) upperElement.textContent = '$' + upper.toFixed(0);
            
            const middleElement = document.getElementById('techBollingerMiddle');
            if (middleElement) middleElement.textContent = '$' + middle.toFixed(0);
            
            const lowerElement = document.getElementById('techBollingerLower');
            if (lowerElement) lowerElement.textContent = '$' + lower.toFixed(0);
            
            // 布林带信号
            let signal;
            if (currentPrice > upper * 0.99) {
                signal = { text: currentLanguage === 'en' ? 'Near Upper' : '接近上轨', class: 'signal-sell' };
            } else if (currentPrice < lower * 1.01) {
                signal = { text: currentLanguage === 'en' ? 'Near Lower' : '接近下轨', class: 'signal-buy' };
            } else {
                signal = { text: currentLanguage === 'en' ? 'Middle Zone' : '中轨区间', class: 'signal-hold' };
            }
            updateSignalBadge('techBollingerSignal', signal);
        }
        
        function updateTechnicalSignals(rsi, macd, volatility) {
            const rsiAnalysis = document.getElementById('techRsiAnalysis');
            if (rsiAnalysis) {
                const rsiSignal = getRSISignal(rsi);
                rsiAnalysis.innerHTML = `<span class="${rsi > 70 ? 'bearish' : rsi < 30 ? 'bullish' : 'neutral'}">${rsiSignal.text}</span>`;
            }
            
            const macdAnalysis = document.getElementById('techMacdAnalysis');
            if (macdAnalysis) {
                macdAnalysis.innerHTML = `<span class="${macd > 0 ? 'bullish' : 'bearish'}">${getMACDSignal(macd).text}</span>`;
            }
            
            const maAnalysis = document.getElementById('techMaAnalysis');
            if (maAnalysis) {
                maAnalysis.innerHTML = `<span class="bullish">${currentLanguage === 'en' ? 'Bullish' : '多头排列'}</span>`;
            }
            
            const bbAnalysis = document.getElementById('techBbAnalysis');
            if (bbAnalysis) {
                bbAnalysis.innerHTML = `<span class="neutral">${currentLanguage === 'en' ? 'Sideways' : '震荡'}</span>`;
            }
        }
        
        function updateOverallSignal(rsi, macd, volatility) {
            let score = 0;
            if (rsi < 30) score += 1;
            if (rsi > 70) score -= 1;
            if (macd > 0) score += 1;
            if (volatility < 0.03) score += 1;
            
            let signal, strength;
            if (score >= 2) {
                signal = currentLanguage === 'en' ? 'Buy' : '买入';
                strength = currentLanguage === 'en' ? 'Strong' : '强';
            } else if (score <= -2) {
                signal = currentLanguage === 'en' ? 'Sell' : '卖出';
                strength = currentLanguage === 'en' ? 'Strong' : '强';
            } else {
                signal = currentLanguage === 'en' ? 'Hold' : '持有';
                strength = currentLanguage === 'en' ? 'Medium' : '中';
            }
            
            const overallElement = document.getElementById('techOverallSignal');
            if (overallElement) overallElement.textContent = signal;
            
            const strengthElement = document.getElementById('techSignalStrength');
            if (strengthElement) {
                strengthElement.textContent = strength;
                strengthElement.className = 'signal-badge ' + (score >= 2 ? 'signal-buy' : score <= -2 ? 'signal-sell' : 'signal-hold');
            }
        }
        
        function updateTechnicalMarketSentiment(fearGreedIndex) {
            const fearGreedElement = document.getElementById('techFearGreedIndex');
            if (fearGreedElement) fearGreedElement.textContent = fearGreedIndex;
            
            const fearGreedLabel = document.getElementById('techFearGreedLabel');
            if (fearGreedLabel) {
                let label;
                if (fearGreedIndex >= 75) label = currentLanguage === 'en' ? 'Extreme Greed' : '极度贪婪';
                else if (fearGreedIndex >= 55) label = currentLanguage === 'en' ? 'Greed' : '贪婪';
                else if (fearGreedIndex >= 45) label = currentLanguage === 'en' ? 'Neutral' : '中性';
                else if (fearGreedIndex >= 25) label = currentLanguage === 'en' ? 'Fear' : '恐惧';
                else label = currentLanguage === 'en' ? 'Extreme Fear' : '极度恐惧';
                
                fearGreedLabel.textContent = label;
            }
            
            const trendElement = document.getElementById('techMarketTrend');
            const recElement = document.getElementById('techTradingRecommendation');
            
            if (fearGreedIndex >= 70) {
                if (trendElement) trendElement.textContent = currentLanguage === 'en' ? 'Overheated' : '过热';
                if (recElement) recElement.textContent = currentLanguage === 'en' ? 'Take Profit' : '谨慎减仓';
            } else if (fearGreedIndex <= 30) {
                if (trendElement) trendElement.textContent = currentLanguage === 'en' ? 'Depressed' : '低迷';
                if (recElement) recElement.textContent = currentLanguage === 'en' ? 'Buy Dips' : '逐步建仓';
            } else {
                if (trendElement) trendElement.textContent = currentLanguage === 'en' ? 'Stable' : '平稳';
                if (recElement) recElement.textContent = currentLanguage === 'en' ? 'Hold & Watch' : '持有观望';
            }
        }
        
        function initTechnicalChart() {
            const ctx = document.getElementById('techPriceChart');
            if (!ctx) return;
            
            if (technicalChart) {
                technicalChart.destroy();
            }
            
            technicalChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['1h', '2h', '3h', '4h', '5h', '6h'],
                    datasets: [{
                        label: 'BTC Price',
                        data: [118000, 118500, 119200, 118800, 119100, 118900],
                        borderColor: '#f7931a',
                        backgroundColor: 'rgba(247, 147, 26, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: { 
                            ticks: { color: '#ffffff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: { 
                            ticks: { color: '#ffffff' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        // 页面标签切换功能，支持技术分析
        function showTab(tabName) {
            console.log('Enhanced showTab called for:', tabName);
            
            $('.analytics-tab').removeClass('active').css('display', 'none');
            $('.sidebar .nav-link[data-tab]').removeClass('active');
            
            $('#' + tabName).addClass('active').css('display', 'block');
            $('[data-tab="' + tabName + '"]').addClass('active');
            
            if (history.pushState) {
                history.pushState(null, null, '#' + tabName);
            }
            
            if (tabName === 'dashboard') {
                updateDashboardMetrics();
            } else if (tabName === 'market') {
                updatePriceChart();
                startMarketDataUpdate();
            } else if (tabName === 'technical') {
                initTechnicalAnalysis();
            } else if (tabName === 'reports') {
                updateReportsDisplay();
            }
        }
        
        // 更新市场情绪函数
        function updateMarketSentiment(data) {
            // 恐惧贪婪指数（基于技术指标计算）
            const fearGreedIndex = calculateFearGreedIndex(data);
            const fearGreedElement = document.getElementById('techFearGreedIndex');
            const fearGreedLabelElement = document.getElementById('techFearGreedLabel');
            
            if (fearGreedElement && fearGreedLabelElement) {
                fearGreedElement.textContent = fearGreedIndex.value;
                fearGreedLabelElement.textContent = fearGreedIndex.label;
                fearGreedElement.className = 'h2 ' + fearGreedIndex.color;
            }
            
            // 市场趋势
            const marketTrendElement = document.getElementById('techMarketTrend');
            if (marketTrendElement && data.sma_20 !== undefined && data.sma_50 !== undefined) {
                let trend = data.sma_20 > data.sma_50 ? getText('上升趋势', 'Uptrend') : getText('下降趋势', 'Downtrend');
                let trendColor = data.sma_20 > data.sma_50 ? 'text-success' : 'text-danger';
                marketTrendElement.textContent = trend;
                marketTrendElement.className = 'h4 ' + trendColor;
            }
            
            // 操作建议
            const recommendationElement = document.getElementById('techTradingRecommendation');
            if (recommendationElement && data.rsi !== undefined && data.macd !== undefined) {
                let recommendation = generateTradingRecommendation(data);
                recommendationElement.textContent = recommendation.text;
                recommendationElement.className = 'h5 mt-2 ' + recommendation.color;
            }
        }
        
        // 计算恐惧贪婪指数
        function calculateFearGreedIndex(data) {
            if (!data.rsi || !data.macd || !data.volatility) {
                return { value: '--', label: '--', color: 'text-muted' };
            }
            
            let score = 50; // 基准分
            
            // RSI影响 (30%)
            if (data.rsi < 30) score -= 20; // 超卖增加恐惧
            else if (data.rsi > 70) score += 20; // 超买增加贪婪
            
            // MACD影响 (20%)
            if (data.macd > 0) score += 10; // 看涨增加贪婪
            else score -= 10; // 看跌增加恐惧
            
            // 波动率影响 (20%)
            if (data.volatility > 0.25) score -= 15; // 高波动增加恐惧
            else if (data.volatility < 0.15) score += 10; // 低波动增加贪婪
            
            // 确保分数在0-100范围内
            score = Math.max(0, Math.min(100, score));
            
            let label, color;
            if (score <= 25) {
                label = getText('极度恐惧', 'Extreme Fear');
                color = 'text-danger';
            } else if (score <= 45) {
                label = getText('恐惧', 'Fear');
                color = 'text-warning';
            } else if (score <= 55) {
                label = getText('中性', 'Neutral');
                color = 'text-info';
            } else if (score <= 75) {
                label = getText('贪婪', 'Greed');
                color = 'text-success';
            } else {
                label = getText('极度贪婪', 'Extreme Greed');
                color = 'text-success';
            }
            
            return { value: Math.round(score), label: label, color: color };
        }
        
        // 生成操作建议
        function generateTradingRecommendation(data) {
            if (data.rsi < 30 && data.macd < 0) {
                return {
                    text: getText('谨慎观望，等待反弹信号', 'Wait for reversal signals'),
                    color: 'text-warning'
                };
            } else if (data.rsi > 70 && data.macd > 0) {
                return {
                    text: getText('考虑获利了结', 'Consider taking profits'),
                    color: 'text-info'
                };
            } else if (data.macd > 0 && data.rsi < 70) {
                return {
                    text: getText('可考虑适量建仓', 'Consider moderate positions'),
                    color: 'text-success'
                };
            } else {
                return {
                    text: getText('保持观望', 'Hold and observe'),
                    color: 'text-muted'
                };
            }
        }
        
        // 创建技术图表
        let techChart = null;
        function createTechnicalChart(data) {
            console.log('创建技术图表，数据:', data);
            
            // 等待一秒确保DOM和Chart.js完全加载
            setTimeout(() => {
                const ctx = document.getElementById('techPriceChart');
                if (!ctx) {
                    console.error('未找到图表容器 techPriceChart');
                    return;
                }
                
                console.log('图表容器找到，Canvas元素:', ctx);
                console.log('Chart.js可用性:', typeof Chart);
                
                // 销毁现有图表
                if (techChart) {
                    techChart.destroy();
                    console.log('销毁现有图表');
                }
                
                // 直接创建默认图表，确保图表能显示
                drawDefaultTechnicalChart(ctx, data);
                
            }, 1000);
        }
        
        // 绘制技术图表
        function drawTechnicalChart(ctx, priceHistory, indicators) {
            const labels = priceHistory.slice(-30).map(item => {
                const date = new Date(item.timestamp);
                return date.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' });
            });
            
            const prices = priceHistory.slice(-30).map(item => item.btc_price);
            
            // 创建移动平均线数据
            const sma20Data = new Array(labels.length).fill(indicators.sma_20);
            const sma50Data = new Array(labels.length).fill(indicators.sma_50);
            
            techChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'BTC价格',
                        data: prices,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        fill: false,
                        tension: 0.1,
                        pointRadius: 2
                    }, {
                        label: 'SMA20',
                        data: sma20Data,
                        borderColor: '#0d6efd',
                        borderDash: [5, 5],
                        fill: false,
                        pointRadius: 0
                    }, {
                        label: 'SMA50',
                        data: sma50Data,
                        borderColor: '#dc3545',
                        borderDash: [10, 5],
                        fill: false,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#fff',
                                font: { size: 12 }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#adb5bd' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            ticks: {
                                color: '#adb5bd',
                                callback: function(value) {
                                    return '$' + Math.round(value).toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }
        
        // 绘制默认技术图表
        function drawDefaultTechnicalChart(ctx, indicators) {
            console.log('绘制默认技术图表，指标数据:', indicators);
            
            // 检查Chart.js是否可用
            if (typeof Chart === 'undefined') {
                console.error('Chart.js未正确加载');
                // 显示错误信息
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = '<div class="alert alert-warning text-center">' + getText('Chart.js正在加载中，请稍候...', 'Chart.js is loading, please wait...') + '</div>';
                ctx.parentNode.appendChild(errorDiv);
                return;
            }
            
            const currentPrice = 118783; // 当前BTC价格
            const labels = ['7天前', '6天前', '5天前', '4天前', '3天前', '2天前', '1天前', '今天'];
            const prices = [116500, 117200, 118000, 118500, 117800, 119200, 118600, currentPrice];
            
            try {
                // 确保Canvas上下文可用
                const context = ctx.getContext('2d');
                if (!context) {
                    console.error('无法获取Canvas上下文');
                    return;
                }
                
                techChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'BTC价格',
                            data: prices,
                            borderColor: '#ffc107',
                            backgroundColor: 'rgba(255, 193, 7, 0.1)',
                            fill: false,
                            tension: 0.1,
                            pointRadius: 3,
                            pointBackgroundColor: '#ffc107',
                            pointBorderColor: '#ffc107'
                        }, {
                            label: `SMA20 ($${Math.round(indicators.sma_20 || 119456).toLocaleString()})`,
                            data: new Array(labels.length).fill(indicators.sma_20 || 119456),
                            borderColor: '#0d6efd',
                            borderDash: [5, 5],
                            fill: false,
                            pointRadius: 0,
                            borderWidth: 2
                        }, {
                            label: `SMA50 ($${Math.round(indicators.sma_50 || 120433).toLocaleString()})`,
                            data: new Array(labels.length).fill(indicators.sma_50 || 120433),
                            borderColor: '#dc3545',
                            borderDash: [10, 5],
                            fill: false,
                            pointRadius: 0,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#fff',
                                    font: { size: 12 },
                                    usePointStyle: true,
                                    padding: 20
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0,0,0,0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: '#444',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            x: {
                                ticks: { 
                                    color: '#adb5bd',
                                    font: { size: 11 }
                                },
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    drawBorder: false
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#adb5bd',
                                    font: { size: 11 },
                                    callback: function(value) {
                                        return '$' + Math.round(value).toLocaleString();
                                    }
                                },
                                grid: { 
                                    color: 'rgba(255,255,255,0.1)',
                                    drawBorder: false
                                }
                            }
                        }
                    }
                });
                console.log('图表创建成功:', techChart);
                
                // 移除任何错误信息
                const errorAlert = ctx.parentNode.querySelector('.alert');
                if (errorAlert) {
                    errorAlert.remove();
                }
                
            } catch (error) {
                console.error('创建图表时出错:', error);
                // 显示错误信息
                const errorDiv = document.createElement('div');
                errorDiv.innerHTML = `<div class="alert alert-danger text-center">图表创建失败: ${error.message}</div>`;
                ctx.parentNode.appendChild(errorDiv);
            }
        }


    </script>

    <!-- 智能层功能JavaScript -->
    <script>
        // 全局变量
        let forecastChartInstance = null;
        let roiFactorChartInstance = null;
        const currentUserId = {{ session.get('user_id', 1) }};  // 获取当前用户ID，默认为1用于测试
        const currentLang = '{{ current_lang }}';

        // 检查智能层系统健康状态
        async function checkIntelligenceHealth() {
            try {
                const response = await fetch('/api/intelligence/health');
                const data = await response.json();
                
                const indicator = document.getElementById('healthIndicator');
                const statusText = document.getElementById('healthStatusText');
                const lastCheck = document.getElementById('healthLastCheck');
                
                const healthCard = document.querySelector('#intelligence .health-card');
                if (data.status === 'healthy') {
                    indicator.className = 'status-indicator status-online';
                    statusText.textContent = currentLang === 'en' ? 'Healthy' : '健康';
                    statusText.className = 'ms-2 text-success';
                    if (healthCard) healthCard.className = 'card health-card';
                } else {
                    indicator.className = 'status-indicator status-offline';
                    statusText.textContent = currentLang === 'en' ? 'Degraded' : '降级运行';
                    statusText.className = 'ms-2 text-warning';
                    if (healthCard) healthCard.className = 'card health-card degraded';
                }
                
                const now = new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN');
                lastCheck.textContent = (currentLang === 'en' ? 'Last check: ' : '最后检查: ') + now;
                
                console.log('✅ Intelligence health check completed:', data);
            } catch (error) {
                console.error('❌ Intelligence health check failed:', error);
                document.getElementById('healthStatusText').textContent = currentLang === 'en' ? 'Error' : '错误';
                document.getElementById('healthStatusText').className = 'ms-2 text-danger';
                const healthCard = document.querySelector('#intelligence .health-card');
                if (healthCard) healthCard.className = 'card health-card error';
            }
        }

        // 加载预测数据
        async function loadForecastData() {
            const summaryDiv = document.getElementById('forecastSummary');
            summaryDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ' + 
                (currentLang === 'en' ? 'Loading...' : '加载中...');
            
            try {
                const response = await fetch(`/api/intelligence/forecast/${currentUserId}?days=7`);
                
                if (response.status === 401) {
                    summaryDiv.innerHTML = '<div class="intel-alert intel-alert-warning"><i class="bi bi-lock"></i> ' +
                        (currentLang === 'en' ? 'Please login to view forecast data' : '请登录后查看预测数据') + '</div>';
                    return;
                }
                
                const data = await response.json();
                
                if (data.forecasts && data.forecasts.length > 0) {
                    document.getElementById('forecastChart').style.display = '';
                    
                    const predictions = data.forecasts.map(f => ({
                        date: f.date,
                        btc_price_predicted: f.btc_price.predicted,
                        btc_price_upper: f.btc_price.upper_bound,
                        btc_price_lower: f.btc_price.lower_bound
                    }));
                    
                    createForecastChart(predictions);
                    
                    const lastPrediction = predictions[predictions.length - 1];
                    summaryDiv.innerHTML = `
                        <div class="d-flex justify-content-between">
                            <div>
                                <small class="text-muted">${currentLang === 'en' ? '7-Day BTC Forecast' : '7天BTC预测'}</small>
                                <h6 class="mb-0">$${lastPrediction.btc_price_predicted.toLocaleString()}</h6>
                            </div>
                            <div>
                                <small class="text-muted">${currentLang === 'en' ? 'Confidence' : '置信度'}</small>
                                <h6 class="mb-0">${data.forecasts[0].model_accuracy && data.forecasts[0].model_accuracy.price_rmse ? (100 - data.forecasts[0].model_accuracy.price_rmse).toFixed(0) + '%' : '95%'}</h6>
                            </div>
                        </div>
                    `;
                } else if (data.count === 0 || (data.forecasts && data.forecasts.length === 0)) {
                    document.getElementById('forecastChart').style.display = 'none';
                    summaryDiv.innerHTML = '<div class="intelligence-empty-state">' +
                        '<i class="bi bi-graph-up-arrow"></i>' +
                        '<p>' + (currentLang === 'en' ? 'No forecast data yet. Click to generate predictions.' : '暂无预测数据。点击生成预测。') + '</p>' +
                        '<button class="btn btn-sm btn-outline-warning mt-2" onclick="refreshForecast()">' +
                        '<i class="bi bi-arrow-clockwise"></i> ' + (currentLang === 'en' ? 'Generate Forecast' : '生成预测') + '</button></div>';
                } else {
                    document.getElementById('forecastChart').style.display = 'none';
                    summaryDiv.innerHTML = '<div class="intelligence-empty-state">' +
                        '<i class="bi bi-graph-up-arrow"></i>' +
                        '<p>' + (currentLang === 'en' ? 'No forecast data available.' : '暂无预测数据。') + '</p></div>';
                }
                
                console.log('✅ Forecast data loaded:', data);
            } catch (error) {
                console.error('❌ Failed to load forecast:', error);
                document.getElementById('forecastChart').style.display = 'none';
                summaryDiv.innerHTML = '<div class="intel-alert intel-alert-danger">' +
                    (currentLang === 'en' ? 'Failed to load forecast data' : '加载预测数据失败') + '</div>';
            }
        }

        async function refreshForecast() {
            const summaryDiv = document.getElementById('forecastSummary');
            summaryDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ' +
                (currentLang === 'en' ? 'Generating forecast...' : '正在生成预测...');
            
            try {
                const response = await fetch(`/api/intelligence/forecast/${currentUserId}/refresh`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days: 7, force: true})
                });
                
                if (response.ok) {
                    console.log('✅ Forecast refresh triggered');
                    setTimeout(() => loadForecastData(), 1000);
                } else {
                    const data = await response.json();
                    summaryDiv.innerHTML = '<div class="intel-alert intel-alert-danger">' +
                        (currentLang === 'en' ? 'Failed to generate forecast: ' : '生成预测失败: ') + (data.message || 'Unknown error') + '</div>';
                }
            } catch (error) {
                console.error('❌ Forecast refresh failed:', error);
                summaryDiv.innerHTML = '<div class="intel-alert intel-alert-danger">' +
                    (currentLang === 'en' ? 'Failed to generate forecast' : '生成预测失败') + '</div>';
            }
        }

        // 创建预测图表
        function createForecastChart(predictions) {
            const ctx = document.getElementById('forecastChart').getContext('2d');
            
            if (forecastChartInstance) {
                forecastChartInstance.destroy();
            }
            
            const dates = predictions.map(p => p.date);
            const prices = predictions.map(p => p.btc_price_predicted);
            const upperBound = predictions.map(p => p.btc_price_upper);
            const lowerBound = predictions.map(p => p.btc_price_lower);
            
            forecastChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [{
                        label: currentLang === 'en' ? 'Predicted Price' : '预测价格',
                        data: prices,
                        borderColor: '#ffc107',
                        backgroundColor: 'rgba(255, 193, 7, 0.1)',
                        borderWidth: 2,
                        tension: 0.4
                    }, {
                        label: currentLang === 'en' ? 'Upper Bound (95%)' : '上界 (95%)',
                        data: upperBound,
                        borderColor: 'rgba(72, 187, 120, 0.5)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        fill: false
                    }, {
                        label: currentLang === 'en' ? 'Lower Bound (95%)' : '下界 (95%)',
                        data: lowerBound,
                        borderColor: 'rgba(245, 101, 101, 0.5)',
                        borderDash: [5, 5],
                        borderWidth: 1,
                        fill: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        },
                        y: {
                            ticks: { 
                                color: '#ffffff',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: { color: 'rgba(255, 255, 255, 0.1)' }
                        }
                    }
                }
            });
        }

        // 加载ROI解释
        async function loadROIExplanation() {
            const recommendDiv = document.getElementById('roiRecommendations');
            recommendDiv.innerHTML = '<div class="spinner-border spinner-border-sm" role="status"></div> ' +
                (currentLang === 'en' ? 'Analyzing...' : '分析中...');
            
            try {
                const response = await fetch(`/api/intelligence/explain/roi/${currentUserId}`);
                
                if (response.status === 401) {
                    recommendDiv.innerHTML = '<div class="intel-alert intel-alert-warning"><i class="bi bi-lock"></i> ' +
                        (currentLang === 'en' ? 'Please login to view ROI analysis' : '请登录后查看ROI分析') + '</div>';
                    return;
                }
                
                const data = await response.json();
                
                if (data.status === 'success' && data.roi_analysis) {
                    const analysis = data.roi_analysis;
                    const metrics = analysis.current_metrics;
                    const impacts = analysis.factor_impacts;
                    
                    document.getElementById('roiFactorChart').style.display = '';
                    
                    const factors = [
                        { factor: currentLang === 'en' ? 'BTC Price' : 'BTC价格', impact_percent: impacts.btc_price.contribution_percent },
                        { factor: currentLang === 'en' ? 'Difficulty' : '网络难度', impact_percent: impacts.difficulty.contribution_percent },
                        { factor: currentLang === 'en' ? 'Uptime' : '在线率', impact_percent: impacts.offline_rate.contribution_percent },
                        { factor: currentLang === 'en' ? 'Electricity' : '电力成本', impact_percent: impacts.electricity_cost.contribution_percent }
                    ];
                    
                    createROIFactorChart(factors);
                    
                    let html = '<div class="mt-2">';
                    html += `<h6 class="mb-2">${currentLang === 'en' ? 'Annual ROI' : '年化ROI'}: <span class="${metrics.annual_roi_percent >= 0 ? 'text-success' : 'text-danger'}">${metrics.annual_roi_percent.toFixed(1)}%</span></h6>`;
                    html += `<div class="small mb-2" style="color: rgba(255,255,255,0.6);">`;
                    html += `${currentLang === 'en' ? 'Daily Revenue' : '日收入'}: $${metrics.daily_revenue_usd.toFixed(2)} | `;
                    html += `${currentLang === 'en' ? 'Daily Cost' : '日成本'}: $${metrics.daily_cost_usd.toFixed(2)} | `;
                    html += `${currentLang === 'en' ? 'Daily Profit' : '日利润'}: <span class="${metrics.daily_profit_usd >= 0 ? 'text-success' : 'text-danger'}">$${metrics.daily_profit_usd.toFixed(2)}</span>`;
                    html += `</div>`;
                    html += '<small class="text-muted">' + (currentLang === 'en' ? 'Key Factors:' : '关键因素:') + '</small><ul class="small mt-1" style="color: rgba(255,255,255,0.7);">';
                    Object.values(impacts).forEach(impact => {
                        html += `<li>${impact.description}</li>`;
                    });
                    html += '</ul>';
                    html += '</div>';
                    recommendDiv.innerHTML = html;
                } else {
                    document.getElementById('roiFactorChart').style.display = 'none';
                    recommendDiv.innerHTML = '<div class="intelligence-empty-state">' +
                        '<i class="bi bi-pie-chart"></i>' +
                        '<p>' + (currentLang === 'en' ? 'No ROI data available. Add miners to see analysis.' : 
                        '暂无ROI数据。请添加矿机以查看分析。') + '</p></div>';
                }
                
                console.log('✅ ROI explanation loaded:', data);
            } catch (error) {
                console.error('❌ Failed to load ROI explanation:', error);
                document.getElementById('roiFactorChart').style.display = 'none';
                recommendDiv.innerHTML = '<div class="intel-alert intel-alert-danger">' +
                    (currentLang === 'en' ? 'Failed to load ROI analysis' : '加载ROI分析失败') + '</div>';
            }
        }

        // 创建ROI因素饼图
        function createROIFactorChart(factors) {
            const ctx = document.getElementById('roiFactorChart').getContext('2d');
            
            if (roiFactorChartInstance) {
                roiFactorChartInstance.destroy();
            }
            
            const labels = factors.map(f => f.factor);
            const data = factors.map(f => f.impact_percent);
            const colors = ['#ffc107', '#48bb78', '#667eea', '#ed8936'];
            
            roiFactorChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { 
                                color: '#ffffff',
                                padding: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // 显示电力优化输入框
        function showOptimizationInput() {
            const resultsDiv = document.getElementById('optimizationResults');
            resultsDiv.innerHTML = `
                <div class="intel-alert intel-alert-info">
                    <i class="bi bi-info-circle"></i> ${currentLang === 'en' ? 'This feature requires user-specific electricity pricing data.' : '此功能需要用户特定的电价数据。'}
                    <br><small>${currentLang === 'en' ? 'Integration coming soon!' : '即将推出！'}</small>
                </div>
            `;
        }

        // 检测异常
        async function detectAnomalies() {
            const alertsDiv = document.getElementById('anomalyAlerts');
            
            try {
                // 模拟异常检测（实际应调用后端API）
                setTimeout(() => {
                    alertsDiv.innerHTML = `
                        <div class="intel-alert intel-alert-success mb-2">
                            <i class="bi bi-check-circle"></i> <strong>${currentLang === 'en' ? 'All Systems Normal' : '所有系统正常'}</strong>
                            <br><small style="color: rgba(72,187,120,0.7);">${currentLang === 'en' ? 'No anomalies detected in the last 24 hours' : '过去24小时未检测到异常'}</small>
                        </div>
                        <div class="small text-muted">
                            ${currentLang === 'en' ? 'Last scan' : '最后扫描'}: ${new Date().toLocaleString(currentLang === 'en' ? 'en-US' : 'zh-CN')}
                        </div>
                    `;
                }, 1500);
                
                console.log('✅ Anomaly detection completed');
            } catch (error) {
                console.error('❌ Anomaly detection failed:', error);
                alertsDiv.innerHTML = '<div class="intel-alert intel-alert-danger">' +
                    (currentLang === 'en' ? 'Failed to scan for anomalies' : '异常扫描失败') + '</div>';
            }
        }

        // 智能分析标签页激活时自动加载数据
        document.addEventListener('DOMContentLoaded', function() {
            const intelligenceTab = document.getElementById('intelligence-tab');
            
            if (intelligenceTab) {
                intelligenceTab.addEventListener('shown.bs.tab', function() {
                    console.log('🧠 Intelligence tab activated!');
                    checkIntelligenceHealth();
                    loadForecastData();
                    loadROIExplanation();
                    detectAnomalies();
                });
            }
        });
    </script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Deribit标签页功能 -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Deribit tab functionality loaded!');
            
            // 标签页切换事件处理
            const deribitTab = document.getElementById('deribit-tab');
            if (deribitTab) {
                deribitTab.addEventListener('shown.bs.tab', function() {
                    console.log('📊 Deribit tab activated!');
                    updateDeribitTabData();
                });
            }
            
            // 更新Deribit标签页数据
            function updateDeribitTabData() {
                console.log('🔄 Updating Deribit tab data...');
                
                // 同步主页面的数据到Deribit标签页
                const totalTrades = document.getElementById('totalTrades');
                const avgPrice = document.getElementById('avgPrice');
                const lastUpdateTime = document.getElementById('lastUpdateTime');
                const exchangeData = document.getElementById('exchangeData');
                
                if (totalTrades && document.getElementById('deribitTotalTrades')) {
                    document.getElementById('deribitTotalTrades').textContent = totalTrades.textContent;
                }
                if (avgPrice && document.getElementById('deribitAvgPrice')) {
                    document.getElementById('deribitAvgPrice').textContent = avgPrice.textContent;
                }
                if (lastUpdateTime && document.getElementById('deribitLastUpdate')) {
                    document.getElementById('deribitLastUpdate').textContent = lastUpdateTime.textContent;
                }
                if (exchangeData && document.getElementById('deribitExchangeData')) {
                    document.getElementById('deribitExchangeData').innerHTML = exchangeData.innerHTML;
                }
                
                console.log('✅ Deribit tab data updated successfully!');
            }
            
            // 确保综合概览标签页在页面加载时激活
            const overviewTab = document.getElementById('overview-tab');
            const overviewPane = document.getElementById('overview');
            if (overviewTab && overviewPane) {
                overviewTab.classList.add('active');
                overviewPane.classList.add('show', 'active');
                console.log('✅ Overview tab activated on page load');
            }
            
            // 初始化数据更新
            setTimeout(updateDeribitTabData, 1000);
            
            // 每30秒自动更新Deribit标签页数据
            setInterval(updateDeribitTabData, 30000);
        });
    </script>


    <!-- Sidecar Offcanvas (辅助界面) -->
    <div class="offcanvas offcanvas-end text-bg-dark" tabindex="-1" id="sidecarCanvas" aria-labelledby="sidecarCanvasLabel" style="width: 38vw; min-width: 360px;">
        <div class="offcanvas-header border-bottom" style="border-color:#2d3748 !important;">
            <h5 class="offcanvas-title" id="sidecarCanvasLabel">
                <i class="bi bi-grid-3x3-gap me-2"></i>{% if current_lang == 'en' %}Aux Sidecar{% else %}辅助界面{% endif %}
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body p-0" style="overflow:hidden;">
            <iframe src="/analytics/sidecar" style="border:0;width:100%;height:100vh;" referrerpolicy="no-referrer"></iframe>
        </div>
    </div>

    <!-- Legal Footer -->
    <footer class="py-4 mt-5 border-top" style="background-color: #1a2332; border-color: #2d3748 !important;">
        <div class="container text-center">
            <div class="row">
                <div class="col-12 mb-3">
                    <a href="{{ url_for('legal_terms') }}" class="btn btn-outline-warning btn-sm me-3">
                        <i class="bi bi-shield-check me-1"></i>
                        {% if current_lang == 'zh' %}服务条款和隐私政策{% else %}Terms of Use & Privacy Notice{% endif %}
                    </a>
                    <a href="mailto:cryptocalculator123@gmail.com" class="btn btn-outline-info btn-sm">
                        <i class="bi bi-envelope me-1"></i>
                        {% if current_lang == 'zh' %}联系我们{% else %}Contact Us{% endif %}
                    </a>
                </div>
                <div class="col-12">
                    <p class="text-muted mb-0">
                        <small>© 2025 HashInsight Mining Intelligence. {% if current_lang == 'zh' %}最后更新{% else %}Last Updated{% endif %}: 22 August 2025</small>
                    </p>
                </div>
            </div>
        </div>
    </footer>

</body>
</html>