{% extends "hosting/hosting_base.html" %}

{% block title %}Site Monitor - {{ site.name if site else 'Unknown' }}{% endblock %}

{% block page_title %}<span data-i18n="monitor.site_monitor">Site Monitor</span> - {{ site.name if site else 'Unknown' }}{% endblock %}
{% block page_subtitle %}<span data-i18n="monitor.realtime_telemetry">Real-time Telemetry Dashboard</span>{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="row g-3 mb-4">
    <div class="col-lg-3 col-md-6">
        <div class="hosting-card h-100">
            <div class="hosting-card-body text-center">
                <h6 class="text-muted mb-2"><i class="bi bi-cpu"></i> <span data-i18n="monitor.total_miners">Total Miners</span></h6>
                <span class="fs-2 fw-bold text-warning" id="total-miners">--</span>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="hosting-card h-100">
            <div class="hosting-card-body text-center">
                <h6 class="text-muted mb-2"><i class="bi bi-check-circle text-success"></i> <span data-i18n="monitor.online">Online</span></h6>
                <span class="fs-2 fw-bold text-success" id="online-miners">--</span>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="hosting-card h-100">
            <div class="hosting-card-body text-center">
                <h6 class="text-muted mb-2"><i class="bi bi-x-circle text-danger"></i> <span data-i18n="monitor.offline">Offline</span></h6>
                <span class="fs-2 fw-bold text-danger" id="offline-miners">--</span>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6">
        <div class="hosting-card h-100">
            <div class="hosting-card-body text-center">
                <h6 class="text-muted mb-2"><i class="bi bi-lightning-charge"></i> <span data-i18n="monitor.total_hashrate">Total Hashrate</span></h6>
                <span class="fs-2 fw-bold text-info" id="total-hashrate">--</span>
                <span class="text-muted">TH/s</span>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-8">
        <div class="hosting-card">
            <div class="hosting-card-header d-flex justify-content-between align-items-center">
                <h5 class="hosting-card-title mb-0">
                    <i class="bi bi-list-ul me-2"></i><span data-i18n="monitor.miner_list">Miner List</span>
                </h5>
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="onlineOnlyFilter">
                    <label class="form-check-label small text-muted" for="onlineOnlyFilter" data-i18n="monitor.online_only">Online Only</label>
                </div>
            </div>
            <div class="hosting-card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-hover" id="minerTable">
                        <thead>
                            <tr>
                                <th data-i18n="monitor.miner_id">Miner ID</th>
                                <th data-i18n="monitor.ip_address">IP Address</th>
                                <th data-i18n="monitor.status">Status</th>
                                <th data-i18n="monitor.hashrate">Hashrate (TH/s)</th>
                                <th data-i18n="monitor.temp_avg">Temp Avg (°C)</th>
                                <th data-i18n="monitor.temp_max">Temp Max (°C)</th>
                                <th data-i18n="monitor.updated">Updated</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="minerTableBody">
                            <tr>
                                <td colspan="8" class="text-center text-muted py-4">
                                    <div class="spinner-border spinner-border-sm me-2"></div>
                                    <span data-i18n="monitor.loading">Loading miners...</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Miner pagination">
                    <ul class="pagination pagination-sm justify-content-center mb-0" id="minerPagination"></ul>
                </nav>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="hosting-card h-100">
            <div class="hosting-card-header">
                <h5 class="hosting-card-title mb-0">
                    <i class="bi bi-graph-up me-2"></i><span data-i18n="monitor.history_chart">History Chart</span>
                </h5>
            </div>
            <div class="hosting-card-body">
                <div class="mb-3">
                    <label class="form-label small text-muted" data-i18n="monitor.selected_miner">Selected Miner</label>
                    <input type="text" class="form-control form-control-sm bg-dark text-light" id="selectedMiner" readonly placeholder="Click a miner to view history">
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted" data-i18n="monitor.metric">Metric</label>
                    <select class="form-select form-select-sm bg-dark text-light" id="metricSelect">
                        <option value="hashrate_ghs">Hashrate (GH/s)</option>
                        <option value="temperature_max">Temperature Max (°C)</option>
                        <option value="temperature_avg">Temperature Avg (°C)</option>
                        <option value="fan_speed_avg">Fan Speed Avg (RPM)</option>
                        <option value="power_consumption">Power (W)</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label small text-muted" data-i18n="monitor.hours">Hours</label>
                    <select class="form-select form-select-sm bg-dark text-light" id="hoursSelect">
                        <option value="6">6 hours</option>
                        <option value="12">12 hours</option>
                        <option value="24" selected>24 hours</option>
                        <option value="48">48 hours</option>
                        <option value="168">7 days</option>
                    </select>
                </div>
                <canvas id="historyChart" height="200"></canvas>
                <p class="text-muted small text-center mt-2" id="chartMessage" data-i18n="monitor.select_miner_prompt">Select a miner to view history</p>
            </div>
        </div>
    </div>
</div>

<script>
const SITE_ID = {{ site_id }};
let currentPage = 1;
let onlineOnly = false;
let selectedMinerId = null;
let historyChart = null;

document.addEventListener('DOMContentLoaded', function() {
    loadSummary();
    loadMiners();
    
    document.getElementById('onlineOnlyFilter').addEventListener('change', function() {
        onlineOnly = this.checked;
        currentPage = 1;
        loadMiners();
    });
    
    document.getElementById('metricSelect').addEventListener('change', loadHistory);
    document.getElementById('hoursSelect').addEventListener('change', loadHistory);
    
    setInterval(function() {
        loadSummary();
        loadMiners();
        if (selectedMinerId) loadHistory();
    }, 30000);
});

function loadSummary() {
    fetch(`/api/collector/summary/${SITE_ID}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                const d = data.data;
                document.getElementById('total-miners').textContent = d.total_miners || 0;
                document.getElementById('online-miners').textContent = d.online_miners || 0;
                document.getElementById('offline-miners').textContent = d.offline_miners || 0;
                document.getElementById('total-hashrate').textContent = (d.total_hashrate_ths || 0).toFixed(1);
            }
        })
        .catch(err => console.error('Summary error:', err));
}

function loadMiners() {
    const params = new URLSearchParams({
        page: currentPage,
        per_page: 20,
        online_only: onlineOnly
    });
    
    fetch(`/api/collector/monitor/sites/${SITE_ID}/miners/latest?${params}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderMinerTable(data.data.miners);
                renderPagination(data.data.pagination);
            }
        })
        .catch(err => {
            console.error('Miners error:', err);
            document.getElementById('minerTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Failed to load miners</td></tr>';
        });
}

function renderMinerTable(miners) {
    const tbody = document.getElementById('minerTableBody');
    
    if (!miners || miners.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">No miners found</td></tr>';
        return;
    }
    
    tbody.innerHTML = miners.map(m => {
        const statusClass = m.online ? 'text-success' : 'text-danger';
        const statusIcon = m.online ? 'bi-check-circle-fill' : 'bi-x-circle-fill';
        const statusText = m.online ? 'Online' : 'Offline';
        const updatedAt = m.updated_at ? new Date(m.updated_at).toLocaleString() : '-';
        const isSelected = m.miner_id === selectedMinerId;
        
        return `
            <tr class="${isSelected ? 'table-active' : ''}" style="cursor: pointer;" onclick="selectMiner('${m.miner_id}')">
                <td><code class="text-warning">${m.miner_id}</code></td>
                <td><code>${m.ip_address || '-'}</code></td>
                <td><i class="bi ${statusIcon} ${statusClass}"></i> <span class="${statusClass}">${statusText}</span></td>
                <td>${m.hashrate_ths ? m.hashrate_ths.toFixed(2) : '0.00'}</td>
                <td>${m.temperature_avg ? m.temperature_avg.toFixed(1) : '-'}</td>
                <td class="${m.temperature_max > 80 ? 'text-danger fw-bold' : ''}">${m.temperature_max ? m.temperature_max.toFixed(1) : '-'}</td>
                <td class="small text-muted">${updatedAt}</td>
                <td><button class="btn btn-sm btn-outline-warning" onclick="event.stopPropagation(); selectMiner('${m.miner_id}')"><i class="bi bi-graph-up"></i></button></td>
            </tr>
        `;
    }).join('');
}

function renderPagination(pagination) {
    const nav = document.getElementById('minerPagination');
    if (!pagination || pagination.pages <= 1) {
        nav.innerHTML = '';
        return;
    }
    
    let html = '';
    if (currentPage > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">«</a></li>`;
    }
    for (let i = 1; i <= pagination.pages; i++) {
        if (i === currentPage) {
            html += `<li class="page-item active"><span class="page-link">${i}</span></li>`;
        } else if (Math.abs(i - currentPage) <= 2 || i === 1 || i === pagination.pages) {
            html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${i})">${i}</a></li>`;
        } else if (Math.abs(i - currentPage) === 3) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }
    if (currentPage < pagination.pages) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">»</a></li>`;
    }
    nav.innerHTML = html;
}

function goToPage(page) {
    currentPage = page;
    loadMiners();
}

function selectMiner(minerId) {
    selectedMinerId = minerId;
    document.getElementById('selectedMiner').value = minerId;
    document.getElementById('chartMessage').style.display = 'none';
    loadHistory();
    loadMiners();
}

function loadHistory() {
    if (!selectedMinerId) return;
    
    const metric = document.getElementById('metricSelect').value;
    const hours = document.getElementById('hoursSelect').value;
    
    fetch(`/api/collector/monitor/sites/${SITE_ID}/miners/${selectedMinerId}/history?metric=${metric}&hours=${hours}`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                renderHistoryChart(data.data);
            }
        })
        .catch(err => console.error('History error:', err));
}

function renderHistoryChart(data) {
    const ctx = document.getElementById('historyChart').getContext('2d');
    
    if (historyChart) {
        historyChart.destroy();
    }
    
    const labels = data.points.map(p => {
        const d = new Date(p.timestamp);
        return d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    });
    
    const values = data.points.map(p => p.value);
    
    const metricColors = {
        'hashrate_ghs': '#f7931e',
        'temperature_max': '#dc3545',
        'temperature_avg': '#fd7e14',
        'fan_speed_avg': '#20c997',
        'power_consumption': '#6f42c1'
    };
    
    const color = metricColors[data.metric] || '#f7931e';
    
    historyChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: data.metric.replace(/_/g, ' ').toUpperCase(),
                data: values,
                borderColor: color,
                backgroundColor: color + '33',
                fill: true,
                tension: 0.3,
                pointRadius: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }
            },
            scales: {
                x: {
                    display: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#adb5bd', maxTicksLimit: 6 }
                },
                y: {
                    display: true,
                    grid: { color: 'rgba(255,255,255,0.1)' },
                    ticks: { color: '#adb5bd' }
                }
            }
        }
    });
}
</script>
{% endblock %}
