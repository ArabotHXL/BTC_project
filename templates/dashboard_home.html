{% extends "base.html" %}

{% block title %}
    {% if current_lang == 'en' %}Bitcoin Mining Intelligent Analysis Platform{% else %}Bitcoin挖矿智能分析平台{% endif %} - BTC Mining Calculator
{% endblock %}

{% block extra_css %}
<style>
/* Modern dashboard styling */
:root {
    --primary-gold: #ffc107;
    --bg-gradient: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
    --card-bg: rgba(255, 255, 255, 0.05);
    --card-border: rgba(255, 255, 255, 0.1);
    --text-primary: #ffffff;
    --text-secondary: #b8b8b8;
    --shadow-glow: 0 8px 32px rgba(255, 193, 7, 0.15);
}

body {
    background: var(--bg-gradient);
    min-height: 100vh;
}

.dashboard-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem;
    position: relative;
}

.dashboard-hero {
    text-align: center;
    margin-bottom: 4rem;
    position: relative;
}

.dashboard-title {
    font-size: 3.5rem;
    font-weight: 700;
    background: linear-gradient(135deg, var(--primary-gold), #e67e22, #dc3545);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    text-shadow: 0 0 30px rgba(255, 193, 7, 0.3);
}

.dashboard-subtitle {
    font-size: 1.2rem;
    color: var(--text-secondary);
    margin-bottom: 2rem;
    max-width: 600px;
    margin: 0 auto 2rem;
    line-height: 1.6;
}

.stats-bar {
    display: flex;
    justify-content: center;
    gap: 3rem;
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: var(--primary-gold);
    display: block;
}

.stat-label {
    font-size: 0.9rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
    gap: 2rem;
    margin-top: 2rem;
}

.dashboard-card {
    background: var(--card-bg);
    border: 1px solid var(--card-border);
    border-radius: 24px;
    padding: 2.5rem 2rem;
    text-align: center;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    cursor: pointer;
    position: relative;
    overflow: hidden;
    height: 280px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(20px);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.dashboard-card:hover {
    transform: translateY(-12px) scale(1.02);
    box-shadow: var(--shadow-glow);
    border-color: var(--primary-gold);
    background: rgba(255, 193, 7, 0.08);
}

.dashboard-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, transparent, rgba(255, 193, 7, 0.1), transparent);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.dashboard-card:hover::before {
    opacity: 1;
}

.dashboard-card::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    background: linear-gradient(45deg, var(--primary-gold), #e67e22, #dc3545, #6f42c1);
    border-radius: 24px;
    z-index: -1;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.dashboard-card:hover::after {
    opacity: 0.7;
}

.card-content {
    position: relative;
    z-index: 2;
    width: 100%;
}

.card-icon {
    font-size: 4rem;
    margin-bottom: 1.5rem;
    display: block;
    transition: all 0.3s ease;
    filter: drop-shadow(0 0 20px currentColor);
}

.dashboard-card:hover .card-icon {
    transform: scale(1.1) rotateY(15deg);
    filter: drop-shadow(0 0 30px currentColor);
}

.card-title {
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0 0 1rem 0;
    line-height: 1.3;
}

.card-description {
    font-size: 0.95rem;
    color: var(--text-secondary);
    margin-top: 0.5rem;
    opacity: 0.8;
    line-height: 1.5;
    max-width: 250px;
    margin: 0 auto;
}

.card-stats {
    position: absolute;
    top: 1rem;
    right: 1rem;
    background: rgba(255, 193, 7, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: 600;
    color: var(--primary-gold);
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.dashboard-card:hover .card-stats {
    opacity: 1;
    transform: translateY(0);
}

@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Enhanced card themes */
.calculator-item {
    background: linear-gradient(135deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
}

.calculator-item::after {
    background: linear-gradient(45deg, #ffc107, #e67e22);
}

.batch-item {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
}

.batch-item::after {
    background: linear-gradient(45deg, #28a745, #20c997);
}

.customer-item {
    background: linear-gradient(135deg, rgba(220, 53, 85, 0.1), rgba(220, 53, 85, 0.05));
}

.customer-item::after {
    background: linear-gradient(45deg, #dc3545, #e74c3c);
}

.analytics-item {
    background: linear-gradient(135deg, rgba(220, 53, 85, 0.15), rgba(230, 126, 34, 0.1));
}

.analytics-item::after {
    background: linear-gradient(45deg, #dc3545, #e67e22, #f39c12);
}

.user-item {
    background: linear-gradient(135deg, rgba(111, 66, 193, 0.1), rgba(111, 66, 193, 0.05));
}

.user-item::after {
    background: linear-gradient(45deg, #6f42c1, #8e44ad);
}

.performance-item {
    background: linear-gradient(135deg, rgba(253, 126, 20, 0.1), rgba(253, 126, 20, 0.05));
}

.performance-item::after {
    background: linear-gradient(45deg, #fd7e14, #f39c12);
}

.sla-nft-item {
    background: linear-gradient(135deg, rgba(106, 13, 173, 0.15), rgba(142, 68, 173, 0.1));
}

.sla-nft-item::after {
    background: linear-gradient(45deg, #6a0dad, #8e44ad, #9b59b6);
}

.sla-nft-badge {
    position: absolute;
    top: 1rem;
    left: 1rem;
    background: rgba(106, 13, 173, 0.3);
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.7rem;
    font-weight: 600;
    color: #9b59b6;
    opacity: 0;
    transform: translateY(-10px);
    transition: all 0.3s ease;
}

.dashboard-card:hover .sla-nft-badge {
    opacity: 1;
    transform: translateY(0);
}

.sla-status-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-right: 6px;
    animation: pulse 2s infinite;
}

.sla-status-excellent { background: #28a745; }
.sla-status-good { background: #17a2b8; }
.sla-status-acceptable { background: #ffc107; }
.sla-status-poor { background: #fd7e14; }
.sla-status-failed { background: #dc3545; }

@keyframes pulse {
    0% { opacity: 1; }
    50% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* Enhanced responsive design */
@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    }
    
    .stats-bar {
        gap: 2rem;
    }
}

@media (max-width: 768px) {
    .dashboard-container {
        padding: 1rem;
    }

    .dashboard-title {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }
    
    .dashboard-subtitle {
        font-size: 1rem;
        margin-bottom: 1.5rem;
    }

    .stats-bar {
        flex-direction: column;
        gap: 1rem;
        padding: 1rem;
    }
    
    .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        text-align: left;
    }
    
    .stat-value {
        font-size: 1.5rem;
    }

    .dashboard-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .dashboard-card {
        padding: 2rem 1.5rem;
        height: 220px;
    }

    .card-icon {
        font-size: 3rem;
    }

    .card-title {
        font-size: 1.2rem;
    }
    
    .card-description {
        font-size: 0.9rem;
    }
}

/* 页面加载动画 */
.dashboard-card {
    opacity: 0;
    transform: translateY(20px);
    animation: slideInUp 0.6s ease forwards;
}

.dashboard-card:nth-child(1) { animation-delay: 0.1s; }
.dashboard-card:nth-child(2) { animation-delay: 0.2s; }
.dashboard-card:nth-child(3) { animation-delay: 0.3s; }
.dashboard-card:nth-child(4) { animation-delay: 0.4s; }
.dashboard-card:nth-child(5) { animation-delay: 0.5s; }
.dashboard-card:nth-child(6) { animation-delay: 0.6s; }
.dashboard-card:nth-child(7) { animation-delay: 0.7s; } /* Add delay for hosting card */

@keyframes slideInUp {
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* 描述文字逐渐显现动画 */
.dashboard-card.show-description .card-description {
    animation: fadeInDescription 1.2s ease forwards;
    animation-delay: 1s; /* 卡片加载后1秒开始显示描述 */
}

@keyframes fadeInDescription {
    from {
        opacity: 0;
        transform: translateY(10px);
        max-height: 0;
    }
    to {
        opacity: 0.8;
        transform: translateY(0);
        max-height: 100px;
    }
}

/* 为特定卡片添加图标颜色 */
.calculator-item .card-icon,
.calculator-item .bi,
.calculator-item i { color: #ffc107 !important; } /* 挖矿计算器 - 金黄色 */

.batch-item .card-icon,
.batch-item .bi,
.batch-item i { color: #28a745 !important; } /* 批量计算器 - 绿色 */

.customer-item .card-icon,
.customer-item .bi,
.customer-item i { color: #dc3545 !important; } /* 客户管理 - 红色 */

.analytics-item .card-icon,
.analytics-item .bi,
.analytics-item i { color: #dc3545 !important; } /* 分析平台 - 红色 */

.user-item .card-icon,
.user-item .bi,
.user-item i { color: #6f42c1 !important; } /* 用户管理 - 紫色 */

.performance-item .card-icon,
.performance-item .bi,
.performance-item i { color: #fd7e14 !important; } /* 性能监控 - 橙色 */

.hosting-item .card-icon,
.hosting-item .bi,
.hosting-item i { color: #20c997 !important; } /* 托管管理 - 青绿色 */

/* 用户下拉按钮悬停效果 */
#userDropdown:hover {
    background: rgba(255, 193, 7, 0.2) !important;
    border-color: var(--primary-gold) !important;
    transform: translateY(-2px);
    box-shadow: 0 12px 40px rgba(255, 193, 7, 0.25) !important;
}

/* 下拉菜单项悬停效果 */
.dropdown-item:hover {
    background: rgba(255, 193, 7, 0.15) !important;
    color: var(--primary-gold) !important;
    transform: translateX(4px);
    transition: all 0.2s ease;
}

/* 固定位置用户下拉菜单样式 */
.position-fixed #userDropdown:hover {
    background: rgba(26, 26, 46, 0.95) !important;
    border-color: var(--primary-gold) !important;
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 15px 50px rgba(255, 193, 7, 0.3) !important;
}

/* 确保下拉菜单不会与内容重叠 */
.dashboard-hero {
    margin-bottom: 3rem;
    padding-top: 1rem;
}

.dashboard-grid {
    margin-top: 2rem;
    position: relative;
    z-index: 1;
}

/* 响应式统计栏调整 */
@media (max-width: 768px) {
    .stats-bar {
        flex-direction: column !important;
        gap: 1rem;
    }
    
    .stats-bar .d-flex.gap-3 {
        justify-content: center;
        order: 2;
    }
    
    .stats-bar .dropdown {
        order: 1;
        align-self: flex-end;
        margin: 0 !important;
    }
    
    #userDropdown {
        font-size: 0.9rem;
        padding: 0.5rem 1rem !important;
    }
    
    #userDropdown + .dropdown-menu {
        transform: translateY(5px) !important;
        max-height: 300px !important;
    }
}

</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- User Account Dropdown - Top Right Corner -->
    <div class="position-fixed" style="top: 6rem; right: 1rem; z-index: 10000;">
        <div class="dropdown">
            <button class="btn btn-outline-light dropdown-toggle d-flex align-items-center" 
                    type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false"
                    style="background: rgba(26, 26, 46, 0.9); 
                           border: 1px solid rgba(255, 193, 7, 0.5); 
                           border-radius: 20px; 
                           padding: 0.75rem 1.25rem;
                           backdrop-filter: blur(15px);
                           box-shadow: 0 8px 32px rgba(255, 193, 7, 0.2);
                           transition: all 0.3s ease;
                           white-space: nowrap;
                           font-size: 0.95rem;
                           min-width: 200px;">
                <i class="bi bi-person-circle me-2" style="color: var(--primary-gold); font-size: 1.1rem;"></i>
                <span style="color: var(--text-primary); font-weight: 600;">
                    {% if session.email %}
                        {{ session.email.split('@')[0] }}...
                    {% else %}
                        {% if current_lang == 'en' %}Guest{% else %}访客{% endif %}
                    {% endif %}
                </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end shadow-lg" 
                style="background: rgba(26, 26, 46, 0.95); 
                       border: 1px solid rgba(255, 193, 7, 0.3);
                       border-radius: 20px; 
                       backdrop-filter: blur(20px);
                       min-width: 300px;
                       max-height: 500px;
                       overflow-y: auto;
                       box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
                       margin-top: 0.75rem;">
                <li><h6 class="dropdown-header text-warning">
                    <i class="bi bi-person-badge me-2"></i>
                    {% if current_lang == 'en' %}Account Info{% else %}账户信息{% endif %}
                </h6></li>
                {% if session.email %}
                    <li><span class="dropdown-item-text text-light">{{ session.email }}</span></li>
                    
                    <!-- 根据角色显示管理员选项 -->
                    {% if session.role in ['owner', 'admin', 'mining_site', 'mining_site_owner'] %}
                        <li><hr class="dropdown-divider border-warning"></li>
                        <li><h6 class="dropdown-header text-warning">
                            <i class="bi bi-gear me-2"></i>
                            {% if current_lang == 'en' %}Admin Functions{% else %}管理功能{% endif %}
                        </h6></li>
                        
                        <!-- 拥有者可以查看登录记录 -->
                        {% if session.role == 'owner' %}
                        <li><a class="dropdown-item text-light" href="{{ url_for('analytics_dashboard') }}" style="border-radius: 10px; margin: 4px;">
                            <i class="bi bi-graph-up-arrow me-2 text-warning"></i> 
                            {% if current_lang == 'en' %}Data Analytics Center{% else %}数据分析中心{% endif %}
                        </a></li>
                        <li><a class="dropdown-item text-light" href="{{ url_for('admin.login_records') }}" style="border-radius: 10px; margin: 4px;">
                            <i class="bi bi-file-text me-2 text-info"></i> 
                            {% if current_lang == 'en' %}View Login Records{% else %}查看登录记录{% endif %}
                        </a></li>
                        <li><a class="dropdown-item text-light" href="/performance-monitor" style="border-radius: 10px; margin: 4px;">
                            <i class="bi bi-speedometer2 me-2 text-success"></i> 
                            {% if current_lang == 'en' %}Performance Monitor{% else %}性能监控{% endif %}
                        </a></li>
                        {% endif %}
                        
                        <!-- 拥有者和管理员可以管理用户访问权限 -->
                        {% if session.role in ['owner', 'admin'] %}
                        <li><a class="dropdown-item text-light" href="{{ url_for('admin.user_access') }}" style="border-radius: 10px; margin: 4px;">
                            <i class="bi bi-people me-2 text-primary"></i> 
                            {% if current_lang == 'en' %}User Access Management{% else %}用户访问管理{% endif %}
                        </a></li>
                        
                        <!-- CRM系统入口 - React CRM -->
                        {% if user_has_crm_access() %}
                        <li>
                            <a class="dropdown-item text-light" href="/crm/" style="border-radius: 10px; margin: 4px;">
                                <i class="bi bi-people-fill me-2 text-danger"></i> 
                                {% if current_lang == 'en' %}Customer Relationship Management{% else %}客户关系管理系统{% endif %}
                            </a>
                        </li>
                        {% endif %}
                        {% endif %}
                        
                        <!-- 显示当前用户角色 -->
                        <li><hr class="dropdown-divider border-warning"></li>
                        <li><span class="dropdown-item-text text-light">
                            <i class="bi bi-person-badge me-2 text-warning"></i> 
                            {% if current_lang == 'en' %}Role: {% else %}角色: {% endif %}
                            {% if session.role == 'owner' %}
                                <span class="badge bg-danger">{{ t('owner') }}</span>
                            {% elif session.role == 'admin' %}
                                <span class="badge bg-warning">{{ t('admin') }}</span>
                            {% elif session.role in ['mining_site', 'mining_site_owner'] %}
                                <span class="badge bg-info">{{ t('mining_site_owner') }}</span>
                            {% else %}
                                <span class="badge bg-primary">{{ t('customer') }}</span>
                            {% endif %}
                        </span></li>
                    {% endif %}
                    
                    <li><hr class="dropdown-divider border-warning"></li>
                    <li><a class="dropdown-item text-light" href="{{ url_for('auth.logout') }}" style="border-radius: 10px; margin: 4px;">
                        <i class="bi bi-box-arrow-right me-2 text-secondary"></i>
                        {% if current_lang == 'en' %}Logout{% else %}退出登录{% endif %}
                    </a></li>
                {% else %}
                    <li><a class="dropdown-item text-light" href="{{ url_for('auth.login') }}" style="border-radius: 10px; margin: 4px;">
                        <i class="bi bi-box-arrow-in-right me-2 text-success"></i>
                        {% if current_lang == 'en' %}Login{% else %}登录{% endif %}
                    </a></li>
                {% endif %}
            </ul>
        </div>
    </div>

    <!-- Hero Section -->
    <div class="dashboard-hero">
        <h1 class="dashboard-title" data-i18n="dashboard_title">
            {% if current_lang == 'en' %}Bitcoin Mining Intelligence{% else %}Bitcoin挖矿智能平台{% endif %}
        </h1>
        <p class="dashboard-subtitle" data-i18n="dashboard_subtitle">
            {% if current_lang == 'en' %}
                Advanced analytics and treasury management for institutional Bitcoin mining operations
            {% else %}
                为机构级Bitcoin挖矿运营提供高级分析和资金管理
            {% endif %}
        </p>
        
        <!-- Real-time Stats Bar -->
        <div class="stats-bar">
            <div class="stat-item">
                <span class="stat-value" id="btc-price">${{ "{:,}".format(btc_price) }}</span>
                <span class="stat-label" data-i18n="btc_price">
                    {% if current_lang == 'en' %}BTC Price{% else %}BTC价格{% endif %}
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="network-hashrate">{{ network_hashrate }}</span>
                <span class="stat-label" data-i18n="network_hashrate">
                    {% if current_lang == 'en' %}Network Hashrate{% else %}全网算力{% endif %}
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="active-users">{{ session.get('total_users', '12') }}</span>
                <span class="stat-label" data-i18n="active_users">
                    {% if current_lang == 'en' %}Active Users{% else %}活跃用户{% endif %}
                </span>
            </div>
            <div class="stat-item">
                <span class="stat-value" id="system-status">Online</span>
                <span class="stat-label" data-i18n="system_status">
                    {% if current_lang == 'en' %}System Status{% else %}系统状态{% endif %}
                </span>
            </div>
        </div>
    </div>

    <!-- 功能卡片网格 -->
    <div class="dashboard-grid">
        <!-- 挖矿计算器 -->
        <div class="dashboard-card calculator-item" onclick="location.href='{{ url_for('calculator.calculator') }}'">
            <div class="card-stats">Core Tool</div>
            <div class="card-content">
                <i class="bi bi-calculator card-icon"></i>
                <h3 class="card-title" data-i18n="mining_calculator">
                    {% if current_lang == 'en' %}Mining Calculator{% else %}挖矿计算器{% endif %}
                </h3>
                <p class="card-description" data-i18n="mining_calculator_desc">
                    {% if current_lang == 'en' %}Real-time profitability analysis with 42+ ASIC miners and live market data{% else %}支持42+款ASIC矿机的实时收益分析{% endif %}
                </p>
            </div>
        </div>

        <!-- 批量计算器 -->
        <div class="dashboard-card batch-item" onclick="location.href='/batch-calculator'">
            <div class="card-stats">Pro Tool</div>
            <div class="card-content">
                <i class="bi bi-table card-icon"></i>
                <h3 class="card-title" data-i18n="batch_calculator">
                    {% if current_lang == 'en' %}Batch Calculator{% else %}批量计算器{% endif %}
                </h3>
                <p class="card-description" data-i18n="batch_calculator_desc">
                    {% if current_lang == 'en' %}Enterprise-grade bulk analysis for large-scale mining operations{% else %}大规模挖矿运营的企业级批量分析{% endif %}
                </p>
            </div>
        </div>

        <!-- 客户管理 - React CRM -->
        {% if user_has_crm_access() %}
        <div class="dashboard-card customer-item" onclick="location.href='/crm/'">
            <div class="card-stats">CRM</div>
            <div class="card-content">
                <i class="bi bi-people card-icon"></i>
                <h3 class="card-title" data-i18n="customer_management">
                    {% if current_lang == 'en' %}Customer Management{% else %}客户管理{% endif %}
                </h3>
                <p class="card-description" data-i18n="customer_management_desc">
                    {% if current_lang == 'en' %}Full-featured CRM with lead tracking, deal management, and automated workflows{% else %}全功能CRM，包含客户跟踪、交易管理和自动化流程{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- 分析平台 -->
        {% if user_has_analytics_access() %}
        <div class="dashboard-card analytics-item" onclick="location.href='{{ url_for('analytics_dashboard') }}'">
            <div class="card-stats">AI-Powered</div>
            <div class="card-content">
                <i class="bi bi-graph-up-arrow card-icon"></i>
                <h3 class="card-title" data-i18n="analytics_platform">
                    {% if current_lang == 'en' %}Analytics Platform{% else %}分析平台{% endif %}
                </h3>
                <p class="card-description" data-i18n="analytics_platform_desc">
                    {% if current_lang == 'en' %}Advanced treasury management with 10-module AI trading algorithms and institutional-grade backtesting{% else %}高级资金管理，配备10模块AI交易算法和机构级回测{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- 托管管理 -->
        {% if session.role in ['owner', 'admin', 'mining_site', 'mining_site_owner'] %}
        <div class="dashboard-card hosting-item" onclick="location.href='{{ url_for('hosting_service_bp.dashboard') }}'">
            <div class="card-stats">Professional</div>
            <div class="card-content">
                <i class="bi bi-building card-icon"></i>
                <h3 class="card-title" data-i18n="hosting_management">
                    {% if current_lang == 'en' %}Hosting Management{% else %}托管管理{% endif %}
                </h3>
                <p class="card-description" data-i18n="hosting_management_desc">
                    {% if current_lang == 'en' %}Comprehensive hosting platform with client management, device monitoring, and transparent reporting{% else %}全面的托管平台，包含客户管理、设备监控和透明报告{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- 白标品牌配置 -->
        {% if session.role in ['owner', 'admin', 'mining_site', 'mining_site_owner'] %}
        <div class="dashboard-card branding-item" onclick="location.href='/branding'">
            <div class="card-stats">Branding</div>
            <div class="card-content">
                <i class="bi bi-brush card-icon" style="color: #9b59b6;"></i>
                <h3 class="card-title" data-i18n="white_label_branding">
                    {% if current_lang == 'en' %}White Label Branding{% else %}白标品牌配置{% endif %}
                </h3>
                <p class="card-description" data-i18n="white_label_desc">
                    {% if current_lang == 'en' %}Customize your platform with your own logo, colors, and branding{% else %}自定义平台Logo、颜色和品牌元素{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- CRM客户管理 -->
        {% if session.role in ['owner', 'admin', 'mining_site', 'mining_site_owner'] %}
        <div class="dashboard-card crm-item" onclick="location.href='/crm/'">
            <div class="card-stats">CRM</div>
            <div class="card-content">
                <i class="bi bi-people card-icon" style="color: #3498db;"></i>
                <h3 class="card-title" data-i18n="crm">
                    {% if current_lang == 'en' %}CRM{% else %}客户管理{% endif %}
                </h3>
                <p class="card-description" data-i18n="crm_desc">
                    {% if current_lang == 'en' %}Complete customer relationship management with lead tracking, deal pipeline, and commission calculation{% else %}完整的客户关系管理，包含线索跟踪、交易管道和佣金计算{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- 用户管理 (管理员功能) -->
        {% if session.role in ['owner', 'admin'] %}
        <div class="dashboard-card user-item" onclick="location.href='{{ url_for('admin.user_access') }}'">
            <div class="card-stats">Admin</div>
            <div class="card-content">
                <i class="bi bi-person-gear card-icon"></i>
                <h3 class="card-title" data-i18n="user_management">
                    {% if current_lang == 'en' %}User Management{% else %}用户管理{% endif %}
                </h3>
                <p class="card-description" data-i18n="user_management_desc">
                    {% if current_lang == 'en' %}Role-based access control with advanced security and audit logging{% else %}基于角色的访问控制，具备高级安全和审计日志{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- 性能监控 -->
        {% if session.role in ['owner', 'admin'] %}
        <div class="dashboard-card performance-item" onclick="location.href='/performance-monitor'">
            <div class="card-stats">System</div>
            <div class="card-content">
                <i class="bi bi-speedometer2 card-icon"></i>
                <h3 class="card-title" data-i18n="performance_monitoring">
                    {% if current_lang == 'en' %}Performance Monitoring{% else %}性能监控{% endif %}
                </h3>
                <p class="card-description" data-i18n="performance_monitoring_desc">
                    {% if current_lang == 'en' %}Real-time system monitoring with advanced metrics and alerting capabilities{% else %}实时系统监控，具备高级指标和警报功能{% endif %}
                </p>
            </div>
        </div>
        {% endif %}

        <!-- Owner专用功能区域 -->
        {% if session.role == 'owner' %}
        
        <!-- Web3 Dashboard -->
        <div class="dashboard-card web3-item" onclick="location.href='{{ url_for('web3_dashboard') }}'">
            <div class="card-stats">Web3</div>
            <div class="card-content">
                <i class="bi bi-grid-3x3-gap card-icon" style="color: #00d4ff;"></i>
                <h3 class="card-title" data-i18n="web3_dashboard">
                    {% if current_lang == 'en' %}Web3 Dashboard{% else %}Web3控制台{% endif %}
                </h3>
                <p class="card-description" data-i18n="web3_dashboard_desc">
                    {% if current_lang == 'en' %}Blockchain verification, NFT management, and cryptocurrency payment systems{% else %}区块链验证、NFT管理和加密货币支付系统{% endif %}
                </p>
            </div>
        </div>

        <!-- 系统配置中心 -->
        <div class="dashboard-card config-item" onclick="location.href='/system-config'">
            <div class="card-stats">System</div>
            <div class="card-content">
                <i class="bi bi-gear-wide-connected card-icon" style="color: #17a2b8;"></i>
                <h3 class="card-title">
                    {% if current_lang == 'en' %}System Configuration{% else %}系统配置中心{% endif %}
                </h3>
                <p class="card-description">
                    {% if current_lang == 'en' %}Advanced system settings, environment variables, and platform configuration{% else %}高级系统设置、环境变量和平台配置管理{% endif %}
                </p>
            </div>
        </div>

        <!-- 数据库管理 -->
        <div class="dashboard-card database-item" onclick="location.href='/database-admin'">
            <div class="card-stats">Database</div>
            <div class="card-content">
                <i class="bi bi-server card-icon" style="color: #28a745;"></i>
                <h3 class="card-title">
                    {% if current_lang == 'en' %}Database Management{% else %}数据库管理{% endif %}
                </h3>
                <p class="card-description">
                    {% if current_lang == 'en' %}Database monitoring, backup, optimization, and schema management{% else %}数据库监控、备份、优化和结构管理{% endif %}
                </p>
            </div>
        </div>

        <!-- API集成管理 -->
        <div class="dashboard-card api-item" onclick="location.href='/api-management'">
            <div class="card-stats">Integration</div>
            <div class="card-content">
                <i class="bi bi-diagram-3 card-icon" style="color: #6f42c1;"></i>
                <h3 class="card-title">
                    {% if current_lang == 'en' %}API & Integrations{% else %}API集成管理{% endif %}
                </h3>
                <p class="card-description">
                    {% if current_lang == 'en' %}External API management, webhook configuration, and third-party integrations{% else %}外部API管理、Webhook配置和第三方集成{% endif %}
                </p>
            </div>
        </div>

        <!-- 安全中心 -->
        <div class="dashboard-card security-item" onclick="location.href='/security-center'">
            <div class="card-stats">Security</div>
            <div class="card-content">
                <i class="bi bi-shield-check card-icon" style="color: #dc3545;"></i>
                <h3 class="card-title">
                    {% if current_lang == 'en' %}Security Center{% else %}安全中心{% endif %}
                </h3>
                <p class="card-description">
                    {% if current_lang == 'en' %}Access logs, security alerts, audit trails, and encryption management{% else %}访问日志、安全警报、审计轨迹和加密管理{% endif %}
                </p>
            </div>
        </div>

        <!-- 备份恢复 -->
        <div class="dashboard-card backup-item" onclick="location.href='/backup-recovery'">
            <div class="card-stats">Backup</div>
            <div class="card-content">
                <i class="bi bi-cloud-upload card-icon" style="color: #fd7e14;"></i>
                <h3 class="card-title">
                    {% if current_lang == 'en' %}Backup & Recovery{% else %}备份恢复{% endif %}
                </h3>
                <p class="card-description">
                    {% if current_lang == 'en' %}Automated backups, system snapshots, and disaster recovery management{% else %}自动备份、系统快照和灾难恢复管理{% endif %}
                </p>
            </div>
        </div>

        {% endif %}

        <!-- SLA NFT证书管理 -->
        {% if session.email %}
        <div class="dashboard-card sla-nft-item" onclick="openSLANFTModal()">
            <div class="card-stats">Blockchain</div>
            <div class="sla-nft-badge" id="sla-nft-count">Loading...</div>
            <div class="card-content">
                <i class="bi bi-award card-icon" style="color: #9b59b6;"></i>
                <h3 class="card-title" data-i18n="sla_nft_certificates">
                    {% if current_lang == 'en' %}SLA NFT Certificates{% else %}SLA NFT证书{% endif %}
                </h3>
                <p class="card-description">
                    <span class="sla-status-indicator sla-status-excellent" id="sla-status-indicator"></span>
                    <span data-i18n="sla_nft_desc">{% if current_lang == 'en' %}Blockchain-verified service level agreement certificates and monthly performance reports{% else %}区块链验证的服务等级协议证书和月度性能报告{% endif %}</span>
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Enhanced dashboard interactions and real-time updates
document.addEventListener('DOMContentLoaded', function() {
    const cards = document.querySelectorAll('.dashboard-card');

    // Enhanced card interactions
    cards.forEach((card, index) => {
        // Add ripple effect on click
        card.addEventListener('click', function(e) {
            const ripple = document.createElement('div');
            const rect = this.getBoundingClientRect();
            const size = Math.max(rect.width, rect.height);
            
            ripple.style.width = ripple.style.height = size + 'px';
            ripple.style.left = (e.clientX - rect.left - size / 2) + 'px';
            ripple.style.top = (e.clientY - rect.top - size / 2) + 'px';
            ripple.style.position = 'absolute';
            ripple.style.borderRadius = '50%';
            ripple.style.background = 'rgba(255, 193, 7, 0.3)';
            ripple.style.transform = 'scale(0)';
            ripple.style.animation = 'ripple 0.6s linear';
            ripple.style.pointerEvents = 'none';
            
            this.appendChild(ripple);
            
            setTimeout(() => {
                ripple.remove();
            }, 600);
        });

        // Enhanced hover effects
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-12px) scale(1.02)';
        });

        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0) scale(1)';
        });

        // Staggered animation on load
        setTimeout(() => {
            card.style.opacity = '1';
            card.style.transform = 'translateY(0)';
        }, 100 + (index * 150));
    });

    // Real-time data updates
    updateRealTimeStats();
    updateSLANFTStatus();
    setInterval(updateRealTimeStats, 30000); // Update every 30 seconds
    setInterval(updateSLANFTStatus, 60000); // Update SLA status every minute
});

// Real-time statistics updates
async function updateRealTimeStats() {
    try {
        // Update BTC price and network stats
        const response = await fetch('/api/analytics/market-data');
        const data = await response.json();
        
        if (data.success) {
            const btcPrice = document.getElementById('btc-price');
            const networkHashrate = document.getElementById('network-hashrate');
            
            if (btcPrice && data.data.btc_price) {
                btcPrice.textContent = '$' + data.data.btc_price.toLocaleString();
                animateValue(btcPrice);
            }
            
            if (networkHashrate && data.data.network_hashrate) {
                networkHashrate.textContent = data.data.network_hashrate.toFixed(2) + ' EH/s';
                animateValue(networkHashrate);
            }
        }
    } catch (error) {
        console.log('Stats update failed:', error);
    }
}

// Animate value changes
function animateValue(element) {
    element.style.transform = 'scale(1.1)';
    element.style.color = 'var(--primary-gold)';
    
    setTimeout(() => {
        element.style.transform = 'scale(1)';
        element.style.color = '';
    }, 300);
}

// SLA NFT Modal and Management Functions
function openSLANFTModal() {
    // Create and show SLA NFT modal
    const modal = createSLANFTModal();
    document.body.appendChild(modal);
    
    // Initialize modal with Bootstrap
    const bsModal = new bootstrap.Modal(modal);
    bsModal.show();
    
    // Load SLA NFT data
    loadSLANFTData();
    
    // Clean up when modal is hidden
    modal.addEventListener('hidden.bs.modal', function () {
        modal.remove();
    });
}

function createSLANFTModal() {
    const modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'slaNFTModal';
    modal.setAttribute('tabindex', '-1');
    
    const currentLang = document.documentElement.lang === 'zh-CN' ? 'zh' : 'en';
    
    modal.innerHTML = `
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content" style="background: rgba(26, 26, 46, 0.95); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 20px;">
                <div class="modal-header border-bottom border-warning">
                    <h5 class="modal-title text-warning">
                        <i class="bi bi-award me-2"></i>
                        ${currentLang === 'en' ? 'SLA NFT Certificates' : 'SLA NFT证书管理'}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- SLA Status Overview -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-dark border-success">
                                <div class="card-body text-center">
                                    <h6 class="text-success">${currentLang === 'en' ? 'Current SLA Status' : '当前SLA状态'}</h6>
                                    <div class="display-6 text-success" id="current-sla-score">Loading...</div>
                                    <small class="text-muted" id="current-sla-status">Loading...</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark border-info">
                                <div class="card-body text-center">
                                    <h6 class="text-info">${currentLang === 'en' ? 'Total Certificates' : '证书总数'}</h6>
                                    <div class="display-6 text-info" id="total-certificates">Loading...</div>
                                    <small class="text-muted">${currentLang === 'en' ? 'Blockchain Verified' : '区块链验证'}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Certificates List -->
                    <div class="mb-3">
                        <h6 class="text-warning">${currentLang === 'en' ? 'Certificate History' : '证书历史'}</h6>
                        <div id="certificates-list" class="mt-3">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Monthly Reports -->
                    <div>
                        <h6 class="text-warning">${currentLang === 'en' ? 'Monthly Reports' : '月度报告'}</h6>
                        <div id="monthly-reports-list" class="mt-3">
                            <div class="text-center">
                                <div class="spinner-border text-warning" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top border-warning">
                    <button type="button" class="btn btn-outline-warning" onclick="refreshSLAData()">
                        <i class="bi bi-arrow-clockwise me-2"></i>
                        ${currentLang === 'en' ? 'Refresh' : '刷新'}
                    </button>
                    <button type="button" class="btn btn-warning" onclick="requestNewCertificate()">
                        <i class="bi bi-plus-circle me-2"></i>
                        ${currentLang === 'en' ? 'Request Certificate' : '申请证书'}
                    </button>
                </div>
            </div>
        </div>
    `;
    
    return modal;
}

async function loadSLANFTData() {
    try {
        // Load SLA status
        const statusResponse = await fetch('/api/sla/status');
        const statusData = await statusResponse.json();
        
        if (statusData.success) {
            updateSLAStatusDisplay(statusData.data);
        }
        
        // Load certificates
        const certResponse = await fetch('/api/sla/certificates');
        const certData = await certResponse.json();
        
        if (certData.success) {
            displayCertificates(certData.data.certificates);
        }
        
        // Load monthly reports
        const reportsResponse = await fetch('/api/sla/reports');
        const reportsData = await reportsResponse.json();
        
        if (reportsData.success) {
            displayMonthlyReports(reportsData.data.reports);
        }
        
    } catch (error) {
        console.error('Failed to load SLA NFT data:', error);
        showErrorMessage('Failed to load SLA data');
    }
}

function updateSLAStatusDisplay(data) {
    const scoreElement = document.getElementById('current-sla-score');
    const statusElement = document.getElementById('current-sla-status');
    const totalElement = document.getElementById('total-certificates');
    
    if (scoreElement && data.current_status.latest_sla_score) {
        scoreElement.textContent = data.current_status.latest_sla_score.toFixed(1) + '%';
    }
    
    if (statusElement && data.current_status.latest_sla_status) {
        statusElement.textContent = data.current_status.latest_sla_status;
    }
    
    if (totalElement && data.statistics.total_certificates) {
        totalElement.textContent = data.statistics.total_certificates;
    }
}

function displayCertificates(certificates) {
    const container = document.getElementById('certificates-list');
    const currentLang = document.documentElement.lang === 'zh-CN' ? 'zh' : 'en';
    
    if (!certificates || certificates.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-inbox display-4 d-block mb-2"></i>
                ${currentLang === 'en' ? 'No certificates found' : '未找到证书'}
            </div>
        `;
        return;
    }
    
    container.innerHTML = certificates.map(cert => {
        const statusClass = getStatusClass(cert.mint_status);
        const year = Math.floor(cert.month_year / 100);
        const month = cert.month_year % 100;
        const monthName = getMonthName(month, currentLang);
        
        return `
            <div class="card bg-dark border-secondary mb-2">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-3">
                            <strong class="text-light">${monthName} ${year}</strong>
                        </div>
                        <div class="col-md-3">
                            <span class="badge ${statusClass}">${cert.mint_status}</span>
                        </div>
                        <div class="col-md-3">
                            ${cert.sla_metrics ? 
                                `<span class="text-success">${cert.sla_metrics.composite_sla_score}%</span>` : 
                                '<span class="text-muted">N/A</span>'
                            }
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-sm btn-outline-info" onclick="viewCertificateDetails('${cert.id}')">
                                <i class="bi bi-eye"></i>
                            </button>
                            ${cert.mint_status === 'MINTED' ? 
                                `<button class="btn btn-sm btn-outline-success ms-1" onclick="verifyCertificate('${cert.id}')">
                                    <i class="bi bi-shield-check"></i>
                                </button>` : 
                                ''
                            }
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function displayMonthlyReports(reports) {
    const container = document.getElementById('monthly-reports-list');
    const currentLang = document.documentElement.lang === 'zh-CN' ? 'zh' : 'en';
    
    if (!reports || reports.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-3">
                <i class="bi bi-file-earmark-text display-4 d-block mb-2"></i>
                ${currentLang === 'en' ? 'No reports available' : '暂无报告'}
            </div>
        `;
        return;
    }
    
    container.innerHTML = reports.map(report => {
        return `
            <div class="card bg-dark border-secondary mb-2">
                <div class="card-body py-2">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <strong class="text-light">${report.display_name}</strong>
                        </div>
                        <div class="col-md-3">
                            <span class="text-info">${report.average_sla_score.toFixed(1)}%</span>
                        </div>
                        <div class="col-md-2">
                            <span class="badge ${report.audit_status === 'audited' ? 'bg-success' : 'bg-warning'}">${report.audit_status}</span>
                        </div>
                        <div class="col-md-3 text-end">
                            <button class="btn btn-sm btn-outline-warning" onclick="downloadReport('${report.month_year}')">
                                <i class="bi bi-download"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Update SLA NFT status on dashboard
async function updateSLANFTStatus() {
    try {
        const response = await fetch('/api/sla/status');
        const data = await response.json();
        
        if (data.success) {
            // Update NFT count badge
            const countBadge = document.getElementById('sla-nft-count');
            if (countBadge) {
                countBadge.textContent = `${data.data.statistics.total_certificates} NFTs`;
            }
            
            // Update status indicator
            const statusIndicator = document.getElementById('sla-status-indicator');
            if (statusIndicator && data.data.current_status.latest_sla_status) {
                const status = data.data.current_status.latest_sla_status.toLowerCase();
                statusIndicator.className = `sla-status-indicator sla-status-${status}`;
            }
        }
    } catch (error) {
        console.log('SLA status update failed:', error);
    }
}

// Helper functions
function getStatusClass(status) {
    const statusMap = {
        'PENDING': 'bg-warning',
        'MINTING': 'bg-info',
        'MINTED': 'bg-success',
        'FAILED': 'bg-danger',
        'VERIFIED': 'bg-primary'
    };
    return statusMap[status] || 'bg-secondary';
}

function getMonthName(month, lang) {
    const monthsEn = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    const monthsZh = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
    return lang === 'zh' ? monthsZh[month - 1] : monthsEn[month - 1];
}

function showErrorMessage(message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'toast align-items-center text-white bg-danger border-0 position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 11000;';
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    setTimeout(() => toast.remove(), 5000);
}

// Placeholder functions for future implementation
function refreshSLAData() {
    loadSLANFTData();
}

function requestNewCertificate() {
    alert('Certificate request functionality coming soon!');
}

function viewCertificateDetails(certId) {
    alert(`Certificate details for ID: ${certId} - Coming soon!`);
}

function verifyCertificate(certId) {
    alert(`Certificate verification for ID: ${certId} - Coming soon!`);
}

function downloadReport(monthYear) {
    window.open(`/api/sla/reports/${monthYear}`, '_blank');
}

// Add ripple animation keyframes
const style = document.createElement('style');
style.textContent = `
@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}
`;
document.head.appendChild(style);
</script>
{% endblock %}