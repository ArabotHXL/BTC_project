{% extends "base.html" %}
{% block title %}
{{ site.name }} - {% if lang == 'zh' %}密钥管理{% else %}Key Management{% endif %}
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a href="{{ url_for('collector_routes.index') }}" class="text-warning">
                    {% if lang == 'zh' %}采集器监控{% else %}Collector Monitor{% endif %}
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{{ url_for('collector_routes.site_detail', site_id=site.id) }}" class="text-warning">
                    {{ site.name }}
                </a>
            </li>
            <li class="breadcrumb-item active text-muted">{% if lang == 'zh' %}密钥管理{% else %}Key Management{% endif %}</li>
        </ol>
    </nav>

    <div class="row mb-4">
        <div class="col">
            <h2 class="text-warning mb-0">
                <i class="bi bi-key me-2"></i>
                {% if lang == 'zh' %}采集器密钥管理{% else %}Collector Key Management{% endif %}
            </h2>
            <p class="text-muted">{{ site.name }} - {{ site.location }}</p>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ 'success' if category == 'success' else 'danger' }} alert-dismissible fade show">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <div class="col-lg-8">
            <div class="card bg-dark border-secondary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="bi bi-list-ul me-2"></i>
                        {% if lang == 'zh' %}密钥列表{% else %}Key List{% endif %}
                    </h5>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#createKeyModal">
                        <i class="bi bi-plus me-1"></i>
                        {% if lang == 'zh' %}创建新密钥{% else %}Create New Key{% endif %}
                    </button>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-dark table-hover mb-0">
                            <thead>
                                <tr class="text-muted">
                                    <th>{% if lang == 'zh' %}名称{% else %}Name{% endif %}</th>
                                    <th>{% if lang == 'zh' %}状态{% else %}Status{% endif %}</th>
                                    <th>{% if lang == 'zh' %}创建时间{% else %}Created{% endif %}</th>
                                    <th>{% if lang == 'zh' %}最后使用{% else %}Last Used{% endif %}</th>
                                    <th>{% if lang == 'zh' %}操作{% else %}Actions{% endif %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for key in keys %}
                                <tr>
                                    <td class="fw-bold">
                                        <i class="bi bi-key me-2 text-warning"></i>
                                        {{ key.name }}
                                    </td>
                                    <td>
                                        {% if key.is_active %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle me-1"></i>
                                            {% if lang == 'zh' %}启用{% else %}Active{% endif %}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-secondary">
                                            <i class="bi bi-x-circle me-1"></i>
                                            {% if lang == 'zh' %}禁用{% else %}Disabled{% endif %}
                                        </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-muted">
                                        {{ key.created_at.strftime('%Y-%m-%d %H:%M') }}
                                    </td>
                                    <td class="text-muted">
                                        {% if key.last_used_at %}
                                        {{ key.last_used_at.strftime('%Y-%m-%d %H:%M') }}
                                        {% else %}
                                        <span class="text-warning">{% if lang == 'zh' %}从未使用{% else %}Never{% endif %}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <form method="post" class="d-inline">
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <input type="hidden" name="action" value="toggle">
                                            <button type="submit" class="btn btn-sm {% if key.is_active %}btn-outline-warning{% else %}btn-outline-success{% endif %}">
                                                {% if key.is_active %}
                                                <i class="bi bi-pause"></i>
                                                {% else %}
                                                <i class="bi bi-play"></i>
                                                {% endif %}
                                            </button>
                                        </form>
                                        <form method="post" class="d-inline" onsubmit="return confirm('{% if lang == 'zh' %}确定要删除此密钥吗？{% else %}Are you sure you want to delete this key?{% endif %}')">
                                            <input type="hidden" name="key_id" value="{{ key.id }}">
                                            <input type="hidden" name="action" value="delete">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-5">
                                        <i class="bi bi-key display-4 d-block mb-3"></i>
                                        {% if lang == 'zh' %}暂无采集器密钥，点击上方按钮创建{% else %}No collector keys. Click the button above to create one.{% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-dark border-secondary mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        {% if lang == 'zh' %}使用说明{% else %}Usage Guide{% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <ol class="ps-3 mb-0">
                        <li class="mb-2">
                            {% if lang == 'zh' %}创建新的采集器密钥{% else %}Create a new collector key{% endif %}
                        </li>
                        <li class="mb-2">
                            {% if lang == 'zh' %}复制密钥到采集器配置文件{% else %}Copy the key to collector config{% endif %}
                        </li>
                        <li class="mb-2">
                            {% if lang == 'zh' %}在矿场服务器启动采集器{% else %}Start the collector on farm server{% endif %}
                        </li>
                        <li class="mb-0">
                            {% if lang == 'zh' %}在监控页面查看实时数据{% else %}View live data on monitor page{% endif %}
                        </li>
                    </ol>
                </div>
            </div>

            <div class="card bg-dark border-secondary">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        {% if lang == 'zh' %}安全提示{% else %}Security Tips{% endif %}
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="ps-3 mb-0 text-muted small">
                        <li class="mb-2">
                            {% if lang == 'zh' %}密钥只在创建时显示一次{% else %}Keys are shown only once when created{% endif %}
                        </li>
                        <li class="mb-2">
                            {% if lang == 'zh' %}请妥善保管密钥，切勿泄露{% else %}Keep your keys safe and secure{% endif %}
                        </li>
                        <li class="mb-2">
                            {% if lang == 'zh' %}定期轮换密钥以提高安全性{% else %}Rotate keys periodically for security{% endif %}
                        </li>
                        <li class="mb-0">
                            {% if lang == 'zh' %}禁用不再使用的密钥{% else %}Disable keys that are no longer in use{% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createKeyModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <form method="post">
                <input type="hidden" name="action" value="create">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title text-warning">
                        <i class="bi bi-plus-circle me-2"></i>
                        {% if lang == 'zh' %}创建采集器密钥{% else %}Create Collector Key{% endif %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">{% if lang == 'zh' %}密钥名称{% else %}Key Name{% endif %}</label>
                        <input type="text" name="name" class="form-control bg-black text-white border-secondary" 
                               placeholder="{% if lang == 'zh' %}例如: 机房1号采集器{% else %}e.g. Building 1 Collector{% endif %}" required>
                    </div>
                    <div class="alert alert-warning mb-0">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        {% if lang == 'zh' %}密钥创建后仅显示一次，请立即复制保存！{% else %}The key will only be shown once. Copy it immediately!{% endif %}
                    </div>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        {% if lang == 'zh' %}取消{% else %}Cancel{% endif %}
                    </button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check me-1"></i>
                        {% if lang == 'zh' %}创建{% else %}Create{% endif %}
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
