# 矿机批量导入功能 - 完整使用教程 📚

## 📍 功能入口

**访问地址：** `https://你的域名/api/miners/page`

**前置条件：** 需要先登录系统（会自动跳转到登录页）

---

## 🎯 功能概览

矿机批量导入模块支持通过 CSV/Excel 文件一次性导入成百上千台矿机设备，具备智能去重、数据验证、错误报告等企业级功能。

### ✨ 核心特性

- ✅ **多格式支持**：CSV、Excel (xlsx/xls)
- ✅ **智能去重**：三种冲突处理策略
- ✅ **数据验证**：IP地址格式自动校验
- ✅ **错误报告**：失败记录可下载 CSV
- ✅ **实时预览**：导入后立即查看结果
- ✅ **双语界面**：中文/英文自动切换

---

## 📋 第一步：下载 CSV 模板

### 方法1：网页下载

1. 进入矿机导入页面
2. 点击 **"下载CSV模板"** 按钮
3. 选择模板类型：
   - **带示例数据**：包含3条示例矿机（推荐新手）
   - **仅表头**：空白模板（适合批量填写）

### 方法2：手动创建

创建一个 `miners.csv` 文件，包含以下列：

```csv
miner_id,model,ip,port,api,username,password,note
S21-192.168.1.45,Antminer S21,192.168.1.45,4028,bmminer,root,,Rack A-03
M50-192.168.1.55,Whatsminer M50,192.168.1.55,22333,http,admin,,Rack B-02
```

### 📝 字段说明

| 字段名 | 必填 | 说明 | 示例 |
|--------|------|------|------|
| `miner_id` | ✅ | 矿机唯一标识 | `S21-192.168.1.45` |
| `model` | ❌ | 矿机型号 | `Antminer S21` |
| `ip` | ✅ | IP地址（IPv4格式） | `192.168.1.45` |
| `port` | ❌ | 端口号 | `4028` |
| `api` | ❌ | API类型 | `bmminer`, `http` |
| `username` | ❌ | 登录用户名 | `root`, `admin` |
| `password` | ❌ | 登录密码（不推荐明文） | 留空 |
| `note` | ❌ | 备注信息 | `Rack A-03 Top` |

---

## 📤 第二步：准备导入数据

### 示例数据文件

已为你创建测试文件 **`test_miners_import.csv`**，包含10台矿机：

```csv
miner_id,model,ip,port,api,username,password,note
S21-192.168.1.45,Antminer S21,192.168.1.45,4028,bmminer,root,,Rack A-03 Top
M50-192.168.1.55,Whatsminer M50,192.168.1.55,22333,http,admin,,Rack B-02 Middle
S19Pro-192.168.1.60,Antminer S19 Pro,192.168.1.60,4028,bmminer,root,,Rack A-05 Bottom
M30S-192.168.1.75,Whatsminer M30S+,192.168.1.75,22333,http,admin,,Rack C-01 Top
S21-192.168.1.80,Antminer S21,192.168.1.80,4028,bmminer,root,,Rack A-10 Middle
T21-192.168.1.90,Antminer T21,192.168.1.90,4028,bmminer,root,,Rack D-03 Bottom
M50S-192.168.1.100,Whatsminer M50S,192.168.1.100,22333,http,admin,,Rack B-08 Top
S19XP-192.168.1.110,Antminer S19 XP,192.168.1.110,4028,bmminer,root,,Rack E-02 Middle
M60-192.168.1.120,Whatsminer M60,192.168.1.120,22333,http,admin,,Rack C-05 Top
S21Pro-192.168.1.130,Antminer S21 Pro,192.168.1.130,4028,bmminer,root,,Rack A-15 Bottom
```

### ⚠️ 注意事项

- **IP地址必须唯一**：同一站点不能有重复IP
- **miner_id必须唯一**：用于后续去重判断
- **IP格式验证**：只支持IPv4（如 `192.168.1.1`）
- **编码格式**：推荐使用 UTF-8 编码

---

## 🚀 第三步：执行批量导入

### 操作流程

1. **进入导入页面**
   - 访问 `/api/miners/page`
   - 确认已登录状态

2. **选择站点ID**
   - 输入框填写站点标识（如 `SITE001`）
   - 这是必填项，所有矿机将关联到此站点

3. **选择去重策略**

   | 策略 | 说明 | 适用场景 |
   |------|------|----------|
   | **优先导入数据** | 导入数据覆盖已有数据 | 批量更新矿机信息 |
   | **保留已有数据** | 跳过冲突记录，保留原数据 | 增量添加新矿机 |
   | **拒绝冲突** | 冲突记录不导入，记录到错误CSV | 严格去重，避免误覆盖 |

4. **上传文件**
   - **方式1：拖拽上传** - 直接将CSV/Excel文件拖到上传区域
   - **方式2：点击上传** - 点击上传区域，选择本地文件

5. **查看进度**
   - 上传后自动开始处理
   - 进度条显示处理状态
   - 处理完成后显示统计结果

---

## 📊 第四步：查看导入结果

### 统计信息卡片

导入完成后，页面顶部显示4张统计卡片：

```
┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
│ 总记录数    │  │ 新增记录    │  │ 更新记录    │  │ 错误记录    │
│   10        │  │    8        │  │    2        │  │    0        │
└─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘
```

### 数据预览表格

显示前50条导入成功的矿机记录：

| 矿机ID | 型号 | IP地址 | 端口 | API | 备注 |
|--------|------|--------|------|-----|------|
| S21-192.168.1.45 | Antminer S21 | 192.168.1.45 | 4028 | bmminer | Rack A-03 Top |
| M50-192.168.1.55 | Whatsminer M50 | 192.168.1.55 | 22333 | http | Rack B-02 Middle |
| ... | ... | ... | ... | ... | ... |

### 错误报告下载

如果有导入失败的记录：

1. 点击 **"下载错误报告CSV"** 按钮
2. 获得包含错误原因的CSV文件
3. 错误CSV包含额外字段：
   - `row_number`：原文件行号
   - `error_reason`：失败原因（中英双语）

**错误示例：**

```csv
row_number,miner_id,model,ip,port,api,error_reason
5,INVALID-IP,Antminer S21,256.300.1.1,4028,bmminer,"IP地址格式无效 (Invalid IP address format)"
8,DUPLICATE-001,Whatsminer M50,192.168.1.45,22333,http,"IP地址已存在 (IP address already exists)"
```

---

## 🔧 高级功能

### 1. 分页查询矿机

访问 `/api/miners?siteId=SITE001&page=1&pageSize=50`

**参数说明：**
- `siteId`：站点ID（必填）
- `page`：页码（默认1）
- `pageSize`：每页条数（默认50，最大100）

**返回示例：**

```json
{
  "total": 150,
  "page": 1,
  "pageSize": 50,
  "totalPages": 3,
  "miners": [
    {
      "id": 1,
      "miner_id": "S21-192.168.1.45",
      "site_id": "SITE001",
      "model": "Antminer S21",
      "ip": "192.168.1.45",
      "port": "4028",
      "api": "bmminer",
      "note": "Rack A-03 Top",
      "status": "unknown",
      "created_at": "2025-10-05T12:30:15"
    }
  ]
}
```

### 2. 关联矿机到站点

**API接口：** `POST /api/miners/link`

**请求体：**

```json
{
  "miner_ids": ["S21-192.168.1.45", "M50-192.168.1.55"],
  "site_id": "SITE002"
}
```

**应用场景：** 将矿机从一个站点批量迁移到另一个站点

---

## 📚 常见问题 FAQ

### Q1: 支持导入多少台矿机？

**A:** 系统支持单次导入 **5000台** 矿机（受Pandas处理性能优化）。如需导入更多，请分批上传。

### Q2: 如何处理重复IP？

**A:** 系统根据 `site_id + ip + miner_id` 组合判断重复：
- **优先导入数据**：更新已有记录
- **保留已有数据**：跳过，不修改原记录
- **拒绝冲突**：标记为错误，不导入

### Q3: Excel文件支持什么格式？

**A:** 支持 `.xlsx` 和 `.xls` 格式，自动识别编码（UTF-8优先）。

### Q4: IP地址验证规则是什么？

**A:** 只接受IPv4格式，正则验证：
```
^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$
```

示例：
- ✅ `192.168.1.1`
- ✅ `10.0.0.255`
- ❌ `256.1.1.1`（超出范围）
- ❌ `192.168.1`（不完整）

### Q5: 导入任务会保存历史记录吗？

**A:** 是的！每次导入会创建 `MinerImportJob` 记录：
- 导入时间
- 操作用户
- 统计信息（总数/成功/失败）
- 错误CSV路径（30分钟自动清理）

### Q6: 错误CSV文件存放在哪里？

**A:** `/tmp/miner_import_errors_{job_id}.csv`，保留30分钟后自动删除。

---

## 🎨 界面预览

### 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  矿机批量导入 / Miner Batch Import                          │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  站点ID: [_______________]  去重策略: [优先导入数据 ▼]      │
│                                                               │
│  ┌─────────────────────────────────────────────────────┐    │
│  │  📁  拖拽文件到这里 或 点击上传                      │    │
│  │      支持 CSV, XLSX, XLS 格式                       │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  [📥 下载CSV模板]                                            │
│                                                               │
├─────────────────────────────────────────────────────────────┤
│  导入结果                                                     │
│  ┌──────┐  ┌──────┐  ┌──────┐  ┌──────┐                    │
│  │ 总数 │  │ 新增 │  │ 更新 │  │ 错误 │                    │
│  │  10  │  │   8  │  │   2  │  │   0  │                    │
│  └──────┘  └──────┘  └──────┘  └──────┘                    │
│                                                               │
│  数据预览:                                                    │
│  ┌─────────────────────────────────────────────────────┐    │
│  │ 矿机ID │ 型号 │ IP地址 │ 端口 │ API │ 备注         │    │
│  ├─────────────────────────────────────────────────────┤    │
│  │ S21... │ S21  │ 192... │ 4028 │ bmm │ Rack A-03    │    │
│  │ M50... │ M50  │ 192... │ 223  │ http│ Rack B-02    │    │
│  └─────────────────────────────────────────────────────┘    │
│                                                               │
│  [📥 下载错误报告]  [🔄 导入另一个文件]                      │
└─────────────────────────────────────────────────────────────┘
```

### 配色方案

- **主背景**：深色主题 `#2C3E50`（炭灰色）
- **强调色**：金色 `#F39C12`
- **成功色**：绿色 `#27AE60`
- **错误色**：红色 `#E74C3C`
- **卡片背景**：`#34495E`（深灰蓝）

---

## 🛠️ 技术架构

### 后端技术栈

- **框架**：Flask + Blueprint 模块化架构
- **数据处理**：Pandas（CSV/Excel解析）
- **数据库**：PostgreSQL + SQLAlchemy ORM
- **认证**：@login_required 装饰器
- **国际化**：translations.py 双语支持

### 数据库表结构

**Miner 表：**

```sql
CREATE TABLE miner (
    id SERIAL PRIMARY KEY,
    miner_id VARCHAR(255) UNIQUE NOT NULL,
    site_id VARCHAR(255) NOT NULL,
    model VARCHAR(100),
    ip VARCHAR(45) NOT NULL,
    port VARCHAR(10),
    api VARCHAR(50),
    username VARCHAR(100),
    password VARCHAR(256),
    note TEXT,
    status VARCHAR(50) DEFAULT 'unknown',
    source VARCHAR(50) DEFAULT 'import',
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW()
);
```

**MinerImportJob 表：**

```sql
CREATE TABLE miner_import_job (
    id SERIAL PRIMARY KEY,
    job_id UUID UNIQUE NOT NULL,
    user_id INTEGER,
    site_id VARCHAR(255),
    total_rows INTEGER,
    parsed_rows INTEGER,
    invalid_rows INTEGER,
    inserted INTEGER,
    updated INTEGER,
    deduped INTEGER,
    error_csv_path TEXT,
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT NOW(),
    completed_at TIMESTAMP
);
```

---

## 📞 技术支持

如有问题，请检查：

1. **日志文件**：`/tmp/logs/Start_application_*.log`
2. **LSP诊断**：运行 `get_latest_lsp_diagnostics`
3. **数据库查询**：
   ```sql
   -- 查看导入历史
   SELECT * FROM miner_import_job ORDER BY created_at DESC LIMIT 10;
   
   -- 查看矿机列表
   SELECT * FROM miner WHERE site_id = 'SITE001' LIMIT 50;
   ```

---

## ✅ 测试清单

完成以下测试确保功能正常：

- [ ] 访问 `/api/miners/page` 页面正常显示
- [ ] 下载CSV模板（带示例）
- [ ] 下载CSV模板（仅表头）
- [ ] 上传CSV文件成功导入
- [ ] 策略"优先导入数据"正常工作
- [ ] 策略"保留已有数据"正常工作
- [ ] 策略"拒绝冲突"正常工作
- [ ] IP格式验证生效（拒绝无效IP）
- [ ] 错误CSV下载正常
- [ ] 数据预览表格显示正确
- [ ] 分页查询API返回正确
- [ ] 矿机关联API正常工作

---

## 🎉 总结

矿机批量导入功能已完全集成到你的 Flask 应用中！

**核心优势：**
- ✅ 企业级数据处理能力（支持5000+台矿机）
- ✅ 智能去重机制（三种策略灵活应对）
- ✅ 完善的错误处理（详细错误报告）
- ✅ 用户友好界面（拖拽上传 + 实时预览）
- ✅ 双语支持（中文/英文自动切换）

**下一步建议：**
1. 添加矿机状态监控（在线/离线检测）
2. 集成算力统计面板
3. 批量操作功能（重启、配置更新）
4. 导出功能（将矿机列表导出为Excel）

---

*文档版本: v1.0*  
*最后更新: 2025-10-05*  
*适用版本: HashInsight Enterprise Platform*
