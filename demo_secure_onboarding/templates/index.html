<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HashInsight Secure Miner Onboarding Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/style.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-lock"></i> HashInsight Security Demo
            </a>
            <div class="navbar-text">
                <span id="current-actor-display" class="badge bg-secondary">Not logged in</span>
                <button class="btn btn-sm btn-outline-light ms-2" onclick="toggleLang()">EN/中文</button>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-3">
        <div class="row">
            <!-- Left Panel: Actor & ABAC -->
            <div class="col-md-3">
                <div class="card mb-3">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-person-badge"></i> <span data-i18n="actor_panel">Actor & ABAC</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label" data-i18n="select_tenant">Tenant</label>
                            <select id="tenant-select" class="form-select form-select-sm" onchange="loadActors()">
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label" data-i18n="select_actor">Actor</label>
                            <select id="actor-select" class="form-select form-select-sm" onchange="setCurrentActor()">
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                        <div id="actor-info" class="small text-muted"></div>
                        <hr>
                        <div class="mb-2">
                            <label class="form-label" data-i18n="allowed_sites">Allowed Sites</label>
                            <div id="allowed-sites-list" class="small"></div>
                        </div>
                    </div>
                </div>

                <!-- Audit Status -->
                <div class="card mb-3">
                    <div class="card-header bg-secondary text-white">
                        <i class="bi bi-shield-check"></i> <span data-i18n="audit_status">Audit Chain</span>
                    </div>
                    <div class="card-body">
                        <div id="audit-verify-status" class="text-center">
                            <span class="badge bg-secondary">Not verified</span>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary w-100 mt-2" onclick="verifyAuditChain()">
                            <i class="bi bi-check-circle"></i> <span data-i18n="verify">Verify</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-6">
                <!-- Site Security Settings -->
                <div class="card mb-3">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-gear"></i> <span data-i18n="site_settings">Site Security Settings</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col">
                                <label class="form-label" data-i18n="select_site">Site</label>
                                <select id="site-select" class="form-select" onchange="loadSiteSettings()">
                                    <option value="">-- Select Site --</option>
                                </select>
                            </div>
                            <div class="col">
                                <label class="form-label" data-i18n="current_mode">Current Mode</label>
                                <div id="current-mode-display" class="form-control-plaintext">
                                    <span class="badge bg-secondary">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="mode-info mb-3">
                            <div class="row">
                                <div class="col-4">
                                    <div class="card mode-card" data-mode="1">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-eye-slash fs-4"></i>
                                            <div class="small"><strong>Mode 1</strong></div>
                                            <div class="tiny text-muted">UI Masking</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card mode-card" data-mode="2">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-lock fs-4"></i>
                                            <div class="small"><strong>Mode 2</strong></div>
                                            <div class="tiny text-muted">Server Envelope</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="card mode-card" data-mode="3">
                                        <div class="card-body text-center p-2">
                                            <i class="bi bi-shield-lock fs-4"></i>
                                            <div class="small"><strong>Mode 3</strong></div>
                                            <div class="tiny text-muted">Device E2EE</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="btn-group w-100">
                            <button class="btn btn-outline-warning" onclick="requestModeChange(1)" data-i18n="switch_mode1">→ Mode 1</button>
                            <button class="btn btn-outline-warning" onclick="requestModeChange(2)" data-i18n="switch_mode2">→ Mode 2</button>
                            <button class="btn btn-outline-warning" onclick="requestModeChange(3)" data-i18n="switch_mode3">→ Mode 3</button>
                        </div>
                        <button class="btn btn-outline-danger w-100 mt-2" onclick="requestBatchMigrate()">
                            <i class="bi bi-arrow-repeat"></i> <span data-i18n="batch_migrate">Batch Migrate Credentials</span>
                        </button>
                    </div>
                </div>

                <!-- Discovery -->
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-search"></i> <span data-i18n="discovery">Network Discovery</span>
                    </div>
                    <div class="card-body">
                        <div class="row mb-2">
                            <div class="col-6">
                                <input type="text" id="discovery-cidr" class="form-control form-control-sm" placeholder="192.168.1.0/24">
                            </div>
                            <div class="col-3">
                                <div class="form-check">
                                    <input type="checkbox" id="discovery-simulate" class="form-check-input" checked>
                                    <label class="form-check-label small" data-i18n="simulate">Simulate</label>
                                </div>
                            </div>
                            <div class="col-3">
                                <button class="btn btn-info btn-sm w-100" onclick="runDiscovery()">
                                    <i class="bi bi-play"></i> <span data-i18n="scan">Scan</span>
                                </button>
                            </div>
                        </div>
                        <div id="discovery-results" class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm table-striped">
                                <thead><tr><th>IP</th><th>Port</th><th>Vendor</th><th>Action</th></tr></thead>
                                <tbody id="discovery-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Miner List -->
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <i class="bi bi-cpu"></i> <span data-i18n="miners">Miners</span>
                        <button class="btn btn-sm btn-light float-end" onclick="loadMiners()">
                            <i class="bi bi-arrow-clockwise"></i>
                        </button>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive" style="max-height: 300px; overflow-y: auto;">
                            <table class="table table-sm table-hover mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Name</th>
                                        <th>Mode</th>
                                        <th>Credential</th>
                                        <th>Counter</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="miners-tbody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Changes & Devices -->
            <div class="col-md-3">
                <!-- Change Queue -->
                <div class="card mb-3">
                    <div class="card-header bg-danger text-white">
                        <i class="bi bi-list-check"></i> <span data-i18n="change_queue">Change Queue</span>
                        <span id="pending-count" class="badge bg-light text-dark float-end">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="changes-list" style="max-height: 250px; overflow-y: auto;"></div>
                    </div>
                    <div class="card-footer">
                        <button class="btn btn-sm btn-outline-danger w-100" onclick="loadChanges()">
                            <i class="bi bi-arrow-clockwise"></i> <span data-i18n="refresh">Refresh</span>
                        </button>
                    </div>
                </div>

                <!-- Devices -->
                <div class="card mb-3">
                    <div class="card-header bg-purple text-white" style="background-color: #6f42c1;">
                        <i class="bi bi-hdd-network"></i> <span data-i18n="devices">Edge Devices</span>
                    </div>
                    <div class="card-body">
                        <div id="devices-list" class="mb-2" style="max-height: 150px; overflow-y: auto;"></div>
                        <button class="btn btn-sm btn-outline-primary w-100" onclick="showRegisterDeviceModal()">
                            <i class="bi bi-plus-circle"></i> <span data-i18n="register_device">Register Device</span>
                        </button>
                    </div>
                </div>

                <!-- Audit Log -->
                <div class="card">
                    <div class="card-header bg-dark text-white">
                        <i class="bi bi-journal-text"></i> <span data-i18n="audit_log">Audit Log</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="audit-log" style="max-height: 200px; overflow-y: auto; font-size: 0.75rem;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Change Request Modal -->
    <div class="modal fade" id="changeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-exclamation-triangle"></i> <span data-i18n="create_change">Create Change Request</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="cr-request-type">
                    <input type="hidden" id="cr-target-type">
                    <input type="hidden" id="cr-target-id">
                    <div id="cr-action-preview" class="alert alert-info mb-3"></div>
                    <div class="mb-3">
                        <label class="form-label" data-i18n="reason">Reason (required)</label>
                        <textarea id="cr-reason" class="form-control" rows="3" placeholder="Explain why this change is needed..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="submitChangeRequest()" data-i18n="submit">Submit</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Register Device Modal -->
    <div class="modal fade" id="deviceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="bi bi-hdd-network"></i> <span data-i18n="register_device">Register Edge Device</span></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Device Name</label>
                        <input type="text" id="device-name" class="form-control" placeholder="Edge-Farm-01">
                    </div>
                    <div class="mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="generateKeyPair()">
                            <i class="bi bi-key"></i> Generate X25519 KeyPair (libsodium)
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Public Key (Base64)</label>
                        <textarea id="device-public-key" class="form-control" rows="2" readonly></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Secret Key (Base64) - DEMO ONLY</label>
                        <textarea id="device-secret-key" class="form-control" rows="2" readonly></textarea>
                        <div class="form-text text-danger">⚠️ In production, secret key stays on device only!</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="registerDevice()">Register</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reveal Result Modal -->
    <div class="modal fade" id="revealModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-eye"></i> Credential Revealed</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="reveal-content" class="bg-light p-3 rounded"></pre>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="toast" class="toast" role="alert">
            <div class="toast-header">
                <strong class="me-auto" id="toast-title">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="toast-body"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libsodium-wrappers@0.7.11/dist/modules/libsodium-wrappers.min.js"></script>
    <script src="/static/app.js"></script>
</body>
</html>
