You are a senior full-stack engineer & release manager working on ArabotHXL/BTC_project (HashInsight).

GOAL
Implement 6 scoped features (with tests, events logging, demo toggles) AND a security-first E2E encryption baseline for miner credentials. Open separate PRs per feature.

GLOBAL CONSTRAINTS / 全局约束
- Backend modules: TypeScript/Node. Dashboard: React/Next. Python ONLY for batch/ETL and the Local Agent.
- Timezone: America/New_York; timestamps ISO8601 + 'Z'; UI显示本地ET。
- Branches:
  feat/secure-credentials-e2e
  feat/datahub-unified
  feat/hosting-monitor
  feat/events-pipeline
  feat/web3-recon-mvp
  feat/curtailment-loop
  feat/miner-adapters
- Package: use pnpm if present else npm. Add minimal CI to run lint + tests.
- .env.example 必须补齐并禁止提交密钥。提供安全默认值与回退。
- 所有 fetch/告警/命令/日报事件 → JSONL 到 events/YYYY-MM-DD/*.jsonl。
- DEMO_MODE=1 时使用模拟器（ miners/ETL/邮件只写日志，不外发）。
- 手工 BTC 价格/区块奖励输入改为只读显示（来自 DataHub），UI 顶部展示 Source + RefreshedAt。

REPO PREP / 仓库准备
1) 如果已存在以下目录，复用；缺失则创建：
   api/, routes/, services/, common/, dashboard/, monitoring/,
   modules/, batch/, database/, reports/, events/, agent/, middleware/
2) 公共类型：common/types.ts；事件工具：common/eventLogger.ts（见下方 schema）。
3) 事件中间件放在 middleware/events_pipeline.ts（不要塞到 common/ 里）。
4) DataHub Facade 放 services/datahub/；具体 provider 放 api/datahub/providers/。

EVENT JSONL SCHEMA (one-line JSON each)
{
  "ts":"2025-11-01T14:00:00Z",
  "type":"datahub.fetch|monitor.alert|monitor.ack|monitor.command|curtailment.plan|curtailment.execute|batch.etl|report.daily|email.sent",
  "source":"coingecko|coindesk|blockchain_info|mempool|antminer|whatsminer|simulator|ui|system",
  "key":"btc_price_usd|difficulty|block_reward|network_hashrate|miner_id|wallet_xxx|rule_xxx",
  "status":"ok|timeout|error|triggered|acknowledged",
  "latency_ms":123,
  "details":{...},
  "actor":"system|user:<email>|agent:<id>"
}

Export helper: common/eventLogger.ts with appendEvent(event) writing to events/YYYY-MM-DD/*.jsonl

────────────────────────────────────────────────────────────────────
(0) SECURE CREDENTIALS E2E BASELINE / 安全加密基线  ← 先做
Branch: feat/secure-credentials-e2e

Goal: 前端用 WebCrypto(PBKDF2-SHA256 + AES-GCM-256) 把矿机连接敏感信息加密为 Encrypted JSON Block；后端仅存密文；本地 Agent(Python) 输入同一 Master Passphrase 解密；后端永不解密。

Frontend
- Add to Add-New-Miner modal: Secure Connection section (ip, api_port=4028 default, ssh_user, ssh_password, api_key, masterPassphrase[password, not submitted]).
- static/js/crypto_miner_credentials.js
  - deriveKeyFromPassphrase(passphrase, salt, iterations=100000)
  - encryptMinerCredentials(passphrase, credentialsObj) → returns JSON.stringify({
      v:1, algo:"AES-GCM", kdf:"PBKDF2-SHA256", iterations:100000,
      salt:"<b64>", iv:"<b64>", ciphertext:"<b64>"
    })
- Hook submit: NEVER send plaintext or passphrase. Payload includes encrypted_credentials only + non-sensitive metadata.

Backend
- Miner/HostedMiner model: add encrypted_credentials TEXT；停止写入 ip/ssh_password/api_key 等明文字段（如存在标记弃用）。
- Route: POST /api/hosting/miners 要求 encrypted_credentials（仅 JSON shape 校验，不解密）。
- Route: GET /api/agents/:agent_id/miners 返回 metadata + encrypted_credentials（鉴权）。
- 禁止在日志/事件/错误信息中出现明文；可记录 blob 长度或哈希用于完整性。

Local Agent (Python) — agent/secure_miner_agent.py
- 依赖 cryptography；启动时 getpass 读取 Master Passphrase（不外发）。
- GET /api/agents/:agent_id/miners 拉取密文；PBKDF2+AES-GCM 本地解密，连 4028 取 metrics。
- POST /api/agents/:agent_id/metrics 上报非敏感指标；每次使用后清除明文数据。

Security hard checks
- grep 代码确保无明文：ssh_password|api_key|miner_ip|ip_address 不写库不打日志。
- 添加 tests/test_secure_credentials.py（正确口令解密成功；错误口令抛错）。

────────────────────────────────────────────────────────────────────
(1) Unified Real-time DataHub / 统一实时数据层
Branch: feat/datahub-unified
- services/datahub/index.ts (facade)
- api/datahub/providers/price.coingecko.ts (primary)
- api/datahub/providers/price.fallback.coindesk.ts (fallback)
- api/datahub/providers/chain.blockchaininfo.ts (difficulty, block_reward, network hashrate)
- api/datahub/providers/chain.fallback.mempool.ts (fallback)
- common/cache.ts LRU + TTL（价格 15–30s；链上 5m）
- common/retry.ts backoff + timeout(8s/provider)
- 每次 fetch 记录 datahub.fetch（含 cache_hit）
- Env: DATAHUB_PRICE_TTL=30, DATAHUB_CHAIN_TTL=300, DATAHUB_TIMEOUT_MS=8000
UI:
- dashboard 顶栏组件 RealtimeStrip：显示 Source + RefreshedAt（只读）
- 移除手工价/奖励输入；仅显示只读与时间戳
Tests (jest):
- timeout → fallback & event logged
- primary error → fallback ok
- provider throw → handled + event

────────────────────────────────────────────────────────────────────
(2) Hosting Monitor Page / 监控页
Branch: feat/hosting-monitor
- dashboard/monitoring.tsx：表格列 MinerID/Model/Status/Hashrate(5m)/Temp/Fan/Power/LastSeen
- 每行 15min sparkline（SVG/simple lib）
- 数据源：
  - api/monitor/miners.ts 从 modules/miner_adapters 取数据
  - 顶栏读 DataHub
- DEMO_MODE=1 时混入 5 台模拟矿机
- 规则（monitoring/rules.ts）：
  - Offline>2min；Temp>85°C；Hashrate跌>15% vs 1h baseline；Fan=0
  - 触发 monitor.alert 事件；UI 显示 badge；批量操作条（真机双确认）
- 日报：
  - reports/generateDailyReport.ts 聚合 events → CSV/HTML/PDF（优先 pdfkit）
  - npm run report:daily 产出 reports/YYYY-MM-DD/monitoring_report.*

────────────────────────────────────────────────────────────────────
(3) Events & Alerts Middleware / 事件流水
Branch: feat/events-pipeline
- middleware/events_pipeline.ts 导出 recordDataFetch/recordAlert/recordCommand/recordEmail（内部用 eventLogger）
- 邮件：email/notifier.ts (SMTP env)，DEMO_MODE 仅写 email.sent 事件与 .eml stub 至 reports/YYYY-MM-DD/
- 邮件模板来自 OPERATIONS_MANUAL_EN.md（alert.hbs / recovery.hbs）
- 导出接口：GET api/events/export?format=csv&since=24h
- Ack：POST api/events/ack（记录 actor）

────────────────────────────────────────────────────────────────────
(4) Web3 Reconciliation MVP / 链上对账
Branch: feat/web3-recon-mvp
- batch/web3/etl.ts (mempool.space + blockchain.info；DEMO fixtures)
- SQLite: database/web3.sqlite（独立于主库）
  tables: blocks, txs, tx_io, address_tags
- batch/web3/reconcileDaily.ts（输入 config/wallets.json）
  输出字段：total_in/out/net/fees/model_revenue/delta_pct；|delta|<1% 标注 rounding accepted
- Export: reports/YYYY-MM-DD/wallet_settlement.(csv|pdf)
- Env: MEMPOOL_BASE=https://mempool.space/api, BLOCKCHAIN_INFO_BASE=https://blockchain.info

────────────────────────────────────────────────────────────────────
(5) Curtailment Strategy / 限功率闭环
Branch: feat/curtailment-loop
- modules/curtailment_service/index.ts
  输入：电价(DataHub 或 config)、阈值(config/curtailment.json)、DEMO
  产出：plan JSON(miner_id, action: throttle|stop, expected_savings, expected_revenue_impact)
  API: POST api/curtailment/plan | execute(confirm=true) | rollback
  事件：curtailment.plan/execute；UI 浮层展示前后收益/功率对比

────────────────────────────────────────────────────────────────────
(6) Miner Adapters / 矿机适配层 (Antminer first; WhatsMiner simulator)
Branch: feat/miner-adapters
- modules/miner_adapters/types.ts
  export interface MinerState {
    id:string; model:string; ip:string;
    online:boolean; hashrate_5m:number; temp_c:number; fan_rpm:number[];
    power_w:number; last_seen:string;
  }
  export interface MinerAdapter {
    getState():Promise<MinerState>;
    setPowerLimit(percent:number):Promise<void>;
    reboot():Promise<void>;
  }
- modules/miner_adapters/antminer.ts : 4028 适配（node-net/TCP），超时+认证支持
- modules/miner_adapters/whatsminer.sim.ts : 模拟器（状态+控制响应）
- modules/miner_adapters/registry.ts : 基于 config/miners.json 解析适配器
- 所有控制指令需二次确认(confirm=true) + 审计 monitor.command（actor 记录）

UI STRAPS
- dashboard/components/RealtimeStrip.tsx
- monitoring page + 15-min sparkline + alert filter
- 导出 CSV 按钮：调用 api/events/export

TESTS / 单测
- jest + ts-jest
- DataHub：timeout/fallback/exception
- Monitoring rules：构造状态触发各规则→断言事件写入
- Curtailment：给定样本矿机+电价→计划长度/节省单调性
- Web3 ETL：DEMO fixtures→SQLite 填充→1d 对账产 CSV
- Python：tests/test_secure_credentials.py（正确/错误口令）

SCRIPTS (package.json)
{
  "scripts": {
    "dev":"next dev",
    "build":"next build",
    "start":"next start",
    "test":"jest --runInBand",
    "report:daily":"ts-node reports/generateDailyReport.ts",
    "web3:etl":"ts-node batch/web3/etl.ts",
    "web3:recon":"ts-node batch/web3/reconcileDaily.ts"
  }
}

CI
- .github/workflows/ci.yml：install + test（若已存在工作流则追加，不覆盖）

ACCEPTANCE CHECKLIST / 验收清单
- Secure E2E：前端加密 → 后端只存密文 → Agent 本地解密；grep 无明文；Python/JS 互通；错误口令解密失败。
- DataHub：UI 顶部显示 Source + Refreshed；去除手工价/奖励；三类单测通过。
- Monitoring：表格+15min 微图；规则触发事件；日报生成于 reports/。
- Events：24h 回放；CSV 导出；每条告警可追溯触发参数与确认人。
- Web3 Recon：ETL 入库；日报 CSV/PDF；<1% 差异标注 rounding。
- Curtailment：plan/execute/rollback + 对比浮层；事件&日报完整。
- Miner adapters：混合5台（真/假）；控制双确认；全量审计。

DELIVERABLES / 交付
- 7 PRs（安全基线 + 六大功能），每个 PR 有截图/GIF
- README 更新：
  - Setup / env / DEMO 模式
  - 跑测试、生成日报、导出事件
  - 安全说明（密文存储、后端不解密、Agent 本地解密）
- 终端最后打印改动摘要（文件清单、路由、JSON schema、操作指南）

IMPORTANT
- Actually modify the code (no pseudo-code). Keep secrets out of logs & DB. 
