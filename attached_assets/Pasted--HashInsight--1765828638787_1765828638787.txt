浏览器 (矿场主)                                            服务器 (HashInsight)                                            边缘采集器 (Edge Collector)
┌───────────────────────────────────────────────┐         ┌───────────────────────────────────────────────┐              ┌───────────────────────────────────────────────┐
│ 0) 选择场地 Site / 绑定 Edge Device            │         │ 多租户控制面                                   │              │ Init) 首次启动生成设备密钥对 (X25519)          │
│    - site_id / device_id                       │  HTTPS  │ - devices(pubkey/status/key_version/token)     │   HTTPS       │  - privkey 本地安全保存(加密落盘/TPM/Keychain) │
│                                                ├────────►│ - miners(asset metadata + fingerprint)         ├─────────────►│  - pubkey 注册 /devices/register               │
│ 1) 输入 IP 范围/网段                            │         │ - secrets(仅密文包)                            │              │  - 获取 device_id + device_token               │
│    192.168.1.100-200 / 10.10.0.0/24            │         └───────────────────────────────────────────────┘              └───────────────────────────────────────────────┘
│                                                │
│ 2) 点击 “IP 扫描/发现”                          │
│    (不需要先录入密码)                           │
│                                                │                                                        2) 扫描流程 (Discovery)
│ 3) 选择 “隐藏 IP 地址信息”策略 (可选)            │                                                        ┌───────────────────────────────────────────────┐
│    ├─ 方案1: UI脱敏 + RBAC + 审计 (默认)         │                                                        │ - 预探测：ping/TCP 探测                         │
│    ├─ 方案2: 服务器加密IP (KMS/Envelope)         │                                                        │ - 端口探测：4028/80/443(可配)                   │
│    └─ 方案3: E2EE加密IP (Server永不见明文)       │                                                        │ - 协议识别：CGMiner/Web 指纹                     │
│                                                │                                                        │ - 生成 fingerprint：MAC/序列号(优先) / hash(次优)│
│ 4) 选择能力等级                                 │                                                        │ - 上报资产清单：miner_id,fingerprint,model,fw    │
│    ├─ Level 1: 仅发现(资产盘点)                  │                                                        └───────────────────────────────────────────────┘
│    ├─ Level 2: 只读遥测(优先不输密码)            │
│    └─ Level 3: 管理控制(需要凭证+E2EE)           │
│                                                │
│ ---------------- Level 1：仅发现 ----------------│         服务器：保存资产概览（默认不展示完整IP）            Edge：持续更新在线状态/型号/固件
│ UI 展示：别名/型号/在线状态/指纹                 │         + RBAC：特权用户才可 Reveal IP(方案1)              + 上报 last_seen/health
│                                                │
│ ----------- Level 2：只读遥测(推荐) ------------ │         服务器：仅接收遥测与告警                           Edge：网络隔离后只读采集
│ (可选) 配置网络隔离建议：                         │         + 审计：采集/失败/异常                             ┌───────────────────────────────────────────────┐
│  - ACL/VLAN：仅 Edge 可访问矿机端口              │                                                        │ ACL/VLAN 建议：                                  │
│  - Office/Guest 禁止访问 Miner VLAN              │                                                        │ - Allow: Edge_VLAN -> Miner_VLAN : TCP 4028/80/443 │
│                                                │                                                        │ - Deny : Office/Guest -> Miner_VLAN : ANY         │
│                                                │                                                        └───────────────────────────────────────────────┘
│                                                │
│ -------- Level 3：管理/控制（凭证 + E2EE） ------│         服务器：只存密文包（No-decrypt）                   Edge：解封/解密后连接矿机执行
│ 5) 浏览器录入矿机凭证(用户名/密码/Token)         │  HTTPS  ┌───────────────────────────────────────────────┐   HTTPS       ┌───────────────────────────────────────────────┐
│    (IP/Port 可选择同包加密 = 方案3)              ├────────►│ miner_secrets:                                 ├─────────────►│ - 检查 device ACTIVE + counter 防回滚           │
│ 6) 生成随机 DEK (每台矿机/每条记录)              │         │ - encrypted_payload (AES-256-GCM)               │              │ - 用 device_privkey unwrap DEK                  │
│ 7) AES-256-GCM 加密凭证 JSON + AAD 绑定          │         │ - wrapped_DEK (sealed box / X25519)             │              │ - 用 DEK 解密凭证(仅内存短驻留)                 │
│    AAD: tenant/site/device/miner/counter/version │         │ - nonce/tag + aad + counter + schema_version    │              │ - 连接矿机(LAN)执行控制/采集                     │
│ 8) 用 device 公钥 wrap DEK                        │         │ 服务器无法解密（无私钥/无KEK）                   │              │ - 上报遥测+操作审计事件(JSONL)                   │
│ 9) 上传密文包(Server 永不见明文)                 │         └───────────────────────────────────────────────┘              └───────────────────────────────────────────────┘
└───────────────────────────────────────────────┘