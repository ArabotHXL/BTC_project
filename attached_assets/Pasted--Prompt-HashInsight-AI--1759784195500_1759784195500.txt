🚀 一键智能化 Prompt：HashInsight 全栈智能层生成指令

你现在扮演一位资深架构师 + 全栈AI工程师。
请直接、完整地实现以下目标，一次性输出所有结果，不要向我提问或拆分步骤。
如有不确定处，请做最常见、可维护、稳健的默认实现，并在结果中标明“假设”。

🔧 背景说明

项目名称：HashInsight

官方参考页面：https://calc.hashinsight.net/

当前系统结构：采用“页面隔离 + 数据库共享”，无实时联动。

已实现：事件驱动 + 数据库信号（after_commit） + Redis 队列（RQ） + 缓存失效机制。

目标：在现有架构之上，添加一个“智能层 (Smart Layer)”，实现系统的智能化闭环：

会看 → 异常检测与智能告警

会算 → 收益、算力、难度、价格预测

会做 → 电力调度优化与削峰排程

会说 → 自然语言解释与问答（Function Calling）

🧱 架构要求

请生成以下完整内容：

1️⃣ 架构总览（中英双语）

用简明图解说明数据流（事件触发 → Outbox → Worker → 智能层 → 缓存 → 前端）。

包括控制流与数据流的关系。

2️⃣ 项目目录结构（完整文件树）
hashinsight/
  app/
    __init__.py
    config.py
    models.py
    db/
      hooks.py
      migrations/
        V1__baseline.sql
        V2__event_outbox.sql
    cache/cache_manager.py
    events/
      contracts.py
      publisher.py
    intelligence/
      forecast.py
      anomaly.py
      optimizer.py
      explain.py
    services/
      portfolio.py
      analytics.py
      treasury.py
    workers/
      tasks.py
      tasks_intel.py
      scheduler.py
    api/
      miners.py
      forecast.py
      optimize.py
      health.py
  requirements.txt
  Procfile.replit
  docker-compose.yml
  Makefile
  README.md

3️⃣ 数据库模型与迁移文件

users, user_miners, event_outbox, event_failures, forecast_daily, ops_schedule

提供 Postgres SQL 脚本和 SQLite 兼容说明。

4️⃣ 智能层模块核心代码（完整可运行示例）

每个文件请单独给出代码块，含导入、函数定义、注释。

📘 app/intelligence/forecast.py

使用 Prophet / XGBoost 生成未来7~30天的 BTC 价格、网络难度与预期收益预测。

输出置信区间与误差指标 (RMSE/MAE)。

📙 app/intelligence/anomaly.py

MAD 异常检测、STL 分解检测（返回异常点与等级）。

支持周期性波动数据（算力/温度/功耗）。

📗 app/intelligence/optimizer.py

基于 OR-Tools 或 PuLP 的削峰排程器：
输入电价、矿机功耗、curtailment%，输出每小时开机台数。

📕 app/intelligence/explain.py

ROI贡献度分解函数：计算各因子（BTC价格、难度、离线率、电价）对收益的影响。

5️⃣ API 层（Flask）

生成以下可直接运行的接口（含 curl 示例）：

路径	方法	功能
/api/forecast/<user_id>	GET	获取预测数据（价格、难度、收益）
/api/optimize/curtailment	POST	提交时段与电价 → 返回削峰排程表
/api/explain/roi	GET	返回 ROI 变化的贡献度分析
/api/miners	POST	新增单台矿机（触发 Outbox）
/api/miners/bulk	POST	批量导入矿机（生成 bulk_imported 事件）
/api/health	GET	返回 outbox 积压、失败任务数、预测延迟等
6️⃣ 队列任务与联动逻辑

事件触发 → Outbox → Scheduler 合并 → Worker 异步执行：

tasks.recalculate_user_all(user_id)（已有）

tasks_intel.forecast_refresh(user_id)

tasks_intel.optimize_curtailment(user_id, window)

tasks_intel.health_predict(user_id)

给出每个任务的幂等与重试机制。

7️⃣ 缓存策略

键命名规范（user_portfolio:{id}, forecast:{id}, optimize:{id}:{date}）

缓存失效规则与 Lazy Rebuild。

针对用户界面的 stale-while-revalidate 策略。

8️⃣ 监控与智能告警

监控指标：

outbox_backlog, task_failures, forecast_latency, optimization_runtime, roi_drift

提供 /api/health 样例 JSON 输出。

告警逻辑：预测误差>阈值、算力异常、ROI下降>10%。

9️⃣ 部署配置（Replit + Docker）

Replit：

Procfile.replit（同时运行 web + worker）

环境变量列表：DATABASE_URL, REDIS_URL, OPENAI_API_KEY

Docker：

docker-compose.yml 启动 web, worker, redis, postgres 四容器。

Makefile 提供快捷命令：make up, make logs, make migrate, make seed.

🔟 最小运行示例（端到端）

用户新增矿机 → outbox 生成事件 → worker 自动重算 → 调用智能层 → 刷新缓存 → /api/forecast 返回预测结果。

请展示一次完整的日志流与结果 JSON。

11️⃣ 验收与测试清单
模块	验收目标
Outbox	事件入库 & 消费幂等
Forecast	RMSE < 5%（7日）
Optimizer	24h 调度耗时 < 1s
Anomaly	异常检测 Precision@K > 0.9
Explain	各因子贡献总和 ≈ 实际变化
API	全部 200 响应，延迟 < 500ms
Worker	失败任务自动重试，重算幂等
部署	Replit 与 Docker 环境均可运行
12️⃣ 高级扩展（可选说明）

引入 LLM Function Calling（自然语言接口示例）：
“帮我预测下周的收益并生成削峰排程表” → 调用预测 + 优化函数链。

训练/推理分离结构。

多币种扩展（BTC/ETC/LTC/CFX）。

13️⃣ 风险与回滚

Worker 宕机 → 缓存仍可读旧数据。

智能预测错误 → 可回滚至规则引擎模式。

所有任务支持幂等重放。

📦 技术默认值
组件	选择
Web框架	Flask
队列系统	Redis + RQ
数据库	PostgreSQL（SQLite兼容）
预测模型	Prophet + XGBoost
优化算法	PuLP（OR-Tools可选）
缓存	Flask-Caching（Redis backend）
Python版本	3.10+
环境	Replit / Docker
⚙️ 输出格式要求

按上面章节顺序分节输出。

每个文件使用独立代码块，顶行标注路径（如：# app/intelligence/forecast.py）。

不可省略关键逻辑。

代码与命令应可直接复制运行。

生成完毕后自动总结系统智能化闭环与下一阶段建议。

请开始执行。
（记得：一次性完整输出所有结果，不要拆分，不要等待确认，不要省略任何关键文件。）