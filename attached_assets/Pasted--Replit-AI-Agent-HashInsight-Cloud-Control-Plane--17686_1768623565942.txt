你是 Replit AI Agent（全栈工程负责人 + 安全/可观测性负责人）。请为 “HashInsight Cloud（控制面/Control Plane）” 设计并实现一套生产可用的云端改进方案，用于与现有 Edge Collector（执行面）配合，实现：遥测入库 → 规则评估 → 命令编排 → Collector 拉取执行 → ACK 回报 → 审计/对账。

目标（必须全部实现）
1) 支持 Cloud 下发控制信号，Collector 以 pull 方式拉取命令并执行，执行结果 ACK 回云端。
2) Cloud 侧具备生产级“命令队列 + 仲裁 + 幂等 + TTL + lease + 重试退避 + 速率限制 + 审计不可抵赖”。
3) Cloud 侧具备规则引擎（rule engine）：对最新遥测做阈值/持续时间/连续采样判断，产生命令；支持冷却期（cooldown）与恢复规则；支持规则优先级与冲突仲裁。
4) Cloud 侧具备权限与审批（RBAC/ABAC + approval flow）：对高风险动作（reboot/disable hashing/批量操作）默认要求审批；支持站点/客户隔离（tenant/site/zone）。
5) 提供完善文档（README + API 文档 + 数据库 schema + 运维手册），以及最小测试（单元测试 + API 测试），并可在 Replit 直接运行。

技术栈（默认，不要问我）
- Backend：Python FastAPI
- DB：Postgres（SQLAlchemy 2.0 + Alembic migrations）
- Queue/Scheduler：Redis + RQ（或 Celery 也可以，但默认用 RQ）
- Auth：JWT（用户）+ Collector Token（设备），再加可选的 HMAC 命令签名（v1 支持）
- Observability：structlog 日志 + Prometheus metrics endpoint
- 前端管理台：先做最小（可用 FastAPI + Jinja/简单 React），优先保证 API 与后台可靠性

需要兼容的 Collector 行为（请按以下约定实现）
- Collector 不接受云端主动打入内网；Collector 只会定时 pull：
  - v1：GET /api/edge/v1/commands/poll
  - v1：POST /api/edge/v1/commands/{command_id}/ack
- 同时提供 legacy 兼容路由（但标注 deprecated）：
  - GET /api/collector/commands/pending/{site_id}
  - POST /api/collector/commands/ack

核心改进（你必须落成“代码 + schema + job + 文档”，不是建议）
A. 命令队列（Command Queue）生产化
- Command 状态机：queued → dispatched(lease) → running → succeeded/failed | expired | canceled | superseded
- 关键字段：command_id, tenant_id, site_id, zone_id?, miner_id, command_type, params(jsonb), priority,
           ttl_sec/expires_at, dedupe_key, approval_state(required/approved/rejected),
           created_by, created_reason, rule_id?, evidence(jsonb), attempt, max_retries, retry_backoff_sec,
           lease_owner(collector_id), lease_until, ack_payload(jsonb), error_code, error_message, timestamps
- 约束：
  1) per-miner 串行：同一 miner_id 同一时刻只允许一个控制类命令处于 dispatched/running
  2) TTL：过期命令不允许被 poll 返回；若已 dispatched 但 lease 过期可重新派发或标记 expired
  3) 幂等：ACK 重放不改变最终态（同 command_id 的 ack 只能从 running/dispatched/queued 走向终态一次）
  4) 退避：失败命令按 backoff 重试（有上限），并记录每次 attempt 的执行证据
  5) 速率限制：按 site_id + command_type 做 rate limit（例如 reboot 每 5 分钟最多 N 台）
  6) 批量命令：支持 group_id（矿机组）展开，但落库必须是“每台矿机一条 command”以便审计与回滚

B. 冲突仲裁（Arbitration）
- 规则/人工/限电策略可能同时命中同一矿机：你必须实现仲裁器：
  - priority：Safety > Compliance/DR > Efficiency > Convenience
  - 若新命令优先级更高，可将低优先级 queued 命令 superseded（保留链路）
  - 若已有 running 的低优先级命令，不允许打断（除非是 Safety 并标记 emergency=true）
  - 仲裁结果必须写入审计（audit）

C. 规则引擎（Rule Engine）
- Rule 表必须支持：
  - scope：tenant/site/zone/group/miner
  - trigger：metric(temp_max/temp_avg/hashrate/reject_rate/hw_errors/offline) + operator + threshold
  - condition：consecutive_samples / min_duration_sec（避免毛刺）
  - cooldown：cooldown_sec
  - action：command_type + params（例如 disable_hashing / set_pool / set_frequency）
  - recovery_rule：支持“恢复正常”规则（例如 temp_max < 70 且当前为 low_power）
  - priority 与 approval_required
  - maintenance_window 支持（可简化：按周/按时间段）
- Rule 评估任务：
  - 每 30~120 秒运行一次（可配置）
  - 只基于“最新遥测”与“近 N 个采样”判断（你需在 telemetry 表设计索引）
  - 命中后创建 command（并写 evidence：触发的采样点列表）
  - 需要实现 cooldown：同一 rule+miner 在 cooldown 内不重复下发（靠 dedupe_key 实现）
- 明确“离线/数据陈旧”策略：
  - 若 miner 最后遥测时间距今 > stale_sec，规则引擎不得发温控类命令，只发 offline 告警/工单事件

D. 权限与审批（RBAC/ABAC + Approval）
- 至少 6 类角色：Owner, OpsManager, NOC, Technician, CustomerSuccess(Hosting), Customer(只读)
- ABAC：tenant_id/site_id/zone_id 数据隔离
- 高风险动作默认需审批：
  - reboot_device / disable_hashing / 批量超过 X 台 / 影响超过 Y kW（若有 power 数据）
- 审批流：
  - 创建命令时可进入 approval_state=required
  - 未批准的命令不得被 poll 返回
  - 提供审批 API：POST /api/admin/v1/commands/{id}/approve 与 /reject（带 reason）

E. 审计与证据链（Audit + Evidence）
- AuditLog：append-only，不允许更新删除（应用层保证）
- 每个关键事件必须落审计：
  - rule evaluated / command created / command superseded / command dispatched / command ack / approve/reject / manual override
- Evidence：命令创建时保存触发证据（采样点、阈值、规则版本号），ACK 保存执行结果与错误码

F. API（必须提供 OpenAPI + 示例 curl）
- Collector APIs（v1）：
  1) GET /api/edge/v1/commands/poll?collector_id=...&limit=...
     - 返回：待执行命令列表（只返回属于该 collector/site 的命令；必须过滤 approval_state=approved/none；必须过滤 expired；必须用 lease 原子派发）
  2) POST /api/edge/v1/commands/{command_id}/ack
     - body：status(succeeded/failed/rejected/skipped), started_at, finished_at, error_code, error_message, result(json), device_id, miner_snapshot_before/after(optional)
- Telemetry ingest（你必须实现，供规则引擎使用）：
  - POST /api/edge/v1/telemetry/batch
    - body：[{miner_id, ts, temp_max, temp_avg, hashrate, fan_rpm, hw_errors, reject_rate, state, ...}]
- Admin APIs（最小）：
  - CRUD rules：/api/admin/v1/rules
  - 查看命令队列：/api/admin/v1/commands?site_id=&state=&miner_id=
  - 审批接口：/api/admin/v1/commands/{id}/approve|reject
  - 查看审计：/api/admin/v1/audit?entity_type=&entity_id=&since=

G. DB Schema（必须提供 Alembic migrations）
至少包含：
- tenants, sites, zones(optional), collectors, miners, miner_groups
- miner_telemetry (时间序列：按 site_id + ts 分区或至少索引优化)
- rules, rule_state (可选：记录 per miner 的 cooldown/last_triggered)
- commands, command_attempts(optional), audit_log, approvals(optional)

H. 可靠性与安全（必须落地）
- Collector token：collector 注册或预置 token；每次 poll/ack/telemetry 都要鉴权
- 可选：命令签名（HMAC）字段：cloud_sign 与 collector_verify（先实现框架与开关）
- Rate limit：实现最小版（DB 或 Redis），并写入文档
- Lease：poll 命令时必须使用数据库事务/SELECT FOR UPDATE SKIP LOCKED 实现原子领取
- Metrics：/metrics 输出关键指标（commands_dispatched_total, commands_failed_total, rule_evals_total, telemetry_ingest_lag_seconds）

交付物（必须给出具体文件与目录）
1) 完整可运行的 Replit 项目结构，例如：
   /app
     main.py (FastAPI)
     config.py
     db.py
     models.py
     schemas.py
     routers/
       edge_v1.py
       admin_v1.py
     services/
       command_dispatcher.py
       rule_engine.py
       arbitration.py
       approval.py
       audit.py
       rate_limit.py
     jobs/
       scheduler.py (RQ jobs)
     migrations/ (Alembic)
     tests/
       test_poll_lease.py
       test_rule_cooldown.py
       test_ack_idempotent.py
   README.md（运行/ENV/示例 curl/故障排查）
   OPENAPI.md（关键 API 示例与字段说明）

2) 最少 3 个关键验收用例（写在 README + tests 中）
- 幂等 ACK：同一 command ack 两次，最终态不被破坏，审计记录完整
- lease 派发：两个 collector 同时 poll，不会领取到同一 command
- cooldown + dedupe：温度在阈值附近抖动，2 分钟内不会重复创建同一动作命令

实现细节要求（请严格遵守）
- 不要把“建议”写成 TODO；要把最小可用版本做出来
- API 返回必须包含明确 error_code（例如 COMMAND_EXPIRED / NOT_APPROVED / MINER_LOCKED / RATE_LIMITED）
- 所有时间字段用 UTC ISO8601
- 所有写操作必须写 audit_log
- 文档里明确说明：Cloud 是慢策略（policy），紧急保护建议在 Collector 本地实现（但此项目仍以 Cloud 发命令为主）

开始执行
- 先输出一个“架构与数据流”简图（ASCII）
- 再创建项目文件与核心代码
- 再写 migrations
- 再写 tests
- 最后完善 README 与 curl 示例

现在开始生成代码与文件。
