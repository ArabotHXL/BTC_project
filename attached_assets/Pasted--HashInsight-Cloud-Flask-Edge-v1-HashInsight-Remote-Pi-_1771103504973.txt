你现在是资深后端工程师 + 安全合规工程师。你要在 HashInsight Cloud（Flask）代码库中，把 Edge v1 协议“做完并可上线”，确保 HashInsight Remote（Pickaxe/Remote 客户端）在不改客户端或最小改客户端配置的情况下，能够：

1) telemetry_api_mode=auto/v1 时，成功向云端上传遥测（gzip payload），云端真正落库并可在 UI/API 查询到；
2) command_api_mode=auto/v1 时，成功 poll 命令并 ack 结果（兼容 Remote 的 payload 字段）；
3) 仍然兼容 legacy：/api/collector/upload 与 /api/collector/commands/pending|result 不被破坏；
4) 解决当前最大阻塞：Remote 使用 Authorization: Bearer <collector_token>（同一个 token 同时放在 X-Collector-Key）时，云端 v1 endpoints 不应 401（必须可用）。

重要上下文（你必须按这个兼容）：
- Remote v1 telemetry endpoint：POST {base}/api/edge/v1/telemetry/batch
- Remote legacy telemetry endpoint：POST {base}/api/collector/upload
- Remote v1 commands poll：GET {base}/api/edge/v1/commands/poll
- Remote legacy commands poll：GET {base}/api/collector/commands/pending
- Remote v1 ack：POST {base}/api/edge/v1/commands/{id}/ack
- Remote legacy result：POST {base}/api/collector/commands/{id}/result

Remote 上传格式（必须兼容）：
A) Legacy telemetry：
- Header: Content-Encoding: gzip
- Body: gzip(json.dumps(list[record]))，record字段含 miner_id, online, hashrate_ghs, hashrate_5s_ghs, temperature_avg, fan_speeds, accepted_shares, rejected_shares, hardware_errors, uptime_seconds, power_consumption, efficiency, pool_url, worker_name, firmware_version, model, error_message, (可选) boards_data 等
B) v1 telemetry_envelope.v1：
- Header: Content-Encoding: gzip
- Body: gzip(json.dumps({
    "schema": "telemetry_envelope.v1",
    "site_id": "<string from remote config>",
    "zone_id": "<string>",
    "device_id": "<string>",
    "sent_at": "<iso utc>",
    "mode": "raw|live|history",
    "record_count": N,
    "source_seq_start": int,
    "source_seq_end": int,
    "compression": "gzip",
    "records": [ {同 legacy record 字段... + 可选 source_seq } ]
  }))
注意：Remote 默认不会发 payload_enc 加密；若出现 payload_enc，你可以先返回 422 并明确错误码 ENCRYPTED_PAYLOAD_UNSUPPORTED（不要 silent fail）。

鉴权要求（必须做到）：
- 现在云端 v1 端点使用 require_device_auth（EdgeDevice token）会导致 Remote 401，因为 Remote 用的是 collector_token（CollectorKey）。
- 你必须实现一个新的 edge 鉴权装饰器（推荐命名 require_edge_auth），支持两种方式其一即可通过：
  1) EdgeDevice token（Authorization: Bearer <device_token> 或 token_hash）
  2) CollectorKey token（同 legacy 校验方式：sha256(raw_token) == collector_keys.key_hash），Remote 会同时带 X-Collector-Key 和 Authorization: Bearer <collector_token>，你至少要支持 Bearer token 校验。
- 通过 CollectorKey 鉴权时：
  - g.site_id = collector_key.site_id（权威 site scope）
  - g.device_id 可以置为 None 或 "collector_key:<id>"（但必须能跑通 v1 telemetry / v1 commands）
  - zone_id 不做强绑定（因为 CollectorKey 本身不含 zone），但要允许从 query 或 envelope 带 zone_id，写入 telemetry 作为标签即可
- 通过 EdgeDevice token 鉴权时：保持当前 zone binding 逻辑不变

云端代码定位（你需要修改/新增的关键点）：
- api/control_plane_api.py
  - /api/edge/v1/telemetry/ingest 与 /api/edge/v1/telemetry/batch 目前是 stub（request.get_json + telemetry字段），必须改为支持 gzip + envelope + list 形式，并真正调用“落库逻辑”
  - /api/edge/v1/commands/poll 与 /api/edge/v1/commands/{id}/ack 需要使用新的 require_edge_auth（允许 CollectorKey），并保证返回结构 Remote 能解析
- api/collector_api.py
  - 已有成熟的 upload_telemetry() 落库逻辑（MinerTelemetryLive/History/Raw24h/boards），建议抽出成可复用函数 ingest_miner_records(site_id:int, records:list[dict], now:datetime, source_meta:dict) 供 v1 调用，避免复制粘贴
- 任何 “edge_collector/collector_config_example.json” 或示例配置里 api_url 不要写到 /api/collector/upload（必须是 base url），否则会出现重复拼接路径的问题（…/api/collector/upload/api/collector/upload）

你要实现的功能（逐条交付，必须全做完）：

【1】实现统一落库入口（共享函数）
- 新建 services/edge_ingest_service.py（或在 services/telemetry_service.py 增加函数）
- 输入：site_id（int）、records（list[dict]）、received_at（datetime）、source（"legacy"|"v1"）、edge_meta（device_id/zone_id/sent_at/source_seq_range）
- 行为：
  - 复用 collector_api.upload_telemetry 中的字段映射与批量写入逻辑，确保写：
    - miner_telemetry_live 更新/插入
    - miner_telemetry_history 插入（可按 5min 聚合策略保持一致；若你已有策略则沿用）
    - TelemetryRaw24h（用于证据包/短期诊断）
    - board telemetry（如果 records 有 boards_data）
  - 对 records 进行最小校验：必须有 miner_id；online 默认 False；数值字段缺失则默认 0
  - 绝不信任 IP（即使 records 里有 ip_address，也要可配置 scrub；保持与 Remote 的“默认不上传 IP”一致）
  - 返回：processed_count, online_count, offline_count, errors(list)

【2】完成 v1 telemetry ingest（真正可用）
- 修改 api/control_plane_api.py 的 edge_ingest_telemetry()
- 兼容输入：
  A) Content-Encoding=gzip + body 为 gzip(json list) -> 当作 legacy records
  B) Content-Encoding=gzip + body 为 gzip(json dict schema=telemetry_envelope.v1) -> 取 records 字段
  C) Content-Encoding 为空 + JSON body（为调试便利），同样支持 list 或 envelope dict
- 验证：
  - 鉴权通过后，以 token 对应的 site_id 为准（忽略 envelope.site_id 或仅做一致性校验）
  - 若 envelope.record_count 与 records 实际长度不一致：记录 warning，但仍可处理
  - 若 payload_enc 存在且 records 缺失：返回 422 + {"error":"ENCRYPTED_PAYLOAD_UNSUPPORTED"}
- 输出：
  - HTTP 200 JSON：
    {
      "success": true,
      "processed": <int>,
      "received_at": "<isoZ>",
      "source": "v1|legacy",
      "site_id": <int>,
      "zone_id": "<string|null>",
      "device_id": "<string|null>",
      "warnings": [...]
    }

【3】完成 v1 commands poll + ack 的兼容（Remote 直连可用）
- 修改 api/control_plane_api.py：
  - edge_poll_commands：鉴权从 require_device_auth -> require_edge_auth
  - 返回格式 Remote 能解析：
    - Remote 接受 list 或 {"commands":[...]}，字段至少含：
      command_id 或 id
      miner_id
      site_id
      command（字符串）
      params（dict）
      priority（int, optional）
      expires_at（optional）
  - edge_ack_command：鉴权同样用 require_edge_auth
    - 接收 Remote report_result body（兼容字段名）：
      status: completed|failed
      result_code: int
      result_message: str
      execution_time_ms / duration_ms (optional)
      before/after (optional)
      error_class (optional)
    - 行为：
      - 更新 miner_commands 表对应记录 status=completed|failed，填充 completed_at/failed_at/result_message 等（按你现有模型字段）
      - 写一条 AuditEvent（包含 actor=collector/device，targets，参数，结果）
      - 返回 200 JSON {"acknowledged": true, "command_status": "..."}
- 保持 legacy /api/collector/commands/* 不变

【4】修复示例配置与文档（避免再次踩坑）
- 搜索并修复所有示例里把 api_url 写成 /api/collector/upload 的情况，必须改为 base，例如 https://calc.hashinsight.net
- 在 docs/ 或 README 增加一段 “Remote 兼容矩阵”：
  - v1 需要：/api/edge/v1/telemetry/batch + /api/edge/v1/commands/poll + /api/edge/v1/commands/{id}/ack
  - legacy 需要：/api/collector/upload + /api/collector/commands/pending + /api/collector/commands/{id}/result
  - token 规则：collector_token 可用于 v1（兼容模式），device_token 为更严格模式（推荐生产）

【5】写一套最小自测脚本/用例（必须能跑通）
- 在 validation/ 或 scripts/ 下新增：
  - scripts/test_edge_v1_telemetry.py：构造一个 telemetry_envelope.v1（gzip）并 POST 到 /api/edge/v1/telemetry/batch，断言 200 且 processed>0
  - scripts/test_edge_v1_commands.py：创建一条 miner_commands pending（你可直接写 DB 或调用已有 propose API），然后 GET poll，拿到命令后 POST ack，断言命令状态更新
- 同时给出 curl 示例（写到脚本注释即可）

约束（必须遵守）：
- 不要引入重型新依赖（标准库、已有依赖可用）
- 不要破坏数据库结构；如必须加字段，用 alembic 迁移并保持向后兼容
- 不要改动 UI 大逻辑，只做后端协议与安全修复
- 所有新接口必须写清楚返回错误码与错误信息（401/403/400/422/500）
- 注意审计：所有 v1 ack 与关键变更都要写入 audit 事件（你已有 audit/audit_logger.py 或 models_control_plane.AuditEvent 就用它）

Definition of Done（验收清单）：
- Remote 只配置 collector_token（X-Collector-Key + Authorization: Bearer 同值），在 telemetry_api_mode=auto 时：
  - 首选命中 /api/edge/v1/telemetry/batch（不再 401）
  - miner_telemetry_live 表出现更新（用 DB 查询或已有 telemetry API 验证）
- Remote 在 command_api_mode=auto 时：
  - /api/edge/v1/commands/poll 返回命令
  - /api/edge/v1/commands/{id}/ack 成功，命令状态更新为 completed/failed
- legacy endpoints 全部仍然可用
- 示例配置 api_url 修正完毕
- 自测脚本能在本地跑通（说明如何设置 env / DB）

现在开始：先扫描代码库中上述文件位置，定位现状 stub，按步骤实现。每完成一块都输出你改动的文件列表、关键 diff 摘要、以及如何手动验证（curl 或脚本命令）。
