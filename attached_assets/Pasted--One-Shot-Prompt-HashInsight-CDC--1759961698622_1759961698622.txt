ğŸŸ¢ One-Shot Prompt â€”â€” HashInsightï¼ˆCDC äº‹ä»¶æ€»çº¿ Â· æœ€ä¼˜è§£ï¼‰

ä½ ç°åœ¨æ‰®æ¼”èµ„æ·±å¹³å°æ¶æ„å¸ˆ + å…¨æ ˆå·¥ç¨‹å¸ˆã€‚
è¯·ä¸€æ¬¡æ€§ç»™å‡ºå®Œæ•´å¯è¿è¡Œçš„é¡¹ç›®ï¼Œä¸è¦å‘æˆ‘æé—®ï¼›ä¸æ˜ç¡®ä¹‹å¤„ç”¨â€œç¨³å¥é»˜è®¤â€ï¼Œå¹¶åœ¨æ–‡æœ«åˆ—å‡ºâ€œå‡è®¾â€ã€‚

èƒŒæ™¯ä¸ç›®æ ‡

å‚è€ƒé¡µé¢ï¼šhttps://calc.hashinsight.net/

ç›®æ ‡ï¼šæŠŠç°æœ‰é¡µé¢/API/æ•°æ®è¡¨ä¸Transactional Outbox â†’ Debezium CDC â†’ Kafkaæ€»çº¿æ‰“é€šï¼Œæ¶ˆè´¹è€…ç”¨Inbox å¹‚ç­‰ + åˆ†å¸ƒå¼é”é‡ç®—æ´¾ç”Ÿè¡¨å¹¶å¤±æ•ˆç¼“å­˜ï¼Œå®ç°P95â‰¤3sçš„â€œå†™åº“åˆ°é¡µé¢å¯è§â€ã€‚

å…³é”®é“¾è·¯ï¼šPOST /api/miners â†’ åŒäº‹åŠ¡å†™ outbox(miner.added) â†’ Debezium æ•è· â†’ Kafka topic(events.miner, key=user_id) â†’ Portfolio-Consumer å¹‚ç­‰é‡ç®— â†’ å¤±æ•ˆ user_portfolio:{uid} â†’ /analytics/main å‘½ä¸­ã€‚

æŠ€æœ¯æ ˆï¼ˆå¿…é¡»ï¼‰

Python 3.10+ / Flask / SQLAlchemy / Pydantic

PostgreSQL 15 + TimescaleDBï¼ˆæ—¶åºè¡¨ï¼‰

Redisï¼ˆç¼“å­˜ + åˆ†å¸ƒå¼é”ï¼‰

Kafkaï¼ˆKRaft æˆ– Zookeeper äºŒé€‰ä¸€ï¼‰ + Kafka Connectï¼ˆDebezium Postgres Sourceï¼‰

kafka-python æˆ– confluent-kafkaï¼ˆæ¶ˆè´¹è€…ï¼‰

Docker Compose ä¸€é”®èµ·å…¨æ ˆï¼›å¯é€‰ Kafka UIã€‚

ç»Ÿä¸€æ—¶åŒºï¼šUTCï¼›å¤šç§Ÿæˆ·é”®ï¼štenant_idï¼›è®¤è¯ï¼šJWT + Scopesï¼›DB å¯ç”¨ RLSã€‚

äº¤ä»˜è¦æ±‚ï¼ˆå…¨éƒ¨å¿…é¡»ç»™å‡ºï¼‰

ç›®å½•ç»“æ„ï¼ˆæ ‘å½¢ï¼‰

docker-compose.yml

servicesï¼šweb(Flask)ã€worker-portfolioã€worker-intel(å ä½)ã€postgres(å¯ç”¨ Timescale)ã€redisã€kafkaã€connect(Debezium)ã€å¯é€‰ kafka-uiã€‚

é¢„åˆ›å»ºä¸»é¢˜ï¼ševents.miner, events.treasury, events.ops, events.crm, events.dlqï¼ˆåˆ†åŒºæ•°ã€ä¿ç•™ç­–ç•¥ï¼‰ã€‚

.env.exampleï¼ˆDATABASE_URL, REDIS_URL, KAFKA_BROKERS, CONNECT_URL, JWT_SECRETâ€¦ï¼‰

æ•°æ®åº“è¿ç§» SQLï¼ˆAlembic æˆ–çº¯ SQLï¼‰

åŸºç¡€è¡¨ï¼šusers, roles, permissions, user_miners, miners, miner_models, inventory, forecast_daily, event_outbox, consumer_inbox, audit_logsã€‚

Timescaleï¼šä¸º miner_telemetry, network_snapshots, forecast_daily å»ºåˆ†åŒºï¼ˆdailyï¼‰ã€‚

Outboxï¼šå¦‚ä¸‹æ³¨é‡Š/ç´¢å¼•ï¼›Inbox å¤åˆä¸»é”®ï¼ˆconsumer_name, event_idï¼‰ã€‚

RLS ç­–ç•¥æ ·ä¾‹ï¼ˆtenant_id = current_setting('app.tenant_id')ï¼‰ã€‚

Flask åº”ç”¨ï¼ˆAPI Gateway + Domain Servicesï¼‰

ç«¯ç‚¹ï¼š

POST /api/minersï¼ˆæ–°å¢çŸ¿æœºï¼Œäº‹åŠ¡å†…æ’å…¥ outboxï¼Œäº‹ä»¶ miner.added å¸¦ idempotency_keyï¼‰

PATCH /api/miners/:id/statusï¼ˆminer.status_changedï¼‰

POST /api/miners/bulkï¼ˆä»…å†™ä¸€æ¡ miner.bulk_imported{count}ï¼‰

GET /api/intelligence/forecastï¼ˆè¯» forecast_dailyï¼ŒSWR ç¼“å­˜ï¼‰

POST /api/treasury/executeï¼ˆtreasury.trade_executed å ä½ï¼‰

GET /api/healthï¼ˆè§æŒ‡æ ‡é¡¹ï¼‰

ç»Ÿä¸€ JWT + Scope ä¸­é—´ä»¶ï¼ˆminers:write, intel:read, treasury:tradeâ€¦ï¼‰

é€Ÿç‡é™åˆ¶ä¸ user_subscriptions èŒƒä¾‹ã€‚

æ‰€æœ‰å†™æ“ä½œå†™å…¥ audit_logsã€‚

æ¯ä¸ªç«¯ç‚¹é™„ curl ç¤ºä¾‹ã€‚

Outbox å†™å…¥é’©å­

SQLAlchemy äº‹åŠ¡æäº¤ç‚¹/æœåŠ¡å±‚å‡½æ•°ï¼šä¸ä¸šåŠ¡å†™å…¥åŒä¸€äº‹åŠ¡æ’å…¥ event_outboxï¼š

CREATE TABLE event_outbox(
  id text PRIMARY KEY,
  kind text NOT NULL,
  user_id text NOT NULL,
  entity_id text,
  payload jsonb NOT NULL,
  idempotency_key text UNIQUE,
  created_at timestamptz NOT NULL DEFAULT now(),
  processed boolean NOT NULL DEFAULT false
);
CREATE INDEX ON event_outbox (processed, created_at);
CREATE INDEX ON event_outbox (user_id, created_at);


Debezium Postgres Source è¿æ¥å™¨é…ç½®ï¼ˆconnectors/outbox.jsonï¼‰

table.include.list=public.event_outbox

transforms=unwrap,routeï¼›message.key.columns=user_idï¼›æŒ‰ kind è·¯ç”±åˆ° events.* ä¸»é¢˜ï¼ˆç¤ºä¾‹é…ç½®å®Œæ•´ JSONï¼‰ã€‚

Kafka æ¶ˆè´¹è€…ï¼ˆPythonï¼‰

workers/portfolio_consumer.pyï¼šè®¢é˜… events.minerï¼Œåˆ†å¸ƒå¼é” lock:recalc:{user_id}ï¼ŒInbox å»é‡ï¼Œè°ƒç”¨ recalc_user_portfolio(user_id)ï¼ŒæˆåŠŸåå¤±æ•ˆ user_portfolio:{uid}ï¼›å¤±è´¥é‡è¯•+å…¥ DLQã€‚

workers/intel_consumer.pyï¼ˆå ä½ï¼‰ï¼šå“åº” miner.* è§¦å‘é¢„æµ‹åˆ·æ–°å†™ forecast_dailyã€‚

é€šç”¨é‡è¯•/å›æ”¾å·¥å…·ï¼ˆæŒ‰æ—¶é—´çª—é‡æ”¾ï¼‰ã€‚

ç¼“å­˜ç­–ç•¥

é”®ï¼šuser_portfolio:{uid}, user_analytics:{uid}, forecast:{uid}, ops_schedule:{uid}:{yyyymmdd}ï¼›SWRï¼šå…ˆå›æ—§å€¼ï¼Œåå°åˆ·æ–°ï¼›TTL ç¤ºä¾‹ï¼ˆportfolio 600s / forecast 1800sï¼‰ã€‚

/api/health æŒ‡æ ‡

outbox_backlog, kafka_consumer_lag(æŒ‰ consumer), dlq_count, forecast_freshness_sec, cache_hit_rate, versionã€‚

Mermaid æ¶æ„å›¾ï¼ˆæ”¾åœ¨ docs/ï¼Œ3 å¼ ï¼šæ€»ä½“æ‹“æ‰‘ã€ç«¯åˆ°ç«¯æ—¶åºã€åˆ†åŸŸ ERï¼‰ã€‚

Makefileï¼ˆmake up/down/logs/migrate/seed/connect/registerï¼‰ä¸READMEï¼ˆå¯åŠ¨æ­¥éª¤ã€éªŒè¯è„šæœ¬ï¼‰ã€‚

éªŒæ”¶è„šæœ¬

å¯åŠ¨ Composeï¼›2) POST /api/minersï¼›3) è§‚å¯Ÿ connector æ—¥å¿—ã€Kafka æ¶ˆè´¹ã€æ¶ˆè´¹è€…æ—¥å¿—ï¼›4) /api/health æŒ‡æ ‡è¾¾æ ‡ï¼›5) GET /analytics/main èƒ½å‘½ä¸­/åˆ·æ–°ã€‚

å®‰å…¨ä¸åˆè§„

KMS/Envelope åŠ å¯†å ä½ï¼ˆçŸ¿æœºå¯†ç /äº¤æ˜“æ‰€ keyï¼‰ï¼›Secret è½®è½¬ç­–ç•¥ï¼›RLS ç¤ºä¾‹ç­–ç•¥ï¼›å®¡è®¡æ—¥å¿—æ ¼å¼ã€‚

å‡è®¾ä¸è¯´æ˜ï¼ˆåˆ—å‡ºé»˜è®¤ç«¯å£ã€é•œåƒã€è´¦å·å¯†ç ã€æ ·ä¾‹æ•°æ®è§„æ¨¡ä¸æ€§èƒ½é¢„æœŸï¼‰ã€‚

è¾“å‡ºæ ¼å¼è¦æ±‚ï¼ˆä¸¥æ ¼éµå®ˆï¼‰

å…ˆç»™é¡¹ç›®ç»“æ„æ ‘ï¼Œéšåé€æ–‡ä»¶è¾“å‡ºï¼›æ¯ä¸ªæ–‡ä»¶ä½¿ç”¨å•ç‹¬ä»£ç å—ï¼Œç¬¬ä¸€è¡Œå†™è·¯å¾„ï¼Œå¦‚ï¼š

# app/api/miners.py
<code...>


ä»£ç å¯å¤åˆ¶å³è·‘ï¼›å…³é”®å¤„é™„ä¸­æ–‡æ³¨é‡Šã€‚

docker-compose.yml ä¸è¿æ¥å™¨ JSON å¿…é¡»å®Œæ•´å¯ç”¨ã€‚

æ¯ä¸ª API ç»™å‡ºæœ€å°‘ 1 æ¡ curl ç¤ºä¾‹ã€‚

æ–‡æœ«é™„ï¼šå¯åŠ¨æ­¥éª¤ï¼ˆä¸€æ­¥æ­¥å‘½ä»¤ï¼‰ + éªŒæ”¶ checklist + å‡è®¾æ¸…å•ã€‚

ä¸è¦çœç•¥æ ¸å¿ƒé€»è¾‘ï¼›ä¸è¦å‘æˆ‘æé—®ï¼›ä¸è¦ç­‰å¾…æˆ‘ç¡®è®¤ã€‚

æŒ‰ä»¥ä¸Šè¦æ±‚ï¼Œç°åœ¨å¼€å§‹å®Œæ•´è¾“å‡ºé¡¹ç›®æ‰€éœ€çš„æ‰€æœ‰æ–‡ä»¶ä¸å†…å®¹ã€‚