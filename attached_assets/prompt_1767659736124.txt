你是“资深比特币矿场 Cloud Control Plane 架构师 + 安全工程师 + Python 后端负责人”。你要在当前仓库基础上做一次性整改（一步到位），目标是让 Cloud 端达到 100MW+ 托管/自营可用，并可通过矿场 PoC 安全审计与功能验收。请直接修改代码并输出可运行结果，不要停留在建议。

========================
A. 不可违背硬约束（Definition of Done）
========================
1) 单一控制面：/api/edge/v1/* 只能有一套实现。不得出现 duplicate route 或两套状态机。
2) 云端不存 IP：数据库、模型、API 响应、日志均不得包含矿机 IP/网段/端口（可保留不可逆 fingerprint/hash）。
3) 云端不存矿机控制凭据：任何 miner 级 credential 只能存在 Edge 本地。Cloud 不读取、不存储、不下发。
4) 审批门禁强制：所有矿机操作必须走审批；托管资产必须由该客户审批（默认单人；高风险/大范围支持二人审批）。
5) Zone 强绑定：Edge device token 必须绑定 (site_id, zone_id)，poll/ingest 不允许通过参数越权访问其他 zone。
6) 价格/需量：支持客户上传 TOU/实时/需量价格（CSV/JSON）并版本化；默认 15-min demand；支持 monthly peak ledger + replay（what-if）可复算。
7) 兼容旧接口：/api/collector/commands/* 仅作为 deprecated adapter，内部代理到 v1 控制面与同一状态机；不得引入第二套模型或 secrets/IP。

========================
B. 你需要先做的“结构收敛”（必须优先完成）
========================
1) 禁用/移除重复 v1 路由：
   - 在 app 初始化/blueprint 注册处，停止注册 api/remote_control_api.py 的 blueprint（或删除其 v1 endpoints）。
   - 保留 api/control_plane_api.py 作为唯一 v1 实现。
   - 你必须确保运行时 Flask route map 中 /api/edge/v1/commands/poll 与 /ack 只有一个 handler。

2) 彻底移除云端 secrets 下发：
   - 删除 remote_control_api.py 中对 MinerSecret 的读取与任何 secrets 下发逻辑。
   - 仓库中如存在 models_device_encryption.MinerSecret / 类似表：从云端路径中剥离，不再被 control plane 引用。
   - 命令 payload 只能包含：action_type、targets(asset_id 列表)、params；不得包含 IP/credential。

3) 彻底移除云端 IP 留存：
   - api/collector_api.py 中的 ip_address 字段与任何写入/回传逻辑必须去掉，或将 collector_api 从 cloud 服务移除（如果必须保留旧接口，则仅通过 legacy adapter 接收旧请求并转换，不入库 IP）。
   - 增加一条测试：任何 endpoint 返回体中不允许出现 "ip" / "ip_address" 字段；任何 model 不允许持久化该字段。

========================
C. 权限与审批（必须做成“买方验收级别”）
========================
1) ABAC 审批规则：
   - 对托管资产（MinerAsset.customer_id != NULL）的命令：
     只能由同 customer_id 的用户 approve/deny；运营方账号不可替客户审批（除非显式实现“客户授权代表 delegation”，并写入审计）。
   - 对自营资产（customer_id == NULL）的命令：
     允许 site owner/ops admin 审批（你需要实现最小可用的角色字段或 site_membership）。
   - 默认：所有 miner 操作 require_approval=True（包括 LED）。

2) 二人审批（可选但必须支持）：
   - 当 risk_tier=HIGH 且 (target_count>N 或 est_kw_impact>X 或 blast_radius>1%) 时，steps_required=2。
   - 第二步审批必须由不同用户完成。
   - 未满足 steps_required 前，命令不得进入 QUEUED，Edge poll 永远拿不到。

3) 状态机统一：
   - Draft/Proposed -> PENDING_APPROVAL -> APPROVED -> QUEUED -> RUNNING -> (SUCCEEDED|FAILED|PARTIAL|EXPIRED)
   - Rollback 也走审批与审计：ROLLBACK_PENDING_APPROVAL -> ROLLING_BACK -> ROLLBACK_DONE/FAILED

========================
D. Edge device auth 与 Zone 强绑定（必须修）
========================
1) EdgeDevice 表必须包含：site_id、zone_id、token_hash、status、last_seen_at。
2) device token 存储必须 hash（不可明文存 token）。
3) require_device_auth 必须：
   - 从 token -> 查 token_hash -> 取 device.site_id 与 device.zone_id，写入 g.site_id 与 g.zone_id。
   - edge poll 不允许使用 query 覆盖 zone_id；如提供 zone_id 仅用于校验必须一致，否则 403。

========================
E. 价格计划 + 需量（PoC 可复算闭环）
========================
1) PricePlanVersion：
   - 上传 CSV/JSON 生成 version_id，记录 effective_from/to、timezone、granularity、missing_data_policy、source_file_hash。
   - payload_json 必须统一 schema（建议 dict），CSV 存为 {"type":"csv","rows":[...], "meta":{...}}。
2) 15-min demand：
   - 从 telemetry(power_w) 或聚合数据计算 15-min demand（窗口最大值）。
   - 写入 DemandLedgerMonthly（peak_kw、peak_window_start/end、price_plan_version_id、source=estimated）。
3) Replay：
   - 输入 month + price_plan_version_id + simulation params（例如 reduction_kw 或 shutdown_pct）。
   - 输出 baseline_peak_kw、new_peak_kw、demand_cost_delta、notes（明确 estimated）。
   - 必须可复算（同输入得到同输出）。

========================
F. 旧接口兼容（只做代理，不引入第二套模型）
========================
1) legacy_adapter.py 的实现必须改为：
   - 将 /api/collector/commands/pending 转换并调用 control_plane 的 v1 poll 逻辑（同一 DB/同一状态机）。
   - 将 /api/collector/commands/{id}/result 转换并调用 control_plane 的 v1 ack 逻辑。
2) legacy adapter 只用于迁移，必须标注 deprecated，并写入审计事件 legacy.*。

========================
G. 测试（pytest，必须全绿）
========================
至少覆盖：
1) 未审批命令 Edge poll 拿不到；审批后才能拿到。
2) 托管客户 A 不能 approve/读取客户 B 的命令与矿机（403）。
3) 非客户身份不能 approve 托管资产命令（403）。
4) 二人审批：第一人审批后仍拿不到；第二人审批后才 QUEUED。
5) zone 越权：Edge token 绑定 zone1，尝试访问 zone2 必须 403。
6) 任何 API 响应体都不包含 "ip"/"ip_address"；DB 模型层不持久化该字段。
7) 不允许 secrets：API 输出不包含 credential/secrets 字段。
8) price plan 上传生成 version；replay 可执行并返回 baseline/new peak。

========================
H. 交付要求
========================
- 给出运行入口（例如 app.py）与 README：如何启动、如何迁移 DB、如何跑测试、curl 示例。
- 启动后 Swagger 或至少 route list 可验证：/api/edge/v1/* 只有一套实现。
- 所有关键路径写入审计：propose/approve/deny/poll/ack/rollback/upload_price/replay。

现在开始执行：
1) 先扫描仓库入口（Flask app 初始化、blueprint 注册）并输出你将保留/移除的模块清单。
2) 然后按上面的顺序直接改代码、补 migrations、补测试。
3) 最后输出：如何 run、pytest 截图/结果摘要、以及一个端到端演示步骤（seed 数据 + curl）。



你是“100MW+ 比特币矿场 Cloud Control Plane 总架构师 + 安全工程师 + Python 后端 Tech Lead”。你要在当前仓库基础上做一次性（一步到位）整改，让 Cloud 端达到矿场买方 PoC 可验收标准，并与 Edge Collector 使用统一 v1 命令协议。你必须直接修改代码，保证可运行、可测试、可演示，不要停在建议层面。

========================================================
0) 目标（Definition of Done，全部必须满足）
========================================================
A. 单一控制面：/api/edge/v1/* 只能有一套实现（不得双路由/双状态机/双模型）。
B. 云端零 IP：数据库模型、API 返回、日志中都不得出现矿机 IP/网段/端口（最多允许不可逆 fingerprint/hash）。
C. 云端零矿机控制凭据：Cloud 不存储、不读取、不下发矿机控制凭据（miner secret/credential）。任何 miner 级 secret 只能存在 Edge 本地。
D. 审批门禁强制：任何矿机操作都必须审批（托管资产必须由客户审批；默认单人，高风险/大范围可选二人审批）。
E. 多 Edge 分区：Edge token 强绑定 (site_id, zone_id)，poll/ingest/ack 全部以 token 绑定为准，禁止用 query 覆盖越权访问其他 zone。
F. 电价/需量：支持客户上传 TOU/实时/需量价格（CSV/JSON）并版本化；默认 15-min demand；必须支持 monthly peak lock-in 与 replay（what-if）可复算。
G. Portal Lite：托管客户只能看到“自己的矿机 + 自己的审批 + 自己的报表”，不能看到站点级摘要。
H. 兼容旧接口：/api/collector/* 仅作为 deprecated adapter（代理到 v1），不得引入第二套控制链路，不得让旧接口把 IP/secret 写入云端。
I. PoC 演示：提供 seed + 一键脚本/curl（propose→approve→poll→ack→audit export）10 分钟内可演示闭环。
J. 工程质量：pytest 全绿；迁移可执行；结构化日志；健康检查；限流背压；幂等去重；敏感字段脱敏。

========================================================
1) 背景/硬约束（不可违背）
========================================================
- 场景：自营 + 托管（Hosting），面向 100MW+，小场也能用。
- 部署：混合（云控+边缘算），多 Edge 分区（机房/集装箱/电力分区），站点级汇聚；云端只做“控制与汇总”。
- 固件优先：Antminer stock、Whatsminer（云端需存 capability probe 结果，用于下发前覆盖率提示）。
- 离线缓存：Edge 可缓存 24h；云端需支持补传延迟标记。
- 数据保留：默认 1 年，可按 site/tenant 调整。
- 替换路径：逐步替换（Overlay→Replace）。

========================================================
2) 必须修复的现状问题（强制）
========================================================
(1) 命令协议双轨：存在 /api/collector/commands/pending + /result 旧风格，以及 /api/edge/v1/commands/poll + /ack 新风格。
    -> 整改后：Cloud 以 /api/edge/v1/* 为唯一标准；旧接口只做代理，标注 deprecated。
(2) 云端矿机导入强制 IP：
    -> 整改后：云端资产导入不含 IP；任何带 ip 字段的输入都必须拒绝/忽略且写审计。
(3) 电价/收益硬编码：
    -> 整改后：必须通过 PricePlanVersion 输入与版本化引用；所有 replay/报告引用 version_id。
(4) 审批门禁必须不可绕过：
    -> Edge poll 永远只能拿到已满足审批要求的命令。

========================================================
3) 技术栈要求
========================================================
- 优先 FastAPI + SQLAlchemy + Alembic + Pydantic + pytest。
- 如果仓库已是 Flask 且改动成本极高，可继续用 Flask，但必须实现同等能力：校验、鉴权、ABAC、限流、结构化日志、测试。
- DB：优先 Postgres；允许 SQLite fallback（开发/测试），但 migrations 必须能跑。

========================================================
4) 数据模型（至少实现这些表，字段可补充但不可少）
========================================================
- Site(site_id, name, timezone, retention_policy_id, created_at)
- Zone(zone_id, site_id, name, type[room/container/power], created_at)
- Customer(customer_id, site_id, name, created_at)  # 托管客户
- EdgeDevice(edge_id, site_id, zone_id, token_hash, status, last_seen_at, created_at)
- MinerAsset(asset_id/miner_id, site_id, zone_id, customer_id(nullable), model, vendor, firmware, tags_json, created_at)  # 不含 IP
- Capability(asset_id, supports_actions_json, detected_at)
- PricePlan(plan_id, site_id, name, created_at)
- PricePlanVersion(version_id, plan_id, effective_from, effective_to, timezone, granularity, missing_data_policy, source_file_hash, payload_json, created_by, created_at)
- DemandLedgerMonthly(id, site_id, month(YYYY-MM), peak_kw, peak_window_start, peak_window_end, source(est/measured), price_plan_version_id, created_at)
- Command(command_id, site_id, zone_id, created_by, created_by_customer_id(nullable), action_type, risk_tier, payload_json, ttl_seconds, target_count, est_kw_impact, blast_radius_est, steps_required, status, created_at, updated_at)
- CommandTarget(command_id, asset_id)
- CommandApproval(approval_id, command_id, approver_user_id, approver_customer_id(nullable), decision[approve/deny], reason, step(1/2), decided_at)
- CommandResult(result_id, command_id, asset_id, edge_id, status, before_snapshot_json, after_snapshot_json, error_code, error_message, started_at, finished_at)
- Delegation(delegation_id, customer_id, delegate_user_id, scopes_json, valid_from, valid_to, revoked_at, created_at)  # 客户授权代表（可选但建议实现）
- AuditEvent(event_id, site_id, actor_type[user/edge/system], actor_id, event_type, ref_id, payload_json, created_at, prev_hash, event_hash) # append-only hash chain
- RetentionPolicy(policy_id, audit_days, telemetry_days, billing_days, ticket_days, created_at)

严格禁止：任何模型/表字段包含 ip / ip_address / credential / secret / password 等。

========================================================
5) API（必须实现）
========================================================
5.1 Edge-facing（仅 Edge）
- POST /api/edge/v1/register
- GET  /api/edge/v1/commands/poll
  规则：只返回 status=QUEUED 且审批门禁满足的命令；必须按 token 绑定的 (site_id, zone_id) 过滤
- POST /api/edge/v1/commands/{command_id}/ack
  规则：幂等；重复 ack 不重复推进状态机；记录 per-asset 结果
- POST /api/edge/v1/telemetry/ingest
  规则：支持补传延迟标记（client_timestamp vs received_at），不得含 IP 字段

5.2 User-facing（Ops/客户/Portal）
- POST /api/v1/auth/login (JWT)
- POST /api/v1/commands/propose
- POST /api/v1/commands/{id}/approve (step=1/2)
- POST /api/v1/commands/{id}/deny
- POST /api/v1/commands/{id}/rollback (必须走审批策略)
- GET  /api/v1/commands/{id}
- GET  /api/v1/commands?site_id=&zone_id=&status=
- POST /api/v1/price-plans/upload (CSV/JSON -> version_id)
- GET  /api/v1/price-plans/{plan_id}/versions
- GET  /api/v1/demand/monthly-ledger?site_id=&month=
- POST /api/v1/demand/replay
- Portal Lite（ABAC 强隔离）：
  - GET  /api/v1/portal/my-miners
  - GET  /api/v1/portal/my-approvals
  - POST /api/v1/portal/approvals/{command_id}/approve
  - POST /api/v1/portal/approvals/{command_id}/deny
  - GET  /api/v1/portal/my-reports
- 审计导出：
  - GET /api/v1/audit/export?site_id=&from=&to= （JSON/CSV，至少 JSON）

5.3 Deprecated 兼容（仅代理到 v1，禁止写入 IP/secret）
- GET  /api/collector/commands/pending -> 代理到 v1 poll（内部转换）
- POST /api/collector/commands/{id}/result -> 代理到 v1 ack

========================================================
6) 审批与风险分级（必须实现到可验收）
========================================================
- 所有 miner 操作 require_approval=true（包括 LED/低风险动作）
- 托管资产（MinerAsset.customer_id != null）：
  - approve/deny 只能由该 customer 的用户执行
  - 或者存在 Delegation（客户授权代表）且在有效期内、scope 覆盖动作
- 自营资产（customer_id == null）：site owner/ops admin 可审批
- 二人审批触发（默认可配置）：
  risk_tier=HIGH 且 (target_count>N 或 est_kw_impact>X 或 blast_radius_est>1% ) => steps_required=2
  step=2 必须由不同用户完成
- 命令状态机（统一）：
  PROPOSED -> PENDING_APPROVAL -> APPROVED -> QUEUED -> RUNNING -> SUCCEEDED/FAILED/PARTIAL/EXPIRED
  ROLLBACK_* 同理，且写审计

========================================================
7) 15-min Demand + 月度峰值锁定 + Replay（必须可复算）
========================================================
- Demand 口径：15-min window max kW（基于 telemetry power_w 聚合）
- Monthly peak ledger：每月记录 peak_kw 与 window，关联 price_plan_version_id
- Replay：
  输入：month + price_plan_version_id + simulation_params（如 reduction_kw 或 shutdown_pct 或 schedule_shift）
  输出：baseline_peak_kw、new_peak_kw、demand_cost_delta、assumptions、version_refs
  必须可复算（同输入同输出）

========================================================
8) 幂等、限流、可观测性、脱敏（必须实现）
========================================================
8.1 幂等
- approve/deny：用 (command_id, approver_user_id, step) 唯一约束或幂等键，避免重复记录
- ack：用 (command_id, asset_id) 唯一约束，重复写入变为 update/no-op
- price upload：用 source_file_hash + effective window 约束避免重复版本（或返回已有版本）

8.2 限流/背压
- 对 poll/ack/telemetry 做 per-edge 限流（例如 X req/min），对 user-facing 做 per-user 限流
- 请求体大小限制（防止超大批量压垮服务）
- 超载返回 429/503 并给 retry-after

8.3 可观测性
- /healthz：检查 DB、时钟、关键依赖
- 结构化 JSON 日志：必须含 request_id、site_id、zone_id、edge_id、command_id（有则写）
- 指标：poll QPS、ack latency、审批耗时、403 次数、命令成功率（可用 Prometheus 或简单 /metrics）

8.4 脱敏
- 写日志前对 payload 做 redaction：token/secret/password/ip/worker_name
- 确保异常栈不会打印敏感字段

========================================================
9) PoC 演示与脚本（必须交付）
========================================================
- seed 脚本：创建 1 Site、2 Zone、2 Customer、若干 MinerAsset、1 EdgeDevice、1 price plan version
- scripts/demo.sh：
  1) propose（托管客户的命令）
  2) 客户 approve（单人/二人两种场景）
  3) edge poll 拿命令
  4) edge ack 回传结果
  5) audit export 导出证据包
- 提供 postman_collection.json 或 curl 示例写在 README

========================================================
10) 测试（pytest，必须全绿）
========================================================
必须覆盖：
1) 未审批命令 edge poll 拿不到；审批后拿到
2) 客户 A 不能读取/审批客户 B 命令与资产（403）
3) 非客户身份不能审批托管资产命令（403）
4) 二人审批：第一人后仍不可执行；第二人后才 QUEUED
5) zone 越权：edge token 绑定 zone1，访问 zone2 -> 403
6) 响应体不含 ip/ip_address；DB 不含 ip 字段（写一个 test grep response keys）
7) 响应体不含 secrets/credentials
8) price plan 上传生成 version；replay 返回 baseline/new peak 且可复算
9) deprecated adapter 能代理成功且写入 legacy.* 审计事件

========================================================
11) 执行顺序（必须按顺序做）
========================================================
Step 1：扫描仓库入口，列出框架与 blueprint/router 注册，确保 /api/edge/v1/* 只保留一套实现（删除/停用重复的）。
Step 2：建立/修正 models + migrations（Alembic），并清理任何 ip/secret 字段与路径。
Step 3：实现鉴权（JWT + Edge token hash）+ ABAC + Delegation（可选但建议）。
Step 4：实现命令状态机 + 审批门禁 + poll/ack 幂等与审计。
Step 5：实现 price upload/version + missing policy 存储；修正 payload schema 一致性。
Step 6：实现 15-min demand + monthly ledger + replay。
Step 7：实现 Portal Lite API + 报表导出（先 JSON/CSV）。
Step 8：实现 deprecated adapter endpoints（只做代理，且审计 legacy.*）。
Step 9：加入限流、/healthz、/metrics、结构化日志、redaction。
Step 10：写 seed + demo.sh + README；写 pytest 并跑通全绿。

========================================================
12) 交付要求
========================================================
- 一键启动：replit run 可启动服务
- migrations 可执行
- pytest 全绿
- demo.sh 可跑通闭环
- route map 中 /api/edge/v1/commands/poll 与 /ack 仅一个 handler
- 全局保证：零 IP、零 miner secret

现在开始：先输出你发现的项目结构与计划（保留哪些模块，移除/停用哪些重复实现），然后直接改代码实现上述全部要求，最后给出：
1) 如何启动
2) 如何迁移 DB
3) 如何跑 pytest
4) 如何运行 demo.sh
5) 关键端点示例 curl

