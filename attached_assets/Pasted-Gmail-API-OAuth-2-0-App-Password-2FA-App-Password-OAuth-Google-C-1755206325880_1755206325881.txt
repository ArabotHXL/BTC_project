Gmail API（OAuth 2.0，无需 App Password）

适用：不想开 2FA/不想存 App Password，希望可控的 OAuth 方式。

一次性准备

在 Google Cloud Console 创建项目 → 启用 Gmail API

配置 OAuth 同意屏幕（External）

创建 OAuth Client（Web/桌面均可），拿到 CLIENT_ID/CLIENT_SECRET

用授权流程获取 refresh_token（需要 scope：https://www.googleapis.com/auth/gmail.send，并勾选 access_type=offline）

Node.js（googleapis + users.messages.send）

import { google } from 'googleapis';
import { createMimeMessage } from 'mimetext'; // 或自己拼MIME并base64url

const oAuth2Client = new google.auth.OAuth2(
  process.env.GOOGLE_CLIENT_ID,
  process.env.GOOGLE_CLIENT_SECRET,
  process.env.OAUTH_REDIRECT_URI // 获取refresh_token时用；发送阶段可不需
);
oAuth2Client.setCredentials({ refresh_token: process.env.GMAIL_REFRESH_TOKEN });

function buildRaw(from, to, subject, html, text) {
  // 也可手写MIME并做 base64url
  const msg = createMimeMessage();
  msg.setSender(from);
  msg.setTo(to);
  msg.setSubject(subject);
  msg.addMessage({ contentType: 'text/plain', data: text });
  msg.addMessage({ contentType: 'text/html', data: html });
  return Buffer.from(msg.asRaw()).toString('base64url'); // Gmail 要 base64url
}

export async function sendVerify(to, link) {
  const gmail = google.gmail({ version: 'v1', auth: oAuth2Client });
  const from = process.env.GMAIL_USER; // 你的gmail
  const subject = 'Verify your email';
  const text = `请打开此链接完成验证：${link}`;
  const html = `
    <p>点击下面按钮完成邮箱验证：</p>
    <p><a href="${link}" style="padding:10px 16px;background:#2f6fed;color:#fff;text-decoration:none;border-radius:6px;">验证邮箱</a></p>
    <p>若无法点击，请复制到浏览器：<br>${link}</p>`;
  const raw = buildRaw(from, to, subject, html, text);

  await gmail.users.messages.send({
    userId: 'me',
    requestBody: { raw }
  });
}


Python（google-api-python-client）

import base64, os
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from google.oauth2.credentials import Credentials
from googleapiclient.discovery import build

def send_verify(to, link):
    creds = Credentials(
        None,
        refresh_token=os.environ["GMAIL_REFRESH_TOKEN"],
        token_uri="https://oauth2.googleapis.com/token",
        client_id=os.environ["GOOGLE_CLIENT_ID"],
        client_secret=os.environ["GOOGLE_CLIENT_SECRET"]
    )
    service = build("gmail", "v1", credentials=creds)

    msg = MIMEMultipart("alternative")
    msg["From"] = os.environ["GMAIL_USER"]
    msg["To"] = to
    msg["Subject"] = "Verify your email"

    text = f"请打开此链接完成验证：{link}"
    html = f"""<p>点击下面按钮完成邮箱验证：</p>
               <p><a href="{link}" style="padding:10px 16px;background:#2f6fed;color:#fff;text-decoration:none;border-radius:6px;">验证邮箱</a></p>
               <p>若无法点击，请复制到浏览器：<br>{link}</p>"""
    msg.attach(MIMEText(text, "plain", "utf-8"))
    msg.attach(MIMEText(html, "html", "utf-8"))

    raw = base64.urlsafe_b64encode(msg.as_bytes()).decode("utf-8")
    service.users().messages().send(userId="me", body={"raw": raw}).execute()


要点

第一次拿 refresh_token 时，授权 URL 要包含 access_type=offline，并请求 gmail.send scope。

个人 Gmail 不能用服务账号直接代发；Workspace 才能做域内委派。

限额与 SMTP 大致接近，仍不适合大批量。

验证邮件的“后端三件套”

无论走 SMTP 还是 API，你还需要：

生成一次性短效 token（JWT 推荐，exp 15–60 分钟）

邮件正文放验证链接：https://your-app.com/verify?token=...

点击回调：校验 token → 标记 email_verified=true → 使 token 失效（单次使用