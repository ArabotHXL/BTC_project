【跨模块联动扩展 | Multi-Module Federation】
在前述 CRM 重设计与实现的基础上，新增“平台级一体化（Platform of Record + System of Engagement）”，要求一次性给出**可运行的最小实现 + 完整文档**，并与 CRM **双向打通**。请严格按以下目录补充新章节与代码。

A) 模块清单与边界（Bounded Contexts）
为每个模块给出：核心对象、读写归属（Source of Truth）、入/出站接口、与 CRM 的耦合点。
1. Marketing Automation（市场自动化）：Campaign、Audience、Journey、UTM、Email/SMS 模板。
2. Service Desk / ITSM（客服与工单）：Ticket、SLA、知识库（KB）、CSAT、RMA/返修。
3. Project & Delivery（交付与项目）：Milestone、Gantt、资源日历、变更单、风险/问题登记。
4. Asset & Inventory（资产与库存）：MinerAsset、SparePart、Batch/Shipment、仓位、SN 批量导入。
5. Billing & ERP（计费与会计）：Invoice、Payment、A/R、应收账龄、总账分录占位；对接 QuickBooks/Xero。
6. Procurement & Logistics（采购与物流）：PO、Vendor、报价单、物流轨迹、清关文档。
7. Monitoring & Alerts（监控与告警）：矿池/设备指标、告警路由、抑制、值班表、OpsTicket 联动。
8. Energy & PPA（能源与电价）：PowerContract、TOU 费率、需量/基本费、EnergyRateSnapshot 固化。
9. ROI Engine（收益测算）：BTC 价格/难度/网络算力/区块奖励实时 API，占位 calc.hashinsight.net Webhook。
10. Client Portal（客户门户）：订单/资产/告警/账单自助查看与电子签、下载对账单。
11. Compliance & KYC（合规与认证）：KYC 档案、访问审计、保留/删除策略、证据哈希锚定（L2 占位）。
12. Data Warehouse & BI（数仓与分析）：星型模型、维度/事实、ETL/CDC、物化视图、指标口径。
13. IAM / SSO（身份与权限）：OIDC/OAuth2、RBAC、字段级/记录级权限、审计轨迹。

B) 集成模式与基础设施
- 同步：API Gateway（REST + GraphQL 读取聚合），统一鉴权与速率限制。
- 异步：事件总线（Kafka/NATS 任选其一），Outbox + CDC（Debezium 占位）保证**至少一次**投递；幂等键。
- 数据契约：OpenAPI（同步）、AsyncAPI（事件）；版本化与兼容策略（向后兼容优先）。
- ID 策略：UUIDv7/ULID，全局主键 Snowflake 兼容；多租户（tenant_id）与软删除。
- 观测：结构化日志（JSON）、指标（Prometheus 占位）、分布式追踪（W3C Trace Context）。

C) 事件目录（Event Catalog | 至少 24 个）
为每一类事件给出：用途、Schema（AsyncAPI 片段 + JSON 示例）、触发源、幂等键、重放策略、订阅方。至少包含：
LeadCaptured、LeadScored、DealStageChanged、ContractSigned、DepositReceived、InventoryReserved、ShipmentArrived、
SNBatchImported、MinerProvisioned、MinerOnline/Offline、AlertRaised、OpsTicketOpened/Closed、CurtailmentDeclared、
EnergyRateFrozen、InvoiceIssued、PaymentReceived、KYCApproved、DocSigned、ROIQuoted、POCreated、VendorQuoted、
ProjectMilestoneReached、RenewalPlaybookTriggered。

D) 对接层（Integration Adapters）
- Email/Calendar：Gmail/Outlook 双向同步，占位 OAuth 流程与 Webhook。
- 电子签：DocuSign/PandaDoc 占位端点（回填签署状态与链接）。
- 会计：QuickBooks/Xero 双向（发票/回款/科目映射）；示例映射表与同步作业（CRON/队列）。
- 矿池/监控：ViaBTC/BTC.com/矿机管理平台占位；指标拉取与告警阈值策略；异常样例。
- calc.hashinsight.net：表单 → /webhooks/intake，签名校验、重放保护、字段映射（Lead/Deal）。
- （可选）/mnt/data 包适配器占位：`mining_core_package.tar.gz`、`web3_integration_package.tar.gz`、`user_management_package.tar.gz` 的
  Adapter 接口（假设导出核心服务：MiningCore、Web3Bridge、UserAdmin）；给出 TypeScript 接口与依赖注入样例。

E) 数据模型扩展与仓库
- 为新增模块补齐 Postgres DDL（含外键/索引/唯一约束/检查约束）；审计表（audit_log）追加对象类型与变更原因。
- 数仓层：维度（客户、站点、设备、时间、费率）与事实（商机、交付、告警、能耗、计费、回款）；物化视图与刷新策略。
- 指标口径字典：在线率、MTTA/MTTR、限电影响小时、订金转化、A/R 天数、单 MW 毛利/净利、续约率。

F) 前端与门户
- 管理台新增：多模块导航、跨对象联动视图（如从 Deal 直达 Onboarding、OpsTicket、Invoice）。
- 客户门户（React+Tailwind 示例）：登录、资产清单、告警列表、账单与回款、合同与证据、下载报表；中英双语。
- 权限：客户仅可见自身租户数据；导出 CSV/PDF（示例实现）。

G) 自动化剧本（再补充 ≥10 条）
在原有 20 条基础上，增加跨模块动作：如“ContractSigned→InventoryReserved→ProjectCreated→Milestones seeded”；
“AlertRaised(severity=critical)→OpsTicket→值班轮值@mention→客户门户推送”；“CurtailmentDeclared→受影响资产清单→计费侧创建调整项”。

H) 部署与运维
- docker-compose 扩展：event-bus、gateway、worker（队列消费者）、pgadmin、nginx（静态门户）。
- 环境变量与密钥示例（.env.sample 补充第三方对接密钥占位）。
- 备份/还原脚本更新；多服务健康检查；滚动升级/回滚说明。

I) 迁移与并行切换
- 旧 CRM 与各外部系统字段映射模板（CSV）；清洗规则（如电话/邮箱/地址规范化）。
- 并行运行 2–4 周的核对清单与抽样对账 SQL；回退策略（只读开关 + 双写关停步骤）。

J) 验收与 SLO（跨模块）
- 端到端用例扩充至 ≥50 条（含：网站留资→报价→合同→上电→告警→计费→回款→续约）。
- SLO：同步 API P95 < 300ms、异步端到端 ≤ 5s、事件丢失 0（可重放），RPO≤24h，RTO≤4h。
- 安全：字段级访问控制回归用例，审计日志抽样验证（≥100 条）。

== 产出物要求 ==
在原目录后**追加新章节与代码**，覆盖：更新后的系统蓝图、ERD、OpenAPI & AsyncAPI、Postgres DDL、事件消费者样例、前端页面示例、docker-compose 扩展、迁移脚本与验收清单。所有新增接口给出示例请求/响应（中文+English），事件给出 JSON 示例。确保一次回复内完整可复制运行。
