你是一个资深安全架构师 + 全栈工程师。请在 Replit 里创建一个可直接运行的“企业级安全演示 Demo”，项目名：HashInsight Secure Miner Onboarding Demo。

一、核心目标（必须实现）
做一个全栈 Web UI + API 的演示系统，展示我在矿场系统里对“矿机接入 + IP/凭证保护 + 设备端执行”的完整安全链路。必须覆盖：

1) 三种 IP 隐藏策略（Site 级别配置）
- Mode 1: UI Masking（明文存储 + UI脱敏 + RBAC + 审计）
- Mode 2: Server Envelope Encryption（服务器端 Envelope，加密存储；服务器可在受控条件下解密）
- Mode 3: Device Envelope E2EE（服务器永不见明文，IP/凭证只对授权 Edge Device 可解密）

2) “Site → Miner → Credential Blob” 数据结构
- 不只是 IP：还要演示“矿机访问凭证包”（Credential Blob），例如：
  - ip
  - port（默认 4028）
  - miner_type（Antminer / Whatsminer 等字符串即可）
  - api_username/api_password（可选）
  - tags（如 rack/pdu/circuit 归属）
- 该 Credential Blob 必须与 IP 一起受相同模式保护（Mode 1/2/3 对应不同保护方式）

3) Device Envelope Encryption + 单调计数器 anti-rollback（关键验收点）
- 每个 Site 可以授权多个 Edge Device（每个 device 有 libsodium X25519 keypair）
- 当 Site 处于 Mode 3 时：
  - 浏览器端生成“Device Envelope”：
    - payload = credential_blob_json
    - counter = monotonic integer（每次更新 +1）
    - envelope = crypto_box_seal(payload_with_counter, device_public_key)
  - 服务器仅存 E2EE:... 的 sealed box 密文，绝不接触明文
- 当 Edge 解密时（用 demo 的 /api/edge/decrypt 模拟）必须校验：
  - counter 不能小于该 miner 上次已接受的 counter（防回滚）
  - 若低于，拒绝并记审计事件 “ANTI_ROLLBACK_REJECT”

4) 审计日志必须是“不可篡改演示”（hash chain）
- audit_events 表必须包含：
  - prev_hash
  - event_hash = sha256(prev_hash + event_json_canonical)
- UI 显示“审计链验证状态”（verify ok / broken）
- 每个敏感动作必须写审计：CREATE_SITE / CHANGE_MODE / DISCOVERY_SCAN / CREATE_MINER / UPDATE_CREDENTIAL / REVEAL / REGISTER_DEVICE / REVOKE_DEVICE / EDGE_DECRYPT / ANTI_ROLLBACK_REJECT / BATCH_MIGRATE

5) 网段发现 + 自动接入闭环（可演示）
- UI 输入 CIDR（例如 192.168.1.0/24）
- 后端执行 discovery（可以是真扫描，也可以 demo 模拟；但必须有可重复结果）
- discovery 输出“候选矿机”列表（IP、端口、指纹）
- 用户点击“接入（Onboard）”：
  - Mode 1/2：可以提交明文 credential_blob 给服务器处理
  - Mode 3：必须前端加密后提交（服务器禁止接收明文 credential）
- 接入成功后 miner 出现在 miner 列表，并可展示其“保护状态”

二、技术栈（严格遵循，避免复杂构建）
- Backend: Python FastAPI + Uvicorn
- DB: SQLite（SQLAlchemy 或 sqlite3 均可，但结构必须清晰）
- Frontend: 单页 HTML + 原生 JS（可 Jinja2 渲染）
- Crypto:
  - 前端：libsodium-wrappers（CDN）用于 sealed box
  - 后端：cryptography.Fernet 用于 Mode 2 的数据加密
  - 后端：hashlib.sha256 用于审计链 hash
- 端口：0.0.0.0:3000

三、Key Management 设计（Demo 版，但要像生产系统）
Mode 2 的 Server Envelope Encryption 必须实现“主密钥 + 站点数据密钥 DEK”的结构：
- MASTER_KEY：从 env 的 SESSION_SECRET + MASTER_SALT 使用 PBKDF2HMAC 派生（length=32, iterations=100000, sha256）
- 每个 Site 生成一个随机 DEK（32 bytes），用 MASTER_KEY 加密后存储到 sites.site_dek_wrapped
- 实际数据（ip/credential）用该 Site 的 DEK（经派生为 Fernet key）加密，存 ENC: 前缀

Mode 3 的 Device Envelope E2EE：
- 服务器只存 device_public_key_b64
- 服务器不得保存 device_secret_key（但为了 demo 模拟 Edge decrypt，可允许在“仅 demo 开关”下保存 secret；必须在 UI 和代码注释里明确标注“生产禁用”）
- sealed box 存 E2EE: 前缀

四、数据库模型（SQLite）
1) tenants
- id, name

2) sites
- id, tenant_id, name
- ip_mode (1/2/3)
- site_dek_wrapped (nullable; Mode2 used)
- created_at, updated_at

3) miners
- id, tenant_id, site_id
- name
- credential_value    # 明文 JSON 或 ENC:... 或 E2EE:...
- credential_mode     # 1/2/3
- fingerprint         # 对 Mode1/2 可服务器生成；对 Mode3 由客户端提交
- last_accepted_counter (int default 0)   # anti-rollback
- created_at, updated_at

4) devices
- id, tenant_id, site_id
- device_name
- public_key_b64
- secret_key_b64 (nullable; demo only)
- device_token
- status (ACTIVE/REVOKED)
- created_at

5) audit_events（hash chain）
- id, tenant_id, site_id
- actor, role
- event_type
- target_type, target_id
- detail_json
- prev_hash
- event_hash
- created_at

五、后端 API（必须实现）
基础：
- GET  /                              -> UI
- GET  /api/tenants                   -> 列 tenants
- POST /api/tenants                   -> admin
- GET  /api/sites?tenant_id=          -> 列 sites
- POST /api/sites                     -> admin: {tenant_id, name, ip_mode}
- GET  /api/sites/{site_id}/settings  -> 当前 mode、device 列表摘要
- POST /api/sites/{site_id}/settings  -> admin: {ip_mode}

矿机与凭证：
- GET  /api/miners?site_id=           -> 列 miners（返回 display 状态）
- POST /api/miners                    -> 创建 miner
  - Mode 1/2 可接受 credential_plaintext_json
  - Mode 3 禁止接受明文：仅接受 credential_e2ee_b64 + counter + device_id
- POST /api/miners/{id}/reveal        -> admin：
  - Mode1: 直接返回明文 JSON
  - Mode2: 解密返回明文 JSON（必须要求 reason 字段）
  - Mode3: 返回“server cannot reveal E2EE”
- POST /api/miners/{id}/update-credential -> 更新凭证（同上规则）
- POST /api/miners/batch-migrate      -> admin：按 site 当前 mode 迁移该 site 下所有 miners
  - 从 1->2：服务器加密
  - 从 2->1：服务器解密回明文
  - 从 1/2->3：要求指定 device_id，并由前端对每个 miner 重新加密（可采用“前端批量迁移”流程：后端提供明文导出仅对 admin + 临时 token；如果实现复杂，至少支持“逐个迁移”）
  - 从 3->1/2：不可逆（除非通过 Edge 解密再导回），因此 API 应提示需要 Edge 导出流程；记录审计

设备管理：
- POST /api/devices/register -> admin: {tenant_id, site_id, device_name, public_key_b64, secret_key_b64(optional demo)}
- GET  /api/devices?site_id= -> 列 devices
- POST /api/devices/{id}/revoke -> admin

Discovery：
- POST /api/discovery/scan -> admin: {site_id, cidr, ports:[4028,22], simulate:true|false}
  -> 返回 candidates [{ip, port, fingerprint, vendor_hint}]
- POST /api/discovery/onboard -> admin:
  - Mode1/2: {site_id, name, credential_plaintext_json}
  - Mode3: {site_id, name, credential_e2ee_b64, device_id, counter, fingerprint}

Edge 模拟：
- POST /api/edge/decrypt -> 使用 device_token：
  - 输入 {miner_id, ciphertext_b64}
  - 输出 {credential_plaintext_json}
  - 同时做 anti-rollback 校验：
    - 如果 counter <= last_accepted_counter: reject + audit ANTI_ROLLBACK_REJECT
    - 否则更新 last_accepted_counter + audit EDGE_DECRYPT_OK
  - 说明：必须在注释中强调“生产环境 Edge 解密在设备侧本地进行，服务器不保存 secret_key”

审计：
- GET /api/audit?site_id= -> 最近 N 条
- GET /api/audit/verify?site_id= -> 返回 verify_ok true/false + first_broken_event_id

六、权限与认证（简化，但必须可用）
- Header 模拟：
  - X-Role: admin|viewer（默认 viewer）
  - X-Actor: 任意
- viewer：只能看列表与 display
- admin：可设置 mode、reveal、设备注册/撤销、discovery、onboard、迁移、edge decrypt

七、前端 UI（单页，中文默认 + 英文切换）
必须有以下区块（每块都能实际操作）：
1) Tenant/Site 选择
2) Site Security Settings
- 当前模式展示 + 切换（admin）
- 解释三种模式的差异（简短）
- “Batch migrate”（admin）
3) Discovery（CIDR 扫描）
- 输入 CIDR、选择 simulate/real
- 显示 candidates 表格 + “Onboard” 按钮
4) Miner List
- name / protected status / display_credential / last_counter / actions
- actions：Reveal（admin+reason）、Update Credential、Edge Decrypt（Mode3）、Revoke（可选）
5) Device Management
- 浏览器端生成 keypair（libsodium）
- 注册设备（admin）并显示 device_token（只显示一次）
- 列表 + revoke
6) Audit Log + Audit Chain Verify 状态灯
- 显示 verify 结果、最近事件

八、显示与脱敏规则（必须一致）
- Mode1：
  - viewer：显示 credential 的 ip 字段为 192.168.xxx.xxx，其他字段用 ***（例如 password）
  - admin：列表也可以默认脱敏，但可点 Reveal 查看全量
- Mode2：
  - viewer：显示 “[Server Encrypted]”
  - admin：同上，Reveal 才解密展示；必须记录 reason
- Mode3：
  - 全部显示 “[E2EE Protected]”
  - 只能通过 Edge decrypt 展示明文（并触发 anti-rollback）

九、文件结构（必须生成）
- main.py
- db.py
- services/
  - ip_credential_service.py        # 负责 Mode1/2/3 的存取、display、迁移
  - envelope_kms_service.py         # MasterKey/DEK wrap/unwrap（demo KMS）
  - audit_service.py                # hash chain append + verify
  - discovery_service.py            # simulate/real scan
- templates/index.html
- static/app.js
- static/style.css
- requirements.txt
- .env.example
- README.md（含运行说明与安全说明）

十、运行方式（必须可直接跑）
- pip install -r requirements.txt
- python main.py （或 uvicorn main:app --host 0.0.0.0 --port 3000）
- 打开页面即可使用，无需前端构建

十一、验收用例（你必须自测并保证可完成）
1) 创建 tenant/site，切换 Mode1/Mode2/Mode3
2) Mode1 扫描 + onboard + viewer 看脱敏，admin reveal 看明文（写审计）
3) Mode2 扫描 + onboard 后 DB 存 ENC:；admin reveal 需 reason；审计链 verify OK
4) 注册 device，切换 Mode3，onboard 时只能提交 E2EE
5) Edge decrypt 成功后 last_accepted_counter 更新；再次用更低 counter 解密必须被拒绝并记录 ANTI_ROLLBACK_REJECT
6) 任意篡改一条 audit_events.detail_json（可在代码里提供一个 debug endpoint 或手工说明），verify 必须能检测 broken

现在开始生成完整项目代码与文件，并确保在 Replit 环境中可以一键运行。
