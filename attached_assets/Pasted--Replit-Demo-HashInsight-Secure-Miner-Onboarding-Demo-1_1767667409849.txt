你是一个资深安全架构师 + 全栈工程师。请在 Replit 里创建一个可直接运行的“企业级安全演示 Demo”，项目名：HashInsight Secure Miner Onboarding Demo (ABAC + Guarded Approval)。

一、核心目标（必须实现）
做一个全栈 Web UI + API 的演示系统，展示“矿机接入 + IP/凭证保护 + 设备端执行 + ABAC + 审批流”的完整安全闭环。必须覆盖：

A) 三种 IP/凭证保护策略（Site 级别配置）
1) Mode 1: UI Masking（明文存储 + UI脱敏 + RBAC/ABAC + 审计）
2) Mode 2: Server Envelope Encryption（服务器 Envelope 加密存储；服务器在受控审批后可解密）
3) Mode 3: Device Envelope E2EE（服务器永不见明文，IP/凭证只对授权 Edge Device 可解密）

B) “Site → Miner → Credential Blob” 数据结构
- credential_blob_json 包含：
  - ip
  - port（默认 4028）
  - miner_type（Antminer / Whatsminer 等）
  - api_username/api_password（可选）
  - tags（rack/pdu/circuit 等）
- 该 Credential Blob 必须与 IP 一起受同一模式保护（Mode1/2/3）

C) Device Envelope Encryption + anti-rollback（关键验收点）
- Site 可授权多个 Edge Device（libsodium X25519 keypair）
- 当 Site 处于 Mode 3：
  - 浏览器端生成“Device Envelope”：
    - payload = credential_blob_json
    - counter = monotonic integer（每次更新 +1）
    - sealed = crypto_box_seal(payload_with_counter, device_public_key)
  - 服务器仅存 E2EE:... 密文，绝不接触明文
- Edge 解密（用 demo 的 /api/edge/decrypt 模拟）必须校验：
  - counter 不能小于或等于该 miner 上次已接受 counter（防回滚）
  - 若违反，拒绝并记审计事件 “ANTI_ROLLBACK_REJECT”

D) 审计日志必须是“不可篡改演示”（hash chain）
- audit_events 表必须包含：
  - prev_hash
  - event_hash = sha256(prev_hash + canonical_event_json)
- UI 显示“审计链验证状态”（verify ok / broken）
- 每个敏感动作必须写审计：CREATE_SITE / CHANGE_MODE_REQUEST / CHANGE_MODE_APPROVE / CHANGE_MODE_EXECUTE / DISCOVERY_SCAN / CREATE_MINER / UPDATE_CREDENTIAL_REQUEST / UPDATE_CREDENTIAL_EXECUTE / REVEAL_REQUEST / REVEAL_APPROVE / REVEAL_EXECUTE / REGISTER_DEVICE / REVOKE_DEVICE / EDGE_DECRYPT / ANTI_ROLLBACK_REJECT / BATCH_MIGRATE_REQUEST / BATCH_MIGRATE_EXECUTE / POLICY_DENY

E) 网段发现 + 自动接入闭环（可演示）
- UI 输入 CIDR（例如 192.168.1.0/24）
- 后端执行 discovery（可模拟，但必须稳定可重复）
- 输出 candidates 列表（ip、port、fingerprint、vendor_hint）
- 用户点击“接入 Onboard”：
  - Mode 1/2：可提交明文 credential_blob 给服务器
  - Mode 3：必须前端加密后提交（服务器禁止接受明文 credential）
- 接入成功后 miner 出现在列表，并可显示其“保护状态”

二、必须新增：ABAC（属性访问控制，强制落地）
你必须实现 ABAC，覆盖所有 API 的数据隔离与敏感动作授权。要求：

1) Actor（操作者）模型：每次请求都要有 actor 身份与属性
- Header 模拟（默认 viewer）：
  - X-Actor: string
  - X-Role: owner|admin|operator|viewer
  - X-Tenant: tenant_id（或 tenant_name）
  - X-Site: site_id（可选；若未给，则按 actor 可见范围返回）
- 系统内部必须维护 actors 表（可在 UI 创建/管理）：
  - actor_id, name, role
  - tenant_id
  - allowed_site_ids（可存 JSON list）
  - attributes_json（如 department, region, oncall, clearance 等）
  - api_token（可选，demo 用）

2) ABAC 规则（最少实现这些“硬规则”，并在代码里集中管理）
- RULE-1：所有读写操作必须 tenant 级隔离：actor.tenant_id 必须匹配目标资源 tenant_id，否则 deny（记录 POLICY_DENY 审计）
- RULE-2：site 级隔离：若资源属于某 site，则 actor.allowed_site_ids 必须包含该 site，否则 deny
- RULE-3：敏感动作（Reveal / ChangeMode / BatchMigrate / Mode2 解密）必须要求 actor.role in {owner, admin} 且通过审批流（见下一节）
- RULE-4：Discovery Scan/Onboard 允许 operator 执行，但必须在其 allowed_site_ids 范围内
- RULE-5：Mode3 的 Edge decrypt 只允许携带 device_token 的请求，且 device 必须 ACTIVE 且属于同 tenant/site；同时遵循 anti-rollback

3) 策略引擎实现方式
- 在 services/policy_service.py 中实现 evaluate(action, actor, resource) -> allow/deny + reason
- 所有 API 入口必须调用该 evaluate（FastAPI dependency / middleware 均可）
- deny 时返回 403，并把 deny reason 写入 audit（POLICY_DENY）

三、必须新增：Guarded Approval（审批流 + 双人复核 + 受控执行）
你必须实现一个可操作的审批工作流，用于高风险动作。要求：

1) 审批对象 Change Request（CR）
- 每个高风险动作必须先创建 CR，再由“不同的人”批准，最后执行：
  - REVEAL_CREDENTIAL（Mode1/2 reveal）
  - CHANGE_SITE_MODE（切换 Mode 1/2/3）
  - BATCH_MIGRATE（批量迁移）
  - DEVICE_REVOKE（撤销设备，若你认为也应高风险）
  - OPTIONAL：UPDATE_CREDENTIAL（若开启“强治理模式”，可以要求更新也走审批；至少要支持可配置）
- CR 状态：DRAFT -> PENDING -> APPROVED -> EXECUTED / REJECTED / EXPIRED
- 必须支持有效期：例如 PENDING 超过 30 分钟自动 EXPIRED（demo 里可用服务端定时检查或执行时检查）

2) 双人复核（Four-Eyes）
- 执行高风险动作必须满足：
  - requester != approver（必须是不同 actor）
  - approver.role in {owner, admin}
  - requester.role in {owner, admin, operator}（按动作可更严格）
- 执行时再校验一次 ABAC（避免批准后资源变更导致越权）

3) CR 的内容必须包含“可审计的最小必要信息”
- request_type
- target_type / target_id（site/miner/device）
- requested_action_json（例如 mode 从 2 -> 3；或 reveal 哪个字段/全量）
- reason（必须填写）
- created_at, expires_at
- approvals（支持至少 1 个批准；扩展到 2 个也可以，但不是硬性）
- execution_result_json（执行后写入）

4) 受控执行（Guarded Execution）
- 所有高风险 API 不得直接执行真实动作：
  - 必须拆成：POST /api/changes（创建） -> POST /api/changes/{id}/approve -> POST /api/changes/{id}/execute
- 执行成功后写入审计 CHANGE_*_EXECUTE，并把结果写入 CR
- 执行失败也要写审计（含失败原因）

四、技术栈（严格遵循）
- Backend: Python FastAPI + Uvicorn
- DB: SQLite（建议 SQLAlchemy）
- Frontend: 单页 HTML + 原生 JS（可 Jinja2 渲染）
- Crypto:
  - 前端：libsodium-wrappers（CDN）用于 sealed box（Mode3）
  - 后端：cryptography.Fernet 用于 Mode2（Envelope）
  - 后端：hashlib.sha256 用于审计链 hash
- 端口：0.0.0.0:3000

五、Key Management（Mode2 的 Envelope）
Mode 2 必须实现“主密钥 + 站点 DEK wrap/unwrap”结构：
- MASTER_KEY：从 env 的 SESSION_SECRET + MASTER_SALT 使用 PBKDF2HMAC 派生（length=32, iterations=100000, sha256）
- 每个 Site 生成随机 DEK（32 bytes），用 MASTER_KEY 加密后存储 sites.site_dek_wrapped
- 实际数据用 Site 的 DEK 派生为 Fernet key 加密，存 ENC: 前缀

Mode 3 的 Device E2EE：
- 服务器只存 device_public_key_b64
- 服务器不得保存 device_secret_key（但为了 demo 的 edge decrypt，可允许“DEMO_ALLOW_STORE_DEVICE_SECRET=true”时存；必须在 UI 与 README 强提醒“生产禁用”）
- sealed box 存 E2EE: 前缀

六、数据库模型（SQLite，必须创建）
1) tenants
- id, name

2) actors（用于 ABAC）
- id, tenant_id
- actor_name
- role (owner/admin/operator/viewer)
- allowed_site_ids_json
- attributes_json
- api_token (optional)
- created_at

3) sites
- id, tenant_id, name
- ip_mode (1/2/3)
- site_dek_wrapped (nullable; Mode2 used)
- created_at, updated_at

4) miners
- id, tenant_id, site_id
- name
- credential_value (plain JSON or ENC:... or E2EE:...)
- credential_mode (1/2/3)
- fingerprint
- last_accepted_counter (int default 0)
- created_at, updated_at

5) devices
- id, tenant_id, site_id
- device_name
- public_key_b64
- secret_key_b64 (nullable; demo only)
- device_token
- status (ACTIVE/REVOKED)
- created_at

6) change_requests（审批流）
- id, tenant_id, site_id (nullable if tenant-level)
- request_type (REVEAL_CREDENTIAL/CHANGE_SITE_MODE/BATCH_MIGRATE/DEVICE_REVOKE/UPDATE_CREDENTIAL)
- target_type, target_id
- requested_action_json
- reason
- status (DRAFT/PENDING/APPROVED/EXECUTED/REJECTED/EXPIRED)
- requester_actor_id
- approver_actor_id (nullable)
- created_at
- expires_at
- executed_at
- execution_result_json

7) audit_events（hash chain）
- id, tenant_id, site_id
- actor_id, actor_name, role
- event_type
- target_type, target_id
- detail_json
- prev_hash
- event_hash
- created_at

七、后端 API（必须实现）
基础：
- GET  / -> UI
- CRUD tenants（可简化）
- CRUD actors（至少支持创建 actor、设置 allowed_site_ids、生成/展示 token）

ABAC helper：
- GET /api/whoami -> 返回 actor 解析结果（来自 header 或 token）

Site：
- GET  /api/sites (自动按 ABAC 过滤)
- POST /api/sites (owner/admin)
- GET  /api/sites/{site_id}/settings (ABAC)
- 注意：切换 mode 不再直接 POST settings 执行，而是走 change request（见 changes）

Miner：
- GET  /api/miners?site_id= (按 ABAC)
- POST /api/miners (Mode1/2 可明文；Mode3 仅允许 E2EE)
- Reveal/Update/Migrate 不直接执行：必须走 change requests

Discovery：
- POST /api/discovery/scan (operator+ 且 ABAC site allow)
- POST /api/discovery/onboard (operator+ 且 ABAC)

Devices：
- POST /api/devices/register (admin+ 且 ABAC)
- GET  /api/devices?site_id= (ABAC)
- Revoke 若设为高风险：走 changes；否则也可直接，但必须审计

Changes（审批流核心）：
- POST /api/changes
  - body: {tenant_id, site_id, request_type, target_type, target_id, requested_action_json, reason}
  - 创建后置为 PENDING（或先 DRAFT 再提交也行，但 UI 必须可操作）
- POST /api/changes/{id}/approve
  - 只能 admin/owner，且 approver != requester；并做 ABAC 校验
- POST /api/changes/{id}/reject
- POST /api/changes/{id}/execute
  - 必须已 APPROVED 且未过期；并再次 ABAC 校验；执行真实动作（mode change / reveal / migrate / update / revoke）
  - 执行后写 audit + 写 execution_result_json

Reveal（通过 changes 执行的语义）：
- 对 Mode1：返回明文 JSON（但必须记录 reason，来自 CR）
- 对 Mode2：解密返回明文 JSON（必须审批通过）
- 对 Mode3：返回 “server cannot reveal E2EE”（即使审批通过也不行），并建议使用 Edge decrypt

Edge 模拟：
- POST /api/edge/decrypt (使用 device_token；ABAC & device ACTIVE 校验；anti-rollback)
  - input {miner_id}
  - server 读取 miner.credential_value（E2EE）并用 device_secret_key_b64（demo only）解密
  - 校验 counter > last_accepted_counter，否则拒绝并审计 ANTI_ROLLBACK_REJECT
  - 成功则更新 last_accepted_counter 并审计 EDGE_DECRYPT_OK，返回明文

Audit：
- GET /api/audit?site_id=
- GET /api/audit/verify?site_id=

八、前端 UI（单页，中文默认 + 英文切换）
必须新增区块：
1) Actor & ABAC Panel（关键）
- 创建/选择当前 actor（或输入 headers 模拟）
- 设置 allowed sites
- 显示当前 actor 的可见 site 列表
- 所有列表按 ABAC 自动过滤（让用户直观看到隔离效果）

2) Change Queue（审批队列）
- 列出 PENDING / APPROVED / EXECUTED / REJECTED / EXPIRED
- 支持 Create / Approve / Reject / Execute
- 清晰显示 requester 与 approver（必须不同）
- 高风险动作按钮（Change mode / Reveal / Batch migrate / Update credential）点击后不是直接执行，而是弹窗创建 CR（填写 reason、requested_action_json）

3) 其他区块沿用 V1：
- Tenant/Site
- Site Security Settings（展示 mode；切换走 CR）
- Discovery（scan + onboard）
- Miner List（actions 走 CR；Mode3 用 Edge decrypt）
- Device Management
- Audit Log + Verify

九、显示与脱敏规则（必须一致）
- Mode1：viewer 显示 ip 192.168.xxx.xxx，password ***；admin 列表仍默认脱敏，需 CR+Execute 才 reveal 全量
- Mode2：viewer 显示 [Server Encrypted]；admin 需 CR 审批后 execute 才解密展示
- Mode3：显示 [E2EE Protected]；任何角色都不能 server reveal；只能 Edge decrypt

十、文件结构（必须生成）
- main.py
- db.py
- services/
  - policy_service.py               # ABAC evaluate
  - ip_credential_service.py        # Mode1/2/3 存取、display、迁移
  - envelope_kms_service.py         # MASTER_KEY/DEK wrap/unwrap
  - change_request_service.py       # CR create/approve/execute + four-eyes
  - audit_service.py                # hash chain append + verify
  - discovery_service.py
- templates/index.html
- static/app.js
- static/style.css
- requirements.txt
- .env.example
- README.md（必须包含：ABAC 规则说明、审批流说明、Mode3 生产禁用 secret 存储说明）

十一、运行方式（必须可直接跑）
- pip install -r requirements.txt
- python main.py（或 uvicorn main:app --host 0.0.0.0 --port 3000）
- 打开页面即可使用，无需前端构建

十二、验收用例（你必须自测并保证可完成）
1) 创建 tenant + 两个 site；创建两个 actor：Alice(admin, allowed_site=[siteA])、Bob(admin, allowed_site=[siteA])、Eve(viewer, allowed_site=[siteB])
2) Alice 只能看到 siteA 的 miners/devices；Eve 只能看到 siteB（ABAC 生效）
3) Alice 发起 CHANGE_SITE_MODE 的 CR（siteA: 1->2），Bob approve，Alice 或 Bob execute（四眼规则：approve 不能是 requester）
4) Mode2 下 Alice 想 reveal 某 miner：先创建 REVEAL_CREDENTIAL CR（必须填写 reason），Bob approve，然后 execute 返回明文；审计链 verify OK
5) 切换到 Mode3 后 onboard 时服务器拒绝明文 credential；必须前端 E2EE 提交
6) Edge decrypt 成功更新 last_accepted_counter；再次尝试用旧 counter 触发 ANTI_ROLLBACK_REJECT
7) 篡改 audit_events 任意一条 detail_json 后，/verify 必须检测 broken

现在开始生成完整项目代码与文件，并确保在 Replit 环境中可以一键运行。
