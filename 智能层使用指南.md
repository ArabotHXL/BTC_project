# 智能层使用指南

## 📖 简介

智能层是一个自动化分析系统，当您的挖矿数据发生变化时，它会自动帮您：
- 预测未来 BTC 价格和挖矿难度
- 检测异常情况（算力下降、电费异常等）
- 优化限电方案，降低电费成本
- 分析投资回报率（ROI）的影响因素

**核心特点**：数据变化时自动触发，无需手动操作！

---

## 🚀 快速开始

### 1. 系统会自动工作
当您执行以下操作时，智能层会自动启动分析：
- ✅ 添加新矿机
- ✅ 修改矿机参数（算力、功率、电费等）
- ✅ 删除矿机

系统会在后台自动计算，几分钟后就能看到结果。

### 2. 查看分析结果
可以通过 API 接口获取各种分析结果（下文有详细示例）。

---

## 📊 四大核心功能

### 1️⃣ 智能预测（Forecast）

**功能**：预测未来 7-30 天的 BTC 价格和挖矿难度

**使用方法**：
```bash
# 获取用户 ID 为 1 的预测数据
curl -X GET "http://your-domain.com/api/intelligence/forecast/1" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**返回数据示例**：
```json
{
  "user_id": 1,
  "forecast_days": 30,
  "predictions": [
    {
      "date": "2025-10-07",
      "btc_price_predicted": 126500.00,
      "btc_price_lower": 122000.00,
      "btc_price_upper": 131000.00,
      "difficulty_predicted": 152000000000000,
      "difficulty_lower": 150000000000000,
      "difficulty_upper": 154000000000000
    }
  ],
  "model_metrics": {
    "rmse": 1250.50,
    "mae": 980.25
  }
}
```

**解读**：
- `btc_price_predicted`：预测的 BTC 价格
- `btc_price_lower/upper`：95% 置信区间（价格可能在这个范围内）
- `difficulty_predicted`：预测的挖矿难度
- `rmse/mae`：模型准确度指标（数值越小越准确）

---

### 2️⃣ 异常检测（Anomaly Detection）

**功能**：自动监控算力、功耗、ROI 异常情况

**触发条件**：
- 算力突然下降超过 20%
- 功耗异常升高
- ROI 低于预期

**严重等级**：
- 🟢 **低（LOW）**：轻微波动，建议关注
- 🟡 **中（MEDIUM）**：明显异常，需要检查
- 🟠 **高（HIGH）**：严重异常，尽快处理
- 🔴 **严重（CRITICAL）**：紧急情况，立即处理

**查看异常记录**：
系统检测到异常会自动记录，您可以在日志或数据库中查询。

---

### 3️⃣ 电力优化（Power Optimizer）

**功能**：计算最优限电方案，降低电费成本

**使用场景**：
- 电费在不同时段价格不同（峰谷电价）
- 需要在保证收益的前提下降低成本

**使用方法**：
```bash
# 提交优化请求
curl -X POST "http://your-domain.com/api/intelligence/optimize/curtailment" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": 1,
    "target_date": "2025-10-07",
    "electricity_prices": {
      "00:00": 0.08,
      "01:00": 0.08,
      "06:00": 0.12,
      "12:00": 0.15,
      "18:00": 0.12,
      "22:00": 0.08
    }
  }'
```

**返回数据示例**：
```json
{
  "user_id": 1,
  "date": "2025-10-07",
  "schedule": [
    {
      "hour": 0,
      "curtailment_percent": 0,
      "reason": "低谷电价，全力运行"
    },
    {
      "hour": 12,
      "curtailment_percent": 30,
      "reason": "高峰电价，建议限电 30%"
    }
  ],
  "savings": {
    "cost_reduction": 1250.00,
    "power_saved_kwh": 850.5
  }
}
```

**解读**：
- `curtailment_percent`：建议限电百分比（0 = 全力运行，100 = 完全停机）
- `cost_reduction`：预计节省的电费（美元）
- `power_saved_kwh`：节省的电量（千瓦时）

---

### 4️⃣ ROI 解释器（ROI Explainer）

**功能**：分析哪些因素对投资回报影响最大

**使用方法**：
```bash
# 获取用户 ID 为 1 的 ROI 分析
curl -X GET "http://your-domain.com/api/intelligence/explain/roi/1" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**返回数据示例**：
```json
{
  "user_id": 1,
  "current_roi_percent": 18.5,
  "factors": [
    {
      "factor": "BTC 价格",
      "impact_percent": 45.2,
      "recommendation": "BTC 价格是最大影响因素，建议关注市场走势"
    },
    {
      "factor": "挖矿难度",
      "impact_percent": 28.3,
      "recommendation": "难度上升会降低收益，建议提前规划"
    },
    {
      "factor": "电费成本",
      "impact_percent": 18.5,
      "recommendation": "优化限电策略可节省电费"
    },
    {
      "factor": "开机率",
      "impact_percent": 8.0,
      "recommendation": "保持高开机率可提升收益"
    }
  ],
  "actionable_insights": [
    "如果 BTC 价格上涨 10%，ROI 将提升至 23.2%",
    "优化限电方案可节省 12% 电费，ROI 提升至 20.1%",
    "维持 95% 以上开机率可确保稳定收益"
  ]
}
```

**解读**：
- `impact_percent`：该因素对 ROI 的影响占比
- `recommendation`：针对该因素的优化建议
- `actionable_insights`：可执行的具体改进方案

---

## 🔧 系统健康检查

**功能**：查看智能层系统运行状态

**使用方法**：
```bash
curl -X GET "http://your-domain.com/api/intelligence/health"
```

**返回数据示例**：
```json
{
  "status": "healthy",
  "timestamp": "2025-10-06T21:47:29Z",
  "metrics": {
    "outbox_backlog": 2,
    "event_failures_24h": 0,
    "avg_forecast_latency_sec": 3.2,
    "max_forecast_latency_sec": 8.5,
    "optimization_count_24h": 15,
    "avg_optimization_runtime_ms": 450.2
  },
  "components": {
    "database": "connected",
    "cache": "degraded",
    "worker_queue": "operational"
  }
}
```

**状态说明**：
- ✅ **healthy**：系统运行正常
- ⚠️ **degraded**：部分功能降级但仍可用
- ❌ **unhealthy**：系统故障，需要检查

---

## ⚙️ 高级配置

### 1. 自定义预测周期
```bash
# 预测 7 天
curl -X GET "http://your-domain.com/api/intelligence/forecast/1?days=7"

# 预测 30 天
curl -X GET "http://your-domain.com/api/intelligence/forecast/1?days=30"
```

### 2. 批量查询多个用户
可以编写脚本循环调用 API：
```bash
for user_id in 1 2 3 4 5; do
  curl -X GET "http://your-domain.com/api/intelligence/forecast/$user_id" \
    -H "Authorization: Bearer YOUR_API_KEY"
done
```

### 3. 设置告警阈值
异常检测的阈值可以在代码中自定义：
- 算力异常：默认 20% 波动
- ROI 异常：默认低于历史平均 15%
- 功耗异常：默认超过额定功率 10%

---

## 🔐 API 认证

所有 API 接口都需要身份验证，支持三种方式：

### 方法 1：API Key（推荐）
```bash
curl -H "Authorization: Bearer YOUR_API_KEY" \
  http://your-domain.com/api/intelligence/forecast/1
```

### 方法 2：Session Cookie
登录后自动获得 session，可以直接访问。

### 方法 3：JWT Token
```bash
curl -H "X-API-Key: YOUR_JWT_TOKEN" \
  http://your-domain.com/api/intelligence/forecast/1
```

---

## 📝 常见问题

### Q1: 为什么我看不到预测数据？
**A**: 系统需要先收集足够的历史数据（至少 30 天）才能生成预测。新添加的矿机可能需要等待几天。

### Q2: 异常检测多久运行一次？
**A**: 每次数据变化时自动运行，无需手动触发。

### Q3: 优化方案是实时的吗？
**A**: 是的，提交优化请求后通常在 30 秒内得到结果。

### Q4: 如何查看历史分析记录？
**A**: 所有分析结果都存储在数据库中，可以通过查询相应的表获取：
- `forecast_daily`：预测数据
- `ops_schedule`：优化方案
- `event_outbox`：事件记录

### Q5: 系统支持多少用户？
**A**: 支持无限用户，每个用户的数据独立分析，互不影响。

### Q6: 出错了怎么办？
**A**: 
1. 检查 `/api/intelligence/health` 查看系统状态
2. 查看应用日志中的错误信息
3. 确认 API 认证信息正确
4. 确保数据库和 Redis 正常运行

---

## 🎯 使用建议

### 1. 日常运维
- ✅ 每天查看一次健康检查状态
- ✅ 关注异常检测告警
- ✅ 定期查看 ROI 分析，优化策略

### 2. 成本优化
- ✅ 使用电力优化功能，根据峰谷电价调整运行策略
- ✅ 结合预测数据，提前规划算力部署

### 3. 风险管理
- ✅ 监控 BTC 价格预测的置信区间
- ✅ 关注难度预测，评估未来收益变化
- ✅ 设置异常告警阈值，及时发现问题

---

## 📞 技术支持

如有问题，请查看：
1. 系统日志：`/tmp/logs/`
2. 健康检查：`/api/intelligence/health`
3. 项目文档：`replit.md`

---

**最后更新**：2025-10-06  
**版本**：1.0.0  
**适用系统**：BTC Mining Calculator - Intelligence Layer
