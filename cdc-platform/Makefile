.PHONY: help up down logs migrate seed connect register test health clean

# é»˜è®¤ç›®æ ‡
help:
	@echo "HashInsight CDC Platform - Makefile Commands"
	@echo "=============================================="
	@echo "  make up          - å¯åŠ¨æ‰€æœ‰æœåŠ¡"
	@echo "  make down        - åœæ­¢æ‰€æœ‰æœåŠ¡"
	@echo "  make logs        - æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—"
	@echo "  make migrate     - è¿è¡Œæ•°æ®åº“è¿ç§»"
	@echo "  make seed        - å¡«å……æµ‹è¯•æ•°æ®"
	@echo "  make connect     - æ£€æŸ¥Kafka ConnectçŠ¶æ€"
	@echo "  make register    - æ³¨å†ŒDebeziumè¿æ¥å™¨"
	@echo "  make test        - è¿è¡ŒéªŒæ”¶æµ‹è¯•"
	@echo "  make health      - æ£€æŸ¥ç³»ç»Ÿå¥åº·"
	@echo "  make clean       - æ¸…ç†æ‰€æœ‰æ•°æ®å’Œå®¹å™¨"
	@echo ""

# å¯åŠ¨æ‰€æœ‰æœåŠ¡
up:
	@echo "ğŸš€ å¯åŠ¨CDCå¹³å°..."
	docker-compose up -d
	@echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
	@sleep 10
	@echo "âœ… æœåŠ¡å·²å¯åŠ¨ï¼"
	@make health

# åœæ­¢æ‰€æœ‰æœåŠ¡
down:
	@echo "ğŸ›‘ åœæ­¢CDCå¹³å°..."
	docker-compose down
	@echo "âœ… å·²åœæ­¢"

# æŸ¥çœ‹æ—¥å¿—
logs:
	docker-compose logs -f

# æ•°æ®åº“è¿ç§»
migrate:
	@echo "ğŸ“Š è¿è¡Œæ•°æ®åº“è¿ç§»..."
	docker-compose exec postgres psql -U hashinsight -d hashinsight -f /docker-entrypoint-initdb.d/001_cdc_foundation.sql
	@echo "âœ… è¿ç§»å®Œæˆ"

# å¡«å……æµ‹è¯•æ•°æ®
seed:
	@echo "ğŸŒ± å¡«å……æµ‹è¯•æ•°æ®..."
	docker-compose exec web python scripts/seed_data.py
	@echo "âœ… æ•°æ®å·²å¡«å……"

# æ£€æŸ¥Kafka Connect
connect:
	@echo "ğŸ”Œ æ£€æŸ¥Kafka ConnectçŠ¶æ€..."
	@curl -s http://localhost:8083/ | jq '.'
	@echo ""
	@curl -s http://localhost:8083/connectors | jq '.'

# æ³¨å†ŒDebeziumè¿æ¥å™¨
register:
	@echo "ğŸ“¡ æ³¨å†ŒDebezium Outboxè¿æ¥å™¨..."
	@curl -X POST -H "Content-Type: application/json" \
		--data @connectors/outbox-connector.json \
		http://localhost:8083/connectors
	@echo ""
	@echo "âœ… è¿æ¥å™¨å·²æ³¨å†Œ"
	@sleep 3
	@make connect

# éªŒæ”¶æµ‹è¯•
test:
	@echo "ğŸ§ª è¿è¡ŒéªŒæ”¶æµ‹è¯•..."
	@bash scripts/acceptance_test.sh

# å¥åº·æ£€æŸ¥
health:
	@echo "ğŸ¥ ç³»ç»Ÿå¥åº·æ£€æŸ¥..."
	@echo "PostgreSQL: "
	@docker-compose exec postgres pg_isready -U hashinsight || echo "âŒ å¤±è´¥"
	@echo ""
	@echo "Redis: "
	@docker-compose exec redis redis-cli ping || echo "âŒ å¤±è´¥"
	@echo ""
	@echo "Kafka: "
	@docker-compose exec kafka kafka-broker-api-versions --bootstrap-server localhost:9092 > /dev/null 2>&1 && echo "âœ… OK" || echo "âŒ å¤±è´¥"
	@echo ""
	@echo "Kafka Connect: "
	@curl -s http://localhost:8083/connectors | jq 'length' | xargs echo "è¿æ¥å™¨æ•°é‡: " || echo "âŒ å¤±è´¥"
	@echo ""
	@echo "Web API: "
	@curl -s http://localhost:5000/api/health | jq '.status' || echo "âŒ å¤±è´¥"

# æ¸…ç†æ‰€æœ‰æ•°æ®
clean:
	@echo "ğŸ—‘ï¸  æ¸…ç†æ‰€æœ‰æ•°æ®..."
	docker-compose down -v
	@echo "âœ… å·²æ¸…ç†"
