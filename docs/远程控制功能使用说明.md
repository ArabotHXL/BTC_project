# Edge Collector 远程控制功能使用说明

## 概述

本文档详细说明 HashInsight Cloud 的边缘采集器远程控制功能如何工作，以及如何正确使用这些功能。该系统专为 20MW+ 大型矿场设计，确保命令执行的可靠性、安全性和可审计性。

---

## 目录

1. [系统架构](#系统架构)
2. [核心功能说明](#核心功能说明)
3. [API 使用指南](#api-使用指南)
4. [安全机制](#安全机制)
5. [故障处理](#故障处理)
6. [配置参数](#配置参数)
7. [常见问题](#常见问题)

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                         HashInsight Cloud                        │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 命令调度器   │  │  速率限制器  │  │     Prometheus 指标     │  │
│  │ (Dispatcher) │  │ (Rate Limit) │  │      (/metrics)         │  │
│  └──────┬──────┘  └──────┬──────┘  └─────────────────────────┘  │
│         │                │                                       │
│  ┌──────▼────────────────▼──────┐                               │
│  │       控制平面 API            │                               │
│  │  /api/edge/v1/commands/*     │                               │
│  └──────────────┬───────────────┘                               │
└─────────────────┼───────────────────────────────────────────────┘
                  │ HTTPS + HMAC 签名
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Edge Collector (矿场)                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐  │
│  │ 命令轮询器   │  │  命令执行器  │  │     安全事件上报        │  │
│  │   (Poll)    │  │  (Executor)  │  │   (Safety Events)       │  │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 核心功能说明

### 1. 原子化租约派发 (Atomic Lease Dispatch)

**什么是原子化租约？**

当多个采集器同时轮询命令时，系统确保每条命令只被一个采集器获取执行，避免重复执行。

**工作原理：**

1. 采集器调用 `GET /api/edge/v1/commands/poll` 获取待执行命令
2. Cloud 使用数据库锁 (`SELECT FOR UPDATE SKIP LOCKED`) 原子获取命令
3. 获取成功后，设置 60 秒租约 (`lease_until`)
4. 其他采集器无法获取已被租约锁定的命令

**好处：**
- ✅ 防止多个采集器重复执行同一命令
- ✅ 租约超时自动恢复，不会死锁
- ✅ 支持高并发场景

---

### 2. 幂等确认 (Idempotent ACK)

**什么是幂等确认？**

采集器可以多次发送同一命令的确认（ACK），系统只处理第一次，后续重复确认不会改变状态。

**工作原理：**

1. 每次 ACK 计算哈希值：`ack_hash = SHA256(command_id + status + result_code + message)`
2. 如果哈希值与之前相同，返回 `{"replayed": true}` 不改变状态
3. 命令进入终态（成功/失败/过期）后，拒绝新的 ACK

**使用场景：**
- 网络不稳定时采集器可能重复发送 ACK
- 采集器重启后重新上报历史 ACK
- 确保命令状态一致性

---

### 3. 指数退避重试 (Exponential Backoff Retry)

**什么是指数退避？**

命令执行失败后，系统自动重试，每次重试间隔时间翻倍。

**计算公式：**
```
下次重试时间 = 当前时间 + 基础间隔 × 2^重试次数
```

**示例：**
- 基础间隔 = 30 秒
- 第1次重试：30 × 2¹ = 60 秒后
- 第2次重试：30 × 2² = 120 秒后
- 第3次重试：30 × 2³ = 240 秒后

**配置参数：**
- `retry_backoff_sec`: 基础退避间隔（默认 30 秒）
- `max_retries`: 最大重试次数（默认 3 次）

---

### 4. 速率限制 (Rate Limiting)

**什么是速率限制？**

限制每个站点每种命令类型的执行频率，防止命令泛滥和意外操作。

**默认限制：**

| 命令类型 | 限制次数 | 时间窗口 |
|---------|---------|---------|
| `MINER_RESTART` | 5 次 | 5 分钟 |
| `DEVICE_REBOOT` | 5 次 | 5 分钟 |
| `HASHING_DISABLE` | 10 次 | 5 分钟 |
| 其他命令 | 20 次 | 1 分钟 |

**触发限制时：**
- 返回 HTTP 429 错误码
- 响应包含 `error_code: "RATE_LIMITED"`
- 命令不会被执行

---

### 5. 命令去重 (Deduplication)

**什么是命令去重？**

自动化规则触发的命令使用去重键（dedupe_key），防止短时间内重复触发相同命令。

**去重键生成：**
```
dedupe_key = SHA256(规则ID + 矿机ID + 动作类型 + 触发类型)[:32]
```

**工作原理：**
- 数据库有唯一索引，相同 dedupe_key 的活跃命令只能存在一条
- 冷却期内重复触发的命令被自动拦截
- 记录审计事件 `RULE_DEDUPED`

---

### 6. HMAC 签名验证 (可选)

**什么是 HMAC 签名？**

Cloud 对每条命令生成加密签名，采集器可验证命令来源和完整性。

**签名过程：**

1. Cloud 使用规范化 JSON 格式组装签名数据：
   ```json
   {
     "command_id": "cmd_123",
     "command_type": "MINER_RESTART",
     "dedupe_key": null,
     "expires_at": "2026-01-18T12:00:00Z",
     "miner_id": 1001,
     "nonce": "uuid-v4",
     "params": {},
     "priority": 0,
     "signed_at": "2026-01-18T10:00:00Z",
     "site_id": 42,
     "zone_id": 5
   }
   ```

2. 使用 HMAC-SHA256 算法和设备密钥生成签名

3. 采集器收到命令后可重新计算签名验证

**启用方式：**
```bash
export ENABLE_COMMAND_SIGNATURE=true
```

---

### 7. 安全事件上报 (Safety Events)

**什么是安全事件？**

采集器检测到紧急情况（如过热）时，自动执行本地保护动作并上报 Cloud。

**支持的安全事件类型：**

| 事件类型 | 说明 |
|---------|------|
| `THERMAL_SHUTDOWN` | 温度过高紧急关机 |
| `EMERGENCY_STOP` | 手动紧急停止 |
| `POWER_LIMIT` | 功率超限 |
| `FAN_FAILURE` | 风扇故障 |

**上报接口：**
```
POST /api/edge/v1/events/safety/batch
```

---

## API 使用指南

### 获取待执行命令

```bash
# 轮询命令
curl -H "Authorization: Bearer $DEVICE_TOKEN" \
     "https://cloud.example.com/api/edge/v1/commands/poll?limit=10"
```

**响应示例：**
```json
{
  "commands": [
    {
      "command_id": "cmd_abc123",
      "site_id": 42,
      "zone_id": 5,
      "miner_id": 1001,
      "command_type": "MINER_RESTART",
      "params": {"reason": "scheduled_maintenance"},
      "priority": 0,
      "expires_at": "2026-01-18T12:00:00Z",
      "nonce": "f47ac10b-58cc-4372-a567-0e02b2c3d479",
      "signature": "a1b2c3d4...",
      "sig_version": "HMAC-SHA256-CANONICAL-JSON-V1",
      "sig_encoding": "hex"
    }
  ],
  "miner_command_count": 1,
  "remote_command_count": 0
}
```

---

### 确认命令执行

```bash
# 命令执行成功
curl -X POST \
     -H "Authorization: Bearer $DEVICE_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "status": "succeeded",
       "result_code": 0,
       "message": "Miner restarted successfully",
       "executed_at": "2026-01-18T10:05:00Z"
     }' \
     "https://cloud.example.com/api/edge/v1/commands/cmd_abc123/ack"
```

**状态值说明：**

| 状态 | 说明 |
|------|------|
| `succeeded` | 命令执行成功 |
| `failed` | 命令执行失败（会自动重试） |
| `deferred` | 命令延迟执行 |
| `rejected` | 命令被拒绝 |

---

### 上报安全事件

```bash
curl -X POST \
     -H "Authorization: Bearer $DEVICE_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "events": [
         {
           "miner_id": 1001,
           "action": "THERMAL_SHUTDOWN",
           "reason": "Temperature exceeded 95C threshold",
           "temp_max": 98.5,
           "ts": "2026-01-18T10:30:00Z",
           "snapshot_json": {
             "hashrate": 100.5,
             "fan_speed": 100,
             "power_draw": 3200
           }
         }
       ]
     }' \
     "https://cloud.example.com/api/edge/v1/events/safety/batch"
```

---

## 安全机制

### 1. 设备认证

每个 Edge Collector 使用唯一的 Bearer Token 进行认证：

```
Authorization: Bearer <device_token>
```

- Token 与站点绑定，只能访问授权站点的命令
- Token 可在管理界面重新生成

### 2. 区域隔离 (Zone Partitioning)

- 每个设备分配到特定区域 (zone_id)
- 设备只能获取和执行所属区域的命令
- 跨区域访问被自动拒绝

### 3. 审计日志

所有操作自动记录审计日志：

| 事件类型 | 说明 |
|---------|------|
| `command.dispatched` | 命令已派发 |
| `command.acked` | 命令已确认 |
| `command.failed` | 命令执行失败 |
| `command.expired` | 命令已过期 |
| `safety.event.*` | 安全事件上报 |

---

## 故障处理

### 问题：命令获取返回空

**可能原因：**
1. 没有待执行命令
2. 所有命令已被其他采集器获取（租约锁定）
3. 设备 Token 无效或区域不匹配

**解决方法：**
1. 检查管理界面是否有待执行命令
2. 等待租约超时（60秒）后重试
3. 验证设备 Token 和区域配置

---

### 问题：ACK 返回 409 错误

**错误信息：** `ACK_NOT_LEASE_OWNER`

**原因：** 设备尝试确认未获得租约的命令

**解决方法：**
1. 确保在租约有效期内发送 ACK
2. 如果租约已超时，等待命令重新分配

---

### 问题：命令执行被限流

**错误信息：** `RATE_LIMITED` (HTTP 429)

**原因：** 短时间内执行了太多相同类型的命令

**解决方法：**
1. 等待限流窗口过期后重试
2. 检查是否有自动化规则过于频繁触发
3. 联系管理员调整限流配置

---

## 配置参数

### 环境变量

| 变量名 | 默认值 | 说明 |
|--------|--------|------|
| `ENABLE_COMMAND_SIGNATURE` | `false` | 启用 HMAC 签名验证 |
| `REDIS_URL` | - | Redis 连接地址（用于速率限制） |
| `COMMAND_LEASE_DURATION_SEC` | `60` | 命令租约时长（秒） |
| `MAX_COMMAND_RETRIES` | `3` | 最大重试次数 |
| `DEFAULT_RETRY_BACKOFF_SEC` | `30` | 基础退避间隔（秒） |

---

## 常见问题

### Q: 采集器重启后会丢失命令吗？

**A:** 不会。已分配但未完成的命令会在租约超时后自动恢复为待执行状态，重新分配给采集器。

---

### Q: 如何查看命令执行历史？

**A:** 可通过以下方式查看：
1. 管理界面 → 远程控制 → 命令历史
2. 审计日志 → 筛选 `command.*` 事件
3. API: `GET /api/v1/portal/commands/history`

---

### Q: 安全事件会触发告警吗？

**A:** 是的。安全事件上报后会：
1. 记录到安全事件表
2. 生成审计日志
3. 触发配置的告警规则（如邮件、Slack 通知）

---

### Q: 如何禁用某个采集器？

**A:** 可通过以下方式：
1. 管理界面 → 设备管理 → 禁用设备
2. 重新生成设备 Token（旧 Token 立即失效）
3. 删除设备记录

---

## 技术支持

如有问题，请联系技术支持或查阅完整 API 文档：

- API 规范: `docs/REMOTE_CONTROL_CLOUD_SPEC.md`
- 控制平面 API: `docs/CONTROL_PLANE_API.md`
- 系统架构: `docs/COLLECTOR_REMOTE_CONTROL_FLOWCHART.md`
