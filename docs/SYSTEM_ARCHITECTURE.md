# HashInsight Enterprise 系统架构文档

**版本**: 2.0  
**日期**: 2026-01-27  
**状态**: 生产就绪  

---

## 目录

1. [系统概述](#1-系统概述)
2. [技术栈](#2-技术栈)
3. [核心模块架构](#3-核心模块架构)
4. [AI 系统架构详解](#4-ai-系统架构详解)
5. [数据流图](#5-数据流图)
6. [安全架构](#6-安全架构)
7. [数据库设计](#7-数据库设计)
8. [API 架构](#8-api-架构)

---

## 1. 系统概述

### 1.1 平台介绍

HashInsight Enterprise 是一个企业级 BTC 矿场运维管理平台，专为大规模矿场运营商设计。平台通过 AI 驱动的智能运维能力，帮助运营商实现矿场管理的自动化、透明化和智能化。

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                     HashInsight Enterprise Platform                          │
│                                                                              │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐  │
│  │   矿机管理   │    │   遥测系统   │    │   控制平面   │    │   AI 系统   │  │
│  │   Miner     │    │  Telemetry  │    │   Control   │    │     AI      │  │
│  │  Management │    │   System    │    │    Plane    │    │   Layer     │  │
│  └──────┬──────┘    └──────┬──────┘    └──────┬──────┘    └──────┬──────┘  │
│         │                  │                  │                  │          │
│         └──────────────────┼──────────────────┼──────────────────┘          │
│                            │                  │                              │
│                    ┌───────┴──────────────────┴───────┐                     │
│                    │      统一数据层 (PostgreSQL)      │                     │
│                    └──────────────────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 1.2 目标用户

| 用户类型 | 描述 | 规模要求 |
|---------|------|---------|
| **矿场运营商** | 拥有物理矿场的企业或个人 | 20MW+ 电力容量 |
| **托管服务商** | 为客户提供矿机托管服务 | 1000+ 矿机 |
| **矿机投资者** | 通过托管方式投资矿机 | 按合约管理 |
| **财务人员** | 处理账单、结算和对账 | 企业级合规需求 |

### 1.3 核心价值

```
┌────────────────────────────────────────────────────────────────────────────┐
│                         核心价值主张                                        │
├────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌──────────────────┐   ┌──────────────────┐   ┌──────────────────┐       │
│  │  AI 驱动智能运维  │   │   透明化对账     │   │   风险可控执行   │        │
│  │                  │   │                  │   │                  │        │
│  │ • 自动故障诊断   │   │ • 实时遥测数据   │   │ • 分级审批机制   │        │
│  │ • 智能限电建议   │   │ • 不可篡改审计   │   │ • 安全边界保护   │        │
│  │ • 预测性维护     │   │ • 区块链验证     │   │ • 闭环反馈学习   │        │
│  └──────────────────┘   └──────────────────┘   └──────────────────┘       │
│                                                                             │
└────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 技术栈

### 2.1 技术架构总览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              技术栈架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          前端层 (Frontend)                           │   │
│  │  Jinja2 Templates │ Bootstrap 5 │ Chart.js │ Alpine.js               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         应用层 (Application)                          │   │
│  │  Flask 3.x │ Flask-SQLAlchemy │ Flask-Login │ Gunicorn               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          服务层 (Services)                            │   │
│  │  AI Services │ Telemetry │ Control Plane │ Security │ Scheduler      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                          数据层 (Data)                                │   │
│  │  PostgreSQL (Neon) │ Redis (缓存/队列) │ File Storage                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         边缘层 (Edge)                                 │   │
│  │  Edge Collector │ CGMiner Adapter │ Whatsminer Adapter               │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

| 组件 | 技术选型 | 版本 | 用途 |
|------|---------|------|------|
| **Web 框架** | Flask | 3.x | RESTful API 和模板渲染 |
| **ORM** | SQLAlchemy | 2.x | 数据库抽象层 |
| **数据库** | PostgreSQL (Neon) | 15+ | 主数据存储 |
| **缓存** | Redis | 7.x | 会话缓存、任务队列 |
| **WSGI 服务器** | Gunicorn | 21.x | 生产环境部署 |
| **模板引擎** | Jinja2 | 3.x | 服务端渲染 |
| **前端框架** | Bootstrap | 5.x | 响应式 UI |
| **图表库** | Chart.js | 4.x | 数据可视化 |

### 2.3 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Replit 部署架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                         Replit Container                           │    │
│   │                                                                    │    │
│   │   ┌─────────────────┐    ┌─────────────────┐                      │    │
│   │   │    Gunicorn     │    │    Scheduler    │                      │    │
│   │   │   (4 workers)   │    │  (APScheduler)  │                      │    │
│   │   │   Port: 5000    │    │                 │                      │    │
│   │   └────────┬────────┘    └────────┬────────┘                      │    │
│   │            │                      │                                │    │
│   │            └──────────┬───────────┘                               │    │
│   │                       │                                            │    │
│   │            ┌──────────┴──────────┐                                │    │
│   │            │    Flask App (app)   │                                │    │
│   │            └──────────────────────┘                                │    │
│   │                                                                    │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                    │                                         │
│                                    │ DATABASE_URL                           │
│                                    ▼                                         │
│   ┌───────────────────────────────────────────────────────────────────┐    │
│   │                    PostgreSQL (Neon Managed)                       │    │
│   │                    Region: Auto-selected                           │    │
│   └───────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 核心模块架构

### 3.1 矿机管理模块 (Miner Management)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          矿机管理模块架构                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌────────────────────┐                                                    │
│   │   HostingSite      │  矿场站点                                          │
│   │   ├─ site_id       │                                                    │
│   │   ├─ name          │                                                    │
│   │   ├─ location      │                                                    │
│   │   └─ capacity_kw   │                                                    │
│   └──────────┬─────────┘                                                    │
│              │ 1:N                                                          │
│   ┌──────────┴─────────┐                                                    │
│   │   Zone             │  分区 (机房/集装箱/电力分区)                        │
│   │   ├─ zone_id       │                                                    │
│   │   ├─ zone_type     │  [room | container | power | building]             │
│   │   ├─ capacity_kw   │                                                    │
│   │   └─ energy_source │  [hydro | solar | wind | grid]                     │
│   └──────────┬─────────┘                                                    │
│              │ 1:N                                                          │
│   ┌──────────┴─────────┐      ┌─────────────────────┐                      │
│   │   MinerAsset       │      │  HostingCustomer    │  托管客户              │
│   │   ├─ asset_id      │◄────►│  ├─ customer_id     │                       │
│   │   ├─ model         │      │  ├─ user_id         │                       │
│   │   ├─ serial_number │      │  └─ contract_*      │                       │
│   │   ├─ hashrate_th   │      └─────────────────────┘                      │
│   │   └─ power_w       │                                                    │
│   └────────────────────┘                                                    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**关键模型**:
- `HostingSite`: 物理矿场站点
- `Zone`: 站点内的逻辑分区
- `MinerAsset`: 逻辑矿机资产（云端不存储 IP/凭据）
- `HostingCustomer`: 托管客户（用于数据隔离）
- `MinerCapability`: 矿机能力探测结果

### 3.2 遥测系统 (Telemetry System - 4层存储)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           四层遥测存储架构                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────┐                                                           │
│   │Edge Collector│  边缘采集器                                              │
│   └──────┬──────┘                                                           │
│          │ 每 60s                                                           │
│          ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Layer 1: telemetry_raw_24h (原始层)                                 │  │
│   │  ├─ 保留期: 24 小时                                                  │  │
│   │  ├─ 用途: 故障取证、模型训练、采集异常核对                           │  │
│   │  └─ 特点: 写多读少，瞬时值                                           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          │ Aggregator Job (每 5 分钟)                                       │
│          ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Layer 2: miner_telemetry_live (快照层)                              │  │
│   │  ├─ 保留期: 每矿机一条记录（覆盖更新）                               │  │
│   │  ├─ 用途: 列表显示、总览页、实时告警                                 │  │
│   │  └─ 特点: 读多写多，5分钟滑动平均                                    │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          │ 同时                                                              │
│          ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Layer 3: telemetry_history_5min (趋势层)                            │  │
│   │  ├─ 保留期: 30-90 天                                                 │  │
│   │  ├─ 用途: 折线图、异常检测、基线计算、可用率统计                     │  │
│   │  └─ 特点: 读多，5分钟聚合                                            │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│          │                                                                   │
│          │ Daily Aggregator Job                                             │
│          ▼                                                                   │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Layer 4: telemetry_daily (日聚合层)                                 │  │
│   │  ├─ 保留期: 365+ 天                                                  │  │
│   │  ├─ 用途: 报表、账单、长期趋势、MTTR/可用率统计                      │  │
│   │  └─ 特点: 存储经济，按天聚合                                         │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**数据口径说明**:

| 层级 | 算力字段 | 数据口径 | 单位 |
|------|---------|---------|------|
| raw_24h | `hashrate_ths` | 瞬时值 | TH/s |
| live | `hashrate_ghs` | 5分钟滑动平均 | GH/s |
| history_5min | `avg_hashrate_ths` | 5分钟算术平均 | TH/s |
| daily | `avg_hashrate_ths` | 日均算力 | TH/s |

### 3.3 控制平面 (Control Plane v1)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         控制平面 v1 架构                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        管理端 (Management)                           │  │
│   │                                                                      │  │
│   │   POST /api/v1/commands/propose      ───► 提议命令                   │  │
│   │   POST /api/v1/commands/{id}/approve ───► 审批命令                   │  │
│   │   POST /api/v1/commands/{id}/deny    ───► 拒绝命令                   │  │
│   │   POST /api/v1/commands/{id}/rollback───► 回滚命令                   │  │
│   │   GET  /api/v1/commands/{id}         ───► 获取命令                   │  │
│   │   GET  /api/v1/commands              ───► 列出命令                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        命令状态流转                                   │  │
│   │                                                                      │  │
│   │   PENDING ─► PENDING_APPROVAL ─► APPROVED ─► DISPATCHED ─► COMPLETED│  │
│   │                      │                              │                │  │
│   │                      ▼                              ▼                │  │
│   │                   DENIED                    FAILED / TIMEOUT         │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                        边缘端 (Edge)                                  │  │
│   │                                                                      │  │
│   │   POST /api/edge/v1/register             ───► 设备注册               │  │
│   │   GET  /api/edge/v1/commands/poll        ───► 轮询命令               │  │
│   │   POST /api/edge/v1/commands/{id}/ack    ───► 确认命令               │  │
│   │   POST /api/edge/v1/telemetry/ingest     ───► 遥测数据               │  │
│   │   POST /api/edge/v1/events/safety/batch  ───► 安全事件               │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**命令类型映射 (v1.1)**:

| Legacy 类型 | v1.1 标准类型 | 风险等级 |
|-------------|--------------|---------|
| `reboot` | `MINER_RESTART` | MEDIUM |
| `stop` / `disable` | `HASHING_DISABLE` | HIGH |
| `start` / `enable` | `HASHING_ENABLE` | LOW |
| `set_pool` | `POOL_SET` | HIGH |
| `set_fan` | `SET_FAN` | LOW |
| `power_mode` | `POWER_MODE` | MEDIUM |

### 3.4 AI 系统 (3阶段演进)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        AI 系统演进路线图                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Phase 1: Explain & Advise (解释 & 建议)                    ✓ 完成  │  │
│   │                                                                      │  │
│   │  • AlertDiagnosisService     ───► 告警诊断服务                      │  │
│   │  • TicketDraftService        ───► 工单草稿服务                      │  │
│   │  • CurtailmentAdvisorService ───► 限电建议服务                      │  │
│   │                                                                      │  │
│   │  输出: 结构化诊断报告、工单模板、限电方案比较                        │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Phase 2: AI Copilot (AI 副驾驶)                            ✓ 完成  │  │
│   │                                                                      │  │
│   │  • Event Monitoring UI        ───► 告警卡片 + AI 诊断按钮           │  │
│   │  • Client Tickets UI          ───► 新工单 + AI 生成草稿             │  │
│   │  • Curtailment Management UI  ───► 策略比较 + AI 推荐               │  │
│   │                                                                      │  │
│   │  交互: 人机协作，AI 提供建议，人工确认执行                           │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                    │                                         │
│                                    ▼                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Phase 3: AI Native (AI 原生)                               ✓ 完成  │  │
│   │                                                                      │  │
│   │  • AIAutoExecutionService    ───► 自动执行服务                      │  │
│   │  • RiskAssessmentEngine      ───► 多维风险评估引擎                  │  │
│   │  • AIClosedLoopService       ───► 闭环反馈系统                      │  │
│   │                                                                      │  │
│   │  特点: 低风险自动执行，高风险分级审批，持续学习优化                  │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. AI 系统架构详解

### 4.1 Phase 1: AI 诊断/工单/限电服务

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        Phase 1 服务架构                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  AlertDiagnosisService (告警诊断服务)                                │  │
│   │  路径: services/ai_alert_diagnosis_service.py                        │  │
│   │                                                                      │  │
│   │  输入:                                                               │  │
│   │  ├─ site_id, miner_id                                               │  │
│   │  ├─ alert_type (温度/算力/离线/功耗)                                │  │
│   │  ├─ live_telemetry (当前遥测)                                       │  │
│   │  └─ history_telemetry (历史遥测)                                    │  │
│   │                                                                      │  │
│   │  输出:                                                               │  │
│   │  ├─ hypotheses: Top3 根因假设                                       │  │
│   │  │   ├─ cause: 原因描述                                             │  │
│   │  │   ├─ confidence: 置信度 (0-1)                                    │  │
│   │  │   ├─ evidence: 支撑证据                                          │  │
│   │  │   └─ suggested_action: 建议操作                                  │  │
│   │  └─ verification_actions: 验证步骤列表                              │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  TicketDraftService (工单草稿服务)                                   │  │
│   │  路径: services/ai_ticket_draft_service.py                           │  │
│   │                                                                      │  │
│   │  输入:                                                               │  │
│   │  ├─ site_id, miner_ids[]                                            │  │
│   │  ├─ alert_type                                                      │  │
│   │  └─ diagnosis_result (可选)                                         │  │
│   │                                                                      │  │
│   │  输出:                                                               │  │
│   │  ├─ title: 工单标题                                                 │  │
│   │  ├─ description: 问题描述                                           │  │
│   │  ├─ impact_scope: 影响范围                                          │  │
│   │  ├─ troubleshooting_steps: 排查步骤                                 │  │
│   │  └─ customer_confirmations: 客户确认项                              │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  CurtailmentAdvisorService (限电建议服务)                            │  │
│   │  路径: services/ai_curtailment_advisor_service.py                    │  │
│   │                                                                      │  │
│   │  输入:                                                               │  │
│   │  ├─ site_id                                                         │  │
│   │  ├─ target_reduction_kw: 目标削减量                                 │  │
│   │  ├─ electricity_price: 电价 ($/kWh)                                 │  │
│   │  └─ strategy: 策略类型                                              │  │
│   │                                                                      │  │
│   │  输出:                                                               │  │
│   │  ├─ recommended_strategy: 推荐策略                                  │  │
│   │  ├─ shutdown_order: 关机顺序                                        │  │
│   │  ├─ revenue_loss_estimate: 收入损失估算                             │  │
│   │  └─ risk_points: 风险点提示                                         │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.2 Phase 2: UI 集成

| UI 页面 | 文件路径 | AI 功能 | API 端点 |
|--------|---------|---------|---------|
| **Event Monitoring** | `templates/hosting/event_monitoring.html` | AI 诊断按钮 | `POST /api/v1/ai/diagnose/alert` |
| **Client Tickets** | `templates/hosting/client_tickets.html` | AI 生成草稿 | `POST /api/v1/ai/ticket/draft` |
| **Curtailment** | `templates/hosting/curtailment_management.html` | 策略比较 | `POST /api/v1/ai/curtailment/plan` |

### 4.3 Phase 3: 自动执行与风险评估

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    风险评估引擎 (Risk Assessment Engine)                     │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   评估维度:                                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   action_type      ──► 操作类型权重 (POWER_OFF=0.8, POWER_ON=0.2)   │  │
│   │   target_count     ──► 影响设备数量 ([0,5]=0.1, [100,∞]=1.0)        │  │
│   │   power_impact_kw  ──► 功率影响 ([0,100]=0.1, [5000,∞]=1.0)         │  │
│   │   revenue_impact_% ──► 收入影响百分比 ([0,5]=0.1, [50,100]=1.0)     │  │
│   │   confidence_score ──► AI 置信度 (高置信 = 低风险)                  │  │
│   │   success_rate     ──► 历史成功率                                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   风险等级阈值:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   LOW      : score < 0.25  ──► 自动执行                             │  │
│   │   MEDIUM   : score < 0.50  ──► 单人审批                             │  │
│   │   HIGH     : score < 0.75  ──► 双人审批                             │  │
│   │   CRITICAL : score >= 0.75 ──► 禁止自动执行，需管理员审批           │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 4.4 AI 闭环流程

```
┌─────────────────────────────────────────────────────────────────────────────┐
│              AI 闭环流程: Detect → Diagnose → Recommend → ...                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐   ┌─────────┐     │
│   │ Detect  │──►│Diagnose │──►│Recommend│──►│ Approve │──►│   Act   │     │
│   │  告警   │   │  诊断   │   │  建议   │   │  审批   │   │  执行   │     │
│   └─────────┘   └─────────┘   └─────────┘   └─────────┘   └────┬────┘     │
│        ▲                                                        │          │
│        │                                                        ▼          │
│   ┌────┴────┐                                              ┌─────────┐    │
│   │  Learn  │◄─────────────────────────────────────────────│  Audit  │    │
│   │  复盘   │                                              │  审计   │    │
│   └─────────┘                                              └─────────┘    │
│                                                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   步骤详解:                                                                  │
│                                                                              │
│   1. Detect (检测)                                                          │
│      • 来源: 告警引擎、异常检测、用户请求                                   │
│      • 数据: site_id, miner_id, alert_type, trigger_data                   │
│                                                                              │
│   2. Diagnose (诊断)                                                        │
│      • 服务: AlertDiagnosisService                                         │
│      • 输出: Top3 根因假设 + 置信度 + 证据                                  │
│                                                                              │
│   3. Recommend (建议)                                                       │
│      • 创建: AIRecommendation 记录                                         │
│      • 内容: action_type, target_ids, expected_benefit                     │
│                                                                              │
│   4. Approve (审批)                                                         │
│      • 规则: AutoApproveRule (低风险自动)                                  │
│      • 人工: 高风险需审批                                                  │
│                                                                              │
│   5. Act (执行)                                                             │
│      • 通过: Control Plane v1 下发命令                                     │
│      • 状态: DISPATCHED → ACK_RECEIVED → COMPLETED                         │
│                                                                              │
│   6. Audit (审计)                                                           │
│      • 记录: AuditEvent (带 hash 链)                                       │
│      • 内容: 操作者、动作、结果、证据                                      │
│                                                                              │
│   7. Learn (复盘)                                                           │
│      • 反馈: AIRecommendationFeedback                                      │
│      • 指标: effectiveness_score, outcome                                  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 数据流图

### 5.1 遥测数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           遥测数据流                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐                                                       │
│   │  矿机 (ASIC)     │                                                       │
│   │  [Antminer S21] │                                                       │
│   │  [Whatsminer M50]│                                                       │
│   └────────┬────────┘                                                       │
│            │ CGMiner API / SSH                                              │
│            ▼                                                                 │
│   ┌─────────────────┐                                                       │
│   │  Edge Collector  │  边缘采集器 (site-local)                              │
│   │  ├─ ip_scanner   │                                                       │
│   │  ├─ cgminer_client│                                                      │
│   │  └─ adapters/*   │                                                       │
│   └────────┬────────┘                                                       │
│            │ POST /api/edge/v1/telemetry/ingest                             │
│            │ (HTTPS + Device Token)                                         │
│            ▼                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                         Cloud Platform                               │  │
│   │                                                                      │  │
│   │   ┌──────────────┐   ┌──────────────┐   ┌──────────────┐           │  │
│   │   │telemetry_api │──►│TelemetryService│──►│  raw_24h    │           │  │
│   │   └──────────────┘   └──────┬───────┘   └──────┬───────┘           │  │
│   │                             │                   │                    │  │
│   │                             │ Aggregator Job    │                    │  │
│   │                             ▼                   ▼                    │  │
│   │                      ┌──────────────┐   ┌──────────────┐           │  │
│   │                      │    live      │   │ history_5min │           │  │
│   │                      └──────┬───────┘   └──────┬───────┘           │  │
│   │                             │                   │                    │  │
│   │                             │ Daily Job         │                    │  │
│   │                             ▼                   ▼                    │  │
│   │                      ┌──────────────────────────────────┐          │  │
│   │                      │         telemetry_daily          │          │  │
│   │                      └──────────────────────────────────┘          │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 命令执行流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           命令执行流                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐                                                       │
│   │   User / AI     │  操作者 (人工或AI建议)                                 │
│   └────────┬────────┘                                                       │
│            │ POST /api/v1/commands/propose                                  │
│            ▼                                                                 │
│   ┌─────────────────┐                                                       │
│   │ Control Plane   │  控制平面                                              │
│   │ ├─ 验证权限     │                                                       │
│   │ ├─ 检查配额     │                                                       │
│   │ └─ 创建命令     │  状态: PENDING                                        │
│   └────────┬────────┘                                                       │
│            │                                                                 │
│            ▼ [需审批?]                                                       │
│   ┌────────────────────┐                                                    │
│   │ ApprovalPolicy     │                                                    │
│   │ ├─ risk_tier       │                                                    │
│   │ └─ require_dual    │                                                    │
│   └────────┬───────────┘                                                    │
│            │                                                                 │
│    ┌───────┴────────┐                                                       │
│    ▼                ▼                                                       │
│  [无需审批]      [需审批]                                                    │
│    │                │                                                       │
│    │       POST /api/v1/commands/{id}/approve                              │
│    │                │                                                       │
│    └───────┬────────┘                                                       │
│            ▼                                                                 │
│   ┌─────────────────┐                                                       │
│   │  命令调度器     │  状态: DISPATCHED                                      │
│   │  CommandDispatcher│                                                      │
│   └────────┬────────┘                                                       │
│            │                                                                 │
│            ▼ GET /api/edge/v1/commands/poll                                 │
│   ┌─────────────────┐                                                       │
│   │  Edge Collector  │  边缘采集器                                           │
│   │  ├─ 验证签名    │  HMAC-SHA256                                          │
│   │  └─ 执行命令    │                                                       │
│   └────────┬────────┘                                                       │
│            │                                                                 │
│            ▼ POST /api/edge/v1/commands/{id}/ack                            │
│   ┌─────────────────┐                                                       │
│   │  结果记录       │  状态: COMPLETED / FAILED                              │
│   │  AuditEvent     │                                                       │
│   └─────────────────┘                                                       │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.3 AI 决策流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI 决策流                                          │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐                                                       │
│   │   Alert Engine   │  告警引擎                                             │
│   │   ├─ 温度告警    │                                                       │
│   │   ├─ 算力异常    │                                                       │
│   │   └─ 离线检测    │                                                       │
│   └────────┬────────┘                                                       │
│            │ trigger_type: alert                                            │
│            ▼                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  AlertDiagnosisService.diagnose()                                    │  │
│   │                                                                      │  │
│   │  输入:                          输出:                                │  │
│   │  ├─ live_telemetry             ├─ hypothesis_1 (conf: 0.85)         │  │
│   │  ├─ history_5min               ├─ hypothesis_2 (conf: 0.60)         │  │
│   │  └─ recent_commands            └─ hypothesis_3 (conf: 0.30)         │  │
│   │                                                                      │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│            │                                                                 │
│            ▼                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  AIAutoExecutionService.convert_to_recommendation()                  │  │
│   │                                                                      │  │
│   │  创建 AIRecommendation:                                              │  │
│   │  ├─ action_type: REBOOT                                             │  │
│   │  ├─ target_ids: [miner_001]                                         │  │
│   │  ├─ risk_level: LOW                                                 │  │
│   │  └─ confidence_score: 0.85                                          │  │
│   │                                                                      │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│            │                                                                 │
│            ▼                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  RiskAssessmentEngine.assess()                                       │  │
│   │                                                                      │  │
│   │  计算 risk_score:                                                    │  │
│   │  ├─ action_weight  × 0.30 = 0.15                                    │  │
│   │  ├─ target_weight  × 0.25 = 0.025                                   │  │
│   │  ├─ power_weight   × 0.20 = 0.02                                    │  │
│   │  └─ confidence_adj × 0.25 = 0.0375                                  │  │
│   │  ────────────────────────────                                       │  │
│   │  Total: 0.23 → LOW → can_auto_execute: true                         │  │
│   │                                                                      │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│            │                                                                 │
│            ▼ [can_auto_execute = true]                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  AIClosedLoopService.execute()                                       │  │
│   │                                                                      │  │
│   │  ├─ 创建 RemoteCommand                                              │  │
│   │  ├─ 调用 Control Plane v1                                           │  │
│   │  └─ 更新 recommendation.status = EXECUTING                          │  │
│   │                                                                      │  │
│   └────────────────────────────────────────────────────────────────────┘  │
│            │                                                                 │
│            ▼                                                                 │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  Feedback Loop (执行完成后)                                          │  │
│   │                                                                      │  │
│   │  ├─ 记录 execution_result                                           │  │
│   │  ├─ 计算 effectiveness_score                                        │  │
│   │  └─ 更新 AIRecommendationFeedback                                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 安全架构

### 6.1 设备信封加密 (Envelope Encryption)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        设备信封加密 (E2EE)                                   │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   原理:                                                                      │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   1. KMS 生成数据加密密钥 (DEK)                                     │  │
│   │   2. 使用 DEK 加密实际数据                                          │  │
│   │   3. 使用 KMS 主密钥 (CMK) 加密 DEK                                 │  │
│   │   4. 存储: 加密数据 + 加密的 DEK                                    │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   支持的 KMS 提供商:                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   AWS_KMS         ──► Amazon Key Management Service                 │  │
│   │   GCP_KMS         ──► Google Cloud Key Management Service           │  │
│   │   AZURE_KEY_VAULT ──► Azure Key Vault                               │  │
│   │   LOCAL_HSM       ──► PKCS#11 Hardware Security Module              │  │
│   │   FALLBACK_FERNET ──► 降级模式 (开发环境)                           │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   加密数据类型:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   • 矿机 IP 地址 (encrypted_ip)                                     │  │
│   │   • 矿机 MAC 地址 (encrypted_mac)                                   │  │
│   │   • 矿机登录凭据 (encrypted_credentials)                            │  │
│   │   • Edge 设备密钥 (device_private_key)                              │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   文件路径: common/crypto/envelope.py                                        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.2 RBAC v2.0 权限矩阵

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        RBAC v2.0 权限矩阵                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   6 个用户角色 (按权限从高到低):                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   OWNER              ──► 所有者 (最高权限)                          │  │
│   │   ADMIN              ──► 管理员                                     │  │
│   │   MINING_SITE_OWNER  ──► 矿场站点负责人                             │  │
│   │   CLIENT             ──► 矿场客户端 (托管客户)                      │  │
│   │   CUSTOMER           ──► 应用客户                                   │  │
│   │   GUEST              ──► 未登录访客                                 │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   11 个功能模块:                                                             │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   BASIC       ──► 基础功能 (计算器/设置/仪表盘)                     │  │
│   │   HOSTING     ──► 托管服务 (站点/矿机/工单/对账)                    │  │
│   │   CURTAILMENT ──► 智能限电 (策略/AI预测/执行/历史)                  │  │
│   │   CRM         ──► CRM 系统 (客户/交易/发票/佣金)                    │  │
│   │   ANALYTICS   ──► 分析工具 (批量计算/网络/技术)                     │  │
│   │   AI          ──► 智能层 (预测/解释/异常/优化)                      │  │
│   │   USER        ──► 用户管理 (创建/编辑/禁用/删除)                    │  │
│   │   SYSTEM      ──► 系统监控 (健康/性能/事件)                         │  │
│   │   WEB3        ──► Web3 功能 (区块链验证/SLA NFT)                    │  │
│   │   FINANCE     ──► 财务管理 (账单/结算/加密支付)                     │  │
│   │   REPORT      ──► 报表系统 (PDF/Excel/PPT)                          │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   3 种访问级别:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   FULL  (✓)  ──► 完全访问 (读写)                                    │  │
│   │   READ  (●)  ──► 只读访问                                           │  │
│   │   NONE  (✗)  ──► 无权限                                             │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   文件路径: common/rbac.py                                                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

**权限矩阵示例**:

| 模块 | Owner | Admin | Site Owner | Client | Customer | Guest |
|------|-------|-------|------------|--------|----------|-------|
| 挖矿计算器 | ✓ | ✓ | ✓ | ✓ | ✓ | ✓ |
| 站点管理 | ✓ | ✓ | ✓ | ● | ✗ | ✗ |
| 限电执行 | ✓ | ✓ | ✓ | ✗ | ✗ | ✗ |
| 用户管理 | ✓ | ✓ | ✗ | ✗ | ✗ | ✗ |
| 系统监控 | ✓ | ✓ | ● | ✗ | ✗ | ✗ |

### 6.3 SOC2 合规功能

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        SOC2 合规功能                                         │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   安全控制措施:                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   会话管理:                                                          │  │
│   │   ├─ 8 小时会话超时 (PERMANENT_SESSION_LIFETIME)                    │  │
│   │   ├─ SameSite=None + Secure Cookie                                  │  │
│   │   └─ Chrome CHIPS 支持 (Partitioned attribute)                      │  │
│   │                                                                      │  │
│   │   认证安全:                                                          │  │
│   │   ├─ Werkzeug pbkdf2_sha256 密码哈希                                │  │
│   │   ├─ CSRF Token 保护                                                │  │
│   │   └─ Rate Limiting (登录尝试限制)                                   │  │
│   │                                                                      │  │
│   │   通信安全:                                                          │  │
│   │   ├─ HTTPS Only (ProxyFix middleware)                               │  │
│   │   ├─ HMAC-SHA256 命令签名                                           │  │
│   │   └─ Device Token 认证                                              │  │
│   │                                                                      │  │
│   │   数据保护:                                                          │  │
│   │   ├─ 信封加密 (敏感数据)                                            │  │
│   │   ├─ 字段级加密 (IP/MAC/凭据)                                       │  │
│   │   └─ 密钥自动轮换                                                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   合规文档路径: docs/soc2/policies/                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 6.4 审计事件哈希链

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        审计事件哈希链                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   AuditEvent 模型:                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   id              ──► 主键                                          │  │
│   │   event_id        ──► 事件 UUID (evt_xxxxxxxxxxxx)                  │  │
│   │   site_id         ──► 关联站点                                      │  │
│   │   actor_type      ──► 操作者类型 [user | device | system | ai]      │  │
│   │   actor_id        ──► 操作者 ID                                     │  │
│   │   event_type      ──► 事件类型 (command.proposed, ai.recommendation)│  │
│   │   ref_type        ──► 引用类型 (command, recommendation)            │  │
│   │   ref_id          ──► 引用 ID                                       │  │
│   │   payload_json    ──► 事件数据 (JSON)                               │  │
│   │   prev_hash       ──► 上一事件的 hash                               │  │
│   │   event_hash      ──► 当前事件的 hash                               │  │
│   │   created_at      ──► 创建时间                                      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   哈希链结构:                                                                │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   Event_1                  Event_2                  Event_3         │  │
│   │   ┌─────────────┐         ┌─────────────┐         ┌─────────────┐  │  │
│   │   │ event_id: A │         │ event_id: B │         │ event_id: C │  │  │
│   │   │ prev_hash: -│────────►│ prev_hash:  │────────►│ prev_hash:  │  │  │
│   │   │ event_hash: │         │   hash(A)   │         │   hash(B)   │  │  │
│   │   │   hash(A)   │         │ event_hash: │         │ event_hash: │  │  │
│   │   │             │         │   hash(B)   │         │   hash(C)   │  │  │
│   │   └─────────────┘         └─────────────┘         └─────────────┘  │  │
│   │                                                                      │  │
│   │   hash = SHA256(event_id + actor + event_type + payload + prev_hash)│  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   特点: 不可篡改、可追溯、支持区块链验证                                      │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 数据库设计

### 7.1 核心表结构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          核心表关系图                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────┐                                                       │
│   │   user_access   │  用户账户                                              │
│   │   PK: id        │                                                       │
│   │   ├─ username   │                                                       │
│   │   ├─ email      │                                                       │
│   │   ├─ role       │                                                       │
│   │   └─ password_hash                                                      │
│   └────────┬────────┘                                                       │
│            │ 1:N                                                             │
│            ▼                                                                 │
│   ┌─────────────────┐       ┌─────────────────┐                            │
│   │  hosting_sites  │◄──────│     zones       │                            │
│   │   PK: id        │       │   PK: id        │                            │
│   │   ├─ name       │       │   FK: site_id   │                            │
│   │   ├─ location   │       │   ├─ zone_type  │                            │
│   │   └─ capacity   │       │   └─ capacity_kw│                            │
│   └────────┬────────┘       └────────┬────────┘                            │
│            │                         │                                       │
│            │ 1:N                     │ 1:N                                   │
│            ▼                         ▼                                       │
│   ┌─────────────────┐       ┌─────────────────┐                            │
│   │hosting_customers│       │ cp_miner_assets │  逻辑矿机资产               │
│   │   PK: id        │◄──────│   PK: id        │                            │
│   │   FK: site_id   │       │   FK: site_id   │                            │
│   │   FK: user_id   │       │   FK: zone_id   │                            │
│   │   ├─ name       │       │   FK: customer_id                            │
│   │   └─ company    │       │   ├─ model      │                            │
│   └─────────────────┘       │   ├─ hashrate_th│                            │
│                             │   └─ power_w    │                            │
│                             └────────┬────────┘                            │
│                                      │                                       │
│            ┌─────────────────────────┼─────────────────────────┐           │
│            ▼                         ▼                         ▼           │
│   ┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐ │
│   │miner_telemetry_ │       │ remote_command  │       │ audit_events    │ │
│   │     live        │       │   PK: id        │       │   PK: id        │ │
│   │   PK: id        │       │   FK: site_id   │       │   FK: site_id   │ │
│   │   ├─ miner_id   │       │   ├─ command_type       │   ├─ event_type │ │
│   │   ├─ hashrate   │       │   ├─ status     │       │   ├─ prev_hash  │ │
│   │   └─ temperature│       │   └─ created_at │       │   └─ event_hash │ │
│   └─────────────────┘       └─────────────────┘       └─────────────────┘ │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.2 AI 相关表

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          AI 相关表结构                                       │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  ai_recommendations (AI 建议表)                                      │  │
│   │                                                                      │  │
│   │  PK: id (UUID)                                                      │  │
│   │  FK: site_id                                                        │  │
│   │                                                                      │  │
│   │  触发信息:                                                           │  │
│   │  ├─ trigger_type    ──► [alert | anomaly | schedule | user_request] │  │
│   │  ├─ trigger_id      ──► 触发事件 ID                                 │  │
│   │  └─ trigger_data    ──► 触发数据 (JSON)                             │  │
│   │                                                                      │  │
│   │  诊断结果:                                                           │  │
│   │  └─ diagnosis       ──► AI 诊断输出 (JSON)                          │  │
│   │                                                                      │  │
│   │  建议操作:                                                           │  │
│   │  ├─ action_type     ──► [REBOOT | POWER_OFF | CURTAIL | ...]        │  │
│   │  ├─ action_params   ──► 操作参数 (JSON)                             │  │
│   │  └─ target_ids      ──► 目标矿机 ID 列表 (JSON)                     │  │
│   │                                                                      │  │
│   │  风险评估:                                                           │  │
│   │  ├─ risk_level      ──► [LOW | MEDIUM | HIGH | CRITICAL]            │  │
│   │  ├─ confidence_score──► AI 置信度 (0-1)                             │  │
│   │  └─ priority        ──► 优先级 (1=最高, 10=最低)                    │  │
│   │                                                                      │  │
│   │  预期收益:                                                           │  │
│   │  └─ expected_benefit──► 预期结果 (JSON)                             │  │
│   │                                                                      │  │
│   │  状态信息:                                                           │  │
│   │  ├─ status          ──► [pending|approved|rejected|executing|...]   │  │
│   │  ├─ require_approval                                                │  │
│   │  └─ expires_at      ──► 过期时间                                    │  │
│   │                                                                      │  │
│   │  审批信息:                                                           │  │
│   │  ├─ approved_by_user_id                                             │  │
│   │  ├─ approved_at                                                     │  │
│   │  └─ approval_reason                                                 │  │
│   │                                                                      │  │
│   │  执行信息:                                                           │  │
│   │  ├─ command_id      ──► 关联的命令 ID                               │  │
│   │  ├─ execution_started_at                                            │  │
│   │  ├─ execution_completed_at                                          │  │
│   │  └─ execution_result                                                │  │
│   │                                                                      │  │
│   │  反馈信息:                                                           │  │
│   │  ├─ effectiveness_score ──► 有效性评分 (0-1)                        │  │
│   │  ├─ feedback_data                                                   │  │
│   │  └─ learned_at                                                      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  ai_recommendation_feedback (AI 反馈表)                              │  │
│   │                                                                      │  │
│   │  PK: id                                                             │  │
│   │  FK: recommendation_id ──► ai_recommendations.id                    │  │
│   │  FK: user_id                                                        │  │
│   │                                                                      │  │
│   │  ├─ outcome         ──► [resolved | partially_resolved | failed]    │  │
│   │  ├─ accuracy_rating ──► 准确度评分 (1-5)                            │  │
│   │  ├─ usefulness_rating ─► 有用度评分 (1-5)                           │  │
│   │  ├─ comment         ──► 用户评论                                    │  │
│   │  └─ created_at                                                      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │  auto_approve_rules (自动审批规则表)                                 │  │
│   │                                                                      │  │
│   │  PK: id                                                             │  │
│   │  FK: site_id                                                        │  │
│   │                                                                      │  │
│   │  ├─ name            ──► 规则名称                                    │  │
│   │  ├─ action_types    ──► 适用的操作类型 (JSON 数组)                  │  │
│   │  ├─ conditions      ──► 触发条件 (JSON)                             │  │
│   │  │   ├─ max_target_count                                            │  │
│   │  │   ├─ max_power_impact_kw                                         │  │
│   │  │   ├─ min_confidence_score                                        │  │
│   │  │   └─ allowed_time_windows                                        │  │
│   │  ├─ is_active       ──► 是否启用                                    │  │
│   │  └─ created_at                                                      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 7.3 遥测数据表

| 表名 | 用途 | 保留期 | 特点 |
|------|------|-------|------|
| `telemetry_raw_24h` | 原始采集数据 | 24小时 | 写多读少 |
| `miner_telemetry_live` | 当前状态快照 | 覆盖更新 | 读多写多 |
| `telemetry_history_5min` | 5分钟聚合 | 30-90天 | 趋势分析 |
| `telemetry_daily` | 日聚合统计 | 365+天 | 报表/账单 |

---

## 8. API 架构

### 8.1 统一前缀规范

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          API 前缀规范                                        │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   管理端 API (Web UI 调用):                                                  │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   /api/v1/commands/*        ──► 命令管理                            │  │
│   │   /api/v1/telemetry/*       ──► 遥测查询                            │  │
│   │   /api/v1/ai/*              ──► AI 服务                             │  │
│   │   /api/v1/portal/*          ──► 客户门户                            │  │
│   │   /api/v1/price-plans/*     ──► 价格计划                            │  │
│   │   /api/v1/demand/*          ──► 需量管理                            │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   边缘端 API (Edge Collector 调用):                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   /api/edge/v1/register           ──► 设备注册                      │  │
│   │   /api/edge/v1/commands/poll      ──► 轮询命令                      │  │
│   │   /api/edge/v1/commands/{id}/ack  ──► 确认命令                      │  │
│   │   /api/edge/v1/telemetry/ingest   ──► 遥测上报                      │  │
│   │   /api/edge/v1/events/safety/batch──► 安全事件                      │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   Legacy API (兼容层 - 已标记弃用):                                          │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   /api/sites/<site_id>/commands   ──► 创建/列出命令                 │  │
│   │   /api/commands/<id>              ──► 获取/取消/审批                │  │
│   │   /api/remote/commands/pending    ──► 轮询命令 (旧)                 │  │
│   │                                                                      │  │
│   │   ⚠️ Sunset: 2026-06-01 (添加 Deprecation header)                   │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.2 认证机制

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          认证机制                                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│   用户认证 (Web UI):                                                         │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   方式: Flask-Login Session                                         │  │
│   │   存储: Server-side session (cookie: session=xxx)                   │  │
│   │   超时: 8 小时                                                       │  │
│   │   验证: @login_required 装饰器                                       │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   设备认证 (Edge API):                                                       │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   方式: Bearer Token                                                │  │
│   │   Header: Authorization: Bearer <device_token>                      │  │
│   │   验证: token_hash = SHA256(token), 查询 EdgeDevice 表              │  │
│   │   绑定: Zone + Site 隔离                                            │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
│   命令签名 (HMAC):                                                           │
│   ┌─────────────────────────────────────────────────────────────────────┐  │
│   │                                                                      │  │
│   │   算法: HMAC-SHA256                                                 │  │
│   │   密钥: 每 Edge 设备独立 hmac_secret                                │  │
│   │   格式: canonical JSON → base64(HMAC(JSON, secret))                 │  │
│   │   字段: command_id, site_id, miner_id, command_type, params,        │  │
│   │         priority, expires_at, dedupe_key, signed_at, nonce          │  │
│   │                                                                      │  │
│   └─────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 8.3 主要 API 蓝图列表

| 蓝图名称 | 文件路径 | 前缀 | 功能 |
|---------|---------|------|------|
| `control_plane_bp` | `api/control_plane_api.py` | `/api/v1/`, `/api/edge/v1/` | 控制平面核心 |
| `telemetry_bp` | `api/telemetry_api.py` | `/api/v1/telemetry/` | 遥测数据查询 |
| `ai_closedloop_bp` | `api/ai_closedloop_api.py` | `/api/v1/ai/recommendations/` | AI 闭环服务 |
| `ai_feature_bp` | `api/ai_feature_api.py` | `/api/v1/ai/diagnose/`, `/api/v1/ai/ticket/`, `/api/v1/ai/curtailment/` | AI 功能服务 |
| `ai_auto_exec_bp` | `api/ai_auto_execution_api.py` | `/api/v1/ai/auto/` | AI 自动执行 |
| `portal_lite_bp` | `api/portal_lite_api.py` | `/api/v1/portal/` | 客户门户 |
| `collector_bp` | `api/collector_api.py` | `/api/collector/` | 采集器管理 |
| `device_bp` | `api/device_api.py` | `/api/devices/` | 设备管理 |
| `remote_control_bp` | `api/remote_control_api.py` | `/api/sites/`, `/api/commands/` | 远程控制 (Legacy) |

---

## 附录

### A. 文件结构

```
HashInsight Enterprise/
├── app.py                      # Flask 应用入口
├── main.py                     # WSGI 入口
├── db.py                       # 数据库初始化
├── models.py                   # 核心数据模型
├── models_ai_closedloop.py     # AI 闭环模型
├── models_control_plane.py     # 控制平面模型
├── models_device_encryption.py # 设备加密模型
├── models_remote_control.py    # 远程控制模型
├── api/                        # API 蓝图
│   ├── control_plane_api.py    # 控制平面 API
│   ├── telemetry_api.py        # 遥测 API
│   ├── ai_closedloop_api.py    # AI 闭环 API
│   ├── ai_feature_api.py       # AI 功能 API
│   └── ai_auto_execution_api.py# AI 自动执行 API
├── services/                   # 业务服务
│   ├── ai_alert_diagnosis_service.py
│   ├── ai_ticket_draft_service.py
│   ├── ai_curtailment_advisor_service.py
│   ├── ai_closedloop_service.py
│   ├── ai_auto_execution_service.py
│   ├── telemetry_service.py
│   └── ...
├── common/                     # 公共模块
│   ├── rbac.py                 # RBAC 权限系统
│   └── crypto/
│       └── envelope.py         # 信封加密
├── edge_collector/             # 边缘采集器
│   ├── main.py
│   ├── adapters/               # 矿机适配器
│   └── ...
├── templates/                  # Jinja2 模板
│   ├── hosting/
│   │   ├── event_monitoring.html
│   │   ├── client_tickets.html
│   │   └── curtailment_management.html
│   └── ...
└── docs/                       # 文档
    ├── SYSTEM_ARCHITECTURE.md  # 本文档
    ├── TELEMETRY_DATA_CONTRACT.md
    ├── COMMAND_API_CONVERGENCE.md
    └── ...
```

### B. 相关文档

| 文档 | 路径 | 描述 |
|------|------|------|
| 遥测数据契约 | `docs/TELEMETRY_DATA_CONTRACT.md` | 四层遥测存储详细规范 |
| 命令 API 收敛 | `docs/COMMAND_API_CONVERGENCE.md` | Legacy → v1 迁移计划 |
| 控制平面 API | `docs/CONTROL_PLANE_API.md` | Control Plane v1 API 文档 |
| 设备信封加密 | `docs/device_envelope_encryption_manual.md` | E2EE 实施手册 |
| SOC2 策略 | `docs/soc2/policies/` | 安全合规策略文档 |

---

**文档维护**: HashInsight 开发团队  
**最后更新**: 2026-01-27
